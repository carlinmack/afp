<div id="Partial_Recursive">
<div class="head">
<h1>Theory Partial_Recursive</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Partial recursive functions›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Partial_Recursive
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <span class="quoted">"<a href="../../HOL/HOL-Library/Nat_Bijection.html">HOL-Library.Nat_Bijection</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This chapter lays the foundation for Chapter~\ref{c:iirf}.
Essentially it develops recursion theory up to the point of certain
fixed-point theorems. This in turn requires standard results such as the
existence of a universal function and the $s$-$m$-$n$ theorem. Besides these,
the chapter contains some results, mostly regarding decidability and the
Kleene normal form, that are not strictly needed later. They are included as
relatively low-hanging fruits to round off the chapter.

The formalization of partial recursive functions is very much inspired by the
Universal Turing Machine AFP entry by Xu
et~al.~\cite{Universal_Turing_Machine-AFP}. It models partial recursive
functions as algorithms whose semantics is given by an evaluation function.
This works well for most of this chapter. For the next chapter, however, it
is beneficial to regard partial recursive functions as ``proper'' partial
functions. To that end, Section~\ref{s:alternative} introduces more
conventional and convenient notation for the common special cases of unary
and binary partial recursive functions.

Especially for the nontrivial proofs I consulted the classical textbook by
Rogers~\cite{Rogers87}, which also partially explains my preferring the
traditional term ``recursive'' to the more modern ``computable''.›</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Basic definitions›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Partial recursive functions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹To represent partial recursive functions we start from the same
datatype as Xu et~al.~\cite{Universal_Turing_Machine-AFP}, more specifically
from Urban's version of the formalization. In fact the datatype <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">recf</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
and the function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">arity</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> below have been copied verbatim from it.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> recf <span class="main">=</span>
  Z
<span class="main">|</span> S
<span class="main">|</span> Id <span class="quoted">nat</span> <span class="quoted">nat</span>
<span class="main">|</span> Cn <span class="quoted">nat</span> <span class="quoted">recf</span> <span class="quoted"><span class="quoted">"recf list"</span></span>
<span class="main">|</span> Pr <span class="quoted">nat</span> <span class="quoted">recf</span> <span class="quoted">recf</span>
<span class="main">|</span> Mn <span class="quoted">nat</span> <span class="quoted">recf</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">arity</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"recf <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">arity</span> Z <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">arity</span> S <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">arity</span> <span class="main">(</span>Id <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">arity</span> <span class="main">(</span>Cn <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">gs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">arity</span> <span class="main">(</span>Pr <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="main">=</span> Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">arity</span> <span class="main">(</span>Mn <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Already we deviate from Xu et~al.\ in that we define a
well-formedness predicate for partial recursive functions. Well-formedness
essentially means arity constraints are respected when combining <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span>
<span class="quoted"><span class="quoted">recf</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>s.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">wellf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"recf <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wellf</span> Z <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wellf</span> S <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wellf</span> <span class="main">(</span>Id <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wellf</span> <span class="main">(</span>Cn <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">gs</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">g</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">gs</span></span></span><span class="main">.</span> arity <span class="bound">g</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> <span class="free">wellf</span> <span class="bound">g</span><span class="main">)</span> <span class="main">∧</span> arity <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">gs</span></span></span> <span class="main">∧</span> <span class="free">wellf</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wellf</span> <span class="main">(</span>Pr <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span>arity <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">∧</span> arity <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> <span class="free">wellf</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∧</span> <span class="free">wellf</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wellf</span> <span class="main">(</span>Mn <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> arity <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> <span class="free">wellf</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wellf_arity_nonzero<span class="main">:</span> <span class="quoted"><span class="quoted">"wellf <span class="free">f</span> <span class="main">⟹</span> arity <span class="free">f</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> arity.induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> wellf_Pr_arity_greater_1<span class="main">:</span> <span class="quoted"><span class="quoted">"wellf <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">⟹</span> arity <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wellf_arity_nonzero <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For the most part of this chapter this is the meaning of ``$f$
is an $n$-ary partial recursive function'':›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">recfn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> recf <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">recfn</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> wellf <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∧</span> arity <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Some abbreviations for working with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"nat option"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">divergent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat option <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">↑</span>"</span> <span class="main">[</span>50<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">↑</span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">convergent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat option <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">↓</span>"</span> <span class="main">[</span>50<span class="main">]</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">↓</span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≠</span> None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">convergent_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat option <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">↓=</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">↓=</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">convergent_neq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat option <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">↓≠</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">↓≠</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">↓</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≠</span> Some <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In prose the terms ``halt'', ``terminate'', ``converge'', and
``defined'' will be used interchangeably; likewise for ``not halt'',
``diverge'', and ``undefined''. In names of lemmas, the abbreviations <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span>
<span class="raw_text"><span class="raw_text">converg</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">diverg</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> will be used consistently.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Our second major deviation from Xu
et~al.~\cite{Universal_Turing_Machine-AFP} is that we model the semantics of
a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">recf</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by combining the value and the termination of a function into
one evaluation function with codomain <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"nat option"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, rather than
separating both aspects into an evaluation function with codomain <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">nat</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
and a termination predicate.

The value of a well-formed partial recursive function applied to a
correctly-sized list of arguments:›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eval_wellf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"recf <span class="main">⇒</span> nat list <span class="main">⇒</span> nat option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_wellf</span> Z <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_wellf</span> S <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">↓=</span> Suc <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_wellf</span> <span class="main">(</span>Id <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">↓=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_wellf</span> <span class="main">(</span>Cn <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">gs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> <span class="main">∀</span><span class="bound">g</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">gs</span></span></span><span class="main">.</span> <span class="free">eval_wellf</span> <span class="bound">g</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">↓</span>
    <span class="keyword1">then</span> <span class="free">eval_wellf</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> the <span class="main">(</span><span class="free">eval_wellf</span> <span class="bound">g</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">gs</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_wellf</span> <span class="main">(</span>Pr <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="main">[]</span> <span class="main">=</span> undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_wellf</span> <span class="main">(</span>Pr <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">0</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">eval_wellf</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_wellf</span> <span class="main">(</span>Pr <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span>
   Option.bind <span class="main">(</span><span class="free">eval_wellf</span> <span class="main">(</span>Pr <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="free">eval_wellf</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="bound">v</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_wellf</span> <span class="main">(</span>Mn <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="bound">E</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="free">eval_wellf</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="bound">z</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>
    <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="main">∃</span><span class="bound">z</span><span class="main">.</span> <span class="bound">E</span> <span class="bound">z</span> <span class="main">↓=</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">y</span></span><span class="main">&lt;</span><span class="bound">z</span><span class="main">.</span> <span class="bound">E</span> <span class="bound">y</span> <span class="main">↓</span><span class="main">)</span>
       <span class="keyword1">then</span> Some <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">E</span> <span class="bound">z</span> <span class="main">↓=</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">y</span></span><span class="main">&lt;</span><span class="bound">z</span><span class="main">.</span> <span class="bound">E</span> <span class="bound">y</span> <span class="main">↓</span><span class="main">)</span><span class="main">)</span>
       <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define a function value only if the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">recf</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is well-formed
and its arity matches the number of arguments.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">eval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"recf <span class="main">⇒</span> nat list <span class="main">⇒</span> nat option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟹</span> <span class="free">eval</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> eval_wellf <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eval_Z <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval Z <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_Z' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span> eval Z <span class="free">xs</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_S <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval S <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_S' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span> eval S <span class="free">xs</span> <span class="main">↓=</span> Suc <span class="main">(</span>hd <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> eval_def hd_conv_nth<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_Id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Id <span class="free">m</span> <span class="free">n</span><span class="main">)</span> <span class="free">xs</span> <span class="main">↓=</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_Cn <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>Cn <span class="free">n</span> <span class="free">f</span> <span class="free">gs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Cn <span class="free">n</span> <span class="free">f</span> <span class="free">gs</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">∀</span><span class="bound">g</span><span class="main">∈</span>set <span class="free">gs</span><span class="main">.</span> eval <span class="bound">g</span> <span class="free">xs</span> <span class="main">↓</span>
     <span class="keyword1">then</span> eval <span class="free">f</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> the <span class="main">(</span>eval <span class="bound">g</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="free">gs</span><span class="main">)</span>
     <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Cn <span class="free">n</span> <span class="free">f</span> <span class="free">gs</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> eval_wellf <span class="main">(</span>Cn <span class="free">n</span> <span class="free">f</span> <span class="free">gs</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms eval_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> set <span class="free">gs</span> <span class="main">⟹</span> eval_wellf <span class="bound">g</span> <span class="free">xs</span> <span class="main">=</span> eval <span class="bound">g</span> <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms eval_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Cn <span class="free">n</span> <span class="free">f</span> <span class="free">gs</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">∀</span><span class="bound">g</span><span class="main">∈</span>set <span class="free">gs</span><span class="main">.</span> eval <span class="bound">g</span> <span class="free">xs</span> <span class="main">↓</span>
     <span class="keyword1">then</span> eval_wellf <span class="free">f</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> the <span class="main">(</span>eval <span class="bound">g</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="free">gs</span><span class="main">)</span>
     <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> map_eq_conv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">g</span><span class="main">.</span> the <span class="main">(</span>eval_wellf <span class="bound">g</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">gs</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">g</span><span class="main">.</span> the <span class="main">(</span>eval <span class="bound">g</span> <span class="free">xs</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ys</span><span class="main">.</span> length <span class="bound">ys</span> <span class="main">=</span> length <span class="free">gs</span> <span class="main">⟹</span> eval <span class="free">f</span> <span class="bound">ys</span> <span class="main">=</span> eval_wellf <span class="free">f</span> <span class="bound">ys</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms eval_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eval_Pr_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="main">0</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> eval <span class="free">f</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_Pr_diverg_Suc <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↑</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↑</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_Pr_converg_Suc <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> eval <span class="free">g</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> the <span class="main">(</span>eval <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms eval_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_Pr_diverg_add<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↑</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↑</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_Pr_converg_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms eval_Pr_diverg_add le_Suc_ex <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_Pr_Suc_converg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval <span class="free">g</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="main">(</span>the <span class="main">(</span>eval <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> eval <span class="free">g</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> the <span class="main">(</span>eval <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> eval_Pr_converg_Suc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    eval_Pr_converg_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">x</span>"</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">,</span> <span class="operator">OF</span> assms<span class="main">]</span> assms<span class="main">(</span>3<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_Mn <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>Mn <span class="free">n</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Mn <span class="free">n</span> <span class="free">f</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">∃</span><span class="bound">z</span><span class="main">.</span> eval <span class="free">f</span> <span class="main">(</span><span class="bound">z</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">y</span></span><span class="main">&lt;</span><span class="bound">z</span><span class="main">.</span> eval <span class="free">f</span> <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">then</span> Some <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">z</span><span class="main">.</span> eval <span class="free">f</span> <span class="main">(</span><span class="bound">z</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">y</span></span><span class="main">&lt;</span><span class="bound">z</span><span class="main">.</span> eval <span class="free">f</span> <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms eval_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For $\mu$-recursion, the condition <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="main"><span class="main">∀</span></span><span class="bound"><span class="bound"><span class="bound"><span class="bound">y</span></span></span></span><span class="main"><span class="main">&lt;</span></span><span class="free"><span class="free">z</span></span><span class="main"><span class="main">.</span></span> eval_wellf <span class="free"><span class="free">f</span></span> <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">y</span></span> <span class="main"><span class="main">#</span></span> <span class="free"><span class="free">xs</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">↓</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
inside <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">LEAST</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in the definition of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">eval_wellf</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is redundant.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eval_wellf_Mn<span class="main">:</span>
  <span class="quoted"><span class="quoted">"eval_wellf <span class="main">(</span>Mn <span class="free">n</span> <span class="free">f</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">∃</span><span class="bound">z</span><span class="main">.</span> eval_wellf <span class="free">f</span> <span class="main">(</span><span class="bound">z</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">y</span></span><span class="main">&lt;</span><span class="bound">z</span><span class="main">.</span> eval_wellf <span class="free">f</span> <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓</span><span class="main">)</span><span class="main">)</span>
     <span class="keyword1">then</span> Some <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">z</span><span class="main">.</span> eval_wellf <span class="free">f</span> <span class="main">(</span><span class="bound">z</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">)</span>
     <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">z</span><span class="main">.</span> eval_wellf <span class="free">f</span> <span class="main">(</span><span class="bound">z</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">y</span></span><span class="main">&lt;</span><span class="bound">z</span><span class="main">.</span> eval_wellf <span class="free">f</span> <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">z</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">z</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> Least <span class="var">?P</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">z</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> LeastI<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">z</span><span class="main">.</span> eval_wellf <span class="free">f</span> <span class="main">(</span><span class="bound">z</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Least_equality<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eval_wellf <span class="free">f</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">z</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"eval_wellf <span class="free">f</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">z</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&lt;</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">y</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> that <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">z</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">using</span></span> that not_less_Least z_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eval_Mn'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>Mn <span class="free">n</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Mn <span class="free">n</span> <span class="free">f</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">∃</span><span class="bound">z</span><span class="main">.</span> eval <span class="free">f</span> <span class="main">(</span><span class="bound">z</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">y</span></span><span class="main">&lt;</span><span class="bound">z</span><span class="main">.</span> eval <span class="free">f</span> <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">then</span> Some <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">z</span><span class="main">.</span> eval <span class="free">f</span> <span class="main">(</span><span class="bound">z</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">)</span>
    <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms eval_def eval_wellf_Mn <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Proving that $\mu$-recursion converges is easier if one does not
have to deal with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">LEAST</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> directly.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eval_Mn_convergI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>Mn <span class="free">n</span> <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eval <span class="free">f</span> <span class="main">(</span><span class="free">z</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">z</span> <span class="main">⟹</span> eval <span class="free">f</span> <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Mn <span class="free">n</span> <span class="free">f</span><span class="main">)</span> <span class="free">xs</span> <span class="main">↓=</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">z</span><span class="main">.</span> eval <span class="free">f</span> <span class="main">(</span><span class="bound">z</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">y</span></span><span class="main">&lt;</span><span class="bound">z</span><span class="main">.</span> eval <span class="free">f</span> <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">=</span> Least <span class="var">?P</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Least_equality<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="quoted"><span class="free">z</span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> not_le_imp_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Mn <span class="free">n</span> <span class="free">f</span><span class="main">)</span> <span class="free">xs</span> <span class="main">↓=</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eval_Mn<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Similarly, reasoning from a $\mu$-recursive function is
simplified somewhat by the next lemma.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eval_Mn_convergE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>Mn <span class="free">n</span> <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Mn <span class="free">n</span> <span class="free">f</span><span class="main">)</span> <span class="free">xs</span> <span class="main">↓=</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">z</span><span class="main">.</span> eval <span class="free">f</span> <span class="main">(</span><span class="bound">z</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">y</span></span><span class="main">&lt;</span><span class="bound">z</span><span class="main">.</span> eval <span class="free">f</span> <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eval <span class="free">f</span> <span class="main">(</span><span class="free">z</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">z</span> <span class="main">⟹</span> eval <span class="free">f</span> <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓≠</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">z</span><span class="main">.</span> eval <span class="free">f</span> <span class="main">(</span><span class="bound">z</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">y</span></span><span class="main">&lt;</span><span class="bound">z</span><span class="main">.</span> eval <span class="free">f</span> <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">=</span> Least <span class="var">?P</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms eval_Mn<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> option.inject option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">z</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">z</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms eval_Mn<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> LeastI<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="free">f</span> <span class="main">(</span><span class="free">z</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">y</span></span><span class="main">&lt;</span><span class="free">z</span><span class="main">.</span> eval <span class="free">f</span> <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eval <span class="free">f</span> <span class="main">(</span><span class="free">z</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">z</span> <span class="main">⟹</span> eval <span class="free">f</span> <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> not_less_Least<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">z</span> <span class="main">=</span> Least <span class="var">?P</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="free">z</span>›</span></span> less_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eval_Mn_diverg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>Mn <span class="free">n</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">z</span><span class="main">.</span> eval <span class="free">f</span> <span class="main">(</span><span class="bound">z</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">y</span></span><span class="main">&lt;</span><span class="bound">z</span><span class="main">.</span> eval <span class="free">f</span> <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> eval <span class="main">(</span>Mn <span class="free">n</span> <span class="free">f</span><span class="main">)</span> <span class="free">xs</span> <span class="main">↑</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms eval_Mn<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Extensional equality›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">exteq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"recf <span class="main">⇒</span> recf <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≃</span>"</span> 55<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">≃</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> arity <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> arity <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">xs</span><span class="main">.</span> length <span class="bound">xs</span> <span class="main">=</span> arity <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟶</span> eval <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">xs</span> <span class="main">=</span> eval <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">xs</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> exteq_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≃</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> exteq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> exteq_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≃</span> <span class="free">g</span> <span class="main">⟹</span> <span class="free">g</span> <span class="main">≃</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> exteq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> exteq_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≃</span> <span class="free">g</span> <span class="main">⟹</span> <span class="free">g</span> <span class="main">≃</span> <span class="free">h</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">≃</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> exteq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> exteqI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"arity <span class="free">f</span> <span class="main">=</span> arity <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> length <span class="bound">xs</span> <span class="main">=</span> arity <span class="free">f</span> <span class="main">⟹</span> eval <span class="free">f</span> <span class="bound">xs</span> <span class="main">=</span> eval <span class="free">g</span> <span class="bound">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≃</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms exteq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> exteqI1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"arity <span class="free">f</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"arity <span class="free">g</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> eval <span class="free">f</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">=</span> eval <span class="free">g</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≃</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms exteqI <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_length_conv length_0_conv<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For every partial recursive function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> there are
infinitely many extensionally equal ones, for example, those that wrap <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> arbitrarily often in the identity function.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">wrap_Id</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"recf <span class="main">⇒</span> nat <span class="main">⇒</span> recf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wrap_Id</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">wrap_Id</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> Cn <span class="main">(</span>arity <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">)</span> <span class="main">[</span><span class="free">wrap_Id</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> recfn_wrap_Id<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="free">a</span> <span class="free">f</span> <span class="main">⟹</span> recfn <span class="free">a</span> <span class="main">(</span>wrap_Id <span class="free">f</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wellf_arity_nonzero <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> exteq_wrap_Id<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="free">a</span> <span class="free">f</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">≃</span> wrap_Id <span class="free">f</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exteq_refl<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wrap_Id <span class="free">f</span> <span class="skolem">n</span> <span class="main">≃</span> wrap_Id <span class="free">f</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> "</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> exteqI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"arity <span class="main">(</span>wrap_Id <span class="free">f</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> arity <span class="main">(</span>wrap_Id <span class="free">f</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> recfn_wrap_Id<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>wrap_Id <span class="free">f</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">=</span> eval <span class="main">(</span>wrap_Id <span class="free">f</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> arity <span class="main">(</span>wrap_Id <span class="free">f</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">xs</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>Cn <span class="main">(</span>arity <span class="free">f</span><span class="main">)</span> <span class="main">(</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">)</span> <span class="main">[</span>wrap_Id <span class="free">f</span> <span class="skolem">n</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> that Suc recfn_wrap_Id <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> wrap_Id.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>wrap_Id <span class="free">f</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">=</span> eval <span class="main">(</span>wrap_Id <span class="free">f</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc exteq_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">depth</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"recf <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">depth</span> Z <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">depth</span> S <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">depth</span> <span class="main">(</span>Id <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">depth</span> <span class="main">(</span>Cn <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">gs</span></span></span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>max <span class="main">(</span><span class="free">depth</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span>Max <span class="main">(</span>set <span class="main">(</span>map <span class="free">depth</span> <span class="free"><span class="bound"><span class="entity">gs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">depth</span> <span class="main">(</span>Pr <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>max <span class="main">(</span><span class="free">depth</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">depth</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">depth</span> <span class="main">(</span>Mn <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">depth</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> depth_wrap_Id<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="free">a</span> <span class="free">f</span> <span class="main">⟹</span> depth <span class="main">(</span>wrap_Id <span class="free">f</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> depth <span class="free">f</span> <span class="main">+</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> wrap_Id_injective<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="free">a</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wrap_Id <span class="free">f</span> <span class="free">n<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> wrap_Id <span class="free">f</span> <span class="free">n<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">n<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">n<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_left_cancel depth_wrap_Id<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> exteq_infinite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="free">a</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound">g</span><span class="main">.</span> recfn <span class="free">a</span> <span class="bound">g</span> <span class="main">∧</span> <span class="bound">g</span> <span class="main">≃</span> <span class="free">f</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"infinite <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj <span class="main">(</span>wrap_Id <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wrap_Id_injective <span class="quoted"><span class="quoted">‹recfn <span class="free">a</span> <span class="free">f</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> inj_onI<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>range <span class="main">(</span>wrap_Id <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_imageD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"range <span class="main">(</span>wrap_Id <span class="free">f</span><span class="main">)</span> <span class="main">⊆</span> <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms exteq_sym exteq_wrap_Id recfn_wrap_Id <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> infinite_super<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Primitive recursive and total functions›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">Mn_free</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"recf <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Mn_free</span> Z <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Mn_free</span> S <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Mn_free</span> <span class="main">(</span>Id <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Mn_free</span> <span class="main">(</span>Cn <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">gs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">g</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">gs</span></span></span><span class="main">.</span> <span class="free">Mn_free</span> <span class="bound">g</span><span class="main">)</span> <span class="main">∧</span> <span class="free">Mn_free</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Mn_free</span> <span class="main">(</span>Pr <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">Mn_free</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∧</span> <span class="free">Mn_free</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Mn_free</span> <span class="main">(</span>Mn <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This is our notion of $n$-ary primitive recursive function:›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">prim_recfn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> recf <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">prim_recfn</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> recfn <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∧</span> Mn_free <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">total</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"recf <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">total</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">xs</span><span class="main">.</span> length <span class="bound">xs</span> <span class="main">=</span> arity <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⟶</span> eval <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">xs</span> <span class="main">↓</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> totalI <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> length <span class="bound">xs</span> <span class="main">=</span> arity <span class="free">f</span> <span class="main">⟹</span> eval <span class="free">f</span> <span class="bound">xs</span> <span class="main">↓</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"total <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms total_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> totalE <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"total <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"recfn <span class="free">n</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval <span class="free">f</span> <span class="free">xs</span> <span class="main">↓</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms total_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> totalI1 <span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> eval <span class="free">f</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"total <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms totalI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def length_0_conv length_Suc_conv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> totalI2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> eval <span class="free">f</span> <span class="main">[</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"total <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms totalI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> length_0_conv length_Suc_conv numeral_2_eq_2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> totalI3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">3</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> eval <span class="free">f</span> <span class="main">[</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"total <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms totalI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> length_0_conv length_Suc_conv numeral_3_eq_3<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> totalI4<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">4</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> eval <span class="free">f</span> <span class="main">[</span><span class="bound">w</span><span class="main">,</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"total <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> totalI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> arity <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">w</span><span class="main">,</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">,</span> <span class="skolem">z</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Suc_length_conv length_0_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eval <span class="free">f</span> <span class="skolem">xs</span> <span class="main">↓</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Mn_free_imp_total <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wellf <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Mn_free <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"total <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> Mn_free.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">n</span> <span class="skolem">f</span> <span class="skolem">g</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Pr <span class="skolem">n</span> <span class="skolem">f</span> <span class="skolem">g</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">↓</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> arity <span class="main">(</span>Pr <span class="skolem">n</span> <span class="skolem">f</span> <span class="skolem">g</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">xs</span>
    <span class="keyword1"><span class="command">using</span></span> 5 that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> arity.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> length_Suc_conv totalI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> total_def eval_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prim_recfn_total<span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="free">n</span> <span class="free">f</span> <span class="main">⟹</span> total <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Mn_free_imp_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> eval_Pr_prim_Suc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">=</span> Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval <span class="free">h</span> <span class="main">(</span>Suc <span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> eval <span class="free">g</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> the <span class="main">(</span>eval <span class="free">h</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms eval_Pr_converg_Suc prim_recfn_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> Cn_total<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">g</span><span class="main">∈</span>set <span class="free">gs</span><span class="main">.</span> total <span class="bound">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"total <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"recfn <span class="free">n</span> <span class="main">(</span>Cn <span class="free">n</span> <span class="free">f</span> <span class="free">gs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"total <span class="main">(</span>Cn <span class="free">n</span> <span class="free">f</span> <span class="free">gs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> totalI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Pr_total<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"total <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"total <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"total <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">↓</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">xs</span>
    <span class="keyword1"><span class="command">using</span></span> that assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> totalI <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_length_conv arity.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> eval_Mn_total<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>Mn <span class="free">n</span> <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"total <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Mn <span class="free">n</span> <span class="free">f</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">∃</span><span class="bound">z</span><span class="main">.</span> eval <span class="free">f</span> <span class="main">(</span><span class="bound">z</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">)</span>
     <span class="keyword1">then</span> Some <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">z</span><span class="main">.</span> eval <span class="free">f</span> <span class="main">(</span><span class="bound">z</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">)</span>
     <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Simple functions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This section, too, bears some similarity to Urban's formalization
in Xu et~al.~\cite{Universal_Turing_Machine-AFP}, but is more minimalistic in
scope.

As a general naming rule, instances of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">recf</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and functions
returning such instances get names starting with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">r_</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Typically, for
an <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">r_xyz</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> there will be a lemma <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">r_xyz_recfn</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> or <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span>
<span class="raw_text"><span class="raw_text">r_xyz_prim</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> establishing its (primitive) recursiveness, arity, and
well-formedness. Moreover there will be a lemma <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">r_xyz</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> describing its
semantics, for which we will sometimes introduce an Isabelle function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span>
<span class="raw_text"><span class="raw_text">xyz</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Manipulating parameters›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Appending dummy parameters:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">r_dummy</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> recf <span class="main">⇒</span> recf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">r_dummy</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> Cn <span class="main">(</span>arity <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> Id <span class="main">(</span>arity <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>arity <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_dummy_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"prim_recfn <span class="free">a</span> <span class="free">f</span> <span class="main">⟹</span> prim_recfn <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>r_dummy <span class="free">n</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wellf_arity_nonzero <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_dummy_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> r_dummy_recfn <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"recfn <span class="free">a</span> <span class="free">f</span> <span class="main">⟹</span> recfn <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>r_dummy <span class="free">n</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wellf_arity_nonzero <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_dummy_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> r_dummy <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"r_dummy <span class="free">n</span> <span class="free">f</span> <span class="main">=</span> Cn <span class="main">(</span>arity <span class="free">f</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="free">f</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> Id <span class="main">(</span>arity <span class="free">f</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>arity <span class="free">f</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_dummy_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_dummy_append<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ys</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_dummy <span class="free">n</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> eval <span class="free">f</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"r_dummy <span class="free">n</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?gs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> Id <span class="main">(</span>arity <span class="free">f</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>arity <span class="free">f</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?gs</span> <span class="main">=</span> arity <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?gs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span>Id <span class="main">(</span>arity <span class="free">f</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> arity <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_wellf <span class="main">(</span><span class="var">?gs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">↓=</span> <span class="free">xs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> arity <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> that assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> the <span class="main">(</span>eval_wellf <span class="bound">g</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="var">?gs</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> length_map nth_equalityI nth_map option.sel<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">g</span> <span class="main">∈</span> set <span class="var">?gs</span><span class="main">.</span> eval_wellf <span class="bound">g</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>length <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="var">?r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms r_dummy_recfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms eval_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Shrinking a binary function to a unary one is useful when we want
to define a unary function via the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Pr</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> operation, which can only
construct <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">recf</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>s of arity two or higher.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">r_shrink</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"recf <span class="main">⇒</span> recf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">r_shrink</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> Cn <span class="main">1</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">,</span> Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_shrink_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="numeral">2</span> <span class="free">f</span> <span class="main">⟹</span> prim_recfn <span class="main">1</span> <span class="main">(</span>r_shrink <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_shrink_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> r_shrink_recfn <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="free">f</span> <span class="main">⟹</span> recfn <span class="main">1</span> <span class="main">(</span>r_shrink <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_shrink_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> r_shrink <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="free">f</span> <span class="main">⟹</span> eval <span class="main">(</span>r_shrink <span class="free">f</span><span class="main">)</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> eval <span class="free">f</span> <span class="main">[</span><span class="free">x</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_shrink_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">r_swap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"recf <span class="main">⇒</span> recf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">r_swap</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> Cn <span class="numeral">2</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">1</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">0</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_swap_recfn <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="free">f</span> <span class="main">⟹</span> recfn <span class="numeral">2</span> <span class="main">(</span>r_swap <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_swap_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> r_swap_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="numeral">2</span> <span class="free">f</span> <span class="main">⟹</span> prim_recfn <span class="numeral">2</span> <span class="main">(</span>r_swap <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_swap_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> r_swap <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="free">f</span> <span class="main">⟹</span> eval <span class="main">(</span>r_swap <span class="free">f</span><span class="main">)</span> <span class="main">[</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">]</span> <span class="main">=</span> eval <span class="free">f</span> <span class="main">[</span><span class="free">y</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_swap_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Prepending one dummy parameter:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">r_shift</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"recf <span class="main">⇒</span> recf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">r_shift</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> Cn <span class="main">(</span>Suc <span class="main">(</span>arity <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> Id <span class="main">(</span>Suc <span class="main">(</span>arity <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>arity <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_shift_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="free">a</span> <span class="free">f</span> <span class="main">⟹</span> prim_recfn <span class="main">(</span>Suc <span class="free">a</span><span class="main">)</span> <span class="main">(</span>r_shift <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_shift_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> r_shift_recfn <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="free">a</span> <span class="free">f</span> <span class="main">⟹</span> recfn <span class="main">(</span>Suc <span class="free">a</span><span class="main">)</span> <span class="main">(</span>r_shift <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_shift_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> r_shift <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_shift <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> eval <span class="free">f</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"r_shift <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?gs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> Id <span class="main">(</span>Suc <span class="main">(</span>arity <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>arity <span class="free">f</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?gs</span> <span class="main">=</span> arity <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?gs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span>Id <span class="main">(</span>Suc <span class="main">(</span>arity <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> arity <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span><span class="var">?gs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓=</span> <span class="free">xs</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> arity <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> assms nth_append that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> the <span class="main">(</span>eval <span class="bound">g</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="var">?gs</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms length_map nth_equalityI nth_map option.sel<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">g</span> <span class="main">∈</span> set <span class="var">?gs</span><span class="main">.</span> eval <span class="bound">g</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">≠</span> None"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> r_shift_def assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Arithmetic and logic›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The unary constants:›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">r_const</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> recf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">r_const</span> <span class="main">0</span> <span class="main">=</span> Z"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">r_const</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> Cn <span class="main">1</span> S <span class="main">[</span><span class="free">r_const</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_const_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> <span class="main">(</span>r_const <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> r_const <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_const <span class="free">c</span><span class="main">)</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Constants of higher arities:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_constn</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> r_const <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="keyword1">else</span> r_dummy <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>r_const <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_constn_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>r_constn <span class="free">n</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_constn_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_constn <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> Suc <span class="free">n</span> <span class="main">⟹</span> eval <span class="main">(</span>r_constn <span class="free">n</span> <span class="free">c</span><span class="main">)</span> <span class="free">xs</span> <span class="main">↓=</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_constn_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> length_0_conv length_Suc_conv r_const<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We introduce addition, subtraction, and multiplication, but
interestingly enough we can make do without division.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_add</span> <span class="main">≡</span> Pr <span class="main">1</span> <span class="main">(</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Cn <span class="numeral">3</span> S <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_add_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="numeral">2</span> r_add"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_add_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> r_add <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_add <span class="main">[</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">]</span> <span class="main">↓=</span> <span class="free">a</span> <span class="main">+</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_add_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_mul</span> <span class="main">≡</span> Pr <span class="main">1</span> Z <span class="main">(</span>Cn <span class="numeral">3</span> r_add <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">1</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_mul_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="numeral">2</span> r_mul"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_mul_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_mul <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_mul <span class="main">[</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">]</span> <span class="main">↓=</span> <span class="free">a</span> <span class="main">*</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_mul_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_dec</span> <span class="main">≡</span> Cn <span class="main">1</span> <span class="main">(</span>Pr <span class="main">1</span> Z <span class="main">(</span>Id <span class="numeral">3</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">,</span> Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_dec_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> r_dec"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_dec_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> r_dec <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_dec <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">↓=</span> <span class="free">a</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Pr <span class="main">1</span> Z <span class="main">(</span>Id <span class="numeral">3</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">↓=</span> <span class="skolem">x</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_dec_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_sub</span> <span class="main">≡</span> r_swap <span class="main">(</span>Pr <span class="main">1</span> <span class="main">(</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Cn <span class="numeral">3</span> r_dec <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_sub_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="numeral">2</span> r_sub"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_sub_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_sub <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_sub <span class="main">[</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">]</span> <span class="main">↓=</span> <span class="free">a</span> <span class="main">-</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Pr <span class="main">1</span> <span class="main">(</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Cn <span class="numeral">3</span> r_dec <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">↓=</span> <span class="skolem">y</span> <span class="main">-</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> r_sub_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_sign</span> <span class="main">≡</span> r_shrink <span class="main">(</span>Pr <span class="main">1</span> Z <span class="main">(</span>r_constn <span class="numeral">2</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_sign_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> r_sign"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_sign_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_sign <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_sign <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Pr <span class="main">1</span> Z <span class="main">(</span>r_constn <span class="numeral">2</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> r_sign_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In the logical functions, true will be represented by zero, and
false will be represented by non-zero as argument and by one as
result.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_not</span> <span class="main">≡</span> Cn <span class="main">1</span> r_sub <span class="main">[</span>r_const <span class="main">1</span><span class="main">,</span> r_sign<span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_not_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> r_not"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_not_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_not <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_not <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_not_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_nand</span> <span class="main">≡</span> Cn <span class="numeral">2</span> r_not <span class="main">[</span>r_add<span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_nand_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="numeral">2</span> r_nand"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_nand_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_nand <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_nand <span class="main">[</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_nand_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_and</span> <span class="main">≡</span> Cn <span class="numeral">2</span> r_not <span class="main">[</span>r_nand<span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_and_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="numeral">2</span> r_and"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_and_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_and <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_and <span class="main">[</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_and_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_or</span> <span class="main">≡</span> Cn <span class="numeral">2</span> r_sign <span class="main">[</span>r_mul<span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_or_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="numeral">2</span> r_or"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_or_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_or <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_or <span class="main">[</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">y</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_or_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Comparison and conditions›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_ifz</span> <span class="main">≡</span>
  <span class="keyword1">let</span> <span class="bound">ifzero</span> <span class="main">=</span> <span class="main">(</span>Cn <span class="numeral">3</span> r_mul <span class="main">[</span>r_dummy <span class="numeral">2</span> r_not<span class="main">,</span> Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">ifnzero</span> <span class="main">=</span> <span class="main">(</span>Cn <span class="numeral">3</span> r_mul <span class="main">[</span>r_dummy <span class="numeral">2</span> r_sign<span class="main">,</span> Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">]</span><span class="main">)</span>
  <span class="keyword1">in</span> Cn <span class="numeral">3</span> r_add <span class="main">[</span><span class="bound">ifzero</span><span class="main">,</span> <span class="bound">ifnzero</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_ifz_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="numeral">3</span> r_ifz"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_ifz_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_ifz <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_ifz <span class="main">[</span><span class="free">cond</span><span class="main">,</span> <span class="free">val0</span><span class="main">,</span> <span class="free">val1</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">cond</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free">val0</span> <span class="keyword1">else</span> <span class="free">val1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_ifz_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_eq</span> <span class="main">≡</span> Cn <span class="numeral">2</span> r_sign <span class="main">[</span>Cn <span class="numeral">2</span> r_add <span class="main">[</span>r_sub<span class="main">,</span> r_swap r_sub<span class="main">]</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_eq_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="numeral">2</span> r_eq"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_eq <span class="main">[</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_ifeq</span> <span class="main">≡</span> Cn <span class="numeral">4</span> r_ifz <span class="main">[</span>r_dummy <span class="numeral">2</span> r_eq<span class="main">,</span> Id <span class="numeral">4</span> <span class="numeral">2</span><span class="main">,</span> Id <span class="numeral">4</span> <span class="numeral">3</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_ifeq_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="numeral">4</span> r_ifeq"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_ifeq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_ifeq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_ifeq <span class="main">[</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">,</span> <span class="free">v<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">]</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="free">v<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">else</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_ifeq_def <span class="keyword1"><span class="command">using</span></span> r_dummy_append<span class="main">[</span><span class="operator">of</span> <span class="quoted">r_eq</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">v<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">]</span>"</span></span> <span class="quoted"><span class="numeral">2</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_neq</span> <span class="main">≡</span> Cn <span class="numeral">2</span> r_not <span class="main">[</span>r_eq<span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_neq_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="numeral">2</span> r_neq"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_neq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_neq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_neq <span class="main">[</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_neq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_ifle</span> <span class="main">≡</span> Cn <span class="numeral">4</span> r_ifz <span class="main">[</span>r_dummy <span class="numeral">2</span> r_sub<span class="main">,</span> Id <span class="numeral">4</span> <span class="numeral">2</span><span class="main">,</span> Id <span class="numeral">4</span> <span class="numeral">3</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_ifle_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="numeral">4</span> r_ifle"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_ifle_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_ifle <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_ifle <span class="main">[</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">,</span> <span class="free">v<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">]</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="main">≤</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="free">v<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">else</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_ifle_def <span class="keyword1"><span class="command">using</span></span> r_dummy_append<span class="main">[</span><span class="operator">of</span> <span class="quoted">r_sub</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">v<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">]</span>"</span></span> <span class="quoted"><span class="numeral">2</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_ifless</span> <span class="main">≡</span> Cn <span class="numeral">4</span> r_ifle <span class="main">[</span>Id <span class="numeral">4</span> <span class="main">1</span><span class="main">,</span> Id <span class="numeral">4</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">4</span> <span class="numeral">3</span><span class="main">,</span> Id <span class="numeral">4</span> <span class="numeral">2</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_ifless_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="numeral">4</span> r_ifless"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_ifless_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_ifless <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_ifless <span class="main">[</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">,</span> <span class="free">v<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">]</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="free">v<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">else</span> <span class="free">v<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_ifless_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_less</span> <span class="main">≡</span> Cn <span class="numeral">2</span> r_ifle <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">1</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">0</span><span class="main">,</span> r_constn <span class="main">1</span> <span class="main">1</span><span class="main">,</span> r_constn <span class="main">1</span> <span class="main">0</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_less_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="numeral">2</span> r_less"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_less_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_less <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_less <span class="main">[</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">y</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_less_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_le</span> <span class="main">≡</span> Cn <span class="numeral">2</span> r_ifle <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">1</span><span class="main">,</span> r_constn <span class="main">1</span> <span class="main">0</span><span class="main">,</span> r_constn <span class="main">1</span> <span class="main">1</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_le_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="numeral">2</span> r_le"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_le_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_le <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_le <span class="main">[</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_le_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Arguments are evaluated eagerly. Therefore <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"r_ifz"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, etc.
cannot be combined with a diverging function to implement a conditionally
diverging function in the naive way. The following function implements a
special case needed in the next section. A \hyperlink{p:r_lifz}{general lazy
version} of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"r_ifz"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> will be introduced later with the help of a
universal function.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_ifeq_else_diverg</span> <span class="main">≡</span>
  Cn <span class="numeral">3</span> r_add <span class="main">[</span>Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">,</span> Mn <span class="numeral">3</span> <span class="main">(</span>Cn <span class="numeral">4</span> r_add <span class="main">[</span>Id <span class="numeral">4</span> <span class="main">0</span><span class="main">,</span> Cn <span class="numeral">4</span> r_eq <span class="main">[</span>Id <span class="numeral">4</span> <span class="main">1</span><span class="main">,</span> Id <span class="numeral">4</span> <span class="numeral">2</span><span class="main">]</span><span class="main">]</span><span class="main">)</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_ifeq_else_diverg_recfn <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">3</span> r_ifeq_else_diverg"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_ifeq_else_diverg_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_ifeq_else_diverg <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"eval r_ifeq_else_diverg <span class="main">[</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">,</span> <span class="free">v</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="main">=</span> <span class="free">b</span> <span class="keyword1">then</span> Some <span class="free">v</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_ifeq_else_diverg_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The halting problem\label{s:halting}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Decidability will be treated more thoroughly in
Section~\ref{s:decidable}. But the halting problem is prominent enough to
deserve an early mention.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">decidable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">decidable</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">f</span><span class="main">.</span> recfn <span class="main">1</span> <span class="bound">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> eval <span class="bound">f</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹No matter how partial recursive functions are encoded as natural
numbers, the set of all codes of functions halting on their own code is
undecidable.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> halting_problem_undecidable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">code</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> recf"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> recfn <span class="main">1</span> <span class="bound">f</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="free">code</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> decidable <span class="main">{</span><span class="bound">x</span><span class="main">.</span> eval <span class="main">(</span><span class="free">code</span> <span class="bound">x</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">↓</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> decidable <span class="var">?K</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"decidable <span class="var">?K</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> eval <span class="skolem">f</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="var">?K</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> decidable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">≡</span> Cn <span class="main">1</span> r_ifeq_else_diverg <span class="main">[</span><span class="skolem">f</span><span class="main">,</span> Z<span class="main">,</span> Z<span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">g</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">f</span>›</span></span> r_ifeq_else_diverg_recfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">code</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> g_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">g</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="var">?K</span> <span class="keyword1">then</span> Some <span class="main">0</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> r_ifeq_else_diverg_recfn <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">f</span>›</span></span> f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">g</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span> <span class="main">↓</span> <span class="main">⟷</span> <span class="skolem">i</span> <span class="main">∉</span> <span class="var">?K</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⟷</span> eval <span class="main">(</span><span class="free">code</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span> <span class="main">↑</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⟷</span> eval <span class="skolem">g</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span> <span class="main">↑</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">g</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span> <span class="main">↓</span> <span class="main">⟷</span> eval <span class="skolem">g</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span> <span class="main">↑</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Encoding tuples and lists›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This section is based on the Cantor encoding for pairs. Tuples
are encoded by repeated application of the pairing function, lists by pairing
their length with the code for a tuple. Thus tuples have a fixed length that
must be known when decoding, whereas lists are dynamically sized and know
their current length.›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Pairs and tuples›</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The Cantor pairing function›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_triangle</span> <span class="main">≡</span> r_shrink <span class="main">(</span>Pr <span class="main">1</span> Z <span class="main">(</span>r_dummy <span class="main">1</span> <span class="main">(</span>Cn <span class="numeral">2</span> S <span class="main">[</span>r_add<span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_triangle_prim<span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> r_triangle"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_triangle_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_triangle<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_triangle <span class="main">[</span><span class="free">n</span><span class="main">]</span> <span class="main">↓=</span> Sum <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"r_dummy <span class="main">1</span> <span class="main">(</span>Cn <span class="numeral">2</span> S <span class="main">[</span>r_add<span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?r</span> <span class="main">[</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">,</span> <span class="skolem">z</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="main">(</span><span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span>
    <span class="keyword1"><span class="command">using</span></span> r_dummy_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Cn <span class="numeral">2</span> S <span class="main">[</span>r_add<span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">z</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Pr <span class="main">1</span> Z <span class="var">?r</span><span class="main">)</span> <span class="main">[</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">↓=</span> Sum <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> r_triangle_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_triangle_eq_triangle <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_triangle <span class="main">[</span><span class="free">n</span><span class="main">]</span> <span class="main">↓=</span> triangle <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> r_triangle gauss_sum_nat triangle_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_prod_encode</span> <span class="main">≡</span> Cn <span class="numeral">2</span> r_add <span class="main">[</span>Cn <span class="numeral">2</span> r_triangle <span class="main">[</span>r_add<span class="main">]</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">0</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_prod_encode_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="numeral">2</span> r_prod_encode"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_prod_encode_def <span class="keyword1"><span class="command">using</span></span> r_triangle_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_prod_encode <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_prod_encode <span class="main">[</span><span class="free">m</span><span class="main">,</span> <span class="free">n</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="free">m</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_prod_encode_def prod_encode_def <span class="keyword1"><span class="command">using</span></span> r_triangle_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹These abbreviations are just two more things borrowed from
Xu~et~al.~\cite{Universal_Turing_Machine-AFP}.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">pdec1</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">≡</span> fst <span class="main">(</span>prod_decode <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">pdec2</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">≡</span> snd <span class="main">(</span>prod_decode <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pdec1_le<span class="main">:</span> <span class="quoted"><span class="quoted">"pdec1 <span class="free">i</span> <span class="main">≤</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_prod_encode_1 prod.collapse prod_decode_inverse<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pdec2_le<span class="main">:</span> <span class="quoted"><span class="quoted">"pdec2 <span class="free">i</span> <span class="main">≤</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_prod_encode_2 prod.collapse prod_decode_inverse<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pdec_less<span class="main">:</span> <span class="quoted"><span class="quoted">"pdec2 <span class="free">i</span> <span class="main">&lt;</span> Suc <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pdec2_le <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_imp_less_Suc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pdec1_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"pdec1 <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pdec1_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_maxletr</span> <span class="main">≡</span>
  Pr <span class="main">1</span> Z <span class="main">(</span>Cn <span class="numeral">3</span> r_ifle <span class="main">[</span>r_dummy <span class="numeral">2</span> <span class="main">(</span>Cn <span class="main">1</span> r_triangle <span class="main">[</span>S<span class="main">]</span><span class="main">)</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">,</span> Cn <span class="numeral">3</span> S <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_maxletr_prim<span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="numeral">2</span> r_maxletr"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_maxletr_def <span class="keyword1"><span class="command">using</span></span> r_triangle_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> not_Suc_Greatest_not_Suc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">P</span> <span class="main">(</span>Suc <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≤</span> Suc <span class="free">x</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_SucI le_Suc_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> r_maxletr<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_maxletr <span class="main">[</span><span class="free">x<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">x<span class="hidden">⇩</span><sub>1</sub></span><span class="main">]</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≤</span> <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> triangle <span class="bound">y</span> <span class="main">≤</span> <span class="free">x<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="numeral">3</span> r_ifle <span class="main">[</span>r_dummy <span class="numeral">2</span> <span class="main">(</span>Cn <span class="main">1</span> r_triangle <span class="main">[</span>S<span class="main">]</span><span class="main">)</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">,</span> Cn <span class="numeral">3</span> S <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> greatest<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> triangle <span class="main">(</span>Suc <span class="skolem">x<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">x<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">then</span> Suc <span class="skolem">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≤</span> <span class="skolem">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> triangle <span class="bound">y</span> <span class="main">≤</span> <span class="skolem">x<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≤</span> Suc <span class="skolem">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> triangle <span class="bound">y</span> <span class="main">≤</span> <span class="skolem">x<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>1</sub></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"triangle <span class="main">(</span>Suc <span class="skolem">x<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">x<span class="hidden">⇩</span><sub>1</sub></span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Greatest_equality<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≤</span> Suc <span class="skolem">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> triangle <span class="bound">y</span> <span class="main">≤</span> <span class="skolem">x<span class="hidden">⇩</span><sub>1</sub></span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> not_Suc_Greatest_not_Suc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">y</span><span class="main">.</span> triangle <span class="bound">y</span> <span class="main">≤</span> <span class="skolem">x<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="skolem">x<span class="hidden">⇩</span><sub>0</sub></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> r_maxletr_def <span class="keyword1"><span class="command">using</span></span> r_triangle_prim 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x<span class="hidden">⇩</span><sub>0</sub></span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Greatest_equality<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≤</span> <span class="main">0</span> <span class="main">∧</span> triangle <span class="bound">y</span> <span class="main">≤</span> <span class="free">x<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">x<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> greatest <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_maxlt</span> <span class="main">≡</span> r_shrink r_maxletr"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_maxlt_prim<span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> r_maxlt"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_maxlt_def <span class="keyword1"><span class="command">using</span></span> r_maxletr_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_maxlt<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_maxlt <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">y</span><span class="main">.</span> triangle <span class="bound">y</span> <span class="main">≤</span> <span class="free">e</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≤</span> triangle <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"triangle <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">e</span> <span class="main">⟹</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">e</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span> <span class="skolem">e</span>
    <span class="keyword1"><span class="command">using</span></span> order_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≤</span> <span class="free">e</span> <span class="main">∧</span> triangle <span class="bound">y</span> <span class="main">≤</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">y</span><span class="main">.</span> triangle <span class="bound">y</span> <span class="main">≤</span> <span class="free">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_maxlt <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≤</span> <span class="free">e</span> <span class="main">∧</span> triangle <span class="bound">y</span> <span class="main">≤</span> <span class="free">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_maxletr r_shrink r_maxlt_def r_maxletr_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pdec1'</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">-</span> triangle <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">y</span><span class="main">.</span> triangle <span class="bound">y</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pdec2'</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">y</span><span class="main">.</span> triangle <span class="bound">y</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">-</span> pdec1' <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> max_triangle_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"triangle <span class="free">z</span> <span class="main">≤</span> <span class="free">e</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">≤</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_pred add_leD2 less_Suc_eq triangle_Suc zero_le zero_less_Suc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> triangle_greatest_le<span class="main">:</span> <span class="quoted"><span class="quoted">"triangle <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">y</span><span class="main">.</span> triangle <span class="bound">y</span> <span class="main">≤</span> <span class="free">e</span><span class="main">)</span> <span class="main">≤</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> max_triangle_bound GreatestI_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">y</span><span class="main">.</span> triangle <span class="bound">y</span> <span class="main">≤</span> <span class="free">e</span>"</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">e</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> prod_encode_pdec'<span class="main">:</span> <span class="quoted"><span class="quoted">"prod_encode <span class="main">(</span>pdec1' <span class="free">e</span><span class="main">,</span> pdec2' <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">y</span><span class="main">.</span> triangle <span class="bound">y</span> <span class="main">≤</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">GREATEST</span> <span class="bound">y</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pdec1' <span class="free">e</span> <span class="main">≤</span> <span class="var">?y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> pdec1' <span class="free">e</span> <span class="main">≤</span> <span class="var">?y</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">-</span> triangle <span class="var">?y</span> <span class="main">&gt;</span> <span class="var">?y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pdec1'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>Suc <span class="var">?y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">z</span> <span class="main">⟶</span> <span class="bound">z</span> <span class="main">≤</span> <span class="free">e</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> max_triangle_bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="var">?y</span> <span class="main">≤</span> <span class="var">?y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Greatest_le_nat<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="quoted"><span class="quoted">"Suc <span class="var">?y</span>"</span></span> <span class="quoted"><span class="free">e</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pdec1' <span class="free">e</span> <span class="main">+</span> pdec2' <span class="free">e</span> <span class="main">=</span> <span class="var">?y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pdec1'_def pdec2'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prod_encode <span class="main">(</span>pdec1' <span class="free">e</span><span class="main">,</span> pdec2' <span class="free">e</span><span class="main">)</span> <span class="main">=</span> triangle <span class="var">?y</span> <span class="main">+</span> pdec1' <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_encode_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> pdec1'_def triangle_greatest_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pdec'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pdec1' <span class="free">e</span> <span class="main">=</span> pdec1 <span class="free">e</span>"</span></span>
  <span class="quoted"><span class="quoted">"pdec2' <span class="free">e</span> <span class="main">=</span> pdec2 <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> prod_encode_pdec' prod_encode_inverse <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> snd_conv<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_pdec1</span> <span class="main">≡</span> Cn <span class="main">1</span> r_sub <span class="main">[</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">,</span> Cn <span class="main">1</span> r_triangle <span class="main">[</span>r_maxlt<span class="main">]</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_pdec1_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> r_pdec1"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_pdec1_def <span class="keyword1"><span class="command">using</span></span> r_triangle_prim r_maxlt_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_pdec1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_pdec1 <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">↓=</span> pdec1 <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_pdec1_def <span class="keyword1"><span class="command">using</span></span> r_triangle_prim r_maxlt_prim pdec' pdec1'_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_maxlt<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_pdec2</span> <span class="main">≡</span> Cn <span class="main">1</span> r_sub <span class="main">[</span>r_maxlt<span class="main">,</span> r_pdec1<span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_pdec2_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> r_pdec2"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_pdec2_def <span class="keyword1"><span class="command">using</span></span> r_maxlt_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_pdec2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_pdec2 <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">↓=</span> pdec2 <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_pdec2_def <span class="keyword1"><span class="command">using</span></span> r_maxlt_prim r_maxlt pdec' pdec2'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">pdec12</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> pdec1 <span class="main">(</span>pdec2 <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">pdec22</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> pdec2 <span class="main">(</span>pdec2 <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">pdec122</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> pdec1 <span class="main">(</span>pdec22 <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">pdec222</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> pdec2 <span class="main">(</span>pdec22 <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_pdec12</span> <span class="main">≡</span> Cn <span class="main">1</span> r_pdec1 <span class="main">[</span>r_pdec2<span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_pdec12_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> r_pdec12"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_pdec12_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_pdec12 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_pdec12 <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">↓=</span> pdec12 <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_pdec12_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_pdec22</span> <span class="main">≡</span> Cn <span class="main">1</span> r_pdec2 <span class="main">[</span>r_pdec2<span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_pdec22_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> r_pdec22"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_pdec22_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_pdec22 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_pdec22 <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">↓=</span> pdec22 <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_pdec22_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_pdec122</span> <span class="main">≡</span> Cn <span class="main">1</span> r_pdec1 <span class="main">[</span>r_pdec22<span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_pdec122_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> r_pdec122"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_pdec122_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_pdec122 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_pdec122 <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">↓=</span> pdec122 <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_pdec122_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_pdec222</span> <span class="main">≡</span> Cn <span class="main">1</span> r_pdec2 <span class="main">[</span>r_pdec22<span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_pdec222_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> r_pdec222"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_pdec222_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_pdec222 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_pdec222 <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">↓=</span> pdec222 <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_pdec222_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The Cantor tuple function›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The empty tuple gets no code, whereas singletons are encoded by their
only element and other tuples by recursively applying the pairing function.
This yields, for every $n$, the function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">tuple_encode</span></span> <span class="free"><span class="free">n</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, which is a
bijection between the natural numbers and the lists of length $(n + 1)$.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">tuple_encode</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tuple_encode</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">[]</span> <span class="main">=</span> undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">tuple_encode</span> <span class="main">0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">tuple_encode</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> prod_encode <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free">tuple_encode</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tuple_encode_prod_encode<span class="main">:</span> <span class="quoted"><span class="quoted">"tuple_encode <span class="main">1</span> <span class="main">[</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">]</span> <span class="main">=</span> prod_encode <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">tuple_decode</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tuple_decode</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">tuple_decode</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> pdec1 <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">#</span> <span class="free">tuple_decode</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>pdec2 <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tuple_encode_decode <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"tuple_encode <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>tuple_decode <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"tuple_encode <span class="skolem">n</span> <span class="main">(</span>tuple_decode <span class="skolem">n</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_Suc_1 length_tl<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Suc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tuple_decode <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">=</span> pdec1 <span class="skolem">i</span> <span class="main">#</span> tuple_decode <span class="skolem">n</span> <span class="main">(</span>pdec2 <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tuple_decode.simps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tuple_encode <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>tuple_decode <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span>
      tuple_encode <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>pdec1 <span class="skolem">i</span> <span class="main">#</span> tuple_decode <span class="skolem">n</span> <span class="main">(</span>pdec2 <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> prod_encode <span class="main">(</span>pdec1 <span class="skolem">i</span><span class="main">,</span> tuple_encode <span class="skolem">n</span> <span class="main">(</span>tuple_decode <span class="skolem">n</span> <span class="main">(</span>pdec2 <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> prod_encode <span class="main">(</span>pdec1 <span class="skolem">i</span><span class="main">,</span> pdec2 <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tuple_encode <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>tuple_decode <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tuple_encode_decode' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"tuple_encode <span class="free">n</span> <span class="main">(</span>tuple_decode <span class="free">n</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> tuple_encode_decode <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Ex_list_of_length diff_Suc_1 length_Cons<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> tuple_decode_encode<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tuple_decode <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>tuple_encode <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def length_0_conv length_Suc_conv tuple_decode.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
      tuple_encode.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"tl <span class="skolem">xs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"tuple_encode <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?t</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?t</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tuple_decode <span class="skolem">n</span> <span class="main">(</span>tuple_encode <span class="skolem">n</span> <span class="var">?t</span><span class="main">)</span> <span class="main">=</span> <span class="var">?t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">=</span> prod_encode <span class="main">(</span>hd <span class="skolem">xs</span><span class="main">,</span> tuple_encode <span class="skolem">n</span> <span class="var">?t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hd_Cons_tl length_greater_0_conv tuple_encode.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tuple_decode <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="var">?i</span> <span class="main">=</span> pdec1 <span class="var">?i</span> <span class="main">#</span> tuple_decode <span class="skolem">n</span> <span class="main">(</span>pdec2 <span class="var">?i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tuple_decode.simps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tuple_decode <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="var">?i</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tuple_decode_encode' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tuple_decode <span class="free">n</span> <span class="main">(</span>tuple_encode <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms tuple_decode_encode <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_Suc_1 zero_less_Suc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> tuple_decode_length <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>tuple_decode <span class="free">n</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> tuple_decode_nonzero<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tuple_decode <span class="free">n</span> <span class="free">i</span> <span class="main">=</span> pdec1 <span class="free">i</span> <span class="main">#</span> tuple_decode <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>pdec2 <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_pred tuple_decode.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The tuple encoding functions are primitive recursive.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">r_tuple_encode</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> recf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">r_tuple_encode</span> <span class="main">0</span> <span class="main">=</span> Id <span class="main">1</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">r_tuple_encode</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span>
     Cn <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> r_prod_encode <span class="main">[</span>Id <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">0</span><span class="main">,</span> r_shift <span class="main">(</span><span class="free">r_tuple_encode</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_tuple_encode_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>r_tuple_encode <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> r_tuple_encode<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_tuple_encode <span class="free">n</span><span class="main">)</span> <span class="free">xs</span> <span class="main">↓=</span> tuple_encode <span class="free">n</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def eval_Id length_Suc_conv nth_Cons_0
      r_tuple_encode.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> tuple_encode.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> zero_less_one<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> y_ys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_Suc_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_tuple_encode <span class="skolem">n</span><span class="main">)</span> <span class="skolem">ys</span> <span class="main">↓=</span> tuple_encode <span class="skolem">n</span> <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> y_ys <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_shift <span class="main">(</span>r_tuple_encode <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">↓=</span> tuple_encode <span class="skolem">n</span> <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc.prems r_shift_prim r_tuple_encode_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Id <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">↓=</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> y_ys Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_tuple_encode <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="skolem">y</span><span class="main">,</span> tuple_encode <span class="skolem">n</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> y_ys <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Functions on encoded tuples›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The function for accessing the $n$-th element of a tuple returns
$0$ for out-of-bounds access.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">e_tuple_nth</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">e_tuple_nth</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">then</span> <span class="main">(</span>tuple_decode <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">else</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> e_tuple_nth_le <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">⟹</span> e_tuple_nth <span class="free">a</span> <span class="free">i</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span>tuple_decode <span class="free">a</span> <span class="free">i</span><span class="main">)</span> <span class="main">!</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> e_tuple_nth_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> e_tuple_nth_gr <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="free">a</span> <span class="main">⟹</span> e_tuple_nth <span class="free">a</span> <span class="free">i</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> e_tuple_nth_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> tuple_decode_pdec2<span class="main">:</span> <span class="quoted"><span class="quoted">"tuple_decode <span class="free">a</span> <span class="main">(</span>pdec2 <span class="free">es</span><span class="main">)</span> <span class="main">=</span> tl <span class="main">(</span>tuple_decode <span class="main">(</span>Suc <span class="free">a</span><span class="main">)</span> <span class="free">es</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">iterate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">iterate</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> id"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">iterate</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∘</span> <span class="main">(</span><span class="free">iterate</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> iterate_additive<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"iterate <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"iterate <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">f</span> <span class="free">y</span> <span class="main">=</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"iterate <span class="main">(</span><span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">z</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> iterate_additive'<span class="main">:</span> <span class="quoted"><span class="quoted">"iterate <span class="main">(</span><span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> iterate <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">f</span> <span class="main">(</span>iterate <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> iterate_additive <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> e_tuple_nth_elementary<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"e_tuple_nth <span class="free">a</span> <span class="free">i</span> <span class="free">k</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="main">=</span> <span class="free">k</span> <span class="keyword1">then</span> <span class="main">(</span>iterate <span class="free">k</span> pdec2 <span class="free">i</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span>pdec1 <span class="main">(</span>iterate <span class="free">k</span> pdec2 <span class="free">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"tuple_decode <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>iterate <span class="free">k</span> pdec2 <span class="free">i</span><span class="main">)</span> <span class="main">=</span> drop <span class="free">k</span> <span class="main">(</span>tuple_decode <span class="free">a</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc_diff_Suc tuple_decode_pdec2 drop_Suc tl_drop<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">k</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tuple_decode <span class="main">0</span> <span class="main">(</span>iterate <span class="free">k</span> pdec2 <span class="free">i</span><span class="main">)</span> <span class="main">=</span> drop <span class="free">k</span> <span class="main">(</span>tuple_decode <span class="free">a</span> <span class="free">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"drop <span class="free">k</span> <span class="main">(</span>tuple_decode <span class="free">a</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span>tuple_decode <span class="free">a</span> <span class="free">i</span> <span class="main">!</span> <span class="free">k</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nth_via_drop tuple_decode.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">-</span> <span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tuple_decode <span class="main">(</span><span class="free">a</span> <span class="main">-</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>iterate <span class="free">k</span> pdec2 <span class="free">i</span><span class="main">)</span> <span class="main">=</span> drop <span class="free">k</span> <span class="main">(</span>tuple_decode <span class="free">a</span> <span class="free">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pdec1 <span class="main">(</span>iterate <span class="free">k</span> pdec2 <span class="free">i</span><span class="main">)</span> <span class="main">=</span> hd <span class="main">(</span>drop <span class="free">k</span> <span class="main">(</span>tuple_decode <span class="free">a</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tuple_decode_nonzero <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">-</span> <span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">a</span> <span class="main">-</span> <span class="free">k</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pdec1 <span class="main">(</span>iterate <span class="free">k</span> pdec2 <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>tuple_decode <span class="free">a</span> <span class="free">i</span><span class="main">)</span> <span class="main">!</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hd_drop_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> False assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_nth_inbounds</span> <span class="main">≡</span>
  <span class="keyword1">let</span> <span class="bound">r</span> <span class="main">=</span> Pr <span class="main">1</span> <span class="main">(</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Cn <span class="numeral">3</span> r_pdec2 <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span>
  <span class="keyword1">in</span> Cn <span class="numeral">3</span> r_ifeq
       <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">0</span><span class="main">,</span>
        Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">,</span>
        Cn <span class="numeral">3</span> <span class="bound">r</span> <span class="main">[</span>Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span><span class="main">,</span>
        Cn <span class="numeral">3</span> r_pdec1 <span class="main">[</span>Cn <span class="numeral">3</span> <span class="bound">r</span> <span class="main">[</span>Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_nth_inbounds_prim<span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="numeral">3</span> r_nth_inbounds"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_nth_inbounds_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> r_nth_inbounds<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">⟹</span> eval r_nth_inbounds <span class="main">[</span><span class="free">a</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">k</span><span class="main">]</span> <span class="main">↓=</span> e_tuple_nth <span class="free">a</span> <span class="free">i</span> <span class="free">k</span>"</span></span>
  <span class="quoted"><span class="quoted">"eval r_nth_inbounds <span class="main">[</span><span class="free">a</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">k</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Pr <span class="main">1</span> <span class="main">(</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Cn <span class="numeral">3</span> r_pdec2 <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="numeral">3</span> <span class="var">?r</span> <span class="main">[</span>Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?r</span> <span class="main">[</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">i</span><span class="main">]</span> <span class="main">↓=</span> iterate <span class="skolem">k</span> pdec2 <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> r_pdec2_prim <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?h</span> <span class="main">[</span><span class="free">a</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">k</span><span class="main">]</span> <span class="main">↓=</span> iterate <span class="free">k</span> pdec2 <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_pdec2_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_nth_inbounds <span class="main">[</span><span class="free">a</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">k</span><span class="main">]</span> <span class="main">↓=</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="main">=</span> <span class="free">k</span> <span class="keyword1">then</span> iterate <span class="free">k</span> pdec2 <span class="free">i</span> <span class="keyword1">else</span> pdec1 <span class="main">(</span>iterate <span class="free">k</span> pdec2 <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> r_nth_inbounds_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">⟹</span> eval r_nth_inbounds <span class="main">[</span><span class="free">a</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">k</span><span class="main">]</span> <span class="main">↓=</span> e_tuple_nth <span class="free">a</span> <span class="free">i</span> <span class="free">k</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eval r_nth_inbounds <span class="main">[</span><span class="free">a</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">k</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> e_tuple_nth_elementary <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_tuple_nth</span> <span class="main">≡</span>
  Cn <span class="numeral">3</span> r_ifle <span class="main">[</span>Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">0</span><span class="main">,</span> r_nth_inbounds<span class="main">,</span> r_constn <span class="numeral">2</span> <span class="main">0</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_tuple_nth_prim<span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="numeral">3</span> r_tuple_nth"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_tuple_nth_def <span class="keyword1"><span class="command">using</span></span> r_nth_inbounds_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_tuple_nth <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_tuple_nth <span class="main">[</span><span class="free">a</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">k</span><span class="main">]</span> <span class="main">↓=</span> e_tuple_nth <span class="free">a</span> <span class="free">i</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_tuple_nth_def <span class="keyword1"><span class="command">using</span></span> r_nth_inbounds_prim r_nth_inbounds <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lists›</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Encoding and decoding›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lists are encoded by pairing the length of the list with the code
for the tuple made up of the list's elements. Then all these codes are
incremented in order to make room for the empty list
(cf.~Rogers~\cite[p.~71]{Rogers87}).›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">list_encode</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">list_encode</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">list_encode</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>prod_encode <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> tuple_encode <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> list_encode_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"list_encode <span class="free">xs</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> list_encode.elims <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> list_encode_1<span class="main">:</span> <span class="quoted"><span class="quoted">"list_encode <span class="main">[</span><span class="main">0</span><span class="main">]</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_encode_def<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">list_decode</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">list_decode</span> <span class="main">0</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">list_decode</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> tuple_decode <span class="main">(</span>pdec1 <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>pdec2 <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> list_encode_decode <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"list_encode <span class="main">(</span>list_decode <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"list_decode <span class="free">n</span> <span class="main">=</span> tuple_decode <span class="main">(</span>pdec1 <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span>pdec2 <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?t</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> xxs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="var">?t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> tuple_decode.elims<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_encode <span class="var">?t</span> <span class="main">=</span> list_encode <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"list_encode <span class="var">?t</span> <span class="main">=</span> Suc <span class="main">(</span>prod_encode <span class="main">(</span>length <span class="skolem">xs</span><span class="main">,</span> tuple_encode <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> length <span class="var">?t</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> xxs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_tl list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> pdec1 <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tuple_encode <span class="main">(</span>length <span class="var">?t</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="var">?t</span> <span class="main">=</span> pdec2 <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 2 tuple_encode_decode <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_encode <span class="var">?t</span> <span class="main">=</span> Suc <span class="main">(</span>prod_encode <span class="main">(</span>pdec1 <span class="skolem">k</span><span class="main">,</span> pdec2 <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 1 2 3 xxs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> * Suc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> list_decode_encode <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"list_decode <span class="main">(</span>list_encode <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_encode <span class="free">xs</span> <span class="main">=</span>
      Suc <span class="main">(</span>prod_encode <span class="main">(</span>length <span class="skolem">ys</span><span class="main">,</span> tuple_encode <span class="main">(</span>length <span class="skolem">ys</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> Suc <span class="var">?i</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_decode <span class="main">(</span>Suc <span class="var">?i</span><span class="main">)</span> <span class="main">=</span> tuple_decode <span class="main">(</span>pdec1 <span class="var">?i</span><span class="main">)</span> <span class="main">(</span>pdec2 <span class="var">?i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pdec1 <span class="var">?i</span> <span class="main">=</span> length <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pdec2 <span class="var">?i</span> <span class="main">=</span> tuple_encode <span class="main">(</span>length <span class="skolem">ys</span><span class="main">)</span> <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_decode <span class="main">(</span>Suc <span class="var">?i</span><span class="main">)</span> <span class="main">=</span>
      tuple_decode <span class="main">(</span>length <span class="skolem">ys</span><span class="main">)</span> <span class="main">(</span>tuple_encode <span class="main">(</span>length <span class="skolem">ys</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ys</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_decode <span class="main">(</span>Suc <span class="var">?i</span><span class="main">)</span> <span class="main">=</span>
      tuple_decode <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>tuple_encode <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">singleton_encode</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">singleton_encode</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> list_encode <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> list_decode_singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"list_decode <span class="main">(</span>singleton_encode <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_singleton_encode</span> <span class="main">≡</span> Cn <span class="main">1</span> S <span class="main">[</span>Cn <span class="main">1</span> r_prod_encode <span class="main">[</span>Z<span class="main">,</span> Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_singleton_encode_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> r_singleton_encode"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_singleton_encode_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_singleton_encode <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_singleton_encode <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> singleton_encode <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_singleton_encode_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">r_list_encode</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> recf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">r_list_encode</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> Cn <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> S <span class="main">[</span>Cn <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> r_prod_encode <span class="main">[</span>r_constn <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> r_tuple_encode <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">]</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_list_encode_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>r_list_encode <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_list_encode_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_list_encode<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_list_encode <span class="free">n</span><span class="main">)</span> <span class="free">xs</span> <span class="main">↓=</span> list_encode <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_tuple_encode <span class="free">n</span><span class="main">)</span> <span class="free">xs</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms r_tuple_encode<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Cn <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> r_prod_encode <span class="main">[</span>r_constn <span class="free">n</span> <span class="free">n</span><span class="main">,</span> r_tuple_encode <span class="free">n</span><span class="main">]</span><span class="main">)</span> <span class="free">xs</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_list_encode <span class="free">n</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span>
      eval S <span class="main">[</span>the <span class="main">(</span>eval <span class="main">(</span>Cn <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> r_prod_encode <span class="main">[</span>r_constn <span class="free">n</span> <span class="free">n</span><span class="main">,</span> r_tuple_encode <span class="free">n</span><span class="main">]</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> r_list_encode_def <span class="keyword1"><span class="command">using</span></span> assms r_tuple_encode <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> length_Suc_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> r_list_encode_def <span class="keyword1"><span class="command">using</span></span> assms r_tuple_encode <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Functions on encoded lists›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The functions in this section mimic those on type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"nat
list"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Their names are prefixed by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">e_</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and the names of the
corresponding <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">recf</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>s by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">r_</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">e_tl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">e_tl</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> list_encode <span class="main">(</span>tl <span class="main">(</span>list_decode <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In order to turn <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">e_tl</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> into a partial recursive function
we first represent it in a more elementary way.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> e_tl_elementary<span class="main">:</span>
  <span class="quoted"><span class="quoted">"e_tl <span class="free">e</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free">e</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span>
     <span class="keyword1">else</span> <span class="keyword1">if</span> pdec1 <span class="main">(</span><span class="free">e</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span>
     <span class="keyword1">else</span> Suc <span class="main">(</span>prod_encode <span class="main">(</span>pdec1 <span class="main">(</span><span class="free">e</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">,</span> pdec22 <span class="main">(</span><span class="free">e</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Suc_d<span class="main">:</span> <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"pdec1 <span class="skolem">d</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc_d <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"list_decode <span class="free">e</span> <span class="main">=</span> tuple_decode <span class="main">(</span>pdec1 <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span>pdec2 <span class="skolem">d</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc_d <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> xxs<span class="main">:</span> <span class="quoted"><span class="quoted">"list_decode <span class="free">e</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"e_tl <span class="free">e</span> <span class="main">=</span> list_encode <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_decode <span class="main">(</span>Suc <span class="main">(</span>prod_encode <span class="main">(</span>pdec1 <span class="main">(</span><span class="free">e</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">,</span> pdec22 <span class="main">(</span><span class="free">e</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        tuple_decode <span class="main">(</span>pdec1 <span class="main">(</span><span class="free">e</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>pdec22 <span class="main">(</span><span class="free">e</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> tuple_decode <span class="skolem">a</span> <span class="main">(</span>pdec22 <span class="main">(</span><span class="free">e</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc Suc_d <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> tl <span class="main">(</span>tuple_decode <span class="main">(</span>Suc <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>pdec2 <span class="main">(</span><span class="free">e</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tuple_decode_pdec2 Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> tl <span class="main">(</span>tuple_decode <span class="main">(</span>pdec1 <span class="main">(</span><span class="free">e</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pdec2 <span class="main">(</span><span class="free">e</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc Suc_d <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> tl <span class="main">(</span>list_decode <span class="free">e</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> * Suc_d <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> xxs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_encode <span class="var">?lhs</span> <span class="main">=</span> list_encode <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>prod_encode <span class="main">(</span>pdec1 <span class="main">(</span><span class="free">e</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">,</span> pdec22 <span class="main">(</span><span class="free">e</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> list_encode <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> list_encode_decode <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ** Suc_d Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_tl</span> <span class="main">≡</span>
 <span class="keyword1">let</span> <span class="bound">r</span> <span class="main">=</span> Cn <span class="main">1</span> r_pdec1 <span class="main">[</span>r_dec<span class="main">]</span>
 <span class="keyword1">in</span> Cn <span class="main">1</span> r_ifz
     <span class="main">[</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">,</span>
      Z<span class="main">,</span>
      Cn <span class="main">1</span> r_ifz
       <span class="main">[</span><span class="bound">r</span><span class="main">,</span> Z<span class="main">,</span> Cn <span class="main">1</span> S <span class="main">[</span>Cn <span class="main">1</span> r_prod_encode <span class="main">[</span>Cn <span class="main">1</span> r_dec <span class="main">[</span><span class="bound">r</span><span class="main">]</span><span class="main">,</span> Cn <span class="main">1</span> r_pdec22 <span class="main">[</span>r_dec<span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_tl_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> r_tl"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_tl_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> r_tl <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_tl <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">↓=</span> e_tl <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_tl_def <span class="keyword1"><span class="command">using</span></span> e_tl_elementary <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define the head of the empty encoded list to be zero.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">e_hd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">e_hd</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> hd <span class="main">(</span>list_decode <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> e_hd <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_decode <span class="free">e</span> <span class="main">=</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"e_hd <span class="free">e</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> e_hd_def assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> e_hd_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"e_hd <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> e_hd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> e_hd_neq_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"e_hd <span class="free">e</span> <span class="main">=</span> hd <span class="main">(</span>list_decode <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> e_hd_def assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_hd</span> <span class="main">≡</span>
  Cn <span class="main">1</span> r_ifz <span class="main">[</span>Cn <span class="main">1</span> r_pdec1 <span class="main">[</span>r_dec<span class="main">]</span><span class="main">,</span> Cn <span class="main">1</span> r_pdec2 <span class="main">[</span>r_dec<span class="main">]</span><span class="main">,</span> Cn <span class="main">1</span> r_pdec12 <span class="main">[</span>r_dec<span class="main">]</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_hd_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> r_hd"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_hd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_hd <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_hd <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">↓=</span> e_hd <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_hd <span class="free">e</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> pdec1 <span class="main">(</span><span class="free">e</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> pdec2 <span class="main">(</span><span class="free">e</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">else</span> pdec12 <span class="main">(</span><span class="free">e</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> pdec1_zero pdec2_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"pdec1 <span class="skolem">d</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pdec1_zero<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> r_hd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">e_length</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">e_length</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> length <span class="main">(</span>list_decode <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> e_length_0<span class="main">:</span> <span class="quoted"><span class="quoted">"e_length <span class="free">e</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">e</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list_encode.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> length_0_conv list_encode_decode<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_length</span> <span class="main">≡</span> Cn <span class="main">1</span> r_ifz <span class="main">[</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">,</span> Z<span class="main">,</span> Cn <span class="main">1</span> S <span class="main">[</span>Cn <span class="main">1</span> r_pdec1 <span class="main">[</span>r_dec<span class="main">]</span><span class="main">]</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_length_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> r_length"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_length_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_length <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_length <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">↓=</span> e_length <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_length_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Accessing an encoded list out of bounds yields zero.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">e_nth</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">e_nth</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> e_tuple_nth <span class="main">(</span>pdec1 <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pdec2 <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> e_nth <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"e_nth <span class="free">e</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">n</span> <span class="main">&lt;</span> e_length <span class="free">e</span> <span class="keyword1">then</span> <span class="main">(</span>list_decode <span class="free">e</span><span class="main">)</span> <span class="main">!</span> <span class="free">n</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> e_nth_def e_tuple_nth_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> e_hd_nth0<span class="main">:</span> <span class="quoted"><span class="quoted">"e_hd <span class="free">e</span> <span class="main">=</span> e_nth <span class="free">e</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> e_hd_def e_length_0 hd_conv_nth<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_nth</span> <span class="main">≡</span>
  Cn <span class="numeral">2</span> r_ifz
   <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">0</span><span class="main">,</span>
    r_constn <span class="main">1</span> <span class="main">0</span><span class="main">,</span>
    Cn <span class="numeral">2</span> r_tuple_nth
     <span class="main">[</span>Cn <span class="numeral">2</span> r_pdec1 <span class="main">[</span>r_dummy <span class="main">1</span> r_dec<span class="main">]</span><span class="main">,</span> Cn <span class="numeral">2</span> r_pdec2 <span class="main">[</span>r_dummy <span class="main">1</span> r_dec<span class="main">]</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_nth_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="numeral">2</span> r_nth"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_nth_def <span class="keyword1"><span class="command">using</span></span> r_tuple_nth_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_nth <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_nth <span class="main">[</span><span class="free">e</span><span class="main">,</span> <span class="free">n</span><span class="main">]</span> <span class="main">↓=</span> e_nth <span class="free">e</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_nth_def e_nth_def <span class="keyword1"><span class="command">using</span></span> r_tuple_nth_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_rev_aux</span> <span class="main">≡</span>
  Pr <span class="main">1</span> r_hd <span class="main">(</span>Cn <span class="numeral">3</span> r_prod_encode <span class="main">[</span>Cn <span class="numeral">3</span> r_nth <span class="main">[</span>Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">,</span> Cn <span class="numeral">3</span> S <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">0</span><span class="main">]</span><span class="main">]</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_rev_aux_prim<span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="numeral">2</span> r_rev_aux"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_rev_aux_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_rev_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_decode <span class="free">e</span> <span class="main">=</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval r_rev_aux <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span> <span class="main">↓=</span> tuple_encode <span class="free">i</span> <span class="main">(</span>rev <span class="main">(</span>take <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> r_rev_aux_def <span class="keyword1"><span class="command">using</span></span> assms e_hd_def r_hd <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_Suc<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="numeral">3</span> r_prod_encode <span class="main">[</span>Cn <span class="numeral">3</span> r_nth <span class="main">[</span>Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">,</span> Cn <span class="numeral">3</span> S <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">0</span><span class="main">]</span><span class="main">]</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> Suc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_rev_aux <span class="main">[</span>Suc <span class="skolem">i</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span> <span class="main">=</span> eval <span class="var">?g</span> <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> the <span class="main">(</span>eval r_rev_aux <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> r_rev_aux_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">,</span> tuple_encode <span class="skolem">i</span> <span class="main">(</span>rev <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc.prems take_Suc_conv_app_nth<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> r_rev_aux_full<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"list_decode <span class="free">e</span> <span class="main">=</span> <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval r_rev_aux <span class="main">[</span>length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span> <span class="main">↓=</span> tuple_encode <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> r_rev_aux assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_rev_aux_total<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_rev_aux <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> r_rev_aux_prim totalE <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_rev</span> <span class="main">≡</span>
  Cn <span class="main">1</span> r_ifz
   <span class="main">[</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">,</span>
    Z<span class="main">,</span>
    Cn <span class="main">1</span> S
     <span class="main">[</span>Cn <span class="main">1</span> r_prod_encode
      <span class="main">[</span>Cn <span class="main">1</span> r_dec <span class="main">[</span>r_length<span class="main">]</span><span class="main">,</span> Cn <span class="main">1</span> r_rev_aux <span class="main">[</span>Cn <span class="main">1</span> r_dec <span class="main">[</span>r_length<span class="main">]</span><span class="main">,</span> Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_rev_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> r_rev"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_rev_def <span class="keyword1"><span class="command">using</span></span> r_rev_aux_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_rev <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_rev <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">↓=</span> list_encode <span class="main">(</span>rev <span class="main">(</span>list_decode <span class="free">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?d</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="main">1</span> r_dec <span class="main">[</span>r_length<span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="main">1</span> r_rev_aux <span class="main">[</span><span class="var">?d</span><span class="main">,</span> Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="main">1</span> r_prod_encode <span class="main">[</span><span class="var">?d</span><span class="main">,</span> <span class="var">?a</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="main">1</span> S <span class="main">[</span><span class="var">?p</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> eval_a<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="var">?a</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">=</span> eval r_rev_aux <span class="main">[</span>e_length <span class="free">e</span> <span class="main">-</span> <span class="main">1</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_rev_aux_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?s</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_rev_aux_prim <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_rev_aux_total<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_rev <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">e</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> the <span class="main">(</span>eval <span class="var">?s</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_rev_aux_prim <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_rev_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> list_decode <span class="free">e</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> e_length_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> e_length <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> eval_a <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?a</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">=</span> eval r_rev_aux <span class="main">[</span>length <span class="skolem">xs</span> <span class="main">-</span> <span class="main">1</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?a</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">↓=</span> tuple_encode <span class="main">(</span>length <span class="skolem">xs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>rev <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> xs r_rev_aux_full <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?s</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">↓=</span>
        Suc <span class="main">(</span>prod_encode <span class="main">(</span>length <span class="skolem">xs</span> <span class="main">-</span> <span class="main">1</span><span class="main">,</span> tuple_encode <span class="main">(</span>length <span class="skolem">xs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>rev <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> len r_rev_aux_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?s</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">↓=</span>
        Suc <span class="main">(</span>prod_encode
              <span class="main">(</span>length <span class="main">(</span>rev <span class="skolem">xs</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">,</span> tuple_encode <span class="main">(</span>length <span class="main">(</span>rev <span class="skolem">xs</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>rev <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>rev <span class="skolem">xs</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> xs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?s</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">↓=</span> list_encode <span class="main">(</span>rev <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list_encode.elims diff_Suc_1 length_Cons length_greater_0_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> xs * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">e_cons</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">e_cons</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="main">≡</span> list_encode <span class="main">(</span><span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">#</span> list_decode <span class="free"><span class="bound"><span class="entity">es</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> e_cons_elementary<span class="main">:</span>
  <span class="quoted"><span class="quoted">"e_cons <span class="free">e</span> <span class="free">es</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free">es</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> Suc <span class="main">(</span>prod_encode <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="free">e</span><span class="main">)</span><span class="main">)</span>
     <span class="keyword1">else</span> Suc <span class="main">(</span>prod_encode <span class="main">(</span>e_length <span class="free">es</span><span class="main">,</span> prod_encode <span class="main">(</span><span class="free">e</span><span class="main">,</span> pdec2 <span class="main">(</span><span class="free">es</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">es</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_length <span class="free">es</span> <span class="main">=</span> Suc <span class="main">(</span>pdec1 <span class="main">(</span><span class="free">es</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list_decode.elims diff_Suc_1 tuple_decode_length<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">es</span> <span class="main">=</span> e_tl <span class="main">(</span>list_encode <span class="main">(</span><span class="free">e</span> <span class="main">#</span> list_decode <span class="free">es</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list_decode_encode list_encode_decode<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> False e_tl_elementary 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list_decode.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> diff_Suc_1 list_encode_decode prod.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
      prod_encode_inverse snd_conv tuple_decode.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_cons_else</span> <span class="main">≡</span>
  Cn <span class="numeral">2</span> S
   <span class="main">[</span>Cn <span class="numeral">2</span> r_prod_encode
     <span class="main">[</span>Cn <span class="numeral">2</span> r_length
       <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">,</span> Cn <span class="numeral">2</span> r_prod_encode <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">0</span><span class="main">,</span> Cn <span class="numeral">2</span> r_pdec2 <span class="main">[</span>Cn <span class="numeral">2</span> r_dec <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_cons_else_prim<span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="numeral">2</span> r_cons_else"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_cons_else_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_cons_else<span class="main">:</span>
  <span class="quoted"><span class="quoted">"eval r_cons_else <span class="main">[</span><span class="free">e</span><span class="main">,</span> <span class="free">es</span><span class="main">]</span> <span class="main">↓=</span>
    Suc <span class="main">(</span>prod_encode <span class="main">(</span>e_length <span class="free">es</span><span class="main">,</span> prod_encode <span class="main">(</span><span class="free">e</span><span class="main">,</span> pdec2 <span class="main">(</span><span class="free">es</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_cons_else_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_cons</span> <span class="main">≡</span>
  Cn <span class="numeral">2</span> r_ifz
    <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">1</span><span class="main">,</span> Cn <span class="numeral">2</span> S <span class="main">[</span>Cn <span class="numeral">2</span> r_prod_encode <span class="main">[</span>r_constn <span class="main">1</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">0</span><span class="main">]</span><span class="main">]</span><span class="main">,</span> r_cons_else<span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_cons_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="numeral">2</span> r_cons"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_cons_def <span class="keyword1"><span class="command">using</span></span> r_cons_else_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_cons <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_cons <span class="main">[</span><span class="free">e</span><span class="main">,</span> <span class="free">es</span><span class="main">]</span> <span class="main">↓=</span> e_cons <span class="free">e</span> <span class="free">es</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_cons_def <span class="keyword1"><span class="command">using</span></span> r_cons_else_prim r_cons_else e_cons_elementary <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">e_snoc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">e_snoc</span> <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> list_encode <span class="main">(</span>list_decode <span class="free"><span class="bound"><span class="entity">es</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> e_nth_snoc_small <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> e_length <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"e_nth <span class="main">(</span>e_snoc <span class="free">b</span> <span class="free">z</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> e_nth <span class="free">b</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> e_hd_snoc <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"e_length <span class="free">b</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"e_hd <span class="main">(</span>e_snoc <span class="free">b</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> e_hd <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> less_imp_neq <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> hd<span class="main">:</span> <span class="quoted"><span class="quoted">"e_hd <span class="free">b</span> <span class="main">=</span> hd <span class="main">(</span>list_decode <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_length <span class="main">(</span>e_snoc <span class="free">b</span> <span class="free">x</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_snoc <span class="free">b</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> not_gr_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_hd <span class="main">(</span>e_snoc <span class="free">b</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> hd <span class="main">(</span>list_decode <span class="main">(</span>e_snoc <span class="free">b</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> assms hd <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_snoc</span> <span class="main">≡</span> Cn <span class="numeral">2</span> r_rev <span class="main">[</span>Cn <span class="numeral">2</span> r_cons <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">1</span><span class="main">,</span> Cn <span class="numeral">2</span> r_rev <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">0</span><span class="main">]</span><span class="main">]</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_snoc_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="numeral">2</span> r_snoc"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_snoc_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_snoc <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_snoc <span class="main">[</span><span class="free">es</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span> <span class="main">↓=</span> e_snoc <span class="free">es</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_snoc_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">e_butlast</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">e_butlast</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> list_encode <span class="main">(</span>butlast <span class="main">(</span>list_decode <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">e_take</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">e_take</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> list_encode <span class="main">(</span>take <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>list_decode <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_take</span> <span class="main">≡</span>
  Cn <span class="numeral">2</span> r_ifle
   <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">0</span><span class="main">,</span> Cn <span class="numeral">2</span> r_length <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">,</span>
    Pr <span class="main">1</span> Z <span class="main">(</span>Cn <span class="numeral">3</span> r_snoc <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">1</span><span class="main">,</span> Cn <span class="numeral">3</span> r_nth <span class="main">[</span>Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">0</span><span class="main">]</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
    Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_take_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="numeral">2</span> r_take"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_take_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> r_take<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> list_encode <span class="free">es</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval r_take <span class="main">[</span><span class="free">n</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> list_encode <span class="main">(</span>take <span class="free">n</span> <span class="free">es</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="numeral">3</span> r_snoc <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">1</span><span class="main">,</span> Cn <span class="numeral">3</span> r_nth <span class="main">[</span>Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">0</span><span class="main">]</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Pr <span class="main">1</span> Z <span class="var">?g</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"total <span class="var">?h</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Mn_free_imp_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≤</span> length <span class="free">es</span> <span class="main">⟹</span> eval <span class="var">?h</span> <span class="main">[</span><span class="skolem">m</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> list_encode <span class="main">(</span>take <span class="skolem">m</span> <span class="free">es</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">m</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">m</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms r_take_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_take_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> length <span class="free">es</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?h</span> <span class="main">[</span>Suc <span class="skolem">m</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span> eval <span class="var">?g</span> <span class="main">[</span><span class="skolem">m</span><span class="main">,</span> the <span class="main">(</span>eval <span class="var">?h</span> <span class="main">[</span><span class="skolem">m</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc r_take_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> eval <span class="var">?g</span> <span class="main">[</span><span class="skolem">m</span><span class="main">,</span> list_encode <span class="main">(</span>take <span class="skolem">m</span> <span class="free">es</span><span class="main">)</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">↓=</span> e_snoc <span class="main">(</span>list_encode <span class="main">(</span>take <span class="skolem">m</span> <span class="free">es</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">es</span> <span class="main">!</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">&lt;</span> length <span class="free">es</span>›</span></span> assms<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">↓=</span> list_encode <span class="main">(</span><span class="main">(</span>take <span class="skolem">m</span> <span class="free">es</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">es</span> <span class="main">!</span> <span class="skolem">m</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> list_decode_encode <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">↓=</span> list_encode <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="free">es</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">&lt;</span> length <span class="free">es</span>›</span></span> take_Suc_conv_app_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Id <span class="numeral">2</span> <span class="main">1</span><span class="main">)</span> <span class="main">[</span><span class="skolem">m</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> list_encode <span class="main">(</span>take <span class="skolem">m</span> <span class="free">es</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&gt;</span> length <span class="free">es</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">m</span>
    <span class="keyword1"><span class="command">using</span></span> that assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_take <span class="main">[</span><span class="skolem">m</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">m</span> <span class="main">≤</span> e_length <span class="free">x</span> <span class="keyword1">then</span> the <span class="main">(</span>eval <span class="var">?h</span> <span class="main">[</span><span class="skolem">m</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="keyword1">else</span> the <span class="main">(</span>eval <span class="main">(</span>Id <span class="numeral">2</span> <span class="main">1</span><span class="main">)</span> <span class="main">[</span><span class="skolem">m</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">m</span>
    <span class="keyword1"><span class="command">unfolding</span></span> r_take_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹total <span class="var">?h</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> r_take_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> r_take' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_take <span class="main">[</span><span class="free">n</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> e_take <span class="free">n</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_take<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_last</span> <span class="main">≡</span> Cn <span class="main">1</span> r_hd <span class="main">[</span>r_rev<span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_last_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> r_last"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_last_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_last <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">=</span> list_encode <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval r_last <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">↓=</span> last <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_encode <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> gr0I list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list_encode_0<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_last <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">=</span> eval r_hd <span class="main">[</span>the <span class="main">(</span>eval r_rev <span class="main">[</span><span class="free">e</span><span class="main">]</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> r_last_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms hd_rev <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_update_aux</span> <span class="main">≡</span>
  <span class="keyword1">let</span>
    <span class="bound">f</span> <span class="main">=</span> r_constn <span class="numeral">2</span> <span class="main">0</span><span class="main">;</span>
    <span class="bound">g</span> <span class="main">=</span> Cn <span class="numeral">5</span> r_snoc
         <span class="main">[</span>Id <span class="numeral">5</span> <span class="main">1</span><span class="main">,</span> Cn <span class="numeral">5</span> r_ifeq <span class="main">[</span>Id <span class="numeral">5</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">5</span> <span class="numeral">3</span><span class="main">,</span> Id <span class="numeral">5</span> <span class="numeral">4</span><span class="main">,</span> Cn <span class="numeral">5</span> r_nth <span class="main">[</span>Id <span class="numeral">5</span> <span class="numeral">2</span><span class="main">,</span> Id <span class="numeral">5</span> <span class="main">0</span><span class="main">]</span><span class="main">]</span><span class="main">]</span>
  <span class="keyword1">in</span> Pr <span class="numeral">3</span> <span class="bound">f</span> <span class="bound">g</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_update_aux_recfn<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">4</span> r_update_aux"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_update_aux_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_update_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> e_length <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval r_update_aux <span class="main">[</span><span class="free">n</span><span class="main">,</span> <span class="free">b</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">v</span><span class="main">]</span> <span class="main">↓=</span> list_encode <span class="main">(</span><span class="main">(</span>take <span class="free">n</span> <span class="main">(</span>list_decode <span class="free">b</span><span class="main">)</span><span class="main">)</span><span class="main">[</span><span class="free">j</span><span class="main">:=</span><span class="free">v</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> r_update_aux_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> e_length <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="numeral">5</span> r_nth <span class="main">[</span>Id <span class="numeral">5</span> <span class="numeral">2</span><span class="main">,</span> Id <span class="numeral">5</span> <span class="main">0</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="numeral">5</span> r_ifeq <span class="main">[</span>Id <span class="numeral">5</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">5</span> <span class="numeral">3</span><span class="main">,</span> Id <span class="numeral">5</span> <span class="numeral">4</span><span class="main">,</span> <span class="var">?a</span><span class="main">]</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">≡</span> Cn <span class="numeral">5</span> r_snoc <span class="main">[</span>Id <span class="numeral">5</span> <span class="main">1</span><span class="main">,</span> <span class="var">?b</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="skolem">g</span> <span class="main">[</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">r</span><span class="main">,</span> <span class="free">b</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">v</span><span class="main">]</span> <span class="main">↓=</span> e_snoc <span class="skolem">r</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">n</span> <span class="main">=</span> <span class="free">j</span> <span class="keyword1">then</span> <span class="free">v</span> <span class="keyword1">else</span> e_nth <span class="free">b</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">r</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Pr <span class="numeral">3</span> <span class="main">(</span>r_constn <span class="numeral">2</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">g</span> <span class="main">=</span> r_update_aux"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_update_aux_def g_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_update_aux <span class="main">[</span>Suc <span class="skolem">n</span><span class="main">,</span> <span class="free">b</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">v</span><span class="main">]</span> <span class="main">=</span>
      eval <span class="skolem">g</span> <span class="main">[</span><span class="skolem">n</span><span class="main">,</span> the <span class="main">(</span>eval r_update_aux <span class="main">[</span><span class="skolem">n</span><span class="main">,</span> <span class="free">b</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">v</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="free">b</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">v</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_update_aux_recfn Suc n eval_Pr_converg_Suc
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> arity.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> length_Cons list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> nat_less_le
      numeral_3_eq_3 option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_update_aux <span class="main">[</span>Suc <span class="skolem">n</span><span class="main">,</span> <span class="free">b</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">v</span><span class="main">]</span> <span class="main">↓=</span> e_snoc
      <span class="main">(</span>list_encode <span class="main">(</span><span class="main">(</span>take <span class="skolem">n</span> <span class="main">(</span>list_decode <span class="free">b</span><span class="main">)</span><span class="main">)</span><span class="main">[</span><span class="free">j</span><span class="main">:=</span><span class="free">v</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">n</span> <span class="main">=</span> <span class="free">j</span> <span class="keyword1">then</span> <span class="free">v</span> <span class="keyword1">else</span> e_nth <span class="free">b</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> g Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>j_eq_n<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="main">|</span> <span class="main">(</span>j_less_n<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span> <span class="main">|</span> <span class="main">(</span>j_gt_n<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&gt;</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> j_eq_n
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>list_decode <span class="free">b</span><span class="main">)</span><span class="main">)</span><span class="main">[</span><span class="free">j</span><span class="main">:=</span><span class="free">v</span><span class="main">]</span> <span class="main">=</span>
        <span class="main">(</span>take <span class="skolem">n</span> <span class="main">(</span>list_decode <span class="free">b</span><span class="main">)</span><span class="main">)</span><span class="main">[</span><span class="free">j</span><span class="main">:=</span><span class="free">v</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">v</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_list_update nth_list_update_eq take_Suc_conv_app_nth take_update_swap<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> j_less_n
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>list_decode <span class="free">b</span><span class="main">)</span><span class="main">)</span><span class="main">[</span><span class="free">j</span><span class="main">:=</span><span class="free">v</span><span class="main">]</span> <span class="main">=</span>
        <span class="main">(</span>take <span class="skolem">n</span> <span class="main">(</span>list_decode <span class="free">b</span><span class="main">)</span><span class="main">)</span><span class="main">[</span><span class="free">j</span><span class="main">:=</span><span class="free">v</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span>list_decode <span class="free">b</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_eq_less_or_eq list_update_append min_absorb2 take_Suc_conv_app_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> j_gt_n
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>list_decode <span class="free">b</span><span class="main">)</span><span class="main">)</span><span class="main">[</span><span class="free">j</span><span class="main">:=</span><span class="free">v</span><span class="main">]</span> <span class="main">=</span>
        <span class="main">(</span>take <span class="skolem">n</span> <span class="main">(</span>list_decode <span class="free">b</span><span class="main">)</span><span class="main">)</span><span class="main">[</span><span class="free">j</span><span class="main">:=</span><span class="free">v</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span>list_decode <span class="free">b</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">n</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n take_Suc_conv_app_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">e_update</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">e_update</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> list_encode <span class="main">(</span><span class="main">(</span>list_decode <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">:=</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_update</span> <span class="main">≡</span>
  Cn <span class="numeral">3</span> r_update_aux <span class="main">[</span>Cn <span class="numeral">3</span> r_length <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">1</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_update_recfn <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">3</span> r_update"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_update_def <span class="keyword1"><span class="command">using</span></span> r_update_aux_recfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_update <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_update <span class="main">[</span><span class="free">b</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">v</span><span class="main">]</span> <span class="main">↓=</span> e_update <span class="free">b</span> <span class="free">j</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_update_def <span class="keyword1"><span class="command">using</span></span> r_update_aux r_update_aux_recfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> e_length_update <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"e_length <span class="main">(</span>e_update <span class="free">b</span> <span class="free">k</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> e_length <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">e_append</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">e_append</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">≡</span> list_encode <span class="main">(</span>list_decode <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> list_decode <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> e_length_append<span class="main">:</span> <span class="quoted"><span class="quoted">"e_length <span class="main">(</span>e_append <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> e_length <span class="free">xs</span> <span class="main">+</span> e_length <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> e_append_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> e_nth_append_small<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> e_length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"e_nth <span class="main">(</span>e_append <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> e_nth <span class="free">xs</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> e_append_def assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> e_nth_append_big<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> e_length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"e_nth <span class="main">(</span>e_append <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> e_nth <span class="free">ys</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> e_length <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> e_append_def assms e_nth <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_diff_conv2 nth_append<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_append</span> <span class="main">≡</span>
  <span class="keyword1">let</span>
    <span class="bound">f</span> <span class="main">=</span> Id <span class="numeral">2</span> <span class="main">0</span><span class="main">;</span>
    <span class="bound">g</span> <span class="main">=</span> Cn <span class="numeral">4</span> r_snoc <span class="main">[</span>Id <span class="numeral">4</span> <span class="main">1</span><span class="main">,</span> Cn <span class="numeral">4</span> r_nth <span class="main">[</span>Id <span class="numeral">4</span> <span class="numeral">3</span><span class="main">,</span> Id <span class="numeral">4</span> <span class="main">0</span><span class="main">]</span><span class="main">]</span>
  <span class="keyword1">in</span> Cn <span class="numeral">2</span> <span class="main">(</span>Pr <span class="numeral">2</span> <span class="bound">f</span> <span class="bound">g</span><span class="main">)</span> <span class="main">[</span>Cn <span class="numeral">2</span> r_length <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_append_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="numeral">2</span> r_append"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_append_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_append <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_append <span class="main">[</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">]</span> <span class="main">↓=</span> e_append <span class="free">a</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> Cn <span class="numeral">4</span> r_snoc <span class="main">[</span>Id <span class="numeral">4</span> <span class="main">1</span><span class="main">,</span> Cn <span class="numeral">4</span> r_nth <span class="main">[</span>Id <span class="numeral">4</span> <span class="numeral">3</span><span class="main">,</span> Id <span class="numeral">4</span> <span class="main">0</span><span class="main">]</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="skolem">g</span> <span class="main">[</span><span class="skolem">j</span><span class="main">,</span> <span class="skolem">r</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">]</span> <span class="main">↓=</span> e_snoc <span class="skolem">r</span> <span class="main">(</span>e_nth <span class="free">b</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span> <span class="skolem">r</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Pr <span class="numeral">2</span> <span class="main">(</span>Id <span class="numeral">2</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">g</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?h</span> <span class="main">[</span><span class="skolem">n</span><span class="main">,</span> <span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">]</span> <span class="main">↓=</span> list_encode <span class="main">(</span>list_decode <span class="free">a</span> <span class="main">@</span> <span class="main">(</span>take <span class="skolem">n</span> <span class="main">(</span>list_decode <span class="free">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> e_length <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">using</span></span> that g g_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> take_Suc_conv_app_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> r_append_def g_def e_append_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">e_append_zeros</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">e_append_zeros</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">≡</span> e_append <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>list_encode <span class="main">(</span>replicate <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> e_append_zeros_length<span class="main">:</span> <span class="quoted"><span class="quoted">"e_length <span class="main">(</span>e_append_zeros <span class="free">b</span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> e_length <span class="free">b</span> <span class="main">+</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> e_append_def e_append_zeros_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> e_nth_append_zeros<span class="main">:</span> <span class="quoted"><span class="quoted">"e_nth <span class="main">(</span>e_append_zeros <span class="free">b</span> <span class="free">z</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> e_nth <span class="free">b</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> e_append_zeros_def e_nth_append_small e_nth_append_big <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> e_nth_append_zeros_big<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≥</span> e_length <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"e_nth <span class="main">(</span>e_append_zeros <span class="free">b</span> <span class="free">z</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> e_append_zeros_def
  <span class="keyword1"><span class="command">using</span></span> e_nth_append_big<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="quoted">"list_encode <span class="main">(</span>replicate <span class="free">z</span> <span class="main">0</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_append_zeros</span> <span class="main">≡</span>
  r_swap <span class="main">(</span>Pr <span class="main">1</span> <span class="main">(</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Cn <span class="numeral">3</span> r_snoc <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">1</span><span class="main">,</span> r_constn <span class="numeral">2</span> <span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_append_zeros_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="numeral">2</span> r_append_zeros"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_append_zeros_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_append_zeros<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_append_zeros <span class="main">[</span><span class="free">b</span><span class="main">,</span> <span class="free">z</span><span class="main">]</span> <span class="main">↓=</span> e_append_zeros <span class="free">b</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Pr <span class="main">1</span> <span class="main">(</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>Cn <span class="numeral">3</span> r_snoc <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">1</span><span class="main">,</span> r_constn <span class="numeral">2</span> <span class="main">0</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?r</span> <span class="main">[</span><span class="free">z</span><span class="main">,</span> <span class="free">b</span><span class="main">]</span> <span class="main">↓=</span> e_append_zeros <span class="free">b</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> e_append_zeros_def e_append_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">z</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> replicate_append_same<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_append_zeros_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Universal">
<div class="head">
<h1>Theory Universal</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹A universal partial recursive function›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Universal
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Partial_Recursive.html">Partial_Recursive</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The main product of this section is a universal partial recursive
function, which given a code $i$ of an $n$-ary partial recursive function $f$
and an encoded list <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">xs</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of $n$ arguments, computes <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"eval <span class="free"><span class="free">f</span></span>
<span class="free"><span class="free">xs</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. From this we can derive fixed-arity universal functions satisfying the
usual results such as the $s$-$m$-$n$ theorem. To represent the code $i$, we
need a way to encode <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">recf</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>s as natural numbers (Section~\ref{s:recf_enc}). To
construct the universal function, we devise a ternary function taking $i$,
$xs$, and a step bound $t$ and simulating the execution of $f$ on input $xs$ for
$t$ steps. This function is useful in its own right, enabling techniques like
dovetailing or ``concurrent'' evaluation of partial recursive functions.

The notion of a ``step'' is not part of the definition of (the evaluation of)
partial recursive functions, but one can simulate the evaluation on an
abstract machine (Section~\ref{s:step}). This machine's configurations can be
encoded as natural numbers, and this leads us to a step function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"nat
<span class="main"><span class="main">⇒</span></span> nat"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> on encoded configurations (Section~\ref{s:step_enc}).
This function in turn can be computed by a primitive recursive function, from
which we develop the aforementioned ternary function of $i$, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">xs</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and
$t$ (Section~\ref{s:step_recf}). From this we can finally derive
a universal function (Section~\ref{s:the_universal}).›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹A step function\label{s:step}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We simulate the stepwise execution of a partial recursive
function in a fairly straightforward way reminiscent of the execution of
function calls in an imperative programming language. A configuration of the
abstract machine is a pair consisting of:
\begin{enumerate}
\item A stack of frames. A frame represents the execution of a function and is
  a triple <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">f</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">xs</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">locals</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of
  \begin{enumerate}
    \item a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">recf</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> being executed,
    \item a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"nat list"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of arguments of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
    \item a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"nat list"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of local variables, which holds intermediate
      values when <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">f</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is of the form <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Cn</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Pr</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, or <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Mn</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
  \end{enumerate}
\item A register of type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"nat option"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> representing the return value of
  the last function call: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">None</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> signals that in the previous step the
  stack was not popped and hence no value was returned, whereas <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Some
  <span class="free"><span class="free">v</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> means that in the previous step a function returned <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">v</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
\end{enumerate}
For computing <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">h</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> on input <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">xs</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the initial configuration is
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="main"><span class="main">[</span></span><span class="main"><span class="main">(</span></span><span class="free"><span class="free">h</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">xs</span></span><span class="main"><span class="main">,</span></span> <span class="main"><span class="main">[]</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> None<span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. When the computation for a frame ends, it is
popped off the stack, and its return value is put in the register. The entire
computation ends when the stack is empty. In such a final configuration the
register contains the value of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">h</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> at <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">xs</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. If no final
configuration is ever reached, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">h</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> diverges at <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">xs</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

The execution of one step depends on the topmost (that is, active) frame. In
the step when a frame <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">h</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">xs</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">locals</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is pushed onto the stack, the
local variables are <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">locals</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">[]</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. The following happens until the
frame is popped off the stack again (if it ever is):
\begin{itemize}
\item For the base functions <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">h</span></span> <span class="main"><span class="main">=</span></span> Z"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">h</span></span> <span class="main"><span class="main">=</span></span> S"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>[names_short] <span class="quoted"><span class="quoted">"<span class="free"><span class="free">h</span></span> <span class="main"><span class="main">=</span></span> Id <span class="free"><span class="free">m</span></span> <span class="free"><span class="free">n</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the frame is popped off the stack right away,
  and the return value is placed in the register.
\item For <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">h</span></span> <span class="main"><span class="main">=</span></span> Cn <span class="free"><span class="free">n</span></span> <span class="free"><span class="free">f</span></span> <span class="free"><span class="free">gs</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, for each function $g$ in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">gs</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:
  \begin{enumerate}
  \item A new frame of the form <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">g</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">xs</span></span><span class="main"><span class="main">,</span></span> <span class="main"><span class="main">[]</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is pushed onto the stack.
  \item When (and if) this frame
    is eventually popped, the value in the register is <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"eval <span class="free"><span class="free">g</span></span> <span class="free"><span class="free">xs</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. This value
    is appended to the list <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">locals</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of local variables.
  \end{enumerate}
  When all $g$ in $gs$ have been evaluated in this manner, $f$ is evaluated on the local variables
  by pushing <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">f</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">locals</span></span><span class="main"><span class="main">,</span></span> <span class="main"><span class="main">[]</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. The resulting register value is kept
  and the active frame for $h$ is popped off the stack.
\item For <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"h = Pr n f g"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, let <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">xs</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">y</span></span> <span class="main"><span class="main">#</span></span> <span class="free"><span class="free">ys</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. First <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">f</span></span><span class="main"><span class="main">,</span></span>
  <span class="free"><span class="free">ys</span></span><span class="main"><span class="main">,</span></span> <span class="main"><span class="main">[]</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is pushed and the return value stored in the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
  <span class="quoted"><span class="free"><span class="quoted"><span class="free">locals</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Then <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">g</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">x</span></span> <span class="main"><span class="main">#</span></span> <span class="free"><span class="free">v</span></span> <span class="main"><span class="main">#</span></span> <span class="free"><span class="free">ys</span></span><span class="main"><span class="main">,</span></span> <span class="main"><span class="main">[]</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is pushed,
  where $x$ is the length of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">locals</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and $v$ the most recently
  appended value. The return value is appended to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">locals</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. This is
  repeated until the length of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">locals</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> reaches <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">y</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Then the most
  recently appended local is placed in the register, and the stack is popped.
\item For <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"h = Mn n f"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, frames <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">f</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">x</span></span> <span class="main"><span class="main">#</span></span> <span class="free"><span class="free">xs</span></span><span class="main"><span class="main">,</span></span> <span class="main"><span class="main">[]</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are pushed
  for $x = 0, 1, 2, \ldots$ until one of them returns $0$. Then this
  $x$ is placed in the register and the stack is popped. Until then $x$ is
  stored in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">locals</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. If none of these evaluations return $0$, the
  stack never shrinks, and thus the machine never reaches a final state.
\end{itemize}›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> frame <span class="main">=</span> <span class="quoted"><span class="quoted">"recf <span class="main">×</span> nat list <span class="main">×</span> nat list"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> configuration <span class="main">=</span> <span class="quoted"><span class="quoted">"frame list <span class="main">×</span> nat option"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Definition of the step function›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"configuration <span class="main">⇒</span> configuration"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>Z<span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">,</span> Some <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>S<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">,</span> Some <span class="main">(</span>Suc <span class="main">(</span>hd <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>Id <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">,</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>Cn <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">gs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> length <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">gs</span></span></span>
     <span class="keyword1">then</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span> <span class="main">=</span> None
          <span class="keyword1">then</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>Cn <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">gs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">,</span> None<span class="main">)</span>
          <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span><span class="main">)</span>
     <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span> <span class="main">=</span> None
          <span class="keyword1">then</span> <span class="keyword1">if</span> length <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">gs</span></span></span>
               <span class="keyword1">then</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">gs</span></span></span> <span class="main">!</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>Cn <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">gs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">,</span> None<span class="main">)</span>
               <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span><span class="main">)</span>   <span class="comment1">―‹cannot occur, so don't-care term›</span>
          <span class="keyword1">else</span> <span class="main">(</span><span class="main">(</span>Cn <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">gs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="main">@</span> <span class="main">[</span>the <span class="free"><span class="bound"><span class="entity">rv</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">,</span> None<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>Pr <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="main">=</span> <span class="main">[]</span>
     <span class="keyword1">then</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span> <span class="main">=</span> None
          <span class="keyword1">then</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span> tl <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>Pr <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">,</span> None<span class="main">)</span>
          <span class="keyword1">else</span> <span class="main">(</span><span class="main">(</span>Pr <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="main">[</span>the <span class="free"><span class="bound"><span class="entity">rv</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">,</span> None<span class="main">)</span>
     <span class="keyword1">else</span> <span class="keyword1">if</span> length <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="main">=</span> Suc <span class="main">(</span>hd <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>
          <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">,</span> Some <span class="main">(</span>hd <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span><span class="main">)</span>
          <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span> <span class="main">=</span> None
               <span class="keyword1">then</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">,</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">#</span> hd <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="main">#</span> tl <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>Pr <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">,</span> None<span class="main">)</span>
               <span class="keyword1">else</span> <span class="main">(</span><span class="main">(</span>Pr <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="main">(</span>the <span class="free"><span class="bound"><span class="entity">rv</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">,</span> None<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>Mn <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span> <span class="main">=</span> <span class="main">[]</span>
     <span class="keyword1">then</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span> <span class="main">0</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>Mn <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">,</span> None<span class="main">)</span>
     <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">rv</span></span></span> <span class="main">=</span> Some <span class="main">0</span>
          <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">,</span> Some <span class="main">(</span>hd <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span><span class="main">)</span>
          <span class="keyword1">else</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span> <span class="main">(</span>Suc <span class="main">(</span>hd <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>Mn <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="main">[</span>Suc <span class="main">(</span>hd <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">fs</span></span></span><span class="main">,</span> None<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">reachable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"configuration <span class="main">⇒</span> configuration <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">reachable</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">t</span><span class="main">.</span> iterate <span class="bound">t</span> step <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> step_reachable <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"step <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"reachable <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> reachable_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> iterate.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> comp_id<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> reachable_transitive <span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"reachable <span class="free">x</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"reachable <span class="free">y</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"reachable <span class="free">x</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms iterate_additive<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?f</span><span class="main"><span class="main">=</span></span><span class="quoted">step</span><span class="main">]</span> reachable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> reachable_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="free">x</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> reachable_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> iterate.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> eq_id_iff<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹From a final configuration, that is, when the stack is empty,
only final configurations are reachable.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> step_empty_stack<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">x</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>step <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.collapse step.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> reachable_empty_stack<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">x</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"reachable <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">y</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>iterate <span class="skolem">t</span> step <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
    <span class="keyword1"><span class="command">using</span></span> assms step_empty_stack <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> reachable_def assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">nonterminating</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"configuration <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nonterminating</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">t</span><span class="main">.</span> fst <span class="main">(</span>iterate <span class="bound">t</span> step <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> reachable_nonterminating<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"reachable <span class="free">x</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"nonterminating <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nonterminating <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"iterate <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> step <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reachable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>iterate <span class="skolem">t</span> step <span class="free">x</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> t1 assms<span class="main">(</span>2<span class="main">)</span> reachable_def reachable_empty_stack iterate_additive'
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_Suc_ex<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"iterate <span class="skolem">t</span> step <span class="free">x</span> <span class="main">=</span> iterate <span class="main">(</span><span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">-</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> step <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"iterate <span class="skolem">t</span> step <span class="free">x</span> <span class="main">=</span> iterate <span class="main">(</span><span class="skolem">t</span> <span class="main">-</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> step <span class="main">(</span>iterate <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span> step <span class="free">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iterate_additive'<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"iterate <span class="skolem">t</span> step <span class="free">x</span> <span class="main">=</span> iterate <span class="main">(</span><span class="skolem">t</span> <span class="main">-</span> <span class="skolem">t<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> step <span class="free">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>iterate <span class="skolem">t</span> step <span class="free">x</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">step</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is underdefined, for example, when the
top frame contains a non-well-formed <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">recf</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> or too few arguments. All is
well, though, if every frame contains a well-formed <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">recf</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> whose arity
matches the number of arguments. Such stacks will be called
\emph{valid}.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">valid</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"frame list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">valid</span> <span class="free"><span class="bound"><span class="entity">stack</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">s</span><span class="main">∈</span>set <span class="free"><span class="bound"><span class="entity">stack</span></span></span><span class="main">.</span> recfn <span class="main">(</span>length <span class="main">(</span>fst <span class="main">(</span>snd <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_frame<span class="main">:</span> <span class="quoted"><span class="quoted">"valid <span class="main">(</span><span class="free">s</span> <span class="main">#</span> <span class="free">ss</span><span class="main">)</span> <span class="main">⟹</span> valid <span class="free">ss</span> <span class="main">∧</span> recfn <span class="main">(</span>length <span class="main">(</span>fst <span class="main">(</span>snd <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> valid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> valid_ConsE<span class="main">:</span> <span class="quoted"><span class="quoted">"valid <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="free">locs</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">)</span> <span class="main">⟹</span> valid <span class="free">rest</span> <span class="main">∧</span> recfn <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> valid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> valid_ConsI<span class="main">:</span> <span class="quoted"><span class="quoted">"valid <span class="free">rest</span> <span class="main">⟹</span> recfn <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">f</span> <span class="main">⟹</span> valid <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="free">locs</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> valid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Stacks in initial configurations are valid, and performing a step
maintains the validity of the stack.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> step_valid<span class="main">:</span> <span class="quoted"><span class="quoted">"valid <span class="free">stack</span> <span class="main">⟹</span> valid <span class="main">(</span>fst <span class="main">(</span>step <span class="main">(</span><span class="free">stack</span><span class="main">,</span> <span class="free">rv</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">stack</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> valid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">s</span> <span class="skolem">ss</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"valid <span class="free">stack</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"valid <span class="skolem">ss</span> <span class="main">∧</span> recfn <span class="main">(</span>length <span class="main">(</span>fst <span class="main">(</span>snd <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_frame Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">s</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Z
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons valid * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fstI prod.collapse step.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> S
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons valid * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv prod.collapse step.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Id
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons valid * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fstI prod.collapse step.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cn <span class="skolem">n</span> <span class="skolem">f</span> <span class="skolem">gs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">ls</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span>Cn <span class="skolem">n</span> <span class="skolem">f</span> <span class="skolem">gs</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">,</span> <span class="skolem">ls</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.collapse<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">consider</span></span>
        <span class="quoted"><span class="quoted">"length <span class="skolem">ls</span> <span class="main">=</span> length <span class="skolem">gs</span> <span class="main">∧</span> <span class="free">rv</span> <span class="main">↑</span>"</span></span>
      <span class="main">|</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ls</span> <span class="main">=</span> length <span class="skolem">gs</span> <span class="main">∧</span> <span class="free">rv</span> <span class="main">↓</span>"</span></span>
      <span class="main">|</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ls</span> <span class="main">&lt;</span> length <span class="skolem">gs</span> <span class="main">∧</span> <span class="free">rv</span> <span class="main">↑</span>"</span></span>
      <span class="main">|</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ls</span> <span class="main">≠</span> length <span class="skolem">gs</span> <span class="main">∧</span> <span class="free">rv</span> <span class="main">↓</span>"</span></span>
      <span class="main">|</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ls</span> <span class="main">&gt;</span> length <span class="skolem">gs</span> <span class="main">∧</span> <span class="free">rv</span> <span class="main">↑</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> valid Cons valid_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pr <span class="skolem">n</span> <span class="skolem">f</span> <span class="skolem">g</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">ls</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span>Pr <span class="skolem">n</span> <span class="skolem">f</span> <span class="skolem">g</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">,</span> <span class="skolem">ls</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.collapse<span class="main">)</span>
    <span class="keyword1"><span class="command">consider</span></span>
        <span class="quoted"><span class="quoted">"length <span class="skolem">ls</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">rv</span> <span class="main">↑</span>"</span></span>
      <span class="main">|</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ls</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">rv</span> <span class="main">↓</span>"</span></span>
      <span class="main">|</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ls</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> length <span class="skolem">ls</span> <span class="main">=</span> Suc <span class="main">(</span>hd <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="main">|</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ls</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> length <span class="skolem">ls</span> <span class="main">≠</span> Suc <span class="main">(</span>hd <span class="skolem">xs</span><span class="main">)</span> <span class="main">∧</span> <span class="free">rv</span> <span class="main">↑</span>"</span></span>
      <span class="main">|</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ls</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> length <span class="skolem">ls</span> <span class="main">≠</span> Suc <span class="main">(</span>hd <span class="skolem">xs</span><span class="main">)</span> <span class="main">∧</span> <span class="free">rv</span> <span class="main">↓</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons * valid_def s <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Mn <span class="skolem">n</span> <span class="skolem">f</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">ls</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span>Mn <span class="skolem">n</span> <span class="skolem">f</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">,</span> <span class="skolem">ls</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.collapse<span class="main">)</span>
    <span class="keyword1"><span class="command">consider</span></span>
        <span class="quoted"><span class="quoted">"length <span class="skolem">ls</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="main">|</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ls</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">rv</span> <span class="main">↑</span>"</span></span>
      <span class="main">|</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ls</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">rv</span> <span class="main">↓</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons * valid_def s <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> iterate_step_valid<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid <span class="free">stack</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valid <span class="main">(</span>fst <span class="main">(</span>iterate <span class="free">t</span> step <span class="main">(</span><span class="free">stack</span><span class="main">,</span> <span class="free">rv</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"iterate <span class="main">(</span>Suc <span class="skolem">t</span><span class="main">)</span> step <span class="main">(</span><span class="free">stack</span><span class="main">,</span> <span class="free">rv</span><span class="main">)</span> <span class="main">=</span> step <span class="main">(</span>iterate <span class="skolem">t</span> step <span class="main">(</span><span class="free">stack</span><span class="main">,</span> <span class="free">rv</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> step_valid valid_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.collapse<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Correctness of the step function›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">step</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> works correctly for a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">recf</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> $f$
on arguments <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">xs</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in some configuration if (1) in case $f$ converges, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">step</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> reaches a configuration with the topmost frame popped and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"eval
<span class="free"><span class="free">f</span></span> <span class="free"><span class="free">xs</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in the register, and (2) in case $f$ diverges, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">step</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> does not
reach a final configuration.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">correct</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"configuration <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">correct</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">correct</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">rest</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> eval <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">↓</span> <span class="keyword1">then</span> reachable <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">rest</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rest</span></span></span><span class="main">,</span> eval <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>
     <span class="keyword1">else</span> nonterminating <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ls</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">rest</span></span></span><span class="main">,</span> None<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> correct_convergI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eval <span class="free">f</span> <span class="free">xs</span> <span class="main">↓</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="free">ls</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">,</span> None<span class="main">)</span> <span class="main">(</span><span class="free">rest</span><span class="main">,</span> eval <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"correct <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="free">ls</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> correct_convergE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"correct <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="free">ls</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eval <span class="free">f</span> <span class="free">xs</span> <span class="main">↓</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="free">ls</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">,</span> None<span class="main">)</span> <span class="main">(</span><span class="free">rest</span><span class="main">,</span> eval <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The correctness proof for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">step</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is by structural induction
on the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">recf</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in the top frame. The base cases <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Z</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">S</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>[names_short] <span class="quoted"><span class="quoted">Id</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are simple. For <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"X = Cn, Pr, Mn"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the
lemmas named <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">reachable_X</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> show which configurations are reachable for
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">recf</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>s of shape <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">X</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Building on those, the lemmas named <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span>
<span class="raw_text"><span class="raw_text">step_X_correct</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> show <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">step</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>'s correctness for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">X</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> reachable_Cn<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid <span class="main">(</span><span class="main">(</span><span class="main">(</span>Cn <span class="free">n</span> <span class="free">f</span> <span class="free">gs</span><span class="main">)</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"valid <span class="var">?stack</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">rest</span><span class="main">.</span> valid <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="bound">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="bound">rest</span><span class="main">)</span> <span class="main">⟹</span> correct <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="bound">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="bound">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">g</span> <span class="bound">xs</span> <span class="bound">rest</span><span class="main">.</span>
      <span class="bound">g</span> <span class="main">∈</span> set <span class="free">gs</span> <span class="main">⟹</span> valid <span class="main">(</span><span class="main">(</span><span class="bound">g</span><span class="main">,</span> <span class="bound">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="bound">rest</span><span class="main">)</span> <span class="main">⟹</span> correct <span class="main">(</span><span class="main">(</span><span class="bound">g</span><span class="main">,</span> <span class="bound">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="bound">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="free">k</span><span class="main">.</span> eval <span class="main">(</span><span class="free">gs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="free">xs</span> <span class="main">↓</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> length <span class="free">gs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"reachable
    <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span>
    <span class="main">(</span><span class="main">(</span>Cn <span class="free">n</span> <span class="free">f</span> <span class="free">gs</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> take <span class="free">k</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> the <span class="main">(</span>eval <span class="bound">g</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="free">gs</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> reachable_refl <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ys</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> the <span class="main">(</span>eval <span class="bound">g</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="free">gs</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> Suc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">gs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>Cn <span class="free">n</span> <span class="free">f</span> <span class="free">gs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"valid <span class="free">rest</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> valid_ConsE<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Cn <span class="free">n</span> <span class="free">f</span> <span class="free">gs</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">from</span></span> Suc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span> <span class="main">(</span><span class="main">(</span>Cn <span class="free">n</span> <span class="free">f</span> <span class="free">gs</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> take <span class="skolem">k</span> <span class="var">?ys</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">(</span><span class="var">?stack1</span><span class="main">,</span> None<span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">...</span> <span class="main">(</span><span class="main">(</span><span class="free">gs</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="var">?stack1</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> step_reachable <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">gs</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> min_absorb2<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">...</span> <span class="main">(</span><span class="var">?stack1</span><span class="main">,</span> eval <span class="main">(</span><span class="free">gs</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="var">?rv</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">gs</span>›</span></span> assms<span class="main">(</span>3<span class="main">)</span> valid valid_ConsI <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">...</span> <span class="main">(</span><span class="main">(</span>Cn <span class="free">n</span> <span class="free">f</span> <span class="free">gs</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="var">?ys</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">(</span><span class="var">?stack2</span><span class="main">,</span> None<span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"step <span class="main">(</span><span class="var">?stack1</span><span class="main">,</span> <span class="var">?rv</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>Cn <span class="free">n</span> <span class="free">f</span> <span class="free">gs</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="main">(</span>take <span class="skolem">k</span> <span class="var">?ys</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>the <span class="var">?rv</span><span class="main">]</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>Cn <span class="free">n</span> <span class="free">f</span> <span class="free">gs</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="var">?ys</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">gs</span>›</span></span> take_Suc_conv_app_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> step_reachable <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span> <span class="main">(</span><span class="var">?stack2</span><span class="main">,</span> None<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> step_Cn_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid <span class="main">(</span><span class="main">(</span><span class="main">(</span>Cn <span class="free">n</span> <span class="free">f</span> <span class="free">gs</span><span class="main">)</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"valid <span class="var">?stack</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">rest</span><span class="main">.</span> valid <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="bound">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="bound">rest</span><span class="main">)</span> <span class="main">⟹</span> correct <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="bound">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="bound">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">g</span> <span class="bound">xs</span> <span class="bound">rest</span><span class="main">.</span>
      <span class="bound">g</span> <span class="main">∈</span> set <span class="free">gs</span> <span class="main">⟹</span> valid <span class="main">(</span><span class="main">(</span><span class="bound">g</span><span class="main">,</span> <span class="bound">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="bound">rest</span><span class="main">)</span> <span class="main">⟹</span> correct <span class="main">(</span><span class="main">(</span><span class="bound">g</span><span class="main">,</span> <span class="bound">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="bound">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"correct <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>Cn <span class="free">n</span> <span class="free">f</span> <span class="free">gs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"valid <span class="free">rest</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_ConsE<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ys</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> the <span class="main">(</span>eval <span class="bound">g</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="free">gs</span>"</span></span>
  <span class="keyword1"><span class="command">consider</span></span>
      <span class="main">(</span>diverg_f<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">g</span><span class="main">∈</span>set <span class="free">gs</span><span class="main">.</span> eval <span class="bound">g</span> <span class="free">xs</span> <span class="main">↓</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eval <span class="free">f</span> <span class="var">?ys</span> <span class="main">↑</span>"</span></span>
    <span class="main">|</span> <span class="main">(</span>diverg_gs<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">g</span><span class="main">∈</span>set <span class="free">gs</span><span class="main">.</span> eval <span class="bound">g</span> <span class="free">xs</span> <span class="main">↑</span>"</span></span>
    <span class="main">|</span> <span class="main">(</span>converg<span class="main">)</span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Cn <span class="free">n</span> <span class="free">f</span> <span class="free">gs</span><span class="main">)</span> <span class="free">xs</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_ConsE<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> diverg_f
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free">gs</span><span class="main">.</span> eval <span class="main">(</span><span class="free">gs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="free">xs</span> <span class="main">↓</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span> <span class="main">(</span><span class="main">(</span>Cn <span class="free">n</span> <span class="free">f</span> <span class="free">gs</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="var">?ys</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">(</span><span class="var">?stack1</span><span class="main">,</span> None<span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> reachable_Cn<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?k</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"length <span class="free">gs</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">...</span> <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="var">?ys</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="var">?stack1</span><span class="main">,</span> None<span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">(</span><span class="var">?stack2</span><span class="main">,</span> None<span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step_reachable<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span> <span class="main">(</span><span class="var">?stack2</span><span class="main">,</span> None<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nonterminating <span class="main">(</span><span class="var">?stack2</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> diverg_f<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?ys</span></span></span> <span class="var"><span class="quoted"><span class="var">?stack1</span></span></span><span class="main">]</span> valid_ConsE<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> valid_ConsI
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nonterminating <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> reachable_nonterminating <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Cn <span class="free">n</span> <span class="free">f</span> <span class="free">gs</span><span class="main">)</span> <span class="free">xs</span> <span class="main">↑</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> diverg_f<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>1<span class="main">)</span> eval_Cn valid_ConsE <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> diverg_gs
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ex_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free">gs</span><span class="main">.</span> eval <span class="main">(</span><span class="free">gs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="free">xs</span> <span class="main">↑</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> in_set_conv_nth<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">gs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">gs</span> <span class="main">∧</span> eval <span class="main">(</span><span class="free">gs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="free">xs</span> <span class="main">↑</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> Least <span class="var">?P</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> gs_k<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span><span class="free">gs</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="free">xs</span> <span class="main">↑</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> LeastI_ex<span class="main">[</span><span class="operator">OF</span> ex_i<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="skolem">k</span><span class="main">.</span> eval <span class="main">(</span><span class="free">gs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="free">xs</span> <span class="main">↓</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> k_def not_less_Least<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">]</span> LeastI_ex<span class="main">[</span><span class="operator">OF</span> ex_i<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">gs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ex_i less_le_trans not_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span> <span class="main">(</span><span class="main">(</span>Cn <span class="free">n</span> <span class="free">f</span> <span class="free">gs</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> take <span class="skolem">k</span> <span class="var">?ys</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> reachable_Cn<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">...</span>
      <span class="main">(</span><span class="main">(</span><span class="free">gs</span> <span class="main">!</span> <span class="main">(</span>length <span class="main">(</span>take <span class="skolem">k</span> <span class="var">?ys</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>Cn <span class="free">n</span> <span class="free">f</span> <span class="free">gs</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> take <span class="skolem">k</span> <span class="var">?ys</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">(</span><span class="var">?stack1</span><span class="main">,</span> None<span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>take <span class="skolem">k</span> <span class="var">?ys</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="free">gs</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">gs</span>›</span></span> less_imp_le_nat min_less_iff_disj<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> step_reachable <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span> <span class="main">(</span><span class="var">?stack1</span><span class="main">,</span> None<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nonterminating <span class="main">(</span><span class="var">?stack1</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="free">gs</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">gs</span>›</span></span> valid<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"correct <span class="main">(</span><span class="var">?stack1</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">gs</span>›</span></span> nth_mem valid valid_ConsI
          assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">gs</span> <span class="main">!</span> <span class="main">(</span>length <span class="main">(</span>take <span class="skolem">k</span> <span class="var">?ys</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>take <span class="skolem">k</span> <span class="var">?ys</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">gs</span>›</span></span> less_imp_le_nat min_absorb2<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> gs_k <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nonterminating <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> reachable_nonterminating <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Cn <span class="free">n</span> <span class="free">f</span> <span class="free">gs</span><span class="main">)</span> <span class="free">xs</span> <span class="main">↑</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> diverg_gs valid <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> converg
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="free">f</span> <span class="var">?ys</span> <span class="main">↓</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> set <span class="free">gs</span> <span class="main">⟹</span> eval <span class="bound">g</span> <span class="free">xs</span> <span class="main">↓</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eval_Cn<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free">gs</span><span class="main">.</span> eval <span class="main">(</span><span class="free">gs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="free">xs</span> <span class="main">↓</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span> <span class="main">(</span><span class="main">(</span>Cn <span class="free">n</span> <span class="free">f</span> <span class="free">gs</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> take <span class="main">(</span>length <span class="free">gs</span><span class="main">)</span> <span class="var">?ys</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> reachable_Cn assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">...</span> <span class="main">(</span><span class="main">(</span>Cn <span class="free">n</span> <span class="free">f</span> <span class="free">gs</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="var">?ys</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">(</span><span class="var">?stack1</span><span class="main">,</span> None<span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reachable_refl<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">...</span> <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="var">?ys</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="var">?stack1</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> step_reachable <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">...</span> <span class="main">(</span><span class="var">?stack1</span><span class="main">,</span> eval <span class="free">f</span> <span class="var">?ys</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="var">?ys</span>"</span></span><span class="main">]</span> correct_convergE valid f valid_ConsI <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span><span class="var">?stack1</span><span class="main">,</span> eval <span class="free">f</span> <span class="var">?ys</span><span class="main">)</span> <span class="main">(</span><span class="free">rest</span><span class="main">,</span> eval <span class="free">f</span> <span class="var">?ys</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span> <span class="main">(</span><span class="free">rest</span><span class="main">,</span> eval <span class="free">f</span> <span class="var">?ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Cn <span class="free">n</span> <span class="free">f</span> <span class="free">gs</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> eval <span class="free">f</span> <span class="var">?ys</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> g valid<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> converg correct_convergI <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹During the execution of a frame with a partial recursive function
of shape <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Pr <span class="free"><span class="free">n</span></span> <span class="free"><span class="free">f</span></span> <span class="free"><span class="free">g</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and arguments <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">x</span></span> <span class="main"><span class="main">#</span></span> <span class="free"><span class="free">xs</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the list of local
variables collects all the function values up to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in reversed
order. We call such a list a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">trace</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for short.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">trace</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> recf <span class="main">⇒</span> recf <span class="main">⇒</span> nat list <span class="main">⇒</span> nat <span class="main">⇒</span> nat list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">trace</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> the <span class="main">(</span>eval <span class="main">(</span>Pr <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>rev <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> trace_length<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>trace <span class="free">n</span> <span class="free">f</span> <span class="free">g</span> <span class="free">xs</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> Suc <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> trace_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> trace_hd<span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>trace <span class="free">n</span> <span class="free">f</span> <span class="free">g</span> <span class="free">xs</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span>eval <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> trace_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> trace_Suc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"trace <span class="free">n</span> <span class="free">f</span> <span class="free">g</span> <span class="free">xs</span> <span class="main">(</span>Suc <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>the <span class="main">(</span>eval <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>trace <span class="free">n</span> <span class="free">f</span> <span class="free">g</span> <span class="free">xs</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> trace_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> reachable_Pr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid <span class="main">(</span><span class="main">(</span><span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span><span class="main">,</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"valid <span class="var">?stack</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">rest</span><span class="main">.</span> valid <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="bound">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="bound">rest</span><span class="main">)</span> <span class="main">⟹</span> correct <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="bound">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="bound">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">rest</span><span class="main">.</span> valid <span class="main">(</span><span class="main">(</span><span class="free">g</span><span class="main">,</span> <span class="bound">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="bound">rest</span><span class="main">)</span> <span class="main">⟹</span> correct <span class="main">(</span><span class="main">(</span><span class="free">g</span><span class="main">,</span> <span class="bound">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="bound">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span> <span class="main">(</span><span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">,</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">,</span> trace <span class="free">n</span> <span class="free">f</span> <span class="free">g</span> <span class="free">xs</span> <span class="free">y</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">have</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>length <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"valid <span class="free">rest</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_ConsE<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="free">f</span> <span class="free">xs</span> <span class="main">↓</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?as</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">#</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span><span class="main">,</span> <span class="var">?as</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> step_reachable <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">...</span> <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> eval <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span><span class="main">,</span> <span class="var">?as</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span>"</span></span><span class="main">]</span>
      correct_convergE<span class="main">[</span><span class="operator">OF</span> _ f<span class="main">]</span> f valid valid_ConsI
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">...</span> <span class="main">(</span><span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">,</span> <span class="var">?as</span><span class="main">,</span> <span class="main">[</span>the <span class="main">(</span>eval <span class="free">f</span> <span class="free">xs</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> step_reachable valid<span class="main">(</span>1<span class="main">)</span> f <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span> <span class="main">(</span><span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">,</span> <span class="var">?as</span><span class="main">,</span> <span class="main">[</span>the <span class="main">(</span>eval <span class="free">f</span> <span class="free">xs</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> trace_def valid<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>length <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"valid <span class="free">rest</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_ConsE<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ls</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"trace <span class="free">n</span> <span class="free">f</span> <span class="free">g</span> <span class="free">xs</span> <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> lenls<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="var">?ls</span> <span class="main">=</span> Suc <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> trace_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> hdls<span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="var">?ls</span> <span class="main">=</span> the <span class="main">(</span>eval <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc trace_hd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> g<span class="main">:</span>
    <span class="quoted"><span class="quoted">"eval <span class="free">g</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> hd <span class="var">?ls</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓</span>"</span></span>
    <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">y</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> eval <span class="free">g</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> hd <span class="var">?ls</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eval_Pr_Suc_converg hdls valid<span class="main">(</span>1<span class="main">)</span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span> <span class="main">(</span><span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">,</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">,</span> <span class="var">?ls</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">(</span><span class="var">?stack1</span><span class="main">,</span> None<span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> Suc valid<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">...</span> <span class="main">(</span><span class="main">(</span><span class="free">g</span><span class="main">,</span> <span class="skolem">y</span> <span class="main">#</span> hd <span class="var">?ls</span> <span class="main">#</span> <span class="free">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">,</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">,</span> <span class="var">?ls</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc.prems lenls <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">...</span> <span class="main">(</span><span class="var">?stack1</span><span class="main">,</span> eval <span class="free">g</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> hd <span class="var">?ls</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="var">?rv</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> g<span class="main">(</span>1<span class="main">)</span> valid valid_ConsI <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">...</span> <span class="main">(</span><span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">,</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">,</span> <span class="main">(</span>the <span class="var">?rv</span><span class="main">)</span> <span class="main">#</span> <span class="var">?ls</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>1<span class="main">)</span> g<span class="main">(</span>1<span class="main">)</span> lenls <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span> <span class="main">(</span><span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">,</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">,</span> <span class="main">(</span>the <span class="var">?rv</span><span class="main">)</span> <span class="main">#</span> <span class="var">?ls</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"trace <span class="free">n</span> <span class="free">f</span> <span class="free">g</span> <span class="free">xs</span> <span class="main">(</span>Suc <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>the <span class="var">?rv</span><span class="main">)</span> <span class="main">#</span> <span class="var">?ls</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> g<span class="main">(</span>2<span class="main">)</span> trace_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> step_Pr_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid <span class="main">(</span><span class="main">(</span><span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"valid <span class="var">?stack</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">rest</span><span class="main">.</span> valid <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="bound">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="bound">rest</span><span class="main">)</span> <span class="main">⟹</span> correct <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="bound">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="bound">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">rest</span><span class="main">.</span> valid <span class="main">(</span><span class="main">(</span><span class="free">g</span><span class="main">,</span> <span class="bound">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="bound">rest</span><span class="main">)</span> <span class="main">⟹</span> correct <span class="main">(</span><span class="main">(</span><span class="free">g</span><span class="main">,</span> <span class="bound">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="bound">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"correct <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"valid <span class="free">rest</span>"</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_ConsE<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> y_ys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> list.exhaust_sel <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"trace <span class="free">n</span> <span class="free">f</span> <span class="free">g</span> <span class="skolem">ys</span>"</span></span>
  <span class="keyword1"><span class="command">consider</span></span>
      <span class="main">(</span>converg<span class="main">)</span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="free">xs</span> <span class="main">↓</span>"</span></span>
    <span class="main">|</span> <span class="main">(</span>diverg_f<span class="main">)</span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="free">xs</span> <span class="main">↑</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eval <span class="free">f</span> <span class="skolem">ys</span> <span class="main">↑</span>"</span></span>
    <span class="main">|</span> <span class="main">(</span>diverg<span class="main">)</span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="free">xs</span> <span class="main">↑</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eval <span class="free">f</span> <span class="skolem">ys</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> converg
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">⟹</span> reachable <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="var">?t</span> <span class="bound">z</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms valid <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_Pr_converg_le reachable_Pr y_ys<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="var">?t</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span><span class="main">(</span><span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="var">?t</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">,</span> None<span class="main">)</span> <span class="main">(</span><span class="free">rest</span><span class="main">,</span> Some <span class="main">(</span>hd <span class="main">(</span><span class="var">?t</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> trace_length step_reachable y_ys <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span> <span class="main">(</span><span class="free">rest</span><span class="main">,</span> Some <span class="main">(</span>hd <span class="main">(</span><span class="var">?t</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> reachable_transitive <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> trace_hd converg y_ys <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> diverg_f
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="skolem">ys</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> tl <span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">(</span><span class="var">?stack1</span><span class="main">,</span> None<span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> y_ys <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span> <span class="main">(</span><span class="var">?stack1</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> step_reachable <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nonterminating <span class="main">(</span><span class="var">?stack1</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms diverg_f valid valid_ConsI * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nonterminating <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> reachable_nonterminating <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> diverg_f<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> diverg
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">z</span><span class="main">.</span> the <span class="main">(</span>eval <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="bound">z</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">&lt;</span> <span class="skolem">y</span> <span class="main">∧</span> eval <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="bound">z</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms diverg neq0_conv y_ys valid <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">zmax</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zmax</span> <span class="main">=</span> Greatest <span class="var">?Q</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="skolem">zmax</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?Q</span> <span class="main">0</span>›</span></span> GreatestI_nat<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> le_zmax<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">z</span> <span class="main">⟹</span> <span class="bound">z</span> <span class="main">≤</span> <span class="skolem">zmax</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Greatest_le_nat<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span> <span class="main">_</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span> zmax_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="var">?t</span> <span class="skolem">zmax</span><span class="main">)</span> <span class="main">&lt;</span> Suc <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?Q</span> <span class="skolem">zmax</span>›</span></span> trace_length<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">↓</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">zmax</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
      <span class="keyword1"><span class="command">using</span></span> that zmax_def <span class="quoted"><span class="quoted">‹<span class="var">?Q</span> <span class="skolem">zmax</span>›</span></span> assms eval_Pr_converg_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="skolem">ys</span></span> <span class="quoted"><span class="skolem">zmax</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span> valid y_ys
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="var">?t</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">zmax</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="quoted"><span class="quoted">‹<span class="var">?Q</span> <span class="skolem">zmax</span>›</span></span> diverg y_ys assms reachable_Pr <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="var">?t</span> <span class="skolem">zmax</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">_</span> <span class="main">(</span><span class="var">?stack1</span><span class="main">,</span> None<span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">...</span>
        <span class="main">(</span><span class="main">(</span><span class="free">g</span><span class="main">,</span> <span class="skolem">zmax</span> <span class="main">#</span> <span class="var">?h</span> <span class="skolem">zmax</span> <span class="main">#</span> tl <span class="free">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="var">?t</span> <span class="skolem">zmax</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">(</span><span class="var">?stack2</span><span class="main">,</span> None<span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> step_reachable<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="var">?t</span> <span class="skolem">zmax</span><span class="main">)</span> <span class="main">≠</span> Suc <span class="main">(</span>hd <span class="free">xs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> len y_ys <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span><span class="var">?t</span> <span class="skolem">zmax</span><span class="main">)</span> <span class="main">=</span> <span class="var">?h</span> <span class="skolem">zmax</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> trace_hd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="var">?t</span> <span class="skolem">zmax</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">zmax</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> trace_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"step <span class="main">(</span><span class="var">?stack1</span><span class="main">,</span> None<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="var">?stack2</span><span class="main">,</span> None<span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span> <span class="main">(</span><span class="var">?stack2</span><span class="main">,</span> None<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nonterminating <span class="main">(</span><span class="var">?stack2</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"correct <span class="main">(</span><span class="var">?stack2</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> y_ys assms valid_ConsI valid <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="free">g</span> <span class="main">(</span><span class="skolem">zmax</span> <span class="main">#</span> <span class="var">?h</span> <span class="skolem">zmax</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">↑</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?Q</span> <span class="skolem">zmax</span>›</span></span> diverg le_zmax len less_Suc_eq trace_length y_ys valid
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> y_ys <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nonterminating <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> reachable_nonterminating <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> diverg assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> reachable_Mn<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid <span class="main">(</span><span class="main">(</span>Mn <span class="free">n</span> <span class="free">f</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"valid <span class="var">?stack</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">rest</span><span class="main">.</span> valid <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="bound">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="bound">rest</span><span class="main">)</span> <span class="main">⟹</span> correct <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="bound">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="bound">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">y</span></span><span class="main">&lt;</span><span class="free">z</span><span class="main">.</span> eval <span class="free">f</span> <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">∉</span> <span class="main">{</span>None<span class="main">,</span> Some <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">z</span> <span class="main">#</span> <span class="free">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>Mn <span class="free">n</span> <span class="free">f</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="main">[</span><span class="free">z</span><span class="main">]</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">z</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"step <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="main">0</span> <span class="main">#</span> <span class="free">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>Mn <span class="free">n</span> <span class="free">f</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> step_reachable assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">z</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"valid <span class="free">rest</span>"</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>Mn <span class="free">n</span> <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_ConsE<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="free">f</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">∉</span> <span class="main">{</span>None<span class="main">,</span> Some <span class="main">0</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="skolem">z</span> <span class="main">#</span> <span class="free">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>Mn <span class="free">n</span> <span class="free">f</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">...</span> <span class="main">(</span><span class="main">(</span>Mn <span class="free">n</span> <span class="free">f</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">,</span> eval <span class="free">f</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">#</span> <span class="free">xs</span>"</span></span><span class="main">]</span> valid correct_convergE valid_ConsI <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">...</span> <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="main">(</span>Suc <span class="skolem">z</span><span class="main">)</span> <span class="main">#</span> <span class="free">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>Mn <span class="free">n</span> <span class="free">f</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="main">[</span>Suc <span class="skolem">z</span><span class="main">]</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span>  <span class="main">(</span><span class="var">?stack1</span><span class="main">,</span> None<span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> step_reachable f <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span> <span class="main">(</span><span class="var">?stack1</span><span class="main">,</span> None<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> iterate_step_empty_stack<span class="main">:</span> <span class="quoted"><span class="quoted">"iterate <span class="free">t</span> step <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">rv</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">rv</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> step_empty_stack <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> reachable_iterate_step_empty_stack<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"reachable <span class="free">cfg</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">rv</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span> iterate <span class="bound">t</span> step <span class="free">cfg</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">rv</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="bound">t</span><span class="main">.</span> fst <span class="main">(</span>iterate <span class="bound">t'</span> step <span class="free">cfg</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> iterate <span class="bound">t</span> step <span class="free">cfg</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">rv</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reachable_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tmin</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tmin</span> <span class="main">=</span> Least <span class="var">?P</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">tmin</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> LeastI_ex<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>iterate <span class="skolem">t'</span> step <span class="free">cfg</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">&lt;</span> <span class="skolem">tmin</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t'</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>iterate <span class="skolem">t'</span> step <span class="free">cfg</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"iterate <span class="skolem">t'</span> step <span class="free">cfg</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.exhaust_sel<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"iterate <span class="skolem">t''</span> step <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t''</span>
      <span class="keyword1"><span class="command">using</span></span> iterate_step_empty_stack <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"iterate <span class="main">(</span><span class="skolem">t'</span> <span class="main">+</span> <span class="skolem">t''</span><span class="main">)</span> step <span class="free">cfg</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t''</span>
      <span class="keyword1"><span class="command">using</span></span> v iterate_additive <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">+</span> <span class="skolem">t''</span> <span class="main">=</span> <span class="skolem">tmin</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="main">&lt;</span> <span class="skolem">tmin</span>›</span></span> less_imp_add_positive <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"iterate <span class="skolem">tmin</span> step <span class="free">cfg</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="free">rv</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">tmin</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"iterate <span class="skolem">t'</span> step <span class="free">cfg</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">rv</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> v <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">tmin</span><span class="main">.</span> <span class="main">¬</span> <span class="var">?P</span> <span class="bound">t'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> tmin_def <span class="keyword1"><span class="command">using</span></span> not_less_Least<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">tmin</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> step_Mn_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid <span class="main">(</span><span class="main">(</span>Mn <span class="free">n</span> <span class="free">f</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"valid <span class="var">?stack</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">rest</span><span class="main">.</span> valid <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="bound">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="bound">rest</span><span class="main">)</span> <span class="main">⟹</span> correct <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="bound">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="bound">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"correct <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"valid <span class="free">rest</span>"</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>Mn <span class="free">n</span> <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_ConsE<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">consider</span></span>
      <span class="main">(</span>diverg<span class="main">)</span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Mn <span class="free">n</span> <span class="free">f</span><span class="main">)</span> <span class="free">xs</span> <span class="main">↑</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span><span class="main">.</span> eval <span class="free">f</span> <span class="main">(</span><span class="bound">z</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓</span>"</span></span>
    <span class="main">|</span> <span class="main">(</span>diverg_f<span class="main">)</span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Mn <span class="free">n</span> <span class="free">f</span><span class="main">)</span> <span class="free">xs</span> <span class="main">↑</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">z</span><span class="main">.</span> eval <span class="free">f</span> <span class="main">(</span><span class="bound">z</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↑</span>"</span></span>
    <span class="main">|</span> <span class="main">(</span>converg<span class="main">)</span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Mn <span class="free">n</span> <span class="free">f</span><span class="main">)</span> <span class="free">xs</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> diverg
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span><span class="main">.</span> eval <span class="free">f</span> <span class="main">(</span><span class="bound">z</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">≠</span> Some <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eval_Mn_diverg<span class="main">[</span><span class="operator">OF</span> valid<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">y</span></span><span class="main">&lt;</span><span class="skolem">z</span><span class="main">.</span> eval <span class="free">f</span> <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">∉</span> <span class="main">{</span>None<span class="main">,</span> Some <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">z</span>
      <span class="keyword1"><span class="command">using</span></span> diverg <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> reach_z<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> reachable <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="bound">z</span> <span class="main">#</span> <span class="free">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>Mn <span class="free">n</span> <span class="free">f</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="main">[</span><span class="bound">z</span><span class="main">]</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> reachable_Mn<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> diverg <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> configuration"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="skolem">z</span> <span class="main">≡</span> <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="skolem">z</span> <span class="main">#</span> <span class="free">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>Mn <span class="free">n</span> <span class="free">f</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">z</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="skolem">h</span> <span class="bound">x</span> <span class="main">≠</span> <span class="skolem">h</span> <span class="bound">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> z_neq_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> fst <span class="main">(</span><span class="skolem">h</span> <span class="bound">z</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

    <span class="keyword1"><span class="command">have</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">z<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">z</span></span><span class="main">&gt;</span><span class="bound">z<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="skolem">t</span><span class="main">.</span> iterate <span class="bound">t'</span> step <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span> <span class="main">=</span> <span class="skolem">h</span> <span class="bound">z</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> h_inj le_zero_eq less_not_refl3<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">t</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> h_inj <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> le_Suc_eq less_not_refl3 less_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nonterminating <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> nonterminating <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>iterate <span class="skolem">t</span> step <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">z</span></span><span class="main">&gt;</span><span class="skolem">z<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="skolem">t</span><span class="main">.</span> iterate <span class="bound">t'</span> step <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span> <span class="main">=</span> <span class="skolem">h</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> z <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> not_h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="skolem">t</span><span class="main">.</span> iterate <span class="bound">t'</span> step <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span> <span class="main">≠</span> <span class="skolem">h</span> <span class="main">(</span>Suc <span class="skolem">z<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">≥</span><span class="skolem">t</span><span class="main">.</span> fst <span class="main">(</span>iterate <span class="bound">t'</span> step <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> t iterate_step_empty_stack iterate_additive'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_Suc_ex prod.exhaust_sel<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">≥</span><span class="skolem">t</span><span class="main">.</span> iterate <span class="bound">t'</span> step <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span> <span class="main">≠</span> <span class="skolem">h</span> <span class="main">(</span>Suc <span class="skolem">z<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> z_neq_Nil <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t'</span><span class="main">.</span> iterate <span class="bound">t'</span> step <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span> <span class="main">≠</span> <span class="skolem">h</span> <span class="main">(</span>Suc <span class="skolem">z<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> not_h nat_le_linear <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> reachable <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span> <span class="main">(</span><span class="skolem">h</span> <span class="main">(</span>Suc <span class="skolem">z<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> reachable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> reach_z<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">z<span class="hidden">⇩</span><sub>0</sub></span>"</span></span><span class="main">]</span> h_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> diverg <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> diverg_f
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">z</span><span class="main">.</span> eval <span class="free">f</span> <span class="main">(</span><span class="bound">z</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↑</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">zmin</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zmin</span> <span class="main">≡</span> Least <span class="var">?P</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">y</span></span><span class="main">&lt;</span><span class="skolem">zmin</span><span class="main">.</span> eval <span class="free">f</span> <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">∉</span> <span class="main">{</span>None<span class="main">,</span> Some <span class="main">0</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> diverg_f eval_Mn_diverg<span class="main">[</span><span class="operator">OF</span> valid<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> less_trans not_less_Least<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> f_zmin<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="free">f</span> <span class="main">(</span><span class="skolem">zmin</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↑</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> diverg_f LeastI_ex<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">]</span> zmin_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"reachable <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="skolem">zmin</span> <span class="main">#</span> <span class="free">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>Mn <span class="free">n</span> <span class="free">f</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="main">[</span><span class="skolem">zmin</span><span class="main">]</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">_</span> <span class="main">(</span><span class="var">?stack1</span><span class="main">,</span> None<span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> reachable_Mn<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nonterminating <span class="main">(</span><span class="var">?stack1</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f_zmin assms valid diverg_f valid_ConsI <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nonterminating <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> reachable_nonterminating <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> diverg_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> converg
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Mn <span class="free">n</span> <span class="free">f</span><span class="main">)</span> <span class="free">xs</span> <span class="main">↓=</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> f_z<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="free">f</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> f_less_z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="skolem">z</span> <span class="main">⟹</span> eval <span class="free">f</span> <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eval_Mn_convergE<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> valid<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span> z<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"reachable <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="skolem">z</span> <span class="main">#</span> <span class="free">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>Mn <span class="free">n</span> <span class="free">f</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> reachable_Mn<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">...</span> <span class="main">(</span><span class="main">(</span>Mn <span class="free">n</span> <span class="free">f</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">,</span> eval <span class="free">f</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">#</span> <span class="free">xs</span>"</span></span><span class="main">]</span> valid f_z valid_ConsI correct_convergE
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">...</span> <span class="main">(</span><span class="free">rest</span><span class="main">,</span> Some <span class="skolem">z</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f_z f_less_z step_reachable <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span> <span class="main">(</span><span class="free">rest</span><span class="main">,</span> Some <span class="skolem">z</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> z <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> step_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"correct <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="free">rest</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">rest</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Z
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> valid_ConsE<span class="main">[</span><span class="operator">of</span> <span class="quoted">Z</span><span class="main">]</span> step_reachable <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> S
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> valid_ConsE<span class="main">[</span><span class="operator">of</span> <span class="quoted">S</span><span class="main">]</span> step_reachable <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Id <span class="skolem">m</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> valid_ConsE<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Id <span class="skolem">m</span> <span class="skolem">n</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Cn
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> step_Cn_correct <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Pr
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> step_Pr_correct <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Mn
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> step_Mn_correct <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Encoding partial recursive functions\label{s:recf_enc}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this section we define an injective, but not surjective,
mapping from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">recf</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>s to natural numbers.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">triple_encode</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">triple_encode</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">≡</span> prod_encode <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> prod_encode <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">quad_encode</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">quad_encode</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">≡</span> prod_encode <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> prod_encode <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> prod_encode <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">encode</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"recf <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">encode</span> Z <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">encode</span> S <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">encode</span> <span class="main">(</span>Id <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> triple_encode <span class="numeral">2</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">encode</span> <span class="main">(</span>Cn <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">gs</span></span></span><span class="main">)</span> <span class="main">=</span> quad_encode <span class="numeral">3</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free">encode</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span>list_encode <span class="main">(</span>map <span class="free">encode</span> <span class="free"><span class="bound"><span class="entity">gs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">encode</span> <span class="main">(</span>Pr <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="main">=</span> quad_encode <span class="numeral">4</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free">encode</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">encode</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">encode</span> <span class="main">(</span>Mn <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">=</span> triple_encode <span class="numeral">5</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free">encode</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prod_encode_gr1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟹</span> prod_encode <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> le_prod_encode_1 less_le_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> encode_not_Z_or_S<span class="main">:</span> <span class="quoted"><span class="quoted">"encode <span class="free">f</span> <span class="main">=</span> prod_encode <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">≠</span> Z <span class="main">∧</span> <span class="free">f</span> <span class="main">≠</span> S"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> encode.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> encode.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> less_numeral_extra<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> not_one_less_zero
    prod_encode_gr1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> encode_injective<span class="main">:</span> <span class="quoted"><span class="quoted">"encode <span class="free">f</span> <span class="main">=</span> encode <span class="free">g</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">=</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">g</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Z
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">a</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟹</span> prod_encode <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prod_encode_gr1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> less_one less_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">≠</span> Z <span class="main">⟹</span> encode <span class="skolem">f</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"encode <span class="skolem">f</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="main">=</span> Z"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Z <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> S
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">a</span> <span class="main">&gt;</span> <span class="main">1</span> <span class="main">⟹</span> prod_encode <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≠</span> Suc <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prod_encode_gr1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def less_numeral_extra<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"encode <span class="skolem">f</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="main">=</span> S"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> S <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Id
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"encode <span class="skolem">f</span> <span class="main">=</span> prod_encode <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Id <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> * encode_not_Z_or_S prod_encode_eq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Cn
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"encode <span class="skolem">f</span> <span class="main">=</span> prod_encode <span class="main">(</span><span class="numeral">3</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Z
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> * encode_not_Z_or_S <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> S
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> * encode_not_Z_or_S <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Id
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_encode_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Cn
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> * Cn.IH Cn.prems list_decode_encode
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> encode.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> fst_conv list.inj_map_strong prod_encode_eq snd_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Pr
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_encode_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Mn
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_encode_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Pr
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"encode <span class="skolem">f</span> <span class="main">=</span> prod_encode <span class="main">(</span><span class="numeral">4</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Pr <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> * encode_not_Z_or_S prod_encode_eq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Mn
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"encode <span class="skolem">f</span> <span class="main">=</span> prod_encode <span class="main">(</span><span class="numeral">5</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Mn <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> * encode_not_Z_or_S prod_encode_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">encode_kind</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">encode_kind</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> pdec1 <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> encode_kind_0<span class="main">:</span> <span class="quoted"><span class="quoted">"encode_kind <span class="main">(</span>encode Z<span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> encode_kind_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> encode_kind_1<span class="main">:</span> <span class="quoted"><span class="quoted">"encode_kind <span class="main">(</span>encode S<span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> encode_kind_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> encode_kind_2<span class="main">:</span> <span class="quoted"><span class="quoted">"encode_kind <span class="main">(</span>encode <span class="main">(</span>Id <span class="free">m</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> encode_kind_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> encode.simps<span class="main"><span class="main">(</span></span>1-3<span class="main"><span class="main">)</span></span> encode_injective fst_conv prod_encode_inverse
    recf.simps<span class="main"><span class="main">(</span></span>16<span class="main"><span class="main">)</span></span> recf.simps<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> encode_kind_3<span class="main">:</span> <span class="quoted"><span class="quoted">"encode_kind <span class="main">(</span>encode <span class="main">(</span>Cn <span class="free">n</span> <span class="free">f</span> <span class="free">gs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">3</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> encode_kind_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> encode.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span> encode_injective fst_conv prod_encode_inverse
    recf.simps<span class="main"><span class="main">(</span></span>10<span class="main"><span class="main">)</span></span> recf.simps<span class="main"><span class="main">(</span></span>18<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> encode_kind_4<span class="main">:</span> <span class="quoted"><span class="quoted">"encode_kind <span class="main">(</span>encode <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">4</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> encode_kind_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> encode.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">)</span></span> encode_injective fst_conv prod_encode_inverse
    recf.simps<span class="main"><span class="main">(</span></span>12<span class="main"><span class="main">)</span></span> recf.simps<span class="main"><span class="main">(</span></span>20<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> encode_kind_5<span class="main">:</span> <span class="quoted"><span class="quoted">"encode_kind <span class="main">(</span>encode <span class="main">(</span>Mn <span class="free">n</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">5</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> encode_kind_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> encode.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">,</span></span>6<span class="main"><span class="main">)</span></span> encode_injective fst_conv prod_encode_inverse
    recf.simps<span class="main"><span class="main">(</span></span>14<span class="main"><span class="main">)</span></span> recf.simps<span class="main"><span class="main">(</span></span>22<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> encode_kind_n <span class="main">=</span>
  encode_kind_0 encode_kind_1 encode_kind_2 encode_kind_3 encode_kind_4 encode_kind_5

<span class="keyword1"><span class="command">lemma</span></span> encode_kind_Cn<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"encode_kind <span class="main">(</span>encode <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">3</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span> <span class="bound">f'</span> <span class="bound">gs</span><span class="main">.</span> <span class="free">f</span> <span class="main">=</span> Cn <span class="bound">n</span> <span class="bound">f'</span> <span class="bound">gs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms encode_kind_n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> encode_kind_Pr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"encode_kind <span class="main">(</span>encode <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">4</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span> <span class="bound">f'</span> <span class="bound">g</span><span class="main">.</span> <span class="free">f</span> <span class="main">=</span> Pr <span class="bound">n</span> <span class="bound">f'</span> <span class="bound">g</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms encode_kind_n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> encode_kind_Mn<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"encode_kind <span class="main">(</span>encode <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">5</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span> <span class="bound">g</span><span class="main">.</span> <span class="free">f</span> <span class="main">=</span> Mn <span class="bound">n</span> <span class="bound">g</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms encode_kind_n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> pdec2_encode_Id<span class="main">:</span> <span class="quoted"><span class="quoted">"pdec2 <span class="main">(</span>encode <span class="main">(</span>Id <span class="free">m</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> prod_encode <span class="main">(</span><span class="free">m</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> pdec2_encode_Pr<span class="main">:</span> <span class="quoted"><span class="quoted">"pdec2 <span class="main">(</span>encode <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> triple_encode <span class="free">n</span> <span class="main">(</span>encode <span class="free">f</span><span class="main">)</span> <span class="main">(</span>encode <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The step function on encoded configurations\label{s:step_enc}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this section we construct a function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"estep :: nat
⇒ nat"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> that is equivalent to the function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"step ::
configuration ⇒ configuration"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> except that it applies to encoded
configurations. We start by defining an encoding for configurations.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">encode_frame</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"frame <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">encode_frame</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span>
    triple_encode <span class="main">(</span>encode <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>list_encode <span class="main">(</span>fst <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>list_encode <span class="main">(</span>snd <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> encode_frame<span class="main">:</span>
  <span class="quoted"><span class="quoted">"encode_frame <span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="free">ls</span><span class="main">)</span> <span class="main">=</span> triple_encode <span class="main">(</span>encode <span class="free">f</span><span class="main">)</span> <span class="main">(</span>list_encode <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>list_encode <span class="free">ls</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> encode_frame_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">encode_option</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat option <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">encode_option</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> None <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> Suc <span class="main">(</span>the <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">encode_config</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"configuration <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">encode_config</span> <span class="free"><span class="bound"><span class="entity">cfg</span></span></span> <span class="main">≡</span>
     prod_encode <span class="main">(</span>list_encode <span class="main">(</span>map encode_frame <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">cfg</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span> encode_option <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">cfg</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> encode_config<span class="main">:</span>
  <span class="quoted"><span class="quoted">"encode_config <span class="main">(</span><span class="free">ss</span><span class="main">,</span> <span class="free">rv</span><span class="main">)</span> <span class="main">=</span> prod_encode <span class="main">(</span>list_encode <span class="main">(</span>map encode_frame <span class="free">ss</span><span class="main">)</span><span class="main">,</span> encode_option <span class="free">rv</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> encode_config_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Various projections from encoded configurations:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">e2stack</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">e2stack</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> pdec1 <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">e2rv</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">e2rv</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> pdec2 <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">e2tail</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">e2tail</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> e_tl <span class="main">(</span>e2stack <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">e2frame</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">e2frame</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> e_hd <span class="main">(</span>e2stack <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">e2i</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">e2i</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> pdec1 <span class="main">(</span>e2frame <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">e2xs</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">e2xs</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> pdec12 <span class="main">(</span>e2frame <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">e2ls</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">e2ls</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> pdec22 <span class="main">(</span>e2frame <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">e2lenas</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">e2lenas</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> e_length <span class="main">(</span>e2xs <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">e2lenls</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">e2lenls</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> e_length <span class="main">(</span>e2ls <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> e2rv_rv <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"e2rv <span class="main">(</span>encode_config <span class="main">(</span><span class="free">ss</span><span class="main">,</span> <span class="free">rv</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">rv</span> <span class="main">↑</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> Suc <span class="main">(</span>the <span class="free">rv</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> e2rv_def <span class="keyword1"><span class="command">using</span></span> encode_config <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> e2stack_stack <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"e2stack <span class="main">(</span>encode_config <span class="main">(</span><span class="free">ss</span><span class="main">,</span> <span class="free">rv</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> list_encode <span class="main">(</span>map encode_frame <span class="free">ss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> e2stack_def <span class="keyword1"><span class="command">using</span></span> encode_config <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> e2tail_tail <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"e2tail <span class="main">(</span>encode_config <span class="main">(</span><span class="free">s</span> <span class="main">#</span> <span class="free">ss</span><span class="main">,</span> <span class="free">rv</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> list_encode <span class="main">(</span>map encode_frame <span class="free">ss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> e2tail_def <span class="keyword1"><span class="command">using</span></span> encode_config <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> e2frame_frame <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"e2frame <span class="main">(</span>encode_config <span class="main">(</span><span class="free">s</span> <span class="main">#</span> <span class="free">ss</span><span class="main">,</span> <span class="free">rv</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> encode_frame <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> e2frame_def <span class="keyword1"><span class="command">using</span></span> encode_config <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> e2i_f <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"e2i <span class="main">(</span>encode_config <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="free">ls</span><span class="main">)</span> <span class="main">#</span> <span class="free">ss</span><span class="main">,</span> <span class="free">rv</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> encode <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> e2i_def <span class="keyword1"><span class="command">using</span></span> encode_config e2frame_frame encode_frame <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> e2xs_xs <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"e2xs <span class="main">(</span>encode_config <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="free">ls</span><span class="main">)</span> <span class="main">#</span> <span class="free">ss</span><span class="main">,</span> <span class="free">rv</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> list_encode <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> e2xs_def e2frame_frame encode_frame <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> e2ls_ls <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"e2ls <span class="main">(</span>encode_config <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="free">ls</span><span class="main">)</span> <span class="main">#</span> <span class="free">ss</span><span class="main">,</span> <span class="free">rv</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> list_encode <span class="free">ls</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> e2ls_def e2frame_frame encode_frame <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> e2lenas_lenas <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"e2lenas <span class="main">(</span>encode_config <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="free">ls</span><span class="main">)</span> <span class="main">#</span> <span class="free">ss</span><span class="main">,</span> <span class="free">rv</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> e2lenas_def e2frame_frame encode_frame <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> e2lenls_lenls <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"e2lenls <span class="main">(</span>encode_config <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="free">ls</span><span class="main">)</span> <span class="main">#</span> <span class="free">ss</span><span class="main">,</span> <span class="free">rv</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="free">ls</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> e2lenls_def e2frame_frame encode_frame <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> e2stack_0_iff_Nil<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">=</span> encode_config <span class="main">(</span><span class="free">ss</span><span class="main">,</span> <span class="free">rv</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"e2stack <span class="free">e</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span>  <span class="free">ss</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list_encode.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> e2stack_stack list_encode_0 map_is_Nil_conv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> e2ls_0_iff_Nil <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"list_decode <span class="main">(</span>e2ls <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟷</span> e2ls <span class="free">e</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list_decode.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list_encode_decode<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now define <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">eterm</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> piecemeal by considering the more
complicated cases <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">Cn</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">Pr</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">Mn</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> separately.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">estep_Cn</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span>
  <span class="keyword1">if</span> e2lenls <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> e_length <span class="main">(</span>pdec222 <span class="main">(</span>e2i <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1">then</span> <span class="keyword1">if</span> e2rv <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">0</span>
       <span class="keyword1">then</span> prod_encode <span class="main">(</span>e_cons <span class="main">(</span>triple_encode <span class="main">(</span>pdec122 <span class="main">(</span>e2i <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>e2ls <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>e2stack <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>
       <span class="keyword1">else</span> prod_encode <span class="main">(</span>e2tail <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> e2rv <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>
  <span class="keyword1">else</span> <span class="keyword1">if</span> e2rv <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">0</span>
       <span class="keyword1">then</span> <span class="keyword1">if</span> e2lenls <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">&lt;</span> e_length <span class="main">(</span>pdec222 <span class="main">(</span>e2i <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span>
            <span class="keyword1">then</span> prod_encode
              <span class="main">(</span>e_cons
                <span class="main">(</span>triple_encode <span class="main">(</span>e_nth <span class="main">(</span>pdec222 <span class="main">(</span>e2i <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>e2lenls <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>e2xs <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>
                <span class="main">(</span>e2stack <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">,</span>
               <span class="main">0</span><span class="main">)</span>
            <span class="keyword1">else</span> prod_encode <span class="main">(</span>e2tail <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> e2rv <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>
       <span class="keyword1">else</span> prod_encode
         <span class="main">(</span>e_cons
           <span class="main">(</span>triple_encode <span class="main">(</span>e2i <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">(</span>e2xs <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">(</span>e_snoc <span class="main">(</span>e2ls <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">(</span>e2rv <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
           <span class="main">(</span>e2tail <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">,</span>
          <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> estep_Cn<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>Cn <span class="free">n</span> <span class="free">f</span> <span class="free">gs</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="free">ls</span><span class="main">)</span> <span class="main">#</span> <span class="free">fs</span><span class="main">)</span><span class="main">,</span> <span class="free">rv</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"estep_Cn <span class="main">(</span>encode_config <span class="free">c</span><span class="main">)</span> <span class="main">=</span> encode_config <span class="main">(</span>step <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> encode_frame <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms estep_Cn_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> encode_config assms<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">estep_Pr</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span>
  <span class="keyword1">if</span> e2ls <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">0</span>
  <span class="keyword1">then</span> <span class="keyword1">if</span> e2rv <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">0</span>
       <span class="keyword1">then</span> prod_encode
         <span class="main">(</span>e_cons <span class="main">(</span>triple_encode <span class="main">(</span>pdec122 <span class="main">(</span>e2i <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>e_tl <span class="main">(</span>e2xs <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>e2stack <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">,</span>
          <span class="main">0</span><span class="main">)</span>
       <span class="keyword1">else</span> prod_encode
         <span class="main">(</span>e_cons <span class="main">(</span>triple_encode <span class="main">(</span>e2i <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">(</span>e2xs <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">(</span>singleton_encode <span class="main">(</span>e2rv <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>e2tail <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">,</span>
          <span class="main">0</span><span class="main">)</span>
  <span class="keyword1">else</span> <span class="keyword1">if</span> e2lenls <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> Suc <span class="main">(</span>e_hd <span class="main">(</span>e2xs <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span>
       <span class="keyword1">then</span> prod_encode <span class="main">(</span>e2tail <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> Suc <span class="main">(</span>e_hd <span class="main">(</span>e2ls <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
       <span class="keyword1">else</span> <span class="keyword1">if</span> e2rv <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">0</span>
            <span class="keyword1">then</span> prod_encode
              <span class="main">(</span>e_cons
                <span class="main">(</span>triple_encode
                  <span class="main">(</span>pdec222 <span class="main">(</span>e2i <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span>
                  <span class="main">(</span>e_cons <span class="main">(</span>e2lenls <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>e_cons <span class="main">(</span>e_hd <span class="main">(</span>e2ls <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>e_tl <span class="main">(</span>e2xs <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                  <span class="main">0</span><span class="main">)</span>
                <span class="main">(</span>e2stack <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">,</span>
                <span class="main">0</span><span class="main">)</span>
            <span class="keyword1">else</span> prod_encode
              <span class="main">(</span>e_cons
                <span class="main">(</span>triple_encode <span class="main">(</span>e2i <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">(</span>e2xs <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">(</span>e_cons <span class="main">(</span>e2rv <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>e2ls <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>e2tail <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">,</span>
                <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> estep_Pr1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="free">ls</span><span class="main">)</span> <span class="main">#</span> <span class="free">fs</span><span class="main">)</span><span class="main">,</span> <span class="free">rv</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ls</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ls</span> <span class="main">≠</span> Suc <span class="main">(</span>hd <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">rv</span> <span class="main">≠</span> None"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"estep_Pr <span class="main">(</span>encode_config <span class="free">c</span><span class="main">)</span> <span class="main">=</span> encode_config <span class="main">(</span>step <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"encode_config <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="free">xs</span> <span class="main">=</span> e_hd <span class="main">(</span>e2xs <span class="var">?e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms e_hd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"step <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="main">(</span>the <span class="free">rv</span><span class="main">)</span> <span class="main">#</span> <span class="free">ls</span><span class="main">)</span> <span class="main">#</span> <span class="free">fs</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"step <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="var">?t</span> <span class="main">#</span> <span class="var">?ss</span><span class="main">,</span> None<span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"encode_config <span class="main">(</span>step <span class="free">c</span><span class="main">)</span> <span class="main">=</span>
      prod_encode <span class="main">(</span>list_encode <span class="main">(</span>map encode_frame <span class="main">(</span><span class="var">?t</span> <span class="main">#</span> <span class="var">?ss</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> encode_config <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>
      prod_encode <span class="main">(</span>e_cons <span class="main">(</span>encode_frame <span class="var">?t</span><span class="main">)</span> <span class="main">(</span>list_encode <span class="main">(</span>map encode_frame <span class="main">(</span><span class="var">?ss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> prod_encode <span class="main">(</span>e_cons <span class="main">(</span>encode_frame <span class="var">?t</span><span class="main">)</span> <span class="main">(</span>e2tail <span class="var">?e</span><span class="main">)</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> prod_encode
      <span class="main">(</span>e_cons
        <span class="main">(</span>triple_encode <span class="main">(</span>e2i <span class="var">?e</span><span class="main">)</span> <span class="main">(</span>e2xs <span class="var">?e</span><span class="main">)</span> <span class="main">(</span>e_cons <span class="main">(</span>e2rv <span class="var">?e</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>e2ls <span class="var">?e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>e2tail <span class="var">?e</span><span class="main">)</span><span class="main">,</span>
       <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms encode_frame<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms eq estep_Pr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> estep_Pr2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="free">ls</span><span class="main">)</span> <span class="main">#</span> <span class="free">fs</span><span class="main">)</span><span class="main">,</span> <span class="free">rv</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ls</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ls</span> <span class="main">≠</span> Suc <span class="main">(</span>hd <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">rv</span> <span class="main">=</span> None"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"estep_Pr <span class="main">(</span>encode_config <span class="free">c</span><span class="main">)</span> <span class="main">=</span> encode_config <span class="main">(</span>step <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"encode_config <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="free">xs</span> <span class="main">=</span> e_hd <span class="main">(</span>e2xs <span class="var">?e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms e_hd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"step <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">g</span><span class="main">,</span> <span class="main">(</span>length <span class="free">ls</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">#</span> hd <span class="free">ls</span> <span class="main">#</span> tl <span class="free">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="free">ls</span><span class="main">)</span> <span class="main">#</span> <span class="free">fs</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"step <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="var">?t</span> <span class="main">#</span> <span class="var">?ss</span><span class="main">,</span> None<span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"encode_config <span class="main">(</span>step <span class="free">c</span><span class="main">)</span> <span class="main">=</span>
      prod_encode <span class="main">(</span>list_encode <span class="main">(</span>map encode_frame <span class="main">(</span><span class="var">?t</span> <span class="main">#</span> <span class="var">?ss</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> encode_config <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>
      prod_encode <span class="main">(</span>e_cons <span class="main">(</span>encode_frame <span class="var">?t</span><span class="main">)</span> <span class="main">(</span>list_encode <span class="main">(</span>map encode_frame <span class="main">(</span><span class="var">?ss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> prod_encode <span class="main">(</span>e_cons <span class="main">(</span>encode_frame <span class="var">?t</span><span class="main">)</span> <span class="main">(</span>e2stack <span class="var">?e</span><span class="main">)</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> prod_encode
    <span class="main">(</span>e_cons
      <span class="main">(</span>triple_encode
        <span class="main">(</span>pdec222 <span class="main">(</span>e2i <span class="var">?e</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>e_cons <span class="main">(</span>e2lenls <span class="var">?e</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>e_cons <span class="main">(</span>e_hd <span class="main">(</span>e2ls <span class="var">?e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>e_tl <span class="main">(</span>e2xs <span class="var">?e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">0</span><span class="main">)</span>
      <span class="main">(</span>e2stack <span class="var">?e</span><span class="main">)</span><span class="main">,</span>
     <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> encode_frame<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="free">ls</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">#</span> hd <span class="free">ls</span> <span class="main">#</span> tl <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span>
      pdec2_encode_Pr<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">g</span></span><span class="main">]</span> e2xs_xs e2i_f e2lenls_lenls e2ls_ls e_hd
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list_encode.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.collapse list_decode_encode
      prod_encode_inverse snd_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms eq estep_Pr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> estep_Pr3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="free">ls</span><span class="main">)</span> <span class="main">#</span> <span class="free">fs</span><span class="main">)</span><span class="main">,</span> <span class="free">rv</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ls</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ls</span> <span class="main">=</span> Suc <span class="main">(</span>hd <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"estep_Pr <span class="main">(</span>encode_config <span class="free">c</span><span class="main">)</span> <span class="main">=</span> encode_config <span class="main">(</span>step <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"encode_config <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hd <span class="free">xs</span> <span class="main">=</span> e_hd <span class="main">(</span>e2xs <span class="var">?e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms e_hd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>length <span class="free">ls</span> <span class="main">=</span> Suc <span class="main">(</span>hd <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>e2lenls <span class="var">?e</span> <span class="main">=</span> Suc <span class="main">(</span>e_hd <span class="main">(</span>e2xs <span class="var">?e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"estep_Pr <span class="var">?e</span> <span class="main">=</span> prod_encode <span class="main">(</span>e2tail <span class="var">?e</span><span class="main">,</span> Suc <span class="main">(</span>e_hd <span class="main">(</span>e2ls <span class="var">?e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms estep_Pr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"step <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="free">fs</span><span class="main">,</span> Some <span class="main">(</span>hd <span class="free">ls</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"encode_config <span class="main">(</span>step <span class="free">c</span><span class="main">)</span> <span class="main">=</span>
      prod_encode <span class="main">(</span>list_encode <span class="main">(</span>map encode_frame <span class="free">fs</span><span class="main">)</span><span class="main">,</span> encode_option <span class="main">(</span>Some <span class="main">(</span>hd <span class="free">ls</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> encode_config <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>
      prod_encode <span class="main">(</span>list_encode <span class="main">(</span>map encode_frame <span class="free">fs</span><span class="main">)</span><span class="main">,</span> encode_option <span class="main">(</span>Some <span class="main">(</span>e_hd <span class="main">(</span>e2ls <span class="var">?e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> e_hd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> prod_encode <span class="main">(</span>list_encode <span class="main">(</span>map encode_frame <span class="free">fs</span><span class="main">)</span><span class="main">,</span> Suc <span class="main">(</span>e_hd <span class="main">(</span>e2ls <span class="var">?e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> prod_encode <span class="main">(</span>e2tail <span class="var">?e</span><span class="main">,</span> Suc <span class="main">(</span>e_hd <span class="main">(</span>e2ls <span class="var">?e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"encode_config <span class="main">(</span>step <span class="free">c</span><span class="main">)</span> <span class="main">=</span> prod_encode <span class="main">(</span>e2tail <span class="var">?e</span><span class="main">,</span> Suc <span class="main">(</span>e_hd <span class="main">(</span>e2ls <span class="var">?e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> estep_Pr_def * <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> estep_Pr4<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="free">ls</span><span class="main">)</span> <span class="main">#</span> <span class="free">fs</span><span class="main">)</span><span class="main">,</span> <span class="free">rv</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ls</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"estep_Pr <span class="main">(</span>encode_config <span class="free">c</span><span class="main">)</span> <span class="main">=</span> encode_config <span class="main">(</span>step <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> encode_frame
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms estep_Pr_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> encode_config assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> estep_Pr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="free">ls</span><span class="main">)</span> <span class="main">#</span> <span class="free">fs</span><span class="main">)</span><span class="main">,</span> <span class="free">rv</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>Pr <span class="free">n</span> <span class="free">f</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"estep_Pr <span class="main">(</span>encode_config <span class="free">c</span><span class="main">)</span> <span class="main">=</span> encode_config <span class="main">(</span>step <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms estep_Pr1 estep_Pr2 estep_Pr3 estep_Pr4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">estep_Mn</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span>
  <span class="keyword1">if</span> e2ls <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">0</span>
  <span class="keyword1">then</span> prod_encode
    <span class="main">(</span>e_cons
      <span class="main">(</span>triple_encode <span class="main">(</span>pdec22 <span class="main">(</span>e2i <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>e_cons <span class="main">0</span> <span class="main">(</span>e2xs <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>
      <span class="main">(</span>e_cons
        <span class="main">(</span>triple_encode <span class="main">(</span>e2i <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">(</span>e2xs <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">(</span>singleton_encode <span class="main">0</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>e2tail <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
     <span class="main">0</span><span class="main">)</span>
  <span class="keyword1">else</span> <span class="keyword1">if</span> e2rv <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">1</span>
       <span class="keyword1">then</span> prod_encode <span class="main">(</span>e2tail <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> Suc <span class="main">(</span>e_hd <span class="main">(</span>e2ls <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
       <span class="keyword1">else</span> prod_encode
        <span class="main">(</span>e_cons
          <span class="main">(</span>triple_encode <span class="main">(</span>pdec22 <span class="main">(</span>e2i <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>e_cons <span class="main">(</span>Suc <span class="main">(</span>e_hd <span class="main">(</span>e2ls <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>e2xs <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>
          <span class="main">(</span>e_cons
            <span class="main">(</span>triple_encode <span class="main">(</span>e2i <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">(</span>e2xs <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">(</span>singleton_encode <span class="main">(</span>Suc <span class="main">(</span>e_hd <span class="main">(</span>e2ls <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>e2tail <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
        <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> estep_Mn<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>Mn <span class="free">n</span> <span class="free">f</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="free">ls</span><span class="main">)</span> <span class="main">#</span> <span class="free">fs</span><span class="main">)</span><span class="main">,</span> <span class="free">rv</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"estep_Mn <span class="main">(</span>encode_config <span class="free">c</span><span class="main">)</span> <span class="main">=</span> encode_config <span class="main">(</span>step <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"encode_config <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="free">ls</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">rv</span> <span class="main">≠</span> Some <span class="main">0</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ls</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">rv</span> <span class="main">=</span> Some <span class="main">0</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ls</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> step_c<span class="main">:</span> <span class="quoted"><span class="quoted">"step <span class="free">c</span> <span class="main">=</span>
       <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="main">(</span>Suc <span class="main">(</span>hd <span class="free">ls</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="free">xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span>Mn <span class="free">n</span> <span class="free">f</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="main">[</span>Suc <span class="main">(</span>hd <span class="free">ls</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">#</span> <span class="free">fs</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"step <span class="free">c</span> <span class="main">=</span> <span class="var">?cfg</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"estep_Mn <span class="var">?e</span> <span class="main">=</span>
      prod_encode
        <span class="main">(</span>e_cons
          <span class="main">(</span>triple_encode <span class="main">(</span>encode <span class="free">f</span><span class="main">)</span> <span class="main">(</span>e_cons <span class="main">(</span>Suc <span class="main">(</span>hd <span class="free">ls</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>list_encode <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>
          <span class="main">(</span>e_cons
            <span class="main">(</span>triple_encode <span class="main">(</span>encode <span class="main">(</span>Mn <span class="free">n</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>list_encode <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>singleton_encode <span class="main">(</span>Suc <span class="main">(</span>hd <span class="free">ls</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>list_encode <span class="main">(</span>map encode_frame <span class="free">fs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
        <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 assms e_hd_def estep_Mn_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> encode_config <span class="var">?cfg</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> encode_config <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> encode_frame<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> step_c <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"estep_Mn <span class="var">?e</span> <span class="main">=</span> prod_encode <span class="main">(</span>e2tail <span class="var">?e</span><span class="main">,</span> Suc <span class="main">(</span>e_hd <span class="main">(</span>e2ls <span class="var">?e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 2 assms estep_Mn_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> prod_encode <span class="main">(</span>e2tail <span class="var">?e</span><span class="main">,</span> Suc <span class="main">(</span>hd <span class="free">ls</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 2 assms e_hd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> prod_encode <span class="main">(</span>list_encode <span class="main">(</span>map encode_frame <span class="free">fs</span><span class="main">)</span><span class="main">,</span> Suc <span class="main">(</span>hd <span class="free">ls</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> encode_config <span class="main">(</span><span class="free">fs</span><span class="main">,</span> Some <span class="main">(</span>hd <span class="free">ls</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> encode_config <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 2 assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 3
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms encode_frame <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> estep_Mn_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> encode_config<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">estep</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span>
  <span class="keyword1">if</span> e2stack <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> prod_encode <span class="main">(</span><span class="main">0</span><span class="main">,</span> e2rv <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>
  <span class="keyword1">else</span> <span class="keyword1">if</span> e2i <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> prod_encode <span class="main">(</span>e2tail <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> <span class="main">1</span><span class="main">)</span>
  <span class="keyword1">else</span> <span class="keyword1">if</span> e2i <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> prod_encode <span class="main">(</span>e2tail <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> Suc <span class="main">(</span>Suc <span class="main">(</span>e_hd <span class="main">(</span>e2xs <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1">else</span> <span class="keyword1">if</span> encode_kind <span class="main">(</span>e2i <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">then</span>
    prod_encode <span class="main">(</span>e2tail <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">,</span> Suc <span class="main">(</span>e_nth <span class="main">(</span>e2xs <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">(</span>pdec22 <span class="main">(</span>e2i <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1">else</span> <span class="keyword1">if</span> encode_kind <span class="main">(</span>e2i <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="numeral">3</span> <span class="keyword1">then</span> estep_Cn <span class="free"><span class="bound"><span class="entity">e</span></span></span>
  <span class="keyword1">else</span> <span class="keyword1">if</span> encode_kind <span class="main">(</span>e2i <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="numeral">4</span> <span class="keyword1">then</span> estep_Pr <span class="free"><span class="bound"><span class="entity">e</span></span></span>
  <span class="keyword1">else</span> <span class="keyword1">if</span> encode_kind <span class="main">(</span>e2i <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="numeral">5</span> <span class="keyword1">then</span> estep_Mn <span class="free"><span class="bound"><span class="entity">e</span></span></span>
  <span class="keyword1">else</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> estep_Z<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>Z<span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="free">ls</span><span class="main">)</span> <span class="main">#</span> <span class="free">fs</span><span class="main">)</span><span class="main">,</span> <span class="free">rv</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"estep <span class="main">(</span>encode_config <span class="free">c</span><span class="main">)</span> <span class="main">=</span> encode_config <span class="main">(</span>step <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> encode_frame <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms estep_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> encode_config assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> estep_S<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>S<span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="free">ls</span><span class="main">)</span> <span class="main">#</span> <span class="free">fs</span><span class="main">)</span><span class="main">,</span> <span class="free">rv</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>hd <span class="main">(</span>fst <span class="free">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"estep <span class="main">(</span>encode_config <span class="free">c</span><span class="main">)</span> <span class="main">=</span> encode_config <span class="main">(</span>step <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"encode_config <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="free">xs</span> <span class="main">=</span> e_hd <span class="main">(</span>e2xs <span class="var">?e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> e_hd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"estep <span class="var">?e</span> <span class="main">=</span> prod_encode <span class="main">(</span>e2tail <span class="var">?e</span><span class="main">,</span> Suc <span class="main">(</span>Suc <span class="main">(</span>e_hd <span class="main">(</span>e2xs <span class="var">?e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> estep_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"step <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="free">fs</span><span class="main">,</span> Some <span class="main">(</span>Suc <span class="main">(</span>hd <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> eq estep_def encode_config<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">fs</span></span> <span class="quoted"><span class="quoted">"Some <span class="main">(</span>Suc <span class="main">(</span>hd <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> estep_Id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>Id <span class="free">m</span> <span class="free">n</span><span class="main">,</span> <span class="free">xs</span><span class="main">,</span> <span class="free">ls</span><span class="main">)</span> <span class="main">#</span> <span class="free">fs</span><span class="main">)</span><span class="main">,</span> <span class="free">rv</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>hd <span class="main">(</span>fst <span class="free">c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"estep <span class="main">(</span>encode_config <span class="free">c</span><span class="main">)</span> <span class="main">=</span> encode_config <span class="main">(</span>step <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"encode_config <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!</span> <span class="free">n</span> <span class="main">=</span> e_nth <span class="main">(</span>e2xs <span class="var">?e</span><span class="main">)</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms e_hd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"encode_kind <span class="main">(</span>e2i <span class="var">?e</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> encode_kind_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"estep <span class="var">?e</span> <span class="main">=</span>
      prod_encode <span class="main">(</span>e2tail <span class="var">?e</span><span class="main">,</span> Suc <span class="main">(</span>e_nth <span class="main">(</span>e2xs <span class="var">?e</span><span class="main">)</span> <span class="main">(</span>pdec22 <span class="main">(</span>e2i <span class="var">?e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms estep_def encode_kind_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"step <span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="free">fs</span><span class="main">,</span> Some <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> eq encode_config<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">fs</span></span> <span class="quoted"><span class="quoted">"Some <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> estep<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid <span class="main">(</span>fst <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"estep <span class="main">(</span>encode_config <span class="free">c</span><span class="main">)</span> <span class="main">=</span> encode_config <span class="main">(</span>step <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="free">c</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> estep_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list_encode.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> e2rv_def e2stack_stack encode_config_def
      map_is_Nil_conv prod.collapse prod_encode_inverse snd_conv step.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">s</span> <span class="skolem">fs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">ls</span></span> <span class="skolem"><span class="skolem">rv</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">f</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">,</span> <span class="skolem">ls</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">fs</span><span class="main">,</span> <span class="skolem">rv</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.exhaust_sel<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms valid_def <span class="keyword1"><span class="command">have</span></span> lenas<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">f</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Z
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> estep_Z c <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> S
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> estep_S c lenas <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Id
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> estep_Id c lenas <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Cn
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> estep_Cn c
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> e2i_f e2stack_0_iff_Nil encode.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> encode.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> encode_kind_2
        encode_kind_3 encode_kind_Cn estep_def list.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> recf.distinct<span class="main"><span class="main">(</span></span>13<span class="main"><span class="main">)</span></span>
        recf.distinct<span class="main"><span class="main">(</span></span>19<span class="main"><span class="main">)</span></span> recf.distinct<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Pr
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> estep_Pr c lenas
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> e2i_f e2stack_0_iff_Nil encode.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> encode.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> encode_kind_2
        encode_kind_4 encode_kind_Cn encode_kind_Pr estep_def list.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> recf.distinct<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span>
        recf.distinct<span class="main"><span class="main">(</span></span>21<span class="main"><span class="main">)</span></span> recf.distinct<span class="main"><span class="main">(</span></span>25<span class="main"><span class="main">)</span></span> recf.distinct<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Mn
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> estep_Pr c lenas
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> e2i_f e2stack_0_iff_Nil encode.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
        encode.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> encode_kind_2 encode_kind_5 encode_kind_Cn encode_kind_Mn encode_kind_Pr
        estep_Mn estep_def list.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> recf.distinct<span class="main"><span class="main">(</span></span>17<span class="main"><span class="main">)</span></span> recf.distinct<span class="main"><span class="main">(</span></span>23<span class="main"><span class="main">)</span></span>
        recf.distinct<span class="main"><span class="main">(</span></span>27<span class="main"><span class="main">)</span></span> recf.distinct<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The step function as a partial recursive function\label{s:step_recf}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this section we construct a primitive recursive function
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">r_step</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> computing <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">estep</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. This will entail defining <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span>
<span class="quoted"><span class="quoted">recf</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>s for many functions defined in the previous section.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_e2stack</span> <span class="main">≡</span> r_pdec1"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_e2stack_prim<span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> r_e2stack"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_e2stack_def <span class="keyword1"><span class="command">using</span></span> r_pdec1_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_e2stack <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_e2stack <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">↓=</span> e2stack <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_e2stack_def e2stack_def <span class="keyword1"><span class="command">using</span></span> r_pdec1_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_e2rv</span> <span class="main">≡</span> r_pdec2"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_e2rv_prim<span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> r_e2rv"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_e2rv_def <span class="keyword1"><span class="command">using</span></span> r_pdec2_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_e2rv <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_e2rv <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">↓=</span> e2rv <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_e2rv_def e2rv_def <span class="keyword1"><span class="command">using</span></span> r_pdec2_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_e2tail</span> <span class="main">≡</span> Cn <span class="main">1</span> r_tl <span class="main">[</span>r_e2stack<span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_e2tail_prim<span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> r_e2tail"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_e2tail_def <span class="keyword1"><span class="command">using</span></span> r_e2stack_prim r_tl_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_e2tail <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_e2tail <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">↓=</span> e2tail <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_e2tail_def e2tail_def <span class="keyword1"><span class="command">using</span></span> r_e2stack_prim r_tl_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_e2frame</span> <span class="main">≡</span> Cn <span class="main">1</span> r_hd <span class="main">[</span>r_e2stack<span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_e2frame_prim<span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> r_e2frame"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_e2frame_def <span class="keyword1"><span class="command">using</span></span> r_hd_prim r_e2stack_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_e2frame <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_e2frame <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">↓=</span> e2frame <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_e2frame_def e2frame_def <span class="keyword1"><span class="command">using</span></span> r_hd_prim r_e2stack_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_e2i</span> <span class="main">≡</span> Cn <span class="main">1</span> r_pdec1 <span class="main">[</span>r_e2frame<span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_e2i_prim<span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> r_e2i"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_e2i_def <span class="keyword1"><span class="command">using</span></span> r_pdec12_prim r_e2frame_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_e2i <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_e2i <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">↓=</span> e2i <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_e2i_def e2i_def <span class="keyword1"><span class="command">using</span></span> r_pdec12_prim r_e2frame_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_e2xs</span> <span class="main">≡</span> Cn <span class="main">1</span> r_pdec12 <span class="main">[</span>r_e2frame<span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_e2xs_prim<span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> r_e2xs"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_e2xs_def <span class="keyword1"><span class="command">using</span></span> r_pdec122_prim r_e2frame_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_e2xs <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_e2xs <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">↓=</span> e2xs <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_e2xs_def e2xs_def <span class="keyword1"><span class="command">using</span></span> r_pdec122_prim r_e2frame_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_e2ls</span> <span class="main">≡</span> Cn <span class="main">1</span> r_pdec22 <span class="main">[</span>r_e2frame<span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_e2ls_prim<span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> r_e2ls"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_e2ls_def <span class="keyword1"><span class="command">using</span></span> r_pdec222_prim r_e2frame_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_e2ls <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_e2ls <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">↓=</span> e2ls <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_e2ls_def e2ls_def <span class="keyword1"><span class="command">using</span></span> r_pdec222_prim r_e2frame_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_e2lenls</span> <span class="main">≡</span> Cn <span class="main">1</span> r_length <span class="main">[</span>r_e2ls<span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_e2lenls_prim<span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> r_e2lenls"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_e2lenls_def <span class="keyword1"><span class="command">using</span></span> r_length_prim r_e2ls_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_e2lenls <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_e2lenls <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">↓=</span> e2lenls <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_e2lenls_def e2lenls_def <span class="keyword1"><span class="command">using</span></span> r_length_prim r_e2ls_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_kind</span> <span class="main">≡</span>
  Cn <span class="main">1</span> r_ifz <span class="main">[</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">,</span> Z<span class="main">,</span> Cn <span class="main">1</span> r_ifeq <span class="main">[</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">,</span> r_const <span class="main">1</span><span class="main">,</span> r_const <span class="main">1</span><span class="main">,</span> r_pdec1<span class="main">]</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_kind_prim<span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> r_kind"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_kind_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_kind<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_kind <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">↓=</span> encode_kind <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_kind_def encode_kind_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> helpers_for_r_step_prim <span class="main">=</span>
  r_e2i_prim
  r_e2lenls_prim
  r_e2ls_prim
  r_e2rv_prim
  r_e2xs_prim
  r_e2stack_prim
  r_e2tail_prim
  r_e2frame_prim

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define primitive recursive functions <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">r_step_Id</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="free"><span class="quoted"><span class="free">r_step_Cn</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">r_step_Pr</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">r_step_Mn</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. The last three
correspond to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">estep_Cn</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">estep_Pr</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">estep_Mn</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> from
the previous section.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_step_Id</span> <span class="main">≡</span>
  Cn <span class="main">1</span> r_prod_encode <span class="main">[</span>r_e2tail<span class="main">,</span> Cn <span class="main">1</span> S <span class="main">[</span>Cn <span class="main">1</span> r_nth <span class="main">[</span>r_e2xs<span class="main">,</span> Cn <span class="main">1</span> r_pdec22 <span class="main">[</span>r_e2i<span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_step_Id<span class="main">:</span>
  <span class="quoted"><span class="quoted">"eval r_step_Id <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span>e2tail <span class="free">e</span><span class="main">,</span> Suc <span class="main">(</span>e_nth <span class="main">(</span>e2xs <span class="free">e</span><span class="main">)</span> <span class="main">(</span>pdec22 <span class="main">(</span>e2i <span class="free">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_step_Id_def <span class="keyword1"><span class="command">using</span></span> helpers_for_r_step_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">r_triple_encode</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"recf <span class="main">⇒</span> recf <span class="main">⇒</span> recf <span class="main">⇒</span> recf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">r_triple_encode</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">≡</span> Cn <span class="main">1</span> r_prod_encode <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> Cn <span class="main">1</span> r_prod_encode <span class="main">[</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">]</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_step_Cn</span> <span class="main">≡</span>
  Cn <span class="main">1</span> r_ifeq
   <span class="main">[</span>r_e2lenls<span class="main">,</span>
    Cn <span class="main">1</span> r_length <span class="main">[</span>Cn <span class="main">1</span> r_pdec222 <span class="main">[</span>r_e2i<span class="main">]</span><span class="main">]</span><span class="main">,</span>
    Cn <span class="main">1</span> r_ifz
     <span class="main">[</span>r_e2rv<span class="main">,</span>
      Cn <span class="main">1</span> r_prod_encode
       <span class="main">[</span>Cn <span class="main">1</span> r_cons <span class="main">[</span>r_triple_encode <span class="main">(</span>Cn <span class="main">1</span> r_pdec122 <span class="main">[</span>r_e2i<span class="main">]</span><span class="main">)</span> r_e2ls Z<span class="main">,</span> r_e2stack<span class="main">]</span><span class="main">,</span>
        Z<span class="main">]</span><span class="main">,</span>
      Cn <span class="main">1</span> r_prod_encode <span class="main">[</span>r_e2tail<span class="main">,</span> r_e2rv<span class="main">]</span><span class="main">]</span><span class="main">,</span>
    Cn <span class="main">1</span> r_ifz
     <span class="main">[</span>r_e2rv<span class="main">,</span>
      Cn <span class="main">1</span> r_ifless
       <span class="main">[</span>r_e2lenls<span class="main">,</span>
        Cn <span class="main">1</span> r_length <span class="main">[</span>Cn <span class="main">1</span> r_pdec222 <span class="main">[</span>r_e2i<span class="main">]</span><span class="main">]</span><span class="main">,</span>
        Cn <span class="main">1</span> r_prod_encode
         <span class="main">[</span>Cn <span class="main">1</span> r_cons
           <span class="main">[</span>r_triple_encode <span class="main">(</span>Cn <span class="main">1</span> r_nth <span class="main">[</span>Cn <span class="main">1</span> r_pdec222 <span class="main">[</span>r_e2i<span class="main">]</span><span class="main">,</span> r_e2lenls<span class="main">]</span><span class="main">)</span> r_e2xs Z<span class="main">,</span>
            r_e2stack<span class="main">]</span><span class="main">,</span>
          Z<span class="main">]</span><span class="main">,</span>
        Cn <span class="main">1</span> r_prod_encode <span class="main">[</span>r_e2tail<span class="main">,</span> r_e2rv<span class="main">]</span><span class="main">]</span><span class="main">,</span>
      Cn <span class="main">1</span> r_prod_encode
       <span class="main">[</span>Cn <span class="main">1</span> r_cons
         <span class="main">[</span>r_triple_encode r_e2i r_e2xs <span class="main">(</span>Cn <span class="main">1</span> r_snoc <span class="main">[</span>r_e2ls<span class="main">,</span> Cn <span class="main">1</span> r_dec <span class="main">[</span>r_e2rv<span class="main">]</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
          r_e2tail<span class="main">]</span><span class="main">,</span>
        Z<span class="main">]</span><span class="main">]</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_step_Cn_prim<span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> r_step_Cn"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_step_Cn_def <span class="keyword1"><span class="command">using</span></span> helpers_for_r_step_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_step_Cn<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_step_Cn <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">↓=</span> estep_Cn <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_step_Cn_def estep_Cn_def <span class="keyword1"><span class="command">using</span></span> helpers_for_r_step_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_step_Pr</span> <span class="main">≡</span>
  Cn <span class="main">1</span> r_ifz
   <span class="main">[</span>r_e2ls<span class="main">,</span>
    Cn <span class="main">1</span> r_ifz
     <span class="main">[</span>r_e2rv<span class="main">,</span>
      Cn <span class="main">1</span> r_prod_encode
       <span class="main">[</span>Cn <span class="main">1</span> r_cons
         <span class="main">[</span>r_triple_encode <span class="main">(</span>Cn <span class="main">1</span> r_pdec122 <span class="main">[</span>r_e2i<span class="main">]</span><span class="main">)</span> <span class="main">(</span>Cn <span class="main">1</span> r_tl <span class="main">[</span>r_e2xs<span class="main">]</span><span class="main">)</span> Z<span class="main">,</span>
          r_e2stack<span class="main">]</span><span class="main">,</span>
        Z<span class="main">]</span><span class="main">,</span>
      Cn <span class="main">1</span> r_prod_encode
       <span class="main">[</span>Cn <span class="main">1</span> r_cons
         <span class="main">[</span>r_triple_encode r_e2i r_e2xs <span class="main">(</span>Cn <span class="main">1</span> r_singleton_encode <span class="main">[</span>Cn <span class="main">1</span> r_dec <span class="main">[</span>r_e2rv<span class="main">]</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
          r_e2tail<span class="main">]</span><span class="main">,</span>
        Z<span class="main">]</span><span class="main">]</span><span class="main">,</span>
    Cn <span class="main">1</span> r_ifeq
     <span class="main">[</span>r_e2lenls<span class="main">,</span>
      Cn <span class="main">1</span> S <span class="main">[</span>Cn <span class="main">1</span> r_hd <span class="main">[</span>r_e2xs<span class="main">]</span><span class="main">]</span><span class="main">,</span>
      Cn <span class="main">1</span> r_prod_encode <span class="main">[</span>r_e2tail<span class="main">,</span> Cn <span class="main">1</span> S <span class="main">[</span>Cn <span class="main">1</span> r_hd <span class="main">[</span>r_e2ls<span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">,</span>
      Cn <span class="main">1</span> r_ifz
        <span class="main">[</span>r_e2rv<span class="main">,</span>
         Cn <span class="main">1</span> r_prod_encode
           <span class="main">[</span>Cn <span class="main">1</span> r_cons
             <span class="main">[</span>r_triple_encode
               <span class="main">(</span>Cn <span class="main">1</span> r_pdec222 <span class="main">[</span>r_e2i<span class="main">]</span><span class="main">)</span>
               <span class="main">(</span>Cn <span class="main">1</span> r_cons
                 <span class="main">[</span>Cn <span class="main">1</span> r_dec <span class="main">[</span>r_e2lenls<span class="main">]</span><span class="main">,</span>
                  Cn <span class="main">1</span> r_cons <span class="main">[</span>Cn <span class="main">1</span> r_hd <span class="main">[</span>r_e2ls<span class="main">]</span><span class="main">,</span>
                  Cn <span class="main">1</span> r_tl <span class="main">[</span>r_e2xs<span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">)</span>
               Z<span class="main">,</span>
              r_e2stack<span class="main">]</span><span class="main">,</span>
            Z<span class="main">]</span><span class="main">,</span>
         Cn <span class="main">1</span> r_prod_encode
           <span class="main">[</span>Cn <span class="main">1</span> r_cons
             <span class="main">[</span>r_triple_encode r_e2i r_e2xs <span class="main">(</span>Cn <span class="main">1</span> r_cons <span class="main">[</span>Cn <span class="main">1</span> r_dec <span class="main">[</span>r_e2rv<span class="main">]</span><span class="main">,</span> r_e2ls<span class="main">]</span><span class="main">)</span><span class="main">,</span>
              r_e2tail<span class="main">]</span><span class="main">,</span>
            Z<span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_step_Pr_prim<span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> r_step_Pr"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_step_Pr_def <span class="keyword1"><span class="command">using</span></span> helpers_for_r_step_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_step_Pr<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_step_Pr <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">↓=</span> estep_Pr <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_step_Pr_def estep_Pr_def <span class="keyword1"><span class="command">using</span></span> helpers_for_r_step_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_step_Mn</span> <span class="main">≡</span>
  Cn <span class="main">1</span> r_ifz
   <span class="main">[</span>r_e2ls<span class="main">,</span>
    Cn <span class="main">1</span> r_prod_encode
      <span class="main">[</span>Cn <span class="main">1</span> r_cons
        <span class="main">[</span>r_triple_encode <span class="main">(</span>Cn <span class="main">1</span> r_pdec22 <span class="main">[</span>r_e2i<span class="main">]</span><span class="main">)</span> <span class="main">(</span>Cn <span class="main">1</span> r_cons <span class="main">[</span>Z<span class="main">,</span> r_e2xs<span class="main">]</span><span class="main">)</span> Z<span class="main">,</span>
         Cn <span class="main">1</span> r_cons
           <span class="main">[</span>r_triple_encode r_e2i r_e2xs <span class="main">(</span>Cn <span class="main">1</span> r_singleton_encode <span class="main">[</span>Z<span class="main">]</span><span class="main">)</span><span class="main">,</span>
            r_e2tail<span class="main">]</span><span class="main">]</span><span class="main">,</span>
       Z<span class="main">]</span><span class="main">,</span>
    Cn <span class="main">1</span> r_ifeq
      <span class="main">[</span>r_e2rv<span class="main">,</span>
       r_const <span class="main">1</span><span class="main">,</span>
       Cn <span class="main">1</span> r_prod_encode <span class="main">[</span>r_e2tail<span class="main">,</span> Cn <span class="main">1</span> S <span class="main">[</span>Cn <span class="main">1</span> r_hd <span class="main">[</span>r_e2ls<span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">,</span>
       Cn <span class="main">1</span> r_prod_encode
         <span class="main">[</span>Cn <span class="main">1</span> r_cons
           <span class="main">[</span>r_triple_encode
             <span class="main">(</span>Cn <span class="main">1</span> r_pdec22 <span class="main">[</span>r_e2i<span class="main">]</span><span class="main">)</span>
             <span class="main">(</span>Cn <span class="main">1</span> r_cons <span class="main">[</span>Cn <span class="main">1</span> S <span class="main">[</span>Cn <span class="main">1</span> r_hd <span class="main">[</span>r_e2ls<span class="main">]</span><span class="main">]</span><span class="main">,</span> r_e2xs<span class="main">]</span><span class="main">)</span>
             Z<span class="main">,</span>
            Cn <span class="main">1</span> r_cons
              <span class="main">[</span>r_triple_encode r_e2i r_e2xs <span class="main">(</span>Cn <span class="main">1</span> r_singleton_encode <span class="main">[</span>Cn <span class="main">1</span> S <span class="main">[</span>Cn <span class="main">1</span> r_hd <span class="main">[</span>r_e2ls<span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
               r_e2tail<span class="main">]</span><span class="main">]</span><span class="main">,</span>
          Z<span class="main">]</span><span class="main">]</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_step_Mn_prim<span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> r_step_Mn"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_step_Mn_def <span class="keyword1"><span class="command">using</span></span> helpers_for_r_step_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_step_Mn<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_step_Mn <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">↓=</span> estep_Mn <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_step_Mn_def estep_Mn_def <span class="keyword1"><span class="command">using</span></span> helpers_for_r_step_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_step</span> <span class="main">≡</span>
  Cn <span class="main">1</span> r_ifz
    <span class="main">[</span>r_e2stack<span class="main">,</span>
     Cn <span class="main">1</span> r_prod_encode <span class="main">[</span>Z<span class="main">,</span> r_e2rv<span class="main">]</span><span class="main">,</span>
     Cn <span class="main">1</span> r_ifz
       <span class="main">[</span>r_e2i<span class="main">,</span>
        Cn <span class="main">1</span> r_prod_encode <span class="main">[</span>r_e2tail<span class="main">,</span> r_const <span class="main">1</span><span class="main">]</span><span class="main">,</span>
        Cn <span class="main">1</span> r_ifeq
          <span class="main">[</span>r_e2i<span class="main">,</span>
           r_const <span class="main">1</span><span class="main">,</span>
           Cn <span class="main">1</span> r_prod_encode <span class="main">[</span>r_e2tail<span class="main">,</span> Cn <span class="main">1</span> S <span class="main">[</span>Cn <span class="main">1</span> S <span class="main">[</span>Cn <span class="main">1</span> r_hd <span class="main">[</span>r_e2xs<span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">,</span>
           Cn <span class="main">1</span> r_ifeq
             <span class="main">[</span>Cn <span class="main">1</span> r_kind <span class="main">[</span>r_e2i<span class="main">]</span><span class="main">,</span>
              r_const <span class="numeral">2</span><span class="main">,</span>
              Cn <span class="main">1</span> r_prod_encode <span class="main">[</span>r_e2tail<span class="main">,</span> Cn <span class="main">1</span> S <span class="main">[</span>Cn <span class="main">1</span> r_nth <span class="main">[</span>r_e2xs<span class="main">,</span> Cn <span class="main">1</span> r_pdec22 <span class="main">[</span>r_e2i<span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">,</span>
              Cn <span class="main">1</span> r_ifeq
                <span class="main">[</span>Cn <span class="main">1</span> r_kind <span class="main">[</span>r_e2i<span class="main">]</span><span class="main">,</span>
                 r_const <span class="numeral">3</span><span class="main">,</span>
                 r_step_Cn<span class="main">,</span>
                 Cn <span class="main">1</span> r_ifeq
                   <span class="main">[</span>Cn <span class="main">1</span> r_kind <span class="main">[</span>r_e2i<span class="main">]</span><span class="main">,</span>
                    r_const <span class="numeral">4</span><span class="main">,</span>
                    r_step_Pr<span class="main">,</span>
                    Cn <span class="main">1</span> r_ifeq
                      <span class="main">[</span>Cn <span class="main">1</span> r_kind <span class="main">[</span>r_e2i<span class="main">]</span><span class="main">,</span> r_const <span class="numeral">5</span><span class="main">,</span> r_step_Mn<span class="main">,</span> Z<span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_step_prim<span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> r_step"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_step_def
  <span class="keyword1"><span class="command">using</span></span> r_kind_prim r_step_Mn_prim r_step_Pr_prim r_step_Cn_prim helpers_for_r_step_prim
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_step<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_step <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">↓=</span> estep <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_step_def estep_def
  <span class="keyword1"><span class="command">using</span></span> r_kind_prim r_step_Mn_prim r_step_Pr_prim r_step_Cn_prim helpers_for_r_step_prim
    r_kind r_step_Cn r_step_Pr r_step_Mn
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">theorem</span></span> r_step_equiv_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid <span class="main">(</span>fst <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval r_step <span class="main">[</span>encode_config <span class="free">c</span><span class="main">]</span> <span class="main">↓=</span> encode_config <span class="main">(</span>step <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> r_step estep assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The universal function\label{s:the_universal}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next function computes the configuration after arbitrarily
many steps.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_leap</span> <span class="main">≡</span>
  Pr <span class="numeral">2</span>
   <span class="main">(</span>Cn <span class="numeral">2</span> r_prod_encode
     <span class="main">[</span>Cn <span class="numeral">2</span> r_singleton_encode
       <span class="main">[</span>Cn <span class="numeral">2</span> r_prod_encode <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">0</span><span class="main">,</span> Cn <span class="numeral">2</span> r_prod_encode <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">1</span><span class="main">,</span> r_constn <span class="main">1</span> <span class="main">0</span><span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">,</span>
      r_constn <span class="main">1</span> <span class="main">0</span><span class="main">]</span><span class="main">)</span>
   <span class="main">(</span>Cn <span class="numeral">4</span> r_step <span class="main">[</span>Id <span class="numeral">4</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_leap_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="numeral">3</span> r_leap"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_leap_def <span class="keyword1"><span class="command">using</span></span> r_step_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_leap_total<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_leap <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> prim_recfn_total<span class="main">[</span><span class="operator">OF</span> r_leap_prim<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_leap<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> encode <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>e_length <span class="free">x</span><span class="main">)</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval r_leap <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> encode_config <span class="main">(</span>iterate <span class="free">t</span> step <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> list_decode <span class="free">x</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> None<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> r_leap_def <span class="keyword1"><span class="command">using</span></span> r_step_prim assms encode_config encode_frame <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> list_decode <span class="free">x</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?tc</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"iterate <span class="skolem">t</span> step <span class="var">?c</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid <span class="main">(</span>fst <span class="var">?c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_def assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> valid<span class="main">:</span> <span class="quoted"><span class="quoted">"valid <span class="main">(</span>fst <span class="var">?tc</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> iterate_step_valid <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_leap <span class="main">[</span>Suc <span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span>
      eval <span class="main">(</span>Cn <span class="numeral">4</span> r_step <span class="main">[</span>Id <span class="numeral">4</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> the <span class="main">(</span>eval r_leap <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> One_nat_def Suc_eq_plus1 eq_numeral_Suc eval_Pr_converg_Suc list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.size<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> nat_1_add_1 pred_numeral_simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> r_leap_def r_leap_prim r_leap_total<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_leap <span class="main">[</span>Suc <span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span> eval <span class="main">(</span>Cn <span class="numeral">4</span> r_step <span class="main">[</span>Id <span class="numeral">4</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> encode_config <span class="var">?tc</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_leap <span class="main">[</span>Suc <span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span> eval r_step <span class="main">[</span>encode_config <span class="var">?tc</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_step_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_leap <span class="main">[</span>Suc <span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> encode_config <span class="main">(</span>step <span class="var">?tc</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_step_equiv_step valid<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> step_leaves_empty_stack_empty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"iterate <span class="free">t</span> step <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> list_decode <span class="free">x</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> None<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> Some <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"iterate <span class="main">(</span><span class="free">t</span> <span class="main">+</span> <span class="free">t'</span><span class="main">)</span> step <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> list_decode <span class="free">x</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> None<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> Some <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t'</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next function is essentially a convenience wrapper around
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">r_leap</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. It returns zero if the configuration returned by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">r_leap</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is non-final, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free"><span class="free">v</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> if the configuration is final with
return value $v$.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_result</span> <span class="main">≡</span>
  Cn <span class="numeral">3</span> r_ifz <span class="main">[</span>Cn <span class="numeral">3</span> r_pdec1 <span class="main">[</span>r_leap<span class="main">]</span><span class="main">,</span> Cn <span class="numeral">3</span> r_pdec2 <span class="main">[</span>r_leap<span class="main">]</span><span class="main">,</span> r_constn <span class="numeral">2</span> <span class="main">0</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_result_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="numeral">3</span> r_result"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_result_def <span class="keyword1"><span class="command">using</span></span> r_leap_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_result_total<span class="main">:</span> <span class="quoted"><span class="quoted">"total r_result"</span></span>
  <span class="keyword1"><span class="command">using</span></span> r_result_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> r_result_empty_stack_None<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> encode <span class="free">f</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>e_length <span class="free">x</span><span class="main">)</span> <span class="free">f</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"iterate <span class="free">t</span> step <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> list_decode <span class="free">x</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> None<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval r_result <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_result_def
  <span class="keyword1"><span class="command">using</span></span> assms r_leap e2stack_0_iff_Nil e2stack_def e2stack_stack r_leap_total r_leap_prim
    e2rv_def e2rv_rv
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_result_empty_stack_Some<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> encode <span class="free">f</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>e_length <span class="free">x</span><span class="main">)</span> <span class="free">f</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"iterate <span class="free">t</span> step <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> list_decode <span class="free">x</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> None<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> Some <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval r_result <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_result_def
  <span class="keyword1"><span class="command">using</span></span> assms r_leap e2stack_0_iff_Nil e2stack_def e2stack_stack r_leap_total r_leap_prim
    e2rv_def e2rv_rv
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_result_empty_stack_stays<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> encode <span class="free">f</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>e_length <span class="free">x</span><span class="main">)</span> <span class="free">f</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"iterate <span class="free">t</span> step <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> list_decode <span class="free">x</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> None<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> Some <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval r_result <span class="main">[</span><span class="free">t</span> <span class="main">+</span> <span class="free">t'</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms step_leaves_empty_stack_empty r_result_empty_stack_Some <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_result_nonempty_stack<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> encode <span class="free">f</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>e_length <span class="free">x</span><span class="main">)</span> <span class="free">f</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>iterate <span class="free">t</span> step <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> list_decode <span class="free">x</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> None<span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval r_result <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ss</span></span> <span class="skolem"><span class="skolem">rv</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"iterate <span class="free">t</span> step <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> list_decode <span class="free">x</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> None<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ss</span><span class="main">,</span> <span class="skolem">rv</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_leap <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> encode_config <span class="main">(</span><span class="skolem">ss</span><span class="main">,</span> <span class="skolem">rv</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms r_leap <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Cn <span class="numeral">3</span> r_pdec1 <span class="main">[</span>r_leap<span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ss</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> r_leap_prim encode_config r_leap_total list_encode_0
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> r_result_def <span class="keyword1"><span class="command">using</span></span> r_leap_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_result_Suc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> encode <span class="free">f</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>e_length <span class="free">x</span><span class="main">)</span> <span class="free">f</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eval r_result <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"iterate <span class="free">t</span> step <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> list_decode <span class="free">x</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> None<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> Some <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?cfg</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="var">?cfg</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms r_result_empty_stack_None r_result_empty_stack_Some
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Zero_not_Suc nat.inject option.collapse option.inject prod.exhaust_sel<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Cons
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms r_result_nonempty_stack <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_result_converg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> encode <span class="free">f</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>e_length <span class="free">x</span><span class="main">)</span> <span class="free">f</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eval <span class="free">f</span> <span class="main">(</span>list_decode <span class="free">x</span><span class="main">)</span> <span class="main">↓=</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">≥</span><span class="bound">t</span><span class="main">.</span> eval r_result <span class="main">[</span><span class="bound">t'</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="free">v</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="bound">t</span><span class="main">.</span> eval r_result <span class="main">[</span><span class="bound">t'</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"list_decode <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?stack</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="var">?xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wellf <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?xs</span> <span class="main">=</span> arity <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"correct <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> step_correct valid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> Some <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"iterate <span class="skolem">t</span> step <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> Some <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> fst <span class="main">(</span>iterate <span class="bound">t'</span> step <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reachable_iterate_step_empty_stack <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span>
    <span class="quoted"><span class="quoted">"eval r_result <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="free">v</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> eval r_result <span class="main">[</span><span class="bound">t'</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_result_empty_stack_Some r_result_nonempty_stack assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_result <span class="main">[</span><span class="skolem">t</span> <span class="main">+</span> <span class="skolem">t'</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t'</span>
    <span class="keyword1"><span class="command">using</span></span> r_result_empty_stack_stays assms r_result_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">≥</span><span class="skolem">t</span><span class="main">.</span> eval r_result <span class="main">[</span><span class="bound">t'</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> le_Suc_ex <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> t<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_result_diverg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> encode <span class="free">f</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>e_length <span class="free">x</span><span class="main">)</span> <span class="free">f</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eval <span class="free">f</span> <span class="main">(</span>list_decode <span class="free">x</span><span class="main">)</span> <span class="main">↑</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval r_result <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"list_decode <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?stack</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="var">?xs</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>length <span class="var">?xs</span><span class="main">)</span> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"correct <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> step_correct valid_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nonterminating <span class="main">(</span><span class="var">?stack</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> r_result_nonempty_stack assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now we can define the universal partial recursive function. This
function executes <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">r_result</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for increasing time bounds, waits for it
to reach a final configuration, and then extracts its result value. If no
final configuration is reached, the universal function diverges.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_univ</span> <span class="main">≡</span>
  Cn <span class="numeral">2</span> r_dec <span class="main">[</span>Cn <span class="numeral">2</span> r_result <span class="main">[</span>Mn <span class="numeral">2</span> <span class="main">(</span>Cn <span class="numeral">3</span> r_not <span class="main">[</span>r_result<span class="main">]</span><span class="main">)</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_univ_recfn <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> r_univ"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_univ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">theorem</span></span> r_univ<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> encode <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>e_length <span class="free">x</span><span class="main">)</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval r_univ <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span> eval <span class="free">f</span> <span class="main">(</span>list_decode <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cond</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="numeral">3</span> r_not <span class="main">[</span>r_result<span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?while</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Mn <span class="numeral">2</span> <span class="var">?cond</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?res</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="numeral">2</span> r_result <span class="main">[</span><span class="var">?while</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"list_decode <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="var">?cond</span> <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> eval r_result <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?cond</span> <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span> eval r_not <span class="main">[</span>the <span class="main">(</span>eval r_result <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> r_result_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_result <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_result_total<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"eval <span class="free">f</span> <span class="var">?xs</span> <span class="main">↑</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> r_univ_def <span class="keyword1"><span class="command">using</span></span> * r_result_diverg<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> eval_Mn_diverg <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="free">f</span> <span class="var">?xs</span> <span class="main">↓=</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">≥</span><span class="skolem">t</span><span class="main">.</span> eval r_result <span class="main">[</span><span class="bound">t'</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="skolem">v</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> eval r_result <span class="main">[</span><span class="bound">t'</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> r_result_converg<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">≥</span><span class="skolem">t</span><span class="main">.</span> eval <span class="var">?cond</span> <span class="main">[</span><span class="bound">t'</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="skolem">t</span><span class="main">.</span> eval <span class="var">?cond</span> <span class="main">[</span><span class="bound">t'</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?while</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eval_Mn_convergI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span> <span class="var"><span class="quoted"><span class="var">?cond</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?res</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span> eval r_result <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?res</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> r_univ_def <span class="keyword1"><span class="command">using</span></span> v <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> r_univ'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>e_length <span class="free">x</span><span class="main">)</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval r_univ <span class="main">[</span>encode <span class="free">f</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span> eval <span class="free">f</span> <span class="main">(</span>list_decode <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> r_univ assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Universal functions for every arity can be built from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"r_univ"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">r_universal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> recf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">r_universal</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> Cn <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> r_univ <span class="main">[</span>Id <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">0</span><span class="main">,</span> r_shift <span class="main">(</span>r_list_encode <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_universal_recfn <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> recfn <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>r_universal <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_universal_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_universal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="free">n</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_universal <span class="free">n</span><span class="main">)</span> <span class="main">(</span>encode <span class="free">f</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> eval <span class="free">f</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_universal_def <span class="keyword1"><span class="command">using</span></span> wellf_arity_nonzero assms r_list_encode r_univ'
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We will mostly be concerned with computing unary functions. Hence
we introduce separate functions for this case.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_result1</span> <span class="main">≡</span>
  Cn <span class="numeral">3</span> r_result <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">1</span><span class="main">,</span> Cn <span class="numeral">3</span> r_singleton_encode <span class="main">[</span>Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">]</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_result1_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="numeral">3</span> r_result1"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_result1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_result1_total<span class="main">:</span> <span class="quoted"><span class="quoted">"total r_result1"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Mn_free_imp_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_result1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"eval r_result1 <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span> eval r_result <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> singleton_encode <span class="free">x</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_result1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following function will be our standard Gödel numbering
of all unary partial recursive functions.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_phi</span> <span class="main">≡</span> r_universal <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_phi_recfn <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> r_phi"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_phi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">theorem</span></span> r_phi<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> encode <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span> eval <span class="free">f</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_phi_def <span class="keyword1"><span class="command">using</span></span> r_universal assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">corollary</span></span> r_phi'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span>encode <span class="free">f</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span> eval <span class="free">f</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms r_phi <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_phi''<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span> eval r_univ <span class="main">[</span><span class="free">i</span><span class="main">,</span> singleton_encode <span class="free">x</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_universal_def r_phi_def <span class="keyword1"><span class="command">using</span></span> r_list_encode <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Applications of the universal function›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this section we shall see some ways <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">r_univ</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">r_result</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> can
be used.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lazy conditional evaluation›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹With the help of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">r_univ</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> we can now define a
\hypertarget{p:r_lifz}{lazy variant} of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">r_ifz</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, in which only one
branch is evaluated.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">r_lazyifzero</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> recf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">r_lazyifzero</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">j<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">j<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">≡</span>
     Cn <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> r_univ
      <span class="main">[</span>Cn <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> r_ifz <span class="main">[</span>Id <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">0</span><span class="main">,</span> r_constn <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span> r_constn <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">]</span><span class="main">,</span>
       r_shift <span class="main">(</span>r_list_encode <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_lazyifzero_recfn<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>r_lazyifzero <span class="free">n</span> <span class="free">j<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">j<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> r_lazyifzero_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_lazyifzero<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> encode <span class="free">f<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> encode <span class="free">f<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">f<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">f<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_lazyifzero <span class="free">n</span> <span class="free">j<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">j<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">c</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> eval <span class="free">f<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">xs</span> <span class="keyword1">else</span> eval <span class="free">f<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"r_constn <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span> r_ifz
    <span class="main">[</span>Id <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span><span class="main">,</span> r_constn <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">j<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> r_constn <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">j<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"r_shift <span class="main">(</span>r_list_encode <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?a</span> <span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓=</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?b</span> <span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">c</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free">j<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">else</span> <span class="free">j<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?c</span> <span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">↓=</span> list_encode <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> r_list_encode r_shift <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_lazyifzero <span class="free">n</span> <span class="free">j<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">j<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span>
      eval r_univ <span class="main">[</span><span class="keyword1">if</span> <span class="free">c</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free">j<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">else</span> <span class="free">j<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> list_encode <span class="free">xs</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> r_lazyifzero_def <span class="keyword1"><span class="command">using</span></span> r_lazyifzero_recfn assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms r_univ <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">r_lifz</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"recf <span class="main">⇒</span> recf <span class="main">⇒</span> recf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">r_lifz</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> r_lazyifzero <span class="main">(</span>arity <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>encode <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span>encode <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_lifz_recfn <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="free">n</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"recfn <span class="free">n</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>r_lifz <span class="free">f</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms r_lazyifzero_recfn r_lifz_def wellf_arity_nonzero <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> r_lifz <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"recfn <span class="free">n</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"recfn <span class="free">n</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_lifz <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="free">c</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">c</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> eval <span class="free">f</span> <span class="free">xs</span> <span class="keyword1">else</span> eval <span class="free">g</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms r_lazyifzero r_lifz_def wellf_arity_nonzero
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_pred<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Enumerating the domains of partial recursive functions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this section we define a binary function $\mathit{enumdom}$
such that for all $i$, the domain of $\varphi_i$ equals
$\{\mathit{enumdom}(i, x) \mid \mathit{enumdom}(i, x)\!\downarrow\}$. In
other words, the image of $\mathit{enumdom}_i$ is the domain of $\varphi_i$.

First we need some more properties of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">r_leap</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">r_result</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_leap_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_leap <span class="main">[</span>Suc <span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span> eval r_step <span class="main">[</span>the <span class="main">(</span>eval r_leap <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_leap <span class="main">[</span>Suc <span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span>
      eval <span class="main">(</span>Cn <span class="numeral">4</span> r_step <span class="main">[</span>Id <span class="numeral">4</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="free">t</span><span class="main">,</span> the <span class="main">(</span>eval r_leap <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_leap_total eval_Pr_converg_Suc r_leap_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_Cons list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> numeral_2_eq_2 numeral_3_eq_3 r_leap_prim<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> r_step_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_leap_Suc_saturating<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pdec1 <span class="main">(</span>the <span class="main">(</span>eval r_leap <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval r_leap <span class="main">[</span>Suc <span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span> eval r_leap <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"eval r_leap <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_step <span class="main">[</span>the <span class="var">?e</span><span class="main">]</span> <span class="main">↓=</span> estep <span class="main">(</span>the <span class="var">?e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_step <span class="main">[</span>the <span class="var">?e</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="main">0</span><span class="main">,</span> e2rv <span class="main">(</span>the <span class="var">?e</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> estep_def assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> e2stack_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_step <span class="main">[</span>the <span class="var">?e</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span>pdec1 <span class="main">(</span>the <span class="var">?e</span><span class="main">)</span><span class="main">,</span> pdec2 <span class="main">(</span>the <span class="var">?e</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> e2rv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_step <span class="main">[</span>the <span class="var">?e</span><span class="main">]</span> <span class="main">↓=</span> the <span class="var">?e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> r_leap_total r_leap_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_result_Suc_saturating<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eval r_result <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval r_result <span class="main">[</span>Suc <span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> eval r_ifz <span class="main">[</span>pdec1 <span class="main">(</span>the <span class="main">(</span>eval r_leap <span class="main">[</span><span class="bound">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> pdec2 <span class="main">(</span>the <span class="main">(</span>eval r_leap <span class="main">[</span><span class="bound">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">0</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="free">t</span> <span class="main">↓=</span> Suc <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> r_result_def <span class="keyword1"><span class="command">using</span></span> r_leap_total r_leap_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pdec1 <span class="main">(</span>the <span class="main">(</span>eval r_leap <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> option.sel <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_leap <span class="main">[</span>Suc <span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span> eval r_leap <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_leap_Suc_saturating <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_result <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span> <span class="var">?r</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> r_result_def <span class="keyword1"><span class="command">using</span></span> r_leap_total r_leap_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_result <span class="main">[</span>Suc <span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span> <span class="var">?r</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> r_result_def <span class="keyword1"><span class="command">using</span></span> r_leap_total r_leap_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_result <span class="main">[</span>Suc <span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span> eval r_result <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_result_saturating<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eval r_result <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval r_result <span class="main">[</span><span class="free">t</span> <span class="main">+</span> <span class="free">d</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> r_result_Suc_saturating assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">d</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> r_result_converg'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eval r_univ <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">≥</span><span class="bound">t</span><span class="main">.</span> eval r_result <span class="main">[</span><span class="bound">t'</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="free">v</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="bound">t</span><span class="main">.</span> eval r_result <span class="main">[</span><span class="bound">t'</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="numeral">3</span> r_not <span class="main">[</span>r_result<span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Mn <span class="numeral">2</span> <span class="var">?f</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="var">?m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> eval_m<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="var">?m</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?m</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↑</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_univ <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↑</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> r_univ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="var">?m</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f_t<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="var">?f</span> <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> f_less_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="skolem">t</span> <span class="main">⟹</span> eval <span class="var">?f</span> <span class="main">[</span><span class="bound">y</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eval_Mn_convergE<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral"><span class="quoted"><span class="numeral"><span class="quoted"><span class="numeral">2</span></span></span></span></span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?f</span></span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[</span></span></span><span class="free"><span class="free"><span class="free">i</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="free"><span class="free"><span class="free">x</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span>"</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t</span></span></span></span></span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">2</span> <span class="var">?m</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> One_nat_def Suc_1 length_Cons list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> eval_Cn2<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Cn <span class="numeral">2</span> r_result <span class="main">[</span><span class="var">?m</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Cn <span class="numeral">2</span> r_result <span class="main">[</span><span class="var">?m</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↑</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_univ <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↑</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> r_univ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_result <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> neq_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> eval r_result <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="free">v</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"eval r_result <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span> None"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> f_t <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_result <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="skolem">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">≠</span> Suc <span class="free">v</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> neq_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_result <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓≠</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">;</span></span> <span class="operator">use</span> f_t <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Cn <span class="numeral">2</span> r_result <span class="main">[</span><span class="var">?m</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span>
          eval r_result <span class="main">[</span>the <span class="main">(</span>eval <span class="var">?m</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> eval_m <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> w t <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Cn <span class="numeral">2</span> r_result <span class="main">[</span><span class="var">?m</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="skolem">w</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_univ <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span>
          eval r_dec <span class="main">[</span>the <span class="main">(</span>eval <span class="main">(</span>Cn <span class="numeral">2</span> r_result <span class="main">[</span><span class="var">?m</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> r_univ_def <span class="keyword1"><span class="command">using</span></span> eval_Cn2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_univ <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span> eval r_dec <span class="main">[</span><span class="skolem">w</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_univ <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="skolem">w</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> assms <span class="quoted"><span class="quoted">‹<span class="skolem">w</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> w <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">≥</span><span class="skolem">t</span><span class="main">.</span> eval r_result <span class="main">[</span><span class="bound">t'</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_result_saturating le_Suc_ex <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_result <span class="main">[</span><span class="skolem">y</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&lt;</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> neq0<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_result <span class="main">[</span><span class="skolem">y</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">≠</span> Some <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"eval r_result <span class="main">[</span><span class="skolem">y</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span> None"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> f_less_t <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">&lt;</span> <span class="skolem">t</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"eval r_result <span class="main">[</span><span class="skolem">y</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> neq0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?f</span> <span class="main">[</span><span class="skolem">y</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> f_less_t <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">&lt;</span> <span class="skolem">t</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_result_diverg'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eval r_univ <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↑</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval r_result <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="numeral">3</span> r_not <span class="main">[</span>r_result<span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Mn <span class="numeral">2</span> <span class="var">?f</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"eval r_result <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">≠</span> Some <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> r_result_total <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_result <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?f</span> <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?f</span> <span class="main">[</span><span class="skolem">y</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&lt;</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">using</span></span>  r_result_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">z</span><span class="main">.</span> eval <span class="var">?f</span> <span class="main">(</span><span class="bound">z</span> <span class="main">#</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">y</span></span><span class="main">&lt;</span><span class="bound">z</span><span class="main">.</span> eval <span class="var">?f</span> <span class="main">(</span><span class="bound">y</span> <span class="main">#</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">↓</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?m</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_univ <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> r_univ_def <span class="keyword1"><span class="command">using</span></span> r_result_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_result_bivalent'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eval r_univ <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval r_result <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="free">v</span> <span class="main">∨</span> eval r_result <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> r_result_converg'<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> r_result_Some'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eval r_result <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval r_univ <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> not_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> eval r_univ <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="free">v</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"eval r_univ <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↑</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms r_result_diverg' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_univ <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="skolem">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">≠</span> <span class="free">v</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> not_v <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_result <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="skolem">w</span> <span class="main">∨</span> eval r_result <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> r_result_bivalent' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms not_v w <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_result1_converg'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">≥</span><span class="bound">t</span><span class="main">.</span> eval r_result1 <span class="main">[</span><span class="bound">t'</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="free">v</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="bound">t</span><span class="main">.</span> eval r_result1 <span class="main">[</span><span class="bound">t'</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms r_result1 r_result_converg' r_phi'' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_result1_diverg'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↑</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval r_result1 <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms r_result1 r_result_diverg' r_phi'' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_result1_Some'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eval r_result1 <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms r_result1 r_result_Some' r_phi'' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next function performs dovetailing in order to evaluate
$\varphi_i$ for every argument for arbitrarily many steps. Given $i$ and $z$,
the function decodes $z$ into a pair $(x, t$) and outputs zero (meaning
``true'') iff.\ the computation of $\varphi_i$ on input $x$ halts after at most
$t$ steps. Fixing $i$ and varying $z$ will eventually compute $\varphi_i$
for every argument in the domain of $\varphi_i$ sufficiently long for it to
converge.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_dovetail</span> <span class="main">≡</span>
  Cn <span class="numeral">2</span> r_not <span class="main">[</span>Cn <span class="numeral">2</span> r_result1 <span class="main">[</span>Cn <span class="numeral">2</span> r_pdec2 <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">0</span><span class="main">,</span> Cn <span class="numeral">2</span> r_pdec1 <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_dovetail_prim<span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="numeral">2</span> r_dovetail"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_dovetail_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> r_dovetail<span class="main">:</span>
  <span class="quoted"><span class="quoted">"eval r_dovetail <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">z</span><span class="main">]</span> <span class="main">↓=</span>
    <span class="main">(</span><span class="keyword1">if</span> the <span class="main">(</span>eval r_result1 <span class="main">[</span>pdec2 <span class="free">z</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> pdec1 <span class="free">z</span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_dovetail_def <span class="keyword1"><span class="command">using</span></span> r_result_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The function $\mathit{enumdom}$ works as follows in order to
enumerate exactly the domain of $\varphi_i$. Given $i$ and $y$ it searches
for the minimum $z \geq y$ for which the dovetail function returns true. This
$z$ is decoded into $(x, t)$ and the $x$ is output. In this way every value
output by $\mathit{enumdom}$ is in the domain of $\varphi_i$ by construction
of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">r_dovetail</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Conversely an $x$ in the domain will be output for $y
= (x, t)$ where $t$ is such that $\varphi_i$ halts on $x$ within $t$
steps.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_dovedelay</span> <span class="main">≡</span>
  Cn <span class="numeral">3</span> r_and
    <span class="main">[</span>Cn <span class="numeral">3</span> r_dovetail <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">1</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span>
     Cn <span class="numeral">3</span> r_ifle <span class="main">[</span>Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">0</span><span class="main">,</span> r_constn <span class="numeral">2</span> <span class="main">0</span><span class="main">,</span> r_constn <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_dovedelay_prim<span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="numeral">3</span> r_dovedelay"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_dovedelay_def <span class="keyword1"><span class="command">using</span></span> r_dovetail_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_dovedelay<span class="main">:</span>
  <span class="quoted"><span class="quoted">"eval r_dovedelay <span class="main">[</span><span class="free">z</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">y</span><span class="main">]</span> <span class="main">↓=</span>
    <span class="main">(</span><span class="keyword1">if</span> the <span class="main">(</span>eval r_result1 <span class="main">[</span>pdec2 <span class="free">z</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> pdec1 <span class="free">z</span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">z</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_dovedelay_def r_dovetail r_dovetail_prim<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_enumdom</span> <span class="main">≡</span> Cn <span class="numeral">2</span> r_pdec1 <span class="main">[</span>Mn <span class="numeral">2</span> r_dovedelay<span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_enumdom_recfn <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> r_enumdom"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_enumdom_def r_dovedelay_prim<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> r_enumdom <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"eval r_enumdom <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">y</span><span class="main">]</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span><span class="bound">z</span><span class="main">.</span> eval r_dovedelay <span class="main">[</span><span class="bound">z</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">y</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>
     <span class="keyword1">then</span> Some <span class="main">(</span>pdec1 <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">z</span><span class="main">.</span> eval r_dovedelay <span class="main">[</span><span class="bound">z</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">y</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>
     <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Mn <span class="numeral">2</span> r_dovedelay"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"total r_dovedelay"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_dovedelay_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?h</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">y</span><span class="main">]</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">∃</span><span class="bound">z</span><span class="main">.</span> eval r_dovedelay <span class="main">[</span><span class="bound">z</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">y</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">)</span>
     <span class="keyword1">then</span> Some <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">z</span><span class="main">.</span> eval r_dovedelay <span class="main">[</span><span class="bound">z</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">y</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">)</span>
     <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_dovedelay_prim r_enumdom_recfn eval_Mn_convergI <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> r_enumdom_def <span class="keyword1"><span class="command">using</span></span> r_dovedelay_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the code of the empty function, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">r_enumdom</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
has an empty domain, too.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_enumdom_empty_domain<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> eval r_phi <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">↑</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> eval r_enumdom <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="bound">y</span><span class="main">]</span> <span class="main">↑</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms r_result1_diverg' r_dovedelay <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the code of a function with non-empty domain,
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">r_enumdom</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> enumerates its domain.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_enumdom_nonempty_domain<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span><span class="main">]</span> <span class="main">↓</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> eval r_enumdom <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="bound">y</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> eval r_phi <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">↓</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> eval r_enumdom <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="bound">y</span><span class="main">]</span> <span class="main">↓=</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eval r_enumdom <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">↓</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">≥</span><span class="skolem">t</span><span class="main">.</span> the <span class="main">(</span>eval r_result1 <span class="main">[</span><span class="bound">t'</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms r_result1_converg' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?z</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"prod_encode <span class="main">(</span><span class="free">x<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> max <span class="skolem">t</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≤</span> <span class="var">?z</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> le_prod_encode_2 max.bounded_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pdec2 <span class="var">?z</span> <span class="main">≥</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>eval r_result1 <span class="main">[</span>pdec2 <span class="var">?z</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> pdec1 <span class="var">?z</span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">≤</span> <span class="var">?z</span>›</span></span> r_dovedelay <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_dovedelay <span class="main">[</span><span class="var">?z</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eval r_enumdom <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> r_enumdom <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">↓</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> eval r_enumdom <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="bound">y</span><span class="main">]</span> <span class="main">↓=</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> eval r_enumdom <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="bound">y</span><span class="main">]</span> <span class="main">↓=</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">↓</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> that <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>eval r_result1 <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> r_result1_converg' assms
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Zero_not_Suc dual_order.refl option.sel zero_less_iff_neq_zero<span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"prod_encode <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_dovedelay <span class="main">[</span><span class="var">?y</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="var">?y</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> r_dovedelay t <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">z</span><span class="main">.</span> eval r_dovedelay <span class="main">[</span><span class="bound">z</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="var">?y</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="var">?y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gr_implies_not_zero r_dovedelay <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Least_equality<span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_enumdom <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="var">?y</span><span class="main">]</span> <span class="main">↓=</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> r_enumdom <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">↓</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> eval r_enumdom <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="bound">y</span><span class="main">]</span> <span class="main">↓=</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> that <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_enumdom <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">↓=</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_enumdom <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">z</span><span class="main">.</span> eval r_dovedelay <span class="main">[</span><span class="bound">z</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        *<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_enumdom <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">↓=</span> pdec1 <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">z</span><span class="main">.</span> eval r_dovedelay <span class="main">[</span><span class="bound">z</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
          <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">↓=</span> pdec1 <span class="var">?z</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> r_enumdom <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_dovedelay <span class="main">[</span><span class="var">?z</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> wellorder_Least_lemma<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>eval r_result1 <span class="main">[</span>pdec2 <span class="var">?z</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> pdec1 <span class="var">?z</span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>the <span class="main">(</span>eval r_result1 <span class="main">[</span>pdec2 <span class="var">?z</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> pdec1 <span class="var">?z</span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">using</span></span> r_dovedelay z <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span><span class="free">i</span><span class="main">,</span> pdec1 <span class="var">?z</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> r_result1_diverg' assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> y * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For every $\varphi_i$ with non-empty domain there is a total
recursive function that enumerates the domain of $\varphi_i$.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nonempty_domain_enumerable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span><span class="main">]</span> <span class="main">↓</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">g</span><span class="main">.</span> recfn <span class="main">1</span> <span class="bound">g</span> <span class="main">∧</span> total <span class="bound">g</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> eval r_phi <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">↓</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> eval <span class="bound">g</span> <span class="main">[</span><span class="bound">y</span><span class="main">]</span> <span class="main">↓=</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">≡</span> Cn <span class="main">1</span> r_enumdom <span class="main">[</span>r_const <span class="free">i</span><span class="main">,</span> Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"total <span class="skolem">g</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> totalI1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">g</span></span><span class="main">]</span> g_def assms r_enumdom_nonempty_domain<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">↓</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> eval <span class="skolem">g</span> <span class="main">[</span><span class="bound">y</span><span class="main">]</span> <span class="main">↓=</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">unfolding</span></span> g_def <span class="keyword1"><span class="command">using</span></span> r_enumdom_nonempty_domain<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Concurrent evaluation of functions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define a function that simulates two <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">recf</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>s
``concurrently'' for the same argument and returns the result of the one
converging first. If both diverge, so does the simulation function.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_both</span> <span class="main">≡</span>
  Cn <span class="numeral">4</span> r_ifz
   <span class="main">[</span>Cn <span class="numeral">4</span> r_result1 <span class="main">[</span>Id <span class="numeral">4</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">4</span> <span class="main">1</span><span class="main">,</span> Id <span class="numeral">4</span> <span class="numeral">3</span><span class="main">]</span><span class="main">,</span>
    Cn <span class="numeral">4</span> r_ifz
     <span class="main">[</span>Cn <span class="numeral">4</span> r_result1 <span class="main">[</span>Id <span class="numeral">4</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">4</span> <span class="numeral">2</span><span class="main">,</span> Id <span class="numeral">4</span> <span class="numeral">3</span><span class="main">]</span><span class="main">,</span>
      Cn <span class="numeral">4</span> r_prod_encode <span class="main">[</span>r_constn <span class="numeral">3</span> <span class="numeral">2</span><span class="main">,</span> r_constn <span class="numeral">3</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span>
      Cn <span class="numeral">4</span> r_prod_encode
       <span class="main">[</span>r_constn <span class="numeral">3</span> <span class="main">1</span><span class="main">,</span> Cn <span class="numeral">4</span> r_dec <span class="main">[</span>Cn <span class="numeral">4</span> r_result1 <span class="main">[</span>Id <span class="numeral">4</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">4</span> <span class="numeral">2</span><span class="main">,</span> Id <span class="numeral">4</span> <span class="numeral">3</span><span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">,</span>
    Cn <span class="numeral">4</span> r_prod_encode
     <span class="main">[</span>r_constn <span class="numeral">3</span> <span class="main">0</span><span class="main">,</span> Cn <span class="numeral">4</span> r_dec <span class="main">[</span>Cn <span class="numeral">4</span> r_result1 <span class="main">[</span>Id <span class="numeral">4</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">4</span> <span class="main">1</span><span class="main">,</span> Id <span class="numeral">4</span> <span class="numeral">3</span><span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_both_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="numeral">4</span> r_both"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_both_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_both<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> eval r_phi <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> eval <span class="free">f</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> eval r_phi <span class="main">[</span><span class="free">j</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> eval <span class="free">g</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval <span class="free">f</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">↑</span> <span class="main">∧</span> eval <span class="free">g</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">↑</span> <span class="main">⟹</span> eval r_both <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>eval r_result1 <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">;</span> eval r_result1 <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">⟧</span> <span class="main">⟹</span>
      eval r_both <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eval r_result1 <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="free">v</span> <span class="main">⟹</span>
      eval r_both <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="main">0</span><span class="main">,</span> the <span class="main">(</span>eval <span class="free">f</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>eval r_result1 <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">;</span> eval r_result1 <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="free">v</span><span class="main">⟧</span> <span class="main">⟹</span>
      eval r_both <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="main">1</span><span class="main">,</span> the <span class="main">(</span>eval <span class="free">g</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> r_result_total <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_result <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">k</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">↓</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span> <span class="skolem">k</span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> r_result_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"eval <span class="free">f</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">↑</span> <span class="main">∧</span> eval <span class="free">g</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">↑</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_result1 <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eval r_result1 <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms r_result1_diverg' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eval r_both <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> r_both_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"eval r_result1 <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eval r_result1 <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eval r_both <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> r_both_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"eval r_result1 <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_result1 <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="main">(</span>the <span class="main">(</span>eval <span class="free">f</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms r_result1_Some' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eval r_both <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="main">0</span><span class="main">,</span> the <span class="main">(</span>eval <span class="free">f</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> r_both_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"eval r_result1 <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eval r_result1 <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_result1 <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="main">(</span>the <span class="main">(</span>eval <span class="free">g</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms r_result1_Some' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eval r_both <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="main">1</span><span class="main">,</span> the <span class="main">(</span>eval <span class="free">g</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> r_both_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_parallel</span> <span class="main">≡</span>
  Cn <span class="numeral">3</span> r_both <span class="main">[</span>Mn <span class="numeral">3</span> <span class="main">(</span>Cn <span class="numeral">4</span> r_le <span class="main">[</span>Cn <span class="numeral">4</span> r_pdec1 <span class="main">[</span>r_both<span class="main">]</span><span class="main">,</span> r_constn <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">1</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_parallel_recfn <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">3</span> r_parallel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_parallel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_parallel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> eval r_phi <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> eval <span class="free">f</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> eval r_phi <span class="main">[</span><span class="free">j</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> eval <span class="free">g</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval <span class="free">f</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">↑</span> <span class="main">∧</span> eval <span class="free">g</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">↑</span> <span class="main">⟹</span> eval r_parallel <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↑</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eval <span class="free">f</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">↓</span> <span class="main">∧</span> eval <span class="free">g</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">↑</span> <span class="main">⟹</span>
      eval r_parallel <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="main">0</span><span class="main">,</span> the <span class="main">(</span>eval <span class="free">f</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eval <span class="free">g</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">↓</span> <span class="main">∧</span> eval <span class="free">f</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">↑</span> <span class="main">⟹</span>
      eval r_parallel <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="main">1</span><span class="main">,</span> the <span class="main">(</span>eval <span class="free">g</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eval <span class="free">f</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">↓</span> <span class="main">∧</span> eval <span class="free">g</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">↓</span> <span class="main">⟹</span>
      eval r_parallel <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="main">0</span><span class="main">,</span> the <span class="main">(</span>eval <span class="free">f</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
      eval r_parallel <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="main">1</span><span class="main">,</span> the <span class="main">(</span>eval <span class="free">g</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cond</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="numeral">4</span> r_le <span class="main">[</span>Cn <span class="numeral">4</span> r_pdec1 <span class="main">[</span>r_both<span class="main">]</span><span class="main">,</span> r_constn <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> Mn <span class="numeral">3</span> <span class="var">?cond</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"r_parallel <span class="main">=</span> Cn <span class="numeral">3</span> r_both <span class="main">[</span><span class="skolem">m</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">1</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> r_parallel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> m_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">3</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"eval <span class="free">f</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">↑</span> <span class="main">∧</span> eval <span class="free">g</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">↑</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> eval r_both <span class="main">[</span><span class="bound">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms r_both <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?cond</span> <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">m</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↑</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> m_def <span class="keyword1"><span class="command">using</span></span> eval_Mn_diverg <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Cn <span class="numeral">3</span> r_both <span class="main">[</span><span class="skolem">m</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">1</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↑</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">3</span> <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eval r_parallel <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↑</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"eval <span class="free">f</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">↓</span> <span class="main">∧</span> eval <span class="free">g</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">vf</span></span> <span class="skolem"><span class="skolem">vg</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="free">f</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="skolem">vf</span>"</span></span> <span class="quoted"><span class="quoted">"eval <span class="free">g</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="skolem">vg</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tf</span></span> <span class="keyword2"><span class="keyword">where</span></span> tf<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t</span></span><span class="main">≥</span><span class="skolem">tf</span><span class="main">.</span> eval r_result1 <span class="main">[</span><span class="bound">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="skolem">vf</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t</span></span><span class="main">&lt;</span><span class="skolem">tf</span><span class="main">.</span> eval r_result1 <span class="main">[</span><span class="bound">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> r_result1_converg' assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">from</span></span> v <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tg</span></span> <span class="keyword2"><span class="keyword">where</span></span> tg<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t</span></span><span class="main">≥</span><span class="skolem">tg</span><span class="main">.</span> eval r_result1 <span class="main">[</span><span class="bound">t</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="skolem">vg</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t</span></span><span class="main">&lt;</span><span class="skolem">tg</span><span class="main">.</span> eval r_result1 <span class="main">[</span><span class="bound">t</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> r_result1_converg' assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eval r_parallel <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="main">0</span><span class="main">,</span> the <span class="main">(</span>eval <span class="free">f</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
      eval r_parallel <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="main">1</span><span class="main">,</span> the <span class="main">(</span>eval <span class="free">g</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">tf</span> <span class="main">≤</span> <span class="skolem">tg</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> tg<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> j0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t</span></span><span class="main">&lt;</span><span class="skolem">tf</span><span class="main">.</span> eval r_result1 <span class="main">[</span><span class="bound">t</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_both <span class="main">[</span><span class="skolem">tf</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="main">0</span><span class="main">,</span> the <span class="main">(</span>eval <span class="free">f</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> r_both<span class="main">(</span>3<span class="main">)</span> assms tf<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">m</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="skolem">tf</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> m_def
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> eval_Mn_convergI<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>length <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>Mn <span class="numeral">3</span> <span class="var">?cond</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Cn <span class="numeral">4</span> r_pdec1 <span class="main">[</span>r_both<span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="skolem">tf</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?cond</span> <span class="main">[</span><span class="skolem">tf</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_both <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">&lt;</span> <span class="skolem">tf</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
          <span class="keyword1"><span class="command">using</span></span> tf<span class="main">(</span>2<span class="main">)</span> r_both<span class="main">(</span>2<span class="main">)</span> assms that j0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?cond</span> <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">&lt;</span> <span class="skolem">tf</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
          <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="skolem">tf</span> <span class="main">⟹</span> eval <span class="var">?cond</span> <span class="main">[</span><span class="bound">y</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_parallel <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span>
          eval <span class="main">(</span>Cn <span class="numeral">3</span> r_both <span class="main">[</span><span class="skolem">m</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">1</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_parallel <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span> eval r_both <span class="main">[</span><span class="skolem">tf</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">3</span> <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_parallel <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="main">0</span><span class="main">,</span> the <span class="main">(</span>eval <span class="free">f</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> tf<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> i0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t</span></span><span class="main">≤</span><span class="skolem">tg</span><span class="main">.</span> eval r_result1 <span class="main">[</span><span class="bound">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_both <span class="main">[</span><span class="skolem">tg</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="main">1</span><span class="main">,</span> the <span class="main">(</span>eval <span class="free">g</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms r_both<span class="main">(</span>4<span class="main">)</span> tg<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">m</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="skolem">tg</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> m_def
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> eval_Mn_convergI<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>length <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>Mn <span class="numeral">3</span> <span class="var">?cond</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Cn <span class="numeral">4</span> r_pdec1 <span class="main">[</span>r_both<span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="skolem">tg</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?cond</span> <span class="main">[</span><span class="skolem">tg</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_both <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">&lt;</span> <span class="skolem">tg</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
          <span class="keyword1"><span class="command">using</span></span> tg<span class="main">(</span>2<span class="main">)</span> r_both<span class="main">(</span>2<span class="main">)</span> assms that i0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?cond</span> <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">&lt;</span> <span class="skolem">tg</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
          <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="skolem">tg</span> <span class="main">⟹</span> eval <span class="var">?cond</span> <span class="main">[</span><span class="bound">y</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_parallel <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span>
          eval <span class="main">(</span>Cn <span class="numeral">3</span> r_both <span class="main">[</span><span class="skolem">m</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">1</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_parallel <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span> eval r_both <span class="main">[</span><span class="skolem">tg</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">3</span> <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_parallel <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="main">1</span><span class="main">,</span> the <span class="main">(</span>eval <span class="free">g</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> eval_fg<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="free">g</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">↓</span> <span class="main">∧</span> eval <span class="free">f</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">↑</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> i0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> eval r_result1 <span class="main">[</span><span class="bound">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> r_result1_diverg' assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> eval_fg <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"eval <span class="free">g</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> t0<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t</span></span><span class="main">≥</span><span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> eval r_result1 <span class="main">[</span><span class="bound">t</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="skolem">v</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t</span></span><span class="main">&lt;</span><span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> eval r_result1 <span class="main">[</span><span class="bound">t</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> r_result1_converg' assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_both <span class="main">[</span><span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="main">1</span><span class="main">,</span> the <span class="main">(</span>eval <span class="free">g</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> r_both<span class="main">(</span>4<span class="main">)</span> assms i0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">m</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> m_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> eval_Mn_convergI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>length <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>Mn <span class="numeral">3</span> <span class="var">?cond</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Cn <span class="numeral">4</span> r_pdec1 <span class="main">[</span>r_both<span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?cond</span> <span class="main">[</span><span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_both <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">&lt;</span> <span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
        <span class="keyword1"><span class="command">using</span></span> t0<span class="main">(</span>2<span class="main">)</span> r_both<span class="main">(</span>2<span class="main">)</span> assms that i0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?cond</span> <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">&lt;</span> <span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
        <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟹</span> eval <span class="var">?cond</span> <span class="main">[</span><span class="bound">y</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_parallel <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span>
        eval <span class="main">(</span>Cn <span class="numeral">3</span> r_both <span class="main">[</span><span class="skolem">m</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">1</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_parallel <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span> eval r_both <span class="main">[</span><span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">3</span> <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eval r_parallel <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="main">1</span><span class="main">,</span> the <span class="main">(</span>eval <span class="free">g</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> eval_fg<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="free">f</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">↓</span> <span class="main">∧</span> eval <span class="free">g</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">↑</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> eval r_result1 <span class="main">[</span><span class="bound">t</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> r_result1_diverg' assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> eval_fg <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"eval <span class="free">f</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> t0<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t</span></span><span class="main">≥</span><span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> eval r_result1 <span class="main">[</span><span class="bound">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="skolem">v</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t</span></span><span class="main">&lt;</span><span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> eval r_result1 <span class="main">[</span><span class="bound">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> r_result1_converg' assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_both <span class="main">[</span><span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="main">0</span><span class="main">,</span> the <span class="main">(</span>eval <span class="free">f</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> r_both<span class="main">(</span>3<span class="main">)</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">m</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> m_def
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> eval_Mn_convergI<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>length <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>Mn <span class="numeral">3</span> <span class="var">?cond</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Cn <span class="numeral">4</span> r_pdec1 <span class="main">[</span>r_both<span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?cond</span> <span class="main">[</span><span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_both <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">&lt;</span> <span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
        <span class="keyword1"><span class="command">using</span></span> t0<span class="main">(</span>2<span class="main">)</span> r_both<span class="main">(</span>2<span class="main">)</span> assms that j0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?cond</span> <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">&lt;</span> <span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
        <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟹</span> eval <span class="var">?cond</span> <span class="main">[</span><span class="bound">y</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_parallel <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span>
        eval <span class="main">(</span>Cn <span class="numeral">3</span> r_both <span class="main">[</span><span class="skolem">m</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">1</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_parallel <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span> eval r_both <span class="main">[</span><span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">3</span> <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eval r_parallel <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="main">0</span><span class="main">,</span> the <span class="main">(</span>eval <span class="free">f</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Standard_Results">
<div class="head">
<h1>Theory Standard_Results</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Standard_Results
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Universal.html">Universal</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Kleene normal form and the number of $\mu$-operations›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Kleene's original normal form theorem~\cite{Kleene43} states that
every partial recursive $f$ can be expressed as $f(x) = u(\mu y[t(i, x, y) =
0]$ for some $i$, where $u$ and $t$ are specially crafted primitive recursive
functions tied to Kleene's definition of partial recursive functions.
Rogers~\cite[p.~29f.]{Rogers87} relaxes the theorem by allowing $u$ and $t$
to be any primitive recursive functions of arity one and three, respectively.
Both versions require a separate $t$-predicate for every arity. We will show
a unified version for all arities by treating $x$ as an encoded list of
arguments.

Our universal function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[display,names_short] "r_univ_def"<span class="antiquote"><span class="antiquote">}</span></span></span></span> can represent
all partial recursive functions (see theorem <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] r_univ<span class="antiquote"><span class="antiquote">}</span></span></span></span>). Moreover
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"r_result"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"r_dec"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"r_not"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are primitive
recursive. As such <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">r_univ</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> could almost serve as the right-hand side
$u(\mu y[t(i, x, y) = 0]$. Its only flaw is that the outer function, the
composition of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">r_dec</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">r_result</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, is ternary rather than
unary.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_univ_almost_kleene_nf<span class="main">:</span>
  <span class="quoted"><span class="quoted">"r_univ <span class="main">≃</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="bound">u</span> <span class="main">=</span> Cn <span class="numeral">3</span> r_dec <span class="main">[</span>r_result<span class="main">]</span><span class="main">;</span>
        <span class="bound">t</span> <span class="main">=</span> Cn <span class="numeral">3</span> r_not <span class="main">[</span>r_result<span class="main">]</span>
    <span class="keyword1">in</span> Cn <span class="numeral">2</span> <span class="bound">u</span> <span class="main">[</span>Mn <span class="numeral">2</span> <span class="bound">t</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_univ_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> exteqI<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We can remedy the wrong arity with some encoding and
projecting.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">r_nf_t</span> <span class="main">::</span> <span class="quoted">recf</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">r_nf_t</span> <span class="main">≡</span> Cn <span class="numeral">3</span> r_and
    <span class="main">[</span>Cn <span class="numeral">3</span> r_eq <span class="main">[</span>Cn <span class="numeral">3</span> r_pdec2 <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span> Cn <span class="numeral">3</span> r_prod_encode <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">1</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">]</span><span class="main">]</span><span class="main">,</span>
     Cn <span class="numeral">3</span> r_not
      <span class="main">[</span>Cn <span class="numeral">3</span> r_result
        <span class="main">[</span>Cn <span class="numeral">3</span> r_pdec1 <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span>
         Cn <span class="numeral">3</span> r_pdec12 <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span>
         Cn <span class="numeral">3</span> r_pdec22 <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">0</span><span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_nf_t_prim<span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="numeral">3</span> r_nf_t"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_nf_t_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">r_nf_u</span> <span class="main">::</span> <span class="quoted">recf</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">r_nf_u</span> <span class="main">≡</span> Cn <span class="main">1</span> r_dec <span class="main">[</span>Cn <span class="main">1</span> r_result <span class="main">[</span>r_pdec1<span class="main">,</span> r_pdec12<span class="main">,</span> r_pdec22<span class="main">]</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_nf_u_prim<span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> r_nf_u"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_nf_u_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_nf_t_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eval r_result <span class="main">[</span>pdec1 <span class="free">y</span><span class="main">,</span> pdec12 <span class="free">y</span><span class="main">,</span> pdec22 <span class="free">y</span><span class="main">]</span> <span class="main">↓≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"pdec2 <span class="free">y</span> <span class="main">=</span> prod_encode <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval r_nf_t <span class="main">[</span><span class="free">y</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_nf_t_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> r_nf_t_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eval r_result <span class="main">[</span>pdec1 <span class="free">y</span><span class="main">,</span> pdec12 <span class="free">y</span><span class="main">,</span> pdec22 <span class="free">y</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span> <span class="main">∨</span> pdec2 <span class="free">y</span> <span class="main">≠</span> prod_encode <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval r_nf_t <span class="main">[</span><span class="free">y</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_nf_t_def <span class="keyword1"><span class="command">using</span></span> assms r_result_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next function is just as universal as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">r_univ</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, but
satisfies the conditions of the Kleene normal form theorem because the
outer funtion <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">r_nf_u</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is unary.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_normal_form</span> <span class="main">≡</span> Cn <span class="numeral">2</span> r_nf_u <span class="main">[</span>Mn <span class="numeral">2</span> r_nf_t<span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_normal_form_recfn<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> r_normal_form"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_normal_form_def <span class="keyword1"><span class="command">using</span></span> r_nf_u_prim r_nf_t_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_univ_exteq_r_normal_form<span class="main">:</span> <span class="quoted"><span class="quoted">"r_univ <span class="main">≃</span> r_normal_form"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> exteqI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> arity<span class="main">:</span> <span class="quoted"><span class="quoted">"arity r_univ <span class="main">=</span> arity r_normal_form"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_normal_form_recfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eval r_univ <span class="skolem">xs</span> <span class="main">=</span> eval r_normal_form <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> arity r_univ"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">xs</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> ix<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Suc_length_conv length_0_conv numeral_2_eq_2<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_univ <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> eval r_normal_form <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> eval r_result <span class="main">[</span><span class="bound">t</span><span class="main">,</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_univ <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">↑</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> r_univ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_normal_form <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">↑</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_nf_t <span class="main">[</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
          <span class="keyword1"><span class="command">using</span></span> True r_nf_t_1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> r_normal_form_def <span class="keyword1"><span class="command">using</span></span> r_nf_u_prim r_nf_t_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span> eval r_result <span class="main">[</span><span class="bound">t</span><span class="main">,</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">↓≠</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_result_total<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"eval r_result <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">↓≠</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_nf_t <span class="main">[</span>triple_encode <span class="skolem">t</span> <span class="skolem">i</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> r_nf_t_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Mn <span class="numeral">2</span> r_nf_t<span class="main">)</span> <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> r_nf_t_prim Mn_free_imp_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_nf_t <span class="main">[</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> r_nf_t_prim Mn_free_imp_total eval_Mn_convergE<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted">r_nf_t</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> r_result<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_result <span class="main">[</span>pdec1 <span class="skolem">y</span><span class="main">,</span> pdec12 <span class="skolem">y</span><span class="main">,</span> pdec22 <span class="skolem">y</span><span class="main">]</span> <span class="main">↓≠</span> <span class="main">0</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> pdec2<span class="main">:</span> <span class="quoted"><span class="quoted">"pdec2 <span class="skolem">y</span> <span class="main">=</span> prod_encode <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> r_nf_t_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> r_nf_t_1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> r_result_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_result <span class="main">[</span>pdec1 <span class="skolem">y</span><span class="main">,</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">↓≠</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span>
          <span class="quoted"><span class="quoted">"eval r_univ <span class="main">[</span>pdec12 <span class="skolem">y</span><span class="main">,</span> pdec22 <span class="skolem">y</span><span class="main">]</span> <span class="main">↓=</span> <span class="skolem">v</span>"</span></span>
          <span class="quoted"><span class="quoted">"eval r_result <span class="main">[</span>pdec1 <span class="skolem">y</span><span class="main">,</span> pdec12 <span class="skolem">y</span><span class="main">,</span> pdec22 <span class="skolem">y</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> r_result r_result_bivalent'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"pdec12 <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"pdec22 <span class="skolem">y</span>"</span></span> <span class="main">_</span> <span class="quoted"><span class="quoted">"pdec1 <span class="skolem">y</span>"</span></span><span class="main">]</span>
          r_result_diverg'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"pdec12 <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"pdec22 <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"pdec1 <span class="skolem">y</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_normal_form <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> eval r_nf_u <span class="main">[</span><span class="skolem">y</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> r_normal_form_def <span class="keyword1"><span class="command">using</span></span> y r_nf_t_prim r_nf_u_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> eval r_dec <span class="main">[</span>the <span class="main">(</span>eval <span class="main">(</span>Cn <span class="main">1</span> r_result <span class="main">[</span>r_pdec1<span class="main">,</span> r_pdec12<span class="main">,</span> r_pdec22<span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> r_nf_u_def <span class="keyword1"><span class="command">using</span></span> r_result <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> eval r_dec <span class="main">[</span>Suc <span class="skolem">v</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> v <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">↓=</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_normal_form <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_univ <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="skolem">v</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> v<span class="main">(</span>1<span class="main">)</span> pdec2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> ix <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> normal_form<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="free">n</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">i</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> e_length <span class="bound">x</span> <span class="main">=</span> <span class="free">n</span> <span class="main">⟶</span> eval r_normal_form <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> eval <span class="free">f</span> <span class="main">(</span>list_decode <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_normal_form <span class="main">[</span>encode <span class="free">f</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> eval <span class="free">f</span> <span class="main">(</span>list_decode <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"e_length <span class="skolem">x</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> r_univ_exteq_r_normal_form assms that exteq_def r_univ' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹As a consequence of the normal form theorem every partial
recursive function can be represented with exactly one application of the
$\mu$-operator.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">count_Mn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"recf <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">count_Mn</span> Z <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">count_Mn</span> S <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">count_Mn</span> <span class="main">(</span>Id <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">count_Mn</span> <span class="main">(</span>Cn <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">gs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">count_Mn</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">+</span> sum_list <span class="main">(</span>map <span class="free">count_Mn</span> <span class="free"><span class="bound"><span class="entity">gs</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">count_Mn</span> <span class="main">(</span>Pr <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">count_Mn</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">+</span> <span class="free">count_Mn</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">count_Mn</span> <span class="main">(</span>Mn <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">count_Mn</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> count_Mn_zero_iff_prim<span class="main">:</span> <span class="quoted"><span class="quoted">"count_Mn <span class="free">f</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> Mn_free <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The normal form has only one $\mu$-recursion.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> count_Mn_normal_form<span class="main">:</span> <span class="quoted"><span class="quoted">"count_Mn r_normal_form <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_normal_form_def r_nf_u_def r_nf_t_def <span class="keyword1"><span class="command">using</span></span> count_Mn_zero_iff_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> one_Mn_suffices<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="free">n</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">g</span><span class="main">.</span> count_Mn <span class="bound">g</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> <span class="bound">g</span> <span class="main">≃</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms wellf_arity_nonzero <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> e_length <span class="bound">x</span> <span class="main">=</span> <span class="free">n</span> <span class="main">⟶</span> eval r_normal_form <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> eval <span class="free">f</span> <span class="main">(</span>list_decode <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> normal_form<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">≡</span> Cn <span class="free">n</span> r_normal_form <span class="main">[</span>r_constn <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">i</span><span class="main">,</span> r_list_encode <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="free">n</span> <span class="skolem">g</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_normal_form_recfn <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">≃</span> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> g_def r_list_encode i assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exteqI<span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count_Mn <span class="skolem">g</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> g_def <span class="keyword1"><span class="command">using</span></span> count_Mn_normal_form count_Mn_zero_iff_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The previous lemma could have been obtained without <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"r_normal_form"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> directly from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"r_univ"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The $s$-$m$-$n$ theorem›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For all $m, n &gt; 0$ there is an $(m + 1)$-ary primitive recursive
function $s^m_n$ with
\[
  \varphi_p^{(m + n)}(c_1, \dots,c_m, x_1, \dots, x_n) =
  \varphi_{s^m_n(p, c_1, \dots,c_m)}^{(n)}(x_1, \dots, x_n)
\]
for all $p, c_1, \ldots, c_m, x_1, \ldots, x_n$. Here, $\varphi^{(n)}$ is a
function universal for $n$-ary partial recursive functions, which we will
represent by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"r_universal <span class="free"><span class="free">n</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The $s^m_n$ functions compute codes of functions. We start simple:
computing codes of the unary constant functions.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">code_const1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">code_const1</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">code_const1</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">=</span> quad_encode <span class="numeral">3</span> <span class="main">1</span> <span class="main">1</span> <span class="main">(</span>singleton_encode <span class="main">(</span><span class="free">code_const1</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> code_const1<span class="main">:</span> <span class="quoted"><span class="quoted">"code_const1 <span class="free">c</span> <span class="main">=</span> encode <span class="main">(</span>r_const <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_code_const1_aux</span> <span class="main">≡</span>
  Cn <span class="numeral">3</span> r_prod_encode
    <span class="main">[</span>r_constn <span class="numeral">2</span> <span class="numeral">3</span><span class="main">,</span>
      Cn <span class="numeral">3</span> r_prod_encode
        <span class="main">[</span>r_constn <span class="numeral">2</span> <span class="main">1</span><span class="main">,</span>
          Cn <span class="numeral">3</span> r_prod_encode
            <span class="main">[</span>r_constn <span class="numeral">2</span> <span class="main">1</span><span class="main">,</span> Cn <span class="numeral">3</span> r_singleton_encode <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_code_const1_aux_prim<span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="numeral">3</span> r_code_const1_aux"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_code_const1_aux_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> r_code_const1_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"eval r_code_const1_aux <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">r</span><span class="main">,</span> <span class="free">c</span><span class="main">]</span> <span class="main">↓=</span> quad_encode <span class="numeral">3</span> <span class="main">1</span> <span class="main">1</span> <span class="main">(</span>singleton_encode <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_code_const1_aux_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_code_const1</span> <span class="main">≡</span> r_shrink <span class="main">(</span>Pr <span class="main">1</span> Z r_code_const1_aux<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_code_const1_prim<span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> r_code_const1"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_code_const1_def r_code_const1_aux_prim<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> r_code_const1<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_code_const1 <span class="main">[</span><span class="free">c</span><span class="main">]</span> <span class="main">↓=</span> code_const1 <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Pr <span class="main">1</span> Z r_code_const1_aux"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?h</span> <span class="main">[</span><span class="free">c</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">↓=</span> code_const1 <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> r_code_const1_aux r_code_const1_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_code_const1_aux_prim<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_code_const1_def r_code_const1_aux_prim<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Functions that compute codes of higher-arity constant functions:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">code_constn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">code_constn</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">≡</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> code_const1 <span class="free"><span class="bound"><span class="entity">c</span></span></span>
    <span class="keyword1">else</span> quad_encode <span class="numeral">3</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>code_const1 <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span> <span class="main">(</span>singleton_encode <span class="main">(</span>triple_encode <span class="numeral">2</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> code_constn<span class="main">:</span> <span class="quoted"><span class="quoted">"code_constn <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">c</span> <span class="main">=</span> encode <span class="main">(</span>r_constn <span class="free">n</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> code_constn_def <span class="keyword1"><span class="command">using</span></span> code_const1 r_constn_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">r_code_constn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> recf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">r_code_constn</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span>
     <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> r_code_const1
     <span class="keyword1">else</span>
       Cn <span class="main">1</span> r_prod_encode
        <span class="main">[</span>r_const <span class="numeral">3</span><span class="main">,</span>
         Cn <span class="main">1</span> r_prod_encode
          <span class="main">[</span>r_const <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span>
           Cn <span class="main">1</span> r_prod_encode
            <span class="main">[</span>r_code_const1<span class="main">,</span>
             Cn <span class="main">1</span> r_singleton_encode
              <span class="main">[</span>Cn <span class="main">1</span> r_prod_encode
                <span class="main">[</span>r_const <span class="numeral">2</span><span class="main">,</span> Cn <span class="main">1</span> r_prod_encode <span class="main">[</span>r_const <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> Z<span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_code_constn_prim<span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> <span class="main">(</span>r_code_constn <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_code_constn_def r_code_const1_prim<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> r_code_constn<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_code_constn <span class="free">n</span><span class="main">)</span> <span class="main">[</span><span class="free">c</span><span class="main">]</span> <span class="main">↓=</span> code_constn <span class="free">n</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_code_constn_def r_code_const1 code_constn_def r_code_const1_prim<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Computing codes of $m$-ary projections:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">code_id</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">code_id</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> triple_encode <span class="numeral">2</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> code_id<span class="main">:</span> <span class="quoted"><span class="quoted">"encode <span class="main">(</span>Id <span class="free">m</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> code_id <span class="free">m</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> code_id_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The functions $s^m_n$ are represented by the following function.
The value $m$ corresponds to the length of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">cs</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">smn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">smn</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">≡</span> quad_encode
     <span class="numeral">3</span>
     <span class="free"><span class="bound"><span class="entity">n</span></span></span>
     <span class="main">(</span>encode <span class="main">(</span>r_universal <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> length <span class="free"><span class="bound"><span class="entity">cs</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>list_encode <span class="main">(</span>code_constn <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">#</span> map <span class="main">(</span>code_constn <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">cs</span></span></span> <span class="main">@</span> map <span class="main">(</span>code_id <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> smn<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"smn <span class="free">n</span> <span class="free">p</span> <span class="free">cs</span> <span class="main">=</span> encode
   <span class="main">(</span>Cn <span class="free">n</span>
     <span class="main">(</span>r_universal <span class="main">(</span><span class="free">n</span> <span class="main">+</span> length <span class="free">cs</span><span class="main">)</span><span class="main">)</span>
     <span class="main">(</span>r_constn <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">p</span> <span class="main">#</span> map <span class="main">(</span>r_constn <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cs</span> <span class="main">@</span> <span class="main">(</span>map <span class="main">(</span>Id <span class="free">n</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"r_constn <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?gs1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>r_constn <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?gs2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>Id <span class="free">n</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?gs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?p</span> <span class="main">#</span> <span class="var">?gs1</span> <span class="main">@</span> <span class="var">?gs2</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map encode <span class="var">?gs1</span> <span class="main">=</span> map <span class="main">(</span>code_constn <span class="free">n</span><span class="main">)</span> <span class="free">cs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nth_equalityI<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">metis</span> code_constn assms Suc_pred<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map encode <span class="var">?gs2</span> <span class="main">=</span> map <span class="main">(</span>code_id <span class="free">n</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nth_equalityI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> code_id_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"encode <span class="var">?p</span> <span class="main">=</span> code_constn <span class="free">n</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms code_constn<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map encode <span class="var">?gs</span> <span class="main">=</span>
      code_constn <span class="free">n</span> <span class="free">p</span> <span class="main">#</span> map <span class="main">(</span>code_constn <span class="free">n</span><span class="main">)</span> <span class="free">cs</span> <span class="main">@</span> map <span class="main">(</span>code_id <span class="free">n</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> smn_def <span class="keyword1"><span class="command">using</span></span> assms encode.simps<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next function is to help us define <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">recf</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>s corresponding
to the $s^m_n$ functions. It maps $m + 1$ arguments $p, c_1, \ldots, c_m$ to
an encoded list of length $m + n + 1$. The list comprises the $m + 1$ codes
of the $n$-ary constants $p, c_1, \ldots, c_m$ and the $n$ codes for all
$n$-ary projections.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">r_smn_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> recf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">r_smn_aux</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span>
     Cn <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>
      <span class="main">(</span>r_list_encode <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> Cn <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">(</span>r_code_constn <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">[</span>Id <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="bound">i</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">]</span> <span class="main">@</span>
       map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> r_constn <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>code_id <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_smn_aux_prim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> prim_recfn <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span> <span class="main">(</span>r_smn_aux <span class="free">n</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_smn_aux_def r_code_constn_prim<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> r_smn_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">cs</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_smn_aux <span class="free">n</span> <span class="free">m</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span> <span class="main">↓=</span>
    list_encode <span class="main">(</span>map <span class="main">(</span>code_constn <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span> <span class="main">@</span> map <span class="main">(</span>code_id <span class="free">n</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> Cn <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span> <span class="main">(</span>r_code_constn <span class="free">n</span><span class="main">)</span> <span class="main">[</span>Id <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span> <span class="bound">i</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="free">m</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ys</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> r_constn <span class="free">m</span> <span class="main">(</span>code_id <span class="free">n</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> len_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="var">?xs</span> <span class="main">=</span> Suc <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> map_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> eval <span class="bound">g</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span> <span class="var">?xs</span> <span class="main">=</span> map Some <span class="main">(</span>map <span class="main">(</span>code_constn <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> nth_equalityI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> eval <span class="bound">g</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span> <span class="var">?xs</span><span class="main">)</span> <span class="main">=</span>
        length <span class="main">(</span>map Some <span class="main">(</span>map <span class="main">(</span>code_constn <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> eval <span class="bound">g</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span> <span class="var">?xs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> map Some <span class="main">(</span>map <span class="main">(</span>code_constn <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> Suc <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> eval <span class="bound">g</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span> <span class="var">?xs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> eval <span class="bound">g</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?xs</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> len_xs that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nth_map<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> eval <span class="main">(</span>Cn <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span> <span class="main">(</span>r_code_constn <span class="free">n</span><span class="main">)</span> <span class="main">[</span>Id <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span> <span class="skolem">i</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> that len_xs
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> add.left_neutral length_map nth_map nth_upt<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> eval <span class="main">(</span>r_code_constn <span class="free">n</span><span class="main">)</span> <span class="main">[</span>the <span class="main">(</span>eval <span class="main">(</span>Id <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> r_code_constn_prim assms<span class="main">(</span>2<span class="main">)</span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> eval <span class="main">(</span>r_code_constn <span class="free">n</span><span class="main">)</span> <span class="main">[</span><span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> len that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> eval <span class="bound">g</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span> <span class="var">?xs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">↓=</span> code_constn <span class="free">n</span> <span class="main">(</span><span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> r_code_constn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> len_xs len that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_map nth_map<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> eval <span class="bound">g</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span> <span class="var">?xs</span><span class="main">)</span> <span class="main">=</span> Suc <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> eval <span class="bound">g</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span> <span class="var">?xs</span><span class="main">)</span> <span class="main">⟹</span>
        map <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> eval <span class="bound">g</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span> <span class="var">?xs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span>
        map Some <span class="main">(</span>map <span class="main">(</span>code_constn <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> eval <span class="bound">g</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span> <span class="var">?ys</span> <span class="main">=</span> map Some <span class="main">(</span>map <span class="main">(</span>code_id <span class="free">n</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nth_equalityI<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> eval <span class="bound">g</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> <span class="var">?ys</span><span class="main">)</span> <span class="main">=</span>
      map Some <span class="main">(</span>map <span class="main">(</span>code_constn <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span> <span class="main">@</span> map <span class="main">(</span>code_id <span class="free">n</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> map_append<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> the <span class="main">(</span>eval <span class="bound">x</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> <span class="var">?ys</span><span class="main">)</span> <span class="main">=</span>
      map the <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> eval <span class="bound">x</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> <span class="var">?ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> the <span class="main">(</span>eval <span class="bound">g</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> <span class="var">?ys</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span>map <span class="main">(</span>code_constn <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span> <span class="main">@</span> map <span class="main">(</span>code_id <span class="free">n</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="var">?xs</span><span class="main">.</span> eval <span class="main">(</span><span class="var">?xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> eval <span class="bound">g</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span> <span class="var">?xs</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nth_map<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="var">?xs</span><span class="main">.</span> eval <span class="main">(</span><span class="var">?xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span> <span class="main">=</span> map Some <span class="main">(</span>map <span class="main">(</span>code_constn <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> map_xs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="var">?xs</span><span class="main">.</span> eval <span class="main">(</span><span class="var">?xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms map_xs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_map nth_map option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> xs_converg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span><span class="main">∈</span>set <span class="var">?xs</span><span class="main">.</span> eval <span class="bound">z</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_conv_nth<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="var">?ys</span><span class="main">.</span> eval <span class="main">(</span><span class="var">?ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> eval <span class="bound">x</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span> <span class="var">?ys</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="var">?ys</span><span class="main">.</span> eval <span class="main">(</span><span class="var">?ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span> <span class="main">=</span> map Some <span class="main">(</span>map <span class="main">(</span>code_id <span class="free">n</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="var">?ys</span><span class="main">.</span> eval <span class="main">(</span><span class="var">?ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span><span class="main">∈</span>set <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> <span class="var">?ys</span><span class="main">)</span><span class="main">.</span> eval <span class="bound">z</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> xs_converg <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">(</span>length <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Cn <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span> <span class="main">(</span>r_list_encode <span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> <span class="var">?ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms r_code_constn_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_smn_aux <span class="free">n</span> <span class="free">m</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span> <span class="main">=</span>
      eval <span class="main">(</span>r_list_encode <span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> the <span class="main">(</span>eval <span class="bound">g</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> <span class="var">?ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> r_smn_aux_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_smn_aux <span class="free">n</span> <span class="free">m</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span> <span class="main">=</span>
      eval <span class="main">(</span>r_list_encode <span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>code_constn <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span> <span class="main">@</span> map <span class="main">(</span>code_id <span class="free">n</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="var">?xs</span> <span class="main">@</span> <span class="var">?ys</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> r_list_encode * assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> length_map<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For all $m, n &gt; 0$, the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">recf</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> corresponding to $s^m_n$ is
given by the next function.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">r_smn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> recf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">r_smn</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span>
    Cn <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> r_prod_encode
     <span class="main">[</span>r_constn <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="numeral">3</span><span class="main">,</span>
      Cn <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> r_prod_encode
       <span class="main">[</span>r_constn <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span>
        Cn <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> r_prod_encode
          <span class="main">[</span>r_constn <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span>encode <span class="main">(</span>r_universal <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> r_smn_aux <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">]</span><span class="main">]</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_smn_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> prim_recfn <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span> <span class="main">(</span>r_smn <span class="free">n</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_smn_def r_smn_aux_prim<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> r_smn<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">cs</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_smn <span class="free">n</span> <span class="free">m</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span> <span class="main">↓=</span> smn <span class="free">n</span> <span class="free">p</span> <span class="free">cs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms r_smn_def r_smn_aux smn_def r_smn_aux_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> map_eval_Some_the<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> eval <span class="bound">g</span> <span class="free">xs</span><span class="main">)</span> <span class="free">gs</span> <span class="main">=</span> map Some <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> the <span class="main">(</span>eval <span class="bound">g</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="free">gs</span> <span class="main">=</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> length_map nth_equalityI nth_map option.sel<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The essential part of the $s$-$m$-$n$ theorem: For all $m, n &gt; 0$
the function $s^m_n$ satisfies
\[
  \varphi_p^{(m + n)}(c_1, \dots,c_m, x_1, \dots, x_n) =
  \varphi_{s^m_n(p, c_1, \dots,c_m)}^{(n)}(x_1, \dots, x_n)
\] for all $p, c_i, x_j$.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> smn_lemma<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> len_cs<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">cs</span> <span class="main">=</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> len_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_universal <span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span> <span class="main">@</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span>
    eval <span class="main">(</span>r_universal <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>the <span class="main">(</span>eval <span class="main">(</span>r_smn <span class="free">n</span> <span class="free">m</span><span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"r_smn <span class="free">n</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="free">n</span>
    <span class="main">(</span>r_universal <span class="main">(</span><span class="free">n</span> <span class="main">+</span> length <span class="free">cs</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>r_constn <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">p</span> <span class="main">#</span> map <span class="main">(</span>r_constn <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cs</span> <span class="main">@</span> <span class="main">(</span>map <span class="main">(</span>Id <span class="free">n</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?s</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span> <span class="main">↓=</span> smn <span class="free">n</span> <span class="free">p</span> <span class="free">cs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms r_smn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eval_s<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="var">?s</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span> <span class="main">↓=</span> encode <span class="var">?f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> smn<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="free">n</span> <span class="var">?f</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> len_cs assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_universal <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>encode <span class="var">?f</span><span class="main">)</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> eval <span class="var">?f</span> <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_universal<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="quoted"><span class="free">n</span></span><span class="main">,</span> <span class="operator">OF</span> _ len_xs<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?gs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"r_constn <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="free">p</span> <span class="main">#</span> map <span class="main">(</span>r_constn <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cs</span> <span class="main">@</span> map <span class="main">(</span>Id <span class="free">n</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">g</span><span class="main">∈</span>set <span class="var">?gs</span><span class="main">.</span> eval <span class="bound">g</span> <span class="free">xs</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> len_cs len_xs assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?f</span> <span class="free">xs</span> <span class="main">=</span>
      eval <span class="main">(</span>r_universal <span class="main">(</span><span class="free">n</span> <span class="main">+</span> length <span class="free">cs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> the <span class="main">(</span>eval <span class="bound">g</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="var">?gs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> len_cs len_xs assms <span class="quoted"><span class="quoted">‹recfn <span class="free">n</span> <span class="var">?f</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?f</span> <span class="free">xs</span> <span class="main">=</span> eval <span class="main">(</span>r_universal <span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> the <span class="main">(</span>eval <span class="bound">g</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="var">?gs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> len_cs add.commute<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_universal <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>the <span class="main">(</span>eval <span class="var">?s</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span>
      eval <span class="main">(</span>r_universal <span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> the <span class="main">(</span>eval <span class="bound">g</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="var">?gs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eval_s * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> the <span class="main">(</span>eval <span class="bound">g</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="var">?gs</span> <span class="main">=</span> <span class="free">p</span> <span class="main">#</span> <span class="free">cs</span> <span class="main">@</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> nth_equalityI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> the <span class="main">(</span>eval <span class="bound">g</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="var">?gs</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span> <span class="main">@</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> len_xs<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> the <span class="main">(</span>eval <span class="bound">g</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="var">?gs</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> len_cs<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> the <span class="main">(</span>eval <span class="bound">g</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="var">?gs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span> <span class="main">@</span> <span class="free">xs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> Suc <span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">&lt;</span> Suc <span class="free">m</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"Suc <span class="free">m</span> <span class="main">≤</span> <span class="skolem">i</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">&lt;</span> Suc <span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> not_le_imp_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> len_xs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 2
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?gs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span>map <span class="main">(</span>r_constn <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cs</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> len_cs
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_less_eq Suc_pred length_map
            less_numeral_extra<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> nth_Cons' nth_append<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> the <span class="main">(</span>eval <span class="bound">g</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="var">?gs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span>
            <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> the <span class="main">(</span>eval <span class="bound">g</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>map <span class="main">(</span>r_constn <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">cs</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> len <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_map nth_map that<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> the <span class="main">(</span>eval <span class="main">(</span><span class="main">(</span>r_constn <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">cs</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 2 len_cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">cs</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> r_constn len_xs assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span> <span class="main">@</span> <span class="free">xs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 2 len_cs
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_Suc_1 less_Suc_eq_0_disj less_numeral_extra<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> nth_Cons' nth_append<span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> 3
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?gs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span>map <span class="main">(</span>Id <span class="free">n</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> Suc <span class="free">m</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> len_cs 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> One_nat_def Suc_less_eq add_leE
            plus_1_eq_Suc diff_diff_left length_map not_le nth_append
            ordered_cancel_comm_monoid_diff_class.add_diff_inverse<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> the <span class="main">(</span>eval <span class="bound">g</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="var">?gs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span>
            <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> the <span class="main">(</span>eval <span class="bound">g</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>map <span class="main">(</span>Id <span class="free">n</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> Suc <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> len <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_map nth_map that<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> the <span class="main">(</span>eval <span class="main">(</span><span class="main">(</span>Id <span class="free">n</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> Suc <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 3 len_cs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">xs</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> Suc <span class="free">m</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> len_xs 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span> <span class="main">@</span> <span class="free">xs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> len_cs len_xs 3
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_Suc_1 diff_diff_left less_Suc_eq_0_disj not_le nth_Cons'
            nth_append plus_1_eq_Suc<span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> the <span class="main">(</span>eval <span class="bound">g</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="var">?gs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">cs</span> <span class="main">@</span> <span class="free">xs</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> the <span class="main">(</span>eval <span class="bound">g</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="var">?gs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> smn_theorem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="main">.</span> prim_recfn <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span> <span class="bound">s</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="bound">cs</span> <span class="bound">xs</span><span class="main">.</span> length <span class="bound">cs</span> <span class="main">=</span> <span class="free">m</span> <span class="main">∧</span> length <span class="bound">xs</span> <span class="main">=</span> <span class="free">n</span> <span class="main">⟶</span>
        eval <span class="main">(</span>r_universal <span class="main">(</span><span class="free">m</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">p</span> <span class="main">#</span> <span class="bound">cs</span> <span class="main">@</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">=</span>
        eval <span class="main">(</span>r_universal <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>the <span class="main">(</span>eval <span class="bound">s</span> <span class="main">(</span><span class="bound">p</span> <span class="main">#</span> <span class="bound">cs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> smn_lemma exI<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"r_smn <span class="free">n</span> <span class="free">m</span>"</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For every numbering, that is, binary partial recursive function,
$\psi$ there is a total recursive function $c$ that translates $\psi$-indices
into $\varphi$-indices.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> numbering_translation<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="free">psi</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">c</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="free">c</span>"</span></span>
    <span class="quoted"><span class="quoted">"total <span class="free">c</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="bound">x</span><span class="main">.</span> eval <span class="free">psi</span> <span class="main">[</span><span class="bound">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> eval r_phi <span class="main">[</span>the <span class="main">(</span>eval <span class="free">c</span> <span class="main">[</span><span class="bound">i</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"encode <span class="free">psi</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> Cn <span class="main">1</span> <span class="main">(</span>r_smn <span class="main">1</span> <span class="main">1</span><span class="main">)</span> <span class="main">[</span>r_const <span class="var">?p</span><span class="main">,</span> Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"total <span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span>the <span class="main">(</span>eval <span class="skolem">c</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> eval <span class="free">psi</span> <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">c</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span> <span class="main">=</span> eval <span class="main">(</span>r_smn <span class="main">1</span> <span class="main">1</span><span class="main">)</span> <span class="main">[</span><span class="var">?p</span><span class="main">,</span> <span class="skolem">i</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> c_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_universal <span class="main">1</span><span class="main">)</span> <span class="main">[</span>the <span class="main">(</span>eval <span class="skolem">c</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">=</span>
        eval <span class="main">(</span>r_universal <span class="main">1</span><span class="main">)</span> <span class="main">[</span>the <span class="main">(</span>eval <span class="main">(</span>r_smn <span class="main">1</span> <span class="main">1</span><span class="main">)</span> <span class="main">[</span><span class="var">?p</span><span class="main">,</span> <span class="skolem">i</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> eval <span class="main">(</span>r_universal <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?p</span> <span class="main">#</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> smn_lemma<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">i</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> eval <span class="main">(</span>r_universal <span class="numeral">2</span><span class="main">)</span> <span class="main">[</span><span class="var">?p</span><span class="main">,</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_eq_Cons_conv nat_1_add_1<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> eval <span class="free">psi</span> <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> r_universal<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_universal <span class="main">1</span><span class="main">)</span> <span class="main">[</span>the <span class="main">(</span>eval <span class="skolem">c</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> eval <span class="free">psi</span> <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> r_phi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Fixed-point theorems›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Fixed-point theorems (also known as recursion theorems) come in
many shapes. We prove the minimum we need for Chapter~\ref{c:iirf}.›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Rogers's fixed-point theorem›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this section we prove a theorem that Rogers~\cite{Rogers87}
credits to Kleene, but admits that it is a special case and not the original
formulation. We follow Wikipedia~\cite{wiki-krt} and call it the Rogers's
fixed-point theorem.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> s11_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> smn <span class="main">1</span> <span class="free">p</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"smn <span class="main">1</span> <span class="free">p</span> <span class="main">[</span><span class="skolem">x<span class="hidden">⇩</span><sub>1</sub></span><span class="main">]</span> <span class="main">=</span> smn <span class="main">1</span> <span class="free">p</span> <span class="main">[</span><span class="skolem">x<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_encode <span class="main">[</span>code_constn <span class="main">1</span> <span class="free">p</span><span class="main">,</span> code_constn <span class="main">1</span> <span class="skolem">x<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> code_id <span class="main">1</span> <span class="main">0</span><span class="main">]</span> <span class="main">=</span>
      list_encode <span class="main">[</span>code_constn <span class="main">1</span> <span class="free">p</span><span class="main">,</span> code_constn <span class="main">1</span> <span class="skolem">x<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> code_id <span class="main">1</span> <span class="main">0</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> smn_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_encode_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span>code_constn <span class="main">1</span> <span class="free">p</span><span class="main">,</span> code_constn <span class="main">1</span> <span class="skolem">x<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> code_id <span class="main">1</span> <span class="main">0</span><span class="main">]</span> <span class="main">=</span>
      <span class="main">[</span>code_constn <span class="main">1</span> <span class="free">p</span><span class="main">,</span> code_constn <span class="main">1</span> <span class="skolem">x<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> code_id <span class="main">1</span> <span class="main">0</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> list_decode_encode <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"code_constn <span class="main">1</span> <span class="skolem">x<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> code_constn <span class="main">1</span> <span class="skolem">x<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">x<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> code_const1 code_constn code_constn_def encode_injective r_constn
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def length_Cons list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> option.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_univuniv</span> <span class="main">≡</span> Cn <span class="numeral">2</span> r_phi <span class="main">[</span>Cn <span class="numeral">2</span> r_phi <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_univuniv_recfn<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> r_univuniv"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_univuniv_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> r_univuniv_converg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span><span class="free">x</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval r_univuniv <span class="main">[</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">]</span> <span class="main">=</span> eval r_phi <span class="main">[</span>the <span class="main">(</span>eval r_phi <span class="main">[</span><span class="free">x</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="free">y</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_univuniv_def <span class="keyword1"><span class="command">using</span></span> assms r_univuniv_recfn r_phi_recfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Strictly speaking this is a generalization of Rogers's theorem in
that it shows the existence of infinitely many fixed-points. In conventional
terms it says that for every total recursive $f$ and $k \in \mathbb{N}$ there is
an $n \geq k$ with $\varphi_n = \varphi_{f(n)}$.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> rogers_fixed_point_theorem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">k</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"total <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="free">k</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> eval r_phi <span class="main">[</span><span class="bound">n</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> eval r_phi <span class="main">[</span>the <span class="main">(</span>eval <span class="free">f</span> <span class="main">[</span><span class="bound">n</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"encode r_univuniv"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">=</span> Cn <span class="main">1</span> <span class="main">(</span>r_smn <span class="main">1</span> <span class="main">1</span><span class="main">)</span> <span class="main">[</span>r_const <span class="var">?p</span><span class="main">,</span> Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> <span class="skolem">h</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"total <span class="skolem">h</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">h</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> eval <span class="main">(</span>Cn <span class="main">1</span> <span class="main">(</span>r_smn <span class="main">1</span> <span class="main">1</span><span class="main">)</span> <span class="main">[</span>r_const <span class="var">?p</span><span class="main">,</span> Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">unfolding</span></span> h_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>eval <span class="skolem">h</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> smn <span class="main">1</span> <span class="var">?p</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_smn<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span>the <span class="main">(</span>eval <span class="skolem">h</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">=</span> eval r_univuniv <span class="main">[</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span>the <span class="main">(</span>eval <span class="skolem">h</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">=</span> eval r_phi <span class="main">[</span>smn <span class="main">1</span> <span class="var">?p</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> h <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> eval r_phi <span class="main">[</span>the <span class="main">(</span>eval <span class="main">(</span>r_smn <span class="main">1</span> <span class="main">1</span><span class="main">)</span> <span class="main">[</span><span class="var">?p</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_smn<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> eval <span class="main">(</span>r_universal <span class="numeral">2</span><span class="main">)</span> <span class="main">[</span><span class="var">?p</span><span class="main">,</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> r_phi_def smn_lemma<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">y</span><span class="main">]</span>"</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons_eq_append_conv One_nat_def Suc_1 length_Cons
        less_numeral_extra<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> plus_1_eq_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span>the <span class="main">(</span>eval <span class="skolem">h</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">=</span> eval r_univuniv <span class="main">[</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> r_universal r_univuniv_recfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span>the <span class="main">(</span>eval <span class="skolem">h</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">=</span> eval r_phi <span class="main">[</span>the <span class="main">(</span>eval r_phi <span class="main">[</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">↓</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">using</span></span> r_univuniv_converg that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fh</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="main">1</span> <span class="free">f</span> <span class="main">[</span><span class="skolem">h</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="var">?fh</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹prim_recfn <span class="main">1</span> <span class="skolem">h</span>›</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound">r</span><span class="main">.</span> recfn <span class="main">1</span> <span class="bound">r</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">≃</span> <span class="var">?fh</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> exteq_infinite<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?fh</span></span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>encode <span class="main">`</span> <span class="main">{</span><span class="bound">r</span><span class="main">.</span> recfn <span class="main">1</span> <span class="bound">r</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">≃</span> <span class="var">?fh</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"infinite <span class="var">?E</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> encode_injective <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> finite_imageD inj_onI<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> smn <span class="main">1</span> <span class="var">?p</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">`</span> <span class="var">?E</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> s11_inj<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_image_iff inj_on_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> smn <span class="main">1</span> <span class="var">?p</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">`</span> <span class="var">?E</span> <span class="main">=</span> <span class="main">{</span>smn <span class="main">1</span> <span class="var">?p</span> <span class="main">[</span>encode <span class="bound">r</span><span class="main">]</span> <span class="main">|</span><span class="bound">r</span><span class="main">.</span> recfn <span class="main">1</span> <span class="bound">r</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">≃</span> <span class="var">?fh</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span>smn <span class="main">1</span> <span class="var">?p</span> <span class="main">[</span>encode <span class="bound">r</span><span class="main">]</span> <span class="main">|</span><span class="bound">r</span><span class="main">.</span> recfn <span class="main">1</span> <span class="bound">r</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">≃</span> <span class="var">?fh</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> <span class="main">{</span>smn <span class="main">1</span> <span class="var">?p</span> <span class="main">[</span>encode <span class="bound">r</span><span class="main">]</span> <span class="main">|</span><span class="bound">r</span><span class="main">.</span> recfn <span class="main">1</span> <span class="bound">r</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">≃</span> <span class="var">?fh</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> finite_nat_set_iff_bounded_le le_cases<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> smn <span class="main">1</span> <span class="var">?p</span> <span class="main">[</span>encode <span class="skolem">r</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">r</span> <span class="main">∧</span> <span class="skolem">r</span> <span class="main">≃</span> <span class="var">?fh</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eval_r<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="skolem">r</span> <span class="main">[</span>encode <span class="skolem">r</span><span class="main">]</span> <span class="main">=</span> eval <span class="var">?fh</span> <span class="main">[</span>encode <span class="skolem">r</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> exteq_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> eval_r'<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="skolem">r</span> <span class="main">[</span>encode <span class="skolem">r</span><span class="main">]</span> <span class="main">=</span> eval <span class="free">f</span> <span class="main">[</span>the <span class="main">(</span>eval <span class="skolem">h</span> <span class="main">[</span>encode <span class="skolem">r</span><span class="main">]</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹total <span class="skolem">h</span>›</span></span> <span class="quoted"><span class="quoted">‹prim_recfn <span class="main">1</span> <span class="skolem">h</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">r</span> <span class="main">[</span>encode <span class="skolem">r</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹prim_recfn <span class="main">1</span> <span class="skolem">h</span>›</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span>encode <span class="skolem">r</span><span class="main">,</span> encode <span class="skolem">r</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">r</span>›</span></span> r_phi<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span>the <span class="main">(</span>eval <span class="skolem">h</span> <span class="main">[</span>encode <span class="skolem">r</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">=</span>
      eval r_phi <span class="main">[</span><span class="main">(</span>the <span class="main">(</span>eval r_phi <span class="main">[</span>encode <span class="skolem">r</span><span class="main">,</span> encode <span class="skolem">r</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span>the <span class="main">(</span>eval <span class="skolem">h</span> <span class="main">[</span>encode <span class="skolem">r</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">=</span>
      eval r_phi <span class="main">[</span><span class="main">(</span>the <span class="main">(</span>eval <span class="skolem">r</span> <span class="main">[</span>encode <span class="skolem">r</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">r</span>›</span></span> r_phi<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> the <span class="main">(</span>eval <span class="skolem">h</span> <span class="main">[</span>encode <span class="skolem">r</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> h r<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">=</span> eval r_phi <span class="main">[</span>the <span class="main">(</span>eval <span class="skolem">r</span> <span class="main">[</span>encode <span class="skolem">r</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">=</span> eval r_phi <span class="main">[</span>the <span class="main">(</span>eval <span class="var">?fh</span> <span class="main">[</span>encode <span class="skolem">r</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">using</span></span> r <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval_r<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?fh</span> <span class="main">[</span>encode <span class="skolem">r</span><span class="main">]</span> <span class="main">=</span> eval <span class="free">f</span> <span class="main">[</span><span class="skolem">n</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eval_r eval_r' <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">=</span> the <span class="main">(</span>eval <span class="skolem">h</span> <span class="main">[</span>encode <span class="skolem">r</span><span class="main">]</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">=</span> eval r_phi <span class="main">[</span>the <span class="main">(</span>eval <span class="free">f</span> <span class="main">[</span><span class="skolem">n</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">≥</span> <span class="free">k</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Kleene's fixed-point theorem›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next theorem is what Rogers~\cite[p.~214]{Rogers87} calls
Kleene's version of what we call Rogers's fixed-point theorem. More precisely
this would be Kleene's \emph{second} fixed-point theorem, but since we do not
cover the first one, we leave out the number.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> kleene_fixed_point_theorem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">k</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="free">psi</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="free">k</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> eval r_phi <span class="main">[</span><span class="bound">n</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> eval <span class="free">psi</span> <span class="main">[</span><span class="bound">n</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> numbering_translation<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span>
    <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">c</span>"</span></span>
    <span class="quoted"><span class="quoted">"total <span class="skolem">c</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="bound">x</span><span class="main">.</span> eval <span class="free">psi</span> <span class="main">[</span><span class="bound">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> eval r_phi <span class="main">[</span>the <span class="main">(</span>eval <span class="skolem">c</span> <span class="main">[</span><span class="bound">i</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> eval r_phi <span class="main">[</span><span class="skolem">n</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> eval r_phi <span class="main">[</span>the <span class="main">(</span>eval <span class="skolem">c</span> <span class="main">[</span><span class="skolem">n</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rogers_fixed_point_theorem <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> c<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> eval r_phi <span class="main">[</span><span class="skolem">n</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> eval <span class="free">psi</span> <span class="main">[</span><span class="skolem">n</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">≥</span> <span class="free">k</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Kleene's fixed-point theorem can be generalized to arbitrary
arities. But we need to generalize it only to binary functions in order to
show Smullyan's double fixed-point theorem in
Section~\ref{s:smullyan}.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_univuniv2</span> <span class="main">≡</span>
  Cn <span class="numeral">3</span> r_phi <span class="main">[</span>Cn <span class="numeral">3</span> <span class="main">(</span>r_universal <span class="numeral">2</span><span class="main">)</span> <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_univuniv2_recfn<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">3</span> r_univuniv2"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_univuniv2_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> r_univuniv2_converg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_universal <span class="numeral">2</span><span class="main">)</span> <span class="main">[</span><span class="free">u</span><span class="main">,</span> <span class="free">u</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval r_univuniv2 <span class="main">[</span><span class="free">u</span><span class="main">,</span> <span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">]</span> <span class="main">=</span> eval r_phi <span class="main">[</span>the <span class="main">(</span>eval <span class="main">(</span>r_universal <span class="numeral">2</span><span class="main">)</span> <span class="main">[</span><span class="free">u</span><span class="main">,</span> <span class="free">u</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="free">y</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_univuniv2_def <span class="keyword1"><span class="command">using</span></span> assms r_univuniv2_recfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">theorem</span></span> kleene_fixed_point_theorem_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"total <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span>
    recfn <span class="main">1</span> <span class="bound">n</span> <span class="main">∧</span>
    total <span class="bound">n</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> eval r_phi <span class="main">[</span><span class="main">(</span>the <span class="main">(</span>eval <span class="bound">n</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="bound">y</span><span class="main">]</span> <span class="main">=</span> eval r_phi <span class="main">[</span><span class="main">(</span>the <span class="main">(</span>eval <span class="free">f</span> <span class="main">[</span>the <span class="main">(</span>eval <span class="bound">n</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="bound">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"encode r_univuniv2"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"r_smn <span class="main">1</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">=</span> Cn <span class="numeral">2</span> <span class="var">?s</span> <span class="main">[</span>r_dummy <span class="main">1</span> <span class="main">(</span>r_const <span class="var">?p</span><span class="main">)</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="numeral">2</span> <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">h</span> <span class="main">[</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> eval <span class="main">(</span>Cn <span class="numeral">2</span> <span class="var">?s</span> <span class="main">[</span>r_dummy <span class="main">1</span> <span class="main">(</span>r_const <span class="var">?p</span><span class="main">)</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> h_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>eval <span class="skolem">h</span> <span class="main">[</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> smn <span class="main">1</span> <span class="var">?p</span> <span class="main">[</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_smn<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span>the <span class="main">(</span>eval <span class="skolem">h</span> <span class="main">[</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">=</span> eval r_phi <span class="main">[</span>smn <span class="main">1</span> <span class="var">?p</span> <span class="main">[</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>
      eval r_phi
        <span class="main">[</span>encode <span class="main">(</span>Cn <span class="main">1</span> <span class="main">(</span>r_universal <span class="numeral">3</span><span class="main">)</span> <span class="main">(</span>r_constn <span class="main">0</span> <span class="var">?p</span> <span class="main">#</span> r_constn <span class="main">0</span> <span class="skolem">u</span> <span class="main">#</span> r_constn <span class="main">0</span> <span class="skolem">x</span> <span class="main">#</span> <span class="main">[</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
         <span class="skolem">y</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> smn<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> numeral_3_eq_3<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>
      eval r_phi
        <span class="main">[</span>encode <span class="main">(</span>Cn <span class="main">1</span> <span class="main">(</span>r_universal <span class="numeral">3</span><span class="main">)</span> <span class="main">(</span>r_const <span class="var">?p</span> <span class="main">#</span> r_const <span class="skolem">u</span> <span class="main">#</span> r_const <span class="skolem">x</span> <span class="main">#</span> <span class="main">[</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> eval r_phi <span class="main">[</span>encode <span class="var">?f</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_constn_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> eval <span class="var">?f</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> r_phi'<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> eval <span class="main">(</span>r_universal <span class="numeral">3</span><span class="main">)</span> <span class="main">[</span><span class="var">?p</span><span class="main">,</span> <span class="skolem">u</span><span class="main">,</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> r_univuniv2_recfn r_universal r_phi <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> eval r_univuniv2 <span class="main">[</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> r_universal
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_universal r_univuniv2_recfn<span class="main">)</span> 
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span>the <span class="main">(</span>eval <span class="skolem">h</span> <span class="main">[</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">=</span>  eval r_univuniv2 <span class="main">[</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span>the <span class="main">(</span>eval <span class="skolem">h</span> <span class="main">[</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">=</span>
      eval r_phi <span class="main">[</span>the <span class="main">(</span>eval <span class="main">(</span>r_universal <span class="numeral">2</span><span class="main">)</span> <span class="main">[</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">u</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_universal <span class="numeral">2</span><span class="main">)</span> <span class="main">[</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">u</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">↓</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">u</span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">using</span></span> r_univuniv2_converg that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fh</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="numeral">2</span> <span class="free">f</span> <span class="main">[</span><span class="skolem">h</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"encode <span class="var">?fh</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="var">?fh</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"total <span class="skolem">h</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"total <span class="var">?fh</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms Cn_total totalI2<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?fh</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="main">1</span> <span class="skolem">h</span> <span class="main">[</span>r_const <span class="var">?e</span><span class="main">,</span> Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="var">?n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"total <span class="var">?n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹total <span class="skolem">h</span>›</span></span> totalI1<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span><span class="main">(</span>the <span class="main">(</span>eval <span class="var">?n</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">=</span> eval r_phi <span class="main">[</span><span class="main">(</span>the <span class="main">(</span>eval <span class="skolem">h</span> <span class="main">[</span><span class="var">?e</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> eval r_phi <span class="main">[</span>the <span class="main">(</span>eval <span class="main">(</span>r_universal <span class="numeral">2</span><span class="main">)</span> <span class="main">[</span><span class="var">?e</span><span class="main">,</span> <span class="var">?e</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> * r_universal<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="numeral">2</span></span><span class="main">]</span> totalE<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?fh</span></span></span> <span class="quoted"><span class="numeral">2</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹total <span class="var">?fh</span>›</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">2</span> <span class="var">?fh</span>›</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_Cons list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> numeral_2_eq_2<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> eval r_phi <span class="main">[</span>the <span class="main">(</span>eval <span class="free">f</span> <span class="main">[</span>the <span class="main">(</span>eval <span class="skolem">h</span> <span class="main">[</span><span class="var">?e</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_universal <span class="numeral">2</span><span class="main">)</span> <span class="main">[</span><span class="var">?e</span><span class="main">,</span> <span class="var">?e</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> totalE<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹total <span class="var">?fh</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">2</span> <span class="var">?fh</span>›</span></span> r_universal
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_Cons list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> numeral_2_eq_2<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_universal <span class="numeral">2</span><span class="main">)</span> <span class="main">[</span><span class="var">?e</span><span class="main">,</span> <span class="var">?e</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> eval <span class="var">?fh</span> <span class="main">[</span><span class="var">?e</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">2</span> <span class="var">?fh</span>›</span></span> length_Cons list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> numeral_2_eq_2 r_universal<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹total <span class="skolem">h</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  eval r_phi <span class="main">[</span><span class="main">(</span>the <span class="main">(</span>eval <span class="free">f</span> <span class="main">[</span>the <span class="main">(</span>eval <span class="var">?n</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span><span class="main">(</span>the <span class="main">(</span>eval <span class="var">?n</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">=</span>
      eval r_phi <span class="main">[</span><span class="main">(</span>the <span class="main">(</span>eval <span class="free">f</span> <span class="main">[</span>the <span class="main">(</span>eval <span class="var">?n</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Smullyan's double fixed-point theorem\label{s:smullyan}›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> smullyan_double_fixed_point_theorem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"total <span class="free">g</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="free">h</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"total <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">m</span> <span class="bound">n</span><span class="main">.</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> eval r_phi <span class="main">[</span><span class="bound">m</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> eval r_phi <span class="main">[</span>the <span class="main">(</span>eval <span class="free">g</span> <span class="main">[</span><span class="bound">m</span><span class="main">,</span> <span class="bound">n</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> eval r_phi <span class="main">[</span><span class="bound">n</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> eval r_phi <span class="main">[</span>the <span class="main">(</span>eval <span class="free">h</span> <span class="main">[</span><span class="bound">m</span><span class="main">,</span> <span class="bound">n</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="quoted"><span class="quoted">"total <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> eval r_phi <span class="main">[</span>the <span class="main">(</span>eval <span class="skolem">m</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="bound">y</span><span class="main">]</span> <span class="main">=</span>
      eval r_phi <span class="main">[</span>the <span class="main">(</span>eval <span class="free">g</span> <span class="main">[</span>the <span class="main">(</span>eval <span class="skolem">m</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="bound">y</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> kleene_fixed_point_theorem_2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">g</span></span><span class="main">]</span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> Cn <span class="main">1</span> <span class="free">h</span> <span class="main">[</span><span class="skolem">m</span><span class="main">,</span> Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">m</span>›</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"total <span class="main">(</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mn_free_imp_total<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"total <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹total <span class="skolem">m</span>›</span></span> assms<span class="main">(</span>4<span class="main">)</span> Cn_total k_def <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> eval r_phi <span class="main">[</span><span class="skolem">n</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> eval r_phi <span class="main">[</span>the <span class="main">(</span>eval <span class="skolem">k</span> <span class="main">[</span><span class="skolem">n</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rogers_fixed_point_theorem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">k</span>›</span></span> <span class="quoted"><span class="quoted">‹total <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">mm</span></span> <span class="keyword2"><span class="keyword">where</span></span> mm<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="skolem">m</span> <span class="main">[</span><span class="skolem">n</span><span class="main">]</span> <span class="main">↓=</span> <span class="skolem">mm</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹total <span class="skolem">m</span>›</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> eval r_phi <span class="main">[</span><span class="skolem">mm</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> eval r_phi <span class="main">[</span>the <span class="main">(</span>eval <span class="free">g</span> <span class="main">[</span><span class="skolem">mm</span><span class="main">,</span> <span class="skolem">n</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> m option.sel<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> eval r_phi <span class="main">[</span><span class="skolem">n</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> eval r_phi <span class="main">[</span>the <span class="main">(</span>eval <span class="free">h</span> <span class="main">[</span><span class="skolem">mm</span><span class="main">,</span> <span class="skolem">n</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> k_def assms<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹total <span class="skolem">m</span>›</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">m</span>›</span></span> mm n <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Decidable and recursively enumerable sets\label{s:decidable}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We defined <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">decidable</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> already back in
Section~\ref{s:halting}: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[display] decidable_def<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next theorem is adapted from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source]
halting_problem_undecidable<span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> halting_problem_phi_undecidable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> decidable <span class="main">{</span><span class="bound">x</span><span class="main">.</span> eval r_phi <span class="main">[</span><span class="bound">x</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">↓</span><span class="main">}</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> decidable <span class="var">?K</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"decidable <span class="var">?K</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> eval <span class="skolem">f</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="var">?K</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> decidable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">≡</span> Cn <span class="main">1</span> r_ifeq_else_diverg <span class="main">[</span><span class="skolem">f</span><span class="main">,</span> Z<span class="main">,</span> Z<span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">g</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">f</span>›</span></span> r_ifeq_else_diverg_recfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> eval <span class="skolem">g</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> r_phi' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> g_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">g</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="var">?K</span> <span class="keyword1">then</span> Some <span class="main">0</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> r_ifeq_else_diverg_recfn <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">f</span>›</span></span> f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">g</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span> <span class="main">↓</span> <span class="main">⟷</span> <span class="skolem">i</span> <span class="main">∉</span> <span class="var">?K</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⟷</span> eval r_phi <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">i</span><span class="main">]</span> <span class="main">↑</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⟷</span> eval <span class="skolem">g</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span> <span class="main">↑</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">g</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span> <span class="main">↓</span> <span class="main">⟷</span> eval <span class="skolem">g</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span> <span class="main">↑</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> decidable_complement<span class="main">:</span> <span class="quoted"><span class="quoted">"decidable <span class="free">X</span> <span class="main">⟹</span> decidable <span class="main">(</span><span class="main">-</span> <span class="free">X</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"decidable <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> eval <span class="skolem">f</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> decidable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> Cn <span class="main">1</span> r_not <span class="main">[</span><span class="skolem">f</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">g</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">g</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g_def f<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> decidable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Finite sets are decidable.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">r_contains</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> recf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">r_contains</span> <span class="main">[]</span> <span class="main">=</span> Z"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">r_contains</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> Cn <span class="main">1</span> r_ifeq <span class="main">[</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">,</span> r_const <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> r_const <span class="main">1</span><span class="main">,</span> <span class="free">r_contains</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_contains_prim<span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> <span class="main">(</span>r_contains <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> r_contains<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_contains <span class="free">xs</span><span class="main">)</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_contains <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> eval r_ifeq <span class="main">[</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">a</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> the <span class="main">(</span>eval <span class="main">(</span>r_contains <span class="skolem">xs</span><span class="main">)</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_contains_prim prim_recfn_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">a</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">xs</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">xs</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_set_decidable<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span> <span class="main">⟹</span> decidable <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">X</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> set <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> eval <span class="main">(</span>r_contains <span class="skolem">xs</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">X</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_contains <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"decidable <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> decidable_def r_contains_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">semidecidable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">semidecidable</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∃</span><span class="bound">f</span><span class="main">.</span> recfn <span class="main">1</span> <span class="bound">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> eval <span class="bound">f</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="keyword1">then</span> Some <span class="main">1</span> <span class="keyword1">else</span> None<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The semidecidable sets are the domains of partial recursive functions.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> semidecidable_iff_domain<span class="main">:</span>
  <span class="quoted"><span class="quoted">"semidecidable <span class="free">X</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">f</span><span class="main">.</span> recfn <span class="main">1</span> <span class="bound">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> eval <span class="bound">f</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">↓</span> <span class="main">⟷</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"semidecidable <span class="free">X</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">f</span><span class="main">.</span> recfn <span class="main">1</span> <span class="bound">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>eval <span class="bound">f</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">↓</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> semidecidable_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"semidecidable <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">.</span> recfn <span class="main">1</span> <span class="bound">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>eval <span class="bound">f</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">↓</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">X</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> that <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>eval <span class="skolem">f</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">↓</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="main">1</span> <span class="main">(</span>r_const <span class="main">1</span><span class="main">)</span> <span class="main">[</span><span class="skolem">f</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="var">?g</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> eval <span class="var">?g</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">X</span> <span class="keyword1">then</span> Some <span class="main">1</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"semidecidable <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> semidecidable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> decidable_imp_semidecidable<span class="main">:</span> <span class="quoted"><span class="quoted">"decidable <span class="free">X</span> <span class="main">⟹</span> semidecidable <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"decidable <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> eval <span class="skolem">f</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> decidable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> Cn <span class="main">1</span> r_ifeq_else_diverg <span class="main">[</span><span class="skolem">f</span><span class="main">,</span> r_const <span class="main">1</span><span class="main">,</span> r_const <span class="main">1</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">g</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">g</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> eval r_ifeq_else_diverg <span class="main">[</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g_def f<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> eval <span class="skolem">g</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">X</span> <span class="main">⟹</span> eval <span class="skolem">g</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">↑</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">g</span>›</span></span> semidecidable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A set is recursively enumerable if it is empty or the image of a
total recursive function.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">recursively_enumerable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">recursively_enumerable</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≡</span>
     <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">f</span><span class="main">.</span> recfn <span class="main">1</span> <span class="bound">f</span> <span class="main">∧</span> total <span class="bound">f</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> <span class="main">{</span>the <span class="main">(</span>eval <span class="bound">f</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> UNIV<span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> recursively_enumerable_iff_semidecidable<span class="main">:</span>
  <span class="quoted"><span class="quoted">"recursively_enumerable <span class="free">X</span> <span class="main">⟷</span> semidecidable <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"semidecidable <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"recursively_enumerable <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">X</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_set_decidable decidable_imp_semidecidable
        recursively_enumerable_def semidecidable_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> that <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">f</span>"</span></span> <span class="quoted"><span class="quoted">"total <span class="skolem">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="main">{</span>the <span class="main">(</span>eval <span class="skolem">f</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> UNIV<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> recursively_enumerable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">=</span> Cn <span class="numeral">2</span> r_eq <span class="main">[</span>Cn <span class="numeral">2</span> <span class="skolem">f</span> <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="skolem">h</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> h_def <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="skolem">h</span> <span class="main">[</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span> <span class="main">⟷</span> the <span class="main">(</span>eval <span class="skolem">f</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
      <span class="keyword1"><span class="command">using</span></span> f<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> h_def <span class="quoted"><span class="quoted">‹recfn <span class="numeral">2</span> <span class="skolem">h</span>›</span></span> totalI2 f<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"total <span class="skolem">h</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> Mn <span class="main">1</span> <span class="skolem">h</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">g</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> h_def f<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">g</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> eval <span class="skolem">h</span> <span class="main">[</span><span class="bound">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">x'</span></span><span class="main">&lt;</span><span class="bound">x</span><span class="main">.</span> eval <span class="skolem">h</span> <span class="main">[</span><span class="bound">x'</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">↓</span><span class="main">)</span><span class="main">)</span>
       <span class="keyword1">then</span> Some <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">x</span><span class="main">.</span> eval <span class="skolem">h</span> <span class="main">[</span><span class="bound">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">)</span>
       <span class="keyword1">else</span> None<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
      <span class="keyword1"><span class="command">using</span></span> g_def <span class="quoted"><span class="quoted">‹total <span class="skolem">h</span>›</span></span> f<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">g</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> eval <span class="skolem">h</span> <span class="main">[</span><span class="bound">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>
       <span class="keyword1">then</span> Some <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">x</span><span class="main">.</span> eval <span class="skolem">h</span> <span class="main">[</span><span class="bound">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">)</span>
       <span class="keyword1">else</span> None<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹total <span class="skolem">h</span>›</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">2</span> <span class="skolem">h</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">g</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span> <span class="main">↓</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> eval <span class="skolem">h</span> <span class="main">[</span><span class="bound">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> h <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">g</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span> <span class="main">↓</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> the <span class="main">(</span>eval <span class="skolem">f</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> f<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">g</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span> <span class="main">↓</span> <span class="main">⟷</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">y</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">g</span>›</span></span> semidecidable_iff_domain <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"recursively_enumerable <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"semidecidable <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">X</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> recursively_enumerable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> that semidecidable_iff_domain <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> eval <span class="skolem">f</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">↓</span> <span class="main">⟷</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"encode <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> eval <span class="skolem">f</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">=</span> eval r_phi <span class="main">[</span><span class="var">?i</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> r_phi' f<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="skolem">X</span>›</span></span> f<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span><span class="var">?i</span><span class="main">,</span> <span class="skolem">x<span class="hidden">⇩</span><sub>0</sub></span><span class="main">]</span> <span class="main">↓</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">g</span>"</span></span> <span class="quoted"><span class="quoted">"total <span class="skolem">g</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> eval r_phi <span class="main">[</span><span class="var">?i</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">↓</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> eval <span class="skolem">g</span> <span class="main">[</span><span class="bound">y</span><span class="main">]</span> <span class="main">↓=</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f<span class="main">(</span>1<span class="main">)</span> nonempty_domain_enumerable <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> f<span class="main">(</span>2<span class="main">)</span> i <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">X</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> eval <span class="skolem">g</span> <span class="main">[</span><span class="bound">y</span><span class="main">]</span> <span class="main">↓=</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">X</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> the <span class="main">(</span>eval <span class="skolem">g</span> <span class="main">[</span><span class="bound">y</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> totalE<span class="main">[</span><span class="operator">OF</span> g<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> g<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def length_Cons list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> option.collapse option.sel<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="main">{</span>the <span class="main">(</span>eval <span class="skolem">g</span> <span class="main">[</span><span class="bound">y</span><span class="main">]</span><span class="main">)</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> UNIV<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> g<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> recursively_enumerable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next goal is to show that a set is decidable iff. it and its
complement are semidecidable. For this we use the concurrent evaluation
function.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> semidecidable_decidable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"semidecidable <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"semidecidable <span class="main">(</span><span class="main">-</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"decidable <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> eval <span class="skolem">f</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">↓</span> <span class="main">⟷</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> semidecidable_iff_domain <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"encode <span class="skolem">f</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">g</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> eval <span class="skolem">g</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">↓</span> <span class="main">⟷</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">-</span> <span class="free">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> semidecidable_iff_domain <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?j</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"encode <span class="skolem">g</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> Cn <span class="main">1</span> r_pdec1 <span class="main">[</span>Cn <span class="main">1</span> r_parallel <span class="main">[</span>r_const <span class="var">?j</span><span class="main">,</span> r_const <span class="var">?i</span><span class="main">,</span> Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">d</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> d_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> eval r_phi <span class="main">[</span><span class="var">?i</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> eval <span class="skolem">f</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> eval r_phi <span class="main">[</span><span class="var">?j</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> eval <span class="skolem">g</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f g r_phi' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">d</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">f</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">g</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">↑</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> g that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_parallel <span class="main">[</span><span class="var">?j</span><span class="main">,</span> <span class="var">?i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="main">1</span><span class="main">,</span> the <span class="main">(</span>eval <span class="skolem">f</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> * r_parallel<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> d_def <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">d</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="free">X</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">g</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> g that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">f</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">↑</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_parallel <span class="main">[</span><span class="var">?j</span><span class="main">,</span> <span class="var">?i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="main">0</span><span class="main">,</span> the <span class="main">(</span>eval <span class="skolem">g</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> * r_parallel<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> d_def <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> decidable_def <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">d</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> decidable_iff_semidecidable_complement<span class="main">:</span>
  <span class="quoted"><span class="quoted">"decidable <span class="free">X</span> <span class="main">⟷</span> semidecidable <span class="free">X</span> <span class="main">∧</span> semidecidable <span class="main">(</span><span class="main">-</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> semidecidable_decidable decidable_imp_semidecidable decidable_complement
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Rice's theorem›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">index_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">index_set</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> eval r_phi <span class="main">[</span><span class="bound">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> eval r_phi <span class="main">[</span><span class="bound">j</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> index_set_closed_in<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"index_set <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> eval r_phi <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> eval r_phi <span class="main">[</span><span class="free">j</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> index_set_def assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> index_set_closed_not_in<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"index_set <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> eval r_phi <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> eval r_phi <span class="main">[</span><span class="free">j</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> index_set_def assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">theorem</span></span> rice_theorem<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"index_set <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">≠</span> UNIV"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> decidable <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"decidable <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">d</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> eval <span class="skolem">d</span> <span class="main">[</span><span class="bound">i</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> decidable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">j<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∉</span> <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?if</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="numeral">2</span> r_ifz <span class="main">[</span>Cn <span class="numeral">2</span> <span class="skolem">d</span> <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span> r_dummy <span class="main">1</span> <span class="main">(</span>r_const <span class="skolem">j<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">,</span> r_dummy <span class="main">1</span> <span class="main">(</span>r_const <span class="skolem">j<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">psi</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">psi</span> <span class="main">=</span> Cn <span class="numeral">2</span> r_phi <span class="main">[</span><span class="var">?if</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span> "</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="skolem">psi</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> d<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?if</span> <span class="main">[</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">=</span> Some <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">I</span> <span class="keyword1">then</span> <span class="skolem">j<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">else</span> <span class="skolem">j<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> d<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">psi</span> <span class="main">[</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">=</span> eval <span class="main">(</span>Cn <span class="numeral">2</span> r_phi <span class="main">[</span><span class="var">?if</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">using</span></span> psi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> psi<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="skolem">psi</span> <span class="main">[</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">=</span> eval r_phi <span class="main">[</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">I</span> <span class="keyword1">then</span> <span class="skolem">j<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">else</span> <span class="skolem">j<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> d<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> in_I<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="skolem">psi</span> <span class="main">[</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">=</span> eval r_phi <span class="main">[</span><span class="skolem">j<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> not_in_I<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="skolem">psi</span> <span class="main">[</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">=</span> eval r_phi <span class="main">[</span><span class="skolem">j<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> psi that<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> eval r_phi <span class="main">[</span><span class="skolem">n</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> eval <span class="skolem">psi</span> <span class="main">[</span><span class="skolem">n</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> kleene_fixed_point_theorem<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">2</span> <span class="skolem">psi</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> eval r_phi <span class="main">[</span><span class="skolem">n</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> eval r_phi <span class="main">[</span><span class="skolem">j<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n in_I <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∉</span> <span class="free">I</span>›</span></span> index_set_closed_not_in<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">∈</span> <span class="free">I</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> eval r_phi <span class="main">[</span><span class="skolem">n</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> eval r_phi <span class="main">[</span><span class="skolem">j<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n not_in_I <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> <span class="free">I</span>›</span></span> index_set_closed_in<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">∉</span> <span class="free">I</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Partial recursive functions as actual functions\label{s:alternative}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A well-formed <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">recf</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> describes an algorithm. Usually,
however, partial recursive functions are considered to be partial functions,
that is, right-unique binary relations. This distinction did not matter much
until now, because we were mostly concerned with the \emph{existence} of
partial recursive functions, which is equivalent to the existence of
algorithms. Whenever it did matter, we could use the extensional equivalence
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"exteq"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. In Chapter~\ref{c:iirf}, however, we will deal with sets of
functions and sets of sets of functions.

For illustration consider the singleton set containing only the unary zero
function. It could be expressed by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span>Z<span class="main"><span class="main">}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, but this would not contain
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>[names_short] <span class="quoted"><span class="quoted">"Cn <span class="main"><span class="main">1</span></span> <span class="main"><span class="main">(</span></span>Id <span class="main"><span class="main">1</span></span> <span class="main"><span class="main">0</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">[</span></span>Z<span class="main"><span class="main">]</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, which computes the same function.
The alternative representation as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="bound"><span class="bound">f</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">f</span></span> <span class="main"><span class="main">≃</span></span> Z<span class="main"><span class="main">}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is not a
singleton set. Another alternative would be to identify partial recursive
functions with the equivalence classes of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"exteq"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. This would work
for all arities. But since we will only need unary and binary functions, we
can go for the less general but simpler alternative of regarding partial
recursive functions as certain functions of types <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"nat <span class="main"><span class="main">⇒</span></span>
nat option"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"nat <span class="main"><span class="main">⇒</span></span> nat <span class="main"><span class="main">⇒</span></span> nat option"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
With this notation we can represent the aforementioned set by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="bound"><span class="main"><span class="bound">_</span></span></span></span><span class="main"><span class="main">.</span></span> Some <span class="main"><span class="main">(</span></span><span class="main"><span class="main">0</span></span><span class="main"><span class="main">::</span></span>nat<span class="main"><span class="main">)</span></span><span class="main"><span class="main">}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and express that the function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="bound"><span class="main"><span class="bound">_</span></span></span></span><span class="main"><span class="main">.</span></span>
Some <span class="main"><span class="main">(</span></span><span class="main"><span class="main">0</span></span><span class="main"><span class="main">::</span></span>nat<span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is total recursive.

In addition terms get shorter, for instance, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"eval <span class="free"><span class="free">r_func</span></span> <span class="main"><span class="main">[</span></span><span class="free"><span class="free">i</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">x</span></span><span class="main"><span class="main">]</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
becomes <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">func</span></span> <span class="free"><span class="free">i</span></span> <span class="free"><span class="free">x</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The definitions›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> partial1 <span class="main">=</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat option"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> partial2 <span class="main">=</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat option"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">total1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial1 <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">total1</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="main">↓</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">total2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial2 <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">total2</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">↓</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> total1I <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">↓</span><span class="main">)</span> <span class="main">⟹</span> total1 <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> total1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> total2I <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">↓</span><span class="main">)</span> <span class="main">⟹</span> total2 <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> total2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> total1E <span class="main">[</span><span class="operator">dest</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"total1 <span class="free">f</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">x</span> <span class="main">↓</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> total1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> total2E <span class="main">[</span><span class="operator">dest</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"total2 <span class="free">f</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">x</span> <span class="free">y</span> <span class="main">↓</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> total2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">P1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial1 set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒫</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝒫</span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> eval <span class="bound">r</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">|</span><span class="bound">r</span><span class="main">.</span> recfn <span class="main">1</span> <span class="bound">r</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">P2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial2 set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒫<span class="hidden">⇧</span><sup>2</sup></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝒫<span class="hidden">⇧</span><sup>2</sup></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> eval <span class="bound">r</span> <span class="main">[</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">]</span> <span class="main">|</span><span class="bound">r</span><span class="main">.</span> recfn <span class="numeral">2</span> <span class="bound">r</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">R1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial1 set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ℛ</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℛ</span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> eval <span class="bound">r</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">|</span><span class="bound">r</span><span class="main">.</span> recfn <span class="main">1</span> <span class="bound">r</span> <span class="main">∧</span> total <span class="bound">r</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">R2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial2 set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℛ<span class="hidden">⇧</span><sup>2</sup></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> eval <span class="bound">r</span> <span class="main">[</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">]</span> <span class="main">|</span><span class="bound">r</span><span class="main">.</span> recfn <span class="numeral">2</span> <span class="bound">r</span> <span class="main">∧</span> total <span class="bound">r</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Prim1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial1 set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Prim1</span> <span class="main">≡</span> <span class="main">{</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> eval <span class="bound">r</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">|</span><span class="bound">r</span><span class="main">.</span> prim_recfn <span class="main">1</span> <span class="bound">r</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Prim2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial2 set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Prim2</span> <span class="main">≡</span> <span class="main">{</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> eval <span class="bound">r</span> <span class="main">[</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">]</span> <span class="main">|</span><span class="bound">r</span><span class="main">.</span> prim_recfn <span class="numeral">2</span> <span class="bound">r</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> R1_imp_P1 <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> R1_def P1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> R2_imp_P2 <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">∈</span> <span class="keyword1">𝒫<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> R2_def P2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Prim1_imp_R1 <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> Prim1 <span class="main">⟹</span> <span class="free">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Prim1_def R1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> Prim2_imp_R2 <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> Prim2 <span class="main">⟹</span> <span class="free">f</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Prim2_def R2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> P1E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">r</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> eval <span class="free">r</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms P1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> P2E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">𝒫<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">r</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> eval <span class="free">r</span> <span class="main">[</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">]</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms P2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> P1I <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> eval <span class="free">r</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms P1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> P2I <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> eval <span class="free">r</span> <span class="main">[</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">]</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">𝒫<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> eval <span class="free">r</span> <span class="main">[</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> P2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> R1I <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"total <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> eval <span class="free">r</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> R1_def
  <span class="keyword1"><span class="command">using</span></span> CollectI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="bound">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> eval <span class="bound">r</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span> recfn <span class="main">1</span> <span class="bound">r</span> <span class="main">∧</span> total <span class="bound">r</span>"</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> R1E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">r</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"total <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> eval <span class="free">r</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms R1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> R2I <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"total <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> eval <span class="free">r</span> <span class="main">[</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">]</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> R2_def
  <span class="keyword1"><span class="command">using</span></span> CollectI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="bound">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> eval <span class="bound">r</span> <span class="main">[</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span> recfn <span class="numeral">2</span> <span class="bound">r</span> <span class="main">∧</span> total <span class="bound">r</span>"</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> R1_SOME<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">r'</span><span class="main">.</span> recfn <span class="main">1</span> <span class="bound">r'</span> <span class="main">∧</span>  total <span class="bound">r'</span> <span class="main">∧</span> <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> eval <span class="bound">r'</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">r'</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">r'</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="free">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> eval <span class="free">r</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> eval <span class="free">r</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> eval <span class="free">r</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">r'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> R1E<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> eval <span class="free">r</span> <span class="main">[</span><span class="bound">b</span><span class="main">]</span> <span class="main">↓</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> eval <span class="free">r</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> someI<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="quoted"><span class="skolem">r'</span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span> totalE<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> eval <span class="free">r</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> R2E <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">r</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"total <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> eval <span class="free">r</span> <span class="main">[</span><span class="bound">x<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">x<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms R2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> R1_imp_total1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span> <span class="main">⟹</span> total1 <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> total1I <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> R2_imp_total2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">⟹</span> total2 <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> totalE <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> Prim1I <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> eval <span class="free">r</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> Prim1"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms Prim1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> Prim2I <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prim_recfn <span class="numeral">2</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">=</span> eval <span class="free">r</span> <span class="main">[</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> Prim2"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms Prim2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> P1_total_imp_R1 <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"total1 <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms totalI1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> P2_total_imp_R2 <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">𝒫<span class="hidden">⇧</span><sup>2</sup></span> "</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"total2 <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms totalI2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Some simple properties›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In order to show that a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">partial1</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> or <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">partial2</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
function is in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">𝒫</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">𝒫<span class="hidden">⇧</span><sup>2</sup></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">ℛ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Prim1"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, or <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Prim2"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> we will usually have to
find a suitable <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">recf</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. But for some simple or frequent cases this
section provides shortcuts.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> identity_in_R1<span class="main">:</span> <span class="quoted"><span class="quoted">"Some <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> eval <span class="main">(</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="main">(</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"total <span class="main">(</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> totalI1<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P2_proj_P1 <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">∈</span> <span class="keyword1">𝒫<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="free">i</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> eval <span class="skolem">u</span> <span class="main">[</span><span class="bound">x<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">x<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">≡</span> Cn <span class="main">1</span> <span class="skolem">u</span> <span class="main">[</span>r_const <span class="free">i</span><span class="main">,</span> Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> eval <span class="skolem">v</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">ψ</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> u <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> R2_proj_R1 <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="free">i</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">∈</span> <span class="keyword1">𝒫<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="free">i</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"total1 <span class="main">(</span><span class="free">ψ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> total1I<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> const_in_Prim1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Some <span class="free">c</span><span class="main">)</span> <span class="main">∈</span> Prim1"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> r_const <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> eval <span class="skolem">r</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">=</span> Some <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"Mn_free <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> concat_P1_P1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">↓</span> <span class="main">∧</span> <span class="free">f</span> <span class="main">(</span>the <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">↓</span> <span class="keyword1">then</span> Some <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">(</span>the <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?h</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rf</span></span> <span class="keyword2"><span class="keyword">where</span></span> rf<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">rf</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> eval <span class="skolem">rf</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rg</span></span> <span class="keyword2"><span class="keyword">where</span></span> rg<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">rg</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> eval <span class="skolem">rg</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rh</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="main">1</span> <span class="skolem">rf</span> <span class="main">[</span><span class="skolem">rg</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="var">?rh</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rf<span class="main">(</span>1<span class="main">)</span> rg<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?rh</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> <span class="var">?h</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> rf rg <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> P1_update_P1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span><span class="free">z</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">z</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> None
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">re</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">re</span> <span class="main">≡</span> Mn <span class="main">1</span> <span class="main">(</span>r_constn <span class="main">1</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> eval <span class="skolem">r</span> <span class="main">[</span><span class="bound">u</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">=</span> Cn <span class="main">1</span> <span class="main">(</span>r_lifz <span class="skolem">re</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">[</span>Cn <span class="main">1</span> r_eq <span class="main">[</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">,</span> r_const <span class="free">x</span><span class="main">]</span><span class="main">,</span> Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">r'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r<span class="main">(</span>1<span class="main">)</span> r'_def re_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">r'</span> <span class="main">[</span><span class="skolem">u</span><span class="main">]</span> <span class="main">=</span> eval <span class="main">(</span>r_lifz <span class="skolem">re</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">[</span><span class="keyword1">if</span> <span class="skolem">u</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">,</span> <span class="skolem">u</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">u</span>
    <span class="keyword1"><span class="command">using</span></span> r'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> r<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">r'</span> <span class="main">[</span><span class="skolem">u</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">u</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> eval <span class="skolem">r</span> <span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">u</span>
    <span class="keyword1"><span class="command">using</span></span> re_def re_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> r<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">r'</span> <span class="main">[</span><span class="skolem">u</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span>None<span class="main">)</span><span class="main">)</span> <span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">u</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> eval <span class="skolem">r'</span> <span class="main">[</span><span class="bound">u</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span>None<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> None <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">r'</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> eval <span class="skolem">r</span> <span class="main">[</span><span class="bound">u</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">≡</span> Cn <span class="main">1</span> <span class="main">(</span>r_lifz <span class="main">(</span>r_const <span class="skolem">y</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">[</span>Cn <span class="main">1</span> r_eq <span class="main">[</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">,</span> r_const <span class="free">x</span><span class="main">]</span><span class="main">,</span> Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">r'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r<span class="main">(</span>1<span class="main">)</span> r'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">r'</span> <span class="main">[</span><span class="skolem">u</span><span class="main">]</span> <span class="main">=</span> eval <span class="main">(</span>r_lifz <span class="main">(</span>r_const <span class="skolem">y</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">[</span><span class="keyword1">if</span> <span class="skolem">u</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">,</span> <span class="skolem">u</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">u</span>
    <span class="keyword1"><span class="command">using</span></span> r'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> r<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">r'</span> <span class="main">[</span><span class="skolem">u</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">u</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">then</span> Some <span class="skolem">y</span> <span class="keyword1">else</span> eval <span class="skolem">r</span> <span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">u</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> r<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">r'</span> <span class="main">[</span><span class="skolem">u</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span>Some <span class="skolem">y</span><span class="main">)</span><span class="main">)</span> <span class="skolem">u</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">u</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> eval <span class="skolem">r'</span> <span class="main">[</span><span class="bound">u</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span><span class="main">(</span><span class="free">x</span><span class="main">:=</span>Some <span class="skolem">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> Some <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">r'</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> swap_P2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">𝒫<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">𝒫<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> eval <span class="skolem">r</span> <span class="main">[</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">]</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_swap <span class="skolem">r</span><span class="main">)</span> <span class="main">[</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">y</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="main">(</span>r_swap <span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_swap_recfn r<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> swap_R2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> swap_P2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> P2_total_imp_R2 R2_imp_P2 R2_imp_total2 total2E total2I<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> skip_P1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> eval <span class="skolem">r</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="main">1</span> <span class="skolem">r</span> <span class="main">[</span>Cn <span class="main">1</span> r_add <span class="main">[</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">,</span> r_const <span class="free">n</span><span class="main">]</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="var">?s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?s</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> eval <span class="skolem">r</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">+</span> <span class="free">n</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> r <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> r <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?s</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="var">?s</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> skip_R1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms skip_P1 R1_imp_total1 total1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Gödel numbering <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">φ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>\label{s:goedel_numbering}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹While the term \emph{Gödel numbering} is often used generically for
mappings between natural numbers and mathematical concepts, the inductive
inference literature uses it in a more specific sense. There it is equivalent
to the notion of acceptable numbering~\cite{Rogers87}: For every numbering
there is a recursive function mapping the numbering's indices to equivalent
ones of a Gödel numbering.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">goedel_numbering</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial2 <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">goedel_numbering</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∈</span> <span class="keyword1">𝒫<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">χ</span><span class="main">∈</span><span class="keyword1">𝒫<span class="hidden">⇧</span><sup>2</sup></span><span class="main">.</span> <span class="main">∃</span><span class="bound">c</span><span class="main">∈</span><span class="keyword1">ℛ</span><span class="main">.</span> <span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">χ</span> <span class="bound">i</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">(</span>the <span class="main">(</span><span class="bound">c</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> goedel_numbering_P2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"goedel_numbering <span class="free">ψ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">∈</span> <span class="keyword1">𝒫<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> goedel_numbering_def assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> goedel_numberingE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"goedel_numbering <span class="free">ψ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="main">∈</span> <span class="keyword1">𝒫<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">c</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">χ</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">ψ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">c</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms goedel_numbering_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> goedel_numbering_universal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"goedel_numbering <span class="free">ψ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="free">ψ</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">χ</span></span> <span class="main">::</span> <span class="quoted">partial2</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">χ</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">χ</span> <span class="main">∈</span> <span class="keyword1">𝒫<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rf</span></span> <span class="keyword2"><span class="keyword">where</span></span> rf<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">rf</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> eval <span class="skolem">rf</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> Cn <span class="numeral">2</span> <span class="skolem">rf</span> <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">x</span><span class="main">.</span> eval <span class="skolem">r</span> <span class="main">[</span><span class="bound">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> eval <span class="skolem">rf</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rf<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">with</span></span> rf<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">x</span><span class="main">.</span> eval <span class="skolem">r</span> <span class="main">[</span><span class="bound">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> r<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> χ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">χ</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">ψ</span> <span class="main">(</span>the <span class="main">(</span><span class="skolem">c</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> goedel_numbering_def assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> χ_def <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Our standard Gödel numbering is based on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">r_phi</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">phi</span> <span class="main">::</span> <span class="quoted">partial2</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">φ</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">φ</span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> eval r_phi <span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> phi_in_P2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">∈</span> <span class="keyword1">𝒫<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> phi_def <span class="keyword1"><span class="command">using</span></span> r_phi_recfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Indices of any numbering can be translated into equivalent indices
of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">phi</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, which thus is a Gödel numbering.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> numbering_translation_for_phi<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">∈</span> <span class="keyword1">𝒫<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">c</span><span class="main">∈</span><span class="keyword1">ℛ</span><span class="main">.</span> <span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">ψ</span> <span class="bound">i</span> <span class="main">=</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="bound">c</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">psi</span></span> <span class="keyword2"><span class="keyword">where</span></span> psi<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="skolem">psi</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">x</span><span class="main">.</span> eval <span class="skolem">psi</span> <span class="main">[</span><span class="bound">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> <span class="free">ψ</span> <span class="bound">i</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> numbering_translation <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"total <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="bound">x</span><span class="main">.</span> eval <span class="skolem">psi</span> <span class="main">[</span><span class="bound">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> eval r_phi <span class="main">[</span>the <span class="main">(</span>eval <span class="skolem">b</span> <span class="main">[</span><span class="bound">i</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">c</span> <span class="bound">i</span> <span class="main">=</span> eval <span class="skolem">b</span> <span class="main">[</span><span class="bound">i</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="main">=</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="skolem">c</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> phi_def psi<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="skolem">i</span> <span class="main">=</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="skolem">c</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> c<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> goedel_numbering_phi<span class="main">:</span> <span class="quoted"><span class="quoted">"goedel_numbering <span class="keyword1">φ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> goedel_numbering_def <span class="keyword1"><span class="command">using</span></span> numbering_translation_for_phi phi_in_P2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">corollary</span></span> phi_universal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">i</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">i</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> goedel_numbering_universal<span class="main">[</span><span class="operator">OF</span> goedel_numbering_phi assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Fixed-point theorems›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The fixed-point theorems look somewhat cleaner in the new
notation. We will only need the following ones in the next chapter.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> kleene_fixed_point<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">k</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">∈</span> <span class="keyword1">𝒫<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">i</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≥</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">i</span> <span class="main">=</span> <span class="free">ψ</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r_psi</span></span> <span class="keyword2"><span class="keyword">where</span></span> r_psi<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="skolem">r_psi</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">x</span><span class="main">.</span> eval <span class="skolem">r_psi</span> <span class="main">[</span><span class="bound">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> <span class="free">ψ</span> <span class="bound">i</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≥</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> eval r_phi <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> eval <span class="skolem">r_psi</span> <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> kleene_fixed_point_theorem <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="skolem">i</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">ψ</span> <span class="skolem">i</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> phi_def r_psi <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> i that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> smullyan_double_fixed_point<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">m</span> <span class="free">n</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">m</span> <span class="main">=</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">g</span> <span class="free">m</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">n</span> <span class="main">=</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">h</span> <span class="free">m</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rg</span></span> <span class="keyword2"><span class="keyword">where</span></span> rg<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="skolem">rg</span>"</span></span> <span class="quoted"><span class="quoted">"total <span class="skolem">rg</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> eval <span class="skolem">rg</span> <span class="main">[</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> R2E<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rh</span></span> <span class="keyword2"><span class="keyword">where</span></span> rh<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="skolem">rh</span>"</span></span> <span class="quoted"><span class="quoted">"total <span class="skolem">rh</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> eval <span class="skolem">rh</span> <span class="main">[</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> R2E<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> eval r_phi <span class="main">[</span><span class="skolem">m</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> eval r_phi <span class="main">[</span>the <span class="main">(</span>eval <span class="skolem">rg</span> <span class="main">[</span><span class="skolem">m</span><span class="main">,</span> <span class="skolem">n</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> eval r_phi <span class="main">[</span><span class="skolem">n</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> eval r_phi <span class="main">[</span>the <span class="main">(</span>eval <span class="skolem">rh</span> <span class="main">[</span><span class="skolem">m</span><span class="main">,</span> <span class="skolem">n</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> smullyan_double_fixed_point_theorem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">rg</span></span> <span class="quoted"><span class="skolem">rh</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="skolem">m</span> <span class="main">=</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">g</span> <span class="skolem">m</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="skolem">n</span> <span class="main">=</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">h</span> <span class="skolem">m</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> phi_def rg rh <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Inductive_Inference_Basics">
<div class="head">
<h1>Theory Inductive_Inference_Basics</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">chapter</span></span> <span class="quoted"><span class="plain_text">‹Inductive inference of recursive functions\label{c:iirf}›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Inductive_Inference_Basics
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Standard_Results.html">Standard_Results</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Inductive inference originates from work by
Solomonoff~\cite{s-ftiip1-64,s-ftiip2-64} and Gold~\cite{g-lil-67,g-lr-65}
and comes in many variations. The common theme is to infer additional
information about objects, such as formal languages or functions, from incomplete
data, such as finitely many words contained in the language or argument-value
pairs of the function. Oftentimes ``additional information'' means complete
information, such that the task becomes identification of the object.

The basic setting in inductive inference of recursive functions is as follows.
Let us denote, for a total function $f$, by $f^n$ the code of the list
$[f(0), ..., f(n)]$. Let $U$ be a set (called \emph{class}) of total
recursive functions, and $\psi$ a binary partial recursive function
(called \emph{hypothesis space}).
A partial recursive function $S$ (called \emph{strategy})
is said to \emph{learn $U$ in the limit with respect to $\psi$} if
for all $f \in U$,
\begin{itemize}
  \item the value $S(f^n)$ is defined for all $n\in\mathbb{N}$,
  \item the sequence $S(f^0), S(f^1), \ldots$ converges to an
    $i\in\mathbb{N}$ with $\psi_i = f$.
\end{itemize}

Both the output $S(f^n)$ of the strategy and its interpretation
as a function $\psi_{S(f^n)}$ are called \emph{hypothesis}. The set
of all classes learnable in the limit by $S$ with respect to $\psi$ is
denoted by $\mathrm{LIM}_\psi(S)$. Moreover we set $\mathrm{LIM}_\psi =
\bigcup_{S\in\mathcal{P}} \mathrm{LIM}_\psi(S)$ and $\mathrm{LIM} =
\bigcup_{\psi\in\mathcal{P}^2} \mathrm{LIM}_\psi$. We call the latter set the
\emph{inference type} $\mathrm{LIM}$.

Many aspects of this setting can be varied. We shall consider:
\begin{itemize}
  \item Intermediate hypotheses: $\psi_{S(f^n)}$ can be required to be total or
    to be in the class $U$, or to coincide with $f$ on arguments up to $n$, or
    a myriad of other conditions or combinations thereof.
  \item Convergence of hypotheses:
  \begin{itemize}
    \item The strategy can be required to output not a sequence but a single
      hypothesis, which must be correct.
    \item The strategy can be required to converge to a \emph{function} rather
      than an index.
  \end{itemize}
\end{itemize}

We formalize five kinds of results (<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ℐ›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ℐ'›</span></span></span></span> stand for
inference types):
\begin{itemize}
  \item Comparison of learning power: results of the form <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">ℐ</span></span>
    <span class="main"><span class="main">⊂</span></span> <span class="free"><span class="free">ℐ'</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, in particular showing that the inclusion is proper
    (Sections~\ref{s:fin_cp}, \ref{s:num_fin}, \ref{s:num_cp},
    \ref{s:num_total}, \ref{s:cons_lim}, \ref{s:lim_bc}, \ref{s:total_cons},
    \ref{s:r1_bc}).
  \item Whether <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ℐ›</span></span></span></span> is closed under the subset relation: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">U</span></span>
    <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">ℐ</span></span> <span class="main"><span class="main">∧</span></span> <span class="free"><span class="free">V</span></span> <span class="main"><span class="main">⊆</span></span> <span class="free"><span class="free">U</span></span> <span class="main"><span class="main">⟹</span></span> <span class="free"><span class="free">V</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">ℐ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
  \item Whether <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ℐ›</span></span></span></span> is closed under union: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">U</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">ℐ</span></span> <span class="main"><span class="main">∧</span></span>
    <span class="free"><span class="free">V</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">ℐ</span></span> <span class="main"><span class="main">⟹</span></span> <span class="free"><span class="free">U</span></span> <span class="main"><span class="main">∪</span></span> <span class="free"><span class="free">V</span></span> <span class="main"><span class="main">∈</span></span> <span class="free"><span class="free">ℐ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (Section~\ref{s:union}).
  \item Whether every class in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ℐ›</span></span></span></span> can be learned with respect to a
    Gödel numbering as hypothesis space (Section~\ref{s:inference_types}).
  \item Whether every class in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>ℐ›</span></span></span></span> can be learned by a \emph{total}
    recursive strategy (Section~\ref{s:lemma_r}).
\end{itemize}

The bulk of this chapter is devoted to the first category of results. Most
results that we are going to formalize have been called ``classical'' by
Jantke and Beick~\cite{jb-cpnii-81}, who compare a large number of inference
types. Another comparison is by Case and Smith~\cite{cs-cicmii-83}. Angluin
and Smith~\cite{as-ii-87} give an overview of various forms of inductive
inference.

All (interesting) proofs herein are based on my lecture notes of the
\emph{Induktive Inferenz} lectures by Rolf Wiehagen from 1999/2000 and
2000/2001 at the University of Kaiserslautern. I have given references to the
original proofs whenever I was able to find them. For the other proofs, as
well as for those that I had to contort beyond recognition, I provide proof
sketches.›</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Preliminaries›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Throughout the chapter, in particular in proof sketches, we use
the following notation.

Let $b\in\mathbb{N}^*$ be a list of numbers. We write $|b|$ for its length
and $b_i$ for the $i$-th element ($i=0,\dots, |b| - 1$). Concatenation of
numbers and lists works in the obvious way; for instance, $jbk$ with
$j,k\in\mathbb{N}$, $b\in\mathbb{N}^*$ refers to the list $jb_0\dots
b_{|b|-1}k$. For $0 \leq i &lt; |b|$, the term $b_{i:=v}$ denotes the list
$b_0\dots b_{i-1}vb_{i+1}\dots b_{|b|-1}$. The notation $b_{&lt;i}$ refers to
$b_0\dots b_{i-1}$ for $0 &lt; i \leq |b|$. Moreover, $v^n$ is short for the
list consisting of $n$ times the value $v \in \mathbb{N}$.

Unary partial functions can be regarded as infinite sequences consisting of
numbers and the symbol~$\uparrow$ denoting undefinedness. We abbreviate the
empty function by $\uparrow^\infty$ and the constant zero function by
$0^\infty$. A function can be written as a list concatenated with a partial
function. For example, $jb\uparrow^\infty$ is the function
\[
x \mapsto \left\{\begin{array}{ll}
  j        &amp; \mbox{if } x = 0,\\
  b_{x-1}  &amp; \mbox{if } 0 &lt; x \leq |b|,\\
  \uparrow &amp; \mbox{otherwise,}
\end{array}\right.
\]
and $jp$, where $p$ is a function, means
\[
x \mapsto \left\{\begin{array}{ll}
  j      &amp; \mbox{if } x = 0,\\
  p(x-1) &amp; \mbox{otherwise.}
\end{array}\right.
\]

A \emph{numbering} is a function $\psi \in \mathcal{P}^2$.›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The prefixes of a function›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A \emph{prefix}, also called \emph{initial segment}, is a list of
initial values of a function.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">prefix</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial1 <span class="main">⇒</span> nat <span class="main">⇒</span> nat list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">prefix</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> length_prefix <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>prefix <span class="free">f</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> prefix_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> prefix_nth <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> Suc <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"prefix <span class="free">f</span> <span class="free">n</span> <span class="main">!</span> <span class="free">k</span> <span class="main">=</span> the <span class="main">(</span><span class="free">f</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> prefix_def <span class="keyword1"><span class="command">using</span></span> assms nth_map_upt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">n</span>"</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> prefixI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">vs</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> length <span class="free">vs</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">↓=</span> <span class="free">vs</span> <span class="main">!</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"prefix <span class="free">f</span> <span class="main">(</span>length <span class="free">vs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">vs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms nth_equalityI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"prefix <span class="free">f</span> <span class="main">(</span>length <span class="free">vs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">vs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> prefixI'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">vs</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> Suc <span class="free">n</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">↓=</span> <span class="free">vs</span> <span class="main">!</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"prefix <span class="free">f</span> <span class="free">n</span> <span class="main">=</span> <span class="free">vs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms nth_equalityI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"prefix <span class="free">f</span> <span class="main">(</span>length <span class="free">vs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">vs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> prefixE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prefix <span class="free">f</span> <span class="main">(</span>length <span class="free">vs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">vs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">vs</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> length <span class="free">vs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">↓=</span> <span class="free">vs</span> <span class="main">!</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms length_prefix prefix_nth<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="quoted">"length <span class="free">vs</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> prefix_eqI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"prefix <span class="free">f</span> <span class="free">n</span> <span class="main">=</span> prefix <span class="free">g</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms prefix_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> prefix_0<span class="main">:</span> <span class="quoted"><span class="quoted">"prefix <span class="free">f</span> <span class="main">0</span> <span class="main">=</span> <span class="main">[</span>the <span class="main">(</span><span class="free">f</span> <span class="main">0</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> prefix_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> prefix_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"prefix <span class="free">f</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> prefix <span class="free">f</span> <span class="free">n</span> <span class="main">@</span> <span class="main">[</span>the <span class="main">(</span><span class="free">f</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> prefix_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> take_prefix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"prefix <span class="free">f</span> <span class="free">k</span> <span class="main">=</span> take <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="main">(</span>prefix <span class="free">f</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?vs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="main">(</span>prefix <span class="free">f</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?vs</span> <span class="main">=</span> Suc <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> length <span class="var">?vs</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">↓=</span> <span class="var">?vs</span> <span class="main">!</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> prefixI<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?vs</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?vs</span>"</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹length <span class="var">?vs</span> <span class="main">=</span> Suc <span class="free">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Strategies receive prefixes in the form of encoded lists. The
term ``prefix'' refers to both encoded and unencoded lists. We use the
notation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">"f ▹ n"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for the prefix $f^n$.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial1 <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">▹</span>"</span> 110<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">▹</span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> list_encode <span class="main">(</span>prefix <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> init_neq_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">▹</span> <span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> init_def prefix_def <span class="keyword1"><span class="command">using</span></span> list_encode_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> init_prefixE <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prefix <span class="free">f</span> <span class="free">n</span> <span class="main">=</span> prefix <span class="free">g</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">▹</span> <span class="free">n</span> <span class="main">=</span> <span class="free">g</span> <span class="main">▹</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> init_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> init_eqI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">▹</span> <span class="free">n</span> <span class="main">=</span> <span class="free">g</span> <span class="main">▹</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> init_def <span class="keyword1"><span class="command">using</span></span> prefix_eqI<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> initI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"e_length <span class="free">e</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> e_length <span class="free">e</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">↓=</span> e_nth <span class="free">e</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">▹</span> <span class="main">(</span>e_length <span class="free">e</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> init_def <span class="keyword1"><span class="command">using</span></span> assms prefixI <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> initI'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"e_length <span class="free">e</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span>  Suc <span class="free">n</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">↓=</span> e_nth <span class="free">e</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">▹</span> <span class="free">n</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> init_def <span class="keyword1"><span class="command">using</span></span> assms prefixI' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> init_iff_list_eq_upto<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"e_length <span class="free">vs</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span>e_length <span class="free">vs</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">↓=</span> e_nth <span class="free">vs</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟷</span> prefix <span class="free">f</span> <span class="main">(</span>e_length <span class="free">vs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> list_decode <span class="free">vs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> prefixI<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> prefixE<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> length_init <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"e_length <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> init_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> init_Suc_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">▹</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> e_snoc <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> init_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefix_Suc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nth_init<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> Suc <span class="free">n</span> <span class="main">⟹</span> e_nth <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> the <span class="main">(</span><span class="free">f</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> init_def <span class="keyword1"><span class="command">using</span></span> prefix_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> hd_init <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"e_hd <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span><span class="free">f</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> init_def <span class="keyword1"><span class="command">using</span></span> init_neq_zero <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> e_hd_nth0<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> list_decode_init <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"list_decode <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> prefix <span class="free">f</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> init_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> init_eq_iff_eq_upto<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span>Suc <span class="free">n</span><span class="main">.</span> <span class="free">g</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">j</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">g</span> <span class="main">▹</span> <span class="free">n</span> <span class="main">=</span> <span class="free">f</span> <span class="main">▹</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms initI' init_iff_list_eq_upto length_init list_decode_init
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_Suc_1 zero_less_Suc<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_init_of</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> partial1 <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_init_of</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>e_length <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">i</span> <span class="main">↓=</span> e_nth <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">i</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> not_initial_imp_not_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> Suc <span class="free">n</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">↓</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>is_init_of <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≠</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> is_init_of_def assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> all_init_eq_imp_fun_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="free">f</span> <span class="main">▹</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">g</span> <span class="main">▹</span> <span class="bound">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefix <span class="free">f</span> <span class="skolem">n</span> <span class="main">=</span> prefix <span class="free">g</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> init_def list_decode_encode<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="free">f</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span><span class="free">g</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> init_def prefix_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">n</span> <span class="main">=</span> <span class="free">g</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> R1_imp_total1 option.expand total1E<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> neq_fun_neq_init<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≠</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">f</span> <span class="main">▹</span> <span class="bound">n</span> <span class="main">≠</span> <span class="free">g</span> <span class="main">▹</span> <span class="bound">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms all_init_eq_imp_fun_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> eq_init_forall_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">▹</span> <span class="free">n</span> <span class="main">=</span> <span class="free">g</span> <span class="main">▹</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">▹</span> <span class="free">m</span> <span class="main">=</span> <span class="free">g</span> <span class="main">▹</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefix <span class="free">f</span> <span class="free">n</span> <span class="main">=</span> prefix <span class="free">g</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> init_def list_decode_encode<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="free">f</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span><span class="free">g</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">using</span></span> prefix_def that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="free">f</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span><span class="free">g</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefix <span class="free">f</span> <span class="free">m</span> <span class="main">=</span> prefix <span class="free">g</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prefix_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> neq_init_forall_ge<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">▹</span> <span class="free">n</span> <span class="main">≠</span> <span class="free">g</span> <span class="main">▹</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≥</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">▹</span> <span class="free">m</span> <span class="main">≠</span> <span class="free">g</span> <span class="main">▹</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> eq_init_forall_le assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> e_take_init<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> Suc <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"e_take <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">▹</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms take_prefix <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_def less_Suc_eq_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> init_butlast_init<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"total1 <span class="free">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">▹</span> <span class="free">n</span> <span class="main">=</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">▹</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> e_butlast <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"e_butlast <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_length <span class="free">e</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"e_length <span class="var">?e</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">▹</span> <span class="main">(</span>e_length <span class="var">?e</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?e</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> initI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> e_length <span class="var">?e</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> len <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> e_length <span class="free">e</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">↓=</span> e_nth <span class="free">e</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> total1_def <span class="quoted"><span class="quoted">‹e_length <span class="free">e</span> <span class="main">=</span> Suc <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> e_length <span class="var">?e</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">↓=</span> e_nth <span class="var">?e</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> butlast_conv_take<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> len <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Some definitions make use of recursive predicates, that is,
$01$-valued functions.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">RPred1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial1 set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ℛ<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ℛ<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">↓=</span> <span class="main">0</span> <span class="main">∨</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">↓=</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> RPred1_subseteq_R1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℛ<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊆</span> <span class="keyword1">ℛ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> RPred1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> const0_in_RPred1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Some <span class="main">0</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> RPred1_def const_in_Prim1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> RPred1_altdef<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℛ<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">{</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℛ<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="var">?S</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℛ<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⊆</span> <span class="var">?S</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span>
    <span class="keyword3"><span class="command">assume</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> RPred1_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> f <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">↓=</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">↓=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> RPred1_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eq_refl less_Suc_eq_le zero_less_Suc option.sel<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">⊆</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span>
    <span class="keyword3"><span class="command">assume</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> total<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">↓</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> f <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> the <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> the <span class="main">(</span><span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_eq_less_or_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> total <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">↓=</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="main">↓=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.collapse<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>›</span></span> RPred1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹NUM›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A class of recursive functions is in NUM if it can be
embedded in a total numbering. Thus, for learning such classes there is
always a total hypothesis space available.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">NUM</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial1 set set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">NUM</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">U</span><span class="main">.</span> <span class="main">∃</span><span class="bound">ψ</span><span class="main">∈</span><span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span><span class="main">.</span> <span class="main">∀</span><span class="bound">f</span><span class="main">∈</span><span class="bound">U</span><span class="main">.</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="bound">ψ</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">f</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">NUM_wrt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial2 <span class="main">⇒</span> partial1 set set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">⟹</span> <span class="free">NUM_wrt</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">U</span><span class="main">.</span> <span class="main">∀</span><span class="bound">f</span><span class="main">∈</span><span class="bound">U</span><span class="main">.</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">f</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> NUM_I <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="free">ψ</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">∈</span> NUM"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms NUM_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> NUM_E <span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">∈</span> NUM"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">⊆</span> <span class="keyword1">ℛ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ψ</span><span class="main">∈</span><span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span><span class="main">.</span> <span class="main">∀</span><span class="bound">f</span><span class="main">∈</span><span class="free">U</span><span class="main">.</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="bound">ψ</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> NUM_def assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> NUM_closed_subseteq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">∈</span> NUM"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">⊆</span> <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">∈</span> NUM"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms subset_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">U</span></span><span class="main">]</span> NUM_I <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This is the classical diagonalization proof showing that there is
no total numbering containing all total recursive functions.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> R1_not_in_NUM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℛ</span> <span class="main">∉</span> NUM"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℛ</span> <span class="main">∈</span> NUM"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ψ</span></span> <span class="keyword2"><span class="keyword">where</span></span> num<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span><span class="main">∈</span><span class="keyword1">ℛ</span><span class="main">.</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">ψ</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">psi</span></span> <span class="keyword2"><span class="keyword">where</span></span> psi<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="skolem">psi</span>"</span></span> <span class="quoted"><span class="quoted">"total <span class="skolem">psi</span>"</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">psi</span> <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">ψ</span> <span class="skolem">i</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> Cn <span class="main">1</span> S <span class="main">[</span>Cn <span class="main">1</span> <span class="skolem">psi</span> <span class="main">[</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">,</span> Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">d</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> psi<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="skolem">d</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="main">(</span>the <span class="main">(</span><span class="skolem">ψ</span> <span class="skolem">x</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">unfolding</span></span> d_def <span class="keyword1"><span class="command">using</span></span> num psi <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> eval <span class="skolem">d</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> R1I <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> eval <span class="skolem">d</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> num<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="skolem">i</span> <span class="skolem">i</span> <span class="main">=</span> eval <span class="skolem">d</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> d <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="skolem">i</span> <span class="skolem">i</span> <span class="main">↓=</span> Suc <span class="main">(</span>the <span class="main">(</span><span class="skolem">ψ</span> <span class="skolem">i</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> option.sel<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>the <span class="main">(</span><span class="skolem">ψ</span> <span class="skolem">i</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A hypothesis space that contains a function for every prefix will
come in handy. The following is a total numbering with this property.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_prenum</span> <span class="main">≡</span>
  Cn <span class="numeral">2</span> r_ifless <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">1</span><span class="main">,</span> Cn <span class="numeral">2</span> r_length <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span> Cn <span class="numeral">2</span> r_nth <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">,</span> r_constn <span class="main">1</span> <span class="main">0</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_prenum_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="numeral">2</span> r_prenum"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_prenum_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> r_prenum <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"eval r_prenum <span class="main">[</span><span class="free">e</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">&lt;</span> e_length <span class="free">e</span> <span class="keyword1">then</span> e_nth <span class="free">e</span> <span class="free">x</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_prenum_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">prenum</span> <span class="main">::</span> <span class="quoted">partial2</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">prenum</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> Some <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> e_length <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="keyword1">then</span> e_nth <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prenum_in_R2<span class="main">:</span> <span class="quoted"><span class="quoted">"prenum <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> prenum_def Prim2I<span class="main">[</span><span class="operator">OF</span> r_prenum_prim<span class="main">,</span> <span class="operator">of</span> <span class="quoted">prenum</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> prenum <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prenum <span class="free">e</span> <span class="free">x</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">&lt;</span> e_length <span class="free">e</span> <span class="keyword1">then</span> e_nth <span class="free">e</span> <span class="free">x</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> prenum_def <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prenum_encode<span class="main">:</span>
  <span class="quoted"><span class="quoted">"prenum <span class="main">(</span>list_encode <span class="free">vs</span><span class="main">)</span> <span class="free">x</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">&lt;</span> length <span class="free">vs</span> <span class="keyword1">then</span> <span class="free">vs</span> <span class="main">!</span> <span class="free">x</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> prenum_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> length <span class="free">vs</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Prepending a list of numbers to a function:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">prepend</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> partial1 <span class="main">⇒</span> partial1"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">⊙</span>"</span> 64<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main"><span class="free">⊙</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="main">!</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> length <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prepend <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">vs</span> <span class="main">⊙</span> <span class="free">f</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">&lt;</span> length <span class="free">vs</span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="free">vs</span> <span class="main">!</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">f</span> <span class="main">(</span><span class="free">x</span> <span class="main">-</span> length <span class="free">vs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> prepend_def <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prepend_total<span class="main">:</span> <span class="quoted"><span class="quoted">"total1 <span class="free">f</span> <span class="main">⟹</span> total1 <span class="main">(</span><span class="free">vs</span> <span class="main">⊙</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> total1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> prepend_at_less<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">vs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">vs</span> <span class="main">⊙</span> <span class="free">f</span><span class="main">)</span> <span class="free">n</span> <span class="main">↓=</span> <span class="free">vs</span> <span class="main">!</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> prepend_at_ge<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> length <span class="free">vs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">vs</span> <span class="main">⊙</span> <span class="free">f</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> length <span class="free">vs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> prefix_prepend_less<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">vs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"prefix <span class="main">(</span><span class="free">vs</span> <span class="main">⊙</span> <span class="free">f</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> take <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">vs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms length_prefix <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> nth_equalityI<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> prepend_eqI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> length <span class="free">vs</span> <span class="main">⟹</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">↓=</span> <span class="free">vs</span> <span class="main">!</span> <span class="bound">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">g</span> <span class="main">(</span>length <span class="free">vs</span> <span class="main">+</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">=</span> <span class="free">vs</span> <span class="main">⊙</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">vs</span> <span class="main">⊙</span> <span class="free">f</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> length <span class="free">vs</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms prepend <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_diff_inverse_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">r_prepend</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> recf <span class="main">⇒</span> recf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">r_prepend</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">r_prepend</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span>
     Cn <span class="main">1</span> <span class="main">(</span>r_lifz <span class="main">(</span>r_const <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">(</span>Cn <span class="main">1</span> <span class="main">(</span><span class="free">r_prepend</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">[</span>r_dec<span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">,</span> Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_prepend_recfn<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="main">(</span>r_prepend <span class="free">vs</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">vs</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> r_prepend<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_prepend <span class="free">vs</span> <span class="free">r</span><span class="main">)</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">&lt;</span> length <span class="free">vs</span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="free">vs</span> <span class="main">!</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">else</span> eval <span class="free">r</span> <span class="main">[</span><span class="free">x</span> <span class="main">-</span> length <span class="free">vs</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">vs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">v</span> <span class="skolem">vs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_prepend_recfn<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_prepend_total<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"total <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_prepend <span class="free">vs</span> <span class="free">r</span><span class="main">)</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">↓=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">&lt;</span> length <span class="free">vs</span> <span class="keyword1">then</span> <span class="free">vs</span> <span class="main">!</span> <span class="free">x</span> <span class="keyword1">else</span> the <span class="main">(</span>eval <span class="free">r</span> <span class="main">[</span><span class="free">x</span> <span class="main">-</span> length <span class="free">vs</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">vs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">v</span> <span class="skolem">vs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_prepend_recfn<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prepend_in_P1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">vs</span> <span class="main">⊙</span> <span class="free">f</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">r</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> eval <span class="skolem">r</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="main">(</span>r_prepend <span class="free">vs</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r r_prepend_recfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_prepend <span class="free">vs</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="free">vs</span> <span class="main">⊙</span> <span class="free">f</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> r r_prepend <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prepend_in_R1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">vs</span> <span class="main">⊙</span> <span class="free">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"total <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> eval <span class="skolem">r</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"total1 <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> R1_imp_total1<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"total <span class="main">(</span>r_prepend <span class="free">vs</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r r_prepend_total r_prepend_recfn totalI1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"r_prepend <span class="free">vs</span> <span class="skolem">r</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> r <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"total <span class="main">(</span>r_prepend <span class="free">vs</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="main">(</span>r_prepend <span class="free">vs</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r r_prepend_recfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_prepend <span class="free">vs</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="free">vs</span> <span class="main">⊙</span> <span class="free">f</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> r r_prepend <span class="quoted"><span class="quoted">‹total1 <span class="free">f</span>›</span></span> total1E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prepend_associative<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">us</span> <span class="main">@</span> <span class="free">vs</span><span class="main">)</span> <span class="main">⊙</span> <span class="free">f</span> <span class="main">=</span> <span class="free">us</span> <span class="main">⊙</span> <span class="free">vs</span> <span class="main">⊙</span> <span class="free">f</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">consider</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> length <span class="free">us</span>"</span></span>
    <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> length <span class="free">us</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">us</span> <span class="main">@</span> <span class="free">vs</span><span class="main">)</span>"</span></span>
    <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> length <span class="main">(</span><span class="free">us</span> <span class="main">@</span> <span class="free">vs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="skolem">x</span> <span class="main">=</span> <span class="var">?rhs</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_add1 length_append less_le_trans nth_append prepend_at_less<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> add_diff_inverse_nat add_less_cancel_left length_append nth_append prepend<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 3
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> prepend_at_ge <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">constant_divergent</span> <span class="main">::</span> <span class="quoted">partial1</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">↑<span class="hidden">⇧</span><sup>∞</sup></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">↑<span class="hidden">⇧</span><sup>∞</sup></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> None"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">constant_zero</span> <span class="main">::</span> <span class="quoted">partial1</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">0<span class="hidden">⇧</span><sup>∞</sup></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">0<span class="hidden">⇧</span><sup>∞</sup></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Some <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> almost0_in_R1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">vs</span> <span class="main">⊙</span> <span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> RPred1_subseteq_R1 const0_in_RPred1 prepend_in_R1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The class $U_0$ of all total recursive functions that are almost
everywhere zero will be used several times to construct
(counter-)examples.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">U0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial1 set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">U<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">vs</span> <span class="main">⊙</span> <span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">|</span><span class="bound">vs</span><span class="main">.</span> <span class="bound">vs</span> <span class="main">∈</span> UNIV<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The class <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">U0</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> contains exactly the functions in the
numbering <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">prenum</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> U0_altdef<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="main">{</span>prenum <span class="bound">e</span><span class="main">|</span> <span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> UNIV<span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="var">?W</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊆</span> <span class="var">?W</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> U0_def <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">vs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="skolem">vs</span> <span class="main">⊙</span> <span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> prenum <span class="main">(</span>list_encode <span class="skolem">vs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prenum_encode <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="var">?W</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?W</span> <span class="main">⊆</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> U0_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> U0_in_NUM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> NUM"</span></span>
  <span class="keyword1"><span class="command">using</span></span> prenum_in_R2 U0_altdef <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> NUM_I<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">prenum</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Every almost-zero function can be represented by $v0^\infty$ for
a list $v$ not ending in zero.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> almost0_canonical<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">vs</span> <span class="main">⊙</span> <span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≠</span> <span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">ws</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ws</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"last <span class="free">ws</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">ws</span> <span class="main">⊙</span> <span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="free">vs</span> <span class="main">∧</span> <span class="free">vs</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">vs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span>length <span class="free">vs</span><span class="main">.</span> <span class="free">vs</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> Greatest <span class="var">?P</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">≤</span> length <span class="free">vs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex GreatestI_ex_nat<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="quoted"><span class="quoted">"length <span class="free">vs</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> not_gr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?P</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&gt;</span> <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">using</span></span> Greatest_le_nat<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">_</span> <span class="quoted"><span class="quoted">"length <span class="free">vs</span>"</span></span><span class="main">]</span> m_def ex le not_less that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ws</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="free">vs</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">vs</span> <span class="main">⊙</span> <span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">=</span> <span class="var">?ws</span> <span class="main">⊙</span> <span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">vs</span> <span class="main">⊙</span> <span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="var">?ws</span> <span class="main">⊙</span> <span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> Suc <span class="skolem">m</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?ws</span> <span class="main">⊙</span> <span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span><span class="main">)</span> <span class="skolem">x</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> not_gr <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> length <span class="free">vs</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="var">?ws</span> <span class="main">⊙</span> <span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?ws</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">vs</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"last <span class="var">?ws</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">m</span>›</span></span> take_Suc_conv_app_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Types of inference\label{s:inference_types}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This section introduces all inference types that we are going to
consider together with some of their simple properties. All these inference
types share the following condition, which essentially says that everything
must be computable:›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">environment</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial2 <span class="main">⇒</span> <span class="main">(</span>partial1 set<span class="main">)</span> <span class="main">⇒</span> partial1 <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">environment</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∈</span> <span class="keyword1">𝒫<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">⊆</span> <span class="keyword1">ℛ</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∈</span> <span class="keyword1">𝒫</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">f</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹LIM: Learning in the limit›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A strategy $S$ learns a class $U$ in the limit with respect to a
hypothesis space <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">ψ</span></span> <span class="main"><span class="main">∈</span></span> <span class="keyword1"><span class="keyword1">𝒫<span class="hidden">⇧</span><sup>2</sup></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> if for all $f\in U$, the
sequence $(S(f^n))_{n\in\mathbb{N}}$ converges to an $i$ with $\psi_i = f$.
Convergence for a sequence of natural numbers means that almost all elements
are the same. We express this with the following notation.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Almost_All</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">binder</span></span> <span class="quoted">"<span class="keyword1">∀<span class="hidden">⇧</span><sup>∞</sup></span>"</span> 10<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">∀<span class="hidden">⇧</span><sup>∞</sup></span></span><span class="bound">n</span><span class="main"><span class="free">.</span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">n</span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">n</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">learn_lim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial2 <span class="main">⇒</span> <span class="main">(</span>partial1 set<span class="main">)</span> <span class="main">⇒</span> partial1 <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">learn_lim</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span>
     environment <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">f</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">.</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> learn_limE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"learn_lim <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"environment <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="free">ψ</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> <span class="free">s</span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms learn_lim_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> learn_limI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"environment <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="free">ψ</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> <span class="free">s</span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"learn_lim <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms learn_lim_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">LIM_wrt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial2 <span class="main">⇒</span> partial1 set set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">LIM_wrt</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">U</span><span class="main">.</span> <span class="main">∃</span><span class="bound">s</span><span class="main">.</span> learn_lim <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="bound">U</span> <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Lim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial1 set set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">LIM</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">LIM</span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">U</span><span class="main">.</span> <span class="main">∃</span><span class="bound">ψ</span> <span class="bound">s</span><span class="main">.</span> learn_lim <span class="bound">ψ</span> <span class="bound">U</span> <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹LIM is closed under the the subset relation.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> learn_lim_closed_subseteq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"learn_lim <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">⊆</span> <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"learn_lim <span class="free">ψ</span> <span class="free">V</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms learn_lim_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> LIM_closed_subseteq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">∈</span> <span class="keyword1">LIM</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">⊆</span> <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">∈</span> <span class="keyword1">LIM</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms learn_lim_closed_subseteq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Lim_def mem_Collect_eq<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Changing the hypothesis infinitely often precludes learning in
the limit.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> infinite_hyp_changes_not_Lim<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">m<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main">&gt;</span><span class="bound">n</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">m<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">&gt;</span><span class="bound">n</span><span class="main">.</span> <span class="free">s</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="bound">m<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">≠</span> <span class="free">s</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="bound">m<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> learn_lim <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms learn_lim_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_imp_le<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> always_hyp_change_not_Lim<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">s</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="main">(</span>Suc <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="free">s</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> learn_lim <span class="free">ψ</span> <span class="main">{</span><span class="free">f</span><span class="main">}</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms learn_limE <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_SucI order_refl singletonI<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Guessing a wrong hypothesis infinitely often precludes learning
in the limit.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> infinite_hyp_wrong_not_Lim<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">m</span></span><span class="main">&gt;</span><span class="bound">n</span><span class="main">.</span> <span class="free">ψ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> learn_lim <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms learn_limE <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_imp_le option.sel<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Converging to the same hypothesis on two functions precludes
learning in the limit.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> same_hyp_for_two_not_Lim<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> <span class="free">U</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> <span class="free">U</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≠</span> <span class="free">f<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="free">n<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="free">s</span> <span class="main">(</span><span class="free">f<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">h</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="free">n<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="free">s</span> <span class="main">(</span><span class="free">f<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> learn_lim <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms learn_limE <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_cases option.sel<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Every class that can be learned in the limit can be learned in
the limit with respect to any Gödel numbering. We prove a generalization in
which hypotheses may have to satisfy an extra condition, so we can re-use it
for other inference types later.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> learn_lim_extra_wrt_goedel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">extra</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>partial1 set<span class="main">)</span> <span class="main">⇒</span> partial1 <span class="main">⇒</span> nat <span class="main">⇒</span> partial1 <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"goedel_numbering <span class="free">χ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"learn_lim <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">⟹</span> <span class="free">extra</span> <span class="free">U</span> <span class="bound">f</span> <span class="bound">n</span> <span class="main">(</span><span class="free">ψ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span> learn_lim <span class="free">χ</span> <span class="free">U</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">f</span><span class="main">∈</span><span class="free">U</span><span class="main">.</span> <span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="free">extra</span> <span class="free">U</span> <span class="bound">f</span> <span class="bound">n</span> <span class="main">(</span><span class="free">χ</span> <span class="main">(</span>the <span class="main">(</span><span class="bound">t</span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> env<span class="main">:</span> <span class="quoted"><span class="quoted">"environment <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> lim<span class="main">:</span> <span class="quoted"><span class="quoted">"learn_lim <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> extra<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span><span class="main">∈</span><span class="free">U</span><span class="main">.</span> <span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="free">extra</span> <span class="free">U</span> <span class="bound">f</span> <span class="bound">n</span> <span class="main">(</span><span class="free">ψ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms learn_limE <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">ψ</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">χ</span> <span class="main">(</span>the <span class="main">(</span><span class="skolem">c</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> env goedel_numberingE<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">ψ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≡</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">s</span> <span class="bound">x</span> <span class="main">↓</span> <span class="main">∧</span> <span class="skolem">c</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">↓</span> <span class="keyword1">then</span> Some <span class="main">(</span>the <span class="main">(</span><span class="skolem">c</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> t_def <span class="keyword1"><span class="command">using</span></span> env c concat_P1_P1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">c</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">s</span> <span class="skolem">x</span> <span class="main">↓</span> <span class="keyword1">then</span> Some <span class="main">(</span>the <span class="main">(</span><span class="skolem">c</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> t_def c<span class="main">(</span>1<span class="main">)</span> R1_imp_total1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">↓=</span> the <span class="main">(</span><span class="skolem">c</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">using</span></span> lim learn_limE that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"learn_lim <span class="free">χ</span> <span class="free">U</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> learn_limI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"environment <span class="free">χ</span> <span class="free">U</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>›</span></span> env goedel_numbering_P2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="free">χ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> <span class="skolem">t</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> lim learn_limE<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span>
        i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="free">s</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">∈</span> <span class="free">U</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?j</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="skolem">c</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="var">?j</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> c<span class="main">(</span>2<span class="main">)</span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="var">?j</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">∈</span> <span class="free">U</span>›</span></span> i t that<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">extra</span> <span class="free">U</span> <span class="skolem">f</span> <span class="skolem">n</span> <span class="main">(</span><span class="free">χ</span> <span class="main">(</span>the <span class="main">(</span><span class="skolem">t</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span> <span class="skolem">n</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> t <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="skolem">t</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span><span class="skolem">c</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="main">(</span>the <span class="main">(</span><span class="skolem">t</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">ψ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> c<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> extra <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> learn_lim_wrt_goedel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"goedel_numbering <span class="free">χ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"learn_lim <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span> learn_lim <span class="free">χ</span> <span class="free">U</span> <span class="bound">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms learn_lim_extra_wrt_goedel<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?extra</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">U</span> <span class="bound">f</span> <span class="bound">n</span> <span class="bound">h</span><span class="main">.</span> True"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> LIM_wrt_phi_eq_Lim<span class="main">:</span> <span class="quoted"><span class="quoted">"LIM_wrt <span class="keyword1">φ</span> <span class="main">=</span> <span class="keyword1">LIM</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> LIM_wrt_def Lim_def learn_lim_wrt_goedel<span class="main">[</span><span class="operator">OF</span> goedel_numbering_phi<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹BC: Behaviorally correct learning in the limit›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Behaviorally correct learning in the limit relaxes LIM by
requiring that the strategy almost always output an index for the target
function, but not necessarily the same index. In other words convergence of
$(S(f^n))_{n\in\mathbb{N}}$ is replaced by convergence of
$(\psi_{S(f^n)})_{n\in\mathbb{N}}$.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">learn_bc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial2 <span class="main">⇒</span> <span class="main">(</span>partial1 set<span class="main">)</span> <span class="main">⇒</span> partial1 <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">learn_bc</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> 
     environment <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">f</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">.</span> <span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="bound">f</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> learn_bcE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"learn_bc <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"environment <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">⟹</span> <span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> <span class="free">ψ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="bound">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms learn_bc_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> learn_bcI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"environment <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">⟹</span> <span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> <span class="free">ψ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="bound">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"learn_bc <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms learn_bc_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">BC_wrt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial2 <span class="main">⇒</span> partial1 set set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">BC_wrt</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">U</span><span class="main">.</span> <span class="main">∃</span><span class="bound">s</span><span class="main">.</span> learn_bc <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="bound">U</span> <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">BC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial1 set set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">BC</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">U</span><span class="main">.</span> <span class="main">∃</span><span class="bound">ψ</span> <span class="bound">s</span><span class="main">.</span> learn_bc <span class="bound">ψ</span> <span class="bound">U</span> <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹BC is a superset of LIM and closed under the subset relation.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> learn_lim_imp_BC<span class="main">:</span> <span class="quoted"><span class="quoted">"learn_lim <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span> <span class="main">⟹</span> learn_bc <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> learn_limE learn_bcI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ψ</span></span> <span class="quoted"><span class="free">U</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> Lim_subseteq_BC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">LIM</span> <span class="main">⊆</span> BC"</span></span>
  <span class="keyword1"><span class="command">using</span></span> learn_lim_imp_BC Lim_def BC_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> learn_bc_closed_subseteq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"learn_bc <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">⊆</span> <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"learn_bc <span class="free">ψ</span> <span class="free">V</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms learn_bc_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> BC_closed_subseteq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">∈</span> BC"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">⊆</span> <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">∈</span> BC"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> BC_def learn_bc_closed_subseteq mem_Collect_eq<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Just like with LIM, guessing a wrong hypothesis infinitely often
precludes BC-style learning.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> infinite_hyp_wrong_not_BC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">m</span></span><span class="main">&gt;</span><span class="bound">n</span><span class="main">.</span> <span class="free">ψ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> learn_bc <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"learn_bc <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="free">ψ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> learn_bcE assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> less_imp_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The proof that Gödel numberings suffice as hypothesis spaces for
BC is similar to the one for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] learn_lim_extra_wrt_goedel<span class="antiquote"><span class="antiquote">}</span></span></span></span>. We do
not need the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">extra</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> part for BC, but we get it for free.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> learn_bc_extra_wrt_goedel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">extra</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>partial1 set<span class="main">)</span> <span class="main">⇒</span> partial1 <span class="main">⇒</span> nat <span class="main">⇒</span> partial1 <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"goedel_numbering <span class="free">χ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"learn_bc <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">⟹</span> <span class="free">extra</span> <span class="free">U</span> <span class="bound">f</span> <span class="bound">n</span> <span class="main">(</span><span class="free">ψ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span> learn_bc <span class="free">χ</span> <span class="free">U</span> <span class="bound">t</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">f</span><span class="main">∈</span><span class="free">U</span><span class="main">.</span> <span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="free">extra</span> <span class="free">U</span> <span class="bound">f</span> <span class="bound">n</span> <span class="main">(</span><span class="free">χ</span> <span class="main">(</span>the <span class="main">(</span><span class="bound">t</span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> env<span class="main">:</span> <span class="quoted"><span class="quoted">"environment <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> lim<span class="main">:</span> <span class="quoted"><span class="quoted">"learn_bc <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> extra<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">f</span><span class="main">∈</span><span class="free">U</span><span class="main">.</span> <span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="free">extra</span> <span class="free">U</span> <span class="bound">f</span> <span class="bound">n</span> <span class="main">(</span><span class="free">ψ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms learn_bc_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">ψ</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">χ</span> <span class="main">(</span>the <span class="main">(</span><span class="skolem">c</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> env goedel_numberingE<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">ψ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">s</span> <span class="bound">x</span> <span class="main">↓</span> <span class="main">∧</span> <span class="skolem">c</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">↓</span> <span class="keyword1">then</span> Some <span class="main">(</span>the <span class="main">(</span><span class="skolem">c</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> t_def <span class="keyword1"><span class="command">using</span></span> env c concat_P1_P1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">c</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">s</span> <span class="skolem">x</span> <span class="main">↓</span> <span class="keyword1">then</span> Some <span class="main">(</span>the <span class="main">(</span><span class="skolem">c</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> t_def c<span class="main">(</span>1<span class="main">)</span> R1_imp_total1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">↓=</span> the <span class="main">(</span><span class="skolem">c</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">using</span></span> lim learn_bcE<span class="main">(</span>1<span class="main">)</span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"learn_bc <span class="free">χ</span> <span class="free">U</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> learn_bcI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"environment <span class="free">χ</span> <span class="free">U</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>›</span></span> env goedel_numbering_P2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> <span class="free">χ</span> <span class="main">(</span>the <span class="main">(</span><span class="skolem">t</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="free">ψ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> lim learn_bcE<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">∈</span> <span class="free">U</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that t c<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">extra</span> <span class="free">U</span> <span class="skolem">f</span> <span class="skolem">n</span> <span class="main">(</span><span class="free">χ</span> <span class="main">(</span>the <span class="main">(</span><span class="skolem">t</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span> <span class="skolem">n</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> t <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="skolem">t</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span><span class="skolem">c</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="main">(</span>the <span class="main">(</span><span class="skolem">t</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">ψ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> c<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> extra <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> learn_bc_wrt_goedel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"goedel_numbering <span class="free">χ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"learn_bc <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span> learn_bc <span class="free">χ</span> <span class="free">U</span> <span class="bound">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms learn_bc_extra_wrt_goedel<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?extra</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">corollary</span></span> BC_wrt_phi_eq_BC<span class="main">:</span> <span class="quoted"><span class="quoted">"BC_wrt <span class="keyword1">φ</span> <span class="main">=</span> BC"</span></span>
  <span class="keyword1"><span class="command">using</span></span> learn_bc_wrt_goedel goedel_numbering_phi BC_def BC_wrt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹CONS: Learning in the limit with consistent hypotheses›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A hypothesis is \emph{consistent} if it matches all values in the
prefix given to the strategy. Consistent learning in the limit requires the
strategy to output only consistent hypotheses for prefixes from the class.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">learn_cons</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial2 <span class="main">⇒</span> <span class="main">(</span>partial1 set<span class="main">)</span> <span class="main">⇒</span> partial1 <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">learn_cons</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span>
     learn_lim <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">f</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">≤</span><span class="bound">n</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">k</span> <span class="main">=</span> <span class="bound">f</span> <span class="bound">k</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">CONS_wrt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial2 <span class="main">⇒</span> partial1 set set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">CONS_wrt</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">U</span><span class="main">.</span> <span class="main">∃</span><span class="bound">s</span><span class="main">.</span> learn_cons <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="bound">U</span> <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">CONS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial1 set set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">CONS</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">U</span><span class="main">.</span> <span class="main">∃</span><span class="bound">ψ</span> <span class="bound">s</span><span class="main">.</span> learn_cons <span class="bound">ψ</span> <span class="bound">U</span> <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> CONS_subseteq_Lim<span class="main">:</span> <span class="quoted"><span class="quoted">"CONS <span class="main">⊆</span> <span class="keyword1">LIM</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> CONS_def Lim_def learn_cons_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> learn_consI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"environment <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="free">ψ</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> <span class="free">s</span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">≤</span><span class="bound">n</span><span class="main">.</span> <span class="free">ψ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">k</span> <span class="main">=</span> <span class="bound">f</span> <span class="bound">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"learn_cons <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms learn_lim_def learn_cons_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If a consistent strategy converges, it automatically converges to
a correct hypothesis. Thus we can remove <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">ψ</span></span> <span class="free"><span class="free">i</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">f</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> from the second
assumption in the previous lemma.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> learn_consI2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"environment <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> <span class="free">s</span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="bound">i</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">≤</span><span class="bound">n</span><span class="main">.</span> <span class="free">ψ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">k</span> <span class="main">=</span> <span class="bound">f</span> <span class="bound">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"learn_cons <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> learn_consI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"environment <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">≤</span><span class="bound">n</span><span class="main">.</span> <span class="free">ψ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">k</span> <span class="main">=</span> <span class="bound">f</span> <span class="bound">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="free">ψ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> <span class="free">s</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> that assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> i_n0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="free">s</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> i_n0 cons that <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">≤</span><span class="skolem">x</span><span class="main">.</span> <span class="free">ψ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">k</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">k</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> cons that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> i_n0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> i_n0 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> learn_consE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"learn_cons <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"environment <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">i</span> <span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="free">ψ</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="free">s</span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">≤</span><span class="bound">n</span><span class="main">.</span> <span class="free">ψ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">k</span> <span class="main">=</span> <span class="bound">f</span> <span class="bound">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms learn_cons_def learn_lim_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> learn_cons_wrt_goedel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"goedel_numbering <span class="free">χ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"learn_cons <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span> learn_cons <span class="free">χ</span> <span class="free">U</span> <span class="bound">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> learn_cons_def assms
    learn_lim_extra_wrt_goedel<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?extra</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">U</span> <span class="bound">f</span> <span class="bound">n</span> <span class="bound">h</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">≤</span><span class="bound">n</span><span class="main">.</span> <span class="bound">h</span> <span class="bound">k</span> <span class="main">=</span> <span class="bound">f</span> <span class="bound">k</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> CONS_wrt_phi_eq_CONS<span class="main">:</span> <span class="quoted"><span class="quoted">"CONS_wrt <span class="keyword1">φ</span> <span class="main">=</span> CONS"</span></span>
  <span class="keyword1"><span class="command">using</span></span> CONS_wrt_def CONS_def learn_cons_wrt_goedel goedel_numbering_phi
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> learn_cons_closed_subseteq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"learn_cons <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">⊆</span> <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"learn_cons <span class="free">ψ</span> <span class="free">V</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms learn_cons_def learn_lim_closed_subseteq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> CONS_closed_subseteq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">∈</span> CONS"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">⊆</span> <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">∈</span> CONS"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms learn_cons_closed_subseteq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> CONS_def mem_Collect_eq<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A consistent strategy cannot output the same hypothesis for two
different prefixes from the class to be learned.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> same_hyp_different_init_not_cons<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="free">U</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> <span class="free">U</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">▹</span> <span class="free">n</span> <span class="main">≠</span> <span class="free">g</span> <span class="main">▹</span> <span class="free">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span> <span class="main">(</span><span class="free">g</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> learn_cons <span class="keyword1">φ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> learn_cons_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> assms init_eqI<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹TOTAL: Learning in the limit with total hypotheses›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Total learning in the limit requires the strategy to hypothesize
only total functions for prefixes from the class.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">learn_total</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial2 <span class="main">⇒</span> <span class="main">(</span>partial1 set<span class="main">)</span> <span class="main">⇒</span> partial1 <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">learn_total</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span>
     learn_lim <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">f</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">ℛ</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">TOTAL_wrt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial2 <span class="main">⇒</span> partial1 set set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">TOTAL_wrt</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">U</span><span class="main">.</span> <span class="main">∃</span><span class="bound">s</span><span class="main">.</span> learn_total <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="bound">U</span> <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">TOTAL</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial1 set set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">TOTAL</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">U</span><span class="main">.</span> <span class="main">∃</span><span class="bound">ψ</span> <span class="bound">s</span><span class="main">.</span> learn_total <span class="bound">ψ</span> <span class="bound">U</span> <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> TOTAL_subseteq_LIM<span class="main">:</span> <span class="quoted"><span class="quoted">"TOTAL <span class="main">⊆</span> <span class="keyword1">LIM</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> TOTAL_def Lim_def <span class="keyword1"><span class="command">using</span></span> learn_total_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> learn_totalI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"environment <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="free">ψ</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> <span class="free">s</span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">⟹</span> <span class="free">ψ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"learn_total <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms learn_lim_def learn_total_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> learn_totalE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"learn_total <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"environment <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">i</span> <span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="free">ψ</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="free">s</span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">⟹</span> <span class="free">ψ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms learn_lim_def learn_total_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> learn_total_wrt_goedel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"goedel_numbering <span class="free">χ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"learn_total <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span> learn_total <span class="free">χ</span> <span class="free">U</span> <span class="bound">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> learn_total_def assms learn_lim_extra_wrt_goedel<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?extra</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">U</span> <span class="bound">f</span> <span class="bound">n</span> <span class="bound">h</span><span class="main">.</span> <span class="bound">h</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> TOTAL_wrt_phi_eq_TOTAL<span class="main">:</span> <span class="quoted"><span class="quoted">"TOTAL_wrt <span class="keyword1">φ</span> <span class="main">=</span> TOTAL"</span></span>
  <span class="keyword1"><span class="command">using</span></span> TOTAL_wrt_def TOTAL_def learn_total_wrt_goedel goedel_numbering_phi
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> learn_total_closed_subseteq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"learn_total <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">⊆</span> <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"learn_total <span class="free">ψ</span> <span class="free">V</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms learn_total_def learn_lim_closed_subseteq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> TOTAL_closed_subseteq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">∈</span> TOTAL"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">⊆</span> <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">∈</span> TOTAL"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms learn_total_closed_subseteq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> TOTAL_def mem_Collect_eq<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹CP: Learning in the limit with class-preserving hypotheses›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Class-preserving learning in the limit requires all hypotheses
for prefixes from the class to be functions from the class.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">learn_cp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial2 <span class="main">⇒</span> <span class="main">(</span>partial1 set<span class="main">)</span> <span class="main">⇒</span> partial1 <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">learn_cp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span>
     learn_lim <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">f</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">CP_wrt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial2 <span class="main">⇒</span> partial1 set set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">CP_wrt</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">U</span><span class="main">.</span> <span class="main">∃</span><span class="bound">s</span><span class="main">.</span> learn_cp <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="bound">U</span> <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">CP</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial1 set set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">CP</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">U</span><span class="main">.</span> <span class="main">∃</span><span class="bound">ψ</span> <span class="bound">s</span><span class="main">.</span> learn_cp <span class="bound">ψ</span> <span class="bound">U</span> <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> learn_cp_wrt_goedel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"goedel_numbering <span class="free">χ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"learn_cp <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span> learn_cp <span class="free">χ</span> <span class="free">U</span> <span class="bound">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> learn_cp_def assms learn_lim_extra_wrt_goedel<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?extra</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">U</span> <span class="bound">f</span> <span class="bound">n</span> <span class="bound">h</span><span class="main">.</span> <span class="bound">h</span> <span class="main">∈</span> <span class="bound">U</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> CP_wrt_phi<span class="main">:</span> <span class="quoted"><span class="quoted">"CP <span class="main">=</span> CP_wrt <span class="keyword1">φ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> learn_cp_wrt_goedel<span class="main">[</span><span class="operator">OF</span> goedel_numbering_phi<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> CP_def CP_wrt_def Collect_cong<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> learn_cpI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"environment <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="free">ψ</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> <span class="free">s</span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">⟹</span> <span class="free">ψ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"learn_cp <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms learn_cp_def learn_lim_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> learn_cpE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"learn_cp <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"environment <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span>  <span class="free">U</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">i</span> <span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="free">ψ</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="free">s</span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">⟹</span> <span class="free">ψ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">U</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms learn_lim_def learn_cp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Since classes contain only total functions, a CP strategy is also
a TOTAL strategy.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> learn_cp_imp_total<span class="main">:</span> <span class="quoted"><span class="quoted">"learn_cp <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span> <span class="main">⟹</span> learn_total <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> learn_cp_def learn_total_def learn_lim_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> CP_subseteq_TOTAL<span class="main">:</span> <span class="quoted"><span class="quoted">"CP <span class="main">⊆</span> TOTAL"</span></span>
  <span class="keyword1"><span class="command">using</span></span> learn_cp_imp_total CP_def TOTAL_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹FIN: Finite learning›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In general it is undecidable whether a LIM strategy has reached
its final hypothesis. By contrast, in finite learning (also called ``one-shot
learning'') the strategy signals when it is ready to output a hypothesis. Up
until then it outputs a ``don't know yet'' value. This value is represented
by zero and the actual hypothesis $i$ by $i + 1$.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">learn_fin</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial2 <span class="main">⇒</span> partial1 set <span class="main">⇒</span> partial1 <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">learn_fin</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span>
     environment <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∧</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">f</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">.</span> <span class="main">∃</span><span class="bound">i</span> <span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">FIN_wrt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial2 <span class="main">⇒</span> partial1 set set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">FIN_wrt</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">U</span><span class="main">.</span> <span class="main">∃</span><span class="bound">s</span><span class="main">.</span> learn_fin <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="bound">U</span> <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">FIN</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial1 set set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">FIN</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">U</span><span class="main">.</span> <span class="main">∃</span><span class="bound">ψ</span> <span class="bound">s</span><span class="main">.</span> learn_fin <span class="bound">ψ</span> <span class="bound">U</span> <span class="bound">s</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> learn_finI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"environment <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">⟹</span>
      <span class="main">∃</span><span class="bound">i</span> <span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="free">ψ</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="free">s</span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="free">s</span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"learn_fin <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms learn_fin_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> learn_finE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"learn_fin <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"environment <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">⟹</span>
      <span class="main">∃</span><span class="bound">i</span> <span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="free">ψ</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="free">s</span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="free">s</span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms learn_fin_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> learn_fin_closed_subseteq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"learn_fin <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">⊆</span> <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"learn_fin <span class="free">ψ</span> <span class="free">V</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms learn_fin_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> learn_fin_wrt_goedel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"goedel_numbering <span class="free">χ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"learn_fin <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span> learn_fin <span class="free">χ</span> <span class="free">U</span> <span class="bound">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> env<span class="main">:</span> <span class="quoted"><span class="quoted">"environment <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">⟹</span>
      <span class="main">∃</span><span class="bound">i</span> <span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="free">ψ</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="free">s</span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="free">s</span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> learn_finE <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">ψ</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">χ</span> <span class="main">(</span>the <span class="main">(</span><span class="skolem">c</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> env goedel_numberingE<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">ψ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≡</span>
    <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">s</span> <span class="bound">x</span> <span class="main">↑</span> <span class="keyword1">then</span> None
         <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">s</span> <span class="bound">x</span> <span class="main">=</span> Some <span class="main">0</span> <span class="keyword1">then</span> Some <span class="main">0</span>
              <span class="keyword1">else</span> Some <span class="main">(</span>Suc <span class="main">(</span>the <span class="main">(</span><span class="skolem">c</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> c <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rc</span></span> <span class="keyword2"><span class="keyword">where</span></span> rc<span class="main">:</span>
      <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">rc</span>"</span></span>
      <span class="quoted"><span class="quoted">"total <span class="skolem">rc</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">c</span> <span class="bound">x</span> <span class="main">=</span> eval <span class="skolem">rc</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> env <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> rs<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">rs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">s</span> <span class="bound">x</span> <span class="main">=</span> eval <span class="skolem">rs</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">rs</span> <span class="main">[</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">]</span> <span class="main">↓</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span> <span class="skolem">n</span>
      <span class="keyword1"><span class="command">using</span></span> env that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">rt</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rt</span> <span class="main">=</span> Cn <span class="main">1</span> r_ifz <span class="main">[</span><span class="skolem">rs</span><span class="main">,</span> Z<span class="main">,</span> Cn <span class="main">1</span> S <span class="main">[</span>Cn <span class="main">1</span> <span class="skolem">rc</span> <span class="main">[</span>Cn <span class="main">1</span> r_dec <span class="main">[</span><span class="skolem">rs</span><span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">rt</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rc<span class="main">(</span>1<span class="main">)</span> rs<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">rt</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">↑</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">rs</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">↑</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">using</span></span> rc<span class="main">(</span>1<span class="main">)</span> rs<span class="main">(</span>1<span class="main">)</span> rt_def that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">rt</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">rs</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">using</span></span> rt_def that rc<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> rs<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">rt</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="main">(</span>the <span class="main">(</span><span class="skolem">c</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">rs</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">↓≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">using</span></span> rt_def that rc rs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">rt</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">t</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> t_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">rt</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">↓=</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="free">s</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> Suc <span class="main">(</span>the <span class="main">(</span><span class="skolem">c</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">using</span></span> that env <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"learn_fin <span class="free">χ</span> <span class="free">U</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> learn_finI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"environment <span class="free">χ</span> <span class="free">U</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>›</span></span> env goedel_numbering_P2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span> <span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="free">χ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="skolem">t</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="skolem">t</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> fin <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span>
        i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="free">s</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="free">s</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> Suc <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">∈</span> <span class="free">U</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?j</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="skolem">c</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="var">?j</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> c<span class="main">(</span>2<span class="main">)</span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="skolem">t</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> t<span class="main">[</span><span class="operator">OF</span> that<span class="main">]</span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">↓=</span> Suc <span class="var">?j</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
        <span class="keyword1"><span class="command">using</span></span> that i t<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">∈</span> <span class="free">U</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="CP_FIN_NUM">
<div class="head">
<h1>Theory CP_FIN_NUM</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹FIN is a proper subset of CP\label{s:fin_cp}›</span></span>

<span class="keyword1"><span class="command">theory</span></span> CP_FIN_NUM
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Inductive_Inference_Basics.html">Inductive_Inference_Basics</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Let $S$ be a FIN strategy for a non-empty class $U$. Let $T$ be a
strategy that hypothesizes an arbitrary function from $U$ while $S$ outputs
``don't know'' and the hypothesis of $S$ otherwise. Then $T$ is a CP strategy
for $U$.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nonempty_FIN_wrt_impl_CP<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">∈</span> FIN_wrt <span class="free">ψ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">∈</span> CP_wrt <span class="free">ψ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"learn_fin <span class="free">ψ</span> <span class="free">U</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> FIN_wrt_def  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> env<span class="main">:</span> <span class="quoted"><span class="quoted">"environment <span class="free">ψ</span> <span class="free">U</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    fin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">⟹</span>
      <span class="main">∃</span><span class="bound">i</span> <span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="free">ψ</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="skolem">s</span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="skolem">s</span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> learn_finE <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="free">U</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> fin <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="skolem">i<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">f<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="skolem">x</span> <span class="main">≡</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">s</span> <span class="skolem">x</span> <span class="main">↑</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="skolem">s</span> <span class="skolem">x</span> <span class="main">↓=</span> <span class="main">0</span> <span class="keyword1">then</span> Some <span class="skolem">i<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">else</span> Some <span class="main">(</span>the <span class="main">(</span><span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> env <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> rs<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">rs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> eval <span class="skolem">rs</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">s</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">rt</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rt</span> <span class="main">=</span> Cn <span class="main">1</span> r_ifz <span class="main">[</span><span class="skolem">rs</span><span class="main">,</span> r_const <span class="skolem">i<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> Cn <span class="main">1</span> r_dec <span class="main">[</span><span class="skolem">rs</span><span class="main">]</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">rt</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rs<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">rt</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">s</span> <span class="skolem">x</span> <span class="main">↓=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="skolem">i<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">else</span> <span class="main">(</span>the <span class="main">(</span><span class="skolem">s</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="skolem">x</span> <span class="main">↓</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">using</span></span> rs rt_def that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">rt</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">↑</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">rs</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">↑</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">using</span></span> rs rt_def that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">rt</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">t</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">using</span></span> rs<span class="main">(</span>2<span class="main">)</span> t_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">rt</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"learn_cp <span class="free">ψ</span> <span class="free">U</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> learn_cpI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"environment <span class="free">ψ</span> <span class="free">U</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> env t_def <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="free">ψ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> <span class="skolem">t</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> that fin <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span>
        i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="skolem">s</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="skolem">s</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> Suc <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="skolem">t</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> that t_def i<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">(</span>the <span class="main">(</span><span class="skolem">t</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span> <span class="skolem">n</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">ψ</span> <span class="skolem">i<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">f<span class="hidden">⇩</span><sub>0</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="free">U</span>›</span></span> t_def fin env that
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> diff_Suc_1 not_less option.sel<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> CP_wrt_def env <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> FIN_wrt_impl_CP<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">∈</span> FIN_wrt <span class="free">ψ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">∈</span> CP_wrt <span class="free">ψ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">∈</span> <span class="keyword1">𝒫<span class="hidden">⇧</span><sup>2</sup></span> <span class="main">⟹</span> <span class="free">U</span> <span class="main">∈</span> CP_wrt <span class="free">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> CP_wrt_def learn_cpI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ψ</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Some <span class="main">0</span>"</span></span><span class="main">]</span> const_in_Prim1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">∈</span> <span class="keyword1">𝒫<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms FIN_wrt_def learn_finE <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">∈</span> CP_wrt <span class="free">ψ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> nonempty_FIN_wrt_impl_CP assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> FIN_subseteq_CP<span class="main">:</span> <span class="quoted"><span class="quoted">"FIN <span class="main">⊆</span> CP"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">U</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">∈</span> FIN"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ψ</span><span class="main">.</span> <span class="skolem">U</span> <span class="main">∈</span> FIN_wrt <span class="bound">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> FIN_def FIN_wrt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ψ</span><span class="main">.</span> <span class="skolem">U</span> <span class="main">∈</span> CP_wrt <span class="bound">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> FIN_wrt_impl_CP <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">∈</span> CP"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CP_def CP_wrt_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In order to show the \emph{proper} inclusion, we show <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="main"><span class="main">∈</span></span> CP <span class="main"><span class="main">-</span></span> FIN"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. A CP strategy for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> simply
hypothesizes the function in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">U0</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with the longest prefix of $f^n$ not
ending in zero. For that we define a function computing the index of the
rightmost non-zero value in a list, returning the length of the list if there
is no such value.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">findr</span> <span class="main">::</span> <span class="quoted">partial1</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">findr</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span>
    <span class="keyword1">if</span> <span class="main">∃</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>e_length <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">.</span> e_nth <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">i</span> <span class="main">≠</span> <span class="main">0</span>
    <span class="keyword1">then</span> Some <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> e_length <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∧</span> e_nth <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">i</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span>
    <span class="keyword1">else</span> Some <span class="main">(</span>e_length <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> findr_total<span class="main">:</span> <span class="quoted"><span class="quoted">"findr <span class="free">e</span> <span class="main">↓</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> findr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> findr_ex<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>e_length <span class="free">e</span><span class="main">.</span> e_nth <span class="free">e</span> <span class="bound">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>findr <span class="free">e</span><span class="main">)</span> <span class="main">&lt;</span> e_length <span class="free">e</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"e_nth <span class="free">e</span> <span class="main">(</span>the <span class="main">(</span>findr <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> the <span class="main">(</span>findr <span class="free">e</span><span class="main">)</span> <span class="main">&lt;</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> e_length <span class="free">e</span> <span class="main">⟶</span> e_nth <span class="free">e</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> e_length <span class="free">e</span> <span class="main">∧</span> e_nth <span class="free">e</span> <span class="bound">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>Greatest <span class="var">?P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> GreatestI_ex_nat<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="quoted"><span class="quoted">"e_length <span class="free">e</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"findr <span class="free">e</span> <span class="main">=</span> Some <span class="main">(</span>Greatest <span class="var">?P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms findr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>findr <span class="free">e</span><span class="main">)</span> <span class="main">&lt;</span> e_length <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"e_nth <span class="free">e</span> <span class="main">(</span>the <span class="main">(</span>findr <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> the <span class="main">(</span>findr <span class="free">e</span><span class="main">)</span> <span class="main">&lt;</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> e_length <span class="free">e</span> <span class="main">⟶</span> e_nth <span class="free">e</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * Greatest_le_nat<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">_</span> <span class="quoted"><span class="quoted">"e_length <span class="free">e</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_findr</span> <span class="main">≡</span>
  <span class="keyword1">let</span> <span class="bound">g</span> <span class="main">=</span>
    Cn <span class="numeral">3</span> r_ifz
     <span class="main">[</span>Cn <span class="numeral">3</span> r_nth <span class="main">[</span>Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span>
      Cn <span class="numeral">3</span> r_ifeq <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">1</span><span class="main">,</span> Cn <span class="numeral">3</span> S <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span><span class="main">,</span>
      Id <span class="numeral">3</span> <span class="main">0</span><span class="main">]</span>
  <span class="keyword1">in</span> Cn <span class="main">1</span> <span class="main">(</span>Pr <span class="main">1</span> Z <span class="bound">g</span><span class="main">)</span> <span class="main">[</span>Cn <span class="main">1</span> r_length <span class="main">[</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span> Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_findr_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> r_findr"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_findr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_findr <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_findr <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">=</span> findr <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span>
    Cn <span class="numeral">3</span> r_ifz
     <span class="main">[</span>Cn <span class="numeral">3</span> r_nth <span class="main">[</span>Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span>
      Cn <span class="numeral">3</span> r_ifeq <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">1</span><span class="main">,</span> Cn <span class="numeral">3</span> S <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span><span class="main">,</span>
      Id <span class="numeral">3</span> <span class="main">0</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">3</span> <span class="skolem">g</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> g_def <span class="keyword1"><span class="command">have</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="skolem">g</span> <span class="main">[</span><span class="skolem">j</span><span class="main">,</span> <span class="skolem">r</span><span class="main">,</span> <span class="skolem">e</span><span class="main">]</span> <span class="main">↓=</span>
      <span class="main">(</span><span class="keyword1">if</span> e_nth <span class="skolem">e</span> <span class="skolem">j</span> <span class="main">≠</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="skolem">j</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="skolem">j</span> <span class="main">=</span> <span class="skolem">r</span> <span class="keyword1">then</span> Suc <span class="skolem">j</span> <span class="keyword1">else</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span> <span class="skolem">r</span> <span class="skolem">e</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Pr <span class="main">1</span> Z <span class="skolem">g</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="var">?h</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">3</span> <span class="skolem">g</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">e</span> <span class="bound">j</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">∧</span> e_nth <span class="bound">e</span> <span class="bound">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?G</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">e</span> <span class="bound">j</span><span class="main">.</span> Greatest <span class="main">(</span><span class="var">?P</span> <span class="bound">e</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="var">?h</span> <span class="main">[</span><span class="skolem">j</span><span class="main">,</span> <span class="skolem">e</span><span class="main">]</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="skolem">j</span><span class="main">.</span> e_nth <span class="skolem">e</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> Some <span class="skolem">j</span> <span class="keyword1">else</span> Some <span class="main">(</span><span class="var">?G</span> <span class="skolem">e</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span> <span class="skolem">e</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">2</span> <span class="var">?h</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?h</span> <span class="main">[</span>Suc <span class="skolem">j</span><span class="main">,</span> <span class="skolem">e</span><span class="main">]</span> <span class="main">=</span> eval <span class="skolem">g</span> <span class="main">[</span><span class="skolem">j</span><span class="main">,</span> the <span class="main">(</span>eval <span class="var">?h</span> <span class="main">[</span><span class="skolem">j</span><span class="main">,</span> <span class="skolem">e</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">e</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">2</span> <span class="var">?h</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?h</span> <span class="main">[</span>Suc <span class="skolem">j</span><span class="main">,</span> <span class="skolem">e</span><span class="main">]</span> <span class="main">=</span>
        eval <span class="skolem">g</span> <span class="main">[</span><span class="skolem">j</span><span class="main">,</span> <span class="keyword1">if</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="skolem">j</span><span class="main">.</span> e_nth <span class="skolem">e</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="skolem">j</span> <span class="keyword1">else</span> <span class="var">?G</span> <span class="skolem">e</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">e</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="var">?h</span> <span class="main">[</span>Suc <span class="skolem">j</span><span class="main">,</span> <span class="skolem">e</span><span class="main">]</span> <span class="main">↓=</span>
      <span class="main">(</span><span class="keyword1">if</span> e_nth <span class="skolem">e</span> <span class="skolem">j</span> <span class="main">≠</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="skolem">j</span>
       <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="skolem">j</span><span class="main">.</span> e_nth <span class="skolem">e</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="skolem">j</span> <span class="keyword1">else</span> <span class="var">?G</span> <span class="skolem">e</span> <span class="skolem">j</span><span class="main">)</span>
            <span class="keyword1">then</span> Suc <span class="skolem">j</span>
            <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="skolem">j</span><span class="main">.</span> e_nth <span class="skolem">e</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="skolem">j</span> <span class="keyword1">else</span> <span class="var">?G</span> <span class="skolem">e</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> g <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>Suc <span class="skolem">j</span><span class="main">.</span> e_nth <span class="skolem">e</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>Suc <span class="skolem">j</span><span class="main">.</span> e_nth <span class="skolem">e</span> <span class="bound">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"e_nth <span class="skolem">e</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ex'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="skolem">j</span><span class="main">.</span> e_nth <span class="skolem">e</span> <span class="bound">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ex less_Suc_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="skolem">j</span><span class="main">.</span> e_nth <span class="skolem">e</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="skolem">j</span> <span class="keyword1">else</span> <span class="var">?G</span> <span class="skolem">e</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="var">?G</span> <span class="skolem">e</span> <span class="skolem">j</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?G</span> <span class="skolem">e</span> <span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ex' GreatestI_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">e</span> <span class="skolem">j</span>"</span></span><span class="main">]</span> less_imp_le_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?h</span> <span class="main">[</span>Suc <span class="skolem">j</span><span class="main">,</span> <span class="skolem">e</span><span class="main">]</span> <span class="main">↓=</span> <span class="var">?G</span> <span class="skolem">e</span> <span class="skolem">j</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> * True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?G</span> <span class="skolem">e</span> <span class="skolem">j</span> <span class="main">=</span> <span class="var">?G</span> <span class="skolem">e</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_SucI less_Suc_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ex <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?h</span> <span class="main">[</span>Suc <span class="skolem">j</span><span class="main">,</span> <span class="skolem">e</span><span class="main">]</span> <span class="main">↓=</span> <span class="skolem">j</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?G</span> <span class="skolem">e</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ex False Greatest_equality<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">e</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ex <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?hh</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="main">1</span> <span class="var">?h</span> <span class="main">[</span>Cn <span class="main">1</span> r_length <span class="main">[</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span> Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="var">?hh</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">2</span> <span class="var">?h</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> h <span class="keyword1"><span class="command">have</span></span> hh<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="var">?hh</span> <span class="main">[</span><span class="skolem">e</span><span class="main">]</span> <span class="main">↓=</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>e_length <span class="skolem">e</span><span class="main">.</span> e_nth <span class="skolem">e</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> e_length <span class="skolem">e</span> <span class="keyword1">else</span> <span class="var">?G</span> <span class="skolem">e</span> <span class="main">(</span>e_length <span class="skolem">e</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">e</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?hh</span> <span class="main">[</span><span class="skolem">e</span><span class="main">]</span> <span class="main">=</span> findr <span class="skolem">e</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">e</span>
    <span class="keyword1"><span class="command">unfolding</span></span> findr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"total <span class="var">?hh</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> hh totalI1 <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="var">?hh</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="var">?hh</span>›</span></span> g_def r_findr_def findr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> U0_in_CP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> CP"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> findr <span class="bound">x</span> <span class="main">↓=</span> e_length <span class="bound">x</span> <span class="keyword1">then</span> Some <span class="main">0</span> <span class="keyword1">else</span> Some <span class="main">(</span>e_take <span class="main">(</span>Suc <span class="main">(</span>the <span class="main">(</span>findr <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≡</span> Cn <span class="main">1</span> r_ifeq <span class="main">[</span>r_findr<span class="main">,</span> r_length<span class="main">,</span> Z<span class="main">,</span> Cn <span class="main">1</span> r_take <span class="main">[</span>Cn <span class="main">1</span> S <span class="main">[</span>r_findr<span class="main">]</span><span class="main">,</span> Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> eval <span class="skolem">r</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">s</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> s_def findr_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"learn_cp prenum <span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> learn_cpI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"environment prenum <span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>›</span></span> s_def prenum_in_R2 U0_in_NUM <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> prenum <span class="bound">i</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> <span class="skolem">s</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Some <span class="main">0</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
        <span class="keyword1"><span class="command">using</span></span> findr_def s_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="main">0</span><span class="main">.</span> <span class="skolem">s</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prenum <span class="main">0</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ws</span></span> <span class="keyword2"><span class="keyword">where</span></span> ws<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ws</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"last <span class="skolem">ws</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="skolem">ws</span> <span class="main">⊙</span> <span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> U0_def <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">∈</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span>›</span></span> almost0_canonical <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ws</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"list_encode <span class="skolem">ws</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prenum <span class="var">?i</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ws <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="var">?i</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="var">?m</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_nth <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="var">?m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ws that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> last_conv_nth<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span>Suc <span class="skolem">n</span><span class="main">.</span> e_nth <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="bound">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> le_imp_less_Suc that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> e_length <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∧</span> e_nth <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="bound">k</span> <span class="main">≠</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="var">?m</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Greatest_equality<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?m</span> <span class="main">&lt;</span> e_length <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∧</span> e_nth <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="var">?m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹e_nth <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="var">?m</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> e_length <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∧</span> e_nth <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="bound">y</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">≤</span> <span class="var">?m</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> ws less_Suc_eq_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"findr <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="var">?m</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> that findr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?m</span> <span class="main">&lt;</span> e_length <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">↓=</span> e_take <span class="main">(</span>Suc <span class="var">?m</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> s_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_take <span class="main">(</span>Suc <span class="var">?m</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> list_encode <span class="skolem">ws</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>Suc <span class="var">?m</span><span class="main">)</span> <span class="main">(</span>prefix <span class="skolem">f</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> prefix <span class="skolem">f</span> <span class="var">?m</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> take_prefix<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> ws that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> almost0_in_R1<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>Suc <span class="var">?m</span><span class="main">)</span> <span class="main">(</span>prefix <span class="skolem">f</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">ws</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> ws prefixI <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟹</span> prenum <span class="main">(</span>the <span class="main">(</span><span class="skolem">s</span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> U0_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> CP_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹As a bit of an interlude, we can now show that CP is not
closed under the subset relation. This works by removing functions from
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in a ``noncomputable'' way such that a strategy cannot ensure
that every intermediate hypothesis is in that new class.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> CP_not_closed_subseteq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">V</span> <span class="bound">U</span><span class="main">.</span> <span class="bound">V</span> <span class="main">⊆</span> <span class="bound">U</span> <span class="main">∧</span> <span class="bound">U</span> <span class="main">∈</span> CP <span class="main">∧</span> <span class="bound">V</span> <span class="main">∉</span> CP"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="comment1">― ‹The numbering $g\in\mathcal{R}^2$ enumerates all
  functions $i0^\infty \in U_0$.›</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">[</span><span class="bound">i</span><span class="main">]</span> <span class="main">⊙</span>  <span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> g_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">g</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">i</span> <span class="main">0</span> <span class="main">↓=</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">j</span> <span class="main">0</span> <span class="main">↓=</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> that <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.inject<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">― ‹Define a class $V$. If the strategy $\varphi_i$ learns
  $g_i$, it outputs a hypothesis for $g_i$ on some shortest prefix $g_i^m$.
  Then the function $g_i^m10^\infty$ is included in the class $V$; otherwise
  $g_i$ is included.›</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">V</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="main">≡</span>
    <span class="main">{</span><span class="keyword1">if</span> learn_lim <span class="keyword1">φ</span> <span class="main">{</span><span class="skolem">g</span> <span class="bound">i</span><span class="main">}</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="bound">i</span><span class="main">)</span>
     <span class="keyword1">then</span> <span class="main">(</span>prefix <span class="main">(</span><span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="keyword1">φ</span> <span class="bound">i</span> <span class="main">(</span><span class="main">(</span><span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="main">1</span><span class="main">]</span> <span class="main">⊙</span> <span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span>
     <span class="keyword1">else</span> <span class="skolem">g</span> <span class="bound">i</span> <span class="main">|</span>
     <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> UNIV<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="main">∉</span> CP_wrt <span class="keyword1">φ</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="comment1">― ‹Assuming $V \in CP_\varphi$, there is a CP strategy
    $\varphi_i$ for $V$.›</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="main">∈</span> CP_wrt <span class="keyword1">φ</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>"</span></span> <span class="quoted"><span class="quoted">"learn_cp <span class="keyword1">φ</span> <span class="skolem">V</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> CP_wrt_def learn_cpE<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> phi_universal <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"learn_lim <span class="keyword1">φ</span> <span class="main">{</span><span class="skolem">g</span> <span class="skolem">i</span><span class="main">}</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> learn<span class="main">:</span> True
      <span class="comment1">― ‹If $\varphi_i$ learns $g_i$, it hypothesizes $g_i$ on
      some shortest prefix $g_i^m$. Thus it hypothesizes $g_i$ on some prefix
      of $g_i^m10^\infty \in V$, too. But $g_i$ is not a class-preserving
      hypothesis because $g_i \notin V$.›</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="keyword1">φ</span> <span class="skolem">i</span> <span class="main">(</span><span class="main">(</span><span class="skolem">g</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">▹</span>  <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">g</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Least <span class="var">?P</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">n</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> i s <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> learn infinite_hyp_wrong_not_Lim insertI1 lessI<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="var">?m</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> LeastI_ex<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">=</span> <span class="main">(</span>prefix <span class="main">(</span><span class="skolem">g</span> <span class="skolem">i</span><span class="main">)</span> <span class="var">?m</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="main">1</span><span class="main">]</span> <span class="main">⊙</span> <span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">∈</span> <span class="skolem">V</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> V_def learn <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">g</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">▹</span>  <span class="var">?m</span> <span class="main">=</span> <span class="skolem">h</span> <span class="main">▹</span>  <span class="var">?m</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefix <span class="main">(</span><span class="skolem">g</span> <span class="skolem">i</span><span class="main">)</span> <span class="var">?m</span> <span class="main">=</span> prefix <span class="skolem">h</span> <span class="var">?m</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> h_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefix_prepend_less<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="keyword1">φ</span> <span class="skolem">i</span> <span class="main">(</span><span class="skolem">h</span> <span class="main">▹</span>  <span class="var">?m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">g</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="var">?m</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">i</span> <span class="main">∉</span> <span class="skolem">V</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">V</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">i</span> <span class="main">=</span>
          <span class="main">(</span><span class="keyword1">if</span> learn_lim <span class="keyword1">φ</span> <span class="main">{</span><span class="skolem">g</span> <span class="skolem">j</span><span class="main">}</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="skolem">j</span><span class="main">)</span>
           <span class="keyword1">then</span> <span class="main">(</span>prefix <span class="main">(</span><span class="skolem">g</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="keyword1">φ</span> <span class="skolem">j</span> <span class="main">(</span><span class="main">(</span><span class="skolem">g</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">▹</span>  <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">g</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="main">1</span><span class="main">]</span> <span class="main">⊙</span> <span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span>
           <span class="keyword1">else</span> <span class="skolem">g</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> V_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"learn_lim <span class="keyword1">φ</span> <span class="main">{</span><span class="skolem">g</span> <span class="skolem">j</span><span class="main">}</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="skolem">j</span><span class="main">)</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">i</span> <span class="main">=</span>
              <span class="main">(</span>prefix <span class="main">(</span><span class="skolem">g</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="keyword1">φ</span> <span class="skolem">j</span> <span class="main">(</span><span class="main">(</span><span class="skolem">g</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">▹</span>  <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">g</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="main">1</span><span class="main">]</span> <span class="main">⊙</span> <span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
              <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">i</span> <span class="main">=</span> <span class="var">?vs</span> <span class="main">@</span> <span class="main">[</span><span class="main">1</span><span class="main">]</span> <span class="main">⊙</span> <span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> j <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="var">?vs</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">i</span> <span class="main">(</span>length <span class="var">?vs</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">1</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prepend_associative<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">i</span> <span class="main">(</span>length <span class="var">?vs</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> g_def len <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> j g_inj learn <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="keyword1">φ</span> <span class="skolem">i</span> <span class="main">(</span><span class="skolem">h</span> <span class="main">▹</span>  <span class="var">?m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> learn_cp <span class="keyword1">φ</span> <span class="skolem">V</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">h</span> <span class="main">∈</span> <span class="skolem">V</span>›</span></span> learn_cpE<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> i s<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="comment1">― ‹If $\varphi_i$ does not learn $g_i$, then $g_i\in V$.
      Hence $\varphi_i$ does not learn $V$.›</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">V</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> V_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> learn_lim <span class="keyword1">φ</span> <span class="skolem">V</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> learn_lim_closed_subseteq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> s<span class="main">(</span>2<span class="main">)</span> i <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> learn_cp_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="main">∉</span> CP"</span></span>
    <span class="keyword1"><span class="command">using</span></span> CP_wrt_phi <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="main">⊆</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> V_def g_def U0_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> U0_in_CP <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Continuing with the main result of this section, we show that
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> cannot be learned finitely. Any FIN strategy would have
to output a hypothesis for the constant zero function on some prefix. But
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> contains infinitely many other functions starting with
the same prefix, which the strategy then would not learn finitely.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> U0_not_in_FIN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∉</span> FIN"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> FIN"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ψ</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"learn_fin <span class="skolem">ψ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> FIN_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> learn_finE <span class="keyword1"><span class="command">have</span></span> cp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟹</span>
      <span class="main">∃</span><span class="bound">i</span> <span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="skolem">ψ</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="skolem">s</span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="skolem">s</span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⊙</span> <span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> U0_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> cp <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="skolem">s</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> Suc <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> replicate <span class="main">(</span>Suc <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">0</span> <span class="main">@</span> <span class="main">[</span><span class="main">1</span><span class="main">]</span> <span class="main">⊙</span> <span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefix <span class="skolem">w</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> replicate <span class="main">(</span>Suc <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefix_prepend_less<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefix <span class="skolem">z</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> replicate <span class="main">(</span>Suc <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prefixI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"replicate <span class="main">(</span>Suc <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="skolem">z</span></span><span class="main">]</span> less_Suc_eq_0_disj <span class="keyword1"><span class="command">unfolding</span></span> z_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">▹</span>  <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">w</span> <span class="main">▹</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_prefixE<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> n0 <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">▹</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">↓=</span> Suc <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> w_def U0_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> cp <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="skolem"><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> i'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="skolem">i'</span> <span class="main">=</span> <span class="skolem">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> n0'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">.</span> <span class="skolem">s</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">.</span> <span class="skolem">s</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> Suc <span class="skolem">i'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">i'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> i i' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">(</span>Suc <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">↓=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> w_def prepend<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"replicate <span class="main">(</span>Suc <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">0</span> <span class="main">@</span> <span class="main">[</span><span class="main">1</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_append_singleton length_replicate lessI nth_append_length<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">(</span>Suc <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> z_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">w</span> <span class="main">=</span> <span class="skolem">z</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">▹</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">↓≠</span> Suc <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n0' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">&lt;</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub>'</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> FIN_subset_CP<span class="main">:</span> <span class="quoted"><span class="quoted">"FIN <span class="main">⊂</span> CP"</span></span>
  <span class="keyword1"><span class="command">using</span></span> U0_in_CP U0_not_in_FIN FIN_subseteq_CP <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹NUM and FIN are incomparable\label{s:num_fin}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The class $V_0$ of all total recursive functions $f$ where $f(0)$
is a Gödel number of $f$ can be learned finitely by always hypothesizing
$f(0)$. The class is not in NUM and therefore serves to separate NUM and
FIN.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">V0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial1 set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">V<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span> <span class="main">∧</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="bound">f</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="bound">f</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> V0_altdef<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="main">{</span><span class="main">[</span><span class="bound">i</span><span class="main">]</span> <span class="main">⊙</span> <span class="bound">f</span><span class="main">|</span> <span class="bound">i</span> <span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span> <span class="main">∧</span> <span class="keyword1">φ</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">[</span><span class="bound">i</span><span class="main">]</span> <span class="main">⊙</span> <span class="bound">f</span><span class="main">}</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="var">?W</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊆</span> <span class="var">?W</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> V0_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">0</span> <span class="main">↓=</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> skip_R1<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">i</span><span class="main">]</span> <span class="main">⊙</span> <span class="skolem">g</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> g_def i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">∈</span> <span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub></span>›</span></span> V0_def i <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="var">?W</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?W</span> <span class="main">⊆</span> <span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">g</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> <span class="var">?W</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="skolem">g</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prepend_in_R1 <span class="quoted"><span class="quoted">‹<span class="skolem">g</span> <span class="main">∈</span> <span class="var">?W</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> <span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> V0_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> V0_in_FIN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> FIN"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Some <span class="main">(</span>Suc <span class="main">(</span>e_hd <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> Cn <span class="main">1</span> S <span class="main">[</span>r_hd<span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">r</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="main">(</span>e_hd <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">unfolding</span></span> r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> s_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">↓=</span> Suc <span class="main">(</span>the <span class="main">(</span><span class="skolem">f</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">unfolding</span></span> s_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"learn_fin <span class="keyword1">φ</span> <span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> learn_finI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"environment <span class="keyword1">φ</span> <span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> s_def <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>›</span></span> phi_in_P2 V0_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span> <span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="keyword1">φ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="skolem">s</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="skolem">s</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span>
      <span class="keyword1"><span class="command">using</span></span> that V0_def s <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> FIN_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹To every <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">f</span></span> <span class="main"><span class="main">∈</span></span> <span class="keyword1"><span class="keyword1">ℛ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> a number can be prepended that is
a Gödel number of the resulting function. Such a function is then in $V_0$.

If $V_0$ was in NUM, it would be embedded in a total numbering. Shifting this
numbering to the left, essentially discarding the values at point $0$, would
yield a total numbering for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">ℛ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, which contradicts <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source]
R1_not_in_NUM<span class="antiquote"><span class="antiquote">}</span></span></span></span>. This proves <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="main"><span class="main">∉</span></span> NUM"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prepend_goedel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">[</span><span class="bound">i</span><span class="main">]</span> <span class="main">⊙</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"total <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> eval <span class="skolem">r</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r_psi</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r_psi</span> <span class="main">=</span> Cn <span class="numeral">2</span> r_ifz <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">1</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">0</span><span class="main">,</span> Cn <span class="numeral">2</span> <span class="skolem">r</span> <span class="main">[</span>Cn <span class="numeral">2</span> r_dec <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="skolem">r_psi</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">r_psi</span> <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> Some <span class="skolem">i</span> <span class="keyword1">else</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Cn <span class="numeral">2</span> <span class="skolem">r</span> <span class="main">[</span>Cn <span class="numeral">2</span> r_dec <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> r <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">r_psi</span> <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> eval r_ifz <span class="main">[</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">i</span><span class="main">,</span> the <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> r_psi_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">2</span> <span class="skolem">r_psi</span>›</span></span> r R1_imp_total1<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">2</span> <span class="skolem">r_psi</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> Some <span class="bound">i</span> <span class="keyword1">else</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">𝒫<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> kleene_fixed_point <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> Some <span class="skolem">i</span> <span class="keyword1">else</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span> <span class="main">⊙</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> V0_in_FIN_minus_NUM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> FIN <span class="main">-</span> NUM"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∉</span> NUM"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> NUM"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ψ</span></span> <span class="keyword2"><span class="keyword">where</span></span> ψ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">ψ</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">f</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ψ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ'</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">ψ</span> <span class="skolem">i</span> <span class="main">(</span>Suc <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ'</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword1"><span class="command">from</span></span> ψ<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r_psi</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        r_psi<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="skolem">r_psi</span>"</span></span> <span class="quoted"><span class="quoted">"total <span class="skolem">r_psi</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">x</span><span class="main">.</span> eval <span class="skolem">r_psi</span> <span class="main">[</span><span class="bound">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">ψ</span> <span class="bound">i</span> <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r_psi'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r_psi'</span> <span class="main">=</span> Cn <span class="numeral">2</span> <span class="skolem">r_psi</span> <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">0</span><span class="main">,</span> Cn <span class="numeral">2</span> S <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="skolem">r_psi'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">x</span><span class="main">.</span> eval <span class="skolem">r_psi'</span> <span class="main">[</span><span class="bound">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">ψ'</span> <span class="bound">i</span> <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> r_psi'_def ψ'_def <span class="keyword1"><span class="command">using</span></span> r_psi <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ'</span> <span class="main">∈</span> <span class="keyword1">𝒫<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"total2 <span class="skolem">ψ'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ψ'_def ψ<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> total2I<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">ψ'</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> that <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">j</span><span class="main">]</span> <span class="main">⊙</span> <span class="skolem">f</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> prepend_goedel <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="skolem">j</span> <span class="main">∈</span> <span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> that V0_altdef <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> ψ <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="skolem">i</span> <span class="main">=</span> <span class="keyword1">φ</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ'</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ψ'_def j <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prepend_at_ge<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ψ'</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℛ</span> <span class="main">∈</span> NUM"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> R1_not_in_NUM <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> V0_in_FIN <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> FIN_not_subseteq_NUM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> FIN <span class="main">⊆</span> NUM"</span></span>
  <span class="keyword1"><span class="command">using</span></span> V0_in_FIN_minus_NUM <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹NUM and CP are incomparable\label{s:num_cp}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹There are FIN classes outside of NUM, and CP encompasses FIN.
Hence there are CP classes outside of NUM, too.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> CP_not_subseteq_NUM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> CP <span class="main">⊆</span> NUM"</span></span>
  <span class="keyword1"><span class="command">using</span></span> FIN_subseteq_CP FIN_not_subseteq_NUM <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Conversely there is a subclass of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> that
is in NUM but cannot be learned in a class-preserving way. The following
proof is due to Jantke and Beick~\cite{jb-cpnii-81}. The idea is to
diagonalize against all strategies, that is, all partial recursive
functions.›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> NUM_not_subseteq_CP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> NUM <span class="main">⊆</span> CP"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="comment1">― ‹Define a family of functions $f_k$.›</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">[</span><span class="bound">k</span><span class="main">]</span> <span class="main">⊙</span> <span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">k</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">using</span></span> almost0_in_R1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="comment1">― ‹If the strategy $\varphi_k$ learns $f_k$ it hypothesizes
  $f_k$ for some shortest prefix $f_k^{a_k}$. Define functions $f'_k =
  k0^{a_k}10^\infty$.›</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="keyword1">LEAST</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="main">(</span><span class="keyword1">φ</span> <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">f</span> <span class="bound">k</span><span class="main">)</span> <span class="main">▹</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">k</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f'</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="bound">k</span> <span class="main">#</span> <span class="main">(</span>replicate <span class="main">(</span><span class="skolem">a</span> <span class="bound">k</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">⊙</span> <span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f'</span> <span class="skolem">k</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">using</span></span> almost0_in_R1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="comment1">― ‹Although $f_k$ and $f'_k$ differ, they share the prefix of length $a_k + 1$.›</span>
  <span class="keyword1"><span class="command">have</span></span> init_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f'</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">▹</span> <span class="main">(</span><span class="skolem">a</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">▹</span> <span class="main">(</span><span class="skolem">a</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> init_eqI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">a</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f'</span> <span class="skolem">k</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">k</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append f'_def f_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">k</span> <span class="main">≠</span> <span class="skolem">f'</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">k</span> <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">a</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f'</span> <span class="skolem">k</span> <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">a</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f'_def prepend<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">k</span> <span class="main">#</span> <span class="main">(</span>replicate <span class="main">(</span><span class="skolem">a</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="skolem">a</span> <span class="skolem">k</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_Cons length_append_singleton length_replicate lessI nth_Cons_Suc
        nth_append_length<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">― ‹The separating class $U$ contains $f'_k$ if $\varphi_k$
  learns $f_k$; otherwise it contains $f_k$.›</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">U</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">≡</span> <span class="main">{</span><span class="keyword1">if</span> learn_lim <span class="keyword1">φ</span> <span class="main">{</span><span class="skolem">f</span> <span class="bound">k</span><span class="main">}</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="bound">k</span><span class="main">)</span> <span class="keyword1">then</span> <span class="skolem">f'</span> <span class="bound">k</span> <span class="keyword1">else</span> <span class="skolem">f</span> <span class="bound">k</span> <span class="main">|</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈</span> UNIV<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">∉</span> CP"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">∈</span> CP"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span><span class="main">.</span> learn_cp <span class="keyword1">φ</span> <span class="skolem">U</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ψ</span> <span class="bound">s</span><span class="main">.</span> learn_cp <span class="bound">ψ</span> <span class="skolem">U</span> <span class="bound">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> CP_def <span class="quoted"><span class="quoted">‹<span class="skolem">U</span> <span class="main">∈</span> CP›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"learn_cp <span class="keyword1">φ</span> <span class="skolem">U</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> learn_cp_wrt_goedel<span class="main">[</span><span class="operator">OF</span> goedel_numbering_phi<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="skolem">k</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> phi_universal learn_cp_def learn_lim_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> s <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"learn_cp <span class="keyword1">φ</span> <span class="skolem">U</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> learn<span class="main">:</span> <span class="quoted"><span class="quoted">"learn_lim <span class="keyword1">φ</span> <span class="skolem">U</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> learn_cp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="comment1">― ‹If $f_k$ was in $U$, $\varphi_k$ would learn it. But then,
    by definition of $U$, $f_k$ would not be in $U$. Hence $f_k \notin U$.›</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">k</span> <span class="main">∉</span> <span class="skolem">U</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">k</span> <span class="main">∈</span> <span class="skolem">U</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> learn_lim <span class="keyword1">φ</span> <span class="main">{</span><span class="skolem">f</span> <span class="skolem">m</span><span class="main">}</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="skolem">m</span><span class="main">)</span> <span class="keyword1">then</span> <span class="skolem">f'</span> <span class="skolem">m</span> <span class="keyword1">else</span> <span class="skolem">f</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> U_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">k</span> <span class="main">0</span> <span class="main">↓=</span> <span class="skolem">m</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> f_def f'_def m <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">k</span> <span class="main">0</span> <span class="main">↓=</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> m <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> learn_lim <span class="keyword1">φ</span> <span class="main">{</span><span class="skolem">f</span> <span class="skolem">k</span><span class="main">}</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="skolem">k</span><span class="main">)</span> <span class="keyword1">then</span> <span class="skolem">f'</span> <span class="skolem">k</span> <span class="keyword1">else</span> <span class="skolem">f</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"learn_lim <span class="keyword1">φ</span> <span class="main">{</span><span class="skolem">f</span> <span class="skolem">k</span><span class="main">}</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="skolem">k</span> <span class="main">∈</span> <span class="skolem">U</span>›</span></span> learn_lim_closed_subseteq<span class="main">[</span><span class="operator">OF</span> learn<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">k</span> <span class="main">=</span> <span class="skolem">f'</span> <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="skolem">k</span> <span class="main">≠</span> <span class="skolem">f'</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f'</span> <span class="skolem">k</span> <span class="main">∈</span> <span class="skolem">U</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> U_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> in_U<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="main">(</span><span class="keyword1">φ</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">f'</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">U</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> learn_cpE<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> k<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="comment1">― ‹Since $f'_k \in U$, the strategy $\varphi_k$ learns $f_k$.
    Then $a_k$ is well-defined, $f'^{a_k} = f^{a_k}$, and $\varphi_k$
    hypothesizes $f_k$ on $f'^{a_k}$, which is not a class-preserving
    hypothesis.›</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"learn_lim <span class="keyword1">φ</span> <span class="main">{</span><span class="skolem">f</span> <span class="skolem">k</span><span class="main">}</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> U_def <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="skolem">k</span> <span class="main">∉</span> <span class="skolem">U</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span> <span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="keyword1">φ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">k</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="keyword1">φ</span> <span class="skolem">k</span> <span class="main">(</span><span class="main">(</span><span class="skolem">f</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> learn_limE<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">k</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="keyword1">φ</span> <span class="skolem">k</span> <span class="main">(</span><span class="main">(</span><span class="skolem">f</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="keyword1">φ</span> <span class="skolem">k</span> <span class="main">(</span><span class="main">(</span><span class="skolem">f</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">▹</span> <span class="main">(</span><span class="skolem">a</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> a_def LeastI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="main">(</span><span class="keyword1">φ</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">f</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">▹</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="main">(</span><span class="keyword1">φ</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">f'</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">▹</span> <span class="main">(</span><span class="skolem">a</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> init_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="skolem">k</span> <span class="main">∉</span> <span class="skolem">U</span>›</span></span> in_U <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">∈</span> NUM"</span></span>
    <span class="keyword1"><span class="command">using</span></span> NUM_closed_subseteq<span class="main">[</span><span class="operator">OF</span> U0_in_NUM<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">U</span></span><span class="main">]</span> f_def f'_def U0_def U_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹NUM is a proper subset of TOTAL\label{s:num_total}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A NUM class $U$ is embedded in a total numbering <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">ψ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
The strategy $S$ with $S(f^n) = \min \{i \mid \forall k \le n: \psi_i(k) =
f(k)\}$ for $f \in U$ converges to the least index of $f$ in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">ψ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
and thus learns $f$ in the limit. Moreover it will be a TOTAL strategy
because <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">ψ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> contains only total functions. This shows <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span> <span class="quoted"><span class="quoted">"NUM
<span class="main"><span class="main">⊆</span></span> TOTAL"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹First we define, for every hypothesis space $\psi$, a
function that tries to determine for a given list $e$ and index $i$ whether
$e$ is a prefix of $\psi_i$. In other words it tries to decide whether $i$ is
a consistent hypothesis for $e$. ``Tries'' refers to the fact that the
function will diverge if $\psi_i(x)\uparrow$ for any $x \le |e|$. We start
with a version that checks the list only up to a given length.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">r_consist_upto</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"recf <span class="main">⇒</span> recf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">r_consist_upto</span> <span class="free"><span class="bound"><span class="entity">r_psi</span></span></span> <span class="main">≡</span>
    <span class="keyword1">let</span> <span class="bound">g</span> <span class="main">=</span> Cn <span class="numeral">4</span> r_ifeq
      <span class="main">[</span>Cn <span class="numeral">4</span> <span class="free"><span class="bound"><span class="entity">r_psi</span></span></span> <span class="main">[</span>Id <span class="numeral">4</span> <span class="numeral">2</span><span class="main">,</span> Id <span class="numeral">4</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span> Cn <span class="numeral">4</span> r_nth <span class="main">[</span>Id <span class="numeral">4</span> <span class="numeral">3</span><span class="main">,</span> Id <span class="numeral">4</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span> Id <span class="numeral">4</span> <span class="main">1</span><span class="main">,</span> r_constn <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span>
    <span class="keyword1">in</span> Pr <span class="numeral">2</span> <span class="main">(</span>r_constn <span class="main">1</span> <span class="main">0</span><span class="main">)</span> <span class="bound">g</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_consist_upto_recfn<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="free">r_psi</span> <span class="main">⟹</span> recfn <span class="numeral">3</span> <span class="main">(</span>r_consist_upto <span class="free">r_psi</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> r_consist_upto_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_consist_upto<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="free">r_psi</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">j</span><span class="main">.</span> eval <span class="free">r_psi</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="bound">k</span><span class="main">]</span> <span class="main">↓</span> <span class="main">⟹</span>
      eval <span class="main">(</span>r_consist_upto <span class="free">r_psi</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span> <span class="main">=</span>
        <span class="main">(</span><span class="keyword1">if</span> <span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">j</span><span class="main">.</span> eval <span class="free">r_psi</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="bound">k</span><span class="main">]</span> <span class="main">↓=</span> e_nth <span class="free">e</span> <span class="bound">k</span> <span class="keyword1">then</span> Some <span class="main">0</span> <span class="keyword1">else</span> Some <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">j</span><span class="main">.</span> eval <span class="free">r_psi</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="bound">k</span><span class="main">]</span> <span class="main">↓</span><span class="main">)</span> <span class="main">⟹</span> eval <span class="main">(</span>r_consist_upto <span class="free">r_psi</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span> <span class="main">↑</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span>
    Cn <span class="numeral">4</span> r_ifeq
     <span class="main">[</span>Cn <span class="numeral">4</span> <span class="free">r_psi</span> <span class="main">[</span>Id <span class="numeral">4</span> <span class="numeral">2</span><span class="main">,</span> Id <span class="numeral">4</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span> Cn <span class="numeral">4</span> r_nth <span class="main">[</span>Id <span class="numeral">4</span> <span class="numeral">3</span><span class="main">,</span> Id <span class="numeral">4</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span> Id <span class="numeral">4</span> <span class="main">1</span><span class="main">,</span> r_constn <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">4</span> <span class="skolem">g</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Cn <span class="numeral">4</span> r_nth <span class="main">[</span>Id <span class="numeral">4</span> <span class="numeral">3</span><span class="main">,</span> Id <span class="numeral">4</span> <span class="main">0</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="skolem">j</span><span class="main">,</span> <span class="skolem">r</span><span class="main">,</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">e</span><span class="main">]</span> <span class="main">↓=</span> e_nth <span class="skolem">e</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span> <span class="skolem">r</span> <span class="skolem">i</span> <span class="skolem">e</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_constn <span class="numeral">3</span> <span class="main">1</span><span class="main">)</span> <span class="main">[</span><span class="skolem">j</span><span class="main">,</span> <span class="skolem">r</span><span class="main">,</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">e</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span> <span class="skolem">r</span> <span class="skolem">i</span> <span class="skolem">e</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Cn <span class="numeral">4</span> <span class="free">r_psi</span> <span class="main">[</span>Id <span class="numeral">4</span> <span class="numeral">2</span><span class="main">,</span> Id <span class="numeral">4</span> <span class="main">0</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="skolem">j</span><span class="main">,</span> <span class="skolem">r</span><span class="main">,</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">e</span><span class="main">]</span> <span class="main">=</span> eval <span class="free">r_psi</span> <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span> <span class="skolem">r</span> <span class="skolem">i</span> <span class="skolem">e</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="skolem">g</span> <span class="main">[</span><span class="skolem">j</span><span class="main">,</span> <span class="skolem">r</span><span class="main">,</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">e</span><span class="main">]</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> eval <span class="free">r_psi</span> <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">]</span> <span class="main">↑</span> <span class="keyword1">then</span> None
     <span class="keyword1">else</span> <span class="keyword1">if</span> eval <span class="free">r_psi</span> <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">]</span> <span class="main">↓=</span> e_nth <span class="skolem">e</span> <span class="skolem">j</span> <span class="keyword1">then</span> Some <span class="skolem">r</span> <span class="keyword1">else</span> Some <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span> <span class="skolem">r</span> <span class="skolem">i</span> <span class="skolem">e</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">4</span> <span class="skolem">g</span>›</span></span> g_def assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> goal1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="skolem">j</span><span class="main">.</span> eval <span class="free">r_psi</span> <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="bound">k</span><span class="main">]</span> <span class="main">↓</span> <span class="main">⟹</span>
    eval <span class="main">(</span>r_consist_upto <span class="free">r_psi</span><span class="main">)</span> <span class="main">[</span><span class="skolem">j</span><span class="main">,</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">e</span><span class="main">]</span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="skolem">j</span><span class="main">.</span> eval <span class="free">r_psi</span> <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="bound">k</span><span class="main">]</span> <span class="main">↓=</span> e_nth <span class="skolem">e</span> <span class="bound">k</span> <span class="keyword1">then</span> Some <span class="main">0</span> <span class="keyword1">else</span> Some <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span> <span class="skolem">i</span> <span class="skolem">e</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> r_consist_upto_def r_consist_upto_recfn assms eval_Pr_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_consist_upto <span class="free">r_psi</span><span class="main">)</span> <span class="main">[</span>Suc <span class="skolem">j</span><span class="main">,</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">e</span><span class="main">]</span> <span class="main">=</span>
        eval <span class="skolem">g</span> <span class="main">[</span><span class="skolem">j</span><span class="main">,</span> the <span class="main">(</span>eval <span class="main">(</span>r_consist_upto <span class="free">r_psi</span><span class="main">)</span> <span class="main">[</span><span class="skolem">j</span><span class="main">,</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">e</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">e</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms eval_Pr_converg_Suc g_def r_consist_upto_def r_consist_upto_recfn
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> eval <span class="skolem">g</span> <span class="main">[</span><span class="skolem">j</span><span class="main">,</span> <span class="keyword1">if</span> <span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="skolem">j</span><span class="main">.</span> eval <span class="free">r_psi</span> <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="bound">k</span><span class="main">]</span> <span class="main">↓=</span> e_nth <span class="skolem">e</span> <span class="bound">k</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">,</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">e</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> eval <span class="free">r_psi</span> <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">]</span> <span class="main">↓=</span> e_nth <span class="skolem">e</span> <span class="skolem">j</span>
        <span class="keyword1">then</span> <span class="keyword1">if</span> <span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="skolem">j</span><span class="main">.</span> eval <span class="free">r_psi</span> <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="bound">k</span><span class="main">]</span> <span class="main">↓=</span> e_nth <span class="skolem">e</span> <span class="bound">k</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> g <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc.prems<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span>Suc <span class="skolem">j</span><span class="main">.</span> eval <span class="free">r_psi</span> <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="bound">k</span><span class="main">]</span> <span class="main">↓=</span> e_nth <span class="skolem">e</span> <span class="bound">k</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_Suc_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">j</span><span class="main">.</span> eval <span class="free">r_psi</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="bound">k</span><span class="main">]</span> <span class="main">↓</span> <span class="main">⟹</span>
    eval <span class="main">(</span>r_consist_upto <span class="free">r_psi</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">j</span><span class="main">.</span> eval <span class="free">r_psi</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="bound">k</span><span class="main">]</span> <span class="main">↓=</span> e_nth <span class="free">e</span> <span class="bound">k</span> <span class="keyword1">then</span> Some <span class="main">0</span> <span class="keyword1">else</span> Some <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">j</span><span class="main">.</span> eval <span class="free">r_psi</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="bound">k</span><span class="main">]</span> <span class="main">↓</span><span class="main">)</span> <span class="main">⟹</span> eval <span class="main">(</span>r_consist_upto <span class="free">r_psi</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span> <span class="main">↑</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">j</span><span class="main">.</span> eval <span class="free">r_psi</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="bound">k</span><span class="main">]</span> <span class="main">↓</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">j</span><span class="main">.</span> eval <span class="free">r_psi</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="bound">k</span><span class="main">]</span> <span class="main">↑</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">∧</span> eval <span class="free">r_psi</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="bound">k</span><span class="main">]</span> <span class="main">↑</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">kmin</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">kmin</span> <span class="main">=</span> Least <span class="var">?P</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">kmin</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> LeastI_ex<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="free">j</span><span class="main">.</span> eval <span class="free">r_psi</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="bound">k</span><span class="main">]</span> <span class="main">↑</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> kmin_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="skolem">kmin</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="var">?P</span> <span class="bound">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> kmin_def not_less_Least<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span> <span class="main">&lt;</span> <span class="skolem">kmin</span><span class="main">.</span> eval <span class="free">r_psi</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="bound">k</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">kmin</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_consist_upto <span class="free">r_psi</span><span class="main">)</span> <span class="main">[</span><span class="skolem">kmin</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span> <span class="main">=</span>
        <span class="main">(</span><span class="keyword1">if</span> <span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span><span class="skolem">kmin</span><span class="main">.</span> eval <span class="free">r_psi</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="bound">k</span><span class="main">]</span> <span class="main">↓=</span> e_nth <span class="free">e</span> <span class="bound">k</span> <span class="keyword1">then</span> Some <span class="main">0</span> <span class="keyword1">else</span> Some <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> goal1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="free">r_psi</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="skolem">kmin</span><span class="main">]</span> <span class="main">↑</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">kmin</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_consist_upto <span class="free">r_psi</span><span class="main">)</span> <span class="main">[</span>Suc <span class="skolem">kmin</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span> <span class="main">↑</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> r_consist_upto_def g assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≥</span> <span class="skolem">kmin</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">kmin</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_consist_upto <span class="free">r_psi</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span> <span class="main">↑</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> r_consist_upto_def r_consist_upto_recfn <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">kmin</span>›</span></span> eval_Pr_converg_le assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Suc_leI length_Cons list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> numeral_2_eq_2 numeral_3_eq_3<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next function provides the consistency decision functions we
need.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">consistent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial2 <span class="main">⇒</span> partial2"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">consistent</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span>
    <span class="keyword1">if</span> <span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span>e_length <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">k</span> <span class="main">↓</span>
    <span class="keyword1">then</span> <span class="keyword1">if</span> <span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span>e_length <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">k</span> <span class="main">↓=</span> e_nth <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">k</span>
         <span class="keyword1">then</span> Some <span class="main">0</span> <span class="keyword1">else</span> Some <span class="main">1</span>
    <span class="keyword1">else</span> None"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Given $i$ and $e$, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"consistent <span class="free"><span class="free">ψ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> decides whether $e$
is a prefix of $\psi_i$, provided $\psi_i$ is defined for the length of
$e$.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">r_consistent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"recf <span class="main">⇒</span> recf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">r_consistent</span> <span class="free"><span class="bound"><span class="entity">r_psi</span></span></span> <span class="main">≡</span>
     Cn <span class="numeral">2</span> <span class="main">(</span>r_consist_upto <span class="free"><span class="bound"><span class="entity">r_psi</span></span></span><span class="main">)</span> <span class="main">[</span>Cn <span class="numeral">2</span> r_length <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_consistent_recfn <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="free">r_psi</span> <span class="main">⟹</span> recfn <span class="numeral">2</span> <span class="main">(</span>r_consistent <span class="free">r_psi</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> r_consistent_def r_consist_upto_recfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_consistent_converg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="free">r_psi</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span>e_length <span class="free">e</span><span class="main">.</span> eval <span class="free">r_psi</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="bound">k</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_consistent <span class="free">r_psi</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span> <span class="main">↓=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span>e_length <span class="free">e</span><span class="main">.</span> eval <span class="free">r_psi</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="bound">k</span><span class="main">]</span> <span class="main">↓=</span> e_nth <span class="free">e</span> <span class="bound">k</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_consistent <span class="free">r_psi</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span> <span class="main">=</span> eval <span class="main">(</span>r_consist_upto <span class="free">r_psi</span><span class="main">)</span> <span class="main">[</span>e_length <span class="free">e</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_consistent_def r_consist_upto_recfn assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms r_consist_upto<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_consistent_diverg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="free">r_psi</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span>e_length <span class="free">e</span><span class="main">.</span> eval <span class="free">r_psi</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="bound">k</span><span class="main">]</span> <span class="main">↑</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_consistent <span class="free">r_psi</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span> <span class="main">↑</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_consistent_def
  <span class="keyword1"><span class="command">using</span></span> r_consist_upto_recfn<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> r_consist_upto<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_consistent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="free">r_psi</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> eval <span class="free">r_psi</span> <span class="main">[</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">]</span> <span class="main">=</span> <span class="free">ψ</span> <span class="bound">x</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_consistent <span class="free">r_psi</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span> <span class="main">=</span> consistent <span class="free">ψ</span> <span class="free">i</span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span>e_length <span class="free">e</span><span class="main">.</span> <span class="free">ψ</span> <span class="free">i</span> <span class="bound">k</span> <span class="main">↓</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span>e_length <span class="free">e</span><span class="main">.</span> eval <span class="free">r_psi</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="bound">k</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> consistent_def <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms r_consistent_converg<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"consistent <span class="free">ψ</span> <span class="free">i</span> <span class="free">e</span> <span class="main">↑</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> consistent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_consistent <span class="free">r_psi</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span> <span class="main">↑</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_consistent_diverg<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> assms False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> consistent_in_P2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">∈</span> <span class="keyword1">𝒫<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"consistent <span class="free">ψ</span> <span class="main">∈</span> <span class="keyword1">𝒫<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms r_consistent P2E<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> P2I r_consistent_recfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> consistent_for_R2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"consistent <span class="free">ψ</span> <span class="free">i</span> <span class="free">e</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span>e_length <span class="free">e</span><span class="main">.</span> <span class="free">ψ</span> <span class="free">i</span> <span class="bound">j</span> <span class="main">↓=</span> e_nth <span class="free">e</span> <span class="bound">j</span> <span class="keyword1">then</span> Some <span class="main">0</span> <span class="keyword1">else</span> Some <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> consistent_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> consistent_init<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"consistent <span class="free">ψ</span> <span class="free">i</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">ψ</span> <span class="free">i</span> <span class="main">▹</span> <span class="free">n</span> <span class="main">=</span> <span class="free">f</span> <span class="main">▹</span> <span class="free">n</span> <span class="keyword1">then</span> Some <span class="main">0</span> <span class="keyword1">else</span> Some <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> consistent_def<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"init <span class="free">f</span> <span class="free">n</span>"</span></span><span class="main">]</span> assms  init_eq_iff_eq_upto <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> consistent_in_R2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"consistent <span class="free">ψ</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> total2I consistent_in_P2 consistent_for_R2<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> P2_total_imp_R2 R2_imp_P2 assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For total hypothesis spaces the next function computes the
minimum hypothesis consistent with a given prefix. It diverges if no such
hypothesis exists.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">min_cons_hyp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial2 <span class="main">⇒</span> partial1"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">min_cons_hyp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span>
    <span class="keyword1">if</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> consistent <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">↓=</span> <span class="main">0</span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i</span><span class="main">.</span> consistent <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">↓=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">else</span> None"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> min_cons_hyp_in_P1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"min_cons_hyp <span class="free">ψ</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms consistent_in_R2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rc</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    rc<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="skolem">rc</span>"</span></span> <span class="quoted"><span class="quoted">"total <span class="skolem">rc</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">e</span><span class="main">.</span> eval <span class="skolem">rc</span> <span class="main">[</span><span class="bound">i</span><span class="main">,</span> <span class="bound">e</span><span class="main">]</span> <span class="main">=</span> consistent <span class="free">ψ</span> <span class="bound">i</span> <span class="bound">e</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> R2E<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"consistent <span class="free">ψ</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> Mn <span class="main">1</span> <span class="skolem">rc</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rc<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">r</span> <span class="main">[</span><span class="skolem">e</span><span class="main">]</span> <span class="main">=</span> min_cons_hyp <span class="free">ψ</span> <span class="skolem">e</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">e</span>
    <span class="keyword1"><span class="command">using</span></span> r_def eval_Mn'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="skolem">rc</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">e</span><span class="main">]</span>"</span></span><span class="main">]</span> rc min_cons_hyp_def assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> consistent_in_R2<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"min_cons_hyp <span class="free"><span class="free">ψ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a strategy for
learning all NUM classes embedded in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">ψ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. It is an example of an
``identification-by-enumeration'' strategy.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> NUM_imp_learn_total<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">∈</span> NUM_wrt <span class="free">ψ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"learn_total <span class="free">ψ</span> <span class="free">U</span> <span class="main">(</span>min_cons_hyp <span class="free">ψ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> learn_totalI<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ex_psi_i_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="free">ψ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span>
    <span class="keyword1"><span class="command">using</span></span> assms that NUM_wrt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> consistent_eq_0<span class="main">:</span> <span class="quoted"><span class="quoted">"consistent <span class="free">ψ</span> <span class="skolem">i</span> <span class="main">(</span><span class="main">(</span><span class="free">ψ</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> consistent_init<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">⟹</span> min_cons_hyp <span class="free">ψ</span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> min_cons_hyp_def assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> env<span class="main">:</span> <span class="quoted"><span class="quoted">"environment <span class="free">ψ</span> <span class="free">U</span> <span class="main">(</span>min_cons_hyp <span class="free">ψ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms NUM_wrt_def min_cons_hyp_in_P1 NUM_E<span class="main">(</span>1<span class="main">)</span> NUM_I <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">⟹</span> <span class="free">ψ</span> <span class="main">(</span>the <span class="main">(</span>min_cons_hyp <span class="free">ψ</span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="free">ψ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> min_cons_hyp <span class="free">ψ</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> that env <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">ψ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">imin</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">imin</span> <span class="main">≡</span> Least <span class="var">?P</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> ex_psi_i_f that <span class="keyword1"><span class="command">have</span></span> imin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">imin</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">≥</span> <span class="skolem">imin</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> LeastI_ex<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">]</span> Least_le<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f_neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="skolem">i</span> <span class="main">≠</span> <span class="skolem">f</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">imin</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">using</span></span> leD that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span> <span class="bound">n</span><span class="main">.</span> <span class="free">ψ</span> <span class="bound">i</span> <span class="main">▹</span> <span class="bound">n</span> <span class="main">≠</span> <span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">nu</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nu</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">SOME</span> <span class="bound">n</span><span class="main">.</span> <span class="var">?Q</span> <span class="bound">i</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> nu_neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="skolem">i</span> <span class="main">▹</span> <span class="main">(</span><span class="skolem">nu</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">f</span> <span class="main">▹</span> <span class="main">(</span><span class="skolem">nu</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">imin</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms imin<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">≠</span> <span class="free">ψ</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> that f_neq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span> <span class="main">≠</span> <span class="main">(</span><span class="free">ψ</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">▹</span> <span class="bound">n</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> neq_fun_neq_init <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="skolem">i</span> <span class="main">(</span><span class="skolem">nu</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> nu_def <span class="keyword1"><span class="command">using</span></span> someI_ex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="var">?Q</span> <span class="skolem">i</span> <span class="bound">n</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> min_cons_hyp <span class="free">ψ</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="skolem">imin</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">imin</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> min_cons_hyp <span class="free">ψ</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="skolem">imin</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> consistent_eq_0 assms<span class="main">(</span>1<span class="main">)</span> imin<span class="main">(</span>1<span class="main">)</span> min_cons_hyp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> Max <span class="main">(</span>set <span class="main">(</span>map <span class="skolem">nu</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">imin</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> Max <span class="var">?N</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nu</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">imin</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?N</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> n<span class="hidden">⇩</span><sub>0</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?N</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> False n<span class="hidden">⇩</span><sub>0</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nu</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="var">?N</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> that Max_ge n<span class="hidden">⇩</span><sub>0</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="skolem">i</span> <span class="main">▹</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≠</span> <span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">imin</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
        <span class="keyword1"><span class="command">using</span></span> nu_neq neq_init_forall_ge that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="skolem">i</span> <span class="main">▹</span> <span class="skolem">n</span> <span class="main">≠</span> <span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">imin</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">n</span>
        <span class="keyword1"><span class="command">using</span></span> nu_neq neq_init_forall_ge that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="skolem">imin</span> <span class="main">▹</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
        <span class="keyword1"><span class="command">using</span></span> imin<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>consistent <span class="free">ψ</span> <span class="skolem">i</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ψ</span> <span class="skolem">i</span> <span class="main">▹</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">n</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> consistent_init<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min_cons_hyp <span class="free">ψ</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i</span><span class="main">.</span> <span class="free">ψ</span> <span class="bound">i</span> <span class="main">▹</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
        <span class="keyword1"><span class="command">using</span></span> min_cons_hyp_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ψ</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i</span><span class="main">.</span> <span class="free">ψ</span> <span class="bound">i</span> <span class="main">▹</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">imin</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Least_equality<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="skolem">imin</span> <span class="main">▹</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> imin<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="free">ψ</span> <span class="bound">y</span> <span class="main">▹</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span> <span class="main">⟹</span> <span class="skolem">imin</span> <span class="main">≤</span> <span class="bound">y</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> imin * leI that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min_cons_hyp <span class="free">ψ</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="skolem">imin</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
        <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> imin<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> NUM_subseteq_TOTAL<span class="main">:</span> <span class="quoted"><span class="quoted">"NUM <span class="main">⊆</span> TOTAL"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">U</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">∈</span> NUM"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ψ</span><span class="main">∈</span><span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span><span class="main">.</span> <span class="main">∀</span><span class="bound">f</span><span class="main">∈</span><span class="skolem">U</span><span class="main">.</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="bound">ψ</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ψ</span><span class="main">∈</span><span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span><span class="main">.</span> <span class="skolem">U</span> <span class="main">∈</span> NUM_wrt <span class="bound">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> NUM_wrt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ψ</span> <span class="bound">s</span><span class="main">.</span> learn_total <span class="bound">ψ</span> <span class="skolem">U</span> <span class="bound">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> NUM_imp_learn_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">∈</span> TOTAL"</span></span>
    <span class="keyword1"><span class="command">using</span></span> TOTAL_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The class <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">V0</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"TOTAL <span class="main"><span class="main">-</span></span> NUM"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. ›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> NUM_subset_TOTAL<span class="main">:</span> <span class="quoted"><span class="quoted">"NUM <span class="main">⊂</span> TOTAL"</span></span>
  <span class="keyword1"><span class="command">using</span></span> CP_subseteq_TOTAL FIN_not_subseteq_NUM FIN_subseteq_CP NUM_subseteq_TOTAL
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="CONS_LIM">
<div class="head">
<h1>Theory CONS_LIM</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹CONS is a proper subset of LIM\label{s:cons_lim}›</span></span>

<span class="keyword1"><span class="command">theory</span></span> CONS_LIM
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Inductive_Inference_Basics.html">Inductive_Inference_Basics</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹That there are classes in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">LIM</span></span> <span class="main"><span class="main">-</span></span> CONS"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> was noted by
Barzdin~\cite{b-iiafp-74,b-iiafp-77} and Blum and Blum~\cite{bb-tmtii-75}. It
was proven by Wiehagen~\cite{w-lerfss-76} (see also Wiehagen and
Zeugmann~\cite{wz-idmowle-94}). The proof uses this class:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">U_LIMCONS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial1 set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">U<span class="hidden">⇘</span><sub>LIM-CONS</sub><span class="hidden">⇙</span></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"U<span class="hidden">⇘</span><sub>LIM-CONS</sub><span class="hidden">⇙</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">vs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">j</span><span class="main">]</span> <span class="main">⊙</span> <span class="bound">p</span><span class="main">|</span> <span class="bound">vs</span> <span class="bound">j</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≥</span> <span class="numeral">2</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="keyword1">φ</span> <span class="bound">j</span> <span class="main">=</span> <span class="bound">vs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">j</span><span class="main">]</span> <span class="main">⊙</span> <span class="bound">p</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Every function in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"U<span class="hidden">⇘</span><sub>LIM-CONS</sub><span class="hidden">⇙</span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> carries a Gödel number
greater or equal two of itself, after which only zeros and ones occur.
Thus, a strategy that always outputs the rightmost value greater or equal two
in the given prefix will converge to this Gödel number.

The next function searches an encoded list for the rightmost element
greater or equal two.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rmge2</span> <span class="main">::</span> <span class="quoted">partial1</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rmge2</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span>
    <span class="keyword1">if</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>e_length <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">.</span> e_nth <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="keyword1">then</span> Some <span class="main">0</span>
    <span class="keyword1">else</span> Some <span class="main">(</span>e_nth <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> e_length <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∧</span> e_nth <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">i</span> <span class="main">≥</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rmge2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> list_decode <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rmge2 <span class="free">e</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free">xs</span><span class="main">.</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="keyword1">then</span> Some <span class="main">0</span>
    <span class="keyword1">else</span> Some <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">∧</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≥</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span> <span class="main">&lt;</span> e_length <span class="free">e</span> <span class="main">∧</span> e_nth <span class="free">e</span> <span class="skolem">i</span> <span class="main">≥</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">∧</span> <span class="free">xs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">≥</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> e_length <span class="free">e</span> <span class="main">∧</span> e_nth <span class="free">e</span> <span class="bound">i</span> <span class="main">≥</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">∧</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≥</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free">xs</span><span class="main">.</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>e_length <span class="free">e</span><span class="main">.</span> e_nth <span class="free">e</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">∧</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≥</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"Greatest <span class="var">?P</span> <span class="main">&lt;</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free">xs</span><span class="main">.</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that GreatestI_ex_nat<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">]</span> le_less_linear order.asym <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rmge2_def assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rmge2_init<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rmge2 <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>Suc <span class="free">n</span><span class="main">.</span> the <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="keyword1">then</span> Some <span class="main">0</span>
    <span class="keyword1">else</span> Some <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> Suc <span class="free">n</span> <span class="main">∧</span> the <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≥</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"prefix <span class="free">f</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">▹</span> <span class="free">n</span> <span class="main">=</span> list_encode <span class="var">?xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>Suc <span class="free">n</span><span class="main">.</span> the <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">&lt;</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="var">?xs</span><span class="main">.</span> <span class="var">?xs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> Suc <span class="free">n</span> <span class="main">∧</span> the <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≥</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="var">?xs</span> <span class="main">∧</span> <span class="var">?xs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≥</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> length_prefix<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> prefix_nth<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> Suc <span class="free">n</span> <span class="main">∧</span> the <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≥</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">&lt;</span> Suc <span class="free">n</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>Suc <span class="free">n</span><span class="main">.</span> the <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">&lt;</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that GreatestI_ex_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span>Suc <span class="free">n</span> <span class="main">∧</span> the <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rmge2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> rmge2_init_total<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"total1 <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rmge2 <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>Suc <span class="free">n</span><span class="main">.</span> the <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="keyword1">then</span> Some <span class="main">0</span>
    <span class="keyword1">else</span> <span class="free">f</span> <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> Suc <span class="free">n</span> <span class="main">∧</span> the <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≥</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms total1_def rmge2_init <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> rmge2_in_R1<span class="main">:</span> <span class="quoted"><span class="quoted">"rmge2 <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> Cn <span class="numeral">3</span> r_ifle <span class="main">[</span>r_constn <span class="numeral">2</span> <span class="numeral">2</span><span class="main">,</span> Cn <span class="numeral">3</span> r_nth <span class="main">[</span>Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span> Cn <span class="numeral">3</span> r_nth <span class="main">[</span>Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">3</span> <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="skolem">g</span> <span class="main">[</span><span class="skolem">j</span><span class="main">,</span> <span class="skolem">r</span><span class="main">,</span> <span class="skolem">e</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="numeral">2</span> <span class="main">≤</span> e_nth <span class="skolem">e</span> <span class="skolem">j</span> <span class="keyword1">then</span> e_nth <span class="skolem">e</span> <span class="skolem">j</span> <span class="keyword1">else</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span> <span class="skolem">r</span> <span class="skolem">e</span>
    <span class="keyword1"><span class="command">using</span></span> g_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Pr <span class="main">1</span> Z <span class="skolem">g</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="var">?h</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">3</span> <span class="skolem">g</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="var">?h</span> <span class="main">[</span><span class="skolem">j</span><span class="main">,</span> <span class="skolem">e</span><span class="main">]</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="skolem">j</span><span class="main">.</span> e_nth <span class="skolem">e</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="keyword1">then</span> Some <span class="main">0</span>
    <span class="keyword1">else</span> Some <span class="main">(</span>e_nth <span class="skolem">e</span> <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">j</span> <span class="main">∧</span> e_nth <span class="skolem">e</span> <span class="bound">i</span> <span class="main">≥</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span> <span class="skolem">e</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">2</span> <span class="var">?h</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?h</span> <span class="main">[</span>Suc <span class="skolem">j</span><span class="main">,</span> <span class="skolem">e</span><span class="main">]</span> <span class="main">=</span> eval <span class="skolem">g</span> <span class="main">[</span><span class="skolem">j</span><span class="main">,</span> the <span class="main">(</span>eval <span class="var">?h</span> <span class="main">[</span><span class="skolem">j</span><span class="main">,</span> <span class="skolem">e</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">e</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">2</span> <span class="var">?h</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="var">?h</span> <span class="main">[</span>Suc <span class="skolem">j</span><span class="main">,</span> <span class="skolem">e</span><span class="main">]</span> <span class="main">↓=</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="numeral">2</span> <span class="main">≤</span> e_nth <span class="skolem">e</span> <span class="skolem">j</span> <span class="keyword1">then</span> e_nth <span class="skolem">e</span> <span class="skolem">j</span>
       <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="skolem">j</span><span class="main">.</span> e_nth <span class="skolem">e</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="keyword1">then</span> <span class="main">0</span>
            <span class="keyword1">else</span> <span class="main">(</span>e_nth <span class="skolem">e</span> <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">j</span> <span class="main">∧</span> e_nth <span class="skolem">e</span> <span class="bound">i</span> <span class="main">≥</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> g Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>Suc <span class="skolem">j</span><span class="main">.</span> e_nth <span class="skolem">e</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="numeral">2</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> ex<span class="main">:</span> False
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> e_nth <span class="skolem">e</span> <span class="skolem">j</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?h</span> <span class="main">[</span>Suc <span class="skolem">j</span><span class="main">,</span> <span class="skolem">e</span><span class="main">]</span> <span class="main">↓=</span> e_nth <span class="skolem">e</span> <span class="skolem">j</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> Suc <span class="skolem">j</span> <span class="main">∧</span> e_nth <span class="skolem">e</span> <span class="bound">i</span> <span class="main">≥</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ex True Greatest_equality<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span>  <span class="bound">i</span> <span class="main">&lt;</span> Suc <span class="skolem">j</span> <span class="main">∧</span> e_nth <span class="skolem">e</span> <span class="bound">i</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ex <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="skolem">j</span><span class="main">.</span> e_nth <span class="skolem">e</span> <span class="bound">i</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ex leI less_Suc_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?h</span> <span class="main">[</span>Suc <span class="skolem">j</span><span class="main">,</span> <span class="skolem">e</span><span class="main">]</span> <span class="main">↓=</span> e_nth <span class="skolem">e</span> <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">j</span> <span class="main">∧</span> e_nth <span class="skolem">e</span> <span class="bound">i</span> <span class="main">≥</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> leD<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> Suc <span class="skolem">j</span> <span class="main">∧</span> e_nth <span class="skolem">e</span> <span class="bound">i</span> <span class="main">≥</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span>
            <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">j</span> <span class="main">∧</span> e_nth <span class="skolem">e</span> <span class="bound">i</span> <span class="main">≥</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> False ex <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_SucI less_Suc_eq less_antisym numeral_2_eq_2<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ex <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?hh</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="main">1</span> <span class="var">?h</span> <span class="main">[</span>Cn <span class="main">1</span> r_length <span class="main">[</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span> Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="var">?hh</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">2</span> <span class="var">?h</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> h <span class="keyword1"><span class="command">have</span></span> hh<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="var">?hh</span> <span class="main">[</span><span class="skolem">e</span><span class="main">]</span> <span class="main">↓=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>e_length <span class="skolem">e</span><span class="main">.</span> e_nth <span class="skolem">e</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="keyword1">then</span> <span class="main">0</span>
     <span class="keyword1">else</span> e_nth <span class="skolem">e</span> <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> e_length <span class="skolem">e</span> <span class="main">∧</span> e_nth <span class="skolem">e</span> <span class="bound">i</span> <span class="main">≥</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">e</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?hh</span> <span class="main">[</span><span class="skolem">e</span><span class="main">]</span> <span class="main">=</span> rmge2 <span class="skolem">e</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">e</span>
    <span class="keyword1"><span class="command">unfolding</span></span> rmge2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"total <span class="var">?hh</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> hh totalI1 <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="var">?hh</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="var">?hh</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The first part of the main result is that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"U<span class="hidden">⇘</span><sub>LIM-CONS</sub><span class="hidden">⇙</span> <span class="main"><span class="main">∈</span></span> <span class="keyword1"><span class="keyword1">LIM</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> U_LIMCONS_in_Lim<span class="main">:</span> <span class="quoted"><span class="quoted">"U<span class="hidden">⇘</span><sub>LIM-CONS</sub><span class="hidden">⇙</span> <span class="main">∈</span> <span class="keyword1">LIM</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"U<span class="hidden">⇘</span><sub>LIM-CONS</sub><span class="hidden">⇙</span> <span class="main">⊆</span> <span class="keyword1">ℛ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> U_LIMCONS_def <span class="keyword1"><span class="command">using</span></span> prepend_in_R1 RPred1_subseteq_R1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"learn_lim <span class="keyword1">φ</span> U<span class="hidden">⇘</span><sub>LIM-CONS</sub><span class="hidden">⇙</span> rmge2"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> learn_limI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"environment <span class="keyword1">φ</span> U<span class="hidden">⇘</span><sub>LIM-CONS</sub><span class="hidden">⇙</span> rmge2"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹U_LIMCONS <span class="main">⊆</span> <span class="keyword1">ℛ</span>›</span></span> phi_in_P2 rmge2_def rmge2_in_R1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> rmge2 <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> U<span class="hidden">⇘</span><sub>LIM-CONS</sub><span class="hidden">⇙</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> that <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">vs</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="skolem">j</span> <span class="main">=</span> <span class="skolem">vs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">j</span><span class="main">]</span> <span class="main">⊙</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="skolem">vs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">j</span><span class="main">]</span> <span class="main">⊙</span> <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> U_LIMCONS_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="skolem">j</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"total1 <span class="skolem">f</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹U<span class="hidden">⇘</span><sub>LIM-CONS</sub><span class="hidden">⇙</span> <span class="main">⊆</span> <span class="keyword1">ℛ</span>›</span></span> R1_imp_total1 total1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> length <span class="skolem">vs</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> f_gr_n0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">n</span> <span class="main">↓=</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">f</span> <span class="skolem">n</span> <span class="main">↓=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> that n<span class="hidden">⇩</span><sub>0</sub>_def f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">with</span></span> RPred1_def p <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rmge2 <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> n0_greatest<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> Suc <span class="skolem">n</span> <span class="main">∧</span> the <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≥</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Greatest_equality<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">&lt;</span> Suc <span class="skolem">n</span> <span class="main">∧</span> the <span class="main">(</span><span class="skolem">f</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> n<span class="hidden">⇩</span><sub>0</sub>_def f that j <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> Suc <span class="skolem">n</span> <span class="main">∧</span> the <span class="main">(</span><span class="skolem">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">≥</span> <span class="numeral">2</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">≤</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&lt;</span> Suc <span class="skolem">n</span> <span class="main">∧</span> <span class="numeral">2</span> <span class="main">≤</span> the <span class="main">(</span><span class="skolem">f</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="keyword1">ℛ</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">p</span> <span class="bound">n</span> <span class="main">↓=</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">p</span> <span class="bound">n</span> <span class="main">↓=</span> <span class="main">1</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> RPred1_def p <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> f_gr_n0
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_1 Suc_n_not_le_n Zero_neq_Suc le_less_linear le_zero_eq option.sel<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">↓=</span> <span class="skolem">j</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> n<span class="hidden">⇩</span><sub>0</sub>_def f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>Suc <span class="skolem">n</span><span class="main">.</span> the <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">&lt;</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> j that less_Suc_eq_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rmge2 <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> Suc <span class="skolem">n</span> <span class="main">∧</span> the <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≥</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> rmge2_init_total <span class="quoted"><span class="quoted">‹total1 <span class="skolem">f</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> n0_greatest <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">↓=</span> <span class="skolem">j</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">φ</span> <span class="skolem">j</span> <span class="main">=</span> <span class="skolem">f</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Lim_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The class <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"U_LIMCONS"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is \emph{prefix-complete}, which
means that every non-empty list is the prefix of some function in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"U_LIMCONS"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. To show this we use an auxiliary lemma: For every $f \in
\mathcal{R}$ and $k \in \mathbb{N}$ the value of $f$ at $k$ can be replaced
by a Gödel number of the function resulting from the replacement.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> goedel_at<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">k</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="free">m</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span> <span class="keyword1">then</span> Some <span class="bound">n</span> <span class="keyword1">else</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">psi</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial1 <span class="main">⇒</span> nat <span class="main">⇒</span> partial2"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">psi</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span> <span class="bound">k</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">k</span> <span class="keyword1">then</span> Some <span class="bound">i</span> <span class="keyword1">else</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">psi</span> <span class="free">f</span> <span class="free">k</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"total <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">r</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r_psi</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">r_psi</span> <span class="main">=</span> Cn <span class="numeral">2</span> r_ifeq <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">1</span><span class="main">,</span> r_dummy <span class="main">1</span> <span class="main">(</span>r_const <span class="free">k</span><span class="main">)</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">0</span><span class="main">,</span> Cn <span class="numeral">2</span> <span class="skolem">r</span> <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">]</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> R2I<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">r_psi</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> r_psi_def <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="skolem">r_psi</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> r<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">r_psi</span> <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">k</span> <span class="keyword1">then</span> Some <span class="skolem">i</span> <span class="keyword1">else</span> <span class="free">f</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Cn <span class="numeral">2</span> <span class="skolem">r</span> <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> r <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">r_psi</span> <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> eval r_ifeq <span class="main">[</span><span class="skolem">x</span><span class="main">,</span> <span class="free">k</span><span class="main">,</span> <span class="skolem">i</span><span class="main">,</span> the <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span><span class="main">]</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> r_psi_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">2</span> <span class="skolem">r_psi</span>›</span></span> r R1_imp_total1<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> eval <span class="skolem">r_psi</span> <span class="main">[</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">psi</span> <span class="free">f</span> <span class="free">k</span> <span class="bound">x</span> <span class="bound">y</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> psi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"total <span class="skolem">r_psi</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> totalI2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">r_psi</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">2</span> <span class="skolem">r_psi</span>›</span></span> assms psi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">psi</span> <span class="free">f</span> <span class="free">k</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms kleene_fixed_point<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">psi</span> <span class="free">f</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="free">m</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> psi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> U_LIMCONS_prefix_complete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">vs</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">∈</span>U<span class="hidden">⇘</span><sub>LIM-CONS</sub><span class="hidden">⇙</span><span class="main">.</span> prefix <span class="bound">f</span> <span class="main">(</span>length <span class="free">vs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">vs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Some <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">vs</span> <span class="main">@</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span> <span class="main">⊙</span> <span class="var">?p</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prepend_in_R1 RPred1_subseteq_R1 const0_in_RPred1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> goedel_at<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="quoted">"length <span class="free">vs</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> length <span class="free">vs</span> <span class="keyword1">then</span> Some <span class="skolem">j</span> <span class="keyword1">else</span> <span class="var">?f</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?g</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">vs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">j</span><span class="main">]</span> <span class="main">⊙</span> <span class="var">?p</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?g</span> <span class="main">∈</span> U<span class="hidden">⇘</span><sub>LIM-CONS</sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> U_LIMCONS_def <span class="keyword1"><span class="command">using</span></span> const0_in_RPred1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefix <span class="var">?g</span> <span class="main">(</span>length <span class="free">vs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">vs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> g assms prefixI prepend_associative <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Roughly speaking, a strategy learning a prefix-complete class
must be total because it must be defined for every prefix in
the class. Technically, however, the empty list is not a prefix, and thus a
strategy may diverge on input 0. We can work around this by
showing that if there is a strategy learning a prefix-complete class then
there is also a total strategy learning this class. We need the result only
for consistent learning.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> U_prefix_complete_imp_total_strategy<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">vs</span><span class="main">.</span> length <span class="bound">vs</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">f</span><span class="main">∈</span><span class="free">U</span><span class="main">.</span> prefix <span class="bound">f</span> <span class="main">(</span>length <span class="bound">vs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="bound">vs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"learn_cons <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span> total1 <span class="bound">t</span> <span class="main">∧</span> learn_cons <span class="free">ψ</span> <span class="free">U</span> <span class="bound">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">e</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> Some <span class="main">0</span> <span class="keyword1">else</span> <span class="free">s</span> <span class="bound">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="skolem">e</span> <span class="main">↓</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">e</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_decode <span class="skolem">e</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?vs</span> <span class="main">≠</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> list_encode_0 list_encode_decode <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_imp_neq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?vs</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="quoted"><span class="quoted">"prefix <span class="skolem">f</span> <span class="main">(</span>length <span class="var">?vs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?vs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> learn_cons_def learn_limE <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="main">(</span>length <span class="var">?vs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">↓</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="skolem">e</span> <span class="main">↓</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f<span class="main">(</span>2<span class="main">)</span> init_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"total1 <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> t_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> learn_consE <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> rs<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">rs</span>"</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">rs</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> <span class="free">s</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">rt</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rt</span> <span class="main">=</span> Cn <span class="main">1</span> <span class="main">(</span>r_lifz Z <span class="skolem">rs</span><span class="main">)</span> <span class="main">[</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">,</span> Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">rt</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">rt</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">t</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">using</span></span> rs rt_def t_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">unfolding</span></span> t_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_neq_zero<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"learn_cons <span class="free">ψ</span> <span class="free">U</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>›</span></span> assms<span class="main">(</span>2<span class="main">)</span> learn_consE<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">ψ</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">U</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">s</span></span></span></span></span></span><span class="main">]</span> learn_consI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ψ</span></span> <span class="quoted"><span class="free">U</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹total1 <span class="skolem">t</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The proof of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span> <span class="quoted"><span class="quoted">"U<span class="hidden">⇘</span><sub>LIM-CONS</sub><span class="hidden">⇙</span> <span class="main"><span class="main">∉</span></span> CONS"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is by contradiction.
Assume there is a consistent learning strategy $S$. By the previous
lemma $S$ can be assumed to be total. Moreover it outputs a consistent
hypothesis for every prefix. Thus for every $e \in \mathbb{N}^+$, $S(e) \neq
S(e0)$ or $S(e) \neq S(e1)$ because $S(e)$ cannot be consistent with both
$e0$ and $e1$. We use this property of $S$ to construct a function in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"U<span class="hidden">⇘</span><sub>LIM-CONS</sub><span class="hidden">⇙</span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for which $S$ fails as a learning strategy. To
this end we define a numbering $\psi \in \mathcal{R}^2$ with $\psi_i(0) = i$
and
\[
\psi_i(x + 1) = \left\{\begin{array}{ll}
    0 &amp; \mbox{if } S(\psi_i^x0) \neq S(\psi_i^x),\\
    1 &amp; \mbox{otherwise}.
\end{array}\right.
\]
This numbering is recursive because $S$ is total. The ``otherwise'' case is
equivalent to $S(\psi_i^x1) \neq S(\psi_i^x)$ because $S(\psi_i^x)$ cannot be
consistent with both $\psi_i^x0$ and $\psi_i^x1$. Therefore every prefix
$\psi_i^x$ is extended in such a way that $S$ changes its hypothesis. Hence
$S$ does not learn $\psi_i$ in the limit. Kleene's fixed-point theorem
ensures that for some $j \geq 2$, $\varphi_j = \psi_j$. This $\psi_j$ is the
sought function in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"U<span class="hidden">⇘</span><sub>LIM-CONS</sub><span class="hidden">⇙</span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

The following locale formalizes the construction of $\psi$ for a total
strategy $S$.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> cons_lim <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span> <span class="main">::</span> <span class="quoted">partial1</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> s_in_R1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">recf</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> computing the strategy:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">r_s</span> <span class="main">::</span> <span class="quoted">recf</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">r_s</span> <span class="main">≡</span> <span class="keyword1">SOME</span> <span class="bound">r_s</span><span class="main">.</span> recfn <span class="main">1</span> <span class="bound">r_s</span> <span class="main">∧</span>  total <span class="bound">r_s</span> <span class="main">∧</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> eval <span class="bound">r_s</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_s_recfn <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> r_s"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> r_s_total <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> eval r_s <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> eval_r_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> eval r_s <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> r_s_def R1_SOME<span class="main">[</span><span class="operator">OF</span> s_in_R1<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">r_s</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next function represents the prefixes of $\psi_i$.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">prefixes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">prefixes</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">prefixes</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">prefixes</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">@</span>
    <span class="main">[</span><span class="keyword1">if</span> <span class="free">s</span> <span class="main">(</span>e_snoc <span class="main">(</span>list_encode <span class="main">(</span><span class="free">prefixes</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span> <span class="main">(</span>list_encode <span class="main">(</span><span class="free">prefixes</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>
     <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_prefixes_aux</span> <span class="main">≡</span>
  Cn <span class="numeral">3</span> r_ifeq
   <span class="main">[</span>Cn <span class="numeral">3</span> r_s <span class="main">[</span>Cn <span class="numeral">3</span> r_snoc <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">1</span><span class="main">,</span> r_constn <span class="numeral">2</span> <span class="main">0</span><span class="main">]</span><span class="main">]</span><span class="main">,</span>
    Cn <span class="numeral">3</span> r_s <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span><span class="main">,</span>
    Cn <span class="numeral">3</span> r_snoc <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">1</span><span class="main">,</span> r_constn <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">,</span>
    Cn <span class="numeral">3</span> r_snoc <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">1</span><span class="main">,</span> r_constn <span class="numeral">2</span> <span class="main">0</span><span class="main">]</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_prefixes_aux_recfn<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">3</span> r_prefixes_aux"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_prefixes_aux_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_prefixes_aux<span class="main">:</span>
  <span class="quoted"><span class="quoted">"eval r_prefixes_aux <span class="main">[</span><span class="free">j</span><span class="main">,</span> <span class="free">v</span><span class="main">,</span> <span class="free">i</span><span class="main">]</span> <span class="main">↓=</span>
    e_snoc <span class="free">v</span> <span class="main">(</span><span class="keyword1">if</span> eval r_s <span class="main">[</span>e_snoc <span class="free">v</span> <span class="main">0</span><span class="main">]</span> <span class="main">=</span> eval r_s <span class="main">[</span><span class="free">v</span><span class="main">]</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_prefixes_aux_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_prefixes</span> <span class="main">≡</span> r_swap <span class="main">(</span>Pr <span class="main">1</span> r_singleton_encode r_prefixes_aux<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_prefixes_recfn<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> r_prefixes"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_prefixes_def r_prefixes_aux_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_prefixes<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_prefixes <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">n</span><span class="main">]</span> <span class="main">↓=</span> list_encode <span class="main">(</span>prefixes <span class="free">i</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?h</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Pr <span class="main">1</span> r_singleton_encode r_prefixes_aux"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?h</span> <span class="main">[</span><span class="free">n</span><span class="main">,</span> <span class="free">i</span><span class="main">]</span> <span class="main">↓=</span> list_encode <span class="main">(</span>prefixes <span class="free">i</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> r_prefixes_def r_prefixes_aux_recfn r_singleton_encode <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> r_prefixes_aux_recfn r_prefixes_aux eval_r_s
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?h</span> <span class="main">[</span><span class="skolem">n</span><span class="main">,</span> <span class="skolem">i</span><span class="main">]</span> <span class="main">=</span> eval r_prefixes <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">n</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">unfolding</span></span> r_prefixes_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_prefixes_aux_recfn<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prefixes_neq_nil<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>prefixes <span class="free">i</span> <span class="free">x</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The actual numbering can then be defined via <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">prefixes</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">psi</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial2"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ψ</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ψ</span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> Some <span class="main">(</span>last <span class="main">(</span>prefixes <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> psi_in_R2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r_psi</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r_psi</span> <span class="main">≡</span> Cn <span class="numeral">2</span> r_last <span class="main">[</span>r_prefixes<span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="skolem">r_psi</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> r_psi_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_prefixes_recfn<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">r_psi</span> <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">n</span><span class="main">]</span> <span class="main">↓=</span> last <span class="main">(</span>prefixes <span class="skolem">i</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">unfolding</span></span> r_psi_def <span class="keyword1"><span class="command">using</span></span> r_prefixes r_prefixes_recfn prefixes_neq_nil <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">x</span><span class="main">.</span> Some <span class="main">(</span>last <span class="main">(</span>prefixes <span class="bound">i</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">𝒫<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">2</span> <span class="skolem">r_psi</span>›</span></span> P2I<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">r_psi</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> psi_def <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="main">∈</span> <span class="keyword1">𝒫<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"total2 psi"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> psi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> psi_0_or_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="free">i</span> <span class="free">n</span> <span class="main">↓=</span> <span class="main">0</span> <span class="main">∨</span> <span class="keyword1">ψ</span> <span class="free">i</span> <span class="free">n</span> <span class="main">↓=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> Suc <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gr0_implies_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"last <span class="main">(</span>prefixes <span class="free">i</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> last <span class="main">(</span>prefixes <span class="free">i</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">=</span> Suc <span class="skolem">m</span>›</span></span> psi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"prefixes"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> does indeed provide the prefixes
for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">ψ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> psi_init<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">ψ</span> <span class="free">i</span><span class="main">)</span> <span class="main">▹</span> <span class="free">x</span> <span class="main">=</span> list_encode <span class="main">(</span>prefixes <span class="free">i</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefix <span class="main">(</span><span class="keyword1">ψ</span> <span class="free">i</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> prefixes <span class="free">i</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> psi_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefix_0 prefix_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> init_def <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹One of the functions $\psi_i$ is in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"U<span class="hidden">⇘</span><sub>LIM-CONS</sub><span class="hidden">⇙</span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ex_psi_in_U<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="keyword1">ψ</span> <span class="bound">j</span> <span class="main">∈</span> U<span class="hidden">⇘</span><sub>LIM-CONS</sub><span class="hidden">⇙</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="skolem">j</span> <span class="main">=</span> <span class="keyword1">φ</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> kleene_fixed_point<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="keyword1">ψ</span></span><span class="main">]</span> psi_in_R2 R2_imp_P2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="skolem">j</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> phi_in_P2<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">ψ</span> <span class="skolem">j</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> p_def <span class="quoted"><span class="quoted">‹<span class="keyword1">ψ</span> <span class="skolem">j</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>›</span></span> skip_P1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> psi_in_R2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"total1 <span class="main">(</span><span class="keyword1">ψ</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> p_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"total1 <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> total1_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> psi_0_or_1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="skolem">n</span> <span class="main">↓=</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">↓=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
      <span class="keyword1"><span class="command">using</span></span> psi_def p_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> RPred1_def P1_total_imp_R1 <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>›</span></span> <span class="quoted"><span class="quoted">‹total1 <span class="skolem">p</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">j</span><span class="main">]</span> <span class="main">⊙</span> <span class="skolem">p</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="skolem">j</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="skolem">j</span><span class="main">]</span> <span class="main">⊙</span> <span class="skolem">p</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> psi_def psi_def prepend_at_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> p_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="skolem">j</span> <span class="main">∈</span> U<span class="hidden">⇘</span><sub>LIM-CONS</sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> j U_LIMCONS_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> append_Nil mem_Collect_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The strategy fails to learn <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">U_LIMCONS</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> because it changes
its hypothesis all the time on functions $\psi_j \in V_0$.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> U_LIMCONS_not_learn_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> learn_cons <span class="keyword1">φ</span> U<span class="hidden">⇘</span><sub>LIM-CONS</sub><span class="hidden">⇙</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> learn<span class="main">:</span> <span class="quoted"><span class="quoted">"learn_cons <span class="keyword1">φ</span> U<span class="hidden">⇘</span><sub>LIM-CONS</sub><span class="hidden">⇙</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">(</span>list_encode <span class="main">(</span><span class="skolem">vs</span> <span class="main">@</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="free">s</span> <span class="main">(</span>list_encode <span class="main">(</span><span class="skolem">vs</span> <span class="main">@</span> <span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">vs</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> f0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> U<span class="hidden">⇘</span><sub>LIM-CONS</sub><span class="hidden">⇙</span>"</span></span> <span class="quoted"><span class="quoted">"prefix <span class="skolem">f<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>length <span class="skolem">vs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">vs</span> <span class="main">@</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> U_LIMCONS_prefix_complete<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">@</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> U<span class="hidden">⇘</span><sub>LIM-CONS</sub><span class="hidden">⇙</span>"</span></span> <span class="quoted"><span class="quoted">"prefix <span class="skolem">f<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span>length <span class="skolem">vs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">vs</span> <span class="main">@</span> <span class="main">[</span><span class="main">1</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> U_LIMCONS_prefix_complete<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">@</span> <span class="main">[</span><span class="main">1</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>length <span class="skolem">vs</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">f<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span>length <span class="skolem">vs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f0 f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lessI nth_append_length prefix_nth zero_neq_one<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span><span class="skolem">f<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">▹</span> length <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">vs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>length <span class="skolem">vs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> learn_consE<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="keyword1">φ</span></span> <span class="quoted">U_LIMCONS</span> <span class="quoted"><span class="free">s</span></span><span class="main">,</span> <span class="operator">OF</span> learn<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">f<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">vs</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> f0<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span><span class="skolem">f<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">▹</span> length <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">vs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span>length <span class="skolem">vs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> learn_consE<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="keyword1">φ</span></span> <span class="quoted">U_LIMCONS</span> <span class="quoted"><span class="free">s</span></span><span class="main">,</span> <span class="operator">OF</span> learn<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">f<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">vs</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> f1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="free">s</span> <span class="main">(</span><span class="skolem">f<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">▹</span> length <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> the <span class="main">(</span><span class="free">s</span> <span class="main">(</span><span class="skolem">f<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">▹</span> length <span class="skolem">vs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">(</span><span class="skolem">f<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">▹</span> length <span class="skolem">vs</span><span class="main">)</span> <span class="main">≠</span> <span class="free">s</span> <span class="main">(</span><span class="skolem">f<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">▹</span> length <span class="skolem">vs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> f0<span class="main">(</span>2<span class="main">)</span> f1<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">(</span>list_encode <span class="main">(</span><span class="skolem">vs</span> <span class="main">@</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="free">s</span> <span class="main">(</span>list_encode <span class="skolem">vs</span><span class="main">)</span> <span class="main">∨</span>
      <span class="free">s</span> <span class="main">(</span>list_encode <span class="main">(</span><span class="skolem">vs</span> <span class="main">@</span> <span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="free">s</span> <span class="main">(</span>list_encode <span class="skolem">vs</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">vs</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">(</span>list_encode <span class="main">(</span>prefixes <span class="skolem">i</span> <span class="main">(</span>Suc <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="free">s</span> <span class="main">(</span>list_encode <span class="main">(</span>prefixes <span class="skolem">i</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> learn_lim <span class="keyword1">φ</span> <span class="main">{</span><span class="keyword1">ψ</span> <span class="skolem">i</span><span class="main">}</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> psi_def psi_init always_hyp_change_not_Lim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> learn_lim <span class="keyword1">φ</span> U_LIMCONS <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex_psi_in_U learn_lim_closed_subseteq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> learn learn_cons_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹With the locale we can now show the second part of the main
result:›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> U_LIMCONS_not_in_CONS<span class="main">:</span> <span class="quoted"><span class="quoted">"U<span class="hidden">⇘</span><sub>LIM-CONS</sub><span class="hidden">⇙</span> <span class="main">∉</span> CONS"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"U<span class="hidden">⇘</span><sub>LIM-CONS</sub><span class="hidden">⇙</span> <span class="main">∈</span> CONS"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"U<span class="hidden">⇘</span><sub>LIM-CONS</sub><span class="hidden">⇙</span> <span class="main">∈</span> CONS_wrt <span class="keyword1">φ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> CONS_wrt_phi_eq_CONS<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">almost_s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"learn_cons <span class="keyword1">φ</span> U<span class="hidden">⇘</span><sub>LIM-CONS</sub><span class="hidden">⇙</span> <span class="skolem">almost_s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> CONS_wrt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"total1 <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"learn_cons <span class="keyword1">φ</span> U<span class="hidden">⇘</span><sub>LIM-CONS</sub><span class="hidden">⇙</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> U_LIMCONS_prefix_complete U_prefix_complete_imp_total_strategy <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> learn_consE<span class="main">(</span>1<span class="main">)</span> P1_total_imp_R1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> cons_lim_def <span class="keyword1"><span class="command">interpret</span></span> cons_lim <span class="quoted"><span class="skolem">s</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> s<span class="main">(</span>2<span class="main">)</span> U_LIMCONS_not_learn_cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The main result of this section:›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> CONS_subset_Lim<span class="main">:</span> <span class="quoted"><span class="quoted">"CONS <span class="main">⊂</span> <span class="keyword1">LIM</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> U_LIMCONS_in_Lim U_LIMCONS_not_in_CONS CONS_subseteq_Lim <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Lemma_R">
<div class="head">
<h1>Theory Lemma_R</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Lemma R\label{s:lemma_r}›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Lemma_R
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Inductive_Inference_Basics.html">Inductive_Inference_Basics</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A common technique for constructing a class that cannot be
learned is diagonalization against all strategies (see, for instance,
Section~\ref{s:lim_bc}). Similarly, the typical way of proving that a class
cannot be learned is by assuming there is a strategy and deriving a
contradiction. Both techniques are easier to carry out if one has to consider
only \emph{total} recursive strategies. This is not possible in general,
since after all the definitions of the inference types admit strictly partial
strategies. However, for many inference types one can show that for every
strategy there is a total strategy with at least the same ``learning power''.
Results to that effect are called Lemma~R.

Lemma~R comes in different strengths depending on how general the
construction of the total recursive strategy is. CONS is the only inference
type considered here for which not even a weak form of Lemma~R holds.›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Strong Lemma R for LIM, FIN, and BC›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In its strong form Lemma~R says that for any strategy $S$, there
is a total strategy $T$ that learns all classes $S$ learns regardless of
hypothesis space. The strategy $T$ can be derived from $S$ by a delayed
simulation of $S$. More precisely, for input $f^n$, $T$ simulates $S$ for
prefixes $f^0, f^1, \ldots, f^n$ for at most $n$ steps. If $S$ halts on none
of the prefixes, $T$ outputs an arbitrary hypothesis. Otherwise let $k \leq
n$ be maximal such that $S$ halts on $f^k$ in at most $n$ steps. Then $T$
outputs $S(f^k)$. ›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We reformulate some lemmas for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">r_result1</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to make it easier
to use them with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">φ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_result1_converg_phi<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">i</span> <span class="free">x</span> <span class="main">↓=</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">≥</span><span class="bound">t</span><span class="main">.</span> eval r_result1 <span class="main">[</span><span class="bound">t'</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="free">v</span><span class="main">)</span> <span class="main">∧</span> 
    <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&lt;</span><span class="bound">t</span><span class="main">.</span> eval r_result1 <span class="main">[</span><span class="bound">t'</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms r_result1_converg' phi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> r_result1_bivalent'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval r_result1 <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="free">v</span> <span class="main">∨</span> eval r_result1 <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms r_result1 r_result_bivalent' r_phi'' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_result1_bivalent_phi<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">i</span> <span class="free">x</span> <span class="main">↓=</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval r_result1 <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="free">v</span> <span class="main">∨</span> eval r_result1 <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms r_result1_bivalent' phi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> r_result1_diverg_phi<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">i</span> <span class="free">x</span> <span class="main">↑</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval r_result1 <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms phi_def r_result1_diverg' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_result1_some_phi<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eval r_result1 <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">i</span> <span class="free">x</span> <span class="main">↓=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms phi_def r_result1_Some' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_result1_saturating'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"eval r_result1 <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval r_result1 <span class="main">[</span><span class="free">t</span> <span class="main">+</span> <span class="free">d</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms r_result1 r_result_saturating r_phi'' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_result1_saturating_the<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>eval r_result1 <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">≥</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>eval r_result1 <span class="main">[</span><span class="free">t'</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"eval r_result1 <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_result1_bivalent_phi r_result1_diverg_phi
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inc_induct le_0_eq not_less_zero option.discI option.expand option.sel<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_result1 <span class="main">[</span><span class="free">t'</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_result1_saturating' le_Suc_ex <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Greatest_bounded_Suc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="free">P</span> <span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="keyword1">then</span> Suc <span class="free">n</span>
          <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> <span class="free">P</span> <span class="bound">j</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="keyword1">then</span> Suc <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">j</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span>Suc <span class="free">n</span><span class="main">.</span> <span class="free">P</span> <span class="bound">j</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="keyword1">then</span> Suc <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> Suc <span class="free">n</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">j</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span>Suc <span class="free">n</span><span class="main">.</span> <span class="free">P</span> <span class="bound">j</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 1<span class="main">:</span> True
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> Suc <span class="free">n</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">j</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Greatest_equality<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> Suc <span class="free">n</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">j</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> Suc <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> Suc <span class="free">n</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">j</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> Suc <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">j</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_SucE<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> Suc <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> Suc <span class="free">n</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">j</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">j</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> Suc <span class="free">n</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">j</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_SucI less_Suc_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For $n$, $i$, $x$, the next function simulates $\varphi_i$ on all
non-empty prefixes of at most length $n$ of the list $x$ for at most $n$
steps. It returns the length of the longest such prefix for which $\varphi_i$
halts, or zero if $\varphi_i$ does not halt for any prefix.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_delay_aux</span> <span class="main">≡</span>
  Pr <span class="numeral">2</span> <span class="main">(</span>r_constn <span class="main">1</span> <span class="main">0</span><span class="main">)</span>
    <span class="main">(</span>Cn <span class="numeral">4</span> r_ifz
      <span class="main">[</span>Cn <span class="numeral">4</span> r_result1
        <span class="main">[</span>Cn <span class="numeral">4</span> r_length <span class="main">[</span>Id <span class="numeral">4</span> <span class="numeral">3</span><span class="main">]</span><span class="main">,</span> Id <span class="numeral">4</span> <span class="numeral">2</span><span class="main">,</span>
         Cn <span class="numeral">4</span> r_take <span class="main">[</span>Cn <span class="numeral">4</span> S <span class="main">[</span>Id <span class="numeral">4</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span> Id <span class="numeral">4</span> <span class="numeral">3</span><span class="main">]</span><span class="main">]</span><span class="main">,</span>
       Id <span class="numeral">4</span> <span class="main">1</span><span class="main">,</span> Cn <span class="numeral">4</span> S <span class="main">[</span>Id <span class="numeral">4</span> <span class="main">0</span><span class="main">]</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_delay_aux_prim<span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="numeral">3</span> r_delay_aux"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_delay_aux_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> r_delay_aux_total<span class="main">:</span> <span class="quoted"><span class="quoted">"total r_delay_aux"</span></span>
  <span class="keyword1"><span class="command">using</span></span>  prim_recfn_total<span class="main">[</span><span class="operator">OF</span> r_delay_aux_prim<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_delay_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> e_length <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval r_delay_aux <span class="main">[</span><span class="free">n</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span>
   <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="free">n</span><span class="main">.</span> the <span class="main">(</span>eval r_result1 <span class="main">[</span>e_length <span class="free">x</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> e_take <span class="main">(</span>Suc <span class="bound">j</span><span class="main">)</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>
    <span class="keyword1">then</span> Suc <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">j</span><span class="main">.</span>
                 <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span>
                 the <span class="main">(</span>eval r_result1 <span class="main">[</span>e_length <span class="free">x</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> e_take <span class="main">(</span>Suc <span class="bound">j</span><span class="main">)</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">≡</span>
    Cn <span class="numeral">4</span> r_result1
      <span class="main">[</span>Cn <span class="numeral">4</span> r_length <span class="main">[</span>Id <span class="numeral">4</span> <span class="numeral">3</span><span class="main">]</span><span class="main">,</span> Id <span class="numeral">4</span> <span class="numeral">2</span><span class="main">,</span> Cn <span class="numeral">4</span> r_take <span class="main">[</span>Cn <span class="numeral">4</span> S <span class="main">[</span>Id <span class="numeral">4</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span> Id <span class="numeral">4</span> <span class="numeral">3</span><span class="main">]</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> z_recfn<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">4</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="skolem">z</span> <span class="main">[</span><span class="skolem">j</span><span class="main">,</span> <span class="skolem">r</span><span class="main">,</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> eval r_result1 <span class="main">[</span>e_length <span class="skolem">x</span><span class="main">,</span> <span class="skolem">i</span><span class="main">,</span> e_take <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="skolem">x</span><span class="main">]</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> e_length <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span> <span class="skolem">r</span> <span class="skolem">i</span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">unfolding</span></span> z_def <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">≡</span> Cn <span class="numeral">4</span> r_ifz <span class="main">[</span><span class="skolem">z</span><span class="main">,</span> Id <span class="numeral">4</span> <span class="main">1</span><span class="main">,</span> Cn <span class="numeral">4</span> S <span class="main">[</span>Id <span class="numeral">4</span> <span class="main">0</span><span class="main">]</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="skolem">g</span> <span class="main">[</span><span class="skolem">j</span><span class="main">,</span> <span class="skolem">r</span><span class="main">,</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">↓=</span>
      <span class="main">(</span><span class="keyword1">if</span> the <span class="main">(</span>eval r_result1 <span class="main">[</span>e_length <span class="skolem">x</span><span class="main">,</span> <span class="skolem">i</span><span class="main">,</span> e_take <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="keyword1">then</span> Suc <span class="skolem">j</span> <span class="keyword1">else</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> e_length <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span> <span class="skolem">r</span> <span class="skolem">i</span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> that z prim_recfn_total z_recfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_delay_aux <span class="main">[</span><span class="main">0</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> eval_Pr_0 r_delay_aux_def r_delay_aux_prim r_constn
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_delay_aux_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">j</span><span class="main">.</span> the <span class="main">(</span>eval r_result1 <span class="main">[</span>e_length <span class="free">x</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> e_take <span class="main">(</span>Suc <span class="bound">j</span><span class="main">)</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_delay_aux <span class="main">[</span><span class="skolem">n</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_delay_aux <span class="main">[</span>Suc <span class="skolem">n</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span>
        eval <span class="main">(</span>Pr <span class="numeral">2</span> <span class="main">(</span>r_constn <span class="main">1</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">g</span><span class="main">)</span> <span class="main">[</span>Suc <span class="skolem">n</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> r_delay_aux_def g_def z_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_delay_aux <span class="main">[</span>Suc <span class="skolem">n</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span>
        eval <span class="skolem">g</span> <span class="main">[</span><span class="skolem">n</span><span class="main">,</span> the <span class="main">(</span>eval r_delay_aux <span class="main">[</span><span class="skolem">n</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> r_delay_aux_prim Suc eval_Pr_converg_Suc
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_delay_aux_def g_def z_def numeral_3_eq_3<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_delay_aux <span class="main">[</span>Suc <span class="skolem">n</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span>
        <span class="main">(</span><span class="keyword1">if</span> <span class="var">?P</span> <span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="keyword1">then</span> Suc <span class="skolem">n</span>
         <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="skolem">n</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">j</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="keyword1">then</span> Suc <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="skolem">n</span> <span class="main">∧</span> <span class="var">?P</span> <span class="bound">j</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> g Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_delay_aux <span class="main">[</span>Suc <span class="skolem">n</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span>
        <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span>Suc <span class="skolem">n</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">j</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="keyword1">then</span> Suc <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> Suc <span class="skolem">n</span> <span class="main">∧</span> <span class="var">?P</span> <span class="bound">j</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Greatest_bounded_Suc<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?P</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?P</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next function simulates $\varphi_i$ on all non-empty prefixes
of a list $x$ of length $n$ for at most $n$ steps and outputs the length of
the longest prefix for which $\varphi_i$ halts, or zero if $\varphi_i$ does
not halt for any such prefix.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_delay</span> <span class="main">≡</span> Cn <span class="numeral">2</span> r_delay_aux <span class="main">[</span>Cn <span class="numeral">2</span> r_length <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_delay_recfn <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> r_delay"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_delay_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_delay_aux_prim<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> r_delay<span class="main">:</span>
  <span class="quoted"><span class="quoted">"eval r_delay <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span>e_length <span class="free">x</span><span class="main">.</span> the <span class="main">(</span>eval r_result1 <span class="main">[</span>e_length <span class="free">x</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> e_take <span class="main">(</span>Suc <span class="bound">j</span><span class="main">)</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>
     <span class="keyword1">then</span> Suc <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">j</span><span class="main">.</span>
        <span class="bound">j</span> <span class="main">&lt;</span> e_length <span class="free">x</span> <span class="main">∧</span> the <span class="main">(</span>eval r_result1 <span class="main">[</span>e_length <span class="free">x</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> e_take <span class="main">(</span>Suc <span class="bound">j</span><span class="main">)</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span>
     <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_delay_def <span class="keyword1"><span class="command">using</span></span> r_delay_aux r_delay_aux_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">delay</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> Some
 <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span>e_length <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">.</span> the <span class="main">(</span>eval r_result1 <span class="main">[</span>e_length <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> e_take <span class="main">(</span>Suc <span class="bound">j</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>
  <span class="keyword1">then</span> Suc <span class="main">(</span><span class="keyword1">GREATEST</span> <span class="bound">j</span><span class="main">.</span>
    <span class="bound">j</span> <span class="main">&lt;</span> e_length <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span> the <span class="main">(</span>eval r_result1 <span class="main">[</span>e_length <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> e_take <span class="main">(</span>Suc <span class="bound">j</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span>
  <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> delay_in_R2<span class="main">:</span> <span class="quoted"><span class="quoted">"delay <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> r_delay totalI2 R2I delay_def r_delay_recfn
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> numeral_2_eq_2 option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> delay_le_length<span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>delay <span class="free">i</span> <span class="free">x</span><span class="main">)</span> <span class="main">≤</span> e_length <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span>e_length <span class="free">x</span><span class="main">.</span> the <span class="main">(</span>eval r_result1 <span class="main">[</span>e_length <span class="free">x</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> e_take <span class="main">(</span>Suc <span class="bound">j</span><span class="main">)</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> e_length <span class="free">x</span> <span class="main">∧</span> the <span class="main">(</span>eval r_result1 <span class="main">[</span>e_length <span class="free">x</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> e_take <span class="main">(</span>Suc <span class="bound">j</span><span class="main">)</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">≤</span> e_length <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>Greatest <span class="var">?P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> GreatestI_ex_nat<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?P</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?P</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Greatest <span class="var">?P</span> <span class="main">&lt;</span> e_length <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"delay <span class="free">i</span> <span class="free">x</span> <span class="main">↓=</span> Suc <span class="main">(</span>Greatest <span class="var">?P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> delay_def True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> delay_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> e_take_delay_init<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>delay <span class="free">i</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"e_take <span class="main">(</span>the <span class="main">(</span>delay <span class="free">i</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">▹</span> <span class="main">(</span>the <span class="main">(</span>delay <span class="free">i</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms e_take_init<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="main">_</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> length_init<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> delay_le_length<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">▹</span> <span class="free">n</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_le_lessD Suc_pred<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> delay_gr0_converg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>delay <span class="free">i</span> <span class="free">x</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">i</span> <span class="main">(</span>e_take <span class="main">(</span>the <span class="main">(</span>delay <span class="free">i</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">↓</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> e_length <span class="free">x</span> <span class="main">∧</span> the <span class="main">(</span>eval r_result1 <span class="main">[</span>e_length <span class="free">x</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> e_take <span class="main">(</span>Suc <span class="bound">j</span><span class="main">)</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">j</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"delay <span class="free">i</span> <span class="free">x</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> delay_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>delay <span class="free">i</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>Greatest <span class="var">?P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> delay_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">≤</span> e_length <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>Greatest <span class="var">?P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">j</span>›</span></span> GreatestI_ex_nat<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?P</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="var">?P</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>eval r_result1 <span class="main">[</span>e_length <span class="free">x</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> e_take <span class="main">(</span>Suc <span class="main">(</span>Greatest <span class="var">?P</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>eval r_result1 <span class="main">[</span>e_length <span class="free">x</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> e_take <span class="main">(</span>the <span class="main">(</span>delay <span class="free">i</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> d <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> r_result1_diverg_phi <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> delay_unbounded<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">m</span><span class="main">.</span> the <span class="main">(</span>delay <span class="free">i</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span> the <span class="main">(</span>eval r_result1 <span class="main">[</span><span class="bound">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_result1_converg_phi
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_refl option.exhaust_sel option.sel zero_less_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>eval r_result1 <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"max <span class="free">n</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="var">?m</span> <span class="main">≥</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>eval r_result1 <span class="main">[</span>Suc <span class="var">?m</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?w</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"eval r_result1 <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">]</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?w</span> <span class="main">↓=</span> Suc <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t assms<span class="main">(</span>2<span class="main">)</span> r_result1_bivalent_phi <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_result1 <span class="main">[</span>Suc <span class="var">?m</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">]</span> <span class="main">=</span> <span class="var">?w</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> v t r_result1_saturating' <span class="quoted"><span class="quoted">‹Suc <span class="var">?m</span> <span class="main">≥</span> <span class="skolem">t</span>›</span></span> le_Suc_ex <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> t <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">▹</span> <span class="var">?m</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>delay <span class="free">i</span> <span class="var">?x</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> e_length <span class="var">?x</span> <span class="main">∧</span> the <span class="main">(</span>eval r_result1 <span class="main">[</span>e_length <span class="var">?x</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> e_take <span class="main">(</span>Suc <span class="bound">j</span><span class="main">)</span> <span class="var">?x</span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_length <span class="var">?x</span> <span class="main">=</span> Suc <span class="var">?m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_take <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="var">?x</span> <span class="main">=</span> <span class="free">f</span> <span class="main">▹</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> e_take_init <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">≤</span> e_length <span class="var">?x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="main">(</span>Greatest <span class="var">?P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Greatest_le_nat<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"e_length <span class="var">?x</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>delay <span class="free">i</span> <span class="var">?x</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>Greatest <span class="var">?P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> delay_def <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> delay_monotone<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> <span class="free">n<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>delay <span class="free">i</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> the <span class="main">(</span>delay <span class="free">i</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>delay <span class="free">i</span> <span class="var">?x1</span><span class="main">)</span> <span class="main">≤</span> the <span class="main">(</span>delay <span class="free">i</span> <span class="var">?x2</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>delay <span class="free">i</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> e_length <span class="var">?x1</span> <span class="main">∧</span> the <span class="main">(</span>eval r_result1 <span class="main">[</span>e_length <span class="var">?x1</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> e_take <span class="main">(</span>Suc <span class="bound">j</span><span class="main">)</span> <span class="var">?x1</span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> e_length <span class="var">?x2</span> <span class="main">∧</span> the <span class="main">(</span>eval r_result1 <span class="main">[</span>e_length <span class="var">?x2</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> e_take <span class="main">(</span>Suc <span class="bound">j</span><span class="main">)</span> <span class="var">?x2</span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> d1<span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>delay <span class="free">i</span> <span class="var">?x1</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>Greatest <span class="var">?P1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="var">?P1</span> <span class="bound">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> delay_def option.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="var">?P1</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">≤</span> e_length <span class="var">?x1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P1</span> <span class="main">(</span>Greatest <span class="var">?P1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> GreatestI_ex_nat<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?P1</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?j</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Greatest <span class="var">?P1</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?j</span> <span class="main">&lt;</span> e_length <span class="var">?x1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"e_take <span class="main">(</span>Suc <span class="var">?j</span><span class="main">)</span> <span class="var">?x1</span> <span class="main">=</span> e_take <span class="main">(</span>Suc <span class="var">?j</span><span class="main">)</span> <span class="var">?x2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms e_take_init <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?j</span> <span class="main">&lt;</span> e_length <span class="var">?x2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> 1 * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>eval r_result1 <span class="main">[</span>e_length <span class="var">?x1</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> e_take <span class="main">(</span>Suc <span class="var">?j</span><span class="main">)</span> <span class="var">?x2</span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_length <span class="var">?x1</span> <span class="main">≤</span> e_length <span class="var">?x2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>eval r_result1 <span class="main">[</span>e_length <span class="var">?x2</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> e_take <span class="main">(</span>Suc <span class="var">?j</span><span class="main">)</span> <span class="var">?x2</span><span class="main">]</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_result1_saturating_the <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P2</span> <span class="var">?j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> d2<span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>delay <span class="free">i</span> <span class="var">?x2</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>Greatest <span class="var">?P2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> delay_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="var">?P2</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">≤</span> e_length <span class="var">?x2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P2</span> <span class="var">?j</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?j</span> <span class="main">≤</span> <span class="main">(</span>Greatest <span class="var">?P2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Greatest_le_nat<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?P2</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> d1 d2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> delay_unbounded_monotone<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">m<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">≥</span><span class="bound">m<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> the <span class="main">(</span>delay <span class="free">i</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms delay_unbounded <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>delay <span class="free">i</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">≥</span><span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> the <span class="main">(</span>delay <span class="free">i</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> delay_monotone order.strict_trans2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now we can define a function that simulates an arbitrary strategy
$\varphi_i$ in a delayed way. The parameter $d$ is the default hypothesis for
when $\varphi_i$ does not halt within the time bound for any prefix.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">r_totalizer</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> recf"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">r_totalizer</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">≡</span>
     Cn <span class="numeral">2</span>
      <span class="main">(</span>r_lifz
        <span class="main">(</span>r_constn <span class="main">1</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span>
        <span class="main">(</span>Cn <span class="numeral">2</span> r_phi
          <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">0</span><span class="main">,</span> Cn <span class="numeral">2</span> r_take <span class="main">[</span>Cn <span class="numeral">2</span> r_delay <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
      <span class="main">[</span>Cn <span class="numeral">2</span> r_delay <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_totalizer_recfn<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="main">(</span>r_totalizer <span class="free">d</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_totalizer_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_totalizer<span class="main">:</span>
  <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_totalizer <span class="free">d</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> the <span class="main">(</span>delay <span class="free">i</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> Some <span class="free">d</span> <span class="keyword1">else</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="main">(</span>e_take <span class="main">(</span>the <span class="main">(</span>delay <span class="free">i</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="numeral">2</span> r_delay <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?i</span> <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> eval r_delay <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> r_delay_recfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="var">?i</span> <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> delay <span class="skolem">i</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> r_delay <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> delay_def<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"r_constn <span class="main">1</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="var">?t</span> <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="numeral">2</span> r_take <span class="main">[</span><span class="var">?i</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="numeral">2</span> r_phi <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">0</span><span class="main">,</span> <span class="var">?e1</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?e1</span> <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> eval r_take <span class="main">[</span>the <span class="main">(</span>delay <span class="skolem">i</span> <span class="skolem">x</span><span class="main">)</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> r_delay i delay_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?e1</span> <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">↓=</span> e_take <span class="main">(</span>the <span class="main">(</span>delay <span class="skolem">i</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> delay_le_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="var">?e</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="main">(</span>e_take <span class="main">(</span>the <span class="main">(</span>delay <span class="free">i</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> phi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?z</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"r_lifz <span class="var">?t</span> <span class="var">?e</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> recfn_te<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="var">?t</span>"</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="var">?e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_totalizer <span class="free">d</span><span class="main">)</span> <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> eval <span class="main">(</span>r_lifz <span class="var">?t</span> <span class="var">?e</span><span class="main">)</span> <span class="main">[</span>the <span class="main">(</span>delay <span class="skolem">i</span> <span class="skolem">x</span><span class="main">)</span><span class="main">,</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">unfolding</span></span> r_totalizer_def <span class="keyword1"><span class="command">using</span></span> i r_totalizer_recfn delay_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_totalizer <span class="free">d</span><span class="main">)</span> <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">if</span> the <span class="main">(</span>delay <span class="skolem">i</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> eval <span class="var">?t</span> <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="keyword1">else</span> eval <span class="var">?e</span> <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> recfn_te <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> t e <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_totalizer_total<span class="main">:</span> <span class="quoted"><span class="quoted">"total <span class="main">(</span>r_totalizer <span class="free">d</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> totalI2<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="main">(</span>r_totalizer <span class="free">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r_totalizer_recfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> eval <span class="main">(</span>r_totalizer <span class="free">d</span><span class="main">)</span> <span class="main">[</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_totalizer delay_gr0_converg <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">totalizer</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> partial2"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">totalizer</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span>
     <span class="keyword1">if</span> the <span class="main">(</span>delay <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="keyword1">else</span> <span class="keyword1">φ</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>e_take <span class="main">(</span>the <span class="main">(</span>delay <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> totalizer_init<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"totalizer <span class="free">d</span> <span class="free">i</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> the <span class="main">(</span>delay <span class="free">i</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> Some <span class="free">d</span>
     <span class="keyword1">else</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="main">(</span>the <span class="main">(</span>delay <span class="free">i</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms e_take_delay_init <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> totalizer_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> totalizer_in_R2<span class="main">:</span> <span class="quoted"><span class="quoted">"totalizer <span class="free">d</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> totalizer_def r_totalizer r_totalizer_total R2I r_totalizer_recfn
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For LIM, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">totalizer</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> works with every default hypothesis
$d$.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lemma_R_for_Lim<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"learn_lim <span class="free">ψ</span> <span class="free">U</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"learn_lim <span class="free">ψ</span> <span class="free">U</span> <span class="main">(</span>totalizer <span class="free">d</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> learn_limI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> env<span class="main">:</span> <span class="quoted"><span class="quoted">"environment <span class="free">ψ</span> <span class="free">U</span> <span class="main">(</span>totalizer <span class="free">d</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms learn_limE<span class="main">(</span>1<span class="main">)</span> totalizer_in_R2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="free">ψ</span> <span class="bound">j</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> totalizer <span class="free">d</span> <span class="free">i</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms env that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> assms learn_limE <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="skolem"><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span>
      j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="skolem">j</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      n0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">∈</span> <span class="free">U</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> m0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">≥</span><span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> the <span class="main">(</span>delay <span class="free">i</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> delay_unbounded_monotone <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">∈</span> <span class="free">U</span>›</span></span> assms learn_limE<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">≥</span><span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> totalizer <span class="free">d</span> <span class="free">i</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">m</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="main">(</span>e_take <span class="main">(</span>the <span class="main">(</span>delay <span class="free">i</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> totalizer_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">≥</span><span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> totalizer <span class="free">d</span> <span class="free">i</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">m</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="main">(</span>the <span class="main">(</span>delay <span class="free">i</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> e_take_delay_init m0 <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> m0 n0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">≥</span><span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> totalizer <span class="free">d</span> <span class="free">i</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">m</span><span class="main">)</span> <span class="main">↓=</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> j <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The effective version of Lemma~R for LIM states that there is a
total recursive function computing Gödel numbers of total strategies
from those of arbitrary strategies.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lemma_R_for_Lim_effective<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">g</span><span class="main">∈</span><span class="keyword1">ℛ</span><span class="main">.</span> <span class="main">∀</span><span class="bound">i</span><span class="main">.</span>
     <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="bound">g</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">ℛ</span> <span class="main">∧</span>
     <span class="main">(</span><span class="main">∀</span><span class="bound">U</span> <span class="bound">ψ</span><span class="main">.</span> learn_lim <span class="bound">ψ</span> <span class="bound">U</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟶</span> learn_lim <span class="bound">ψ</span> <span class="bound">U</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="bound">g</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"totalizer <span class="main">0</span> <span class="main">∈</span> <span class="keyword1">𝒫<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> totalizer_in_R2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span>totalizer <span class="main">0</span><span class="main">)</span> <span class="bound">i</span> <span class="main">=</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> numbering_translation_for_phi <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> totalizer_in_R2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> R2_proj_R1<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> g<span class="main">(</span>2<span class="main">)</span> lemma_R_for_Lim<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?d</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="bound">U</span> <span class="bound">ψ</span><span class="main">.</span> learn_lim <span class="bound">ψ</span> <span class="bound">U</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟶</span> learn_lim <span class="bound">ψ</span> <span class="bound">U</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="skolem">g</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> g<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In order for us to use the previous lemma, we need a function
that performs the actual computation:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_limr</span> <span class="main">≡</span>
 <span class="keyword1">SOME</span> <span class="bound">g</span><span class="main">.</span>
   recfn <span class="main">1</span> <span class="bound">g</span> <span class="main">∧</span>
   total <span class="bound">g</span> <span class="main">∧</span>
   <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span>eval <span class="bound">g</span> <span class="main">[</span><span class="bound">i</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">ℛ</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">U</span> <span class="bound">ψ</span><span class="main">.</span> learn_lim <span class="bound">ψ</span> <span class="bound">U</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟶</span> learn_lim <span class="bound">ψ</span> <span class="bound">U</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span>eval <span class="bound">g</span> <span class="main">[</span><span class="bound">i</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_limr_recfn<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> r_limr"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> r_limr_total<span class="main">:</span> <span class="quoted"><span class="quoted">"total r_limr"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> r_limr<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span>eval r_limr <span class="main">[</span><span class="free">i</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
    <span class="quoted"><span class="quoted">"learn_lim <span class="free">ψ</span> <span class="free">U</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="free">i</span><span class="main">)</span> <span class="main">⟹</span> learn_lim <span class="free">ψ</span> <span class="free">U</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span>eval r_limr <span class="main">[</span><span class="free">i</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">g</span><span class="main">.</span>
    <span class="bound">g</span> <span class="main">∈</span> <span class="keyword1">ℛ</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="bound">g</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">ℛ</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">U</span> <span class="bound">ψ</span><span class="main">.</span> learn_lim <span class="bound">ψ</span> <span class="bound">U</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟶</span> learn_lim <span class="bound">ψ</span> <span class="bound">U</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="bound">g</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">g</span><span class="main">.</span>
    recfn <span class="main">1</span> <span class="bound">g</span> <span class="main">∧</span>
    total <span class="bound">g</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span>eval <span class="bound">g</span> <span class="main">[</span><span class="bound">i</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">ℛ</span> <span class="main">∧</span> 
       <span class="main">(</span><span class="main">∀</span><span class="bound">U</span> <span class="bound">ψ</span><span class="main">.</span> learn_lim <span class="bound">ψ</span> <span class="bound">U</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟶</span> learn_lim <span class="bound">ψ</span> <span class="bound">U</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span>eval <span class="bound">g</span> <span class="main">[</span><span class="bound">i</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">g</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">g</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lemma_R_for_Lim_effective <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g'</span></span> <span class="keyword2"><span class="keyword">where</span></span> g'<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">g'</span>"</span></span> <span class="quoted"><span class="quoted">"total <span class="skolem">g'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> eval <span class="skolem">g'</span> <span class="main">[</span><span class="bound">i</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">g</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">g</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="skolem">g'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> r_limr_def someI_ex<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> r_limr"</span></span>
    <span class="quoted"><span class="quoted">"total r_limr"</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span>eval r_limr <span class="main">[</span><span class="free">i</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
    <span class="quoted"><span class="quoted">"learn_lim <span class="free">ψ</span> <span class="free">U</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="free">i</span><span class="main">)</span> <span class="main">⟹</span> learn_lim <span class="free">ψ</span> <span class="free">U</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span>eval r_limr <span class="main">[</span><span class="free">i</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For BC, too, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">totalizer</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> works with every default
hypothesis $d$.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lemma_R_for_BC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"learn_bc <span class="free">ψ</span> <span class="free">U</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"learn_bc <span class="free">ψ</span> <span class="free">U</span> <span class="main">(</span>totalizer <span class="free">d</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> learn_bcI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> env<span class="main">:</span> <span class="quoted"><span class="quoted">"environment <span class="free">ψ</span> <span class="free">U</span> <span class="main">(</span>totalizer <span class="free">d</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms learn_bcE<span class="main">(</span>1<span class="main">)</span> totalizer_in_R2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="free">ψ</span> <span class="main">(</span>the <span class="main">(</span>totalizer <span class="free">d</span> <span class="free">i</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms env that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> n0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="free">ψ</span> <span class="main">(</span>the <span class="main">(</span><span class="main">(</span><span class="keyword1">φ</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms learn_bcE <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">∈</span> <span class="free">U</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> m0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">≥</span><span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> the <span class="main">(</span>delay <span class="free">i</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> delay_unbounded_monotone <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">∈</span> <span class="free">U</span>›</span></span> assms learn_bcE<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">≥</span><span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> totalizer <span class="free">d</span> <span class="free">i</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">m</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="main">(</span>e_take <span class="main">(</span>the <span class="main">(</span>delay <span class="free">i</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> totalizer_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">≥</span><span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> totalizer <span class="free">d</span> <span class="free">i</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">m</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="main">(</span>the <span class="main">(</span>delay <span class="free">i</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> e_take_delay_init m0 <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> m0 n0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">≥</span><span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="free">ψ</span> <span class="main">(</span>the <span class="main">(</span>totalizer <span class="free">d</span> <span class="free">i</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> lemma_R_for_BC_simple<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"learn_bc <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s'</span><span class="main">∈</span><span class="keyword1">ℛ</span><span class="main">.</span> learn_bc <span class="free">ψ</span> <span class="free">U</span> <span class="bound">s'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms lemma_R_for_BC totalizer_in_R2 learn_bcE
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> R2_proj_R1 learn_bcE<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> phi_universal<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For FIN the default hypothesis of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">totalizer</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> must be
zero, signalling ``don't know yet''.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lemma_R_for_FIN<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"learn_fin <span class="free">ψ</span> <span class="free">U</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"learn_fin <span class="free">ψ</span> <span class="free">U</span> <span class="main">(</span>totalizer <span class="main">0</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> learn_finI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> env<span class="main">:</span> <span class="quoted"><span class="quoted">"environment <span class="free">ψ</span> <span class="free">U</span> <span class="main">(</span>totalizer <span class="main">0</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms learn_finE<span class="main">(</span>1<span class="main">)</span> totalizer_in_R2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span> <span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="free">ψ</span> <span class="bound">j</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">∧</span>
           <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> totalizer <span class="main">0</span> <span class="free">i</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span>
           <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> totalizer <span class="main">0</span> <span class="free">i</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> Suc <span class="bound">j</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms env that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> assms learn_finE<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">ψ</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">U</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">φ</span></span> <span class="free"><span class="free">i</span></span>"</span></span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="skolem">j</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      ex_n0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> Suc <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">∈</span> <span class="free">U</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> Suc <span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> Least <span class="var">?Q</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> ex_n0 <span class="keyword1"><span class="command">have</span></span> n0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="main">¬</span> <span class="var">?Q</span> <span class="bound">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> LeastI_ex<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span><span class="main">]</span> not_less_Least<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">m<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">≥</span><span class="bound">m<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> the <span class="main">(</span>delay <span class="free">i</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> Least <span class="var">?P</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">m<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">≥</span><span class="bound">m<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> the <span class="main">(</span>delay <span class="free">i</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> delay_unbounded_monotone <span class="quoted"><span class="quoted">‹<span class="skolem">f</span><span class="main">∈</span><span class="keyword1">ℛ</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">∈</span> <span class="free">U</span>›</span></span> assms learn_finE<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> m0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">&lt;</span><span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="main">¬</span> <span class="var">?P</span> <span class="bound">m</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> LeastI_ex<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">]</span> not_less_Least<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">≥</span><span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> totalizer <span class="main">0</span> <span class="free">i</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">m</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="main">(</span>e_take <span class="main">(</span>the <span class="main">(</span>delay <span class="free">i</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> totalizer_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">≥</span><span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> totalizer <span class="main">0</span> <span class="free">i</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">m</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="main">(</span>the <span class="main">(</span>delay <span class="free">i</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> e_take_delay_init m0 <span class="quoted"><span class="quoted">‹<span class="skolem">f</span><span class="main">∈</span><span class="keyword1">ℛ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> m0 n0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">m</span></span><span class="main">≥</span><span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> totalizer <span class="main">0</span> <span class="free">i</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">m</span><span class="main">)</span> <span class="main">↓=</span> Suc <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"totalizer <span class="main">0</span> <span class="free">i</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> <span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">m</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>delay <span class="free">i</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> totalizer_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>delay <span class="free">i</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> m0 that <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>›</span></span> delay_monotone <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> leI order.strict_trans2<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>›</span></span> n0<span class="main">(</span>1<span class="main">)</span> totalizer_init <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc_le_lessD<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> j <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Weaker Lemma R for CP and TOTAL›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For TOTAL the default hypothesis used by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">totalizer</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
depends on the hypothesis space, because it must refer to a total function in
that space. Consequently the total strategy depends on the hypothesis space,
which makes this form of Lemma~R weaker than the ones in the previous
section.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lemma_R_for_TOTAL<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ψ</span> <span class="main">::</span> <span class="quoted">partial2</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">d</span><span class="main">.</span> <span class="main">∀</span><span class="bound">U</span><span class="main">.</span> <span class="main">∀</span><span class="bound">i</span><span class="main">.</span> learn_total <span class="free">ψ</span> <span class="bound">U</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟶</span>  learn_total <span class="free">ψ</span> <span class="bound">U</span> <span class="main">(</span>totalizer <span class="bound">d</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">d</span><span class="main">.</span> <span class="free">ψ</span> <span class="bound">d</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="skolem">d</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"learn_total <span class="free">ψ</span> <span class="skolem">U</span> <span class="main">(</span>totalizer <span class="skolem">d</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"learn_total <span class="free">ψ</span> <span class="skolem">U</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">U</span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> learn_totalI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> env<span class="main">:</span> <span class="quoted"><span class="quoted">"environment <span class="free">ψ</span> <span class="skolem">U</span> <span class="main">(</span>totalizer <span class="skolem">d</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that learn_totalE<span class="main">(</span>1<span class="main">)</span> totalizer_in_R2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="skolem">U</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="free">ψ</span> <span class="bound">j</span> <span class="main">=</span> <span class="bound">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> totalizer <span class="skolem">d</span> <span class="skolem">i</span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that learn_total_def lemma_R_for_Lim<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?d</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">d</span></span><span class="main">]</span> learn_limE<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">(</span>the <span class="main">(</span>totalizer <span class="skolem">d</span> <span class="skolem">i</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="skolem">U</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>delay <span class="skolem">i</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> totalizer_def <span class="quoted"><span class="quoted">‹<span class="free">ψ</span> <span class="skolem">d</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> that env <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> False that <span class="quoted"><span class="quoted">‹learn_total <span class="free">ψ</span> <span class="skolem">U</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="skolem">i</span><span class="main">)</span>›</span></span> totalizer_init learn_totalE<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> learn_total_def lemma_R_for_Lim <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> lemma_R_for_TOTAL_simple<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"learn_total <span class="free">ψ</span> <span class="free">U</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s'</span><span class="main">∈</span><span class="keyword1">ℛ</span><span class="main">.</span> learn_total <span class="free">ψ</span> <span class="free">U</span> <span class="bound">s'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms lemma_R_for_TOTAL totalizer_in_R2
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> R2_proj_R1 learn_totalE<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> phi_universal<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For CP the default hypothesis used by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">totalizer</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> depends
on both the hypothesis space and the class. Therefore the total strategy
depends on both the the hypothesis space and the class, which makes Lemma~R
for CP even weaker than the one for TOTAL.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lemma_R_for_CP<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ψ</span> <span class="main">::</span> <span class="quoted">partial2</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">U</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial1 set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"learn_cp <span class="free">ψ</span> <span class="free">U</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">d</span><span class="main">.</span> learn_cp <span class="free">ψ</span> <span class="free">U</span> <span class="main">(</span>totalizer <span class="bound">d</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms learn_cp_def lemma_R_for_Lim <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">∈</span> <span class="free">U</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="skolem">d</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> learn_cpE<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">∈</span> <span class="free">U</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="skolem">d</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"learn_cp <span class="free">ψ</span> <span class="free">U</span> <span class="main">(</span>totalizer <span class="skolem">d</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> learn_cpI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> env<span class="main">:</span> <span class="quoted"><span class="quoted">"environment <span class="free">ψ</span> <span class="free">U</span> <span class="main">(</span>totalizer <span class="skolem">d</span> <span class="free">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms learn_cpE<span class="main">(</span>1<span class="main">)</span> totalizer_in_R2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="free">ψ</span> <span class="bound">j</span> <span class="main">=</span> <span class="bound">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> totalizer <span class="skolem">d</span> <span class="free">i</span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms learn_cp_def lemma_R_for_Lim<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?d</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">d</span></span><span class="main">]</span> learn_limE<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">(</span>the <span class="main">(</span>totalizer <span class="skolem">d</span> <span class="free">i</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="free">U</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>delay <span class="free">i</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> totalizer_def <span class="quoted"><span class="quoted">‹<span class="free">ψ</span> <span class="skolem">d</span> <span class="main">∈</span> <span class="free">U</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> that env assms totalizer_init learn_cpE<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹No Lemma R for CONS›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This section demonstrates that the class $V_{01}$ of all total
recursive functions $f$ where $f(0)$ or $f(1)$ is a Gödel number of $f$ can
be consistently learned in the limit, but not by a total strategy. This implies
that Lemma~R does not hold for CONS.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">V01</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial1 set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">V<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="bound">f</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="bound">f</span> <span class="main">∨</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="bound">f</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="bound">f</span><span class="main">)</span><span class="main">}</span>"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹No total CONS strategy for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>\label{s:v01_not_total}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In order to show that no total strategy can learn <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> we construct, for each total strategy $S$, one or two
functions in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> such that $S$ fails for at least one
of them. At the core of this construction is a process that given a total
recursive strategy $S$ and numbers $z, i, j \in \mathbb{N}$ builds a function
$f$ as follows: Set $f(0) = i$ and $f(1) = j$. For $x\geq1$:
\begin{enumerate}
\item[(a)] Check whether $S$ changes its hypothesis when $f^x$ is
  extended by 0, that is, if $S(f^x) \neq S(f^x0)$. If so, set $f(x+1) = 0$.
\item[(b)] Otherwise check if $S$ changes its hypothesis when $f^x$ is extended
  by $1$, that is, if $S(f^x) \neq S(f^x1)$. If so, set $f(x+1) = 1$.
\item[(c)] If neither happens, set $f(x+1) = z$.
\end{enumerate}
In other words, as long as we can force $S$ to change its hypothesis by
extending the function by 0 or 1, we do just that. Now there are two
cases:
\begin{enumerate}
\item[Case 1.] For all $x\geq1$ either (a) or (b) occurs; then $S$
  changes its hypothesis on $f$ all the time and thus does not learn $f$ in
  the limit (not to mention consistently). The value of $z$ makes no
  difference in this case.
\item[Case 2.] For some minimal $x$, (c) occurs, that is,
  there is an $f^x$ such that $h := S(f^x) = S(f^x0) = S(f^x1)$. But the
  hypothesis $h$ cannot be consistent with both prefixes $f^x0$ and $f^x1$.
  Running the process once with $z = 0$ and once with $z = 1$ yields two
  functions starting with $f^x0$ and $f^x1$, respectively, such that $S$
  outputs the same hypothesis, $h$, on both prefixes and thus cannot be
  consistent for both functions.
\end{enumerate}
This process is computable because $S$ is total. The construction does not
work if we only assume $S$ to be a CONS strategy for $V_{01}$, because we
need to be able to apply $S$ to prefixes not in $V_{01}$.

The parameters $i$ and $j$ provide flexibility to find functions built by the
above process that are actually in $V_{01}$. To this end we will use
Smullyan's double fixed-point theorem.›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span> <span class="main">::</span> <span class="quoted">partial1</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> s_in_R1 <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">prefixes</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> constructs prefixes according to the
aforementioned process.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">prefixes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">prefixes</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">prefixes</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">prefixes</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">@</span>
    <span class="main">[</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span>
     <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">s</span> <span class="main">(</span>list_encode <span class="main">(</span><span class="free">prefixes</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="free">s</span> <span class="main">(</span>list_encode <span class="main">(</span><span class="free">prefixes</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>
          <span class="keyword1">then</span> <span class="main">0</span>
          <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">s</span> <span class="main">(</span>list_encode <span class="main">(</span><span class="free">prefixes</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="free">s</span> <span class="main">(</span>list_encode <span class="main">(</span><span class="free">prefixes</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>
               <span class="keyword1">then</span> <span class="main">1</span>
               <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prefixes_length<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>prefixes <span class="free">z</span> <span class="free">i</span> <span class="free">j</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> Suc <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The functions <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>[names_short] <span class="quoted"><span class="quoted">"<span class="free"><span class="free">adverse</span></span> <span class="free"><span class="free">z</span></span> <span class="free"><span class="free">i</span></span> <span class="free"><span class="free">j</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are the
functions constructed by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>[names_short] <span class="quoted"><span class="quoted">"prefixes"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">adverse</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">adverse</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> Some <span class="main">(</span>last <span class="main">(</span>prefixes <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> init_adverse_eq_prefixes<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="free">n</span> <span class="main">=</span> list_encode <span class="main">(</span>prefixes <span class="free">z</span> <span class="free">i</span> <span class="free">j</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefix <span class="main">(</span>adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> prefixes <span class="free">z</span> <span class="free">i</span> <span class="free">j</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> adverse_def prefixes_length prefixI' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> adverse_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefix_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> adverse_at_01<span class="main">:</span>
  <span class="quoted"><span class="quoted">"adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span> <span class="main">0</span> <span class="main">↓=</span> <span class="free">i</span>"</span></span>
  <span class="quoted"><span class="quoted">"adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span> <span class="main">1</span> <span class="main">↓=</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> adverse_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Had we introduced ternary partial recursive functions, the
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>[names_short] <span class="quoted"><span class="quoted">"adverse <span class="free"><span class="free">z</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> functions would be among them.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> adverse_in_R3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span><span class="main">.</span> recfn <span class="numeral">3</span> <span class="bound">r</span> <span class="main">∧</span> total <span class="bound">r</span> <span class="main">∧</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">j</span> <span class="bound">x</span><span class="main">.</span> eval <span class="bound">r</span> <span class="main">[</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> adverse <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> rs<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">rs</span>"</span></span> <span class="quoted"><span class="quoted">"total <span class="skolem">rs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> eval <span class="skolem">rs</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> R1E <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> s_total<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">s</span> <span class="bound">x</span> <span class="main">↓</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> Cn <span class="numeral">2</span> r_singleton_encode <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">0</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> eval <span class="skolem">f</span> <span class="main">[</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">]</span> <span class="main">↓=</span> list_encode <span class="main">[</span><span class="bound">i</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ch1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ch1</span> <span class="main">=</span> Cn <span class="numeral">4</span> r_ifeq
    <span class="main">[</span>Cn <span class="numeral">4</span> <span class="skolem">rs</span> <span class="main">[</span>Cn <span class="numeral">4</span> r_snoc <span class="main">[</span>Id <span class="numeral">4</span> <span class="main">1</span><span class="main">,</span> r_constn <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">,</span>
     Cn <span class="numeral">4</span> <span class="skolem">rs</span> <span class="main">[</span>Id <span class="numeral">4</span> <span class="main">1</span><span class="main">]</span><span class="main">,</span>
     r_dummy <span class="numeral">3</span> <span class="main">(</span>r_const <span class="free">z</span><span class="main">)</span><span class="main">,</span>
     r_constn <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ch1<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">4</span> <span class="skolem">ch1</span>"</span></span> <span class="quoted"><span class="quoted">"total <span class="skolem">ch1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cn_total prim_recfn_total rs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ch0</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ch0</span> <span class="main">=</span> Cn <span class="numeral">4</span> r_ifeq
    <span class="main">[</span>Cn <span class="numeral">4</span> <span class="skolem">rs</span> <span class="main">[</span>Cn <span class="numeral">4</span> r_snoc <span class="main">[</span>Id <span class="numeral">4</span> <span class="main">1</span><span class="main">,</span> r_constn <span class="numeral">3</span> <span class="main">0</span><span class="main">]</span><span class="main">]</span><span class="main">,</span>
     Cn <span class="numeral">4</span> <span class="skolem">rs</span> <span class="main">[</span>Id <span class="numeral">4</span> <span class="main">1</span><span class="main">]</span><span class="main">,</span>
     <span class="skolem">ch1</span><span class="main">,</span>
     r_constn <span class="numeral">3</span> <span class="main">0</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ch0_total<span class="main">:</span> <span class="quoted"><span class="quoted">"total <span class="skolem">ch0</span>"</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">4</span> <span class="skolem">ch0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cn_total prim_recfn_total rs ch1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">ch1</span> <span class="main">[</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">v</span><span class="main">,</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">s</span> <span class="main">(</span>e_snoc <span class="skolem">v</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span> <span class="skolem">v</span> <span class="keyword1">then</span> <span class="free">z</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">l</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="skolem">j</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">ch1</span> <span class="main">[</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">v</span><span class="main">,</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">]</span> <span class="main">=</span> eval r_ifeq <span class="main">[</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span>e_snoc <span class="skolem">v</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> the <span class="main">(</span><span class="free">s</span> <span class="skolem">v</span><span class="main">)</span><span class="main">,</span> <span class="free">z</span><span class="main">,</span> <span class="main">1</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ch1_def <span class="keyword1"><span class="command">using</span></span> rs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s_total option.expand<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">ch0</span> <span class="main">[</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">v</span><span class="main">,</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">]</span> <span class="main">↓=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free">s</span> <span class="main">(</span>e_snoc <span class="skolem">v</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span> <span class="skolem">v</span> <span class="keyword1">then</span> the <span class="main">(</span>eval <span class="skolem">ch1</span> <span class="main">[</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">v</span><span class="main">,</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">l</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="skolem">j</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">ch0</span> <span class="main">[</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">v</span><span class="main">,</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">]</span> <span class="main">=</span>
        eval r_ifeq <span class="main">[</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span>e_snoc <span class="skolem">v</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> the <span class="main">(</span><span class="free">s</span> <span class="skolem">v</span><span class="main">)</span><span class="main">,</span> the <span class="main">(</span>eval <span class="skolem">ch1</span> <span class="main">[</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">v</span><span class="main">,</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="main">0</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ch0_def <span class="keyword1"><span class="command">using</span></span> rs ch1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s_total option.expand<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> ch0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l</span> <span class="bound">v</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> eval <span class="skolem">ch0</span> <span class="main">[</span><span class="bound">l</span><span class="main">,</span> <span class="bound">v</span><span class="main">,</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">]</span> <span class="main">↓=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free">s</span> <span class="main">(</span>e_snoc <span class="bound">v</span> <span class="main">0</span><span class="main">)</span> <span class="main">≠</span> <span class="free">s</span> <span class="bound">v</span> <span class="keyword1">then</span> <span class="main">0</span>
     <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">s</span> <span class="main">(</span>e_snoc <span class="bound">v</span> <span class="main">1</span><span class="main">)</span> <span class="main">≠</span> <span class="free">s</span> <span class="bound">v</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="free">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">app</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">app</span> <span class="main">=</span> Cn <span class="numeral">4</span> r_ifz <span class="main">[</span>Id <span class="numeral">4</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">4</span> <span class="numeral">3</span><span class="main">,</span> <span class="skolem">ch0</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">4</span> <span class="skolem">app</span>"</span></span> <span class="quoted"><span class="quoted">"total <span class="skolem">app</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ch0_total totalI4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">app</span> <span class="main">[</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">v</span><span class="main">,</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">l</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="skolem">j</span> <span class="keyword1">else</span> the <span class="main">(</span>eval <span class="skolem">ch0</span> <span class="main">[</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">v</span><span class="main">,</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">l</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">unfolding</span></span> app_def <span class="keyword1"><span class="command">using</span></span> ch0_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> ch0 <span class="keyword1"><span class="command">have</span></span> app<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l</span> <span class="bound">v</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> eval <span class="skolem">app</span> <span class="main">[</span><span class="bound">l</span><span class="main">,</span> <span class="bound">v</span><span class="main">,</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">]</span> <span class="main">↓=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="bound">l</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="bound">j</span>
     <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">s</span> <span class="main">(</span>e_snoc <span class="bound">v</span> <span class="main">0</span><span class="main">)</span> <span class="main">≠</span> <span class="free">s</span> <span class="bound">v</span> <span class="keyword1">then</span> <span class="main">0</span>
     <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">s</span> <span class="main">(</span>e_snoc <span class="bound">v</span> <span class="main">1</span><span class="main">)</span> <span class="main">≠</span> <span class="free">s</span> <span class="bound">v</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="free">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> Cn <span class="numeral">4</span> r_snoc <span class="main">[</span>Id <span class="numeral">4</span> <span class="main">1</span><span class="main">,</span> <span class="skolem">app</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> app <span class="keyword1"><span class="command">have</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l</span> <span class="bound">v</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> eval <span class="skolem">g</span> <span class="main">[</span><span class="bound">l</span><span class="main">,</span> <span class="bound">v</span><span class="main">,</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">]</span> <span class="main">↓=</span> e_snoc <span class="bound">v</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="bound">l</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="bound">j</span>
     <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">s</span> <span class="main">(</span>e_snoc <span class="bound">v</span> <span class="main">0</span><span class="main">)</span> <span class="main">≠</span> <span class="free">s</span> <span class="bound">v</span> <span class="keyword1">then</span> <span class="main">0</span>
     <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">s</span> <span class="main">(</span>e_snoc <span class="bound">v</span> <span class="main">1</span><span class="main">)</span> <span class="main">≠</span> <span class="free">s</span> <span class="bound">v</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="free">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">4</span> <span class="skolem">app</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> g_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">4</span> <span class="skolem">g</span>"</span></span> <span class="quoted"><span class="quoted">"total <span class="skolem">g</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">4</span> <span class="skolem">app</span>›</span></span> <span class="quoted"><span class="quoted">‹total <span class="skolem">app</span>›</span></span> Cn_total Mn_free_imp_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> Pr <span class="numeral">2</span> <span class="skolem">f</span> <span class="skolem">g</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">3</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">2</span> <span class="skolem">f</span>›</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">4</span> <span class="skolem">g</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="skolem">b</span> <span class="main">[</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">]</span> <span class="main">↓=</span> list_encode <span class="main">(</span>prefixes <span class="free">z</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">i</span> <span class="skolem">j</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> b_def <span class="keyword1"><span class="command">using</span></span> f <span class="quoted"><span class="quoted">‹recfn <span class="numeral">2</span> <span class="skolem">f</span>›</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">4</span> <span class="skolem">g</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">b</span> <span class="main">[</span>Suc <span class="skolem">x</span><span class="main">,</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">]</span> <span class="main">=</span> eval <span class="skolem">g</span> <span class="main">[</span><span class="skolem">x</span><span class="main">,</span> the <span class="main">(</span>eval <span class="skolem">b</span> <span class="main">[</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> b_def <span class="quoted"><span class="quoted">‹recfn <span class="numeral">3</span> <span class="skolem">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">↓=</span>
     <span class="main">(</span><span class="keyword1">let</span> <span class="bound">v</span> <span class="main">=</span> list_encode <span class="main">(</span>prefixes <span class="free">z</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">x</span><span class="main">)</span>
      <span class="keyword1">in</span> e_snoc <span class="bound">v</span>
        <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="skolem">j</span>
         <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">s</span> <span class="main">(</span>e_snoc <span class="bound">v</span> <span class="main">0</span><span class="main">)</span> <span class="main">≠</span> <span class="free">s</span> <span class="bound">v</span> <span class="keyword1">then</span> <span class="main">0</span>
              <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">s</span> <span class="main">(</span>e_snoc <span class="bound">v</span> <span class="main">1</span><span class="main">)</span> <span class="main">≠</span> <span class="free">s</span> <span class="bound">v</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="free">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> g Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">↓=</span>
     <span class="main">(</span><span class="keyword1">let</span> <span class="bound">v</span> <span class="main">=</span> list_encode <span class="main">(</span>prefixes <span class="free">z</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">x</span><span class="main">)</span>
      <span class="keyword1">in</span> e_snoc <span class="bound">v</span>
        <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="skolem">j</span>
         <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">s</span> <span class="main">(</span>list_encode <span class="main">(</span>prefixes <span class="free">z</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">x</span> <span class="main">@</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="free">s</span> <span class="bound">v</span> <span class="keyword1">then</span> <span class="main">0</span>
              <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">s</span> <span class="main">(</span>list_encode <span class="main">(</span>prefixes <span class="free">z</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">x</span> <span class="main">@</span> <span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="free">s</span> <span class="bound">v</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="free">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> list_decode_encode <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">b'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="main">=</span> Cn <span class="numeral">3</span> <span class="skolem">b</span> <span class="main">[</span>Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">3</span> <span class="skolem">b'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">3</span> <span class="skolem">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> b <span class="keyword1"><span class="command">have</span></span> b'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span> <span class="bound">x</span><span class="main">.</span> eval <span class="skolem">b'</span> <span class="main">[</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">↓=</span> list_encode <span class="main">(</span>prefixes <span class="free">z</span> <span class="bound">i</span> <span class="bound">j</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> b'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> Cn <span class="numeral">3</span> r_last <span class="main">[</span><span class="skolem">b'</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">3</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">3</span> <span class="skolem">b'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> b' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span> <span class="bound">x</span><span class="main">.</span> eval <span class="skolem">r</span> <span class="main">[</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">↓=</span> last <span class="main">(</span>prefixes <span class="free">z</span> <span class="bound">i</span> <span class="bound">j</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_def prefixes_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"total <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> totalI3 <span class="quoted"><span class="quoted">‹recfn <span class="numeral">3</span> <span class="skolem">r</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">j</span> <span class="bound">x</span><span class="main">.</span> eval <span class="skolem">r</span> <span class="main">[</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> adverse <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> adverse_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">3</span> <span class="skolem">r</span>›</span></span> <span class="quoted"><span class="quoted">‹total <span class="skolem">r</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> adverse_in_R1<span class="main">:</span> <span class="quoted"><span class="quoted">"adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> adverse_in_R3 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    r<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">3</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"total <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">j</span> <span class="bound">x</span><span class="main">.</span> eval <span class="skolem">r</span> <span class="main">[</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> adverse <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">rij</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rij</span> <span class="main">=</span> Cn <span class="main">1</span> <span class="skolem">r</span> <span class="main">[</span>r_const <span class="free">i</span><span class="main">,</span> r_const <span class="free">j</span><span class="main">,</span> Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">rij</span>"</span></span> <span class="quoted"><span class="quoted">"total <span class="skolem">rij</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> Cn_total Mn_free_imp_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> rij_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> eval <span class="skolem">rij</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">=</span> eval <span class="skolem">r</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> r<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> eval <span class="skolem">rij</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">=</span> adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">rij</span>›</span></span> <span class="quoted"><span class="quoted">‹total <span class="skolem">rij</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next we show that for every $z$ there are $i$, $j$ such that
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>[names_short] <span class="quoted"><span class="quoted">"adverse <span class="free"><span class="free">z</span></span> <span class="free"><span class="free">i</span></span> <span class="free"><span class="free">j</span></span> <span class="main"><span class="main">∈</span></span> <span class="keyword1"><span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. The first step is to show that for every
$z$, Gödel numbers for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>[names_short] <span class="quoted"><span class="quoted">"adverse <span class="free"><span class="free">z</span></span> <span class="free"><span class="free">i</span></span> <span class="free"><span class="free">j</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> can be computed
uniformly from $i$ and $j$.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> phi_translate_adverse<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">∈</span><span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span><span class="main">.</span><span class="main">∀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="bound">f</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> adverse <span class="free">z</span> <span class="bound">i</span> <span class="bound">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">3</span> <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"total <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">j</span> <span class="bound">x</span><span class="main">.</span> eval <span class="skolem">r</span> <span class="main">[</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> adverse <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> adverse_in_R3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"encode <span class="skolem">r</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">rf</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rf</span> <span class="main">=</span> Cn <span class="numeral">2</span> <span class="main">(</span>r_smn <span class="main">1</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">[</span>r_dummy <span class="main">1</span> <span class="main">(</span>r_const <span class="var">?p</span><span class="main">)</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="skolem">rf</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"total <span class="skolem">rf</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Mn_free_imp_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> eval <span class="skolem">rf</span> <span class="main">[</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">2</span> <span class="skolem">rf</span>›</span></span> <span class="quoted"><span class="quoted">‹total <span class="skolem">rf</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> rf<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="skolem">rf</span> <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">]</span> <span class="main">=</span> eval <span class="main">(</span>r_smn <span class="main">1</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">[</span><span class="var">?p</span><span class="main">,</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">unfolding</span></span> rf_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> eval r_phi <span class="main">[</span>the <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> phi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> eval r_phi <span class="main">[</span>the <span class="main">(</span>eval <span class="skolem">rf</span> <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> eval <span class="main">(</span>r_universal <span class="main">1</span><span class="main">)</span> <span class="main">[</span>the <span class="main">(</span>eval <span class="main">(</span>r_smn <span class="main">1</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">[</span><span class="var">?p</span><span class="main">,</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rf r_phi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> eval <span class="main">(</span>r_universal <span class="main">(</span><span class="numeral">2</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?p</span> <span class="main">#</span> <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> smn_lemma<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> eval <span class="main">(</span>r_universal <span class="numeral">3</span><span class="main">)</span> <span class="main">[</span><span class="var">?p</span><span class="main">,</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> eval <span class="skolem">r</span> <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> r_universal r <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> adverse <span class="free">z</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">x</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> r<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="skolem">f</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> adverse <span class="free">z</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The second, and final, step is to apply Smullyan's double
fixed-point theorem to show the existence of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>[names_short] <span class="quoted"><span class="quoted">adverse</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
functions in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> adverse_in_V01<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">m</span> <span class="bound">n</span><span class="main">.</span> adverse <span class="main">0</span> <span class="bound">m</span> <span class="bound">n</span> <span class="main">∈</span> <span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> adverse <span class="main">1</span> <span class="bound">m</span> <span class="bound">n</span> <span class="main">∈</span> <span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> f0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="skolem">f<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> adverse <span class="main">0</span> <span class="bound">i</span> <span class="bound">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> phi_translate_adverse<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="skolem">f<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> adverse <span class="main">1</span> <span class="bound">i</span> <span class="bound">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> phi_translate_adverse<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="skolem">m</span> <span class="main">=</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="skolem">f<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">m</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="skolem">n</span> <span class="main">=</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="skolem">f<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">m</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> smullyan_double_fixed_point<span class="main">[</span><span class="operator">OF</span> f0<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> f1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> f0<span class="main">(</span>2<span class="main">)</span> f1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="skolem">m</span> <span class="main">=</span> adverse <span class="main">0</span> <span class="skolem">m</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="skolem">n</span> <span class="main">=</span> adverse <span class="main">1</span> <span class="skolem">m</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>adverse <span class="main">0</span> <span class="skolem">m</span> <span class="skolem">n</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>adverse <span class="main">1</span> <span class="skolem">m</span> <span class="skolem">n</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> adverse_at_01 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span>adverse <span class="main">0</span> <span class="skolem">m</span> <span class="skolem">n</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> adverse <span class="main">0</span> <span class="skolem">m</span> <span class="skolem">n</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span>adverse <span class="main">1</span> <span class="skolem">m</span> <span class="skolem">n</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> adverse <span class="main">1</span> <span class="skolem">m</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"adverse <span class="main">0</span> <span class="skolem">m</span> <span class="skolem">n</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"adverse <span class="main">1</span> <span class="skolem">m</span> <span class="skolem">n</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> adverse_in_R1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> V01_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Before we prove the main result of this section we need some
lemmas regarding the shape of the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>[names_short] <span class="quoted"><span class="quoted">adverse</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> functions and
hypothesis changes of the strategy.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> adverse_Suc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span> <span class="main">(</span>Suc <span class="free">x</span><span class="main">)</span> <span class="main">↓=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free">s</span> <span class="main">(</span>e_snoc <span class="main">(</span><span class="main">(</span>adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="free">x</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="main">≠</span> <span class="free">s</span> <span class="main">(</span><span class="main">(</span>adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="free">x</span><span class="main">)</span>
     <span class="keyword1">then</span> <span class="main">0</span>
     <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">s</span> <span class="main">(</span>e_snoc <span class="main">(</span><span class="main">(</span>adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="free">x</span><span class="main">)</span> <span class="main">1</span><span class="main">)</span> <span class="main">≠</span> <span class="free">s</span> <span class="main">(</span><span class="main">(</span>adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="free">x</span><span class="main">)</span>
          <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="free">z</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span> <span class="main">(</span>Suc <span class="free">x</span><span class="main">)</span> <span class="main">↓=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free">s</span> <span class="main">(</span>list_encode <span class="main">(</span>prefixes <span class="free">z</span> <span class="free">i</span> <span class="free">j</span> <span class="free">x</span> <span class="main">@</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="free">s</span> <span class="main">(</span>list_encode <span class="main">(</span>prefixes <span class="free">z</span> <span class="free">i</span> <span class="free">j</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>
     <span class="keyword1">then</span> <span class="main">0</span>
     <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free">s</span> <span class="main">(</span>list_encode <span class="main">(</span>prefixes <span class="free">z</span> <span class="free">i</span> <span class="free">j</span> <span class="free">x</span> <span class="main">@</span> <span class="main">[</span><span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="free">s</span> <span class="main">(</span>list_encode <span class="main">(</span>prefixes <span class="free">z</span> <span class="free">i</span> <span class="free">j</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>
          <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="free">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms adverse_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_adverse_eq_prefixes<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The process in the proof sketch (page~\pageref{s:v01_not_total})
consists of steps (a), (b), and (c). The next abbreviation is true iff.\ step
(a) or (b) applies.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">hyp_change</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span>
  <span class="free">s</span> <span class="main">(</span>e_snoc <span class="main">(</span><span class="main">(</span>adverse <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">▹</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="main">≠</span> <span class="free">s</span> <span class="main">(</span><span class="main">(</span>adverse <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">▹</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">∨</span>
  <span class="free">s</span> <span class="main">(</span>e_snoc <span class="main">(</span><span class="main">(</span>adverse <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">▹</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">1</span><span class="main">)</span> <span class="main">≠</span> <span class="free">s</span> <span class="main">(</span><span class="main">(</span>adverse <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">▹</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If step (c) applies, the process appends $z$.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> adverse_Suc_not_hyp_change<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> hyp_change <span class="free">z</span> <span class="free">i</span> <span class="free">j</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span> <span class="main">(</span>Suc <span class="free">x</span><span class="main">)</span> <span class="main">↓=</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms adverse_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹While (a) or (b) applies, the process appends a value that
forces $S$ to change its hypothesis.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> while_hyp_change<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span> hyp_change <span class="free">z</span> <span class="free">i</span> <span class="free">j</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">≤</span>Suc <span class="free">n</span><span class="main">.</span> adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span> <span class="bound">x</span> <span class="main">=</span> adverse <span class="free">z'</span> <span class="free">i</span> <span class="free">j</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> adverse_def le_Suc_eq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span> hyp_change <span class="free">z</span> <span class="free">i</span> <span class="free">j</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">≤</span>Suc <span class="skolem">n</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span> adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span> <span class="bound">x</span> <span class="main">=</span> adverse <span class="free">z'</span> <span class="free">i</span> <span class="free">j</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span> <span class="main">0</span> <span class="main">=</span> adverse <span class="free">z'</span> <span class="free">i</span> <span class="free">j</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> adverse_at_01 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> zz'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">≤</span>Suc <span class="skolem">n</span><span class="main">.</span> adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span> <span class="bound">x</span> <span class="main">=</span> adverse <span class="free">z'</span> <span class="free">i</span> <span class="free">j</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span> <span class="quoted"><span class="quoted">"adverse <span class="free">z'</span> <span class="free">i</span> <span class="free">j</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> adverse_in_R1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> init_zz'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>adverse <span class="free">z'</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> init_eqI <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> adverse <span class="free">z'</span> <span class="free">i</span> <span class="free">j</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">(</span>e_snoc <span class="main">(</span><span class="main">(</span>adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="main">≠</span> <span class="free">s</span> <span class="main">(</span><span class="main">(</span>adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">(</span>e_snoc <span class="main">(</span><span class="main">(</span>adverse <span class="free">z'</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="main">≠</span> <span class="free">s</span> <span class="main">(</span><span class="main">(</span>adverse <span class="free">z'</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> init_zz' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"adverse <span class="free">z'</span> <span class="free">i</span> <span class="free">j</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> adverse_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> adverse_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">(</span>e_snoc <span class="main">(</span><span class="main">(</span>adverse <span class="free">z'</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span> <span class="main">(</span><span class="main">(</span>adverse <span class="free">z'</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> init_zz' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"adverse <span class="free">z'</span> <span class="free">i</span> <span class="free">j</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> init_zz' Suc.prems adverse_Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> le_refl zero_less_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False Suc.prems adverse_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> zz' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> le_SucE <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next result corresponds to Case~1 from the proof sketch.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> always_hyp_change_no_lim<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> hyp_change <span class="free">z</span> <span class="free">i</span> <span class="free">j</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> learn_lim <span class="keyword1">φ</span> <span class="main">{</span>adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span><span class="main">}</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> infinite_hyp_changes_not_Lim<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"adverse <span class="free"><span class="free">z</span></span> <span class="free"><span class="free">i</span></span> <span class="free"><span class="free">j</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span> <span class="main">∈</span> <span class="main">{</span>adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">m<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main">&gt;</span><span class="bound">n</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">m<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">&gt;</span><span class="bound">n</span><span class="main">.</span> <span class="free">s</span> <span class="main">(</span>adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span> <span class="main">▹</span> <span class="bound">m<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">≠</span> <span class="free">s</span> <span class="main">(</span>adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span> <span class="main">▹</span> <span class="bound">m<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> m1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">&gt;</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"hyp_change <span class="free">z</span> <span class="free">i</span> <span class="free">j</span> <span class="skolem">m<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">(</span>adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span> <span class="main">▹</span> <span class="skolem">m<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">≠</span> <span class="free">s</span> <span class="main">(</span>adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span> <span class="main">▹</span> <span class="main">(</span>Suc <span class="skolem">m<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">(</span>e_snoc <span class="main">(</span><span class="main">(</span>adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="skolem">m<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="main">≠</span> <span class="free">s</span> <span class="main">(</span><span class="main">(</span>adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="skolem">m<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span> <span class="main">(</span>Suc <span class="skolem">m<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> m1 adverse_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="main">(</span>Suc <span class="skolem">m<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> e_snoc <span class="main">(</span><span class="main">(</span>adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="skolem">m<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_Suc_snoc<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span> <span class="main">(</span>Suc <span class="skolem">m<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">↓=</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> m1 adverse_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="main">(</span>Suc <span class="skolem">m<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> e_snoc <span class="main">(</span><span class="main">(</span>adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="skolem">m<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_Suc_snoc<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> False m1<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">m<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main">&gt;</span><span class="skolem">n</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">m<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">&gt;</span><span class="skolem">n</span><span class="main">.</span> <span class="free">s</span> <span class="main">(</span>adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span> <span class="main">▹</span> <span class="bound">m<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">≠</span> <span class="free">s</span> <span class="main">(</span>adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span> <span class="main">▹</span> <span class="bound">m<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> less_SucI m1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next result corresponds to Case~2 from the proof sketch.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> no_hyp_change_no_cons<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> hyp_change <span class="free">z</span> <span class="free">i</span> <span class="free">j</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> learn_cons <span class="keyword1">φ</span> <span class="main">{</span>adverse <span class="main">0</span> <span class="free">i</span> <span class="free">j</span><span class="main">,</span> adverse <span class="main">1</span> <span class="free">i</span> <span class="free">j</span><span class="main">}</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">¬</span> hyp_change <span class="free">z</span> <span class="free">i</span> <span class="free">j</span> <span class="bound">x</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">xmin</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xmin</span> <span class="main">=</span> Least <span class="var">?P</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> xmin<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">xmin</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">xmin</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="var">?P</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> LeastI<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">]</span> not_less_Least<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xmin</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">≤</span><span class="skolem">xmin</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span> hyp_change <span class="free">z</span> <span class="free">i</span> <span class="free">j</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> xmin <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_pred le_imp_less_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">≤</span><span class="skolem">xmin</span><span class="main">.</span> adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span> <span class="bound">x</span> <span class="main">=</span> adverse <span class="main">0</span> <span class="free">i</span> <span class="free">j</span> <span class="bound">x</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">≤</span><span class="skolem">xmin</span><span class="main">.</span> adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span> <span class="bound">x</span> <span class="main">=</span> adverse <span class="main">1</span> <span class="free">i</span> <span class="free">j</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> while_hyp_change<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">xmin</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> while_hyp_change<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">xmin</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
    init_z0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="skolem">xmin</span> <span class="main">=</span> <span class="main">(</span>adverse <span class="main">0</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="skolem">xmin</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    init_z1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="skolem">xmin</span> <span class="main">=</span> <span class="main">(</span>adverse <span class="main">1</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="skolem">xmin</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> adverse_in_R1 init_eqI <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
    a0<span class="main">:</span> <span class="quoted"><span class="quoted">"adverse <span class="main">0</span> <span class="free">i</span> <span class="free">j</span> <span class="main">(</span>Suc <span class="skolem">xmin</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    a1<span class="main">:</span> <span class="quoted"><span class="quoted">"adverse <span class="main">1</span> <span class="free">i</span> <span class="free">j</span> <span class="main">(</span>Suc <span class="skolem">xmin</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> adverse_Suc_not_hyp_change xmin<span class="main">(</span>1<span class="main">)</span> init_z1
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
    i0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>adverse <span class="main">0</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="main">(</span>Suc <span class="skolem">xmin</span><span class="main">)</span> <span class="main">=</span> e_snoc <span class="main">(</span><span class="main">(</span>adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="skolem">xmin</span><span class="main">)</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    i1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>adverse <span class="main">1</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="main">(</span>Suc <span class="skolem">xmin</span><span class="main">)</span> <span class="main">=</span> e_snoc <span class="main">(</span><span class="main">(</span>adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="skolem">xmin</span><span class="main">)</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> init_z0 init_z1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> init_Suc_snoc<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">(</span>e_snoc <span class="main">(</span><span class="main">(</span>adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="skolem">xmin</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span> <span class="main">(</span><span class="main">(</span>adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="skolem">xmin</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">(</span>e_snoc <span class="main">(</span><span class="main">(</span>adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="skolem">xmin</span><span class="main">)</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span> <span class="main">(</span><span class="main">(</span>adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="skolem">xmin</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> xmin <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">(</span><span class="main">(</span>adverse <span class="main">0</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="main">(</span>Suc <span class="skolem">xmin</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span> <span class="main">(</span><span class="main">(</span>adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="skolem">xmin</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">(</span><span class="main">(</span>adverse <span class="main">1</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="main">(</span>Suc <span class="skolem">xmin</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span> <span class="main">(</span><span class="main">(</span>adverse <span class="free">z</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="skolem">xmin</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">(</span><span class="main">(</span>adverse <span class="main">0</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="main">(</span>Suc <span class="skolem">xmin</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span> <span class="main">(</span><span class="main">(</span>adverse <span class="main">1</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="main">(</span>Suc <span class="skolem">xmin</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>adverse <span class="main">0</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="main">(</span>Suc <span class="skolem">xmin</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span>adverse <span class="main">1</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="main">(</span>Suc <span class="skolem">xmin</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a0 a1 i0 i1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append1_eq_conv list_decode_encode zero_neq_one<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> learn_cons <span class="keyword1">φ</span> <span class="main">{</span>adverse <span class="main">0</span> <span class="free">i</span> <span class="free">j</span><span class="main">,</span> adverse <span class="main">1</span> <span class="free">i</span> <span class="free">j</span><span class="main">}</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> same_hyp_different_init_not_cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Combining the previous two lemmas shows that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> cannot be learned consistently in the limit by the total
strategy $S$.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> V01_not_in_R_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> learn_cons <span class="keyword1">φ</span> <span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    mn0<span class="main">:</span> <span class="quoted"><span class="quoted">"adverse <span class="main">0</span> <span class="skolem">m</span> <span class="skolem">n</span> <span class="main">∈</span> <span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    mn1<span class="main">:</span> <span class="quoted"><span class="quoted">"adverse <span class="main">1</span> <span class="skolem">m</span> <span class="skolem">n</span> <span class="main">∈</span> <span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> adverse_in_V01 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> learn_cons <span class="keyword1">φ</span> <span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> hyp_change <span class="main">0</span> <span class="skolem">m</span> <span class="skolem">n</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> learn_lim <span class="keyword1">φ</span> <span class="main">{</span>adverse <span class="main">0</span> <span class="skolem">m</span> <span class="skolem">n</span><span class="main">}</span> <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> always_hyp_change_no_lim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> mn0 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> learn_cons_def learn_lim_closed_subseteq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> hyp_change <span class="main">0</span> <span class="skolem">m</span> <span class="skolem">n</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> learn_cons <span class="keyword1">φ</span> <span class="main">{</span>adverse <span class="main">0</span> <span class="skolem">m</span> <span class="skolem">n</span><span class="main">,</span> adverse <span class="main">1</span> <span class="skolem">m</span> <span class="skolem">n</span><span class="main">}</span> <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> no_hyp_change_no_cons<span class="main">[</span><span class="operator">OF</span> x<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> mn0 mn1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> learn_cons_closed_subseteq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is in CONS›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹At first glance, consistently learning <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> looks fairly
easy. After all every <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">f</span></span> <span class="main"><span class="main">∈</span></span> <span class="keyword1"><span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> provides a Gödel number of itself
either at argument 0 or 1. A strategy only has to figure out which one is
right. However, the strategy $S$ we are going to devise does not always
converge to $f(0)$ or $f(1)$. Instead it uses a technique called
``amalgamation''. The amalgamation of two Gödel numbers $i$ and $j$ is a
function whose value at $x$ is determined by simulating $\varphi_i(x)$ and
$\varphi_j(x)$ in parallel and outputting the value of the first one to halt.
If neither halts the value is undefined. There is a function
$a\in\mathcal{R}^2$ such that $\varphi_{a(i,j)}$ is the amalgamation of $i$
and $j$.

If <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">f</span></span> <span class="main"><span class="main">∈</span></span> <span class="keyword1"><span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> then $\varphi_{a(f(0), f(1))}$ is
total because by definition of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> we have
$\varphi_{f(0)} = f$ or $\varphi_{f(1)} = f$ and $f$ is total.

Given a prefix $f^n$ of an <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">f</span></span> <span class="main"><span class="main">∈</span></span> <span class="keyword1"><span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> the strategy
$S$ first computes $\varphi_{a(f(0), f(1))}(x)$ for $x = 0, \ldots, n$. For
the resulting prefix $\varphi^n_{a(f(0), f(1))}$ there are two cases:
\begin{enumerate}
\item[Case 1.] It differs from $f^n$, say at minimum index $x$. Then for
  either $z = 0$ or $z = 1$ we have $\varphi_{f(z)}(x) \neq f(x)$ by
  definition of amalgamation. This
  implies $\varphi_{f(z)} \neq f$, and thus $\varphi_{f(1-z)} = f$ by
  definition of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. We set $S(f^n) = f(1 - z)$. This
  hypothesis is correct and hence consistent.
\item[Case 2.] It equals $f^n$. Then we set $S(f^n) = a(f(0), f(1))$. This
  hypothesis is consistent by definition of this case.
\end{enumerate}

In both cases the hypothesis is consistent. If Case~1 holds for some $n$, the
same $x$ and $z$ will be found also for all larger values of $n$. Therefore
$S$ converges to the correct hypothesis $f(1 - z)$. If Case~2 holds for all
$n$, then $S$ always outputs the same hypothesis $a(f(0), f(1))$ and thus
also converges.

The above discussion tacitly assumes $n \geq 1$, such that both $f(0)$ and
$f(1)$ are available to $S$. For $n = 0$ the strategy outputs an arbitrary
consistent hypothesis.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Amalgamation uses the concurrent simulation of functions.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">parallel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">parallel</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> eval r_parallel <span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_parallel'<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_parallel <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span> parallel <span class="free">i</span> <span class="free">j</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> parallel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_parallel''<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↑</span> <span class="main">∧</span> eval r_phi <span class="main">[</span><span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↑</span> <span class="main">⟹</span> eval r_parallel <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↑</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓</span> <span class="main">∧</span> eval r_phi <span class="main">[</span><span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↑</span> <span class="main">⟹</span>
      eval r_parallel <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="main">0</span><span class="main">,</span> the <span class="main">(</span>eval r_phi <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span><span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓</span> <span class="main">∧</span> eval r_phi <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↑</span> <span class="main">⟹</span>
      eval r_parallel <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="main">1</span><span class="main">,</span> the <span class="main">(</span>eval r_phi <span class="main">[</span><span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓</span> <span class="main">∧</span> eval r_phi <span class="main">[</span><span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓</span> <span class="main">⟹</span>
      eval r_parallel <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="main">0</span><span class="main">,</span> the <span class="main">(</span>eval r_phi <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
      eval r_parallel <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="main">1</span><span class="main">,</span> the <span class="main">(</span>eval r_phi <span class="main">[</span><span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="main">1</span> r_phi <span class="main">[</span>r_const <span class="free">i</span><span class="main">,</span> Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="main">1</span> r_phi <span class="main">[</span>r_const <span class="free">j</span><span class="main">,</span> Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> eval r_phi <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> eval <span class="var">?f</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> eval r_phi <span class="main">[</span><span class="free">j</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> eval <span class="var">?g</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↑</span> <span class="main">∧</span> eval r_phi <span class="main">[</span><span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↑</span> <span class="main">⟹</span> eval r_parallel <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↑</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓</span> <span class="main">∧</span> eval r_phi <span class="main">[</span><span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↑</span> <span class="main">⟹</span>
      eval r_parallel <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="main">0</span><span class="main">,</span> the <span class="main">(</span>eval r_phi <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span><span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓</span> <span class="main">∧</span> eval r_phi <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↑</span> <span class="main">⟹</span>
      eval r_parallel <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="main">1</span><span class="main">,</span> the <span class="main">(</span>eval r_phi <span class="main">[</span><span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"eval r_phi <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓</span> <span class="main">∧</span> eval r_phi <span class="main">[</span><span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓</span> <span class="main">⟹</span>
      eval r_parallel <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="main">0</span><span class="main">,</span> the <span class="main">(</span>eval r_phi <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
      eval r_parallel <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="main">1</span><span class="main">,</span> the <span class="main">(</span>eval r_phi <span class="main">[</span><span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_parallel<span class="main">[</span><span class="operator">OF</span> *<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> parallel<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">i</span> <span class="free">x</span> <span class="main">↑</span> <span class="main">∧</span> <span class="keyword1">φ</span> <span class="free">j</span> <span class="free">x</span> <span class="main">↑</span> <span class="main">⟹</span> parallel <span class="free">i</span> <span class="free">j</span> <span class="free">x</span> <span class="main">↑</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">i</span> <span class="free">x</span> <span class="main">↓</span> <span class="main">∧</span> <span class="keyword1">φ</span> <span class="free">j</span> <span class="free">x</span> <span class="main">↑</span> <span class="main">⟹</span> parallel <span class="free">i</span> <span class="free">j</span> <span class="free">x</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="main">0</span><span class="main">,</span> the <span class="main">(</span><span class="keyword1">φ</span> <span class="free">i</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">j</span> <span class="free">x</span> <span class="main">↓</span> <span class="main">∧</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="free">x</span> <span class="main">↑</span> <span class="main">⟹</span> parallel <span class="free">i</span> <span class="free">j</span> <span class="free">x</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="main">1</span><span class="main">,</span> the <span class="main">(</span><span class="keyword1">φ</span> <span class="free">j</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">i</span> <span class="free">x</span> <span class="main">↓</span> <span class="main">∧</span> <span class="keyword1">φ</span> <span class="free">j</span> <span class="free">x</span> <span class="main">↓</span> <span class="main">⟹</span>
     parallel <span class="free">i</span> <span class="free">j</span> <span class="free">x</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="main">0</span><span class="main">,</span> the <span class="main">(</span><span class="keyword1">φ</span> <span class="free">i</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span>
     parallel <span class="free">i</span> <span class="free">j</span> <span class="free">x</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="main">1</span><span class="main">,</span> the <span class="main">(</span><span class="keyword1">φ</span> <span class="free">j</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> phi_def r_parallel'' r_parallel parallel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> parallel_converg_pdec1_0_or_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"parallel <span class="free">i</span> <span class="free">j</span> <span class="free">x</span> <span class="main">↓</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pdec1 <span class="main">(</span>the <span class="main">(</span>parallel <span class="free">i</span> <span class="free">j</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> pdec1 <span class="main">(</span>the <span class="main">(</span>parallel <span class="free">i</span> <span class="free">j</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms parallel<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">j</span></span></span></span></span></span></span></span><span class="main">]</span> parallel<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_eqD option.sel prod_encode_inverse<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> parallel_converg_either<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">φ</span> <span class="free">i</span> <span class="free">x</span> <span class="main">↓</span> <span class="main">∨</span> <span class="keyword1">φ</span> <span class="free">j</span> <span class="free">x</span> <span class="main">↓</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>parallel <span class="free">i</span> <span class="free">j</span> <span class="free">x</span> <span class="main">↓</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> parallel <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> parallel_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"parallel <span class="free">i</span> <span class="free">j</span> <span class="free">x</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">i</span> <span class="free">x</span> <span class="main">↓=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> parallel assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> option.collapse option.sel option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> prod.inject prod_encode_eq zero_neq_one<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> parallel_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"parallel <span class="free">i</span> <span class="free">j</span> <span class="free">x</span> <span class="main">↓=</span> prod_encode <span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">j</span> <span class="free">x</span> <span class="main">↓=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> parallel assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> option.collapse option.sel option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> prod.inject prod_encode_eq zero_neq_one<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> parallel_converg_V01<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"parallel <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">↓</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">∨</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms V01_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">ℛ</span> <span class="main">∨</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">↓</span> <span class="main">∨</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> R1_imp_total1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> parallel_converg_either <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The amalgamation of two Gödel numbers can then be described
in terms of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"parallel"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">amalgamation</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> partial1"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">amalgamation</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span>
     <span class="keyword1">if</span> parallel <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">↑</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> Some <span class="main">(</span>pdec2 <span class="main">(</span>the <span class="main">(</span>parallel <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> amalgamation_diverg<span class="main">:</span> <span class="quoted"><span class="quoted">"amalgamation <span class="free">i</span> <span class="free">j</span> <span class="free">x</span> <span class="main">↑</span> <span class="main">⟷</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="free">x</span> <span class="main">↑</span> <span class="main">∧</span> <span class="keyword1">φ</span> <span class="free">j</span> <span class="free">x</span> <span class="main">↑</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> amalgamation_def parallel <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> amalgamation_total<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"total1 <span class="main">(</span><span class="keyword1">φ</span> <span class="free">i</span><span class="main">)</span> <span class="main">∨</span> total1 <span class="main">(</span><span class="keyword1">φ</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"total1 <span class="main">(</span>amalgamation <span class="free">i</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms amalgamation_diverg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">]</span> total_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> amalgamation_V01_total<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"total1 <span class="main">(</span>amalgamation <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms V01_def amalgamation_total R1_imp_total1 total1_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> mem_Collect_eq<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_amalgamation</span> <span class="main">≡</span> Cn <span class="numeral">3</span> r_pdec2 <span class="main">[</span>r_parallel<span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_amalgamation_recfn<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">3</span> r_amalgamation"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_amalgamation_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_amalgamation<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_amalgamation <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span> amalgamation <span class="free">i</span> <span class="free">j</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"parallel <span class="free">i</span> <span class="free">j</span> <span class="free">x</span> <span class="main">↑</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_parallel <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↑</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_parallel'<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_amalgamation <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↑</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> r_amalgamation_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"amalgamation <span class="free">i</span> <span class="free">j</span> <span class="free">x</span> <span class="main">↑</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> amalgamation_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_parallel <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_parallel'<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_amalgamation <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span> eval r_pdec2 <span class="main">[</span>the <span class="main">(</span>eval r_parallel <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> r_amalgamation_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">↓=</span> pdec2 <span class="main">(</span>the <span class="main">(</span>eval r_parallel <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> False amalgamation_def r_parallel'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">amalgamate</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> computes Gödel numbers of
amalgamations. It corresponds to the function $a$ from the proof sketch.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">amalgamate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">amalgamate</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≡</span> smn <span class="main">1</span> <span class="main">(</span>encode r_amalgamation<span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> amalgamate<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>amalgamate <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> amalgamation <span class="free">i</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>amalgamate <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> eval r_phi <span class="main">[</span>amalgamate <span class="free">i</span> <span class="free">j</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> phi_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> eval r_phi <span class="main">[</span>smn <span class="main">1</span> <span class="main">(</span>encode r_amalgamation<span class="main">)</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">]</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> amalgamate_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> eval r_phi
     <span class="main">[</span>encode <span class="main">(</span>Cn <span class="main">1</span> <span class="main">(</span>r_universal <span class="numeral">3</span><span class="main">)</span>
      <span class="main">(</span>r_constn <span class="main">0</span> <span class="main">(</span>encode r_amalgamation<span class="main">)</span> <span class="main">#</span> map <span class="main">(</span>r_constn <span class="main">0</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">]</span> <span class="main">@</span> map <span class="main">(</span>Id <span class="main">1</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> smn<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="quoted">"encode r_amalgamation"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> numeral_3_eq_3<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> eval r_phi
     <span class="main">[</span>encode <span class="main">(</span>Cn <span class="main">1</span> <span class="main">(</span>r_universal <span class="numeral">3</span><span class="main">)</span>
      <span class="main">(</span>r_const <span class="main">(</span>encode r_amalgamation<span class="main">)</span> <span class="main">#</span> <span class="main">[</span>r_const <span class="free">i</span><span class="main">,</span> r_const <span class="free">j</span><span class="main">,</span> Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span>"</span></span>
     <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> eval r_phi <span class="main">[</span>encode <span class="var">?f</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_constn_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>amalgamate <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> eval r_phi
     <span class="main">[</span>encode <span class="main">(</span>Cn <span class="main">1</span> <span class="main">(</span>r_universal <span class="numeral">3</span><span class="main">)</span>
      <span class="main">(</span>r_const <span class="main">(</span>encode r_amalgamation<span class="main">)</span> <span class="main">#</span> <span class="main">[</span>r_const <span class="free">i</span><span class="main">,</span> r_const <span class="free">j</span><span class="main">,</span> Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>amalgamate <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> eval <span class="main">(</span>r_universal <span class="numeral">3</span><span class="main">)</span> <span class="main">[</span>encode r_amalgamation<span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> r_phi_def <span class="keyword1"><span class="command">using</span></span> r_universal<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> r_amalgamation_recfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>amalgamate <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> amalgamation <span class="free">i</span> <span class="free">j</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_amalgamation <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_amalgamation_recfn r_universal<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> amalgamation_in_P1<span class="main">:</span> <span class="quoted"><span class="quoted">"amalgamation <span class="free">i</span> <span class="free">j</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> amalgamate <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> P2_proj_P1 phi_in_P2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> amalgamation_V01_R1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"amalgamation <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms amalgamation_V01_total amalgamation_in_P1
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> P1_total_imp_R1<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_amalgamate</span> <span class="main">≡</span>
  Cn <span class="numeral">2</span> <span class="main">(</span>r_smn <span class="main">1</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">[</span>r_dummy <span class="main">1</span> <span class="main">(</span>r_const <span class="main">(</span>encode r_amalgamation<span class="main">)</span><span class="main">)</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_amalgamate_recfn<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> r_amalgamate"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_amalgamate_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_amalgamate<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_amalgamate <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">]</span> <span class="main">↓=</span> amalgamate <span class="free">i</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"encode r_amalgamation"</span></span>
  <span class="keyword1"><span class="command">have</span></span> rs21<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_smn <span class="main">1</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">[</span><span class="var">?p</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">]</span> <span class="main">↓=</span> smn <span class="main">1</span> <span class="var">?p</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_smn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_amalgamate <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">]</span> <span class="main">=</span> eval <span class="main">(</span>r_smn <span class="main">1</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">[</span><span class="var">?p</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> r_amalgamate_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_amalgamate <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">]</span> <span class="main">↓=</span> smn <span class="main">1</span> <span class="var">?p</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> amalgamate_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The strategy $S$ distinguishes the two cases from the proof
sketch with the help of the next function, which checks if a hypothesis
$\varphi_i$ is inconsistent with a prefix $e$. If so, it returns the least $x
&lt; |e|$ witnessing the inconsistency; otherwise it returns the length $|e|$.
If $\varphi_i$ diverges for some $x &lt; |e|$, so does the function.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inconsist</span> <span class="main">::</span> <span class="quoted">partial2</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inconsist</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span>e_length <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">x</span> <span class="main">↑</span> <span class="keyword1">then</span> None
     <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">∃</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span>e_length <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">x</span> <span class="main">↓≠</span> e_nth <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">x</span>
          <span class="keyword1">then</span> Some <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> e_length <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∧</span> <span class="keyword1">φ</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">x</span> <span class="main">↓≠</span> e_nth <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="bound">x</span><span class="main">)</span>
          <span class="keyword1">else</span> Some <span class="main">(</span>e_length <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inconsist_converg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inconsist <span class="free">i</span> <span class="free">e</span> <span class="main">↓</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inconsist <span class="free">i</span> <span class="free">e</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span>e_length <span class="free">e</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↓≠</span> e_nth <span class="free">e</span> <span class="bound">x</span>
     <span class="keyword1">then</span> Some <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> e_length <span class="free">e</span> <span class="main">∧</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↓≠</span> e_nth <span class="free">e</span> <span class="bound">x</span><span class="main">)</span>
     <span class="keyword1">else</span> Some <span class="main">(</span>e_length <span class="free">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span>e_length <span class="free">e</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↓</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inconsist_def assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">presburger</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">meson</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inconsist_bounded<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inconsist <span class="free">i</span> <span class="free">e</span> <span class="main">↓</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>inconsist <span class="free">i</span> <span class="free">e</span><span class="main">)</span> <span class="main">≤</span> e_length <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span>e_length <span class="free">e</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↓≠</span> e_nth <span class="free">e</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> inconsist_converg<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Least_le dual_order.strict_implies_order dual_order.strict_trans2 option.sel<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> inconsist_converg<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inconsist_consistent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inconsist <span class="free">i</span> <span class="free">e</span> <span class="main">↓</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inconsist <span class="free">i</span> <span class="free">e</span> <span class="main">↓=</span> e_length <span class="free">e</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span>e_length <span class="free">e</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↓=</span> e_nth <span class="free">e</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span>e_length <span class="free">e</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↓=</span> e_nth <span class="free">e</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"inconsist <span class="free">i</span> <span class="free">e</span> <span class="main">↓=</span> e_length <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span>e_length <span class="free">e</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↓≠</span> e_nth <span class="free">e</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> that inconsist_converg<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> not_less_Least option.inject<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> that inconsist_converg<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span>e_length <span class="free">e</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↓=</span> e_nth <span class="free">e</span> <span class="bound">x</span> <span class="main">⟹</span> inconsist <span class="free">i</span> <span class="free">e</span> <span class="main">↓=</span> e_length <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> inconsist_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inconsist_converg_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inconsist <span class="free">i</span> <span class="free">e</span> <span class="main">↓=</span> e_length <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span>e_length <span class="free">e</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↓=</span> e_nth <span class="free">e</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms inconsist_consistent <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> inconsist_converg_less<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inconsist <span class="free">i</span> <span class="free">e</span> <span class="main">↓</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>inconsist <span class="free">i</span> <span class="free">e</span><span class="main">)</span> <span class="main">&lt;</span> e_length <span class="free">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span>e_length <span class="free">e</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↓≠</span> e_nth <span class="free">e</span> <span class="bound">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"inconsist <span class="free">i</span> <span class="free">e</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> e_length <span class="free">e</span> <span class="main">∧</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↓≠</span> e_nth <span class="free">e</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span>e_length <span class="free">e</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↓≠</span> e_nth <span class="free">e</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> inconsist_converg<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> nat_neq_iff option.sel<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inconsist <span class="free">i</span> <span class="free">e</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> e_length <span class="free">e</span> <span class="main">∧</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↓≠</span> e_nth <span class="free">e</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms inconsist_converg <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> least_bounded_Suc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">upper</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">upper</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> Suc <span class="free">upper</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">upper</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Least <span class="var">?Q</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">&lt;</span> <span class="free">upper</span> <span class="main">∧</span> <span class="free">P</span> <span class="var">?x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> LeastI_ex<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">&lt;</span> Suc <span class="free">upper</span> <span class="main">∧</span> <span class="free">P</span> <span class="var">?x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">y</span></span><span class="main">&lt;</span><span class="var">?x</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Least_le<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span><span class="main">]</span> not_less_Least <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> Suc <span class="free">upper</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="var">?x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Least_equality<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">&lt;</span> Suc <span class="free">upper</span> <span class="main">∧</span> <span class="free">P</span> <span class="var">?x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> Suc <span class="free">upper</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="var">?x</span> <span class="main">≤</span> <span class="bound">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 2 leI <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> least_bounded_gr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">upper</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">upper</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">upper</span> <span class="main">+</span> <span class="free">m</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">upper</span> <span class="main">+</span> <span class="skolem">m</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms trans_less_add1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> least_bounded_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inconsist_init_converg_less<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">i</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"inconsist <span class="free">i</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span> <span class="main">↓</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>inconsist <span class="free">i</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> Suc <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inconsist <span class="free">i</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> inconsist <span class="free">i</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> phi_i_total<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">i</span> <span class="skolem">x</span> <span class="main">↓</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> f_nth<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">↓=</span> e_nth <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> Suc <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">using</span></span> that assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">φ</span> <span class="free">i</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="free">i</span> <span class="skolem">x</span> <span class="main">↓≠</span> e_nth <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> Suc <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> cond<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">&lt;</span> Suc <span class="skolem">n</span> <span class="main">∧</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="skolem">x</span> <span class="main">&lt;</span> e_length <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∧</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="skolem">x</span> <span class="main">↓≠</span> e_nth <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">using</span></span> length_init <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
    1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span>Suc <span class="free">n</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">f</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    2<span class="main">:</span> <span class="quoted"><span class="quoted">"inconsist <span class="free">i</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> Suc <span class="free">n</span> <span class="main">∧</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> inconsist_converg_less<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">f</span></span> <span class="main"><span class="main">▹</span></span> <span class="free"><span class="free">n</span></span>"</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span>Suc <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">f</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> not_add_less1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span>Suc <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↓≠</span> e_nth <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cond <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span>e_length <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↓≠</span> e_nth <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"inconsist <span class="free">i</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> R1_imp_total1 inconsist_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inconsist <span class="free">i</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">↓=</span>
      <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> e_length <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↓≠</span> e_nth <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inconsist_converg<span class="main">[</span><span class="operator">OF</span> 4<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"inconsist <span class="free">i</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> Suc <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span> <span class="main">∧</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cond<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">+</span> <span class="free">m</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> Suc <span class="free">n</span> <span class="main">∧</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> Suc <span class="free">n</span> <span class="main">+</span> <span class="free">m</span> <span class="main">∧</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">≠</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> least_bounded_gr<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?upper</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"Suc <span class="free">n</span>"</span></span><span class="main">]</span> 1 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_inconsist</span> <span class="main">≡</span>
  <span class="keyword1">let</span>
    <span class="bound">f</span> <span class="main">=</span> Cn <span class="numeral">2</span> r_length <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">;</span>
    <span class="bound">g</span> <span class="main">=</span> Cn <span class="numeral">4</span> r_ifless
      <span class="main">[</span>Id <span class="numeral">4</span> <span class="main">1</span><span class="main">,</span>
       Cn <span class="numeral">4</span> r_length <span class="main">[</span>Id <span class="numeral">4</span> <span class="numeral">3</span><span class="main">]</span><span class="main">,</span>
       Id <span class="numeral">4</span> <span class="main">1</span><span class="main">,</span>
       Cn <span class="numeral">4</span> r_ifeq
        <span class="main">[</span>Cn <span class="numeral">4</span> r_phi <span class="main">[</span>Id <span class="numeral">4</span> <span class="numeral">2</span><span class="main">,</span> Id <span class="numeral">4</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span>
         Cn <span class="numeral">4</span> r_nth <span class="main">[</span>Id <span class="numeral">4</span> <span class="numeral">3</span><span class="main">,</span> Id <span class="numeral">4</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span>
         Id <span class="numeral">4</span> <span class="main">1</span><span class="main">,</span>
         Id <span class="numeral">4</span> <span class="main">0</span><span class="main">]</span><span class="main">]</span>
   <span class="keyword1">in</span> Cn <span class="numeral">2</span> <span class="main">(</span>Pr <span class="numeral">2</span> <span class="bound">f</span> <span class="bound">g</span><span class="main">)</span> <span class="main">[</span>Cn <span class="numeral">2</span> r_length <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_inconsist_recfn<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> r_inconsist"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_inconsist_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_inconsist<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_inconsist <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span> <span class="main">=</span> inconsist <span class="free">i</span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> Cn <span class="numeral">2</span> r_length <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">len</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">len</span> <span class="main">=</span> Cn <span class="numeral">4</span> r_length <span class="main">[</span>Id <span class="numeral">4</span> <span class="numeral">3</span><span class="main">]</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">nth</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nth</span> <span class="main">=</span> Cn <span class="numeral">4</span> r_nth <span class="main">[</span>Id <span class="numeral">4</span> <span class="numeral">3</span><span class="main">,</span> Id <span class="numeral">4</span> <span class="main">0</span><span class="main">]</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ph</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ph</span> <span class="main">=</span> Cn <span class="numeral">4</span> r_phi <span class="main">[</span>Id <span class="numeral">4</span> <span class="numeral">2</span><span class="main">,</span> Id <span class="numeral">4</span> <span class="main">0</span><span class="main">]</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> Cn <span class="numeral">4</span> r_ifless <span class="main">[</span>Id <span class="numeral">4</span> <span class="main">1</span><span class="main">,</span> <span class="skolem">len</span><span class="main">,</span> Id <span class="numeral">4</span> <span class="main">1</span><span class="main">,</span> Cn <span class="numeral">4</span> r_ifeq <span class="main">[</span><span class="skolem">ph</span><span class="main">,</span> <span class="skolem">nth</span><span class="main">,</span> Id <span class="numeral">4</span> <span class="main">1</span><span class="main">,</span> Id <span class="numeral">4</span> <span class="main">0</span><span class="main">]</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="skolem">f</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span> <span class="main">↓=</span> e_length <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">4</span> <span class="skolem">len</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> len_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="skolem">len</span> <span class="main">[</span><span class="skolem">j</span><span class="main">,</span> <span class="skolem">v</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span> <span class="main">↓=</span> e_length <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span> <span class="skolem">v</span>
    <span class="keyword1"><span class="command">unfolding</span></span> len_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">4</span> <span class="skolem">nth</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> nth_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> nth<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="skolem">nth</span> <span class="main">[</span><span class="skolem">j</span><span class="main">,</span> <span class="skolem">v</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span> <span class="main">↓=</span> e_nth <span class="free">e</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span> <span class="skolem">v</span>
    <span class="keyword1"><span class="command">unfolding</span></span> nth_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">4</span> <span class="skolem">ph</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ph_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> ph<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="skolem">ph</span> <span class="main">[</span><span class="skolem">j</span><span class="main">,</span> <span class="skolem">v</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span> <span class="main">=</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span> <span class="skolem">v</span>
    <span class="keyword1"><span class="command">unfolding</span></span> ph_def <span class="keyword1"><span class="command">using</span></span> phi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">4</span> <span class="skolem">g</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> g_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">4</span> <span class="skolem">nth</span>›</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">4</span> <span class="skolem">ph</span>›</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">4</span> <span class="skolem">len</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> g_diverg<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="skolem">g</span> <span class="main">[</span><span class="skolem">j</span><span class="main">,</span> <span class="skolem">v</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span> <span class="main">↑</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">ph</span> <span class="main">[</span><span class="skolem">j</span><span class="main">,</span> <span class="skolem">v</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span> <span class="main">↑</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span> <span class="skolem">v</span>
    <span class="keyword1"><span class="command">unfolding</span></span> g_def <span class="keyword1"><span class="command">using</span></span> that <span class="quoted"><span class="quoted">‹recfn <span class="numeral">4</span> <span class="skolem">nth</span>›</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">4</span> <span class="skolem">ph</span>›</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">4</span> <span class="skolem">len</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> g_converg<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="skolem">g</span> <span class="main">[</span><span class="skolem">j</span><span class="main">,</span> <span class="skolem">v</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span> <span class="main">↓=</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">v</span> <span class="main">&lt;</span> e_length <span class="free">e</span> <span class="keyword1">then</span> <span class="skolem">v</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="skolem">j</span> <span class="main">↓=</span> e_nth <span class="free">e</span> <span class="skolem">j</span> <span class="keyword1">then</span> <span class="skolem">v</span> <span class="keyword1">else</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">ph</span> <span class="main">[</span><span class="skolem">j</span><span class="main">,</span> <span class="skolem">v</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span> <span class="main">↓</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span> <span class="skolem">v</span>
    <span class="keyword1"><span class="command">unfolding</span></span> g_def <span class="keyword1"><span class="command">using</span></span> that <span class="quoted"><span class="quoted">‹recfn <span class="numeral">4</span> <span class="skolem">nth</span>›</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">4</span> <span class="skolem">ph</span>›</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">4</span> <span class="skolem">len</span>›</span></span> len nth ph
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">≡</span> Pr <span class="numeral">2</span> <span class="skolem">f</span> <span class="skolem">g</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">3</span> <span class="skolem">h</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">2</span> <span class="skolem">f</span>›</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">4</span> <span class="skolem">g</span>›</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?invariant</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">j</span> <span class="bound">i</span> <span class="bound">e</span><span class="main">.</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span><span class="bound">j</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="bound">i</span> <span class="bound">x</span> <span class="main">↑</span> <span class="keyword1">then</span> None
     <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="main">∃</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span><span class="bound">j</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="bound">i</span> <span class="bound">x</span> <span class="main">↓≠</span> e_nth <span class="bound">e</span> <span class="bound">x</span>
          <span class="keyword1">then</span> Some <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="bound">j</span> <span class="main">∧</span> <span class="keyword1">φ</span> <span class="bound">i</span> <span class="bound">x</span> <span class="main">↓≠</span> e_nth <span class="bound">e</span> <span class="bound">x</span><span class="main">)</span>
          <span class="keyword1">else</span> Some <span class="main">(</span>e_length <span class="bound">e</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">h</span> <span class="main">[</span><span class="skolem">j</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span> <span class="main">=</span> <span class="var">?invariant</span> <span class="skolem">j</span> <span class="free">i</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> e_length <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> h_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">2</span> <span class="skolem">f</span>›</span></span> f <span class="quoted"><span class="quoted">‹recfn <span class="numeral">4</span> <span class="skolem">g</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j_less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> e_length <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> e_length <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"eval <span class="skolem">h</span> <span class="main">[</span><span class="skolem">j</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span> <span class="main">↑</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span><span class="skolem">j</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↑</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> j_le Suc.IH <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span>Suc <span class="skolem">j</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↑</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> less_SucI <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="skolem">h</span> <span class="main">[</span>Suc <span class="skolem">j</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span> <span class="main">↑</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> True h_def <span class="quoted"><span class="quoted">‹recfn <span class="numeral">3</span> <span class="skolem">h</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> Suc.IH j_le <span class="keyword1"><span class="command">have</span></span> h_j<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="skolem">h</span> <span class="main">[</span><span class="skolem">j</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span> <span class="main">=</span>
        <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span><span class="skolem">j</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↓≠</span> e_nth <span class="free">e</span> <span class="bound">x</span>
         <span class="keyword1">then</span> Some <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">j</span> <span class="main">∧</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↓≠</span> e_nth <span class="free">e</span> <span class="bound">x</span><span class="main">)</span>
         <span class="keyword1">else</span> Some <span class="main">(</span>e_length <span class="free">e</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> the_h_j<span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>eval <span class="skolem">h</span> <span class="main">[</span><span class="skolem">j</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span><span class="skolem">j</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↓≠</span> e_nth <span class="free">e</span> <span class="bound">x</span>
         <span class="keyword1">then</span> <span class="keyword1">LEAST</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">j</span> <span class="main">∧</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↓≠</span> e_nth <span class="free">e</span> <span class="bound">x</span>
         <span class="keyword1">else</span> e_length <span class="free">e</span><span class="main">)</span>"</span></span>
         <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?v</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> h_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="skolem">h</span> <span class="main">[</span>Suc <span class="skolem">j</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span> <span class="main">=</span> eval <span class="skolem">g</span> <span class="main">[</span><span class="skolem">j</span><span class="main">,</span> the <span class="main">(</span>eval <span class="skolem">h</span> <span class="main">[</span><span class="skolem">j</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> False h_def <span class="quoted"><span class="quoted">‹recfn <span class="numeral">4</span> <span class="skolem">g</span>›</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">2</span> <span class="skolem">f</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">i</span> <span class="skolem">j</span> <span class="main">↑</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> ph g_diverg h_Suc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> h_Suc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">h</span> <span class="main">[</span>Suc <span class="skolem">j</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span> <span class="main">↓=</span>
          <span class="main">(</span><span class="keyword1">if</span> <span class="var">?v</span> <span class="main">&lt;</span> e_length <span class="free">e</span> <span class="keyword1">then</span> <span class="var">?v</span>
           <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="skolem">j</span> <span class="main">↓=</span> e_nth <span class="free">e</span> <span class="skolem">j</span> <span class="keyword1">then</span> <span class="var">?v</span> <span class="keyword1">else</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
          <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">↓=</span> <span class="var">?lhs</span>"</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> g_converg ph the_h_j <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?invariant</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="free">i</span> <span class="free">e</span> <span class="main">↓=</span>
          <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span>Suc <span class="skolem">j</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↓≠</span> e_nth <span class="free">e</span> <span class="bound">x</span>
           <span class="keyword1">then</span> <span class="keyword1">LEAST</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> Suc <span class="skolem">j</span> <span class="main">∧</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↓≠</span> e_nth <span class="free">e</span> <span class="bound">x</span>
           <span class="keyword1">else</span> e_length <span class="free">e</span><span class="main">)</span>"</span></span>
          <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">↓=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">i</span> <span class="skolem">j</span> <span class="main">↓</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span><span class="skolem">j</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↑</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Suc.IH h_j j_le option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span>Suc <span class="skolem">j</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↑</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> less_Suc_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?v</span> <span class="main">&lt;</span> e_length <span class="free">e</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
            ex_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span><span class="skolem">j</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↓≠</span> e_nth <span class="free">e</span> <span class="bound">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
            v_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?v</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">j</span> <span class="main">∧</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↓≠</span> e_nth <span class="free">e</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span><span class="main"><span class="keyword3">+</span></span>
          <span class="keyword1"><span class="command">with</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">from</span></span> ex_j <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span>Suc <span class="skolem">j</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↓≠</span> e_nth <span class="free">e</span> <span class="bound">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> less_SucI <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> Suc <span class="skolem">j</span> <span class="main">∧</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↓≠</span> e_nth <span class="free">e</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">with</span></span> True v_eq ex_j <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> least_bounded_Suc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↓≠</span> e_nth <span class="free">e</span> <span class="bound">x</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> not_ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span><span class="skolem">j</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↓≠</span> e_nth <span class="free">e</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Least_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">j</span> <span class="main">∧</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↓≠</span> e_nth <span class="free">e</span> <span class="bound">x</span>"</span></span><span class="main">]</span> j_le
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> leD le_less_linear le_trans<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?v</span> <span class="main">=</span> e_length <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
          <span class="keyword1"><span class="command">with</span></span> False <span class="keyword1"><span class="command">have</span></span> lhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="skolem">j</span> <span class="main">↓=</span> e_nth <span class="free">e</span> <span class="skolem">j</span> <span class="keyword1">then</span> e_length <span class="free">e</span> <span class="keyword1">else</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">i</span> <span class="skolem">j</span> <span class="main">↓=</span> e_nth <span class="free">e</span> <span class="skolem">j</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span>Suc <span class="skolem">j</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↓≠</span> e_nth <span class="free">e</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> less_SucE not_ex <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> e_length <span class="free">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> e_length <span class="free">e</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> lhs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">i</span> <span class="skolem">j</span> <span class="main">↓≠</span> e_nth <span class="free">e</span> <span class="skolem">j</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">φ</span> <span class="free">i</span> <span class="skolem">j</span> <span class="main">↓</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">with</span></span> not_ex <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">&lt;</span>Suc <span class="skolem">j</span> <span class="main">∧</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↓≠</span> e_nth <span class="free">e</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> LeastI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">&lt;</span>Suc <span class="skolem">j</span> <span class="main">∧</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↓≠</span> e_nth <span class="free">e</span> <span class="bound">x</span>"</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> less_Suc_eq
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">φ</span> <span class="free">i</span> <span class="skolem">j</span> <span class="main">↓≠</span> e_nth <span class="free">e</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> lessI<span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> False lhs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">h</span> <span class="main">[</span>e_length <span class="free">e</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span> <span class="main">=</span> <span class="var">?invariant</span> <span class="main">(</span>e_length <span class="free">e</span><span class="main">)</span> <span class="free">i</span> <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">h</span> <span class="main">[</span>e_length <span class="free">e</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span> <span class="main">=</span> inconsist <span class="free">i</span> <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inconsist_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Cn <span class="numeral">2</span> <span class="main">(</span>Pr <span class="numeral">2</span> <span class="skolem">f</span> <span class="skolem">g</span><span class="main">)</span> <span class="main">[</span>Cn <span class="numeral">2</span> r_length <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span> <span class="main">=</span>
      eval <span class="skolem">h</span> <span class="main">[</span>e_length <span class="free">e</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">4</span> <span class="skolem">g</span>›</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">2</span> <span class="skolem">f</span>›</span></span> h_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> r_inconsist_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_def g_def len_def nth_def ph_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inconsist_for_total<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"total1 <span class="main">(</span><span class="keyword1">φ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inconsist <span class="free">i</span> <span class="free">e</span> <span class="main">↓=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span>e_length <span class="free">e</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↓≠</span> e_nth <span class="free">e</span> <span class="bound">x</span>
     <span class="keyword1">then</span> <span class="keyword1">LEAST</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> e_length <span class="free">e</span> <span class="main">∧</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↓≠</span> e_nth <span class="free">e</span> <span class="bound">x</span>
     <span class="keyword1">else</span> e_length <span class="free">e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inconsist_def <span class="keyword1"><span class="command">using</span></span> assms total1_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inconsist_for_V01<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> amalgamate <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inconsist <span class="free">k</span> <span class="free">e</span> <span class="main">↓=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">∃</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span>e_length <span class="free">e</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">k</span> <span class="bound">x</span> <span class="main">↓≠</span> e_nth <span class="free">e</span> <span class="bound">x</span>
     <span class="keyword1">then</span> <span class="keyword1">LEAST</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> e_length <span class="free">e</span> <span class="main">∧</span> <span class="keyword1">φ</span> <span class="free">k</span> <span class="bound">x</span> <span class="main">↓≠</span> e_nth <span class="free">e</span> <span class="bound">x</span>
     <span class="keyword1">else</span> e_length <span class="free">e</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">k</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> amalgamation_V01_R1<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span> amalgamate <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"total1 <span class="main">(</span><span class="keyword1">φ</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> inconsist_for_total<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next function computes Gödel numbers of functions consistent
with a given prefix. The strategy will use these as consistent auxiliary
hypotheses when receiving a prefix of length one.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_auxhyp</span> <span class="main">≡</span> Cn <span class="main">1</span> <span class="main">(</span>r_smn <span class="main">1</span> <span class="main">1</span><span class="main">)</span> <span class="main">[</span>r_const <span class="main">(</span>encode r_prenum<span class="main">)</span><span class="main">,</span> Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_auxhyp_prim<span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> r_auxhyp"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_auxhyp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_auxhyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span>eval r_auxhyp <span class="main">[</span><span class="free">e</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> prenum <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"encode r_prenum"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"encode r_prenum"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_auxhyp <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">=</span> eval <span class="main">(</span>r_smn <span class="main">1</span> <span class="main">1</span><span class="main">)</span> <span class="main">[</span><span class="var">?p</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> r_auxhyp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_auxhyp <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">↓=</span> smn <span class="main">1</span> <span class="var">?p</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_smn<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">↓=</span> encode <span class="main">(</span>Cn <span class="main">1</span> <span class="main">(</span>r_universal <span class="main">(</span><span class="main">1</span> <span class="main">+</span> length <span class="main">[</span><span class="free">e</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>r_constn <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="var">?p</span> <span class="main">#</span>
       map <span class="main">(</span>r_constn <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">@</span> map <span class="main">(</span>recf.Id <span class="main">1</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> smn<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">e</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">↓=</span> encode <span class="main">(</span>Cn <span class="main">1</span> <span class="main">(</span>r_universal <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>r_constn <span class="main">0</span> <span class="var">?p</span> <span class="main">#</span> map <span class="main">(</span>r_constn <span class="main">0</span><span class="main">)</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">↓=</span> encode <span class="main">(</span>Cn <span class="main">1</span> <span class="main">(</span>r_universal <span class="numeral">2</span><span class="main">)</span>
      <span class="main">(</span>r_constn <span class="main">0</span> <span class="var">?p</span> <span class="main">#</span> map <span class="main">(</span>r_constn <span class="main">0</span><span class="main">)</span> <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> one_add_one<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">↓=</span> encode <span class="main">(</span>Cn <span class="main">1</span> <span class="main">(</span>r_universal <span class="numeral">2</span><span class="main">)</span> <span class="main">[</span>r_constn <span class="main">0</span> <span class="var">?p</span><span class="main">,</span> r_constn <span class="main">0</span> <span class="free">e</span><span class="main">,</span> Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">↓=</span> encode <span class="main">(</span>Cn <span class="main">1</span> <span class="main">(</span>r_universal <span class="numeral">2</span><span class="main">)</span> <span class="main">[</span>r_const <span class="var">?p</span><span class="main">,</span> r_const <span class="free">e</span><span class="main">,</span> Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_constn_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_auxhyp <span class="main">[</span><span class="free">e</span><span class="main">]</span> <span class="main">↓=</span>
    encode <span class="main">(</span>Cn <span class="main">1</span> <span class="main">(</span>r_universal <span class="numeral">2</span><span class="main">)</span> <span class="main">[</span>r_const <span class="var">?p</span><span class="main">,</span> r_const <span class="free">e</span><span class="main">,</span> Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span>eval r_auxhyp <span class="main">[</span><span class="free">e</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> eval r_phi <span class="main">[</span>the <span class="main">(</span>eval r_auxhyp <span class="main">[</span><span class="free">e</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> phi_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span>eval r_auxhyp <span class="main">[</span><span class="free">e</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span>
      eval r_phi <span class="main">[</span>encode <span class="main">(</span>Cn <span class="main">1</span> <span class="main">(</span>r_universal <span class="numeral">2</span><span class="main">)</span> <span class="main">[</span>r_const <span class="var">?p</span><span class="main">,</span> r_const <span class="free">e</span><span class="main">,</span> Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> eval r_phi <span class="main">[</span>encode <span class="var">?f</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span>eval r_auxhyp <span class="main">[</span><span class="free">e</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span>
      eval <span class="main">(</span>Cn <span class="main">1</span> <span class="main">(</span>r_universal <span class="numeral">2</span><span class="main">)</span> <span class="main">[</span>r_const <span class="var">?p</span><span class="main">,</span> r_const <span class="free">e</span><span class="main">,</span> Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_phi_def r_universal<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span>eval r_auxhyp <span class="main">[</span><span class="free">e</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> eval <span class="main">(</span>r_universal <span class="numeral">2</span><span class="main">)</span> <span class="main">[</span><span class="var">?p</span><span class="main">,</span> <span class="free">e</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span>eval r_auxhyp <span class="main">[</span><span class="free">e</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> eval r_prenum <span class="main">[</span><span class="free">e</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_universal <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span>eval r_auxhyp <span class="main">[</span><span class="free">e</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> prenum <span class="free">e</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">auxhyp</span> <span class="main">::</span> <span class="quoted">partial1</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">auxhyp</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> eval r_auxhyp <span class="main">[</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> auxhyp_prenum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span>auxhyp <span class="free">e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> prenum <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> auxhyp_def r_auxhyp <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> auxhyp_in_R1<span class="main">:</span> <span class="quoted"><span class="quoted">"auxhyp <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> auxhyp_def Mn_free_imp_total R1I r_auxhyp_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now we can define our consistent learning strategy for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_sv01</span> <span class="main">≡</span>
  <span class="keyword1">let</span>
    <span class="bound">at0</span> <span class="main">=</span> Cn <span class="main">1</span> r_nth <span class="main">[</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">,</span> Z<span class="main">]</span><span class="main">;</span>
    <span class="bound">at1</span> <span class="main">=</span> Cn <span class="main">1</span> r_nth <span class="main">[</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">,</span> r_const <span class="main">1</span><span class="main">]</span><span class="main">;</span>
    <span class="bound">m</span> <span class="main">=</span> Cn <span class="main">1</span> r_amalgamate <span class="main">[</span><span class="bound">at0</span><span class="main">,</span> <span class="bound">at1</span><span class="main">]</span><span class="main">;</span>
    <span class="bound">c</span> <span class="main">=</span> Cn <span class="main">1</span> r_inconsist <span class="main">[</span><span class="bound">m</span><span class="main">,</span> Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span><span class="main">;</span>
    <span class="bound">p</span> <span class="main">=</span> Cn <span class="main">1</span> r_pdec1 <span class="main">[</span>Cn <span class="main">1</span> r_parallel <span class="main">[</span><span class="bound">at0</span><span class="main">,</span> <span class="bound">at1</span><span class="main">,</span> <span class="bound">c</span><span class="main">]</span><span class="main">]</span><span class="main">;</span>
    <span class="bound">g</span> <span class="main">=</span> Cn <span class="main">1</span> r_ifeq <span class="main">[</span><span class="bound">c</span><span class="main">,</span> r_length<span class="main">,</span> <span class="bound">m</span><span class="main">,</span> Cn <span class="main">1</span> r_ifz <span class="main">[</span><span class="bound">p</span><span class="main">,</span> <span class="bound">at1</span><span class="main">,</span> <span class="bound">at0</span><span class="main">]</span><span class="main">]</span>
  <span class="keyword1">in</span> Cn <span class="main">1</span> <span class="main">(</span>r_lifz r_auxhyp <span class="bound">g</span><span class="main">)</span> <span class="main">[</span>Cn <span class="main">1</span> r_eq <span class="main">[</span>r_length<span class="main">,</span> r_const <span class="main">1</span><span class="main">]</span><span class="main">,</span> Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_sv01_recfn<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> r_sv01"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_sv01_def <span class="keyword1"><span class="command">using</span></span> r_auxhyp_prim r_inconsist_recfn r_amalgamate_recfn
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sv01</span> <span class="main">::</span> <span class="quoted">partial1</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">s<span class="hidden">⇘</span><sub>01</sub><span class="hidden">⇙</span></span>"</span><span class="main">)</span><span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sv01</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">≡</span> eval r_sv01 <span class="main">[</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sv01_in_P1<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇘</span><sub>01</sub><span class="hidden">⇙</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sv01_def r_sv01_recfn P1I <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We are interested in the behavior of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇘</span><sub>01</sub><span class="hidden">⇙</span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> only on
prefixes of functions in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. This behavior is linked
to the amalgamation of $f(0)$ and $f(1)$, where $f$ is the function
to be learned.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">amalg01</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial1 <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">amalg01</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> amalgamate <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sv01<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇘</span><sub>01</sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> auxhyp <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span>
      inconsist <span class="main">(</span>amalg01 <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span> <span class="main">↓=</span> Suc <span class="free">n</span> <span class="main">⟹</span>
      s<span class="hidden">⇘</span><sub>01</sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span> <span class="main">↓=</span> amalg01 <span class="free">f</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span>
      the <span class="main">(</span>inconsist <span class="main">(</span>amalg01 <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> Suc <span class="free">n</span> <span class="main">⟹</span>
      pdec1 <span class="main">(</span>the <span class="main">(</span>parallel <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span>inconsist <span class="main">(</span>amalg01 <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span>
      s<span class="hidden">⇘</span><sub>01</sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span>
      the <span class="main">(</span>inconsist <span class="main">(</span>amalg01 <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> Suc <span class="free">n</span> <span class="main">⟹</span>
      pdec1 <span class="main">(</span>the <span class="main">(</span>parallel <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span>inconsist <span class="main">(</span>amalg01 <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span>
      s<span class="hidden">⇘</span><sub>01</sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> f_total<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms V01_def R1_imp_total1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">at0</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">at0</span> <span class="main">=</span> Cn <span class="main">1</span> r_nth <span class="main">[</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">,</span> Z<span class="main">]</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">at1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">at1</span> <span class="main">=</span> Cn <span class="main">1</span> r_nth <span class="main">[</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">,</span> r_const <span class="main">1</span><span class="main">]</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> Cn <span class="main">1</span> r_amalgamate <span class="main">[</span><span class="skolem">at0</span><span class="main">,</span> <span class="skolem">at1</span><span class="main">]</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> Cn <span class="main">1</span> r_inconsist <span class="main">[</span><span class="skolem">m</span><span class="main">,</span> Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> Cn <span class="main">1</span> r_pdec1 <span class="main">[</span>Cn <span class="main">1</span> r_parallel <span class="main">[</span><span class="skolem">at0</span><span class="main">,</span> <span class="skolem">at1</span><span class="main">,</span> <span class="skolem">c</span><span class="main">]</span><span class="main">]</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> Cn <span class="main">1</span> r_ifeq <span class="main">[</span><span class="skolem">c</span><span class="main">,</span> r_length<span class="main">,</span> <span class="skolem">m</span><span class="main">,</span> Cn <span class="main">1</span> r_ifz <span class="main">[</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">at1</span><span class="main">,</span> <span class="skolem">at0</span><span class="main">]</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">g</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> g_def p_def c_def m_def at1_def at0_def
    <span class="keyword1"><span class="command">using</span></span> r_auxhyp_prim r_inconsist_recfn r_amalgamate_recfn
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Cn <span class="main">1</span> r_eq <span class="main">[</span>r_length<span class="main">,</span> r_const <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="free">f</span> <span class="main">▹</span> <span class="main">0</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_sv01 <span class="main">[</span><span class="free">f</span> <span class="main">▹</span> <span class="main">0</span><span class="main">]</span> <span class="main">=</span> eval r_auxhyp <span class="main">[</span><span class="free">f</span> <span class="main">▹</span> <span class="main">0</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> r_sv01_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">g</span>›</span></span> c_def g_def m_def p_def r_auxhyp_prim
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇘</span><sub>01</sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> auxhyp <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> auxhyp_def sv01_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> sv01<span class="main">:</span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇘</span><sub>01</sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> eval <span class="skolem">g</span> <span class="main">[</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Cn <span class="main">1</span> r_eq <span class="main">[</span>r_length<span class="main">,</span> r_const <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">]</span> <span class="main">↓≠</span> <span class="main">0</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r_eq</span> <span class="main">↓≠</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="main">(</span>r_lifz r_auxhyp <span class="skolem">g</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">g</span>›</span></span> r_auxhyp_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_sv01 <span class="main">[</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">]</span> <span class="main">=</span>
        eval <span class="main">(</span>Cn <span class="main">1</span> <span class="main">(</span>r_lifz r_auxhyp <span class="skolem">g</span><span class="main">)</span> <span class="main">[</span>Cn <span class="main">1</span> r_eq <span class="main">[</span>r_length<span class="main">,</span> r_const <span class="main">1</span><span class="main">]</span><span class="main">,</span> Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> r_sv01_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> at0_def at1_def c_def g_def m_def p_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_sv01 <span class="main">[</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">]</span> <span class="main">=</span> eval <span class="main">(</span>r_lifz r_auxhyp <span class="skolem">g</span><span class="main">)</span> <span class="main">[</span>the <span class="var">?r_eq</span><span class="main">,</span> <span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_sv01 <span class="main">[</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">]</span> <span class="main">=</span> eval <span class="skolem">g</span> <span class="main">[</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"*"</span> <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">g</span>›</span></span> r_auxhyp_prim <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sv01_def that<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">at0</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> at0_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> at0<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="skolem">at0</span> <span class="main">[</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">]</span> <span class="main">↓=</span> the <span class="main">(</span><span class="free">f</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> at0_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">at1</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> at1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> at1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> eval <span class="skolem">at1</span> <span class="main">[</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">]</span> <span class="main">↓=</span> the <span class="main">(</span><span class="free">f</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> at1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> m_def at0_def at1_def <span class="keyword1"><span class="command">using</span></span> r_amalgamate_recfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> eval <span class="skolem">m</span> <span class="main">[</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">]</span> <span class="main">↓=</span> amalg01 <span class="free">f</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">↓=</span> <span class="var">?m</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> m_def at0_def at1_def
    <span class="keyword1"><span class="command">using</span></span> at0 at1 amalgamate r_amalgamate r_amalgamate_recfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> eval <span class="skolem">c</span> <span class="main">[</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">]</span> <span class="main">=</span> inconsist <span class="main">(</span>amalg01 <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">=</span> <span class="var">?c</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> c_def <span class="keyword1"><span class="command">using</span></span> r_inconsist_recfn <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">m</span>›</span></span> r_inconsist <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> c_converg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> eval <span class="skolem">c</span> <span class="main">[</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inconsist_for_V01<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> c_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">m</span>›</span></span> r_inconsist_recfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> par<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span>
      eval <span class="main">(</span>Cn <span class="main">1</span> r_parallel <span class="main">[</span><span class="skolem">at0</span><span class="main">,</span> <span class="skolem">at1</span><span class="main">,</span> <span class="skolem">c</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">]</span> <span class="main">=</span> parallel <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the <span class="var">?c</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">=</span> <span class="var">?par</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> at0 at1 c c_converg m r_parallel' <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">at0</span>›</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">at1</span>›</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">c</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> parallel_converg_V01<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
      par_converg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> eval <span class="main">(</span>Cn <span class="main">1</span> r_parallel <span class="main">[</span><span class="skolem">at0</span><span class="main">,</span> <span class="skolem">at1</span><span class="main">,</span> <span class="skolem">c</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> p_converg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> eval <span class="skolem">p</span> <span class="main">[</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> p_def <span class="keyword1"><span class="command">using</span></span> at0 at1 c_converg <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">at0</span>›</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">at1</span>›</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">c</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> eval <span class="skolem">p</span> <span class="main">[</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">]</span> <span class="main">↓=</span> pdec1 <span class="main">(</span>the <span class="var">?par</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> p_def
    <span class="keyword1"><span class="command">using</span></span> at0 at1 c_converg <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">at0</span>›</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">at1</span>›</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">c</span>›</span></span> par par_converg
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> p_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">at0</span>›</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">at1</span>›</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">m</span>›</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">c</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="main">1</span> r_ifz <span class="main">[</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">at1</span><span class="main">,</span> <span class="skolem">at0</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> eval <span class="var">?r</span> <span class="main">[</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> pdec1 <span class="main">(</span>the <span class="var">?par</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="free">f</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> at0 at1 c_converg <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">at0</span>›</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">at1</span>›</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">c</span>›</span></span>
      <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">m</span>›</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">p</span>›</span></span> p f_total
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1"><span class="command">have</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span>
      eval <span class="skolem">g</span> <span class="main">[</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">]</span> <span class="main">↓=</span>
        <span class="main">(</span><span class="keyword1">if</span> the <span class="var">?c</span> <span class="main">=</span> e_length <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span>
         <span class="keyword1">then</span> <span class="var">?m</span> <span class="keyword1">else</span> the <span class="main">(</span>eval <span class="main">(</span>Cn <span class="main">1</span> r_ifz <span class="main">[</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">at1</span><span class="main">,</span> <span class="skolem">at0</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> g_def
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">p</span>›</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">at0</span>›</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">at1</span>›</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">c</span>›</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">m</span>›</span></span>
      p_converg at1 at0 c c_converg m
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="main">↓=</span> Suc <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_length <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">g</span> <span class="main">[</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">]</span> <span class="main">↓=</span> <span class="var">?m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> g <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇘</span><sub>01</sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span> <span class="main">↓=</span> amalg01 <span class="free">f</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sv01<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"the <span class="var">?c</span> <span class="main">&lt;</span> Suc <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"pdec1 <span class="main">(</span>the <span class="var">?par</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> g r f_total <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">g</span> <span class="main">[</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">]</span> <span class="main">=</span> <span class="free">f</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇘</span><sub>01</sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sv01<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"the <span class="var">?c</span> <span class="main">&lt;</span> Suc <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"pdec1 <span class="main">(</span>the <span class="var">?par</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> g r f_total <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">g</span> <span class="main">[</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">]</span> <span class="main">=</span> <span class="free">f</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇘</span><sub>01</sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sv01<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Part of the correctness of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">sv01</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is convergence on
prefixes of functions in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sv01_converg_V01<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇘</span><sub>01</sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span> <span class="main">↓</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms sv01 R1_imp_total1 auxhyp_in_R1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> n_gr_0<span class="main">:</span> False
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"inconsist <span class="main">(</span>amalg01 <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span> <span class="main">↓=</span> Suc <span class="free">n</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> n_gr_0 assms sv01 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>inconsist <span class="main">(</span>amalg01 <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> Suc <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms inconsist_bounded inconsist_for_V01 length_init
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> le_neq_implies_less option.collapse option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> n_gr_0 assms sv01 R1_imp_total1 total1E V01_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> mem_Collect_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Another part of the correctness of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">sv01</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is its hypotheses
being consistent on prefixes of functions in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sv01_consistent_V01<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span>s<span class="hidden">⇘</span><sub>01</sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇘</span><sub>01</sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> auxhyp <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sv01<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span>s<span class="hidden">⇘</span><sub>01</sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> prenum <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> auxhyp_prenum <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> R1_imp_total1 total1E assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> V01_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> n_gr_0<span class="main">:</span> False
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"amalg01 <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">▹</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?c</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>inconsist <span class="var">?m</span> <span class="var">?e</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"inconsist <span class="var">?m</span> <span class="var">?e</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms inconsist_for_V01 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"inconsist <span class="var">?m</span> <span class="var">?e</span> <span class="main">↓=</span> Suc <span class="free">n</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms n_gr_0 sv01 R1_imp_total1 total1E V01_def is_init_of_def
        inconsist_consistent not_initial_imp_not_eq length_init inconsist_converg_eq 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> le_imp_less_Suc mem_Collect_eq option.sel<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> less<span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>inconsist <span class="var">?m</span> <span class="var">?e</span><span class="main">)</span> <span class="main">&lt;</span> Suc <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> c assms inconsist_bounded inconsist_for_V01 length_init
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_neq_implies_less option.collapse<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>inconsist <span class="var">?m</span> <span class="var">?e</span><span class="main">)</span> <span class="main">&lt;</span> e_length <span class="var">?e</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span>e_length <span class="var">?e</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="var">?m</span> <span class="bound">x</span> <span class="main">↓≠</span> e_nth <span class="var">?e</span> <span class="bound">x</span>"</span></span>
      <span class="quoted"><span class="quoted">"inconsist <span class="var">?m</span> <span class="var">?e</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> e_length <span class="var">?e</span> <span class="main">∧</span> <span class="keyword1">φ</span> <span class="var">?m</span> <span class="bound">x</span> <span class="main">↓≠</span> e_nth <span class="var">?e</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">↓=</span> Least <span class="var">?P</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> inconsist_converg_less<span class="main">[</span><span class="operator">OF</span> c<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="var">?c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="var">?c</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="var">?P</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> LeastI_ex<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">]</span> not_less_Least<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> e_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="var">?m</span> <span class="var">?c</span> <span class="main">≠</span> <span class="free">f</span> <span class="var">?c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"amalgamation <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="var">?c</span> <span class="main">≠</span> <span class="free">f</span> <span class="var">?c</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> amalgamate <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"Some <span class="main">(</span>pdec2 <span class="main">(</span>the <span class="main">(</span>parallel <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="var">?c</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="free">f</span> <span class="var">?c</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> amalgamation_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms parallel_converg_V01<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"parallel <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="var">?c</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"pdec1 <span class="main">(</span>the <span class="var">?p</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="var">?c</span> <span class="main">↓=</span> pdec2 <span class="main">(</span>the <span class="var">?p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms parallel_0 parallel_converg_V01
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.collapse prod.collapse prod_decode_inverse<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="var">?c</span> <span class="main">≠</span> <span class="free">f</span> <span class="var">?c</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms V01_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇘</span><sub>01</sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> True less n_gr_0 sv01 assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pdec1 <span class="main">(</span>the <span class="var">?p</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms parallel_converg_V01 parallel_converg_pdec1_0_or_1<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="var">?c</span> <span class="main">↓=</span> pdec2 <span class="main">(</span>the <span class="var">?p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms parallel_1 parallel_converg_V01
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.collapse prod.collapse prod_decode_inverse<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="var">?c</span> <span class="main">≠</span> <span class="free">f</span> <span class="var">?c</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms V01_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> False less n_gr_0 sv01 assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇘</span><sub>01</sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The final part of the correctness is <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"sv01"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> converging
for all functions in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sv01_limit_V01<span class="main">:</span>
 <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> s<span class="hidden">⇘</span><sub>01</sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="bound">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> s<span class="hidden">⇘</span><sub>01</sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> amalgamate <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> less_le_trans zero_less_one<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> n0<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="quoted"><span class="quoted">"s<span class="hidden">⇘</span><sub>01</sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">↓≠</span> amalg01 <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span>›</span></span> sv01_converg_V01 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>inconsist <span class="main">(</span>amalg01 <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> Suc <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>inconsist <span class="var">?m</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> Suc <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≠</span> <span class="main">0</span>›</span></span> sv01<span class="main">(</span>2<span class="main">)</span> inconsist_bounded inconsist_for_V01 length_init
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> le_neq_implies_less option.collapse option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms V01_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="var">?m</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> amalgamate amalgamation_V01_R1 assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inconsist <span class="var">?m</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inconsist_for_V01 assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"inconsist <span class="var">?m</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="main">(</span><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> inconsist <span class="var">?m</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">m</span>
    <span class="keyword1"><span class="command">using</span></span> inconsist_init_converg_less<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>inconsist <span class="var">?m</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="main">(</span><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> Suc <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">+</span> <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">m</span>
    <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"pdec1 <span class="main">(</span>the <span class="main">(</span>parallel <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span>inconsist <span class="var">?m</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="main">(</span><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      pdec1 <span class="main">(</span>the <span class="main">(</span>parallel <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span>inconsist <span class="var">?m</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">m</span>
    <span class="keyword1"><span class="command">using</span></span> ** <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">+</span> <span class="skolem">m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">m</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"s<span class="hidden">⇘</span><sub>01</sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="main">(</span><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> s<span class="hidden">⇘</span><sub>01</sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">m</span>
    <span class="keyword1"><span class="command">using</span></span> assms sv01 * <span class="quoted"><span class="quoted">‹<span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> s<span class="hidden">⇘</span><sub>01</sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> s<span class="hidden">⇘</span><sub>01</sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nat_le_iff_add <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> s<span class="hidden">⇘</span><sub>01</sub><span class="hidden">⇙</span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> the <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n0<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> V01_learn_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"learn_cons <span class="keyword1">φ</span> <span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span> s<span class="hidden">⇘</span><sub>01</sub><span class="hidden">⇙</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> learn_consI2<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"environment <span class="keyword1">φ</span> <span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span> s<span class="hidden">⇘</span><sub>01</sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Collect_mono V01_def phi_in_P2 sv01_in_P1 sv01_converg_V01<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">≤</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span>s<span class="hidden">⇘</span><sub>01</sub><span class="hidden">⇙</span> <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">k</span> <span class="main">=</span> <span class="bound">f</span> <span class="bound">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sv01_consistent_V01 <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span> <span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> s<span class="hidden">⇘</span><sub>01</sub><span class="hidden">⇙</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="bound">i</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span>
    <span class="keyword1"><span class="command">using</span></span> sv01_limit_V01 that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> V01_in_CONS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> CONS"</span></span>
  <span class="keyword1"><span class="command">using</span></span> V01_learn_cons CONS_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now we can show the main result of this section, namely that
there is a consistently learnable class that cannot be learned consistently
by a total strategy. In other words, there is no Lemma~R for CONS.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> no_lemma_R_for_CONS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">U</span><span class="main">.</span> <span class="bound">U</span> <span class="main">∈</span> CONS <span class="main">∧</span> <span class="main">(</span><span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="keyword1">ℛ</span> <span class="main">∧</span> learn_cons <span class="keyword1">φ</span> <span class="bound">U</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> V01_in_CONS V01_not_in_R_cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="LIM_BC">
<div class="head">
<h1>Theory LIM_BC</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹LIM is a proper subset of BC\label{s:lim_bc}›</span></span>

<span class="keyword1"><span class="command">theory</span></span> LIM_BC
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Lemma_R.html">Lemma_R</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The proper inclusion of LIM in BC has been proved by
Barzdin~\cite{b-ttlsf-74} (see also Case and Smith~\cite{cs-cicmii-83}). The
proof constructs a class $V \in \mathrm{BC} - \mathrm{LIM}$ by
diagonalization against all LIM strategies. Exploiting Lemma~R for LIM, we
can assume that all such strategies are total functions. From the effective
version of this lemma we derive a numbering <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">σ</span></span> <span class="main"><span class="main">∈</span></span>
<span class="keyword1"><span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> such that for all $U \in \mathrm{LIM}$ there is an $i$ with
$U\in \mathrm{LIM}_\varphi(\sigma_i)$. The idea behind $V$
is for every $i$ to construct a class $V_i$ of cardinality one or two such
that $V_i \notin \mathrm{LIM}_\varphi(\sigma_i)$. It then follows that the
union $V := \bigcup_i V_i$ cannot be learned by any $\sigma_i$ and thus $V
\notin \mathrm{LIM}$. At the same time, the construction ensures that the
functions in $V$ are ``predictable enough'' to be learnable in the BC sense.

At the core is a process that maintains a state $(b, k)$ of a list $b$ of
numbers and an index $k &lt; |b|$ into this list. We imagine $b$ to be the
prefix of the function being constructed, except for position $k$ where
we imagine $b$ to have a ``gap''; that is, $b_k$ is not defined yet.
Technically, we will always have $b_k = 0$, so $b$ also represents the prefix
after the ``gap is filled'' with 0, whereas $b_{k:=1}$ represents the prefix
where the gap is filled with 1. For every $i \in \mathbb{N}$, the process
starts in state $(i0, 1)$ and computes the next state from a given state
$(b,k)$ as follows:
\begin{enumerate}
\item if $ \sigma_i(b_{&lt;k}) \neq \sigma_i(b)$ then the next state is $(b0, |b|)$,
\item else if $\sigma_i(b_{&lt;k}) \neq \sigma_i(b_{k:=1})$ then the next state is $(b_{k:=1}0, |b|)$,
\item else the next state is $(b0, k)$.
\end{enumerate}
In other words, if $\sigma_i$ changes its hypothesis when the gap in $b$ is
filled with 0 or 1, then the process fills the gap with 0 or 1, respectively, and
appends a gap to $b$. If, however, a hypothesis change cannot be enforced at
this point, the process appends a 0 to $b$ and leaves the gap alone. Now there
are two cases:
\begin{itemize}
\item[Case 1.] Every gap gets filled eventually. Then the process generates
increasing prefixes of a total function $\tau_i$, on which $\sigma_i$ changes
its hypothesis infinitely often. We set $V_i := \{\tau_i\}$, and have $V_i \notin
\mathrm{LIM}_\varphi(\sigma_i)$.
\item[Case 2.] Some gap never gets filled. That means a state $(b, k)$ is
reached such that $\sigma_i(b0^t) = \sigma_i(b_{k:=1}0^t) = \sigma_i(b_{&lt;k})$
for all $t$. Then the process describes a function $\tau_i = b_{&lt;k}\uparrow0^\infty$,
where the value at the gap $k$ is undefined.
Replacing the value at $k$ by 0 and 1 yields two functions
$\tau_i^{(0)} = b0^\infty$ and $\tau_i^{(1)} = b_{k:=1}0^\infty$, which differ only at $k$ and on
which $\sigma_i$ converges to the same hypothesis. Thus $\sigma_i$ does not learn the
class $V_i := \{\tau_i^{(0)}, \tau_i^{(1)}\}$ in the limit.
\end{itemize}
Both cases combined imply $V \notin \mathrm{LIM}$.

A BC strategy $S$ for $V = \bigcup_i V_i$ works as follows. Let $f\in V$. On input $f^n$ the
strategy outputs a Gödel number of the function
\[
g_n(x) = \left\{\begin{array}{ll}
    f(x) &amp; \mbox{if } x \leq n,\\
    \tau_{f(0)}(x) &amp; \mbox{otherwise}.
\end{array}\right.
\]
By definition of $V$, $f$ is generated by the process running for $i = f(0)$.
If $f(0)$ leads to Case~1 then $f = \tau_{f(0)}$, and
$g_n$ equals $f$ for all $n$. If $f(0)$ leads to Case~2 with
a forever unfilled gap at $k$, then
$g_n$ will be equal to the correct one of $\tau_i^{(0)}$ or $\tau_i^{(1)}$ for all $n
\geq k$. Intuitively, the prefix received by $S$ eventually grows long enough to
reveal the value $f(k)$.
In both cases $S$ converges to $f$, but it outputs a different Gödel number
for every $f^n$ because $g_n$ contains the ``hard-coded'' values
$f(0),\dots,f(n)$. Therefore $S$ is a BC strategy but not a LIM
strategy for $V$.›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Enumerating enough total strategies›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For the construction of $\sigma$ we need the function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">r_limr</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> from the effective version of Lemma~R for LIM.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_sigma</span> <span class="main">≡</span> Cn <span class="numeral">2</span> r_phi <span class="main">[</span>Cn <span class="numeral">2</span> r_limr <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_sigma_recfn<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> r_sigma"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_sigma_def <span class="keyword1"><span class="command">using</span></span> r_limr_recfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_sigma<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_sigma <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span>eval r_limr <span class="main">[</span><span class="free">i</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_sigma_def phi_def <span class="keyword1"><span class="command">using</span></span> r_sigma_recfn r_limr_total r_limr_recfn
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_sigma_total<span class="main">:</span> <span class="quoted"><span class="quoted">"total r_sigma"</span></span>
  <span class="keyword1"><span class="command">using</span></span> r_sigma r_limr r_sigma_recfn totalI2<span class="main">[</span><span class="operator">of</span> <span class="quoted">r_sigma</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">sigma</span> <span class="main">::</span> <span class="quoted">partial2</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">σ</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">σ</span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> eval r_sigma <span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sigma<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">σ</span> <span class="free">i</span> <span class="main">=</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span>eval r_limr <span class="main">[</span><span class="free">i</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> r_sigma <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The numbering <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="keyword1"><span class="quoted"><span class="keyword1">σ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> does indeed enumerate enough total
strategies for every LIM learning problem.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> learn_lim_sigma<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"learn_lim <span class="free">ψ</span> <span class="free">U</span> <span class="main">(</span><span class="keyword1">φ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"learn_lim <span class="free">ψ</span> <span class="free">U</span> <span class="main">(</span><span class="keyword1">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms sigma r_limr <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The diagonalization process›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following function represents the process described above. It
computes the next state from a given state $(b, k)$.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_next</span> <span class="main">≡</span>
  Cn <span class="main">1</span> r_ifeq
   <span class="main">[</span>Cn <span class="main">1</span> r_sigma <span class="main">[</span>Cn <span class="main">1</span> r_hd <span class="main">[</span>r_pdec1<span class="main">]</span><span class="main">,</span> r_pdec1<span class="main">]</span><span class="main">,</span>
    Cn <span class="main">1</span> r_sigma <span class="main">[</span>Cn <span class="main">1</span> r_hd <span class="main">[</span>r_pdec1<span class="main">]</span><span class="main">,</span> Cn <span class="main">1</span> r_take <span class="main">[</span>r_pdec2<span class="main">,</span> r_pdec1<span class="main">]</span><span class="main">]</span><span class="main">,</span>
    Cn <span class="main">1</span> r_ifeq
     <span class="main">[</span>Cn <span class="main">1</span> r_sigma <span class="main">[</span>Cn <span class="main">1</span> r_hd <span class="main">[</span>r_pdec1<span class="main">]</span><span class="main">,</span> Cn <span class="main">1</span> r_update <span class="main">[</span>r_pdec1<span class="main">,</span> r_pdec2<span class="main">,</span> r_const <span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">,</span>
      Cn <span class="main">1</span> r_sigma <span class="main">[</span>Cn <span class="main">1</span> r_hd <span class="main">[</span>r_pdec1<span class="main">]</span><span class="main">,</span> Cn <span class="main">1</span> r_take <span class="main">[</span>r_pdec2<span class="main">,</span> r_pdec1<span class="main">]</span><span class="main">]</span><span class="main">,</span>
      Cn <span class="main">1</span> r_prod_encode <span class="main">[</span>Cn <span class="main">1</span> r_snoc <span class="main">[</span>r_pdec1<span class="main">,</span> Z<span class="main">]</span><span class="main">,</span> r_pdec2<span class="main">]</span><span class="main">,</span>
      Cn <span class="main">1</span> r_prod_encode
       <span class="main">[</span>Cn <span class="main">1</span> r_snoc
         <span class="main">[</span>Cn <span class="main">1</span> r_update <span class="main">[</span>r_pdec1<span class="main">,</span> r_pdec2<span class="main">,</span> r_const <span class="main">1</span><span class="main">]</span><span class="main">,</span> Z<span class="main">]</span><span class="main">,</span> Cn <span class="main">1</span> r_length <span class="main">[</span>r_pdec1<span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">,</span>
    Cn <span class="main">1</span> r_prod_encode <span class="main">[</span>Cn <span class="main">1</span> r_snoc <span class="main">[</span>r_pdec1<span class="main">,</span> Z<span class="main">]</span><span class="main">,</span> Cn <span class="main">1</span> r_length <span class="main">[</span>r_pdec1<span class="main">]</span><span class="main">]</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_next_recfn<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> r_next"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_next_def <span class="keyword1"><span class="command">using</span></span> r_sigma_recfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The three conditions distinguished in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">r_next</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> correspond
to Steps 1, 2, and 3 of the process: hypothesis change when the gap is
filled with 0; hypothesis change when the gap is filled with 1; or
no hypothesis change either way.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">change_on_0</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≡</span> <span class="keyword1">σ</span> <span class="main">(</span>e_hd <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≠</span> <span class="keyword1">σ</span> <span class="main">(</span>e_hd <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>e_take <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">change_on_1</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≡</span>
  <span class="keyword1">σ</span> <span class="main">(</span>e_hd <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="keyword1">σ</span> <span class="main">(</span>e_hd <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>e_take <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">∧</span>
  <span class="keyword1">σ</span> <span class="main">(</span>e_hd <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>e_update <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">1</span><span class="main">)</span> <span class="main">≠</span> <span class="keyword1">σ</span> <span class="main">(</span>e_hd <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>e_take <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">change_on_neither</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≡</span>
  <span class="keyword1">σ</span> <span class="main">(</span>e_hd <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="keyword1">σ</span> <span class="main">(</span>e_hd <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>e_take <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">∧</span>
  <span class="keyword1">σ</span> <span class="main">(</span>e_hd <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>e_update <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ</span> <span class="main">(</span>e_hd <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span>e_take <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> change_conditions<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span>
    <span class="main">(</span>on_0<span class="main">)</span> <span class="quoted"><span class="quoted">"change_on_0 <span class="free">b</span> <span class="free">k</span>"</span></span>
  <span class="main">|</span> <span class="main">(</span>on_1<span class="main">)</span> <span class="quoted"><span class="quoted">"change_on_1 <span class="free">b</span> <span class="free">k</span>"</span></span>
  <span class="main">|</span> <span class="main">(</span>neither<span class="main">)</span> <span class="quoted"><span class="quoted">"change_on_neither <span class="free">b</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> r_next<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">arg</span> <span class="main">=</span> prod_encode <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"change_on_0 <span class="free">b</span> <span class="free">k</span> <span class="main">⟹</span> eval r_next <span class="main">[</span><span class="free">arg</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span>e_snoc <span class="free">b</span> <span class="main">0</span><span class="main">,</span> e_length <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"change_on_1 <span class="free">b</span> <span class="free">k</span> <span class="main">⟹</span>
      eval r_next <span class="main">[</span><span class="free">arg</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span>e_snoc <span class="main">(</span>e_update <span class="free">b</span> <span class="free">k</span> <span class="main">1</span><span class="main">)</span> <span class="main">0</span><span class="main">,</span> e_length <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"change_on_neither <span class="free">b</span> <span class="free">k</span> <span class="main">⟹</span> eval r_next <span class="main">[</span><span class="free">arg</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span>e_snoc <span class="free">b</span> <span class="main">0</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?bhd</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="main">1</span> r_hd <span class="main">[</span>r_pdec1<span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?bup</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="main">1</span> r_update <span class="main">[</span>r_pdec1<span class="main">,</span> r_pdec2<span class="main">,</span> r_const <span class="main">1</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?bk</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="main">1</span> r_take <span class="main">[</span>r_pdec2<span class="main">,</span> r_pdec1<span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?bap</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="main">1</span> r_snoc <span class="main">[</span>r_pdec1<span class="main">,</span> Z<span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?len</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="main">1</span> r_length <span class="main">[</span>r_pdec1<span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?thenthen</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="main">1</span> r_prod_encode <span class="main">[</span><span class="var">?bap</span><span class="main">,</span> r_pdec2<span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?thenelse</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="main">1</span> r_prod_encode <span class="main">[</span>Cn <span class="main">1</span> r_snoc <span class="main">[</span><span class="var">?bup</span><span class="main">,</span> Z<span class="main">]</span><span class="main">,</span> <span class="var">?len</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?else</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="main">1</span> r_prod_encode <span class="main">[</span><span class="var">?bap</span><span class="main">,</span> <span class="var">?len</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> bhd<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="var">?bhd</span> <span class="main">[</span><span class="free">arg</span><span class="main">]</span> <span class="main">↓=</span> e_hd <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> bup<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="var">?bup</span> <span class="main">[</span><span class="free">arg</span><span class="main">]</span> <span class="main">↓=</span> e_update <span class="free">b</span> <span class="free">k</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> bk<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="var">?bk</span> <span class="main">[</span><span class="free">arg</span><span class="main">]</span> <span class="main">↓=</span> e_take <span class="free">k</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> bap<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="var">?bap</span> <span class="main">[</span><span class="free">arg</span><span class="main">]</span> <span class="main">↓=</span> e_snoc <span class="free">b</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="var">?len</span> <span class="main">[</span><span class="free">arg</span><span class="main">]</span> <span class="main">↓=</span> e_length <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> else_<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="var">?else</span> <span class="main">[</span><span class="free">arg</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span>e_snoc <span class="free">b</span> <span class="main">0</span><span class="main">,</span> e_length <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bap len <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> thenthen<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="var">?thenthen</span> <span class="main">[</span><span class="free">arg</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span>e_snoc <span class="free">b</span> <span class="main">0</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bap assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> thenelse<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="var">?thenelse</span> <span class="main">[</span><span class="free">arg</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span>e_snoc <span class="main">(</span>e_update <span class="free">b</span> <span class="free">k</span> <span class="main">1</span><span class="main">)</span> <span class="main">0</span><span class="main">,</span> e_length <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bup len <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> then_<span class="main">:</span>
    <span class="quoted"><span class="quoted">"eval
      <span class="main">(</span>Cn <span class="main">1</span> r_ifeq <span class="main">[</span>Cn <span class="main">1</span> r_sigma <span class="main">[</span><span class="var">?bhd</span><span class="main">,</span> <span class="var">?bup</span><span class="main">]</span><span class="main">,</span> Cn <span class="main">1</span> r_sigma <span class="main">[</span><span class="var">?bhd</span><span class="main">,</span> <span class="var">?bk</span><span class="main">]</span><span class="main">,</span> <span class="var">?thenthen</span><span class="main">,</span> <span class="var">?thenelse</span><span class="main">]</span><span class="main">)</span>
      <span class="main">[</span><span class="free">arg</span><span class="main">]</span> <span class="main">↓=</span>
    <span class="main">(</span><span class="keyword1">if</span> the <span class="main">(</span><span class="keyword1">σ</span> <span class="main">(</span>e_hd <span class="free">b</span><span class="main">)</span> <span class="main">(</span>e_update <span class="free">b</span> <span class="free">k</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span><span class="keyword1">σ</span> <span class="main">(</span>e_hd <span class="free">b</span><span class="main">)</span> <span class="main">(</span>e_take <span class="free">k</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span>
     <span class="keyword1">then</span> prod_encode <span class="main">(</span>e_snoc <span class="free">b</span> <span class="main">0</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span>
     <span class="keyword1">else</span> prod_encode <span class="main">(</span>e_snoc <span class="main">(</span>e_update <span class="free">b</span> <span class="free">k</span> <span class="main">1</span><span class="main">)</span> <span class="main">0</span><span class="main">,</span> e_length <span class="free">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?then</span> <span class="main">[</span><span class="free">arg</span><span class="main">]</span> <span class="main">↓=</span> <span class="var">?then_eval</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> bhd bup bk thenthen thenelse r_sigma r_sigma_recfn r_limr R1_imp_total1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_next <span class="main">[</span><span class="free">arg</span><span class="main">]</span> <span class="main">↓=</span>
    <span class="main">(</span><span class="keyword1">if</span> the <span class="main">(</span><span class="keyword1">σ</span> <span class="main">(</span>e_hd <span class="free">b</span><span class="main">)</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span><span class="keyword1">σ</span> <span class="main">(</span>e_hd <span class="free">b</span><span class="main">)</span> <span class="main">(</span>e_take <span class="free">k</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span>
     <span class="keyword1">then</span> <span class="var">?then_eval</span>
     <span class="keyword1">else</span> prod_encode <span class="main">(</span>e_snoc <span class="free">b</span> <span class="main">0</span><span class="main">,</span> e_length <span class="free">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> r_next_def
    <span class="keyword1"><span class="command">using</span></span> bhd bk then_ else_ r_sigma r_sigma_recfn r_limr R1_imp_total1 assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> r_sigma_neq<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_sigma <span class="main">[</span><span class="skolem">x<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">y<span class="hidden">⇩</span><sub>1</sub></span><span class="main">]</span> <span class="main">≠</span> eval r_sigma <span class="main">[</span><span class="skolem">x<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">y<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span> <span class="main">⟷</span>
      the <span class="main">(</span>eval r_sigma <span class="main">[</span><span class="skolem">x<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">y<span class="hidden">⇩</span><sub>1</sub></span><span class="main">]</span><span class="main">)</span> <span class="main">≠</span> the <span class="main">(</span>eval r_sigma <span class="main">[</span><span class="skolem">x<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">y<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">y<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">y<span class="hidden">⇩</span><sub>2</sub></span>
    <span class="keyword1"><span class="command">using</span></span> r_sigma r_limr totalE<span class="main">[</span><span class="operator">OF</span> r_sigma_total r_sigma_recfn<span class="main">]</span> r_sigma_recfn r_sigma_total
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_1 length_Cons list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> option.expand<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"change_on_0 <span class="free">b</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eval r_next <span class="main">[</span><span class="free">arg</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span>e_snoc <span class="free">b</span> <span class="main">0</span><span class="main">,</span> e_length <span class="free">b</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> * r_sigma_neq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"change_on_1 <span class="free">b</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eval r_next <span class="main">[</span><span class="free">arg</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span>e_snoc <span class="main">(</span>e_update <span class="free">b</span> <span class="free">k</span> <span class="main">1</span><span class="main">)</span> <span class="main">0</span><span class="main">,</span> e_length <span class="free">b</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> * r_sigma_neq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"change_on_neither <span class="free">b</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eval r_next <span class="main">[</span><span class="free">arg</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span>e_snoc <span class="free">b</span> <span class="main">0</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> * r_sigma_neq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_next_total<span class="main">:</span> <span class="quoted"><span class="quoted">"total r_next"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> totalI1<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> r_next"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_next_recfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eval r_next <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">↓</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> prod_encode <span class="main">(</span><span class="skolem">b</span><span class="main">,</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod_encode_pdec'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> r_next <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next function computes the state of the process after
any number of iterations.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_state</span> <span class="main">≡</span>
  Pr <span class="main">1</span>
   <span class="main">(</span>Cn <span class="main">1</span> r_prod_encode <span class="main">[</span>Cn <span class="main">1</span> r_snoc <span class="main">[</span>Cn <span class="main">1</span> r_singleton_encode <span class="main">[</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span> Z<span class="main">]</span><span class="main">,</span> r_const <span class="main">1</span><span class="main">]</span><span class="main">)</span>
   <span class="main">(</span>Cn <span class="numeral">3</span> r_next <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_state_recfn<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> r_state"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_state_def <span class="keyword1"><span class="command">using</span></span> r_next_recfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_state_at_0<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_state <span class="main">[</span><span class="main">0</span><span class="main">,</span> <span class="free">i</span><span class="main">]</span> <span class="main">↓=</span> prod_encode <span class="main">(</span>list_encode <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="main">1</span> r_prod_encode <span class="main">[</span>Cn <span class="main">1</span> r_snoc <span class="main">[</span>Cn <span class="main">1</span> r_singleton_encode <span class="main">[</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span> Z<span class="main">]</span><span class="main">,</span> r_const <span class="main">1</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_state <span class="main">[</span><span class="main">0</span><span class="main">,</span> <span class="free">i</span><span class="main">]</span> <span class="main">=</span> eval <span class="var">?f</span> <span class="main">[</span><span class="free">i</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> r_state_def <span class="keyword1"><span class="command">using</span></span> r_next_recfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">↓=</span> prod_encode <span class="main">(</span>list_encode <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_decode_singleton<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_state_total<span class="main">:</span> <span class="quoted"><span class="quoted">"total r_state"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_state_def
  <span class="keyword1"><span class="command">using</span></span> r_next_recfn totalE<span class="main">[</span><span class="operator">OF</span> r_next_total r_next_recfn<span class="main">]</span> totalI3<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Cn <span class="numeral">3</span> r_next <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Pr_total<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We call the components of a state $(b, k)$ the \emph{block} $b$
and the \emph{gap} $k$.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">block</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">block</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> pdec1 <span class="main">(</span>the <span class="main">(</span>eval r_state <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gap</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gap</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> pdec2 <span class="main">(</span>the <span class="main">(</span>eval r_state <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> state_at_0<span class="main">:</span>
  <span class="quoted"><span class="quoted">"block <span class="free">i</span> <span class="main">0</span> <span class="main">=</span> list_encode <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="main">0</span><span class="main">]</span>"</span></span>
  <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="main">0</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> block_def gap_def r_state_at_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Some lemmas describing the behavior of blocks and gaps in
one iteration of the process:›</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> state_Suc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> block <span class="free">i</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> gap <span class="free">i</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"block <span class="free">i</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span> <span class="main">=</span> pdec1 <span class="main">(</span>the <span class="main">(</span>eval r_next <span class="main">[</span>prod_encode <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span> <span class="main">=</span> pdec2 <span class="main">(</span>the <span class="main">(</span>eval r_next <span class="main">[</span>prod_encode <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_state <span class="main">[</span>Suc <span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">]</span> <span class="main">=</span>
      eval <span class="main">(</span>Cn <span class="numeral">3</span> r_next <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="free">t</span><span class="main">,</span> the <span class="main">(</span>eval r_state <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="free">i</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_state_recfn r_next_recfn totalE<span class="main">[</span><span class="operator">OF</span> r_state_total r_state_recfn<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">]</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_state_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> eval r_next <span class="main">[</span>the <span class="main">(</span>eval r_state <span class="main">[</span><span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_next_recfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> eval r_next <span class="main">[</span>prod_encode <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms block_def gap_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_state <span class="main">[</span>Suc <span class="free">t</span><span class="main">,</span> <span class="free">i</span><span class="main">]</span> <span class="main">=</span> eval r_next <span class="main">[</span>prod_encode <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"block <span class="free">i</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span> <span class="main">=</span> pdec1 <span class="main">(</span>the <span class="main">(</span>eval r_next <span class="main">[</span>prod_encode <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span> <span class="main">=</span> pdec2 <span class="main">(</span>the <span class="main">(</span>eval r_next <span class="main">[</span>prod_encode <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">k</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> block_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gap_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gap_Suc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> block <span class="free">i</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> gap <span class="free">i</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"change_on_0 <span class="free">b</span> <span class="free">k</span> <span class="main">⟹</span> gap <span class="free">i</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span> <span class="main">=</span> e_length <span class="free">b</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"change_on_1 <span class="free">b</span> <span class="free">k</span> <span class="main">⟹</span> gap <span class="free">i</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span> <span class="main">=</span> e_length <span class="free">b</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"change_on_neither <span class="free">b</span> <span class="free">k</span><span class="main">⟹</span> gap <span class="free">i</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms r_next state_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> block_Suc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> block <span class="free">i</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> gap <span class="free">i</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"change_on_0 <span class="free">b</span> <span class="free">k</span> <span class="main">⟹</span> block <span class="free">i</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span> <span class="main">=</span> e_snoc <span class="free">b</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"change_on_1 <span class="free">b</span> <span class="free">k</span> <span class="main">⟹</span> block <span class="free">i</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span> <span class="main">=</span> e_snoc <span class="main">(</span>e_update <span class="free">b</span> <span class="free">k</span> <span class="main">1</span><span class="main">)</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"change_on_neither <span class="free">b</span> <span class="free">k</span><span class="main">⟹</span> block <span class="free">i</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span> <span class="main">=</span> e_snoc <span class="free">b</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms r_next state_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Non-gap positions in the block remain unchanged after an
iteration.›</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> block_stable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> e_length <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≠</span> gap <span class="free">i</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"e_nth <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> e_nth <span class="main">(</span>block <span class="free">i</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> change_conditions<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"block <span class="free">i</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="free">t</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms block_Suc gap_Suc
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next are some properties of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">block</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">gap</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> gap_in_block<span class="main">:</span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="free">t</span> <span class="main">&lt;</span> e_length <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> state_at_0<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> change_conditions<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"block <span class="free">i</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="skolem">t</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> on_0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> block_Suc<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> gap_Suc<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> on_1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> block_Suc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> gap_Suc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> neither
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc.IH block_Suc<span class="main">(</span>3<span class="main">)</span> gap_Suc<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> length_block<span class="main">:</span> <span class="quoted"><span class="quoted">"e_length <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> state_at_0<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> change_conditions<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"block <span class="free">i</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="skolem">t</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> block_Suc gap_Suc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gap_gr0<span class="main">:</span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="free">t</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> state_at_0<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> change_conditions<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"block <span class="free">i</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="skolem">t</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> length_block <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> block_Suc gap_Suc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> hd_block<span class="main">:</span> <span class="quoted"><span class="quoted">"e_hd <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> state_at_0<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> change_conditions<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"block <span class="free">i</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="skolem">t</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> on_0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc block_Suc<span class="main">(</span>1<span class="main">)</span> length_block <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> e_hd_snoc gap_Suc<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> gap_gr0<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> on_1
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"block <span class="free">i</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?k</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gap_gr0 Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_nth <span class="main">(</span>e_update <span class="var">?b</span> <span class="var">?k</span> <span class="main">1</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> e_nth <span class="var">?b</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"e_hd <span class="main">(</span>e_update <span class="var">?b</span> <span class="var">?k</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> e_hd <span class="var">?b</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> e_hd_nth0 gap_Suc<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> gap_gr0 on_1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> e_length_update<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> on_1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"block <span class="free">i</span> <span class="main">(</span>Suc <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> e_snoc <span class="main">(</span>e_update <span class="var">?b</span> <span class="var">?k</span> <span class="main">1</span><span class="main">)</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> block_Suc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> e_hd_0 e_hd_snoc Suc length_block <span class="quoted"><span class="quoted">‹<span class="var">?k</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> *
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> e_length_update gap_Suc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> gap_gr0 on_1<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> neither
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc block_Suc<span class="main">(</span>3<span class="main">)</span> length_block <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Formally, a block always ends in zero, even if it ends in a gap.›</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> last_block<span class="main">:</span> <span class="quoted"><span class="quoted">"e_nth <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>gap <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> state_at_0<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> change_conditions<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"block <span class="free">i</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="skolem">t</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> on_0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> block_Suc<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> gap_Suc<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> on_1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> block_Suc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> gap_Suc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> neither
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"block <span class="free">i</span> <span class="main">(</span>Suc <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> e_snoc <span class="main">(</span>block <span class="free">i</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">0</span>"</span></span>
      <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="main">(</span>Suc <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> gap <span class="free">i</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gap_Suc<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> block_Suc<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc gap_in_block <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> gap_le_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="free">t</span> <span class="main">≤</span> gap <span class="free">i</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> change_conditions<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"block <span class="free">i</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="free">t</span>"</span></span><span class="main">]</span>
    gap_Suc gap_in_block less_imp_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"e_length <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> gap_monotone<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> gap <span class="free">i</span> <span class="free">t<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> gap <span class="free">i</span> <span class="main">(</span><span class="free">t<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> gap_le_Suc dual_order.trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms le_Suc_ex <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We need some lemmas relating the shape of the next state
to the hypothesis change conditions in Steps 1, 2, and 3.›</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> state_change_on_neither<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span> <span class="main">=</span> gap <span class="free">i</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"change_on_neither <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>gap <span class="free">i</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"block <span class="free">i</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span> <span class="main">=</span> e_snoc <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"block <span class="free">i</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?k</span> <span class="main">&lt;</span> e_length <span class="var">?b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gap_in_block <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> change_conditions<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"change_on_neither <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>gap <span class="free">i</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> on_0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?k</span> <span class="main">&lt;</span> e_length <span class="var">?b</span>›</span></span> assms gap_Suc<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> on_1
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms gap_Suc<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> neither
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"block <span class="free">i</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span> <span class="main">=</span> e_snoc <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> block_Suc<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> state_change_on_either<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span> <span class="main">≠</span> gap <span class="free">i</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> change_on_neither <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>gap <span class="free">i</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span> <span class="main">=</span> e_length <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"block <span class="free">i</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="free">t</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> change_on_neither <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>gap <span class="free">i</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"change_on_neither <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>gap <span class="free">i</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="var">?k</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gap_Suc<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span> <span class="main">=</span> e_length <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gap_Suc<span class="main">(</span>1<span class="main">)</span> gap_Suc<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next up is the definition of $\tau$. In every iteration the
process determines $\tau_i(x)$ for some $x$ either by appending 0 to the
current block $b$, or by filling the current gap $k$. In the former case,
the value is determined for $x = |b|$, in the latter for $x = k$.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For $i$ and $x$ the function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">r_dettime</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> computes in which
iteration the process for $i$ determines the value $\tau_i(x)$. This is the
first iteration in which the block is long enough to contain position $x$ and
in which $x$ is not the gap. If $\tau_i(x)$ is never determined, because Case~2 is
reached with $k = x$, then <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">r_dettime</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> diverges.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">determined</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">determined</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> e_length <span class="main">(</span>block <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≠</span> gap <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">t</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> determined_0<span class="main">:</span> <span class="quoted"><span class="quoted">"determined <span class="free">i</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> gap_gr0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> gap_in_block<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_dettime</span> <span class="main">≡</span>
  Mn <span class="numeral">2</span>
   <span class="main">(</span>Cn <span class="numeral">3</span> r_and
     <span class="main">[</span>Cn <span class="numeral">3</span> r_less
       <span class="main">[</span>Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">,</span> Cn <span class="numeral">3</span> r_length <span class="main">[</span>Cn <span class="numeral">3</span> r_pdec1 <span class="main">[</span>Cn <span class="numeral">3</span> r_state <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">,</span>
      Cn <span class="numeral">3</span> r_neq
       <span class="main">[</span>Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">,</span> Cn <span class="numeral">3</span> r_pdec2 <span class="main">[</span>Cn <span class="numeral">3</span> r_state <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_dettime_recfn<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> r_dettime"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_dettime_def <span class="keyword1"><span class="command">using</span></span> r_state_recfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">dettime</span> <span class="main">::</span> <span class="quoted">partial2</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dettime</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> eval r_dettime <span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_dettime<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"determined <span class="free">i</span> <span class="free">x</span> <span class="main">⟹</span> dettime <span class="free">i</span> <span class="free">x</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">t</span><span class="main">.</span> <span class="free">x</span> <span class="main">&lt;</span> e_length <span class="main">(</span>block <span class="free">i</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">≠</span> gap <span class="free">i</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> determined <span class="free">i</span> <span class="free">x</span> <span class="main">⟹</span> dettime <span class="free">i</span> <span class="free">x</span> <span class="main">↑</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span>
   <span class="main">(</span>Cn <span class="numeral">3</span> r_and
     <span class="main">[</span>Cn <span class="numeral">3</span> r_less
       <span class="main">[</span>Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">,</span> Cn <span class="numeral">3</span> r_length <span class="main">[</span>Cn <span class="numeral">3</span> r_pdec1 <span class="main">[</span>Cn <span class="numeral">3</span> r_state <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">,</span>
      Cn <span class="numeral">3</span> r_neq
       <span class="main">[</span>Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">,</span> Cn <span class="numeral">3</span> r_pdec2 <span class="main">[</span>Cn <span class="numeral">3</span> r_state <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"r_dettime <span class="main">=</span> Mn <span class="numeral">2</span> <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> f_def r_dettime_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">3</span> <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="keyword1"><span class="command">using</span></span> r_state_recfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"total <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="keyword1"><span class="command">using</span></span> Cn_total r_state_total Mn_free_imp_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="skolem">f</span> <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">&lt;</span> e_length <span class="main">(</span>block <span class="free">i</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">≠</span> gap <span class="free">i</span> <span class="skolem">t</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="numeral">3</span> r_pdec1 <span class="main">[</span>Cn <span class="numeral">3</span> r_state <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="numeral">3</span> r_pdec2 <span class="main">[</span>Cn <span class="numeral">3</span> r_state <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?b</span> <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> pdec1 <span class="main">(</span>the <span class="main">(</span>eval r_state <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> r_state_recfn r_state_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="var">?b</span> <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> block <span class="free">i</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> block_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?k</span> <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> pdec2 <span class="main">(</span>the <span class="main">(</span>eval r_state <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> r_state_recfn r_state_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="var">?k</span> <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> gap <span class="free">i</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gap_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval
          <span class="main">(</span>Cn <span class="numeral">3</span> r_neq <span class="main">[</span>Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">,</span> Cn <span class="numeral">3</span> r_pdec2 <span class="main">[</span>Cn <span class="numeral">3</span> r_state <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">)</span>
          <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span>
       <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">≠</span> gap <span class="free">i</span> <span class="skolem">t</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> b k r_state_recfn r_state_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval
          <span class="main">(</span>Cn <span class="numeral">3</span> r_less
            <span class="main">[</span>Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">,</span> Cn <span class="numeral">3</span> r_length <span class="main">[</span>Cn <span class="numeral">3</span> r_pdec1 <span class="main">[</span>Cn <span class="numeral">3</span> r_state <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">]</span><span class="main">)</span>
          <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span>
       <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">&lt;</span> e_length <span class="main">(</span>block <span class="free">i</span> <span class="skolem">t</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> b k r_state_recfn r_state_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="keyword1"><span class="command">using</span></span> b k r_state_recfn r_state_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"determined <span class="free">i</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> f <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span> eval <span class="skolem">f</span> <span class="main">[</span><span class="bound">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dettime <span class="free">i</span> <span class="free">x</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">t</span><span class="main">.</span> eval <span class="skolem">f</span> <span class="main">[</span><span class="bound">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹total <span class="skolem">f</span>›</span></span> <span class="quoted"><span class="quoted">‹r_dettime <span class="main">=</span> Mn <span class="numeral">2</span> <span class="skolem">f</span>›</span></span> r_dettime_recfn <span class="quoted"><span class="quoted">‹recfn <span class="numeral">3</span> <span class="skolem">f</span>›</span></span>
        eval_Mn_total<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dettime <span class="free">i</span> <span class="free">x</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">t</span><span class="main">.</span> <span class="free">x</span> <span class="main">&lt;</span> e_length <span class="main">(</span>block <span class="free">i</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">≠</span> gap <span class="free">i</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> determined <span class="free">i</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> f <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> eval <span class="skolem">f</span> <span class="main">[</span><span class="bound">t</span><span class="main">,</span> <span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dettime <span class="free">i</span> <span class="free">x</span> <span class="main">↑</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹total <span class="skolem">f</span>›</span></span> <span class="quoted"><span class="quoted">‹r_dettime <span class="main">=</span> Mn <span class="numeral">2</span> <span class="skolem">f</span>›</span></span> r_dettime_recfn <span class="quoted"><span class="quoted">‹recfn <span class="numeral">3</span> <span class="skolem">f</span>›</span></span>
        eval_Mn_total<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> f <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dettime <span class="free">i</span> <span class="free">x</span> <span class="main">↑</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_dettimeI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> e_length <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">≠</span> gap <span class="free">i</span> <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">T</span><span class="main">.</span> <span class="free">x</span> <span class="main">&lt;</span> e_length <span class="main">(</span>block <span class="free">i</span> <span class="bound">T</span><span class="main">)</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">≠</span> gap <span class="free">i</span> <span class="bound">T</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">≤</span> <span class="bound">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dettime <span class="free">i</span> <span class="free">x</span> <span class="main">↓=</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">T</span><span class="main">.</span> <span class="free">x</span> <span class="main">&lt;</span> e_length <span class="main">(</span>block <span class="free">i</span> <span class="bound">T</span><span class="main">)</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">≠</span> gap <span class="free">i</span> <span class="bound">T</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"determined <span class="free">i</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Least <span class="var">?P</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms Least_equality<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> r_dettime <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_dettime_0<span class="main">:</span> <span class="quoted"><span class="quoted">"dettime <span class="free">i</span> <span class="main">0</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> r_dettimeI<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> determined_0 gap_gr0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> gap_in_block<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Computing the value of $\tau_i(x)$ works by running the process
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">r_state</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"dettime <span class="free"><span class="free">i</span></span> <span class="free"><span class="free">x</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> iterations and taking the value at
index $x$ of the resulting block.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_tau</span> <span class="main">≡</span> Cn <span class="numeral">2</span> r_nth <span class="main">[</span>Cn <span class="numeral">2</span> r_pdec1 <span class="main">[</span>Cn <span class="numeral">2</span> r_state <span class="main">[</span>r_dettime<span class="main">,</span> Id <span class="numeral">2</span> <span class="main">0</span><span class="main">]</span><span class="main">]</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_tau_recfn<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> r_tau"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_tau_def <span class="keyword1"><span class="command">using</span></span> r_dettime_recfn r_state_recfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">tau</span> <span class="main">::</span> <span class="quoted">partial2</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">τ</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">τ</span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> eval r_tau <span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tau_in_P2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">τ</span> <span class="main">∈</span> <span class="keyword1">𝒫<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> r_tau_recfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> tau_diverg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> determined <span class="free">i</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">τ</span> <span class="free">i</span> <span class="free">x</span> <span class="main">↑</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_tau_def <span class="keyword1"><span class="command">using</span></span> assms r_dettime r_dettime_recfn r_state_recfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> tau_converg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"determined <span class="free">i</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">τ</span> <span class="free">i</span> <span class="free">x</span> <span class="main">↓=</span> e_nth <span class="main">(</span>block <span class="free">i</span> <span class="main">(</span>the <span class="main">(</span>dettime <span class="free">i</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"dettime <span class="free">i</span> <span class="free">x</span> <span class="main">↓=</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_dettime<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Cn <span class="numeral">2</span> r_state <span class="main">[</span>r_dettime<span class="main">,</span> Id <span class="numeral">2</span> <span class="main">0</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span> eval r_state <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_state_recfn r_dettime_recfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_state <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_state_total r_state_recfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Cn <span class="numeral">2</span> r_pdec1 <span class="main">[</span>Cn <span class="numeral">2</span> r_state <span class="main">[</span>r_dettime<span class="main">,</span> Id <span class="numeral">2</span> <span class="main">0</span><span class="main">]</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">=</span>
      eval r_pdec1 <span class="main">[</span>the <span class="main">(</span>eval r_state <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_state_recfn r_dettime_recfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> r_tau_def <span class="keyword1"><span class="command">using</span></span> r_state_recfn r_dettime_recfn t block_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tau_converg'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dettime <span class="free">i</span> <span class="free">x</span> <span class="main">↓=</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">τ</span> <span class="free">i</span> <span class="free">x</span> <span class="main">↓=</span> e_nth <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms tau_converg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span> r_dettime<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> tau_at_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">τ</span> <span class="free">i</span> <span class="main">0</span> <span class="main">↓=</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">τ</span> <span class="free">i</span> <span class="main">0</span> <span class="main">↓=</span> e_nth <span class="main">(</span>block <span class="free">i</span> <span class="main">0</span><span class="main">)</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tau_converg'<span class="main">[</span><span class="operator">OF</span> r_dettime_0<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> block_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_state_at_0<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> state_unchanged<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="free">t</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≤</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="free">t</span> <span class="main">=</span> gap <span class="free">i</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="free">t</span> <span class="main">=</span> gap <span class="free">i</span> <span class="main">(</span>gap <span class="free">i</span> <span class="free">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gap_def r_state_at_0<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">t</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="main">(</span>Suc <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">t</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> Suc state_change_on_either<span class="main">(</span>2<span class="main">)</span> length_block <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="main">(</span>gap <span class="free">i</span> <span class="free">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≤</span> gap <span class="free">i</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> gap_monotone <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="free">y</span> <span class="main">≤</span> gap <span class="free">i</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> gap_monotone <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The values of the non-gap indices $x$ of every block created in
the diagonalization process equal $\tau_i(x)$.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tau_eq_state<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> e_length <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≠</span> gap <span class="free">i</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">τ</span> <span class="free">i</span> <span class="free">j</span> <span class="main">↓=</span> e_nth <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gap_gr0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> gap_in_block<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> length_block<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">τ</span> <span class="main">(</span>e_hd <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">j</span> <span class="main">↓=</span> e_nth <span class="main">(</span>block <span class="free">i</span> <span class="main">(</span>the <span class="main">(</span>dettime <span class="free">i</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> determined_0 tau_converg hd_block <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">τ</span> <span class="main">(</span>e_hd <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">j</span> <span class="main">↓=</span> e_nth <span class="main">(</span>block <span class="free">i</span> <span class="main">0</span><span class="main">)</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_dettime_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">=</span> <span class="main">0</span>›</span></span> r_dettime_0 tau_converg' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"block <span class="free">i</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?bb</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"block <span class="free">i</span> <span class="main">(</span>Suc <span class="skolem">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?kk</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="main">(</span>Suc <span class="skolem">t</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?kk</span> <span class="main">=</span> <span class="var">?k</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> kk_eq_k<span class="main">:</span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> bb_b0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?bb</span> <span class="main">=</span> e_snoc <span class="var">?b</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> state_change_on_neither <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">τ</span> <span class="free">i</span> <span class="free">j</span> <span class="main">↓=</span> e_nth <span class="var">?bb</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> e_length <span class="var">?b</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_nth <span class="var">?bb</span> <span class="free">j</span> <span class="main">=</span> e_nth <span class="var">?b</span> <span class="free">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> bb_b0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≠</span> <span class="var">?k</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Suc kk_eq_k <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">=</span> e_length <span class="var">?b</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>1<span class="main">)</span> length_block <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_nth <span class="var">?bb</span> <span class="free">j</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> bb_b0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dettime <span class="free">i</span> <span class="free">j</span> <span class="main">↓=</span> Suc <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> r_dettimeI<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> e_length <span class="var">?bb</span> <span class="main">∧</span> <span class="free">j</span> <span class="main">≠</span> <span class="var">?kk</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">T</span><span class="main">.</span> <span class="free">j</span> <span class="main">&lt;</span> e_length <span class="main">(</span>block <span class="free">i</span> <span class="bound">T</span><span class="main">)</span> <span class="main">∧</span> <span class="free">j</span> <span class="main">≠</span> gap <span class="free">i</span> <span class="bound">T</span> <span class="main">⟹</span> Suc <span class="skolem">t</span> <span class="main">≤</span> <span class="bound">T</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> length_block j <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">with</span></span> tau_converg' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> kk_lenb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?kk</span> <span class="main">=</span> e_length <span class="var">?b</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> state_change_on_either <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">=</span> <span class="var">?k</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> j_eq_k<span class="main">:</span> True
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dettime <span class="free">i</span> <span class="free">j</span> <span class="main">↓=</span> Suc <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> r_dettimeI<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> e_length <span class="var">?bb</span> <span class="main">∧</span> <span class="free">j</span> <span class="main">≠</span> <span class="var">?kk</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">t</span> <span class="main">≤</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> e_length <span class="main">(</span>block <span class="free">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">∧</span> <span class="free">j</span> <span class="main">≠</span> gap <span class="free">i</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">T</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>Suc <span class="skolem">t</span> <span class="main">≤</span> <span class="skolem">T</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">&lt;</span> Suc <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">&lt;</span> <span class="var">?k</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_length <span class="main">(</span>block <span class="free">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">T</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> length_block <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_length <span class="main">(</span>block <span class="free">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">&lt;</span> <span class="var">?k</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_length <span class="main">(</span>block <span class="free">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_length <span class="main">(</span>block <span class="free">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> j_eq_k <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
              <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?k</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≤</span> <span class="skolem">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">T</span> <span class="main">&lt;</span> Suc <span class="skolem">t</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
            <span class="keyword1"><span class="command">with</span></span> state_unchanged <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="skolem">t</span> <span class="main">=</span> gap <span class="free">i</span> <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
              <span class="keyword1"><span class="command">using</span></span> j_eq_k that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> tau_converg' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> e_length <span class="var">?b</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> kk_lenb Suc.prems<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> length_block <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc False block_stable <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tau_eq_state'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">t</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">" <span class="free">j</span> <span class="main">≠</span> gap <span class="free">i</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">τ</span> <span class="free">i</span> <span class="free">j</span> <span class="main">↓=</span> e_nth <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms tau_eq_state length_block <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now consider the two cases described in the proof sketch.
In Case~2 there is a gap that never gets filled, or equivalently there is
a rightmost gap.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">case_two</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="main">∀</span><span class="bound">T</span><span class="main">.</span> gap <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">T</span> <span class="main">≤</span> gap <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">case_one</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> <span class="main">¬</span> case_two <span class="free"><span class="bound"><span class="entity">i</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Another characterization of Case~2 is that from some iteration on
only <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">change_on_neither</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> holds.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> case_two_iff_forever_neither<span class="main">:</span>
  <span class="quoted"><span class="quoted">"case_two <span class="free">i</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">T</span></span><span class="main">≥</span><span class="bound">t</span><span class="main">.</span> change_on_neither <span class="main">(</span>block <span class="free">i</span> <span class="bound">T</span><span class="main">)</span> <span class="main">(</span>gap <span class="free">i</span> <span class="bound">T</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">T</span></span><span class="main">≥</span><span class="bound">t</span><span class="main">.</span> change_on_neither <span class="main">(</span>block <span class="free">i</span> <span class="bound">T</span><span class="main">)</span> <span class="main">(</span>gap <span class="free">i</span> <span class="bound">T</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">T</span></span><span class="main">≥</span><span class="skolem">t</span><span class="main">.</span> change_on_neither <span class="main">(</span>block <span class="free">i</span> <span class="bound">T</span><span class="main">)</span> <span class="main">(</span>gap <span class="free">i</span> <span class="bound">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>gap <span class="free">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>gap <span class="free">i</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">T</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> gap_monotone <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">T</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">T</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> t <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"change_on_neither <span class="main">(</span><span class="main">(</span>block <span class="free">i</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>gap <span class="free">i</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> Suc.IH state_change_on_either<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="skolem">T</span></span><span class="main">]</span> gap_monotone<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">T</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="main">∀</span><span class="bound">T</span><span class="main">.</span> gap <span class="free">i</span> <span class="bound">T</span> <span class="main">≤</span> gap <span class="free">i</span> <span class="bound">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="main">∀</span><span class="bound">T</span><span class="main">.</span> gap <span class="free">i</span> <span class="bound">T</span> <span class="main">≤</span> gap <span class="free">i</span> <span class="bound">t</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">T</span><span class="main">.</span> gap <span class="free">i</span> <span class="bound">T</span> <span class="main">≤</span> gap <span class="free">i</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"change_on_neither <span class="main">(</span>block <span class="free">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">(</span>gap <span class="free">i</span> <span class="skolem">T</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span><span class="main">≥</span><span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">T</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>gap <span class="free">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">≥</span> <span class="main">(</span>gap <span class="free">i</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gap_monotone that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> change_on_neither <span class="main">(</span>block <span class="free">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">(</span>gap <span class="free">i</span> <span class="skolem">T</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"change_on_0 <span class="main">(</span>block <span class="free">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">(</span>gap <span class="free">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">∨</span> change_on_1 <span class="main">(</span>block <span class="free">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">(</span>gap <span class="free">i</span> <span class="skolem">T</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="main">(</span>Suc <span class="skolem">T</span><span class="main">)</span> <span class="main">&gt;</span> gap <span class="free">i</span> <span class="skolem">T</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gap_le_Suc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span> state_change_on_either<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span> state_change_on_neither<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span>
          dual_order.strict_iff_order
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> T <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="main">(</span>Suc <span class="skolem">T</span><span class="main">)</span> <span class="main">&gt;</span> gap <span class="free">i</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> t <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> not_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">T</span></span><span class="main">≥</span><span class="bound">t</span><span class="main">.</span> change_on_neither <span class="main">(</span>block <span class="free">i</span> <span class="bound">T</span><span class="main">)</span> <span class="main">(</span>gap <span class="free">i</span> <span class="bound">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In Case~1, $\tau_i$ is total.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> case_one_tau_total<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"case_one <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">τ</span> <span class="free">i</span> <span class="free">x</span> <span class="main">↓</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> gap <span class="free">i</span> <span class="free">x</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">∃</span><span class="bound">T</span><span class="main">.</span> gap <span class="free">i</span> <span class="bound">T</span> <span class="main">&gt;</span> gap <span class="free">i</span> <span class="bound">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> le_less_linear gap_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword">where</span></span> T<span class="main">:</span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="skolem">T</span> <span class="main">&gt;</span> gap <span class="free">i</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">&gt;</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gap_monotone leD le_less_linear <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="skolem">T</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> T True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> gap <span class="free">i</span> <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> tau_eq_state' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">x</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> tau_eq_state' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In Case~2, $\tau_i$ is undefined only at the gap that never gets filled.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> case_two_tau_not_quite_total<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">T</span><span class="main">.</span> gap <span class="free">i</span> <span class="bound">T</span> <span class="main">≤</span> gap <span class="free">i</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">τ</span> <span class="free">i</span> <span class="main">(</span>gap <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">↑</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> gap <span class="free">i</span> <span class="free">t</span> <span class="main">⟹</span> <span class="keyword1">τ</span> <span class="free">i</span> <span class="free">x</span> <span class="main">↓</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> determined <span class="free">i</span> <span class="var">?k</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"determined <span class="free">i</span> <span class="var">?k</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword">where</span></span> T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?k</span> <span class="main">&lt;</span> e_length <span class="main">(</span>block <span class="free">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">∧</span> <span class="var">?k</span> <span class="main">≠</span> gap <span class="free">i</span> <span class="skolem">T</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> snd_le<span class="main">:</span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="skolem">T</span> <span class="main">&lt;</span> <span class="var">?k</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dual_order.strict_iff_order<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">&lt;</span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gap_monotone <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> leD le_less_linear<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> T length_block <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?k</span> <span class="main">&lt;</span> <span class="skolem">T</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?k</span> <span class="main">≠</span> <span class="skolem">T</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> T state_change_on_either<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">T</span> <span class="main">&lt;</span> <span class="free">t</span>›</span></span> state_unchanged
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 Suc_leI add_diff_cancel_right' le_add1 nat_neq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?k</span> <span class="main">≤</span> <span class="skolem">T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="skolem">T</span> <span class="main">=</span> gap <span class="free">i</span> <span class="var">?k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> state_unchanged<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="skolem">T</span></span> <span class="quoted"><span class="quoted">"<span class="var">?k</span>"</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="var">?k</span> <span class="main">&lt;</span> <span class="skolem">T</span> <span class="main">+</span> <span class="numeral">2</span>›</span></span> snd_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_le_self state_unchanged leD nat_le_linear gap_monotone snd_le<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> tau_diverg <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">τ</span> <span class="free">i</span> <span class="var">?k</span> <span class="main">↑</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="var">?k</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">τ</span> <span class="free">i</span> <span class="free">x</span> <span class="main">↓</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">t</span> <span class="main">+</span> <span class="numeral">2</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="var">?k</span>›</span></span> tau_eq_state' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="free">x</span> <span class="main">=</span> <span class="var">?k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dual_order.antisym gap_monotone<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≠</span> <span class="var">?k</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> gap <span class="free">i</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> tau_eq_state'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> case_two_tau_almost_total<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="main">∀</span><span class="bound">T</span><span class="main">.</span> gap <span class="free">i</span> <span class="bound">T</span> <span class="main">≤</span> gap <span class="free">i</span> <span class="bound">t</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">t</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">τ</span> <span class="free">i</span> <span class="main">(</span>gap <span class="free">i</span> <span class="main">(</span>Least <span class="var">?P</span><span class="main">)</span><span class="main">)</span> <span class="main">↑</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> gap <span class="free">i</span> <span class="main">(</span>Least <span class="var">?P</span><span class="main">)</span> <span class="main">⟹</span> <span class="keyword1">τ</span> <span class="free">i</span> <span class="free">x</span> <span class="main">↓</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span>Least <span class="var">?P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> LeastI_ex<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">τ</span> <span class="free">i</span> <span class="main">(</span>gap <span class="free">i</span> <span class="main">(</span>Least <span class="var">?P</span><span class="main">)</span><span class="main">)</span> <span class="main">↑</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> gap <span class="free">i</span> <span class="main">(</span>Least <span class="var">?P</span><span class="main">)</span> <span class="main">⟹</span> <span class="keyword1">τ</span> <span class="free">i</span> <span class="free">x</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> case_two_tau_not_quite_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Some more properties of $\tau$.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> init_tau_gap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">τ</span> <span class="free">i</span><span class="main">)</span> <span class="main">▹</span> <span class="main">(</span>gap <span class="free">i</span> <span class="free">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> e_take <span class="main">(</span>gap <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> initI'<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"e_length <span class="main">(</span>e_take <span class="main">(</span>gap <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>gap <span class="free">i</span> <span class="free">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="free">t</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gap_gr0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="free">t</span> <span class="main">&lt;</span> e_length <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gap_in_block <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_length <span class="main">(</span>e_take <span class="main">(</span>gap <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> gap <span class="free">i</span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> gap_gr0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">τ</span> <span class="free">i</span> <span class="skolem">x</span> <span class="main">↓=</span> e_nth <span class="main">(</span>e_take <span class="main">(</span>gap <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> Suc <span class="main">(</span>gap <span class="free">i</span> <span class="free">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> x_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> gap <span class="free">i</span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that gap_gr0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> e_length <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gap_in_block less_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">τ</span> <span class="free">i</span> <span class="skolem">x</span> <span class="main">↓=</span> e_nth <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x_le tau_eq_state <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> e_length <span class="main">(</span>e_take <span class="main">(</span>gap <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x_le 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_nth <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> e_nth <span class="main">(</span>e_take <span class="main">(</span>gap <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> change_on_0_init_tau<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"change_on_0 <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>gap <span class="free">i</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">τ</span> <span class="free">i</span><span class="main">)</span> <span class="main">▹</span> <span class="main">(</span><span class="free">t</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> block <span class="free">i</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> initI'<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"block <span class="free">i</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="free">t</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"e_length <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">t</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> length_block <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">τ</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">↓=</span> e_nth <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> Suc <span class="main">(</span><span class="free">t</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="var">?k</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span> <span class="main">=</span> e_length <span class="var">?b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"block <span class="free">i</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span> <span class="main">=</span> e_snoc <span class="var">?b</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gap_Suc<span class="main">(</span>1<span class="main">)</span> block_Suc<span class="main">(</span>1<span class="main">)</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> e_length <span class="main">(</span>block <span class="free">i</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> gap <span class="free">i</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that length_block <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">τ</span> <span class="free">i</span> <span class="skolem">x</span> <span class="main">↓=</span> e_nth <span class="main">(</span>block <span class="free">i</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tau_eq_state <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that assms b <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that assms tau_eq_state' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> change_on_0_hyp_change<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"change_on_0 <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>gap <span class="free">i</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">σ</span> <span class="free">i</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">τ</span> <span class="free">i</span><span class="main">)</span> <span class="main">▹</span> <span class="main">(</span><span class="free">t</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="keyword1">σ</span> <span class="free">i</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">τ</span> <span class="free">i</span><span class="main">)</span> <span class="main">▹</span> <span class="main">(</span>gap <span class="free">i</span> <span class="free">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms hd_block init_tau_gap change_on_0_init_tau <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> change_on_1_init_tau<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"change_on_1 <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>gap <span class="free">i</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">τ</span> <span class="free">i</span><span class="main">)</span> <span class="main">▹</span>  <span class="main">(</span><span class="free">t</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> e_update <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>gap <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> initI'<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"block <span class="free">i</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="free">t</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"e_length <span class="main">(</span>e_update <span class="var">?b</span> <span class="var">?k</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">t</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> length_block <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">τ</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">↓=</span> e_nth <span class="main">(</span>e_update <span class="var">?b</span> <span class="var">?k</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> Suc <span class="main">(</span><span class="free">t</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="var">?k</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span> <span class="main">=</span> e_length <span class="var">?b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"block <span class="free">i</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span> <span class="main">=</span> e_snoc <span class="main">(</span>e_update <span class="var">?b</span> <span class="var">?k</span> <span class="main">1</span><span class="main">)</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gap_Suc<span class="main">(</span>2<span class="main">)</span> block_Suc<span class="main">(</span>2<span class="main">)</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> e_length <span class="main">(</span>block <span class="free">i</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> gap <span class="free">i</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that length_block <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">τ</span> <span class="free">i</span> <span class="skolem">x</span> <span class="main">↓=</span> e_nth <span class="main">(</span>block <span class="free">i</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tau_eq_state <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that assms b nth_append <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that assms tau_eq_state' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> change_on_1_hyp_change<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"change_on_1 <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>gap <span class="free">i</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">σ</span> <span class="free">i</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">τ</span> <span class="free">i</span><span class="main">)</span> <span class="main">▹</span> <span class="main">(</span><span class="free">t</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="keyword1">σ</span> <span class="free">i</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">τ</span> <span class="free">i</span><span class="main">)</span> <span class="main">▹</span> <span class="main">(</span>gap <span class="free">i</span> <span class="free">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms hd_block init_tau_gap change_on_1_init_tau <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> change_on_either_hyp_change<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> change_on_neither <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>gap <span class="free">i</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">σ</span> <span class="free">i</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">τ</span> <span class="free">i</span><span class="main">)</span> <span class="main">▹</span> <span class="main">(</span><span class="free">t</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="keyword1">σ</span> <span class="free">i</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">τ</span> <span class="free">i</span><span class="main">)</span> <span class="main">▹</span> <span class="main">(</span>gap <span class="free">i</span> <span class="free">t</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms change_on_0_hyp_change change_on_1_hyp_change <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> filled_gap_0_init_tau<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">τ</span> <span class="free">i</span><span class="main">)</span><span class="main">(</span><span class="main">(</span>gap <span class="free">i</span> <span class="free">t</span><span class="main">)</span><span class="main">:=</span>Some <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">▹</span> <span class="main">(</span><span class="free">t</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> block <span class="free">i</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> initI'<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"e_length <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">t</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms length_block <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">x</span> <span class="main">↓=</span> e_nth <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> Suc <span class="main">(</span><span class="free">t</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> gap <span class="free">i</span> <span class="free">t</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms last_block <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms len tau_eq_state that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> filled_gap_1_init_tau<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">τ</span> <span class="free">i</span><span class="main">)</span><span class="main">(</span><span class="main">(</span>gap <span class="free">i</span> <span class="free">t</span><span class="main">)</span><span class="main">:=</span>Some <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">▹</span> <span class="main">(</span><span class="free">t</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> e_update <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>gap <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> initI'<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"e_length <span class="main">(</span>e_update <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>gap <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">t</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> e_length_update length_block <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">x</span> <span class="main">↓=</span> e_nth <span class="main">(</span>e_update <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>gap <span class="free">i</span> <span class="free">t</span><span class="main">)</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> Suc <span class="main">(</span><span class="free">t</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> gap <span class="free">i</span> <span class="free">t</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="free">t</span> <span class="main">&lt;</span> e_length <span class="main">(</span>block <span class="free">i</span> <span class="free">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gap_in_block <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms len tau_eq_state that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The separating class›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next we define the sets $V_i$ from the introductory proof sketch
(page~\pageref{s:lim_bc}).›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">V_bclim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> partial1 set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">V_bclim</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span>
    <span class="keyword1">if</span> case_two <span class="free"><span class="bound"><span class="entity">i</span></span></span>
    <span class="keyword1">then</span> <span class="keyword1">let</span> <span class="bound">k</span> <span class="main">=</span> gap <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">t</span><span class="main">.</span> <span class="main">∀</span><span class="bound">T</span><span class="main">.</span> gap <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">T</span> <span class="main">≤</span> gap <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">t</span><span class="main">)</span>
         <span class="keyword1">in</span> <span class="main">{</span><span class="main">(</span><span class="keyword1">τ</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">(</span><span class="bound">k</span><span class="main">:=</span>Some <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">τ</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">(</span><span class="bound">k</span><span class="main">:=</span>Some <span class="main">1</span><span class="main">)</span><span class="main">}</span>
    <span class="keyword1">else</span> <span class="main">{</span><span class="keyword1">τ</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> V_subseteq_R1<span class="main">:</span> <span class="quoted"><span class="quoted">"V_bclim <span class="free">i</span> <span class="main">⊆</span> <span class="keyword1">ℛ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"case_two <span class="free">i</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> gap <span class="free">i</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">t</span><span class="main">.</span> <span class="main">∀</span><span class="bound">T</span><span class="main">.</span> gap <span class="free">i</span> <span class="bound">T</span> <span class="main">≤</span> gap <span class="free">i</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">τ</span> <span class="free">i</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tau_in_P2 P2_proj_P1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">τ</span> <span class="free">i</span><span class="main">)</span><span class="main">(</span><span class="skolem">k</span><span class="main">:=</span>Some <span class="main">0</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">τ</span> <span class="free">i</span><span class="main">)</span><span class="main">(</span><span class="skolem">k</span><span class="main">:=</span>Some <span class="main">1</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> P1_update_P1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"total1 <span class="main">(</span><span class="main">(</span><span class="keyword1">τ</span> <span class="free">i</span><span class="main">)</span><span class="main">(</span><span class="skolem">k</span><span class="main">:=</span>Some <span class="skolem">v</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span>
     <span class="keyword1"><span class="command">using</span></span> case_two_tau_almost_total<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span> k_def total1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">τ</span> <span class="free">i</span><span class="main">)</span><span class="main">(</span><span class="skolem">k</span><span class="main">:=</span>Some <span class="main">0</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">τ</span> <span class="free">i</span><span class="main">)</span><span class="main">(</span><span class="skolem">k</span><span class="main">:=</span>Some <span class="main">1</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> P1_total_imp_R1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"V_bclim <span class="free">i</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="keyword1">τ</span> <span class="free">i</span><span class="main">)</span><span class="main">(</span><span class="skolem">k</span><span class="main">:=</span>Some <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">τ</span> <span class="free">i</span><span class="main">)</span><span class="main">(</span><span class="skolem">k</span><span class="main">:=</span>Some <span class="main">1</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> True V_bclim_def k_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"V_bclim <span class="free">i</span> <span class="main">=</span> <span class="main">{</span><span class="keyword1">τ</span> <span class="free">i</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> V_bclim_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> False<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">τ</span> <span class="free">i</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> total1I case_one_tau_total<span class="main">[</span><span class="operator">OF</span> False<span class="main">]</span> tau_in_P2 P2_proj_P1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="keyword1">τ</span></span><span class="main">]</span> P1_total_imp_R1
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> case_one_imp_gap_unbounded<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"case_one <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span> gap <span class="free">i</span> <span class="bound">t</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&gt;</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms gap_gr0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span> state_at_0<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_is_0_eq gr_zeroI<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="skolem">t</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&gt;</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">∃</span><span class="bound">T</span><span class="main">.</span> gap <span class="free">i</span> <span class="bound">T</span> <span class="main">&gt;</span> gap <span class="free">i</span> <span class="bound">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> leI <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="skolem">T</span> <span class="main">&gt;</span> gap <span class="free">i</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="skolem">T</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&gt;</span> gap <span class="free">i</span> <span class="skolem">t</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gap_gr0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc_le_eq diff_less_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> t <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="skolem">T</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&gt;</span> Suc <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> case_one_imp_not_learn_lim_V<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"case_one <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> learn_lim <span class="keyword1">φ</span> <span class="main">(</span>V_bclim <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> V_bclim<span class="main">:</span> <span class="quoted"><span class="quoted">"V_bclim <span class="free">i</span> <span class="main">=</span> <span class="main">{</span><span class="keyword1">τ</span> <span class="free">i</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms V_bclim_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">m<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main">&gt;</span><span class="skolem">n</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">m<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">&gt;</span><span class="skolem">n</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">τ</span> <span class="free">i</span><span class="main">)</span> <span class="main">▹</span> <span class="bound">m<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span><span class="keyword1">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">τ</span> <span class="free">i</span><span class="main">)</span> <span class="main">▹</span> <span class="bound">m<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="skolem">t</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&gt;</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> case_one_imp_gap_unbounded<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">T</span></span><span class="main">≥</span><span class="bound">t</span><span class="main">.</span> <span class="main">¬</span> change_on_neither <span class="main">(</span>block <span class="free">i</span> <span class="bound">T</span><span class="main">)</span> <span class="main">(</span>gap <span class="free">i</span> <span class="bound">T</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms case_two_iff_forever_neither <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword">where</span></span> T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">≥</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> change_on_neither <span class="main">(</span>block <span class="free">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">(</span>gap <span class="free">i</span> <span class="skolem">T</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">τ</span> <span class="free">i</span><span class="main">)</span> <span class="main">▹</span> <span class="main">(</span><span class="skolem">T</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">(</span><span class="keyword1">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">τ</span> <span class="free">i</span><span class="main">)</span> <span class="main">▹</span> <span class="main">(</span>gap <span class="free">i</span> <span class="skolem">T</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> change_on_either_hyp_change <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="skolem">T</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&gt;</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t T<span class="main">(</span>1<span class="main">)</span> gap_monotone <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_le_mono less_le_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&gt;</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="skolem">T</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≤</span> <span class="skolem">T</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gap_in_block length_block <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_diff_conv less_Suc_eq_le<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹gap <span class="free">i</span> <span class="skolem">T</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&gt;</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> infinite_hyp_changes_not_Lim V_bclim <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> case_two_imp_not_learn_lim_V<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"case_two <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> learn_lim <span class="keyword1">φ</span> <span class="main">(</span>V_bclim <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">∀</span><span class="bound">T</span><span class="main">.</span> <span class="main">(</span>gap <span class="free">i</span> <span class="bound">T</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>gap <span class="free">i</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">LEAST</span> <span class="bound">t</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">t</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"gap <span class="free">i</span> <span class="var">?t</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"e_take <span class="var">?k</span> <span class="main">(</span>block <span class="free">i</span> <span class="var">?t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">T</span><span class="main">.</span> gap <span class="free">i</span> <span class="bound">T</span> <span class="main">≤</span> gap <span class="free">i</span> <span class="var">?t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms LeastI_ex<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> neither<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">T</span></span><span class="main">≥</span><span class="var">?t</span><span class="main">.</span> change_on_neither <span class="main">(</span>block <span class="free">i</span> <span class="bound">T</span><span class="main">)</span> <span class="main">(</span>gap <span class="free">i</span> <span class="bound">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gap_le_Suc gap_monotone state_change_on_neither<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> gap_T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">T</span></span><span class="main">≥</span><span class="var">?t</span><span class="main">.</span> gap <span class="free">i</span> <span class="bound">T</span> <span class="main">=</span> <span class="var">?k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> t gap_monotone antisym_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">τ</span> <span class="free">i</span><span class="main">)</span><span class="main">(</span><span class="var">?k</span><span class="main">:=</span>Some <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">τ</span> <span class="free">i</span><span class="main">)</span><span class="main">(</span><span class="var">?k</span><span class="main">:=</span>Some <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> same_hyp_for_two_not_Lim<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> V_bclim <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> V_bclim <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms V_bclim_def f<span class="hidden">⇩</span><sub>0</sub>_def f<span class="hidden">⇩</span><sub>1</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≠</span> <span class="skolem">f<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f<span class="hidden">⇩</span><sub>0</sub>_def f<span class="hidden">⇩</span><sub>1</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> map_upd_eqD1 zero_neq_one<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span>Suc <span class="var">?t</span><span class="main">.</span> <span class="keyword1">σ</span> <span class="free">i</span> <span class="main">(</span><span class="skolem">f<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ</span> <span class="free">i</span> <span class="var">?b</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">σ</span> <span class="free">i</span> <span class="main">(</span>block <span class="free">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ</span> <span class="free">i</span> <span class="main">(</span>e_take <span class="var">?k</span> <span class="main">(</span>block <span class="free">i</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">≥</span> <span class="var">?t</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">T</span>
        <span class="keyword1"><span class="command">using</span></span> that gap_T neither hd_block <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">σ</span> <span class="free">i</span> <span class="main">(</span>block <span class="free">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ</span> <span class="free">i</span> <span class="var">?b</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">≥</span> <span class="var">?t</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">T</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> init_tau_gap gap_T that<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">σ</span> <span class="free">i</span> <span class="main">(</span><span class="skolem">f<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">▹</span> <span class="main">(</span><span class="skolem">T</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ</span> <span class="free">i</span> <span class="var">?b</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">≥</span> <span class="var">?t</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">T</span>
        <span class="keyword1"><span class="command">using</span></span> filled_gap_0_init_tau<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="skolem">T</span></span><span class="main">]</span> f<span class="hidden">⇩</span><sub>0</sub>_def gap_T that
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">σ</span> <span class="free">i</span> <span class="main">(</span><span class="skolem">f<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">▹</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ</span> <span class="free">i</span> <span class="var">?b</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">≥</span> Suc <span class="var">?t</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">T</span>
        <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Suc_eq_plus1 Suc_le_D Suc_le_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span>Suc <span class="var">?t</span><span class="main">.</span> <span class="keyword1">σ</span> <span class="free">i</span> <span class="main">(</span><span class="skolem">f<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ</span> <span class="free">i</span> <span class="var">?b</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">σ</span> <span class="free">i</span> <span class="main">(</span>e_update <span class="main">(</span>block <span class="free">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="var">?k</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ</span> <span class="free">i</span> <span class="main">(</span>e_take <span class="var">?k</span> <span class="main">(</span>block <span class="free">i</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">≥</span> <span class="var">?t</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">T</span>
        <span class="keyword1"><span class="command">using</span></span> neither <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> hd_block gap_T that<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">σ</span> <span class="free">i</span> <span class="main">(</span>e_update <span class="main">(</span>block <span class="free">i</span> <span class="skolem">T</span><span class="main">)</span> <span class="var">?k</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ</span> <span class="free">i</span> <span class="var">?b</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">≥</span> <span class="var">?t</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">T</span>
        <span class="keyword1"><span class="command">using</span></span> that init_tau_gap<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span> gap_T <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">σ</span> <span class="free">i</span> <span class="main">(</span><span class="skolem">f<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">▹</span> <span class="main">(</span><span class="skolem">T</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ</span> <span class="free">i</span> <span class="var">?b</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">≥</span> <span class="var">?t</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">T</span>
        <span class="keyword1"><span class="command">using</span></span> filled_gap_1_init_tau<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="skolem">T</span></span><span class="main">]</span> f<span class="hidden">⇩</span><sub>1</sub>_def gap_T that
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">σ</span> <span class="free">i</span> <span class="main">(</span><span class="skolem">f<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">▹</span> <span class="skolem">T</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">σ</span> <span class="free">i</span> <span class="var">?b</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">≥</span> Suc <span class="var">?t</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">T</span>
        <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Suc_eq_plus1 Suc_le_D Suc_le_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> not_learn_lim_V<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> learn_lim <span class="keyword1">φ</span> <span class="main">(</span>V_bclim <span class="free">i</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">σ</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> case_one_imp_not_learn_lim_V case_two_imp_not_learn_lim_V
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"case_two <span class="free">i</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next we define the separating class.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">V_BCLIM</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial1 set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">V<span class="hidden">⇘</span><sub>BC-LIM</sub><span class="hidden">⇙</span></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"V<span class="hidden">⇘</span><sub>BC-LIM</sub><span class="hidden">⇙</span> <span class="main">≡</span> <span class="main">⋃</span><span class="bound">i</span><span class="main">.</span> V_bclim <span class="bound">i</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> V_BCLIM_R1<span class="main">:</span> <span class="quoted"><span class="quoted">"V<span class="hidden">⇘</span><sub>BC-LIM</sub><span class="hidden">⇙</span> <span class="main">⊆</span> <span class="keyword1">ℛ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> V_BCLIM_def V_subseteq_R1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> V_BCLIM_not_in_Lim<span class="main">:</span> <span class="quoted"><span class="quoted">"V<span class="hidden">⇘</span><sub>BC-LIM</sub><span class="hidden">⇙</span> <span class="main">∉</span> <span class="keyword1">LIM</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"V<span class="hidden">⇘</span><sub>BC-LIM</sub><span class="hidden">⇙</span> <span class="main">∈</span> <span class="keyword1">LIM</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"learn_lim <span class="keyword1">φ</span> V<span class="hidden">⇘</span><sub>BC-LIM</sub><span class="hidden">⇙</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> learn_lim_wrt_goedel<span class="main">[</span><span class="operator">OF</span> goedel_numbering_phi<span class="main">]</span> Lim_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> s learn_limE<span class="main">(</span>1<span class="main">)</span> phi_universal <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"learn_lim <span class="keyword1">φ</span> V<span class="hidden">⇘</span><sub>BC-LIM</sub><span class="hidden">⇙</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> eval r_sigma <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> learn_lim_sigma <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"V_bclim <span class="skolem">i</span> <span class="main">⊆</span> V<span class="hidden">⇘</span><sub>BC-LIM</sub><span class="hidden">⇙</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> V_BCLIM_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"learn_lim <span class="keyword1">φ</span> <span class="main">(</span>V_bclim <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> eval r_sigma <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> learn_lim_closed_subseteq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> not_learn_lim_V <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The separating class is in BC›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In order to show <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"V<span class="hidden">⇘</span><sub>BC-LIM</sub><span class="hidden">⇙</span> <span class="main"><span class="main">∈</span></span> BC"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> we
define a hypothesis space that for every function $\tau_i$ and every list $b$
of numbers contains a copy of $\tau_i$ with the first $|b|$ values replaced
by $b$.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">psitau</span> <span class="main">::</span> <span class="quoted">partial2</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ψ<span class="hidden">⇧</span><sup>τ</sup></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ψ<span class="hidden">⇧</span><sup>τ</sup></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> e_length <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> Some <span class="main">(</span>e_nth <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="keyword1">τ</span> <span class="main">(</span>e_hd <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> psitau_in_P2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ<span class="hidden">⇧</span><sup>τ</sup></span> <span class="main">∈</span> <span class="keyword1">𝒫<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≡</span>
    Cn <span class="numeral">2</span>
     <span class="main">(</span>r_lifz r_nth <span class="main">(</span>Cn <span class="numeral">2</span> r_tau <span class="main">[</span>Cn <span class="numeral">2</span> r_hd <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
     <span class="main">[</span>Cn <span class="numeral">2</span> r_less <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">1</span><span class="main">,</span> Cn <span class="numeral">2</span> r_length <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">0</span><span class="main">]</span><span class="main">]</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_tau_recfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">r</span> <span class="main">[</span><span class="skolem">b</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> <span class="keyword1">ψ<span class="hidden">⇧</span><sup>τ</sup></span> <span class="skolem">b</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">b</span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="numeral">2</span> r_tau <span class="main">[</span>Cn <span class="numeral">2</span> r_hd <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> r_nth"</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="var">?f</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> r_tau_recfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_lifz r_nth <span class="var">?f</span><span class="main">)</span> <span class="main">[</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">b</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">=</span>
        <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">c</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> eval r_nth <span class="main">[</span><span class="skolem">b</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="keyword1">else</span> eval <span class="var">?f</span> <span class="main">[</span><span class="skolem">b</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">c</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_nth <span class="main">[</span><span class="skolem">b</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">↓=</span> e_nth <span class="skolem">b</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?f</span> <span class="main">[</span><span class="skolem">b</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> <span class="keyword1">τ</span> <span class="main">(</span>e_hd <span class="skolem">b</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> r_tau_recfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_lifz r_nth <span class="var">?f</span><span class="main">)</span> <span class="main">[</span><span class="skolem">c</span><span class="main">,</span> <span class="skolem">b</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">=</span>
        <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">c</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> Some <span class="main">(</span>e_nth <span class="skolem">b</span> <span class="skolem">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="keyword1">τ</span> <span class="main">(</span>e_hd <span class="skolem">b</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">c</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Cn <span class="numeral">2</span> r_less <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">1</span><span class="main">,</span> Cn <span class="numeral">2</span> r_length <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">0</span><span class="main">]</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="skolem">b</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">↓=</span>
        <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">&lt;</span> e_length <span class="skolem">b</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> r_def psitau_def <span class="keyword1"><span class="command">using</span></span> r_tau_recfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> psitau_init<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">ψ<span class="hidden">⇧</span><sup>τ</sup></span> <span class="main">(</span><span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">&lt;</span> Suc <span class="free">n</span> <span class="keyword1">then</span> Some <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="keyword1">τ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">f</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">▹</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_length <span class="var">?e</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> Suc <span class="free">n</span> <span class="main">⟹</span> e_nth <span class="var">?e</span> <span class="free">x</span> <span class="main">=</span> the <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_hd <span class="var">?e</span> <span class="main">=</span> the <span class="main">(</span><span class="free">f</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> hd_init <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> psitau_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The class <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">V_BCLIM</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> can be learned BC-style in the
hypothesis space <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">psitau</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by the identity function.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> learn_bc_V_BCLIM<span class="main">:</span> <span class="quoted"><span class="quoted">"learn_bc <span class="keyword1">ψ<span class="hidden">⇧</span><sup>τ</sup></span> V<span class="hidden">⇘</span><sub>BC-LIM</sub><span class="hidden">⇙</span> Some"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> learn_bcI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"environment <span class="keyword1">ψ<span class="hidden">⇧</span><sup>τ</sup></span> V<span class="hidden">⇘</span><sub>BC-LIM</sub><span class="hidden">⇙</span> Some"</span></span>
    <span class="keyword1"><span class="command">using</span></span> identity_in_R1 V_BCLIM_R1 psitau_in_P2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="keyword1">ψ<span class="hidden">⇧</span><sup>τ</sup></span> <span class="main">(</span>the <span class="main">(</span>Some <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> V<span class="hidden">⇘</span><sub>BC-LIM</sub><span class="hidden">⇙</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> that V_BCLIM_def <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> V_bclim <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"case_two <span class="skolem">i</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">∀</span><span class="bound">T</span><span class="main">.</span> <span class="main">(</span>gap <span class="skolem">i</span> <span class="bound">T</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>gap <span class="skolem">i</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lmin</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">LEAST</span> <span class="bound">t</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">t</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≡</span> gap <span class="skolem">i</span> <span class="var">?lmin</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> V_bclim<span class="main">:</span> <span class="quoted"><span class="quoted">"V_bclim <span class="skolem">i</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="keyword1">τ</span> <span class="skolem">i</span><span class="main">)</span><span class="main">(</span><span class="skolem">k</span><span class="main">:=</span>Some <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="keyword1">τ</span> <span class="skolem">i</span><span class="main">)</span><span class="main">(</span><span class="skolem">k</span><span class="main">:=</span>Some <span class="main">1</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> True V_bclim_def k_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gap_gr0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> k_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">0</span> <span class="main">↓=</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> tau_at_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ<span class="hidden">⇧</span><sup>τ</sup></span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ<span class="hidden">⇧</span><sup>τ</sup></span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> R1_imp_total1 V_subseteq_R1 i psitau_init <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ<span class="hidden">⇧</span><sup>τ</sup></span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="keyword1">τ</span> <span class="main">(</span>the <span class="main">(</span><span class="skolem">f</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> psitau_init <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ<span class="hidden">⇧</span><sup>τ</sup></span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="keyword1">τ</span> <span class="skolem">i</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">0</span> <span class="main">↓=</span> <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="keyword1">τ</span> <span class="skolem">i</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> False V_bclim i that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"V_bclim <span class="skolem">i</span> <span class="main">=</span> <span class="main">{</span><span class="keyword1">τ</span> <span class="skolem">i</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> V_bclim_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="keyword1">τ</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ<span class="hidden">⇧</span><sup>τ</sup></span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ<span class="hidden">⇧</span><sup>τ</sup></span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> R1_imp_total1 V_BCLIM_R1 psitau_init that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f psitau_init tau_at_0<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Finally, the main result of this section:›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> Lim_subset_BC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">LIM</span> <span class="main">⊂</span> BC"</span></span>
  <span class="keyword1"><span class="command">using</span></span> learn_bc_V_BCLIM BC_def Lim_subseteq_BC V_BCLIM_not_in_Lim <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="TOTAL_CONS">
<div class="head">
<h1>Theory TOTAL_CONS</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹TOTAL is a proper subset of CONS\label{s:total_cons}›</span></span>

<span class="keyword1"><span class="command">theory</span></span> TOTAL_CONS
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Lemma_R.html">Lemma_R</a>  <span class="comment1">(* for r_auxhyp *)</span>
    <a href="CP_FIN_NUM.html">CP_FIN_NUM</a>  <span class="comment1">(* for r_consistent *)</span>
    <a href="CONS_LIM.html">CONS_LIM</a>  <span class="comment1">(* for rmge2, goedel_at *)</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We first show that TOTAL is a subset of CONS. Then we present a
separating class.›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹TOTAL is a subset of CONS›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A TOTAL strategy hypothesizes only total functions, for which the
consistency with the input prefix is decidable. A CONS strategy can thus run
a TOTAL strategy and check if its hypothesis is consistent. If so, it
outputs this hypothesis, otherwise some arbitrary consistent one. Since the
TOTAL strategy converges to a correct hypothesis, which is consistent, the
CONS strategy will converge to the same hypothesis.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Without loss of generality we can assume that learning takes place
with respect to our Gödel numbering $\varphi$. So we need to decide
consistency only for this numbering.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">r_consist_phi</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">r_consist_phi</span> <span class="main">≡</span> r_consistent r_phi"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_consist_phi_recfn <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> r_consist_phi"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_consist_phi<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span>e_length <span class="free">e</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">k</span> <span class="main">↓</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval r_consist_phi <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span> <span class="main">↓=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span>e_length <span class="free">e</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">k</span> <span class="main">↓=</span> e_nth <span class="free">e</span> <span class="bound">k</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span>e_length <span class="free">e</span><span class="main">.</span> eval r_phi <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="bound">k</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms phi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> r_phi"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>r_consistent r_phi<span class="main">)</span> <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">e</span><span class="main">]</span> <span class="main">↓=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span>e_length <span class="free">e</span><span class="main">.</span> eval r_phi <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="bound">k</span><span class="main">]</span> <span class="main">↓=</span> e_nth <span class="free">e</span> <span class="bound">k</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_consistent_converg assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> phi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_consist_phi_init<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">i</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval r_consist_phi <span class="main">[</span><span class="free">i</span><span class="main">,</span> <span class="free">f</span> <span class="main">▹</span> <span class="free">n</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">≤</span><span class="free">n</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">k</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms r_consist_phi R1_imp_total1 total1E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_consist_phi<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> TOTAL_subseteq_CONS<span class="main">:</span> <span class="quoted"><span class="quoted">"TOTAL <span class="main">⊆</span> CONS"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">U</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">∈</span> TOTAL"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">∈</span> TOTAL_wrt <span class="keyword1">φ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> TOTAL_wrt_phi_eq_TOTAL <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"learn_total <span class="keyword1">φ</span> <span class="skolem">U</span> <span class="skolem">t'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> TOTAL_wrt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> eval <span class="skolem">t</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">t'</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> learn_totalE<span class="main">(</span>1<span class="main">)</span> P1E <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> t_converg<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="skolem">t</span> <span class="main">[</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">]</span> <span class="main">↓</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="skolem">U</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">using</span></span> t' learn_totalE<span class="main">(</span>1<span class="main">)</span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≡</span> Cn <span class="main">1</span> r_ifz <span class="main">[</span>Cn <span class="main">1</span> r_consist_phi <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span> <span class="skolem">t</span><span class="main">,</span> r_auxhyp<span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_consist_phi_recfn r_auxhyp_prim t<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> consist<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_consist_phi <span class="main">[</span>the <span class="main">(</span>eval <span class="skolem">t</span> <span class="main">[</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">]</span> <span class="main">↓=</span>
     <span class="main">(</span><span class="keyword1">if</span> <span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span>eval <span class="skolem">t</span> <span class="main">[</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="bound">k</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">k</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="skolem">U</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span> <span class="skolem">n</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_consist_phi <span class="main">[</span>the <span class="main">(</span>eval <span class="skolem">t</span> <span class="main">[</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">]</span> <span class="main">=</span>
        eval <span class="main">(</span>Cn <span class="main">1</span> r_consist_phi <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> Id <span class="main">1</span> <span class="main">0</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that t_converg t<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span>eval <span class="skolem">t</span> <span class="main">[</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="bound">k</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">k</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> learn_totalE<span class="main">(</span>1<span class="main">)</span> t' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span>eval <span class="skolem">t</span> <span class="main">[</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> t' t learn_totalE t_converg that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> r_consist_phi_init t_converg t<span class="main">(</span>1<span class="main">)</span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> s_eq_t<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="skolem">s</span> <span class="main">[</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">]</span> <span class="main">=</span> eval <span class="skolem">t</span> <span class="main">[</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">]</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span>eval <span class="skolem">t</span> <span class="main">[</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="bound">k</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="skolem">U</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">using</span></span> that consist s_def t r_auxhyp_prim prim_recfn_total
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> s_eq_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="skolem">s</span> <span class="main">[</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">]</span> <span class="main">=</span> eval r_auxhyp <span class="main">[</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">]</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span>eval <span class="skolem">t</span> <span class="main">[</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="bound">k</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="skolem">U</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span> <span class="skolem">n</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_consist_phi <span class="main">[</span>the <span class="main">(</span>eval <span class="skolem">t</span> <span class="main">[</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> consist <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">↓</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> t' learn_totalE<span class="main">(</span>1<span class="main">)</span> that<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> s_def t r_auxhyp_prim t' learn_totalE <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"learn_cons <span class="keyword1">φ</span> <span class="skolem">U</span> <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> eval <span class="skolem">s</span> <span class="main">[</span><span class="bound">e</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> learn_consI<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">s</span> <span class="main">[</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">]</span> <span class="main">↓</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="skolem">U</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span> <span class="skolem">n</span>
      <span class="keyword1"><span class="command">using</span></span> that t_converg<span class="main">[</span><span class="operator">OF</span> that<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> s_eq_t<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">f</span></span><span class="main">]</span> prim_recfn_total<span class="main">[</span><span class="operator">of</span> <span class="quoted">r_auxhyp</span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span>
        r_auxhyp_prim s_eq_aux<span class="main">[</span><span class="operator">OF</span> _ that<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> totalE
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"environment <span class="keyword1">φ</span> <span class="skolem">U</span> <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> eval <span class="skolem">s</span> <span class="main">[</span><span class="bound">e</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t' <span class="quoted"><span class="quoted">‹recfn <span class="main">1</span> <span class="skolem">s</span>›</span></span> learn_totalE<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> eval <span class="skolem">s</span> <span class="main">[</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">]</span> <span class="main">↓=</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="skolem">U</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> that t' t learn_totalE <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span>
        i_n0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> eval <span class="skolem">t</span> <span class="main">[</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">]</span> <span class="main">↓=</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≥</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">≤</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span>eval <span class="skolem">t</span> <span class="main">[</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="bound">k</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">k</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> s_eq_t <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≥</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟹</span> eval <span class="skolem">s</span> <span class="main">[</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">]</span> <span class="main">=</span> eval <span class="skolem">t</span> <span class="main">[</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> i_n0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≥</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟹</span> eval <span class="skolem">s</span> <span class="main">[</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">]</span> <span class="main">↓=</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> i_n0 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span>eval <span class="skolem">s</span> <span class="main">[</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="bound">k</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">k</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="skolem">U</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span>eval <span class="skolem">t</span> <span class="main">[</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="bound">k</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">k</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> that s_eq_t <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">s</span> <span class="main">[</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">]</span> <span class="main">=</span> eval r_auxhyp <span class="main">[</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> that s_eq_aux <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> learn_totalE<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> t'<span class="main">]</span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> r_auxhyp <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">∈</span> CONS"</span></span> <span class="keyword1"><span class="command">using</span></span> CONS_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The separating class›</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Definition of the class›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The class that will be shown to be in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"CONS <span class="main"><span class="main">-</span></span> TOTAL"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is
the union of the following two classes.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">V_constotal_1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial1 set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">V_constotal_1</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">f</span><span class="main">.</span> <span class="main">∃</span><span class="bound">j</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">f</span> <span class="main">=</span> <span class="main">[</span><span class="bound">j</span><span class="main">]</span> <span class="main">⊙</span> <span class="bound">p</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">≥</span> <span class="numeral">2</span> <span class="main">∧</span> <span class="bound">p</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="keyword1">φ</span> <span class="bound">j</span> <span class="main">=</span> <span class="bound">f</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">V_constotal_2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial1 set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">V_constotal_2</span> <span class="main">≡</span>
     <span class="main">{</span><span class="bound">f</span><span class="main">.</span> <span class="main">∃</span><span class="bound">j</span> <span class="bound">a</span> <span class="bound">k</span><span class="main">.</span>
            <span class="bound">f</span> <span class="main">=</span> <span class="bound">j</span> <span class="main">#</span> <span class="bound">a</span> <span class="main">@</span> <span class="main">[</span><span class="bound">k</span><span class="main">]</span> <span class="main">⊙</span> <span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">∧</span>
            <span class="bound">j</span> <span class="main">≥</span> <span class="numeral">2</span> <span class="main">∧</span>
            <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span>
            <span class="bound">k</span> <span class="main">≥</span> <span class="numeral">2</span> <span class="main">∧</span>
            <span class="keyword1">φ</span> <span class="bound">j</span> <span class="main">=</span> <span class="bound">j</span> <span class="main">#</span> <span class="bound">a</span> <span class="main">⊙</span> <span class="main">↑<span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">∧</span>
            <span class="keyword1">φ</span> <span class="bound">k</span> <span class="main">=</span> <span class="bound">f</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">V_constotal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial1 set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">V_constotal</span> <span class="main">≡</span> V_constotal_1 <span class="main">∪</span> V_constotal_2"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> V_constotal_2I<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">j</span> <span class="main">#</span> <span class="free">a</span> <span class="main">@</span> <span class="main">[</span><span class="free">k</span><span class="main">]</span> <span class="main">⊙</span> <span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free">a</span><span class="main">.</span> <span class="free">a</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">j</span> <span class="main">=</span> <span class="free">j</span> <span class="main">#</span> <span class="free">a</span> <span class="main">⊙</span> <span class="main">↑<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">k</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> V_constotal_2"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms V_constotal_2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> V_subseteq_R1<span class="main">:</span> <span class="quoted"><span class="quoted">"V_constotal <span class="main">⊆</span> <span class="keyword1">ℛ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> V_constotal"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> V_constotal_1 <span class="main">∨</span> <span class="skolem">f</span> <span class="main">∈</span> V_constotal_2"</span></span>
    <span class="keyword1"><span class="command">using</span></span> V_constotal_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> V_constotal_1"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">j</span><span class="main">]</span> <span class="main">⊙</span> <span class="skolem">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> V_constotal_1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> prepend_in_R1 RPred1_subseteq_R1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> V_constotal_2"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">#</span> <span class="skolem">a</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">k</span><span class="main">]</span> <span class="main">⊙</span> <span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> V_constotal_2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> almost0_in_R1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The class is in CONS›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The class can be learned by the strategy <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">rmge2</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, which
outputs the rightmost value greater or equal two in the input $f^n$. If $f$
is from $V_1$ then the strategy is correct right from the start. If $f$ is
from $V_2$ the strategy outputs the consistent hypothesis $j$ until it
encounters the correct hypothesis $k$, to which it converges.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> V_in_CONS<span class="main">:</span> <span class="quoted"><span class="quoted">"learn_cons <span class="keyword1">φ</span> V_constotal rmge2"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> learn_consI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"environment <span class="keyword1">φ</span> V_constotal rmge2"</span></span>
    <span class="keyword1"><span class="command">using</span></span> V_subseteq_R1 rmge2_in_R1 R1_imp_total1 phi_in_P2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> rmge2 <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">≤</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span>rmge2 <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">k</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> V_constotal"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> V_constotal_1"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">j</span><span class="main">]</span> <span class="main">⊙</span> <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      phi_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="skolem">j</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> V_constotal_1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">0</span> <span class="main">↓=</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prepend_at_less<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f_at_0<span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="skolem">f</span> <span class="main">0</span><span class="main">)</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> j<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> f_at_gr0<span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">using</span></span> that f p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> RPred1_altdef Suc_leI prepend_at_ge<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"total1 <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> V_subseteq_R1 that R1_imp_total1 total1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rmge2 <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> Suc <span class="skolem">n</span> <span class="main">∧</span> the <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Greatest <span class="var">?P</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Greatest_equality<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> Suc <span class="skolem">n</span> <span class="main">∧</span> <span class="numeral">2</span> <span class="main">≤</span> the <span class="main">(</span><span class="skolem">f</span> <span class="main">0</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> f_at_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> Suc <span class="skolem">n</span> <span class="main">∧</span> <span class="numeral">2</span> <span class="main">≤</span> the <span class="main">(</span><span class="skolem">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> f_at_gr0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rmge2 <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> f_at_0 rmge2_init_total<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹total1 <span class="skolem">f</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rmge2 <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">0</span> <span class="main">↓=</span> <span class="skolem">j</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> phi_j <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> V_constotal_2"</span></span>
      <span class="keyword1"><span class="command">using</span></span> V_constotal_def that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> jak<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">#</span> <span class="skolem">a</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">k</span><span class="main">]</span> <span class="main">⊙</span> <span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="skolem">a</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="skolem">j</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">#</span> <span class="skolem">a</span> <span class="main">⊙</span> <span class="main">↑<span class="hidden">⇧</span><sup>∞</sup></span> "</span></span>
      <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="skolem">k</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> V_constotal_2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f_at_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">0</span> <span class="main">↓=</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> f_eq_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">↓=</span> <span class="skolem">a</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">&lt;</span> Suc <span class="main">(</span>length <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">a</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> jak<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> less_SucI nth_append that<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f_at_a<span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">&lt;</span> Suc <span class="main">(</span>length <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">using</span></span> jak<span class="main">(</span>3<span class="main">)</span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> jak <span class="keyword1"><span class="command">have</span></span> f_k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">↓=</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> jak <span class="keyword1"><span class="command">have</span></span> f_at_big<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&gt;</span> Suc <span class="main">(</span>length <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> Suc <span class="bound">n</span> <span class="main">∧</span> the <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> rmge2<span class="main">:</span> <span class="quoted"><span class="quoted">"rmge2 <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">(</span>Greatest <span class="main">(</span><span class="var">?P</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>Suc <span class="skolem">n</span><span class="main">.</span> the <span class="main">(</span><span class="skolem">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">&lt;</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
        <span class="keyword1"><span class="command">using</span></span> jak<span class="main">(</span>2<span class="main">)</span> f_at_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"total1 <span class="skolem">f</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> V_subseteq_R1 R1_imp_total1 that total1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rmge2_init_total<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Greatest <span class="main">(</span><span class="var">?P</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> Suc <span class="main">(</span>length <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Greatest_equality<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> Suc <span class="skolem">n</span> <span class="main">∧</span> <span class="numeral">2</span> <span class="main">≤</span> the <span class="main">(</span><span class="skolem">f</span> <span class="main">0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> jak<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> f_at_0<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> Suc <span class="skolem">n</span> <span class="main">∧</span> <span class="numeral">2</span> <span class="main">≤</span> the <span class="main">(</span><span class="skolem">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> that f_at_a
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_1 dual_order.strict_trans leI less_Suc_eq not_less_eq_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> rmge2 f_at_0 <span class="keyword1"><span class="command">have</span></span> rmge2_small<span class="main">:</span>
      <span class="quoted"><span class="quoted">"rmge2 <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> Suc <span class="main">(</span>length <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Greatest <span class="main">(</span><span class="var">?P</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> Suc <span class="main">(</span>length <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Greatest_equality<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>length <span class="skolem">a</span><span class="main">)</span> <span class="main">&lt;</span> Suc <span class="skolem">n</span> <span class="main">∧</span> <span class="numeral">2</span> <span class="main">≤</span> the <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> that f_k <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> jak<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> less_Suc_eq_le<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&lt;</span> Suc <span class="skolem">n</span> <span class="main">∧</span> <span class="numeral">2</span> <span class="main">≤</span> the <span class="main">(</span><span class="skolem">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">≤</span> Suc <span class="main">(</span>length <span class="skolem">a</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> that f_at_big <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> leI le_SucI not_less_eq_eq numeral_2_eq_2 option.sel<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> rmge2 f_at_big f_k <span class="keyword1"><span class="command">have</span></span> rmge2_big<span class="main">:</span>
      <span class="quoted"><span class="quoted">"rmge2 <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> Suc <span class="main">(</span>length <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span> <span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="keyword1">φ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> rmge2 <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> jak<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">≤</span><span class="skolem">n</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span>rmge2 <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">k</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">k</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> Suc <span class="main">(</span>length <span class="skolem">a</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rmge2 <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rmge2_small <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span>rmge2 <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">φ</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> rmge2_small f_at_0 f_eq_a jak<span class="main">(</span>5<span class="main">)</span> prepend_at_less
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_less_trans le_zero_eq length_Cons not_le_imp_less nth_Cons_0 nth_Cons_pos<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rmge2_big jak <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> V_constotal <span class="main">⟹</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀<span class="hidden">⇧</span><sup>∞</sup></span><span class="bound">n</span><span class="main">.</span> rmge2 <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> V_constotal <span class="main">⟹</span> <span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">≤</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span>rmge2 <span class="main">(</span><span class="bound">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">k</span> <span class="main">=</span> <span class="bound">f</span> <span class="bound">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The class is not in TOTAL›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Recall that $V$ is the union of $V_1 = \{jp \mid j\geq2 \land p \in
\mathcal{R}_{01} \land \varphi_j = jp\}$ and $V_2 = \{jak0^\infty \mid j\geq 2 \land a
\in \{0, 1\}^* \land k\geq 2 \land \varphi_j = ja\uparrow^\infty \land\ 
\varphi_k = jak0^\infty\}$.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The proof is adapted from a proof of a stronger result by
Freivalds, Kinber, and Wiehagen~\cite[Theorem~27]{fkw-iisde-95} concerning an
inference type not defined here.

The proof is by contradiction. If $V$ was in TOTAL, there would be
a strategy $S$ learning $V$ in our standard Gödel numbering $\varphi$.
By Lemma R for TOTAL we can assume $S$ to be total.

In order to construct a function $f\in V$ for which $S$ fails we employ a
computable process iteratively building function prefixes. For every $j$ the
process builds a function $\psi_j$. The initial prefix is the singleton
$[j]$. Given a prefix $b$, the next prefix is determined as follows:
\begin{enumerate}
\item Search for a $y \geq |b|$ with $\varphi_{S(b)}(y) \downarrow= v$ for
some $v$.
\item Set the new prefix $b0^{y - |b|}\bar{v}$, where $\bar v = 1 - v$.
\end{enumerate}

Step~1 can diverge, for example, if $\varphi_{S(b)}$ is the empty function.
In this case $\psi_j$ will only be defined for a finite prefix. If, however,
Step~2 is reached, the prefix $b$ is extended to a $b'$ such that
$\varphi_{S(b)}(y) \neq b'_y$, which implies $S(b)$ is a wrong hypothesis for
every function starting with $b'$, in particular for $\psi_j$. Since $\bar v
\in \{0, 1\}$, Step~2 only appends zeros and ones, which is important for
showing membership in $V$.

This process defines a numbering $\psi \in \mathcal{P}^2$, and by Kleene's
fixed-point theorem there is a $j \geq 2$ with $\varphi_j = \psi_j$. For this
$j$ there are two cases:
\begin{enumerate}
\item[Case 1.] Step~1 always succeeds. Then $\psi_j$ is total and
  $\psi_j \in V_1$. But $S$ outputs wrong hypotheses on infinitely many
  prefixes of $\psi_j$ (namely every prefix constructed by the process).

\item[Case 2.] Step~1 diverges at some iteration, say when the state is $b = ja$
  for some $a \in \{0, 1\}^*$.
  Then $\psi_j$ has the form $ja\uparrow^\infty$. The numbering $\chi$ with $\chi_k =
  jak0^\infty$ is in $\mathcal{P}^2$, and by Kleene's fixed-point theorem there is a
  $k\geq 2$ with $\varphi_k = \chi_k = jak0^\infty$. This $jak0^\infty$ is in
  $V_2$ and has the prefix $ja$. But Step~1 diverged on this prefix, which
  means there is no $y \geq |ja|$ with $\varphi_{S(ja)}(y)\downarrow$. In
  other words $S$ hypothesizes a non-total function.
\end{enumerate}

Thus, in both cases there is a function in $V$ where $S$ does not behave like
a TOTAL strategy. This is the desired contradiction.

The following locale formalizes this proof sketch.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> total_cons <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span> <span class="main">::</span> <span class="quoted">partial1</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> s_in_R1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">r_s</span> <span class="main">::</span> <span class="quoted">recf</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">r_s</span> <span class="main">≡</span> <span class="keyword1">SOME</span> <span class="bound">r_s</span><span class="main">.</span> recfn <span class="main">1</span> <span class="bound">r_s</span> <span class="main">∧</span>  total <span class="bound">r_s</span> <span class="main">∧</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> eval <span class="bound">r_s</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rs_recfn <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> r_s"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> rs_total <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> eval r_s <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> eval_rs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">s</span> <span class="bound">x</span> <span class="main">=</span> eval r_s <span class="main">[</span><span class="bound">x</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> r_s_def R1_SOME<span class="main">[</span><span class="operator">OF</span> s_in_R1<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">r_s</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Performing Step~1 means enumerating the domain of
$\varphi_{S(b)}$ until a $y \geq |b|$ is found. The next function enumerates
all domain values and checks the condition for them.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_search_enum</span> <span class="main">≡</span>
  Cn <span class="numeral">2</span> r_le <span class="main">[</span>Cn <span class="numeral">2</span> r_length <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">,</span> Cn <span class="numeral">2</span> r_enumdom <span class="main">[</span>Cn <span class="numeral">2</span> r_s <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">0</span><span class="main">]</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_search_enum_recfn <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> r_search_enum"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_search_enum_def Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">search_enum</span> <span class="main">::</span> <span class="quoted">partial2</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">search_enum</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> eval r_search_enum <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">enumdom</span> <span class="main">::</span> <span class="quoted">partial2</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">enumdom</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> eval r_enumdom <span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> enumdom_empty_domain<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↑</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> enumdom <span class="free">i</span> <span class="bound">y</span> <span class="main">↑</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms r_enumdom_empty_domain <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> phi_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> enumdom_nonempty_domain<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">i</span> <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">↓</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> enumdom <span class="free">i</span> <span class="bound">y</span> <span class="main">↓</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↓</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> enumdom <span class="free">i</span> <span class="bound">y</span> <span class="main">↓=</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms r_enumdom_nonempty_domain phi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Enumerating the empty domain yields the empty function.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> search_enum_empty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">b</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">b</span> <span class="main">↓=</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↑</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> search_enum <span class="bound">x</span> <span class="free">b</span> <span class="main">↑</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms r_search_enum_def enumdom_empty_domain eval_rs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Enumerating a non-empty domain yields a total function.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> search_enum_nonempty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">b</span> <span class="free">y0</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">b</span> <span class="main">↓=</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">i</span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">↓</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">=</span> the <span class="main">(</span>enumdom <span class="free">i</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"search_enum <span class="free">x</span> <span class="free">b</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> e_length <span class="free">b</span> <span class="main">≤</span> <span class="free">e</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> the <span class="main">(</span>enumdom <span class="free">i</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="numeral">2</span> r_enumdom <span class="main">[</span>Cn <span class="numeral">2</span> r_s <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">0</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="var">?y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> eval <span class="var">?y</span> <span class="main">[</span><span class="bound">x</span><span class="main">,</span> <span class="free">b</span><span class="main">]</span> <span class="main">=</span> enumdom <span class="free">i</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> eval_rs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> eval <span class="var">?y</span> <span class="main">[</span><span class="bound">x</span><span class="main">,</span> <span class="free">b</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> enumdom_nonempty_domain<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Cn <span class="numeral">2</span> r_le <span class="main">[</span>Cn <span class="numeral">2</span> r_length <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">,</span> <span class="var">?y</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="free">x</span><span class="main">,</span> <span class="free">b</span><span class="main">]</span> <span class="main">↓=</span>
      <span class="main">(</span><span class="keyword1">if</span> e_length <span class="free">b</span> <span class="main">≤</span> <span class="var">?e</span> <span class="free">x</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_search_enum_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If there is a $y$ as desired, the enumeration will eventually return
zero (representing ``true'').›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> search_enum_nonempty_eq0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">b</span> <span class="free">y</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">b</span> <span class="main">↓=</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">i</span> <span class="free">y</span> <span class="main">↓</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≥</span> e_length <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> search_enum <span class="bound">x</span> <span class="free">b</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"enumdom <span class="free">i</span> <span class="skolem">x</span> <span class="main">↓=</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> enumdom_nonempty_domain<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">i</span> <span class="free">y</span> <span class="main">↓</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"search_enum <span class="skolem">x</span> <span class="free">b</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> search_enum_nonempty<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?e</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">y</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If there is no $y$ as desired, the enumeration will never return
zero.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> search_enum_nonempty_neq0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">b</span> <span class="free">y0</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">b</span> <span class="main">↓=</span> <span class="free">i</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">i</span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">↓</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">y</span> <span class="main">↓</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">≥</span> e_length <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> search_enum <span class="bound">x</span> <span class="free">b</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> search_enum <span class="bound">x</span> <span class="free">b</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"search_enum <span class="skolem">x</span> <span class="free">b</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"enumdom <span class="free">i</span> <span class="skolem">x</span> <span class="main">↓=</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> enumdom_nonempty_domain<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"search_enum <span class="skolem">x</span> <span class="free">b</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> e_length <span class="free">b</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1-2<span class="main">)</span> search_enum_nonempty <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_length <span class="free">b</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> option.inject <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">i</span> <span class="skolem">y</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> enumdom_nonempty_domain<span class="main">(</span>2<span class="main">)</span> y <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next function corresponds to Step~1. Given a prefix $b$ it
computes a $y \geq |b|$ with $\varphi_{S(b)}(y)\downarrow$ if such a $y$
exists; otherwise it diverges.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_search</span> <span class="main">≡</span> Cn <span class="main">1</span> r_enumdom <span class="main">[</span>r_s<span class="main">,</span> Mn <span class="main">1</span> r_search_enum<span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_search_recfn <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> r_search"</span></span>
  <span class="keyword1"><span class="command">using</span></span> r_search_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">search</span> <span class="main">::</span> <span class="quoted">partial1</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">search</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> eval r_search <span class="main">[</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If $\varphi_{S(b)}$ is the empty function, the search process
diverges because already the enumeration of the domain diverges.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> search_empty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">b</span> <span class="main">↓=</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↑</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"search <span class="free">b</span> <span class="main">↑</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> search_enum <span class="bound">x</span> <span class="free">b</span> <span class="main">↑</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> search_enum_empty<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Mn <span class="main">1</span> r_search_enum<span class="main">)</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">↑</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"search <span class="free">b</span> <span class="main">↑</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> r_search_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If $\varphi_{S(b)}$ is non-empty, but there is no $y$ with the
desired properties, the search process diverges.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> search_nonempty_neq0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">b</span> <span class="free">y0</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">b</span> <span class="main">↓=</span> <span class="free">i</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">i</span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">↓</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">y</span> <span class="main">↓</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">≥</span> e_length <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"search <span class="free">b</span> <span class="main">↑</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> search_enum <span class="bound">x</span> <span class="free">b</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms search_enum_nonempty_neq0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="main">(</span>Mn <span class="main">1</span> r_search_enum<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Mn <span class="main">1</span> r_search_enum<span class="main">)</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">↑</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> r_search_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If there is a $y$ as desired, the search process will return
one such $y$.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> search_nonempty_eq0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">b</span> <span class="free">y</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">b</span> <span class="main">↓=</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">i</span> <span class="free">y</span> <span class="main">↓</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≥</span> e_length <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"search <span class="free">b</span> <span class="main">↓</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">i</span> <span class="main">(</span>the <span class="main">(</span>search <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">↓</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>search <span class="free">b</span><span class="main">)</span> <span class="main">≥</span> e_length <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> search_enum <span class="bound">x</span> <span class="free">b</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms search_enum_nonempty_eq0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> search_enum <span class="bound">x</span> <span class="free">b</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms search_enum_nonempty <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="main">(</span>Mn <span class="main">1</span> r_search_enum<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
    1<span class="main">:</span> <span class="quoted"><span class="quoted">"search_enum <span class="main">(</span>the <span class="main">(</span>eval <span class="main">(</span>Mn <span class="main">1</span> r_search_enum<span class="main">)</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="free">b</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    2<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Mn <span class="main">1</span> r_search_enum<span class="main">)</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eval_Mn_diverg eval_Mn_convergE<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">1</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"r_search_enum"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[</span></span></span><span class="free"><span class="free"><span class="free">b</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span>"</span></span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> One_nat_def length_Cons list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> option.collapse<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> One_nat_def length_Cons list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>eval <span class="main">(</span>Mn <span class="main">1</span> r_search_enum<span class="main">)</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"search <span class="free">b</span> <span class="main">=</span> eval <span class="main">(</span>Cn <span class="main">1</span> r_enumdom <span class="main">[</span>r_s<span class="main">,</span> Mn <span class="main">1</span> r_search_enum<span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> r_search_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"search <span class="free">b</span> <span class="main">=</span> enumdom <span class="free">i</span> <span class="var">?x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms 2 eval_rs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>search <span class="free">b</span><span class="main">)</span> <span class="main">=</span> the <span class="main">(</span>enumdom <span class="free">i</span> <span class="var">?x</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"search_enum <span class="var">?x</span> <span class="free">b</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> e_length <span class="free">b</span> <span class="main">≤</span> <span class="var">?y</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> search_enum_nonempty assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> 3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">i</span> <span class="var">?y</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> enumdom_nonempty_domain assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.collapse<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">i</span> <span class="var">?y</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> phi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="main">≥</span> e_length <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms 4 1 option.inject <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"search <span class="free">b</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 3 assms<span class="main">(</span>2<span class="main">)</span> enumdom_nonempty_domain<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The converse of the previous lemma states that whenever
the search process returns a value it will be one with the
desired properties.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> search_converg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">b</span> <span class="main">↓=</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"search <span class="free">b</span> <span class="main">↓</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="main">↓</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">i</span> <span class="main">(</span>the <span class="var">?y</span><span class="main">)</span> <span class="main">↓</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"the <span class="var">?y</span> <span class="main">≥</span> e_length <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">y</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms search_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≥</span> e_length <span class="free">b</span> <span class="main">∧</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">y</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> search_nonempty_neq0 assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≥</span> e_length <span class="free">b</span> <span class="main">∧</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="skolem">y</span> <span class="main">↓</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">i</span> <span class="skolem">y</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> phi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">i</span> <span class="main">(</span>the <span class="main">(</span>search <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">↓</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>the <span class="main">(</span>search <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> e_length <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> y assms search_nonempty_eq0<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">‹<span class="keyword1"><span class="keyword1"><span class="keyword1">φ</span></span></span> <span class="free"><span class="free"><span class="free">i</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">y</span></span></span> <span class="main"><span class="main"><span class="main">↓</span></span></span>›</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Likewise, if the search diverges, there is no appropriate $y$.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> search_diverg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">b</span> <span class="main">↓=</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"search <span class="free">b</span> <span class="main">↑</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">y</span> <span class="main">↓</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">≥</span> e_length <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">y</span> <span class="main">↓</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">≥</span> e_length <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">i</span> <span class="skolem">y</span> <span class="main">↓</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≥</span> e_length <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> y<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">i</span> <span class="skolem">y</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> phi_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> y<span class="main">(</span>2<span class="main">)</span> search_nonempty_eq0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"search <span class="free">b</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Step~2 extends the prefix by a block of the shape $0^n\bar v$.
The next function constructs such a block for given $n$ and $v$.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_badblock</span> <span class="main">≡</span>
  <span class="keyword1">let</span> <span class="bound">f</span> <span class="main">=</span> Cn <span class="main">1</span> r_singleton_encode <span class="main">[</span>r_not<span class="main">]</span><span class="main">;</span>
      <span class="bound">g</span> <span class="main">=</span> Cn <span class="numeral">3</span> r_cons <span class="main">[</span>r_constn <span class="numeral">2</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span>
  <span class="keyword1">in</span> Pr <span class="main">1</span> <span class="bound">f</span> <span class="bound">g</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_badblock_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> r_badblock"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_badblock_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_badblock<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_badblock <span class="main">[</span><span class="free">n</span><span class="main">,</span> <span class="free">v</span><span class="main">]</span> <span class="main">↓=</span> list_encode <span class="main">(</span>replicate <span class="free">n</span> <span class="main">0</span> <span class="main">@</span> <span class="main">[</span><span class="main">1</span> <span class="main">-</span> <span class="free">v</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="main">1</span> r_singleton_encode <span class="main">[</span>r_not<span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_badblock <span class="main">[</span><span class="main">0</span><span class="main">,</span> <span class="free">v</span><span class="main">]</span> <span class="main">=</span> eval <span class="var">?f</span> <span class="main">[</span><span class="free">v</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> r_badblock_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> eval r_singleton_encode <span class="main">[</span>the <span class="main">(</span>eval r_not <span class="main">[</span><span class="free">v</span><span class="main">]</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">↓=</span> list_encode <span class="main">[</span><span class="main">1</span> <span class="main">-</span> <span class="free">v</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="numeral">3</span> r_cons <span class="main">[</span>r_constn <span class="numeral">2</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">3</span> <span class="var">?g</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_badblock <span class="main">[</span><span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">,</span> <span class="free">v</span><span class="main">]</span> <span class="main">=</span> eval <span class="var">?g</span> <span class="main">[</span><span class="skolem">n</span><span class="main">,</span> the <span class="main">(</span>eval r_badblock <span class="main">[</span><span class="skolem">n</span> <span class="main">,</span> <span class="free">v</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="free">v</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">3</span> <span class="var">?g</span>›</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_badblock_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> eval <span class="var">?g</span> <span class="main">[</span><span class="skolem">n</span><span class="main">,</span> list_encode <span class="main">(</span>replicate <span class="skolem">n</span> <span class="main">0</span> <span class="main">@</span> <span class="main">[</span><span class="main">1</span> <span class="main">-</span> <span class="free">v</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="free">v</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> eval r_cons <span class="main">[</span><span class="main">0</span><span class="main">,</span> list_encode <span class="main">(</span>replicate <span class="skolem">n</span> <span class="main">0</span> <span class="main">@</span> <span class="main">[</span><span class="main">1</span> <span class="main">-</span> <span class="free">v</span><span class="main">]</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">↓=</span> e_cons <span class="main">0</span> <span class="main">(</span>list_encode <span class="main">(</span>replicate <span class="skolem">n</span> <span class="main">0</span> <span class="main">@</span> <span class="main">[</span><span class="main">1</span> <span class="main">-</span> <span class="free">v</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">↓=</span> list_encode <span class="main">(</span><span class="main">0</span> <span class="main">#</span> <span class="main">(</span>replicate <span class="skolem">n</span> <span class="main">0</span> <span class="main">@</span> <span class="main">[</span><span class="main">1</span> <span class="main">-</span> <span class="free">v</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">↓=</span> list_encode <span class="main">(</span>replicate <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">0</span> <span class="main">@</span> <span class="main">[</span><span class="main">1</span> <span class="main">-</span> <span class="free">v</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_badblock_only_01<span class="main">:</span> <span class="quoted"><span class="quoted">"e_nth <span class="main">(</span>the <span class="main">(</span>eval r_badblock <span class="main">[</span><span class="free">n</span><span class="main">,</span> <span class="free">v</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> r_badblock <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> r_badblock_last<span class="main">:</span> <span class="quoted"><span class="quoted">"e_nth <span class="main">(</span>the <span class="main">(</span>eval r_badblock <span class="main">[</span><span class="free">n</span><span class="main">,</span> <span class="free">v</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> <span class="main">1</span> <span class="main">-</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> r_badblock <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following function computes the next prefix from the current
one. In other words, it performs Steps~1 and~2.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_next</span> <span class="main">≡</span>
  Cn <span class="main">1</span> r_append
   <span class="main">[</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">,</span>
    Cn <span class="main">1</span> r_badblock
     <span class="main">[</span>Cn <span class="main">1</span> r_sub <span class="main">[</span>r_search<span class="main">,</span> r_length<span class="main">]</span><span class="main">,</span>
      Cn <span class="main">1</span> r_phi <span class="main">[</span>r_s<span class="main">,</span> r_search<span class="main">]</span><span class="main">]</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_next_recfn <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> r_next"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_next_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The name <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">next</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is unavailable, so we go for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">nxt</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">nxt</span> <span class="main">::</span> <span class="quoted">partial1</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nxt</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> eval r_next <span class="main">[</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nxt_diverg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"search <span class="free">b</span> <span class="main">↑</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nxt <span class="free">b</span> <span class="main">↑</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_next_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nxt_converg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"search <span class="free">b</span> <span class="main">↓=</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nxt <span class="free">b</span> <span class="main">↓=</span>
     e_append <span class="free">b</span> <span class="main">(</span>list_encode <span class="main">(</span>replicate <span class="main">(</span><span class="free">y</span> <span class="main">-</span> e_length <span class="free">b</span><span class="main">)</span> <span class="main">0</span> <span class="main">@</span> <span class="main">[</span><span class="main">1</span> <span class="main">-</span> the <span class="main">(</span><span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="free">y</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_next_def <span class="keyword1"><span class="command">using</span></span> assms r_badblock search_converg phi_def eval_rs
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> nxt_search_diverg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nxt <span class="free">b</span> <span class="main">↑</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"search <span class="free">b</span> <span class="main">↑</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"search <span class="free">b</span> <span class="main">↓</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"search <span class="free">b</span> <span class="main">↓=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> nxt_converg assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If Step~1 finds a $y$, the hypothesis $S(b)$ is incorrect for
the new prefix.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nxt_wrong_hyp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nxt <span class="free">b</span> <span class="main">↓=</span> <span class="free">b'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">b</span> <span class="main">↓=</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">y</span></span><span class="main">&lt;</span>e_length <span class="free">b'</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">y</span> <span class="main">↓≠</span> e_nth <span class="free">b'</span> <span class="bound">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"search <span class="free">b</span> <span class="main">↓=</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms nxt_diverg <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> y_len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≥</span> e_length <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms search_converg<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> b'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b'</span> <span class="main">=</span>
      <span class="main">(</span>e_append <span class="free">b</span> <span class="main">(</span>list_encode <span class="main">(</span>replicate <span class="main">(</span><span class="skolem">y</span> <span class="main">-</span> e_length <span class="free">b</span><span class="main">)</span> <span class="main">0</span> <span class="main">@</span> <span class="main">[</span><span class="main">1</span> <span class="main">-</span> the <span class="main">(</span><span class="keyword1">φ</span> <span class="free">i</span> <span class="skolem">y</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> y assms nxt_converg <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_nth <span class="free">b'</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">1</span> <span class="main">-</span> the <span class="main">(</span><span class="keyword1">φ</span> <span class="free">i</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> y_len e_nth_append_big r_badblock r_badblock_last <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">i</span> <span class="skolem">y</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> search_converg y y_len assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">i</span> <span class="skolem">y</span> <span class="main">↓≠</span> e_nth <span class="free">b'</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> gr_zeroI less_numeral_extra<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> less_one option.sel zero_less_diff<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_length <span class="free">b'</span> <span class="main">=</span> Suc <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> y_len e_length_append b' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If Step~1 diverges, the hypothesis $S(b)$ refers to a non-total
function.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nxt_nontotal_hyp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nxt <span class="free">b</span> <span class="main">↑</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">b</span> <span class="main">↓=</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↑</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> nxt_search_diverg<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> search_diverg<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The process only ever extends the given prefix.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nxt_stable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nxt <span class="free">b</span> <span class="main">↓=</span> <span class="free">b'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span>e_length <span class="free">b</span><span class="main">.</span> e_nth <span class="free">b</span> <span class="bound">x</span> <span class="main">=</span> e_nth <span class="free">b'</span> <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"search <span class="free">b</span> <span class="main">↓=</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms nxt_diverg <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≥</span> e_length <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> search_converg<span class="main">(</span>2<span class="main">)</span> eval_rs rs_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> e_length <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="free">s</span> <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> b'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b'</span> <span class="main">=</span>
        <span class="main">(</span>e_append <span class="free">b</span> <span class="main">(</span>list_encode <span class="main">(</span>replicate <span class="main">(</span><span class="skolem">y</span> <span class="main">-</span> e_length <span class="free">b</span><span class="main">)</span> <span class="main">0</span> <span class="main">@</span> <span class="main">[</span><span class="main">1</span> <span class="main">-</span> the <span class="main">(</span><span class="keyword1">φ</span> <span class="var">?i</span> <span class="skolem">y</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms nxt_converg<span class="main">[</span><span class="operator">OF</span> y<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"e_nth <span class="free">b</span> <span class="skolem">x</span> <span class="main">=</span> e_nth <span class="free">b'</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> e_nth_append_small <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">&lt;</span> e_length <span class="free">b</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following properties of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">r_next</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> will be
used to show that some of the constructed functions are in the class
$V$.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nxt_append_01<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nxt <span class="free">b</span> <span class="main">↓=</span> <span class="free">b'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> e_length <span class="free">b</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">&lt;</span> e_length <span class="free">b'</span> <span class="main">⟶</span>  e_nth <span class="free">b'</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> e_nth <span class="free">b'</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"search <span class="free">b</span> <span class="main">↓=</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms nxt_diverg <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="free">s</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> b'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b'</span> <span class="main">=</span> <span class="main">(</span>e_append <span class="free">b</span> <span class="main">(</span>list_encode <span class="main">(</span>replicate <span class="main">(</span><span class="skolem">y</span> <span class="main">-</span> e_length <span class="free">b</span><span class="main">)</span> <span class="main">0</span> <span class="main">@</span> <span class="main">[</span><span class="main">1</span> <span class="main">-</span> the <span class="main">(</span><span class="keyword1">φ</span> <span class="var">?i</span> <span class="skolem">y</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="free">b'</span> <span class="main">=</span> <span class="main">(</span>e_append <span class="free">b</span> <span class="var">?z</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms y  nxt_converg prod_encode_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"e_length <span class="free">b</span> <span class="main">≤</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">&lt;</span> e_length <span class="free">b'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_nth <span class="free">b'</span> <span class="skolem">x</span> <span class="main">=</span> e_nth <span class="var">?z</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> e_length <span class="free">b</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> b' e_nth_append_big <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"e_nth <span class="free">b'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> e_nth <span class="free">b'</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_one nat_less_le option.sel r_badblock r_badblock_only_01<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nxt_monotone<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"nxt <span class="free">b</span> <span class="main">↓=</span> <span class="free">b'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"e_length <span class="free">b</span> <span class="main">&lt;</span> e_length <span class="free">b'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"search <span class="free">b</span> <span class="main">↓=</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms nxt_diverg <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="free">s</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> b'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b'</span> <span class="main">=</span>
      <span class="main">(</span>e_append <span class="free">b</span> <span class="main">(</span>list_encode <span class="main">(</span>replicate <span class="main">(</span><span class="skolem">y</span> <span class="main">-</span> e_length <span class="free">b</span><span class="main">)</span> <span class="main">0</span> <span class="main">@</span> <span class="main">[</span><span class="main">1</span> <span class="main">-</span> the <span class="main">(</span><span class="keyword1">φ</span> <span class="var">?i</span> <span class="skolem">y</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms y nxt_converg prod_encode_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> e_length_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next function computes the prefixes after each iteration of
the process <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">r_next</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> when started with the list $[j]$.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">r_prefixes</span> <span class="main">::</span> <span class="quoted">recf</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">r_prefixes</span> <span class="main">≡</span> Pr <span class="main">1</span> r_singleton_encode <span class="main">(</span>Cn <span class="numeral">3</span> r_next <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_prefixes_recfn <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> r_prefixes"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_prefixes_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">prefixes</span> <span class="main">::</span> <span class="quoted">partial2</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">prefixes</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≡</span> eval r_prefixes <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prefixes_at_0<span class="main">:</span> <span class="quoted"><span class="quoted">"prefixes <span class="main">0</span> <span class="free">j</span> <span class="main">↓=</span> list_encode <span class="main">[</span><span class="free">j</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_prefixes_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> prefixes_at_Suc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prefixes <span class="free">t</span> <span class="free">j</span> <span class="main">↓</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?b</span> <span class="main">↓</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"prefixes <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> nxt <span class="main">(</span>the <span class="var">?b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> r_prefixes_def assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> prefixes_at_Suc'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prefixes <span class="free">t</span> <span class="free">j</span> <span class="main">↓=</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"prefixes <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> nxt <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> r_prefixes_def assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> prefixes_prod_encode<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prefixes <span class="free">t</span> <span class="free">j</span> <span class="main">↓</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">b</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"prefixes <span class="free">t</span> <span class="free">j</span> <span class="main">↓=</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms surj_prod_encode <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> prefixes_converg_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prefixes <span class="free">t</span> <span class="free">j</span> <span class="main">↓</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">≤</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"prefixes <span class="free">t'</span> <span class="free">j</span> <span class="main">↓</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> r_prefixes_def assms eval_Pr_converg_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">j</span><span class="main">]</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> prefixes_diverg_add<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prefixes <span class="free">t</span> <span class="free">j</span> <span class="main">↑</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"prefixes <span class="main">(</span><span class="free">t</span> <span class="main">+</span> <span class="free">d</span><span class="main">)</span> <span class="free">j</span> <span class="main">↑</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> r_prefixes_def assms eval_Pr_diverg_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">j</span><span class="main">]</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Many properties of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">r_prefixes</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> can be derived from similar
properties of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">r_next</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prefixes_length<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prefixes <span class="free">t</span> <span class="free">j</span> <span class="main">↓=</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"e_length <span class="free">b</span> <span class="main">&gt;</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> prefixes_at_0 prod_encode_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefixes <span class="skolem">t</span> <span class="free">j</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prefixes_converg_le Suc_n_not_le_n nat_le_linear <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b'</span></span> <span class="keyword2"><span class="keyword">where</span></span> b'<span class="main">:</span> <span class="quoted"><span class="quoted">"prefixes <span class="skolem">t</span> <span class="free">j</span> <span class="main">↓=</span> <span class="skolem">b'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prefixes_prod_encode <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_length <span class="skolem">b'</span> <span class="main">&gt;</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefixes <span class="main">(</span>Suc <span class="skolem">t</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> nxt <span class="skolem">b'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> b' prefixes_at_Suc' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nxt <span class="skolem">b'</span> <span class="main">↓=</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_length <span class="skolem">b'</span> <span class="main">&lt;</span> e_length <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nxt_monotone <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹e_length <span class="skolem">b'</span> <span class="main">&gt;</span> <span class="skolem">t</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prefixes_monotone<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prefixes <span class="free">t</span> <span class="free">j</span> <span class="main">↓=</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"prefixes <span class="main">(</span><span class="free">t</span> <span class="main">+</span> <span class="free">d</span><span class="main">)</span> <span class="free">j</span> <span class="main">↓=</span> <span class="free">b'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"e_length <span class="free">b</span> <span class="main">≤</span> e_length <span class="free">b'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">induction</span> <span class="quoted"><span class="free">d</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">b'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> prod_encode_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">+</span> <span class="skolem">d</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">+</span> Suc <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefixes <span class="main">(</span><span class="free">t</span> <span class="main">+</span> <span class="skolem">d</span><span class="main">)</span> <span class="free">j</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prefixes_converg_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b''</span></span> <span class="keyword2"><span class="keyword">where</span></span> b''<span class="main">:</span> <span class="quoted"><span class="quoted">"prefixes <span class="main">(</span><span class="free">t</span> <span class="main">+</span> <span class="skolem">d</span><span class="main">)</span> <span class="free">j</span> <span class="main">↓=</span> <span class="skolem">b''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prefixes_prod_encode <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefixes <span class="main">(</span><span class="free">t</span> <span class="main">+</span> Suc <span class="skolem">d</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> nxt <span class="skolem">b''</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefixes_at_Suc'<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nxt <span class="skolem">b''</span> <span class="main">↓=</span> <span class="skolem">b'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> nxt_monotone Suc b'' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prefixes_stable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prefixes <span class="free">t</span> <span class="free">j</span> <span class="main">↓=</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"prefixes <span class="main">(</span><span class="free">t</span> <span class="main">+</span> <span class="free">d</span><span class="main">)</span> <span class="free">j</span> <span class="main">↓=</span> <span class="free">b'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span>e_length <span class="free">b</span><span class="main">.</span> e_nth <span class="free">b</span> <span class="bound">x</span> <span class="main">=</span> e_nth <span class="free">b'</span> <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">induction</span> <span class="quoted"><span class="free">d</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">b'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> prod_encode_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">+</span> <span class="skolem">d</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">+</span> Suc <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefixes <span class="main">(</span><span class="free">t</span> <span class="main">+</span> <span class="skolem">d</span><span class="main">)</span> <span class="free">j</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prefixes_converg_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b''</span></span> <span class="keyword2"><span class="keyword">where</span></span> b''<span class="main">:</span> <span class="quoted"><span class="quoted">"prefixes <span class="main">(</span><span class="free">t</span> <span class="main">+</span> <span class="skolem">d</span><span class="main">)</span> <span class="free">j</span> <span class="main">↓=</span> <span class="skolem">b''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prefixes_prod_encode <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefixes <span class="main">(</span><span class="free">t</span> <span class="main">+</span> Suc <span class="skolem">d</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> nxt <span class="skolem">b''</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefixes_at_Suc'<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword1"><span class="command">have</span></span> b'<span class="main">:</span> <span class="quoted"><span class="quoted">"nxt <span class="skolem">b''</span> <span class="main">↓=</span> <span class="skolem">b'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span>e_length <span class="free">b</span><span class="main">.</span> e_nth <span class="free">b</span> <span class="bound">x</span> <span class="main">=</span> e_nth <span class="skolem">b'</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> e_length <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_nth <span class="free">b</span> <span class="skolem">x</span> <span class="main">=</span> e_nth <span class="skolem">b''</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc b'' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> e_length <span class="skolem">b''</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x prefixes_monotone b'' Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"e_nth <span class="free">b</span> <span class="skolem">x</span> <span class="main">=</span> e_nth <span class="skolem">b'</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> b'' nxt_stable Suc b' prefixes_monotone x
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> leD le_neq_implies_less<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prefixes_tl_only_01<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prefixes <span class="free">t</span> <span class="free">j</span> <span class="main">↓=</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> e_nth <span class="free">b</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> e_nth <span class="free">b</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> prefixes_at_0 prod_encode_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefixes <span class="skolem">t</span> <span class="free">j</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prefixes_converg_le Suc_n_not_le_n nat_le_linear <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b'</span></span> <span class="keyword2"><span class="keyword">where</span></span> b'<span class="main">:</span> <span class="quoted"><span class="quoted">"prefixes <span class="skolem">t</span> <span class="free">j</span> <span class="main">↓=</span> <span class="skolem">b'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prefixes_prod_encode <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> e_nth <span class="skolem">b</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> e_nth <span class="skolem">b</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"e_nth <span class="skolem">b</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> e_nth <span class="skolem">b</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> e_length <span class="skolem">b'</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> Suc b' prefixes_at_Suc' nxt_stable x <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> Suc.prems b' prefixes_at_Suc' nxt_append_01 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prefixes_hd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prefixes <span class="free">t</span> <span class="free">j</span> <span class="main">↓=</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"e_nth <span class="free">b</span> <span class="main">0</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b'</span></span> <span class="keyword2"><span class="keyword">where</span></span> b'<span class="main">:</span> <span class="quoted"><span class="quoted">"prefixes <span class="main">0</span> <span class="free">j</span> <span class="main">↓=</span> <span class="skolem">b'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefixes_at_0<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="main">=</span> list_encode <span class="main">[</span><span class="free">j</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_encode_eq prefixes_at_0<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_nth <span class="skolem">b'</span> <span class="main">0</span> <span class="main">=</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"e_nth <span class="free">b</span> <span class="main">0</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms prefixes_stable<span class="main">[</span><span class="operator">OF</span> b'<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span> prefixes_length<span class="main">[</span><span class="operator">OF</span> b'<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prefixes_nontotal_hyp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prefixes <span class="free">t</span> <span class="free">j</span> <span class="main">↓=</span> <span class="free">b</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"prefixes <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span> <span class="free">j</span> <span class="main">↑</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="free">b</span> <span class="main">↓=</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">i</span> <span class="bound">x</span> <span class="main">↑</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> nxt_nontotal_hyp<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span> prefixes_at_Suc'<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now consider the two cases from the proof sketch.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">case_two</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">t</span><span class="main">.</span> prefixes <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">↑</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">case_one</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≡</span> <span class="main">¬</span> case_two <span class="free"><span class="bound"><span class="entity">j</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In Case~2 there is a maximum convergent iteration because
iteration 0 converges.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> case_two<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"case_two <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="bound">t</span><span class="main">.</span> prefixes <span class="bound">t'</span> <span class="free">j</span> <span class="main">↓</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&gt;</span><span class="bound">t</span><span class="main">.</span> prefixes <span class="bound">t'</span> <span class="free">j</span> <span class="main">↑</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> prefixes <span class="bound">t</span> <span class="free">j</span> <span class="main">↑</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> Least <span class="var">?P</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms LeastI_ex<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> diverg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≥</span> <span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
    <span class="keyword1"><span class="command">using</span></span> prefixes_converg_le that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> t<span class="hidden">⇩</span><sub>0</sub>_def <span class="keyword1"><span class="command">have</span></span> converg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?P</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">&lt;</span> <span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
    <span class="keyword1"><span class="command">using</span></span> Least_le<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">]</span> that not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span>›</span></span> prefixes_at_0 <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="var">?t</span><span class="main">.</span> prefixes <span class="bound">t'</span> <span class="free">j</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> converg <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&gt;</span><span class="var">?t</span><span class="main">.</span> prefixes <span class="bound">t'</span> <span class="free">j</span> <span class="main">↑</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> diverg <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Having completed the modelling of the process, we can now define
the functions $\psi_j$ it computes. The value $\psi_j(x)$ is computed by
running <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">r_prefixes</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> until the prefix is longer than $x$ and then
taking the $x$-th element of the prefix.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_psi</span> <span class="main">≡</span>
  <span class="keyword1">let</span> <span class="bound">f</span> <span class="main">=</span> Cn <span class="numeral">3</span> r_less <span class="main">[</span>Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">,</span> Cn <span class="numeral">3</span> r_length <span class="main">[</span>Cn <span class="numeral">3</span> r_prefixes <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">]</span>
  <span class="keyword1">in</span> Cn <span class="numeral">2</span> r_nth <span class="main">[</span>Cn <span class="numeral">2</span> r_prefixes <span class="main">[</span>Mn <span class="numeral">2</span> <span class="bound">f</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_psi_recfn<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> r_psi"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_psi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">psi</span> <span class="main">::</span> <span class="quoted">partial2</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ψ</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ψ</span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> eval r_psi <span class="main">[</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> psi_in_P2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="main">∈</span> <span class="keyword1">𝒫<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> r_psi_recfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The values of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">ψ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> can be read off the prefixes.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> psi_eq_nth_prefix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prefixes <span class="free">t</span> <span class="free">j</span> <span class="main">↓=</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"e_length <span class="free">b</span> <span class="main">&gt;</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="free">j</span> <span class="free">x</span> <span class="main">↓=</span> e_nth <span class="free">b</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="numeral">3</span> r_less <span class="main">[</span>Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">,</span> Cn <span class="numeral">3</span> r_length <span class="main">[</span>Cn <span class="numeral">3</span> r_prefixes <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> prefixes <span class="bound">t</span> <span class="free">j</span> <span class="main">↓</span> <span class="main">∧</span> e_length <span class="main">(</span>the <span class="main">(</span>prefixes <span class="bound">t</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> ex_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> Least <span class="var">?P</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> LeastI_ex<span class="main">[</span><span class="operator">OF</span> ex_t<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> ex_t <span class="keyword1"><span class="command">have</span></span> not_P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?P</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">&lt;</span> <span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
    <span class="keyword1"><span class="command">using</span></span> ex_t that Least_le<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span><span class="main">]</span> not_le t<span class="hidden">⇩</span><sub>0</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> not_P <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> leI <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> b0<span class="main">:</span> <span class="quoted"><span class="quoted">"prefixes <span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">j</span> <span class="main">↓=</span> <span class="skolem">b<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> prefixes_converg_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?f</span> <span class="main">[</span><span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Cn <span class="numeral">3</span> r_prefixes <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="skolem">b<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> b0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?f</span> <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">&lt;</span> <span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">bt</span></span> <span class="keyword2"><span class="keyword">where</span></span> bt<span class="main">:</span> <span class="quoted"><span class="quoted">"prefixes <span class="skolem">t</span> <span class="free">j</span> <span class="main">↓=</span> <span class="skolem">bt</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prefixes_converg_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> b0 <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">&lt;</span> <span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?P</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that not_P <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_length <span class="skolem">bt</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Cn <span class="numeral">3</span> r_prefixes <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="skolem">bt</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> bt <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Mn <span class="numeral">2</span> <span class="var">?f</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eval_Mn_convergI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="free">j</span> <span class="free">x</span> <span class="main">↓=</span> e_nth <span class="skolem">b<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> r_psi_def <span class="keyword1"><span class="command">using</span></span> b0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> <span class="free">t</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> prefixes_stable<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="skolem">b<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">-</span> <span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span> b0 <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">t<span class="hidden">⇩</span><sub>0</sub></span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> psi_converg_imp_prefix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="free">j</span> <span class="free">x</span> <span class="main">↓</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span> <span class="bound">b</span><span class="main">.</span> prefixes <span class="bound">t</span> <span class="free">j</span> <span class="main">↓=</span> <span class="bound">b</span> <span class="main">∧</span> e_length <span class="bound">b</span> <span class="main">&gt;</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="numeral">3</span> r_less <span class="main">[</span>Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">,</span> Cn <span class="numeral">3</span> r_length <span class="main">[</span>Cn <span class="numeral">3</span> r_prefixes <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">0</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Mn <span class="numeral">2</span> <span class="var">?f</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> eval <span class="main">(</span>Mn <span class="numeral">2</span> <span class="var">?f</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Mn <span class="numeral">2</span> <span class="var">?f</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↑</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="free">j</span> <span class="free">x</span> <span class="main">↑</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> r_psi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Mn <span class="numeral">2</span> <span class="var">?f</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="main">(</span>Mn <span class="numeral">2</span> <span class="var">?f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="var">?f</span> <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eval_Mn_convergE<span class="main">[</span><span class="operator">OF</span> _ t<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> One_nat_def Suc_1 length_Cons list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefixes <span class="skolem">t</span> <span class="free">j</span> <span class="main">↓</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> prefixes <span class="skolem">t</span> <span class="free">j</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefixes <span class="skolem">t</span> <span class="free">j</span> <span class="main">↑</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?f</span> <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↑</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> f_zero <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b'</span></span> <span class="keyword2"><span class="keyword">where</span></span> b'<span class="main">:</span> <span class="quoted"><span class="quoted">"prefixes <span class="skolem">t</span> <span class="free">j</span> <span class="main">↓=</span> <span class="skolem">b'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_length <span class="skolem">b'</span> <span class="main">&gt;</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> e_length <span class="skolem">b'</span> <span class="main">&gt;</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?f</span> <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">x</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> b' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> f_zero <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> psi_converg_imp_prefix'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="free">j</span> <span class="free">x</span> <span class="main">↓</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span> <span class="bound">b</span><span class="main">.</span> prefixes <span class="bound">t</span> <span class="free">j</span> <span class="main">↓=</span> <span class="bound">b</span> <span class="main">∧</span> e_length <span class="bound">b</span> <span class="main">&gt;</span> <span class="free">x</span> <span class="main">∧</span> <span class="keyword1">ψ</span> <span class="free">j</span> <span class="free">x</span> <span class="main">↓=</span> e_nth <span class="bound">b</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> psi_converg_imp_prefix<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> psi_eq_nth_prefix <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In both Case~1 and~2, $\psi_j$ starts with $j$.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> psi_at_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="free">j</span> <span class="main">0</span> <span class="main">↓=</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> prefixes_hd prefixes_length psi_eq_nth_prefix prefixes_at_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In Case~1, $\psi_j$ is total and made up of $j$ followed by zeros
and ones, just as required by the definition of $V_1$.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> case_one_psi_total<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"case_one <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="free">j</span> <span class="free">x</span> <span class="main">↓=</span> <span class="main">0</span> <span class="main">∨</span> <span class="keyword1">ψ</span> <span class="free">j</span> <span class="free">x</span> <span class="main">↓=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"prefixes <span class="free">x</span> <span class="free">j</span> <span class="main">↓=</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_length <span class="skolem">b</span> <span class="main">&gt;</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prefixes_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="free">j</span> <span class="free">x</span> <span class="main">↓=</span> e_nth <span class="skolem">b</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> b psi_eq_nth_prefix <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_nth <span class="skolem">b</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> e_nth <span class="skolem">b</span> <span class="free">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prefixes_tl_only_01<span class="main">[</span><span class="operator">OF</span> b<span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="free">j</span> <span class="free">x</span> <span class="main">↓=</span> <span class="main">0</span> <span class="main">∨</span> <span class="keyword1">ψ</span> <span class="free">j</span> <span class="free">x</span> <span class="main">↓=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In Case~2, $\psi_j$ is defined only for a prefix starting with
$j$ and continuing with zeros and ones. This prefix corresponds to $ja$ from
the definition of $V_2$.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> case_two_psi_only_prefix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"case_two <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="keyword1">ψ</span> <span class="free">j</span> <span class="bound">x</span> <span class="main">↓=</span> <span class="main">0</span> <span class="main">∨</span> <span class="keyword1">ψ</span> <span class="free">j</span> <span class="bound">x</span> <span class="main">↓=</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span>
                <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">x</span></span> <span class="main">≥</span> <span class="bound">y</span><span class="main">.</span> <span class="keyword1">ψ</span> <span class="free">j</span> <span class="bound">x</span> <span class="main">↑</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    t_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="skolem">t</span><span class="main">.</span> prefixes <span class="bound">t'</span> <span class="free">j</span> <span class="main">↓</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    t_gr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&gt;</span><span class="skolem">t</span><span class="main">.</span> prefixes <span class="bound">t'</span> <span class="free">j</span> <span class="main">↑</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms case_two <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"prefixes <span class="skolem">t</span> <span class="free">j</span> <span class="main">↓=</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"e_length <span class="skolem">b</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="free">j</span> <span class="skolem">x</span> <span class="main">↓=</span> <span class="main">0</span> <span class="main">∨</span> <span class="keyword1">ψ</span> <span class="free">j</span> <span class="skolem">x</span> <span class="main">↓=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="var">?y</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> t_le b that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prefixes_tl_only_01 psi_eq_nth_prefix<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="free">j</span> <span class="skolem">x</span> <span class="main">↑</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> <span class="var">?y</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="free">j</span> <span class="skolem">x</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="skolem"><span class="skolem">b'</span></span> <span class="keyword2"><span class="keyword">where</span></span> t'<span class="main">:</span> <span class="quoted"><span class="quoted">"prefixes <span class="skolem">t'</span> <span class="free">j</span> <span class="main">↓=</span> <span class="skolem">b'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"e_length <span class="skolem">b'</span> <span class="main">&gt;</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> psi_converg_imp_prefix <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_length <span class="skolem">b'</span> <span class="main">&gt;</span> <span class="var">?y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> t' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">&gt;</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prefixes_monotone b <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_diff_inverse_nat leD<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> t' t_gr <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">longest_prefix</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">longest_prefix</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≡</span> <span class="keyword1">THE</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span><span class="bound">y</span><span class="main">.</span> <span class="keyword1">ψ</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="bound">x</span> <span class="main">↓</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">≥</span><span class="bound">y</span><span class="main">.</span> <span class="keyword1">ψ</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="bound">x</span> <span class="main">↑</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> longest_prefix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"case_two <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">=</span> longest_prefix <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span><span class="free">z</span><span class="main">.</span> <span class="keyword1">ψ</span> <span class="free">j</span> <span class="bound">x</span> <span class="main">↓</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">≥</span><span class="free">z</span><span class="main">.</span> <span class="keyword1">ψ</span> <span class="free">j</span> <span class="bound">x</span> <span class="main">↑</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span><span class="bound">z</span><span class="main">.</span> <span class="keyword1">ψ</span> <span class="free">j</span> <span class="bound">x</span> <span class="main">↓</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">≥</span><span class="bound">z</span><span class="main">.</span> <span class="keyword1">ψ</span> <span class="free">j</span> <span class="bound">x</span> <span class="main">↑</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">y</span> <span class="main">⟶</span> <span class="keyword1">ψ</span> <span class="free">j</span> <span class="bound">x</span> <span class="main">↓=</span> <span class="main">0</span> <span class="main">∨</span> <span class="keyword1">ψ</span> <span class="free">j</span> <span class="bound">x</span> <span class="main">↓=</span> <span class="main">1</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">≥</span><span class="skolem">y</span><span class="main">.</span> <span class="keyword1">ψ</span> <span class="free">j</span> <span class="bound">x</span> <span class="main">↑</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> case_two_psi_only_prefix<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">z</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> theI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?P</span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">y</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span><span class="skolem">y</span><span class="main">.</span> <span class="keyword1">ψ</span> <span class="free">j</span> <span class="bound">x</span> <span class="main">↓</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="free">j</span> <span class="skolem">x</span> <span class="main">↓</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> psi_at_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> y<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">≥</span><span class="skolem">y</span><span class="main">.</span> <span class="keyword1">ψ</span> <span class="free">j</span> <span class="bound">x</span> <span class="main">↑</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> y<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">z</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">z</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">&lt;</span> <span class="skolem">y</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> that <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> that <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">y</span>›</span></span> y<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> linorder_cases order_refl<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">&lt;</span><span class="main">(</span><span class="keyword1">THE</span> <span class="bound">z</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">z</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">ψ</span> <span class="free">j</span> <span class="bound">x</span> <span class="main">↓</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">x</span></span><span class="main">≥</span><span class="main">(</span><span class="keyword1">THE</span> <span class="bound">z</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">z</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">ψ</span> <span class="free">j</span> <span class="bound">x</span> <span class="main">↑</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"longest_prefix <span class="free">j</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">z</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> longest_prefix_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> case_two_psi_longest_prefix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"case_two <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> longest_prefix <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">y</span> <span class="main">⟶</span> <span class="keyword1">ψ</span> <span class="free">j</span> <span class="bound">x</span> <span class="main">↓=</span> <span class="main">0</span> <span class="main">∨</span> <span class="keyword1">ψ</span> <span class="free">j</span> <span class="bound">x</span> <span class="main">↓=</span> <span class="main">1</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">x</span></span> <span class="main">≥</span> <span class="free">y</span><span class="main">.</span> <span class="keyword1">ψ</span> <span class="free">j</span> <span class="bound">x</span> <span class="main">↑</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms longest_prefix case_two_psi_only_prefix
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prefixes_tl_only_01 psi_converg_imp_prefix'<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The prefix cannot be empty because the process starts with prefix $[j]$.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> longest_prefix_gr_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"case_two <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"longest_prefix <span class="free">j</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms case_two_psi_longest_prefix psi_at_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> psi_not_divergent_init<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prefixes <span class="free">t</span> <span class="free">j</span> <span class="main">↓=</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">ψ</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="main">(</span>e_length <span class="free">b</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> initI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> e_length <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms prefixes_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="free">j</span> <span class="skolem">x</span> <span class="main">↓=</span> e_nth <span class="free">b</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> e_length <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">using</span></span> that assms psi_eq_nth_prefix <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In Case~2, the strategy $S$ outputs a non-total hypothesis on
some prefix of $\psi_j$.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> case_two_nontotal_hyp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"case_two <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span>longest_prefix <span class="free">j</span><span class="main">.</span> <span class="main">¬</span> total1 <span class="main">(</span><span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">ψ</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">≤</span><span class="skolem">t</span><span class="main">.</span> prefixes <span class="bound">t'</span> <span class="free">j</span> <span class="main">↓</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t_gr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t'</span></span><span class="main">&gt;</span><span class="skolem">t</span><span class="main">.</span> prefixes <span class="bound">t'</span> <span class="free">j</span> <span class="main">↑</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms case_two <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"prefixes <span class="skolem">t</span> <span class="free">j</span> <span class="main">↓=</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="skolem">b</span> <span class="main">↓=</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eval_rs <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> div<span class="main">:</span> <span class="quoted"><span class="quoted">"prefixes <span class="main">(</span>Suc <span class="skolem">t</span><span class="main">)</span> <span class="free">j</span> <span class="main">↑</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> t_gr <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="skolem">i</span> <span class="bound">x</span> <span class="main">↑</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prefixes_nontotal_hyp <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="main">↑</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> init<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="free">j</span> <span class="main">▹</span> <span class="main">(</span>e_length <span class="skolem">b</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">▹</span> <span class="var">?n</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> psi_not_divergent_init<span class="main">[</span><span class="operator">OF</span> b<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span><span class="keyword1">ψ</span> <span class="free">j</span> <span class="main">▹</span> <span class="var">?n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">↑</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> total1 <span class="main">(</span><span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span><span class="keyword1">ψ</span> <span class="free">j</span> <span class="main">▹</span> <span class="var">?n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">&lt;</span> longest_prefix <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> case_two_psi_longest_prefix init b div psi_eq_nth_prefix
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_init lessI not_le_imp_less option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Consequently, in Case~2 the strategy does not TOTAL-learn
any function starting with the longest prefix of $\psi_j$.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> case_two_not_learn<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"case_two <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> longest_prefix <span class="free">j</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="keyword1">ψ</span> <span class="free">j</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> learn_total <span class="keyword1">φ</span> <span class="main">{</span><span class="free">f</span><span class="main">}</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> longest_prefix <span class="free">j</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span> total1 <span class="main">(</span><span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span><span class="keyword1">ψ</span> <span class="free">j</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> case_two_nontotal_hyp<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">▹</span> <span class="skolem">n</span> <span class="main">=</span> <span class="keyword1">ψ</span> <span class="free">j</span> <span class="main">▹</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> n<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> init_eqI<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> n<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> R1_imp_total1 learn_totalE<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> singletonI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In Case~1 the strategy outputs a wrong hypothesis
on infinitely many prefixes of $\psi_j$ and thus does not
learn $\psi_j$ in the limit, much less in the sense of TOTAL.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> case_one_wrong_hyp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"case_one <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&gt;</span><span class="free">k</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">ψ</span> <span class="free">j</span><span class="main">)</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="keyword1">ψ</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> all_t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> prefixes <span class="bound">t</span> <span class="free">j</span> <span class="main">↓</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"prefixes <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="free">j</span> <span class="main">↓=</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> length<span class="main">:</span> <span class="quoted"><span class="quoted">"e_length <span class="skolem">b</span> <span class="main">&gt;</span> Suc <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prefixes_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> init<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="free">j</span> <span class="main">▹</span> <span class="main">(</span>e_length <span class="skolem">b</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> psi_not_divergent_init b <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="skolem">b</span> <span class="main">↓=</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eval_rs <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> all_t <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b'</span></span> <span class="keyword2"><span class="keyword">where</span></span> b'<span class="main">:</span> <span class="quoted"><span class="quoted">"prefixes <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="free">j</span> <span class="main">↓=</span> <span class="skolem">b'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="free">j</span> <span class="main">▹</span> <span class="main">(</span>e_length <span class="skolem">b'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">b'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> psi_not_divergent_init <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">y</span></span><span class="main">&lt;</span>e_length <span class="skolem">b'</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="skolem">i</span> <span class="bound">y</span> <span class="main">↓≠</span> e_nth <span class="skolem">b'</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nxt_wrong_hyp b b' i prefixes_at_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">y</span></span><span class="main">&lt;</span>e_length <span class="skolem">b'</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="skolem">i</span> <span class="bound">y</span> <span class="main">≠</span> <span class="keyword1">ψ</span> <span class="free">j</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> b' psi_eq_nth_prefix <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="skolem">i</span> <span class="main">≠</span> <span class="keyword1">ψ</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> init length i <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_less_eq length_init option.sel<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> case_one_not_learn<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"case_one <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> learn_lim <span class="keyword1">φ</span> <span class="main">{</span><span class="keyword1">ψ</span> <span class="free">j</span><span class="main">}</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> infinite_hyp_wrong_not_Lim<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">ψ</span></span> <span class="free"><span class="free">j</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="free">j</span> <span class="main">∈</span> <span class="main">{</span><span class="keyword1">ψ</span> <span class="free">j</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">m</span></span><span class="main">&gt;</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span><span class="keyword1">ψ</span> <span class="free">j</span> <span class="main">▹</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="keyword1">ψ</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> case_one_wrong_hyp<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> case_one_not_learn_V<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"case_one <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">j</span> <span class="main">=</span> <span class="keyword1">ψ</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> learn_lim <span class="keyword1">φ</span> V_constotal <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="free">j</span> <span class="main">∈</span> V_constotal_1"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">ψ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> p_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="keyword1">𝒫</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> skip_P1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> psi_in_P2 P2_proj_P1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="skolem">x</span> <span class="main">↓=</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">p</span> <span class="skolem">x</span> <span class="main">↓=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
        <span class="keyword1"><span class="command">using</span></span> p_def assms<span class="main">(</span>1<span class="main">)</span> case_one_psi_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"total1 <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> RPred1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="free">j</span> <span class="main">=</span> <span class="main">[</span><span class="free">j</span><span class="main">]</span> <span class="main">⊙</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> prepend_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> psi_at_0<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> V_constotal_1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="free">j</span> <span class="main">∈</span> V_constotal"</span></span> <span class="keyword1"><span class="command">using</span></span> V_constotal_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> learn_lim <span class="keyword1">φ</span> <span class="main">{</span><span class="keyword1">ψ</span> <span class="free">j</span><span class="main">}</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> case_one_not_learn assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> learn_lim_closed_subseteq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next lemma embodies the construction of $\chi$ followed by
the application of Kleene's fixed-point theorem as described in the
proof sketch.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> goedel_after_prefixes<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">vs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="free">m</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">vs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">n</span><span class="main">]</span> <span class="main">⊙</span> <span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="main">::</span> <span class="quoted">partial1</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">≡</span> <span class="free">vs</span> <span class="main">⊙</span> <span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> almost0_in_R1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="free">m</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> length <span class="free">vs</span> <span class="keyword1">then</span> Some <span class="skolem">n</span> <span class="keyword1">else</span> <span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> goedel_at<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="quoted">"length <span class="free">vs</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="skolem">n</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">vs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">n</span><span class="main">]</span> <span class="main">⊙</span> <span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">consider</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> length <span class="free">vs</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> length <span class="free">vs</span>"</span></span> <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&gt;</span> length <span class="free">vs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> n f_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prepend_associative<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If Case~2 holds for a $j\geq 2$ with $\varphi_j = \psi_j$, that
is, if $\psi_j\in V_1$, then there is a function in $V$, namely $\psi_j$, on
which $S$ fails. Therefore $S$ does not learn $V$.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> case_two_not_learn_V<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"case_two <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">j</span> <span class="main">=</span> <span class="keyword1">ψ</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> learn_total <span class="keyword1">φ</span> V_constotal <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> longest_prefix <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> longest_prefix_gr_0<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">vs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> prefix <span class="main">(</span><span class="keyword1">ψ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">!</span> <span class="main">0</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> psi_at_0 <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> tl <span class="skolem">vs</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> vs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> <span class="free">j</span> <span class="main">#</span> <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> vs_def <span class="quoted"><span class="quoted">‹<span class="skolem">vs</span> <span class="main">!</span> <span class="main">0</span> <span class="main">=</span> <span class="free">j</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_Suc_conv length_prefix list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> nth_Cons_0<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> phi_k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">j</span> <span class="main">#</span> <span class="skolem">a</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">k</span><span class="main">]</span> <span class="main">⊙</span> <span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> goedel_after_prefixes<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">#</span> <span class="skolem">a</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> phi_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="free">j</span> <span class="main">=</span> <span class="free">j</span> <span class="main">#</span> <span class="skolem">a</span> <span class="main">⊙</span> <span class="main">↑<span class="hidden">⇧</span><sup>∞</sup></span> "</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> prepend_eqI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">j</span> <span class="main">#</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">⟹</span> <span class="keyword1">φ</span> <span class="free">j</span> <span class="bound">x</span> <span class="main">↓=</span> <span class="main">(</span><span class="free">j</span> <span class="main">#</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">!</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> vs vs_def <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">z</span>›</span></span>
        length_prefix<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span>
        prefix_nth<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="free">j</span>"</span></span><span class="main">]</span>
        psi_at_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">j</span></span><span class="main">]</span>
        case_two_psi_longest_prefix<span class="main">[</span><span class="operator">OF</span> _ z_def<span class="main">]</span>
        longest_prefix<span class="main">[</span><span class="operator">OF</span> _ z_def<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_pred option.collapse<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="free">j</span> <span class="main">(</span>length <span class="main">(</span><span class="free">j</span> <span class="main">#</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">+</span> <span class="bound">x</span><span class="main">)</span> <span class="main">↑</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> vs_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vs assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> case_two_psi_longest_prefix z_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="skolem">k</span> <span class="main">∈</span> V_constotal_2"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> V_constotal_2I<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">j</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">a</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">k</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">j</span> <span class="main">#</span> <span class="skolem">a</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">k</span><span class="main">]</span> <span class="main">⊙</span> <span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> phi_k <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">≤</span> <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">≤</span> <span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="skolem">a</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">z</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> z_def vs_def length_prefix <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">z</span>›</span></span> vs
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_mono Suc_pred length_Cons<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">vs</span> <span class="main">!</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> vs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> the <span class="main">(</span><span class="keyword1">ψ</span> <span class="free">j</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> vs_def vs i length_Cons length_prefix prefix_nth
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> case_two_psi_longest_prefix <span class="quoted"><span class="quoted">‹Suc <span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">z</span>›</span></span> z_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> less_or_eq_imp_le not_le_imp_less not_one_less_zero
          option.sel zero_less_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> phi_j<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="skolem">k</span> <span class="main">∈</span> V_constotal"</span></span>
    <span class="keyword1"><span class="command">using</span></span> V_constotal_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> learn_total <span class="keyword1">φ</span> <span class="main">{</span><span class="keyword1">φ</span> <span class="skolem">k</span><span class="main">}</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="skolem">k</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> phi_k almost0_in_R1<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> longest_prefix <span class="free">j</span> <span class="main">⟹</span> <span class="keyword1">φ</span> <span class="skolem">k</span> <span class="bound">x</span> <span class="main">=</span> <span class="keyword1">ψ</span> <span class="free">j</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> phi_k vs_def z_def length_prefix phi_j prepend_associative prepend_at_less
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_pred <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">z</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">vs</span> <span class="main">=</span> <span class="free">j</span> <span class="main">#</span> <span class="skolem">a</span>›</span></span> append_Cons assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> case_two_not_learn<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> learn_total <span class="keyword1">φ</span> V_constotal <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> learn_total_closed_subseteq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The strategy $S$ does not learn $V$ in either case.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> not_learn_total_V<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> learn_total <span class="keyword1">φ</span> V_constotal <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="skolem">j</span> <span class="main">=</span> <span class="keyword1">ψ</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> kleene_fixed_point psi_in_P2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> case_one_not_learn_V learn_total_def case_two_not_learn_V
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"case_two <span class="skolem">j</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">lemma</span></span> V_not_in_TOTAL<span class="main">:</span> <span class="quoted"><span class="quoted">"V_constotal <span class="main">∉</span> TOTAL"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> V_constotal <span class="main">∉</span> TOTAL"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"V_constotal <span class="main">∈</span> TOTAL"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"V_constotal <span class="main">∈</span> TOTAL_wrt <span class="keyword1">φ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> TOTAL_wrt_phi_eq_TOTAL<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"learn_total <span class="keyword1">φ</span> V_constotal <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> TOTAL_wrt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> s'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span> <span class="quoted"><span class="quoted">"learn_total <span class="keyword1">φ</span> V_constotal <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lemma_R_for_TOTAL_simple <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> total_cons <span class="quoted"><span class="skolem">s'</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> total_cons_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> learn_total <span class="keyword1">φ</span> V_constotal <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_learn_total_V<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> s'<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> TOTAL_neq_CONS<span class="main">:</span> <span class="quoted"><span class="quoted">"TOTAL <span class="main">≠</span> CONS"</span></span>
  <span class="keyword1"><span class="command">using</span></span> V_not_in_TOTAL V_in_CONS CONS_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The main result of this section:›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> TOTAL_subset_CONS<span class="main">:</span> <span class="quoted"><span class="quoted">"TOTAL <span class="main">⊂</span> CONS"</span></span>
  <span class="keyword1"><span class="command">using</span></span> TOTAL_subseteq_CONS TOTAL_neq_CONS <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="R1_BC">
<div class="head">
<h1>Theory R1_BC</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">ℛ</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is not in BC\label{s:r1_bc}›</span></span>

<span class="keyword1"><span class="command">theory</span></span> R1_BC
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Lemma_R.html">Lemma_R</a>
    <a href="CP_FIN_NUM.html">CP_FIN_NUM</a>  <span class="comment1">(* for V0 *)</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We show that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="main"><span class="main">∪</span></span> <span class="keyword1"><span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is not in BC,
which implies <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">ℛ</span></span> <span class="main"><span class="main">∉</span></span> BC"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

The proof is by contradiction. Assume there is a strategy $S$ learning <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="main"><span class="main">∪</span></span> <span class="keyword1"><span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> behaviorally correct in the limit with respect to our
standard Gödel numbering $\varphi$. Thanks to Lemma~R for BC we can assume
$S$ to be total. Then we construct a function in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="main"><span class="main">∪</span></span> <span class="keyword1"><span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for
which $S$ fails.

As usual, there is a computable process building prefixes of functions
$\psi_j$. For every $j$ it starts with the singleton prefix $b = [j]$ and
computes the next prefix from a given prefix $b$ as follows:

\begin{enumerate}
\item Simulate $\varphi_{S(b0^k)}(|b| + k)$ for increasing $k$ for an
  increasing number of steps.
\item Once a $k$ with $\varphi_{S(b0^k)}(|b| + k) = 0$ is found, extend the
  prefix by $0^k1$.
\end{enumerate}

There is always such a $k$ because by assumption $S$ learns $b0^\infty \in
U_0$ and thus outputs a hypothesis for $b0^\infty$ on almost all of its
prefixes. Therefore for almost all prefixes of the form $b0^k$, we have
$\varphi_{S(b0^k)} = b0^\infty$ and hence $\varphi_{S(b0^k)}(|b| + k) = 0$.
But Step~2 constructs $\psi_j$ such that $\psi_j(|b| + k) = 1$. Therefore $S$
does not hypothesize $\psi_j$ on the prefix $b0^k$ of $\psi_j$. And since the
process runs forever, $S$ outputs infinitely many incorrect hypotheses for
$\psi_j$ and thus does not learn $\psi_j$.

Applying Kleene's fixed-point theorem to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">ψ</span></span> <span class="main"><span class="main">∈</span></span> <span class="keyword1"><span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
yields a $j$ with $\varphi_j = \psi_j$ and thus $\psi_j \in V_0$. But $S$
does not learn any $\psi_j$, contradicting our assumption.

The result <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">ℛ</span></span> <span class="main"><span class="main">∉</span></span> BC"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> can be obtained more directly by
running the process with the empty prefix, thereby constructing only one
function instead of a numbering. This function is in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">R1</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and $S$
fails to learn it by the same reasoning as above. The stronger statement
about <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="main"><span class="main">∪</span></span> <span class="keyword1"><span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> will be exploited in
Section~\ref{s:union}.

In the following locale the assumption that $S$ learns <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
suffices for analyzing the process. However, in order to arrive at the
desired contradiction this assumption is too weak because the functions built
by the process are not in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> r1_bc <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span> <span class="main">::</span> <span class="quoted">partial1</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> s_in_R1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s_learn_U0<span class="main">:</span> <span class="quoted"><span class="quoted">"learn_bc <span class="keyword1">φ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">s</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> s_learn_prenum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> learn_bc <span class="keyword1">φ</span> <span class="main">{</span>prenum <span class="bound">b</span><span class="main">}</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> s_learn_U0 U0_altdef learn_bc_closed_subseteq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">recf</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for the strategy:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">r_s</span> <span class="main">::</span> <span class="quoted">recf</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">r_s</span> <span class="main">≡</span> <span class="keyword1">SOME</span> <span class="bound">rs</span><span class="main">.</span> recfn <span class="main">1</span> <span class="bound">rs</span> <span class="main">∧</span>  total <span class="bound">rs</span> <span class="main">∧</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> eval <span class="bound">rs</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_s_recfn <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> r_s"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> r_s_total<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> eval r_s <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> eval_r_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">s</span> <span class="bound">x</span> <span class="main">=</span> eval r_s <span class="main">[</span><span class="bound">x</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> r_s_def R1_SOME<span class="main">[</span><span class="operator">OF</span> s_in_R1<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">r_s</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We begin with the function that finds the $k$ from Step~1 of the
construction of $\psi$.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_find_k</span> <span class="main">≡</span>
  <span class="keyword1">let</span> <span class="bound">k</span> <span class="main">=</span> Cn <span class="numeral">2</span> r_pdec1 <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">0</span><span class="main">]</span><span class="main">;</span>
      <span class="bound">r</span> <span class="main">=</span> Cn <span class="numeral">2</span> r_result1
        <span class="main">[</span>Cn <span class="numeral">2</span> r_pdec2 <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span>
        Cn <span class="numeral">2</span> r_s <span class="main">[</span>Cn <span class="numeral">2</span> r_append_zeros <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">1</span><span class="main">,</span> <span class="bound">k</span><span class="main">]</span><span class="main">]</span><span class="main">,</span>
        Cn <span class="numeral">2</span> r_add <span class="main">[</span>Cn <span class="numeral">2</span> r_length <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">,</span> <span class="bound">k</span><span class="main">]</span><span class="main">]</span>
  <span class="keyword1">in</span> Cn <span class="main">1</span> r_pdec1 <span class="main">[</span>Mn <span class="main">1</span> <span class="main">(</span>Cn <span class="numeral">2</span> r_eq <span class="main">[</span><span class="bound">r</span><span class="main">,</span> r_constn <span class="main">1</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_find_k_recfn <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> r_find_k"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_find_k_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹There is always a suitable $k$, since the strategy learns
$b0^\infty$ for all $b$.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> learn_bc_prenum_eventually_zero<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span>e_append_zeros <span class="free">b</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>e_length <span class="free">b</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"prenum <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span>e_length <span class="free">b</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span><span class="var">?f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="var">?f</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> learn_bcE s_learn_prenum <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> le_cases singletonI<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> e_length <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span><span class="var">?f</span> <span class="main">▹</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="var">?f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> Suc <span class="skolem">n</span> <span class="main">-</span> e_length <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"e_append_zeros <span class="free">b</span> <span class="skolem">k</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> len<span class="main">:</span> <span class="quoted"><span class="quoted">"e_length <span class="var">?e</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> k_def n e_append_zeros_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">▹</span> <span class="skolem">n</span> <span class="main">=</span> <span class="var">?e</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_length <span class="var">?e</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> len n<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">x</span> <span class="main">↓=</span> e_nth <span class="var">?e</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> e_length <span class="free">b</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> e_nth_append_zeros <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">x</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_nth <span class="var">?e</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> e_nth_append_zeros_big <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> initI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="var">?e</span>"</span></span><span class="main">]</span> len <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> n<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="var">?e</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="var">?f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="var">?e</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>e_length <span class="var">?e</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> len n<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> e_append_zeros_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> if_eq_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="free">v</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>

<span class="keyword1"><span class="command">lemma</span></span> r_find_k<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"eval r_find_k <span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">↓</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">k</span> <span class="main">=</span> the <span class="main">(</span>eval r_find_k <span class="main">[</span><span class="free">b</span><span class="main">]</span><span class="main">)</span>
           <span class="keyword1">in</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span>e_append_zeros <span class="free">b</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>e_length <span class="free">b</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="numeral">2</span> r_pdec1 <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">0</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?argt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="numeral">2</span> r_pdec2 <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">0</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?argi</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="numeral">2</span> r_s <span class="main">[</span>Cn <span class="numeral">2</span> r_append_zeros <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">1</span><span class="main">,</span> <span class="var">?k</span><span class="main">]</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?argx</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="numeral">2</span> r_add <span class="main">[</span>Cn <span class="numeral">2</span> r_length <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">,</span> <span class="var">?k</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="numeral">2</span> r_result1 <span class="main">[</span><span class="var">?argt</span><span class="main">,</span> <span class="var">?argi</span><span class="main">,</span> <span class="var">?argx</span><span class="main">]</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">≡</span>
    <span class="keyword1">let</span> <span class="bound">k</span> <span class="main">=</span> Cn <span class="numeral">2</span> r_pdec1 <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">0</span><span class="main">]</span><span class="main">;</span>
        <span class="bound">r</span> <span class="main">=</span> Cn <span class="numeral">2</span> r_result1
             <span class="main">[</span>Cn <span class="numeral">2</span> r_pdec2 <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span>
              Cn <span class="numeral">2</span> r_s <span class="main">[</span>Cn <span class="numeral">2</span> r_append_zeros <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">1</span><span class="main">,</span> <span class="bound">k</span><span class="main">]</span><span class="main">]</span><span class="main">,</span>
              Cn <span class="numeral">2</span> r_add <span class="main">[</span>Cn <span class="numeral">2</span> r_length <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">,</span> <span class="bound">k</span><span class="main">]</span><span class="main">]</span>
    <span class="keyword1">in</span> Cn <span class="numeral">2</span> r_eq <span class="main">[</span><span class="bound">r</span><span class="main">,</span> r_constn <span class="main">1</span> <span class="main">1</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="skolem">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"total r_s"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_s_total totalI1<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"total <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="keyword1"><span class="command">using</span></span> Cn_total Mn_free_imp_total <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?argi</span> <span class="main">[</span><span class="skolem">z</span><span class="main">,</span> <span class="free">b</span><span class="main">]</span> <span class="main">=</span> <span class="free">s</span> <span class="main">(</span>e_append_zeros <span class="free">b</span> <span class="main">(</span>pdec1 <span class="skolem">z</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">z</span>
    <span class="keyword1"><span class="command">using</span></span> r_append_zeros <span class="quoted"><span class="quoted">‹recfn <span class="numeral">2</span> <span class="skolem">f</span>›</span></span> eval_r_s <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?argi</span> <span class="main">[</span><span class="skolem">z</span><span class="main">,</span> <span class="free">b</span><span class="main">]</span> <span class="main">↓=</span> the <span class="main">(</span><span class="free">s</span> <span class="main">(</span>e_append_zeros <span class="free">b</span> <span class="main">(</span>pdec1 <span class="skolem">z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">z</span>
    <span class="keyword1"><span class="command">using</span></span> eval_r_s r_s_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">2</span> <span class="skolem">f</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="var">?r</span> <span class="main">[</span><span class="skolem">z</span><span class="main">,</span> <span class="free">b</span><span class="main">]</span> <span class="main">=</span>
      eval r_result1 <span class="main">[</span>pdec2 <span class="skolem">z</span><span class="main">,</span> the <span class="main">(</span><span class="free">s</span> <span class="main">(</span>e_append_zeros <span class="free">b</span> <span class="main">(</span>pdec1 <span class="skolem">z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> e_length <span class="free">b</span> <span class="main">+</span> pdec1 <span class="skolem">z</span><span class="main">]</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">z</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="skolem">f</span> <span class="main">[</span><span class="skolem">z</span><span class="main">,</span> <span class="free">b</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> the <span class="main">(</span>eval <span class="var">?r</span> <span class="main">[</span><span class="skolem">z</span><span class="main">,</span> <span class="free">b</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">z</span>
    <span class="keyword1"><span class="command">using</span></span> f_def <span class="quoted"><span class="quoted">‹recfn <span class="numeral">2</span> <span class="skolem">f</span>›</span></span> prim_recfn_total <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span>e_append_zeros <span class="free">b</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>e_length <span class="free">b</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> s_learn_prenum learn_bc_prenum_eventually_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span>e_append_zeros <span class="free">b</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>e_length <span class="free">b</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"eval r_result1 <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> the <span class="main">(</span><span class="free">s</span> <span class="main">(</span>e_append_zeros <span class="free">b</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> e_length <span class="free">b</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_result1_converg_phi<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_result1 <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> the <span class="main">(</span><span class="free">s</span> <span class="main">(</span>e_append_zeros <span class="free">b</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> e_length <span class="free">b</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?z</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"prod_encode <span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?r</span> <span class="main">[</span><span class="var">?z</span><span class="main">,</span> <span class="free">b</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> t r <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv prod_encode_inverse snd_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> f <span class="keyword1"><span class="command">have</span></span> fzb<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="skolem">f</span> <span class="main">[</span><span class="var">?z</span><span class="main">,</span> <span class="free">b</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Mn <span class="main">1</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">∃</span><span class="bound">z</span><span class="main">.</span> eval <span class="skolem">f</span> <span class="main">(</span><span class="main">[</span><span class="bound">z</span><span class="main">,</span> <span class="free">b</span><span class="main">]</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">)</span>
     <span class="keyword1">then</span> Some <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">z</span><span class="main">.</span> eval <span class="skolem">f</span> <span class="main">[</span><span class="bound">z</span><span class="main">,</span> <span class="free">b</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">)</span>
     <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eval_Mn_total<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">b</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹total <span class="skolem">f</span>›</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">2</span> <span class="skolem">f</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> mn1f<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Mn <span class="main">1</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">z</span><span class="main">.</span> eval <span class="skolem">f</span> <span class="main">[</span><span class="bound">z</span><span class="main">,</span> <span class="free">b</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> fzb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">f</span> <span class="main">[</span>the <span class="main">(</span>eval <span class="main">(</span>Mn <span class="main">1</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="free">b</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">f</span> <span class="main">[</span><span class="var">?zz</span><span class="main">,</span> <span class="free">b</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹total <span class="skolem">f</span>›</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">2</span> <span class="skolem">f</span>›</span></span> LeastI_ex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">%</span><span class="bound">z</span><span class="main">.</span> eval <span class="skolem">f</span> <span class="main">[</span><span class="bound">z</span><span class="main">,</span> <span class="free">b</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">f</span> <span class="main">[</span><span class="var">?zz</span><span class="main">,</span> <span class="free">b</span><span class="main">]</span> <span class="main">↓=</span> <span class="main">(</span><span class="keyword1">if</span> the <span class="main">(</span>eval <span class="var">?r</span> <span class="main">[</span><span class="var">?zz</span><span class="main">,</span> <span class="free">b</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> the <span class="main">(</span>eval <span class="var">?r</span> <span class="main">[</span><span class="var">?zz</span><span class="main">,</span> <span class="free">b</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span> <span class="keyword1">else</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>eval <span class="var">?r</span> <span class="main">[</span><span class="var">?zz</span><span class="main">,</span> <span class="free">b</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> if_eq_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>eval <span class="var">?r</span> <span class="main">[</span><span class="var">?zz</span><span class="main">,</span> <span class="free">b</span><span class="main">]</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
     <span class="quoted"><span class="quoted">"eval r_result1
        <span class="main">[</span>pdec2 <span class="var">?zz</span><span class="main">,</span> the <span class="main">(</span><span class="free">s</span> <span class="main">(</span>e_append_zeros <span class="free">b</span> <span class="main">(</span>pdec1 <span class="var">?zz</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> e_length <span class="free">b</span> <span class="main">+</span> pdec1 <span class="var">?zz</span><span class="main">]</span> <span class="main">↓=</span>
      <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r r_result1_total r_result1_prim totalE
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_Cons list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> numeral_3_eq_3 option.collapse<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span>e_append_zeros <span class="free">b</span> <span class="main">(</span>pdec1 <span class="var">?zz</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>e_length <span class="free">b</span> <span class="main">+</span> pdec1 <span class="var">?zz</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_result1_some_phi<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Mn1f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Mn1f</span> <span class="main">=</span> Mn <span class="main">1</span> <span class="skolem">f</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">Mn1f</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">↓=</span> <span class="var">?zz</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mn1f <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="main">(</span>Cn <span class="main">1</span> r_pdec1 <span class="main">[</span><span class="skolem">Mn1f</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">2</span> <span class="skolem">f</span>›</span></span> Mn1f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Cn <span class="main">1</span> r_pdec1 <span class="main">[</span><span class="skolem">Mn1f</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">=</span> eval r_pdec1 <span class="main">[</span>the <span class="main">(</span>eval <span class="main">(</span><span class="skolem">Mn1f</span><span class="main">)</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Cn <span class="main">1</span> r_pdec1 <span class="main">[</span><span class="skolem">Mn1f</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">=</span> eval r_pdec1 <span class="main">[</span><span class="var">?zz</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Mn1f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Cn <span class="main">1</span> r_pdec1 <span class="main">[</span><span class="skolem">Mn1f</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">↓=</span> pdec1 <span class="var">?zz</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="main">(</span>Cn <span class="main">1</span> S <span class="main">[</span>Cn <span class="main">1</span> r_pdec1 <span class="main">[</span><span class="skolem">Mn1f</span><span class="main">]</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">2</span> <span class="skolem">f</span>›</span></span> Mn1f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Cn <span class="main">1</span> S <span class="main">[</span>Cn <span class="main">1</span> r_pdec1 <span class="main">[</span><span class="skolem">Mn1f</span><span class="main">]</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">=</span>
      eval S <span class="main">[</span>the <span class="main">(</span>eval <span class="main">(</span>Cn <span class="main">1</span> r_pdec1 <span class="main">[</span><span class="skolem">Mn1f</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Cn <span class="main">1</span> S <span class="main">[</span>Cn <span class="main">1</span> r_pdec1 <span class="main">[</span><span class="skolem">Mn1f</span><span class="main">]</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">=</span> eval S <span class="main">[</span>pdec1 <span class="var">?zz</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="main">(</span>Cn <span class="main">1</span> S <span class="main">[</span>Cn <span class="main">1</span> r_pdec1 <span class="main">[</span><span class="skolem">Mn1f</span><span class="main">]</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">↓=</span> Suc <span class="main">(</span>pdec1 <span class="var">?zz</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_find_k <span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">=</span> eval <span class="main">(</span>Cn <span class="main">1</span> r_pdec1 <span class="main">[</span><span class="skolem">Mn1f</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="free">b</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> r_find_k_def Mn1f_def f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> r_find_ksb<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_find_k <span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">↓=</span> pdec1 <span class="var">?zz</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eval r_find_k <span class="main">[</span><span class="free">b</span><span class="main">]</span> <span class="main">↓</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

  <span class="keyword1"><span class="command">from</span></span> r_find_ksb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>eval r_find_k <span class="main">[</span><span class="free">b</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> pdec1 <span class="var">?zz</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span>e_append_zeros <span class="free">b</span> <span class="main">(</span>pdec1 <span class="var">?zz</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>e_length <span class="free">b</span> <span class="main">+</span> pdec1 <span class="var">?zz</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">k</span> <span class="main">=</span> the <span class="main">(</span>eval r_find_k <span class="main">[</span><span class="free">b</span><span class="main">]</span><span class="main">)</span>
      <span class="keyword1">in</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span>e_append_zeros <span class="free">b</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>e_length <span class="free">b</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_find_k_total<span class="main">:</span> <span class="quoted"><span class="quoted">"total r_find_k"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> s_learn_prenum r_find_k<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> totalI1<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following function represents one iteration of the
process.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_next</span> <span class="main">≡</span>
  Cn <span class="numeral">3</span> r_snoc <span class="main">[</span>Cn <span class="numeral">3</span> r_append_zeros <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">1</span><span class="main">,</span> Cn <span class="numeral">3</span> r_find_k <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span><span class="main">]</span><span class="main">,</span> r_constn <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Using <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">r_next</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> we define the function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">r_prefixes</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
that computes the prefix after every iteration of the process.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">r_prefixes</span> <span class="main">::</span> <span class="quoted">recf</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">r_prefixes</span> <span class="main">≡</span> Pr <span class="main">1</span> r_singleton_encode r_next"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_prefixes_recfn<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> r_prefixes"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_prefixes_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_prefixes_total<span class="main">:</span> <span class="quoted"><span class="quoted">"total r_prefixes"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">3</span> r_next"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"total r_next"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">3</span> r_next›</span></span> r_find_k_total Cn_total Mn_free_imp_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mn_free_imp_total Pr_total r_prefixes_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_prefixes_0<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_prefixes <span class="main">[</span><span class="main">0</span><span class="main">,</span> <span class="free">j</span><span class="main">]</span> <span class="main">↓=</span> list_encode <span class="main">[</span><span class="free">j</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_prefixes_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_prefixes_Suc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"eval r_prefixes <span class="main">[</span>Suc <span class="free">n</span><span class="main">,</span> <span class="free">j</span><span class="main">]</span> <span class="main">↓=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">b</span> <span class="main">=</span> the <span class="main">(</span>eval r_prefixes <span class="main">[</span><span class="free">n</span><span class="main">,</span> <span class="free">j</span><span class="main">]</span><span class="main">)</span>
     <span class="keyword1">in</span> e_snoc <span class="main">(</span>e_append_zeros <span class="bound">b</span> <span class="main">(</span>the <span class="main">(</span>eval r_find_k <span class="main">[</span><span class="bound">b</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">3</span> r_next"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"total r_next"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">3</span> r_next›</span></span> r_find_k_total Cn_total Mn_free_imp_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> eval_next<span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_next <span class="main">[</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">v</span><span class="main">,</span> <span class="skolem">j</span><span class="main">]</span> <span class="main">↓=</span>
      e_snoc <span class="main">(</span>e_append_zeros <span class="skolem">v</span> <span class="main">(</span>the <span class="main">(</span>eval r_find_k <span class="main">[</span><span class="skolem">v</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">1</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span> <span class="skolem">v</span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">using</span></span> r_find_k_total <span class="quoted"><span class="quoted">‹recfn <span class="numeral">3</span> r_next›</span></span> r_append_zeros <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval r_prefixes <span class="main">[</span>Suc <span class="free">n</span><span class="main">,</span> <span class="free">j</span><span class="main">]</span> <span class="main">=</span> eval r_next <span class="main">[</span><span class="free">n</span><span class="main">,</span> the <span class="main">(</span>eval r_prefixes <span class="main">[</span><span class="free">n</span><span class="main">,</span> <span class="free">j</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="free">j</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_prefixes_total <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_prefixes_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eval r_prefixes <span class="main">[</span>Suc <span class="free">n</span><span class="main">,</span> <span class="free">j</span><span class="main">]</span> <span class="main">↓=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">b</span> <span class="main">=</span> the <span class="main">(</span>eval r_prefixes <span class="main">[</span><span class="free">n</span><span class="main">,</span> <span class="free">j</span><span class="main">]</span><span class="main">)</span>
     <span class="keyword1">in</span> e_snoc <span class="main">(</span>e_append_zeros <span class="bound">b</span> <span class="main">(</span>the <span class="main">(</span>eval r_find_k <span class="main">[</span><span class="bound">b</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eval_next <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Since <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">r_prefixes</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is total, we can get away with
introducing a total function.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">prefixes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">prefixes</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> the <span class="main">(</span>eval r_prefixes <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prefixes_Suc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"prefixes <span class="free">j</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span> <span class="main">=</span>
    e_snoc <span class="main">(</span>e_append_zeros <span class="main">(</span>prefixes <span class="free">j</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span>eval r_find_k <span class="main">[</span>prefixes <span class="free">j</span> <span class="free">t</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> prefixes_def <span class="keyword1"><span class="command">using</span></span> r_prefixes_Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> prefixes_Suc_length<span class="main">:</span>
  <span class="quoted"><span class="quoted">"e_length <span class="main">(</span>prefixes <span class="free">j</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    Suc <span class="main">(</span>e_length <span class="main">(</span>prefixes <span class="free">j</span> <span class="free">t</span><span class="main">)</span> <span class="main">+</span> the <span class="main">(</span>eval r_find_k <span class="main">[</span>prefixes <span class="free">j</span> <span class="free">t</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> e_append_zeros_length prefixes_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> prefixes_length_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"e_length <span class="main">(</span>prefixes <span class="free">j</span> <span class="free">t</span><span class="main">)</span> <span class="main">&lt;</span> e_length <span class="main">(</span>prefixes <span class="free">j</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> prefixes_Suc_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> prefixes_length_mono'<span class="main">:</span> <span class="quoted"><span class="quoted">"e_length <span class="main">(</span>prefixes <span class="free">j</span> <span class="free">t</span><span class="main">)</span> <span class="main">≤</span> e_length <span class="main">(</span>prefixes <span class="free">j</span> <span class="main">(</span><span class="free">t</span> <span class="main">+</span> <span class="free">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">d</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> prefixes_length_mono le_less_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prefixes_length_lower_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"e_length <span class="main">(</span>prefixes <span class="free">j</span> <span class="free">t</span><span class="main">)</span> <span class="main">≥</span> Suc <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefixes_def r_prefixes_0<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>e_length <span class="main">(</span>prefixes <span class="free">j</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> e_length <span class="main">(</span>prefixes <span class="free">j</span> <span class="main">(</span>Suc <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prefixes_length_mono <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc_leI<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prefixes_Suc_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> e_length <span class="main">(</span>prefixes <span class="free">j</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"e_nth <span class="main">(</span>prefixes <span class="free">j</span> <span class="free">t</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> e_nth <span class="main">(</span>prefixes <span class="free">j</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> the <span class="main">(</span>eval r_find_k <span class="main">[</span>prefixes <span class="free">j</span> <span class="free">t</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?u</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"e_append_zeros <span class="main">(</span>prefixes <span class="free">j</span> <span class="free">t</span><span class="main">)</span> <span class="skolem">k</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefixes <span class="free">j</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span> <span class="main">=</span>
      e_snoc <span class="main">(</span>e_append_zeros <span class="main">(</span>prefixes <span class="free">j</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span>eval r_find_k <span class="main">[</span>prefixes <span class="free">j</span> <span class="free">t</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prefixes_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> k_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefixes <span class="free">j</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span> <span class="main">=</span> e_snoc <span class="var">?u</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_nth <span class="main">(</span>prefixes <span class="free">j</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> e_nth <span class="main">(</span>e_snoc <span class="var">?u</span> <span class="main">1</span><span class="main">)</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> e_length <span class="var">?u</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms e_append_zeros_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_nth <span class="main">(</span>prefixes <span class="free">j</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> e_nth <span class="var">?u</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> e_nth_snoc_small <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_nth <span class="var">?u</span> <span class="free">x</span> <span class="main">=</span> e_nth <span class="main">(</span>prefixes <span class="free">j</span> <span class="free">t</span><span class="main">)</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms e_nth_append_zeros <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"e_nth <span class="main">(</span>prefixes <span class="free">j</span> <span class="free">t</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> e_nth <span class="main">(</span>prefixes <span class="free">j</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prefixes_Suc_last<span class="main">:</span> <span class="quoted"><span class="quoted">"e_nth <span class="main">(</span>prefixes <span class="free">j</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>e_length <span class="main">(</span>prefixes <span class="free">j</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> prefixes_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> prefixes_le_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> e_length <span class="main">(</span>prefixes <span class="free">j</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"e_nth <span class="main">(</span>prefixes <span class="free">j</span> <span class="free">t</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> e_nth <span class="main">(</span>prefixes <span class="free">j</span> <span class="main">(</span><span class="free">t</span> <span class="main">+</span> <span class="free">d</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">d</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">d</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> e_length <span class="main">(</span>prefixes <span class="free">j</span> <span class="main">(</span><span class="free">t</span> <span class="main">+</span> <span class="skolem">d</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> s_learn_prenum assms prefixes_length_mono'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le order_trans_rules<span class="main"><span class="main">(</span></span>23<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_nth <span class="main">(</span>prefixes <span class="free">j</span> <span class="main">(</span><span class="free">t</span> <span class="main">+</span> <span class="skolem">d</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> e_nth <span class="main">(</span>prefixes <span class="free">j</span> <span class="main">(</span><span class="free">t</span> <span class="main">+</span> Suc <span class="skolem">d</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prefixes_Suc_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The numbering $\psi$ is defined via <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>[names_short] <span class="quoted"><span class="quoted">prefixes</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">psi</span> <span class="main">::</span> <span class="quoted">partial2</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ψ</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ψ</span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> Some <span class="main">(</span>e_nth <span class="main">(</span>prefixes <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> psi_in_R2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≡</span>  Cn <span class="numeral">2</span> r_nth <span class="main">[</span>Cn <span class="numeral">2</span> r_prefixes <span class="main">[</span>Cn <span class="numeral">2</span> S <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_prefixes_recfn <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">r</span> <span class="main">[</span><span class="skolem">j</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">↓=</span> e_nth <span class="main">(</span>prefixes <span class="skolem">j</span> <span class="main">(</span>Suc <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">unfolding</span></span> r_def prefixes_def <span class="keyword1"><span class="command">using</span></span> r_prefixes_total r_prefixes_recfn e_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="skolem">r</span> <span class="main">[</span><span class="skolem">j</span><span class="main">,</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> <span class="keyword1">ψ</span> <span class="skolem">j</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">unfolding</span></span> psi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="main">∈</span> <span class="keyword1">𝒫<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">2</span> <span class="skolem">r</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"total2 <span class="keyword1">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> psi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> psi_eq_nth_prefixes<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> e_length <span class="main">(</span>prefixes <span class="free">j</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="free">j</span> <span class="free">x</span> <span class="main">↓=</span> e_nth <span class="main">(</span>prefixes <span class="free">j</span> <span class="free">t</span><span class="main">)</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Suc <span class="free">x</span> <span class="main">&lt;</span> <span class="free">t</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> e_length <span class="main">(</span>prefixes <span class="free">j</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prefixes_length_lower_bound <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc_leD<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;</span> e_length <span class="main">(</span>prefixes <span class="free">j</span> <span class="main">(</span>Suc <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prefixes_length_mono s_learn_prenum <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> e_length <span class="main">(</span>prefixes <span class="free">j</span> <span class="main">(</span>Suc <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">with</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_nth <span class="main">(</span>prefixes <span class="free">j</span> <span class="main">(</span>Suc <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> e_nth <span class="main">(</span>prefixes <span class="free">j</span> <span class="free">t</span><span class="main">)</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prefixes_le_nth<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">-</span> Suc <span class="free">x</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> psi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_nth <span class="main">(</span>prefixes <span class="free">j</span> <span class="main">(</span>Suc <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> e_nth <span class="main">(</span>prefixes <span class="free">j</span> <span class="free">t</span><span class="main">)</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prefixes_le_nth<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">x</span> <span class="main">-</span> <span class="free">t</span>"</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> psi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> psi_at_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="free">j</span> <span class="main">0</span> <span class="main">↓=</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> psi_eq_nth_prefixes<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> prefixes_length_lower_bound<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prefixes_def r_prefixes_0<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The prefixes output by the process <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>[names_short] <span class="quoted"><span class="quoted">"prefixes <span class="free"><span class="free">j</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are
indeed prefixes of $\psi_j$.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prefixes_init_psi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="free">j</span> <span class="main">▹</span> <span class="main">(</span>e_length <span class="main">(</span>prefixes <span class="free">j</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> prefixes <span class="free">j</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> initI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"prefixes <span class="free"><span class="free">j</span></span> <span class="main"><span class="main">(</span></span>Suc <span class="free"><span class="free">t</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"prefixes <span class="free">j</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"e_length <span class="var">?e</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prefixes_length_lower_bound<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="free">t</span>"</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> e_length <span class="var">?e</span> <span class="main">⟹</span> <span class="keyword1">ψ</span> <span class="free">j</span> <span class="bound">x</span> <span class="main">↓=</span> e_nth <span class="var">?e</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prefixes_Suc_nth psi_eq_nth_prefixes <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Every prefix of $\psi_j$ generated by the process
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>[names_short] <span class="quoted"><span class="quoted">"prefixes <span class="free"><span class="free">j</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (except for the initial one) is of the form
$b0^k1$. But $k$ is chosen such that $\varphi_{S(b0^k)}(|b|+k) = 0 \neq 1 =
b0^k1_{|b|+k}$. Therefore the hypothesis $S(b0^k)$ is incorrect for
$\psi_j$.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> hyp_wrong_at_last<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span>e_butlast <span class="main">(</span>prefixes <span class="free">j</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>e_length <span class="main">(</span>prefixes <span class="free">j</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">≠</span>
   <span class="keyword1">ψ</span> <span class="free">j</span> <span class="main">(</span>e_length <span class="main">(</span>prefixes <span class="free">j</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">≠</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"prefixes <span class="free">j</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>eval r_find_k <span class="main">[</span><span class="var">?b</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"e_length <span class="main">(</span>prefixes <span class="free">j</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_butlast <span class="main">(</span>prefixes <span class="free">j</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> e_append_zeros <span class="var">?b</span> <span class="var">?k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> s_learn_prenum prefixes_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span>e_append_zeros <span class="var">?b</span> <span class="var">?k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="var">?x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">=</span> e_length <span class="var">?b</span> <span class="main">+</span> <span class="var">?k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prefixes_Suc_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span>e_append_zeros <span class="var">?b</span> <span class="var">?k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>e_length <span class="var">?b</span> <span class="main">+</span> <span class="var">?k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_find_k<span class="main">(</span>2<span class="main">)</span> r_s_total s_learn_prenum <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">&lt;</span> e_length <span class="main">(</span>prefixes <span class="free">j</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prefixes_length_lower_bound le_less_trans linorder_not_le s_learn_prenum
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">↓=</span> e_nth <span class="main">(</span>prefixes <span class="free">j</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="var">?x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> psi_eq_nth_prefixes<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">t</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"e_nth <span class="main">(</span>prefixes <span class="free">j</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="var">?x</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prefixes_Suc prefixes_Suc_last <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">↓=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?lhs</span> <span class="main">↓=</span> <span class="main">0</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> hyp_wrong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span>e_butlast <span class="main">(</span>prefixes <span class="free">j</span> <span class="main">(</span>Suc <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="keyword1">ψ</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> hyp_wrong_at_last<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For all $j$, the strategy $S$ outputs infinitely many wrong hypotheses for
$\psi_j$›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> infinite_hyp_wrong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">m</span></span><span class="main">&gt;</span><span class="free">n</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span><span class="keyword1">ψ</span> <span class="free">j</span> <span class="main">▹</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="keyword1">ψ</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"prefixes <span class="free">j</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?bb</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"e_butlast <span class="var">?b</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> len_b<span class="main">:</span> <span class="quoted"><span class="quoted">"e_length <span class="var">?b</span> <span class="main">&gt;</span> Suc <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prefixes_length_lower_bound <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc_le_lessD<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> len_bb<span class="main">:</span> <span class="quoted"><span class="quoted">"e_length <span class="var">?bb</span> <span class="main">&gt;</span> Suc <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> e_length <span class="var">?bb</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> len_bb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&gt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="free">j</span> <span class="main">▹</span> <span class="skolem">m</span> <span class="main">=</span> <span class="var">?bb</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="free">j</span> <span class="main">▹</span> <span class="main">(</span>e_length <span class="var">?b</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?b</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prefixes_init_psi <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="free">j</span> <span class="main">▹</span> <span class="main">(</span>e_length <span class="var">?b</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="var">?bb</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> init_butlast_init psi_in_R2 R2_proj_R1 R1_imp_total1 len_bb length_init
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_1 diff_diff_left length_butlast length_greater_0_conv
        list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list_decode_encode not_less0 plus_1_eq_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_Suc_1 length_init m_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="var">?bb</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="keyword1">ψ</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> hyp_wrong <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span><span class="keyword1">ψ</span> <span class="free">j</span> <span class="main">▹</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="keyword1">ψ</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">&gt;</span> <span class="free">n</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> U0_V0_not_learn_bc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> learn_bc <span class="keyword1">φ</span> <span class="main">(</span><span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∪</span> <span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="skolem">j</span> <span class="main">=</span> <span class="keyword1">ψ</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> R2_imp_P2 kleene_fixed_point psi_in_R2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">m</span></span><span class="main">&gt;</span><span class="skolem">n</span><span class="main">.</span> <span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="free">s</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">ψ</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">▹</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="keyword1">ψ</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">using</span></span> infinite_hyp_wrong<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> learn_bc <span class="keyword1">φ</span> <span class="main">{</span><span class="keyword1">ψ</span> <span class="skolem">j</span><span class="main">}</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> infinite_hyp_wrong_not_BC <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="skolem">j</span> <span class="main">∈</span> <span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">ψ</span> <span class="skolem">j</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> psi_in_R2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="main">(</span>the <span class="main">(</span><span class="var">?f</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="var">?f</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> j psi_at_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> V0_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> learn_bc <span class="keyword1">φ</span> <span class="main">(</span><span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∪</span> <span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> learn_bc_closed_subseteq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> U0_V0_not_in_BC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∪</span> <span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∉</span> BC"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> in_BC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∪</span> <span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> BC"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∪</span> <span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> BC_wrt <span class="keyword1">φ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> BC_wrt_phi_eq_BC <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"learn_bc <span class="keyword1">φ</span> <span class="main">(</span><span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∪</span> <span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> BC_wrt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> s'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span> <span class="quoted"><span class="quoted">"learn_bc <span class="keyword1">φ</span> <span class="main">(</span><span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∪</span> <span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lemma_R_for_BC_simple <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> learn_U0<span class="main">:</span> <span class="quoted"><span class="quoted">"learn_bc <span class="keyword1">φ</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> learn_bc_closed_subseteq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="keyword1">φ</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∪</span> <span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> r1_bc <span class="quoted"><span class="skolem">s'</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r1_bc_def s'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> learn_bc <span class="keyword1">φ</span> <span class="main">(</span><span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∪</span> <span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> learn_bc_closed_subseteq U0_V0_not_learn_bc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> s'<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> R1_not_in_BC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ℛ</span> <span class="main">∉</span> BC"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∪</span> <span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊆</span> <span class="keyword1">ℛ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> V0_def U0_in_NUM <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> U0_V0_not_in_BC BC_closed_subseteq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Union">
<div class="head">
<h1>Theory Union</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The union of classes\label{s:union}›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Union
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="R1_BC.html">R1_BC</a> <a href="TOTAL_CONS.html">TOTAL_CONS</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹None of the inference types introduced in this chapter are closed
under union of classes. For all inference types except FIN this follows from
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] "U0_V0_not_in_BC"<span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> not_closed_under_union<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ℐ</span><span class="main">∈</span><span class="main">{</span>CP<span class="main">,</span> TOTAL<span class="main">,</span> CONS<span class="main">,</span> <span class="keyword1">LIM</span><span class="main">,</span> BC<span class="main">}</span><span class="main">.</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="bound">ℐ</span> <span class="main">∧</span> <span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="bound">ℐ</span> <span class="main">∧</span> <span class="keyword1">U<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∪</span> <span class="keyword1">V<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∉</span> <span class="bound">ℐ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> U0_in_CP U0_in_NUM V0_in_FIN
    FIN_subseteq_CP
    NUM_subseteq_TOTAL
    CP_subseteq_TOTAL
    TOTAL_subseteq_CONS
    CONS_subseteq_Lim
    Lim_subseteq_BC
    U0_V0_not_in_BC
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In order to show the analogous result for FIN consider the
classes $\{0^\infty\}$ and $\{0^n10^\infty \mid n \in \mathbb{N}\}$. The
former can be learned finitely by a strategy that hypothesizes $0^\infty$ for
every input. The latter can be learned finitely by a strategy that waits for
the 1 and hypothesizes the only function in the class with a 1 at that
position. However, the union of both classes is not in FIN. This is because
any FIN strategy has to hypothesize $0^\infty$ on some prefix of the form
$0^n$. But the strategy then fails for the function $0^n10^\infty$.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> singleton_in_FIN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span> <span class="main">⟹</span> <span class="main">{</span><span class="free">f</span><span class="main">}</span> <span class="main">∈</span> FIN"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> phi_universal <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="main">::</span> <span class="quoted">partial1</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Some <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> const_in_Prim1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"learn_fin <span class="keyword1">φ</span> <span class="main">{</span><span class="free">f</span><span class="main">}</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> learn_finI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"environment <span class="keyword1">φ</span> <span class="main">{</span><span class="free">f</span><span class="main">}</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> phi_in_P2<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span> <span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="keyword1">φ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">g</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="skolem">s</span> <span class="main">(</span><span class="skolem">g</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="skolem">s</span> <span class="main">(</span><span class="skolem">g</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> <span class="main">{</span><span class="free">f</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">g</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">φ</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">g</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="main">0</span><span class="main">.</span> <span class="skolem">s</span> <span class="main">(</span><span class="skolem">g</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="main">0</span><span class="main">.</span> <span class="skolem">s</span> <span class="main">(</span><span class="skolem">g</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> Suc <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> s_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">f</span><span class="main">}</span> <span class="main">∈</span> FIN"</span></span> <span class="keyword1"><span class="command">using</span></span> FIN_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">U_single</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"partial1 set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">U_single</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">n</span> <span class="keyword1">then</span> Some <span class="main">1</span> <span class="keyword1">else</span> Some <span class="main">0</span><span class="main">)</span><span class="main">|</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> UNIV<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> U_single_in_FIN<span class="main">:</span> <span class="quoted"><span class="quoted">"U_single <span class="main">∈</span> FIN"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">psi</span></span> <span class="main">::</span> <span class="quoted">partial2</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">psi</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">n</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">n</span> <span class="keyword1">then</span> Some <span class="main">1</span> <span class="keyword1">else</span> Some <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">psi</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> psi_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> R2I<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Cn <span class="numeral"><span class="numeral"><span class="numeral">2</span></span></span> r_not <span class="main"><span class="main"><span class="main">[</span></span></span>r_eq<span class="main"><span class="main"><span class="main">]</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="main">::</span> <span class="quoted">partial1</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="keyword1">if</span> findr <span class="bound">b</span> <span class="main">↓=</span> e_length <span class="bound">b</span> <span class="keyword1">then</span> Some <span class="main">0</span> <span class="keyword1">else</span> Some <span class="main">(</span>Suc <span class="main">(</span>the <span class="main">(</span>findr <span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> R1I<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="main">1</span> r_ifeq <span class="main">[</span>r_findr<span class="main">,</span> r_length<span class="main">,</span> Z<span class="main">,</span> Cn <span class="main">1</span> S <span class="main">[</span>r_findr<span class="main">]</span><span class="main">]</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"recfn <span class="main">1</span> <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"total <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?r</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">s</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">b</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>findr <span class="skolem">b</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?r</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="var">?b</span> <span class="main">=</span> e_length <span class="skolem">b</span> <span class="keyword1">then</span> Some <span class="main">0</span> <span class="keyword1">else</span> Some <span class="main">(</span>Suc <span class="main">(</span><span class="var">?b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> findr_total <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?r</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">s</span> <span class="skolem">b</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> findr_total option.collapse option.inject s_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"U_single <span class="main">⊆</span> <span class="keyword1">ℛ</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> U_single"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">n</span> <span class="keyword1">then</span> Some <span class="main">1</span> <span class="keyword1">else</span> Some <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> U_single_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="skolem">psi</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> psi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">psi</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"learn_fin <span class="skolem">psi</span> U_single <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> learn_finI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"environment <span class="skolem">psi</span> U_single <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">psi</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∈</span> <span class="keyword1">ℛ</span>›</span></span> <span class="quoted"><span class="quoted">‹U_single <span class="main">⊆</span> <span class="keyword1">ℛ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span> <span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="skolem">psi</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="skolem">s</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="bound">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="skolem">s</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> U_single"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> that <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">i</span> <span class="keyword1">then</span> Some <span class="main">1</span> <span class="keyword1">else</span> Some <span class="main">0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> U_single_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">psi</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> psi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="skolem">i</span><span class="main">.</span> <span class="skolem">s</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> i s_def findr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="skolem">i</span><span class="main">.</span> <span class="skolem">s</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> Suc <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?e</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"init <span class="skolem">f</span> <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>e_length <span class="var">?e</span><span class="main">.</span> e_nth <span class="var">?e</span> <span class="bound">i</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">≥</span> <span class="skolem">i</span>›</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> less<span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>findr <span class="var">?e</span><span class="main">)</span> <span class="main">&lt;</span> e_length <span class="var">?e</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> nth_e<span class="main">:</span> <span class="quoted"><span class="quoted">"e_nth <span class="var">?e</span> <span class="main">(</span>the <span class="main">(</span>findr <span class="var">?e</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> findr_ex <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="var">?e</span> <span class="main">↓=</span> Suc <span class="main">(</span>the <span class="main">(</span>findr <span class="var">?e</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> s_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>findr <span class="var">?e</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> nth_e less i <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_init nth_init option.sel<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="var">?e</span> <span class="main">↓=</span> Suc <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"U_single <span class="main">∈</span> FIN"</span></span> <span class="keyword1"><span class="command">using</span></span> FIN_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> zero_U_single_not_in_FIN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span><span class="main">}</span> <span class="main">∪</span> U_single <span class="main">∉</span> FIN"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span><span class="main">}</span> <span class="main">∪</span> U_single <span class="main">∈</span> FIN"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">psi</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> learn<span class="main">:</span> <span class="quoted"><span class="quoted">"learn_fin <span class="skolem">psi</span> <span class="main">(</span><span class="main">{</span><span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span><span class="main">}</span> <span class="main">∪</span> U_single<span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> FIN_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"learn_fin <span class="skolem">psi</span> <span class="main">{</span><span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span><span class="main">}</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> learn_fin_closed_subseteq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="skolem">psi</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="skolem">s</span> <span class="main">(</span><span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="skolem">s</span> <span class="main">(</span><span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> Suc <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> learn_finE<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> Suc <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">then</span> Some <span class="main">1</span> <span class="keyword1">else</span> Some <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">≠</span> <span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.inject zero_neq_one<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">∈</span> U_single"</span></span>
    <span class="keyword1"><span class="command">using</span></span> U_single_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"learn_fin <span class="skolem">psi</span> <span class="main">{</span><span class="var">?f</span><span class="main">}</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> learn learn_fin_closed_subseteq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="skolem"><span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="skolem">psi</span> <span class="skolem">j</span> <span class="main">=</span> <span class="var">?f</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span><span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="skolem">s</span> <span class="main">(</span><span class="var">?f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> <span class="skolem">s</span> <span class="main">(</span><span class="var">?f</span> <span class="main">▹</span> <span class="bound">n</span><span class="main">)</span> <span class="main">↓=</span> Suc <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> learn_finE<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">consider</span></span>
    <span class="main">(</span>less<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">&lt;</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="main">|</span> <span class="main">(</span>eq<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="main">|</span> <span class="main">(</span>gr<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">&gt;</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> less
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">(</span><span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span><span class="main">▹</span> <span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">▹</span> <span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="var">?f</span> <span class="main">▹</span> <span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> less init_eqI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">(</span><span class="var">?f</span> <span class="main">▹</span> <span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> j <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> eq
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">▹</span> <span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="var">?f</span> <span class="main">▹</span> <span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> init_eqI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">(</span><span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">▹</span> <span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">=</span> <span class="skolem">s</span> <span class="main">(</span><span class="var">?f</span> <span class="main">▹</span> <span class="skolem">m<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> i j eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">psi</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">psi</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?f</span> <span class="main">≠</span> <span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span>›</span></span> i j <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> gr
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">▹</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="var">?f</span> <span class="main">▹</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> init_eqI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">(</span><span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">▹</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">↓=</span> Suc <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> i <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">(</span><span class="var">?f</span> <span class="main">▹</span> <span class="skolem">n<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">↓=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> j gr <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> FIN_not_closed_under_union<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">U</span> <span class="bound">V</span><span class="main">.</span> <span class="bound">U</span> <span class="main">∈</span> FIN <span class="main">∧</span> <span class="bound">V</span> <span class="main">∈</span> FIN <span class="main">∧</span> <span class="bound">U</span> <span class="main">∪</span> <span class="bound">V</span> <span class="main">∉</span> FIN"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0<span class="hidden">⇧</span><sup>∞</sup></span><span class="main">}</span> <span class="main">∈</span> FIN"</span></span>
    <span class="keyword1"><span class="command">using</span></span> singleton_in_FIN const_in_Prim1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"U_single <span class="main">∈</span> FIN"</span></span>
    <span class="keyword1"><span class="command">using</span></span> U_single_in_FIN <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> zero_U_single_not_in_FIN <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In contrast to the inference types, NUM is closed under the union
of classes. The total numberings that exist for each NUM class can be
interleaved to produce a total numbering encompassing the union of the
classes. To define the interleaving, modulo and division by two will be
helpful.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_div2</span> <span class="main">≡</span>
  r_shrink
   <span class="main">(</span>Pr <span class="main">1</span> Z
     <span class="main">(</span>Cn <span class="numeral">3</span> r_ifle
       <span class="main">[</span>Cn <span class="numeral">3</span> r_mul <span class="main">[</span>r_constn <span class="numeral">2</span> <span class="numeral">2</span><span class="main">,</span> Cn <span class="numeral">3</span> S <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">0</span><span class="main">]</span><span class="main">]</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">,</span> Cn <span class="numeral">3</span> S <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_div2_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> r_div2"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_div2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_div2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_div2 <span class="main">[</span><span class="free">n</span><span class="main">]</span> <span class="main">↓=</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Pr <span class="main">1</span> Z
    <span class="main">(</span>Cn <span class="numeral">3</span> r_ifle
      <span class="main">[</span>Cn <span class="numeral">3</span> r_mul <span class="main">[</span>r_constn <span class="numeral">2</span> <span class="numeral">2</span><span class="main">,</span> Cn <span class="numeral">3</span> S <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">0</span><span class="main">]</span><span class="main">]</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="numeral">2</span><span class="main">,</span> Cn <span class="numeral">3</span> S <span class="main">[</span>Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span><span class="main">,</span> Id <span class="numeral">3</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?p</span> <span class="main">[</span><span class="skolem">i</span><span class="main">,</span> <span class="free">n</span><span class="main">]</span> <span class="main">↓=</span> min <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?p</span> <span class="main">[</span><span class="free">n</span><span class="main">,</span> <span class="free">n</span><span class="main">]</span> <span class="main">↓=</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> r_div2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r_mod2</span> <span class="main">≡</span> Cn <span class="main">1</span> r_sub <span class="main">[</span>Id <span class="main">1</span> <span class="main">0</span><span class="main">,</span> Cn <span class="main">1</span> r_mul <span class="main">[</span>r_const <span class="numeral">2</span><span class="main">,</span> r_div2<span class="main">]</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> r_mod2_prim <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prim_recfn <span class="main">1</span> r_mod2"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_mod2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> r_mod2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"eval r_mod2 <span class="main">[</span><span class="free">n</span><span class="main">]</span> <span class="main">↓=</span> <span class="free">n</span> <span class="keyword1">mod</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> r_mod2_def <span class="keyword1"><span class="command">using</span></span> Rings.semiring_modulo_class.minus_mult_div_eq_mod
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> NUM_closed_under_union<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">∈</span> NUM"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">∈</span> NUM"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">∪</span> <span class="free">V</span> <span class="main">∈</span> NUM"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">psi_u</span></span> <span class="skolem"><span class="skolem">psi_v</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    psi_u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">psi_u</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">psi_u</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">f</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    psi_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">psi_v</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">V</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">psi_v</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">f</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">psi</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">psi</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="keyword1">mod</span> <span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="skolem">psi_u</span> <span class="main">(</span><span class="bound">i</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">else</span> <span class="skolem">psi_v</span> <span class="main">(</span><span class="bound">i</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> psi_u<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"total <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> eval <span class="skolem">u</span> <span class="main">[</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">psi_u</span> <span class="bound">x</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> psi_v<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"total <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> eval <span class="skolem">v</span> <span class="main">[</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">psi_v</span> <span class="bound">x</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r_psi</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Cn <span class="numeral">2</span> r_ifz
    <span class="main">[</span>Cn <span class="numeral">2</span> r_mod2 <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span>
     Cn <span class="numeral">2</span> <span class="skolem">u</span> <span class="main">[</span>Cn <span class="numeral">2</span> r_div2 <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">,</span>
     Cn <span class="numeral">2</span> <span class="skolem">v</span> <span class="main">[</span>Cn <span class="numeral">2</span> r_div2 <span class="main">[</span>Id <span class="numeral">2</span> <span class="main">0</span><span class="main">]</span><span class="main">,</span> Id <span class="numeral">2</span> <span class="main">1</span><span class="main">]</span><span class="main">]</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> NUM_I<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">psi</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">psi</span> <span class="main">∈</span> <span class="keyword1">ℛ<span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> R2I<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"recfn <span class="numeral">2</span> <span class="var">?r_psi</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> u<span class="main">(</span>1<span class="main">)</span> v<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"eval <span class="var">?r_psi</span> <span class="main">[</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">psi</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
        <span class="keyword1"><span class="command">using</span></span> u v psi_def prim_recfn_total R2_imp_total2<span class="main">[</span><span class="operator">OF</span> psi_u<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
          R2_imp_total2<span class="main">[</span><span class="operator">OF</span> psi_v<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">psi</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">↓</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
        <span class="keyword1"><span class="command">using</span></span> psi_def psi_u<span class="main">(</span>1<span class="main">)</span> psi_v<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"total <span class="var">?r_psi</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹recfn <span class="numeral">2</span> <span class="var">?r_psi</span>›</span></span> totalI2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">psi</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="free">U</span> <span class="main">∪</span> <span class="free">V</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">f</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="free">U</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">psi_u</span> <span class="skolem">j</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> psi_u<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">psi</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> psi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="free">V</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">psi_v</span> <span class="skolem">j</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> psi_v<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">psi</span> <span class="main">(</span>Suc <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> psi_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div>