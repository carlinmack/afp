<div id="Preliminaries2">
<div class="head">
<h1>Theory Preliminaries2</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Author:      Salomon Sickert
    License:     BSD
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary Facts›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Preliminaries2
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <span class="quoted">"<a href="../../HOL/HOL-Library/Infinite_Set.html">HOL-Library.Infinite_Set</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Finite and Infinite Sets›</span></span>

<span class="keyword1" id="Preliminaries2-finite_product"><span class="command">lemma</span></span> finite_product<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fst<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>fst <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     snd<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>snd <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="main">(</span>fst <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span>snd <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> snd fst finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Cofinite Filters›</span></span>

<span class="keyword1" id="Preliminaries2-almost_all_commutative"><span class="command">lemma</span></span> almost_all_commutative<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="main">∀<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">(</span><span class="bound">i</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span> 
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">S</span><span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> insert <span class="skolem">x</span> <span class="skolem">S</span><span class="main">.</span> <span class="main">∀<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">i</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="skolem">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="skolem">x</span> <span class="bound">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">i<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≥</span> <span class="skolem">i<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="skolem">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">j</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≥</span> <span class="skolem">i<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="free">P</span> <span class="skolem">x</span> <span class="bound">j</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> MOST_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≥</span> max <span class="skolem">i<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">i<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="skolem">S</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">j</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> insert <span class="skolem">x</span> <span class="skolem">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">i</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> MOST_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> insert <span class="skolem">x</span> <span class="skolem">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">i</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> insert <span class="skolem">x</span> <span class="skolem">S</span><span class="main">.</span> <span class="main">∀<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">i</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> MOST_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Preliminaries2-almost_all_commutative'"><span class="command">lemma</span></span> almost_all_commutative'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="free">S</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">∀<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">(</span><span class="bound">i</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> almost_all_commutative <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">index</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">∀<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">i</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">i</span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> <span class="bound">i</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">j</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>

<span class="keyword1" id="Preliminaries2-index_properties"><span class="command">lemma</span></span> index_properties<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">i</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"index <span class="free">P</span> <span class="main">=</span> Some <span class="free">i</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">P</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"index <span class="free">P</span> <span class="main">=</span> Some <span class="free">i</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">≥</span> <span class="free">i</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"index <span class="free">P</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> i_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> <span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> index.simps <span class="keyword1"><span class="command">using</span></span> option.distinct<span class="main">(</span>2<span class="main">)</span> option.sel 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>erased<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> <span class="skolem">i'</span><span class="main">.</span>  <span class="free">P</span> <span class="bound">j</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> MOST_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≥</span> <span class="free">i</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> LeastI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> <span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="bound">j</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> i_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> Suc <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lessE <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j'</span><span class="main">.</span> <span class="bound">j'</span> <span class="main">&gt;</span> <span class="skolem">j</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">j'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≥</span> <span class="free">i</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">P</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> not_less_Least<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> i_def<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> leI le_antisym<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">P</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> Suc <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Map2">
<div class="head">
<h1>Theory Map2</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Author:      Salomon Sickert
    License:     BSD
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary Map Facts›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Map2
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="keyword1" id="Map2-map_of_tabulate"><span class="command">lemma</span></span> map_of_tabulate<span class="main">:</span>  
  <span class="quoted"><span class="quoted">"map_of <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="free">x</span> <span class="main">≠</span> None <span class="main">⟷</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Map2-map_of_tabulate_simp"><span class="command">lemma</span></span> map_of_tabulate_simp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map_of <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> comp_eq_dest_lhs map_of_map_restrict restrict_map_def<span class="main">)</span>

<span class="keyword1" id="Map2-dom_map_update"><span class="command">lemma</span></span> dom_map_update<span class="main">:</span>
  <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="free">m</span> <span class="main">(</span><span class="free">k</span> <span class="main">↦</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dom <span class="free">m</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Map2-map_equal"><span class="command">lemma</span></span> map_equal<span class="main">:</span>
  <span class="quoted"><span class="quoted">"dom <span class="free">m</span> <span class="main">=</span> dom <span class="free">m'</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> dom <span class="free">m</span> <span class="main">⟹</span> <span class="free">m</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">m'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">=</span> <span class="free">m'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Map2-map_reduce"><span class="command">lemma</span></span> map_reduce<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dom <span class="free">m</span> <span class="main">=</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">∪</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">m'</span><span class="main">.</span> dom <span class="bound">m'</span> <span class="main">=</span> <span class="free">B</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> <span class="free">m</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">m'</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">B</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_absorb insert_is_Un<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span><span class="free">m</span> <span class="main">(</span><span class="free">a</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">B</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">B</span><span class="main">.</span> <span class="free">m</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">m</span> <span class="main">(</span><span class="free">a</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Mapping2">
<div class="head">
<h1>Theory Mapping2</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Author:      Salomon Sickert
    License:     BSD
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary Mapping Facts›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Mapping2
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <a href="Map2.html">Map2</a> <span class="quoted">"<a href="../../HOL/HOL-Library/Mapping.html">HOL-Library.Mapping</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="keyword1" id="Mapping2-lookup_delete"><span class="command">lemma</span></span> lookup_delete<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span>Mapping.delete <span class="free">k</span> <span class="free">m</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span> 

<span class="keyword1" id="Mapping2-lookup_tabulate"><span class="command">lemma</span></span> lookup_tabulate<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span>Mapping.tabulate <span class="free">xs</span> <span class="free">f</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">insert</span> map_of_tabulate_simp<span class="main">)</span>

<span class="keyword1" id="Mapping2-lookup_tabulate_Some"><span class="command">lemma</span></span> lookup_tabulate_Some<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> the <span class="main">(</span>Mapping.lookup <span class="main">(</span>Mapping.tabulate <span class="free">xs</span> <span class="free">f</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_tabulate<span class="main">)</span>

<span class="keyword1" id="Mapping2-finite_keys_tabulate"><span class="command">lemma</span></span> finite_keys_tabulate<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>Mapping.keys <span class="main">(</span>Mapping.tabulate <span class="free">xs</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Mapping2-keys_empty_iff_map_empty"><span class="command">lemma</span></span> keys_empty_iff_map_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Mapping.keys <span class="free">m</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> <span class="free">m</span> <span class="main">=</span> Mapping.empty"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Mapping2-mapping_equal"><span class="command">lemma</span></span> mapping_equal<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Mapping.keys <span class="free">m</span> <span class="main">=</span> Mapping.keys <span class="free">m'</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> Mapping.keys <span class="free">m</span> <span class="main">⟹</span> Mapping.lookup <span class="free">m</span> <span class="bound">x</span> <span class="main">=</span> Mapping.lookup <span class="free">m'</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">=</span> <span class="free">m'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> map_equal<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mapping_generator</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> list<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> mapping set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mapping_generator</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{</span>Mapping.empty<span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mapping_generator</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ks</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>Mapping.update <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="bound">v</span> <span class="bound">m</span> <span class="main">|</span> <span class="bound">v</span> <span class="bound">m</span><span class="main">.</span>  <span class="bound">v</span> <span class="main">∈</span> set <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="bound">m</span> <span class="main">∈</span> <span class="free">mapping_generator</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">ks</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mapping_generator_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> list<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> mapping list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mapping_generator_list</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[</span>Mapping.empty<span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mapping_generator_list</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ks</span></span></span><span class="main">)</span> <span class="main">=</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> Mapping.update <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="bound">v</span> <span class="bound">m</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">mapping_generator_list</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">ks</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Mapping2-mapping_generator_code"><span class="command">lemma</span></span> mapping_generator_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"mapping_generator <span class="free">V</span> <span class="free">K</span> <span class="main">=</span> set <span class="main">(</span>mapping_generator_list <span class="free">V</span> <span class="free">K</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">K</span></span><span class="main">)</span> <span class="operator">auto</span> 

<span class="keyword1" id="Mapping2-mapping_generator_set_eq"><span class="command">lemma</span></span> mapping_generator_set_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mapping_generator <span class="free">V</span> <span class="free">K</span> <span class="main">=</span> <span class="main">{</span><span class="bound">m</span><span class="main">.</span> Mapping.keys <span class="bound">m</span> <span class="main">=</span> set <span class="free">K</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">(</span>set <span class="free">K</span><span class="main">)</span><span class="main">.</span> the <span class="main">(</span>Mapping.lookup <span class="bound">m</span> <span class="bound">k</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">V</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">K</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">k</span> <span class="skolem">ks</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">m</span><span class="main">(</span><span class="skolem">k</span> <span class="main">↦</span> <span class="bound">v</span><span class="main">)</span> <span class="main">|</span><span class="bound">v</span> <span class="bound">m</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">V</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">∧</span>  <span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">m</span><span class="main">.</span> dom <span class="bound">m</span> <span class="main">=</span> set <span class="skolem">ks</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">∈</span>set <span class="skolem">ks</span><span class="main">.</span> the <span class="main">(</span><span class="bound">m</span> <span class="bound">k</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">V</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">m</span><span class="main">.</span> dom <span class="bound">m</span> <span class="main">=</span> set <span class="main">(</span><span class="skolem">k</span> <span class="main">#</span> <span class="skolem">ks</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">∈</span>set <span class="main">(</span><span class="skolem">k</span> <span class="main">#</span> <span class="skolem">ks</span><span class="main">)</span><span class="main">.</span> the <span class="main">(</span><span class="bound">m</span> <span class="bound">k</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">V</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">⊆</span> <span class="var">?r</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> 
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">∈</span> <span class="var">?r</span>"</span></span> 
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">m</span> <span class="main">=</span> set <span class="main">(</span><span class="skolem">k</span><span class="main">#</span><span class="skolem">ks</span><span class="main">)</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">k</span><span class="main">#</span><span class="skolem">ks</span><span class="main">)</span><span class="main">.</span> the <span class="main">(</span><span class="skolem">m</span> <span class="bound">k</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">V</span> <span class="bound">k</span><span class="main">)</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k'</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">k</span><span class="main">#</span><span class="skolem">ks</span><span class="main">)</span><span class="main">.</span> <span class="skolem">m</span> <span class="skolem">k</span> <span class="main">≠</span> None"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>   
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">m'</span> <span class="main">=</span> set <span class="skolem">ks</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">ks</span><span class="main">.</span> <span class="skolem">m</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">m'</span> <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> map_reduce<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">m</span></span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ks</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="skolem">m</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">V</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">m'</span> <span class="main">=</span> set <span class="skolem">ks</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">(</span>set <span class="skolem">ks</span><span class="main">)</span><span class="main">.</span> the <span class="main">(</span><span class="skolem">m'</span> <span class="bound">k</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">V</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="skolem">m'</span><span class="main">(</span><span class="skolem">k</span> <span class="main">↦</span> the <span class="main">(</span><span class="skolem">m</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> map_equal<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">m</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">m'</span></span><span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">k</span></span> <span class="main"><span class="main">↦</span></span> the <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">m</span></span> <span class="skolem"><span class="skolem">k</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> dom_map_update <span class="quoted"><span class="quoted">‹dom <span class="skolem">m</span> <span class="main">=</span> set <span class="main">(</span><span class="skolem">k</span><span class="main">#</span><span class="skolem">ks</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">m'</span> <span class="main">=</span> set <span class="skolem">ks</span>›</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="skolem">m'</span><span class="main">(</span><span class="skolem">k</span> <span class="main">↦</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">V</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">∈</span> <span class="var">?l</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">m</span> <span class="main">=</span> set <span class="main">(</span><span class="skolem">k</span><span class="main">#</span><span class="skolem">ks</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>       
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Mapping.update <span class="skolem">k</span> <span class="bound">v</span> <span class="bound">m</span> <span class="main">|</span><span class="bound">v</span> <span class="bound">m</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">V</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">m</span><span class="main">.</span> Mapping.keys <span class="bound">m</span> <span class="main">=</span> set <span class="skolem">ks</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">∈</span>set <span class="skolem">ks</span><span class="main">.</span> the <span class="main">(</span>Mapping.lookup <span class="bound">m</span> <span class="bound">k</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">V</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">}</span> 
      <span class="main">=</span> <span class="main">{</span><span class="bound">m</span><span class="main">.</span> Mapping.keys <span class="bound">m</span> <span class="main">=</span> set <span class="main">(</span><span class="skolem">k</span> <span class="main">#</span> <span class="skolem">ks</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">∈</span>set <span class="main">(</span><span class="skolem">k</span> <span class="main">#</span> <span class="skolem">ks</span><span class="main">)</span><span class="main">.</span> the <span class="main">(</span>Mapping.lookup <span class="bound">m</span> <span class="bound">k</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">V</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> keys_empty_iff_map_empty<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="DTS">
<div class="head">
<h1>Theory DTS</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Author:      Salomon Sickert
    License:     BSD
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Deterministic Transition Systems›</span></span>

<span class="keyword1"><span class="command">theory</span></span> DTS
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <span class="quoted">"<a href="../../HOL/HOL-Library/Omega_Words_Fun.html">HOL-Library.Omega_Words_Fun</a>"</span> <span class="quoted">"<a href="Mapping2.html">Auxiliary/Mapping2</a>"</span> <a href="../KBPs/DFS.html">KBPs.DFS</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">― ‹DTS are realised by functions›</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> DTS <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> transition <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Infinite Runs›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">run</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'q</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> DTS <span class="main">⇒</span> <span class="tfree">'q</span> <span class="main">⇒</span> <span class="tfree">'a</span> word <span class="main">⇒</span> <span class="tfree">'q</span> word"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">run</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">run</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="main">(</span><span class="free">run</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">run<span class="hidden">⇩</span><sub>t</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'q</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> DTS <span class="main">⇒</span> <span class="tfree">'q</span> <span class="main">⇒</span> <span class="tfree">'a</span> word <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'q</span> <span class="main">*</span> <span class="tfree">'a</span> <span class="main">*</span> <span class="tfree">'q</span><span class="main">)</span> word"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">run<span class="hidden">⇩</span><sub>t</sub></span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span>run <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> run <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="DTS-run_foldl"><span class="command">lemma</span></span> run_foldl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"run <span class="free">Δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">w</span> <span class="free">i</span> <span class="main">=</span> foldl <span class="free">Δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>map <span class="free">w</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="DTS-run"><span class="command">lemma</span></span> run<span class="hidden">⇩</span><sub>t</sub>_foldl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"run<span class="hidden">⇩</span><sub>t</sub> <span class="free">Δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">w</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span>foldl <span class="free">Δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>map <span class="free">w</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">i</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="free">w</span> <span class="free">i</span><span class="main">,</span> foldl <span class="free">Δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>map <span class="free">w</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="free">i</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> run<span class="hidden">⇩</span><sub>t</sub>.simps run_foldl <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Reachable States and Transitions›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">reach</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> DTS <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">reach</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">=</span> <span class="main">{</span>run <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="bound">w</span> <span class="bound">n</span> <span class="main">|</span> <span class="bound">w</span> <span class="bound">n</span><span class="main">.</span> range <span class="bound">w</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">reach<span class="hidden">⇩</span><sub>t</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> DTS <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> transition set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">reach<span class="hidden">⇩</span><sub>t</sub></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">=</span> <span class="main">{</span>run<span class="hidden">⇩</span><sub>t</sub> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="bound">w</span> <span class="bound">n</span> <span class="main">|</span> <span class="bound">w</span> <span class="bound">n</span><span class="main">.</span> range <span class="bound">w</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="DTS-reach_foldl_def"><span class="command">lemma</span></span> reach_foldl_def<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Σ</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"reach <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="main">{</span>foldl <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">w</span> <span class="main">|</span> <span class="bound">w</span><span class="main">.</span> set <span class="bound">w</span> <span class="main">⊆</span> <span class="free">Σ</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">w</span> <span class="main">⊆</span> <span class="free">Σ</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">Σ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Σ</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"foldl <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">w</span> <span class="main">=</span> foldl <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>prefix <span class="main">(</span>length <span class="skolem">w</span><span class="main">)</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">⌢</span> <span class="main">(</span>iter <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"range <span class="main">(</span><span class="skolem">w</span> <span class="main">⌢</span> <span class="main">(</span>iter <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Σ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> prefix_conc_length<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iter_def conc_def<span class="main">)</span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">w'</span> <span class="bound">n</span><span class="main">.</span> foldl <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">w</span> <span class="main">=</span> run <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">w'</span> <span class="bound">n</span> <span class="main">∧</span> range <span class="bound">w'</span> <span class="main">⊆</span> <span class="free">Σ</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> run_foldl subsequence_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_def run_foldl<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DTS-reach"><span class="command">lemma</span></span> reach<span class="hidden">⇩</span><sub>t</sub>_foldl_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span>foldl <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">w</span><span class="main">,</span> <span class="bound">ν</span><span class="main">,</span> foldl <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="bound">w</span><span class="main">@</span><span class="main">[</span><span class="bound">ν</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">w</span> <span class="bound">ν</span><span class="main">.</span> set <span class="bound">w</span> <span class="main">⊆</span> <span class="free">Σ</span> <span class="main">∧</span> <span class="bound">ν</span> <span class="main">∈</span> <span class="free">Σ</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">Σ</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="skolem">ν</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">w</span> <span class="main">⊆</span> <span class="free">Σ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ν</span> <span class="main">∈</span> <span class="free">Σ</span>"</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">Σ</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Σ</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="skolem">w</span> <span class="keyword1">then</span> <span class="skolem">w</span> <span class="main">!</span> <span class="bound">n</span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">-</span> length <span class="skolem">w</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">[</span><span class="skolem">ν</span><span class="main">]</span> <span class="main">!</span> <span class="main">(</span><span class="bound">n</span> <span class="main">-</span> length <span class="skolem">w</span><span class="main">)</span> <span class="keyword1">else</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>length <span class="skolem">w</span><span class="main">]</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_equalityI<span class="main">)</span>  
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"foldl <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">w</span> <span class="main">=</span> foldl <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>prefix <span class="main">(</span>length <span class="skolem">w</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">w</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">ν</span><span class="main">]</span><span class="main">)</span> <span class="main">⌢</span> <span class="main">(</span>iter <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
          <span class="keyword2"><span class="keyword">and</span></span><span class="quoted"><span class="quoted">"foldl <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="skolem">w</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">ν</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> foldl <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>prefix <span class="main">(</span>length <span class="main">(</span><span class="skolem">w</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">ν</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">w</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">ν</span><span class="main">]</span><span class="main">)</span> <span class="main">⌢</span> <span class="main">(</span>iter <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"range <span class="main">(</span><span class="main">(</span><span class="skolem">w</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">ν</span><span class="main">]</span><span class="main">)</span> <span class="main">⌢</span> <span class="main">(</span>iter <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Σ</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> prefix_conc_length conc_conc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> iter_def<span class="main">)</span>
             <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subsequence_def conc_def upt_Suc_append<span class="main"><span class="main">[</span></span><span class="operator">OF</span> le0<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">w</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">ν</span><span class="main">]</span><span class="main">)</span> <span class="main">⌢</span> <span class="main">(</span>iter <span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">ν</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conc_def<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">w'</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span>foldl <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">w</span><span class="main">,</span> <span class="skolem">ν</span><span class="main">,</span> foldl <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="skolem">w</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">ν</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> run<span class="hidden">⇩</span><sub>t</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">w'</span> <span class="bound">n</span> <span class="main">∧</span> range <span class="bound">w'</span> <span class="main">⊆</span> <span class="free">Σ</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> run<span class="hidden">⇩</span><sub>t</sub>_foldl length_append_singleton subsequence_def<span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⊇</span> <span class="var">?rhs</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> reach<span class="hidden">⇩</span><sub>t</sub>_def run<span class="hidden">⇩</span><sub>t</sub>.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">unfold</span> reach<span class="hidden">⇩</span><sub>t</sub>_def run<span class="hidden">⇩</span><sub>t</sub>_foldl<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upt_Suc_append<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach<span class="hidden">⇩</span><sub>t</sub>_def<span class="main">)</span>

<span class="keyword1" id="DTS-reach_card_0"><span class="command">lemma</span></span> reach_card_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Σ</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>reach <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⟷</span> card <span class="main">(</span>reach <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>run <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">w</span> <span class="bound">n</span> <span class="main">|</span> <span class="bound">w</span> <span class="bound">n</span><span class="main">.</span> range <span class="bound">w</span> <span class="main">⊆</span> <span class="free">Σ</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> reach_def card_eq_0_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DTS-reach"><span class="command">lemma</span></span> reach<span class="hidden">⇩</span><sub>t</sub>_card_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Σ</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⟷</span> card <span class="main">(</span>reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>run<span class="hidden">⇩</span><sub>t</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">w</span> <span class="bound">n</span> <span class="main">|</span> <span class="bound">w</span> <span class="bound">n</span><span class="main">.</span> range <span class="bound">w</span> <span class="main">⊆</span> <span class="free">Σ</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> reach<span class="hidden">⇩</span><sub>t</sub>_def card_eq_0_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Relation to runs›</span></span>

<span class="keyword1" id="DTS-run_subseteq_reach"><span class="command">lemma</span></span> run_subseteq_reach<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"range <span class="free">w</span> <span class="main">⊆</span> <span class="free">Σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"range <span class="main">(</span>run <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">w</span><span class="main">)</span> <span class="main">⊆</span> reach <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"range <span class="main">(</span>run<span class="hidden">⇩</span><sub>t</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">w</span><span class="main">)</span> <span class="main">⊆</span> reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> reach_def reach<span class="hidden">⇩</span><sub>t</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="DTS-limit_subseteq_reach"><span class="command">lemma</span></span> limit_subseteq_reach<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"range <span class="free">w</span> <span class="main">⊆</span> <span class="free">Σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"limit <span class="main">(</span>run <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">w</span><span class="main">)</span> <span class="main">⊆</span> reach <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"limit <span class="main">(</span>run<span class="hidden">⇩</span><sub>t</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">w</span><span class="main">)</span> <span class="main">⊆</span> reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> run_subseteq_reach<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> limit_in_range <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="DTS-run"><span class="command">lemma</span></span> run<span class="hidden">⇩</span><sub>t</sub>_finite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reach <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"range <span class="free">w</span> <span class="main">⊆</span> <span class="free">Σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≡</span> run<span class="hidden">⇩</span><sub>t</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>reach <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">×</span> <span class="free">Σ</span> <span class="main">×</span> <span class="main">(</span>reach <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">w</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">Σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> set <span class="main">(</span>map <span class="free">w</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">i</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Σ</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹range <span class="free">w</span> <span class="main">⊆</span> <span class="free">Σ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="free">r</span> <span class="bound">n</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> run<span class="hidden">⇩</span><sub>t</sub>.simps run_foldl reach_foldl_def<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">Σ</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span><span class="main">]</span> r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"range <span class="free">r</span> <span class="main">⊆</span> <span class="var">?S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Compute reach Using DFS›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Q<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> DTS <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Q<span class="hidden">⇩</span><sub>L</sub></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">≠</span> <span class="main">[]</span> <span class="keyword1">then</span> gen_dfs <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> map <span class="main">(</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="bound">q</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> Set.insert <span class="main">(∈)</span> <span class="main">{}</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">list_dfs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> transition <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> transition list<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> transition list <span class="main">=&gt;</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> transition list <span class="main">=&gt;</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> transition list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">list_dfs</span> <span class="free"><span class="bound"><span class="entity">succ</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">start</span></span></span> <span class="main">≡</span> gen_dfs <span class="free"><span class="bound"><span class="entity">succ</span></span></span> List.insert <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="bound">xs</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">start</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">δ<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> DTS <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> transition set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">δ<span class="hidden">⇩</span><sub>L</sub></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">=</span> set <span class="main">(</span> 
    <span class="keyword1">let</span> 
      <span class="bound">start</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">ν</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="bound">ν</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="bound">ν</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">;</span> 
      <span class="bound">succ</span> <span class="main">=</span> <span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">ν</span><span class="main">.</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">ν</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="bound">q</span> <span class="bound">ν</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span>
    <span class="keyword1">in</span> 
      <span class="main">(</span>list_dfs <span class="bound">succ</span> <span class="main">[]</span> <span class="bound">start</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="DTS-Q"><span class="command">lemma</span></span> Q<span class="hidden">⇩</span><sub>L</sub>_reach<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reach <span class="main">(</span>set <span class="free">Σ</span><span class="main">)</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Q<span class="hidden">⇩</span><sub>L</sub> <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> reach <span class="main">(</span>set <span class="free">Σ</span><span class="main">)</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">Σ</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> reach_redef<span class="main">:</span> <span class="quoted"><span class="quoted">"reach <span class="main">(</span>set <span class="free">Σ</span><span class="main">)</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="main">{</span>foldl <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">w</span> <span class="main">|</span> <span class="bound">w</span><span class="main">.</span> set <span class="bound">w</span> <span class="main">⊆</span> set <span class="free">Σ</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> reach_foldl_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"set <span class="free">Σ</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> set_empty<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">Σ</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">w</span> <span class="skolem">y</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">w</span> <span class="main">⊆</span> set <span class="free">Σ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> foldl <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span><span class="free">δ</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">Σ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ν</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">x</span> <span class="skolem">ν</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ν</span> <span class="main">∈</span> set <span class="free">Σ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> foldl <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="skolem">w</span><span class="main">@</span><span class="main">[</span><span class="skolem">ν</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="skolem">w</span><span class="main">@</span><span class="main">[</span><span class="skolem">ν</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">Σ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">w'</span><span class="main">.</span> set <span class="bound">w'</span> <span class="main">⊆</span> set <span class="free">Σ</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">=</span> foldl  <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">w'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> extend_run <span class="main">=</span> this
    
    <span class="keyword1"><span class="command">interpret</span></span> DFS <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">q</span><span class="main">.</span> map <span class="main">(</span><span class="free">δ</span> <span class="bound">q</span><span class="main">)</span> <span class="free">Σ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> reach <span class="main">(</span>set <span class="free">Σ</span><span class="main">)</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">S</span><span class="main">.</span> <span class="bound">S</span> <span class="main">⊆</span> reach <span class="main">(</span>set <span class="free">Σ</span><span class="main">)</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted">Set.insert</span> <span class="quoted"><span class="quoted">"<span class="main">(∈)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="quoted">id</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> member_rec reach_redef list_all_iff <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> extend_run<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> extend_run image_eqI set_map<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> reach_redef<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

    <span class="keyword1"><span class="command">have</span></span> Nil1<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">[]</span> <span class="main">⊆</span> set <span class="free">Σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Nil2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> foldl <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> list_all_init<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> reach <span class="main">(</span>set <span class="free">Σ</span><span class="main">)</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">[</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> list_all_iff list.set reach_redef <span class="keyword1"><span class="command">using</span></span> Nil1 Nil2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reach <span class="main">(</span>set <span class="free">Σ</span><span class="main">)</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊆</span> reachable <span class="main">{</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">rule</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> 
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> reach <span class="main">(</span>set <span class="free">Σ</span><span class="main">)</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> foldl <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">w</span> <span class="main">⊆</span> set <span class="free">Σ</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> reach_redef <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"foldl <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">w</span> <span class="main">∈</span> reachable <span class="main">{</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">ν</span> <span class="skolem">w</span><span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"foldl <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">w</span> <span class="main">∈</span> reachable <span class="main">{</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">(</span>foldl <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">w</span><span class="main">)</span> <span class="skolem">ν</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span><span class="free">δ</span> <span class="main">(</span>foldl <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">w</span><span class="main">)</span><span class="main">)</span> <span class="free">Σ</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rtrancl.rtrancl_into_rtrancl reachable_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reachable_def<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> reachable <span class="main">{</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">{</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span> <span class="main">⊆</span> reach <span class="main">(</span>set <span class="free">Σ</span><span class="main">)</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">rule</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> 
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> reachable <span class="main">{</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span><span class="free">δ</span> <span class="bound">x</span><span class="main">)</span> <span class="free">Σ</span><span class="main">)</span><span class="main">}</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> reachable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> reach <span class="main">(</span>set <span class="free">Σ</span><span class="main">)</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> reach_redef Nil1 Nil2<span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> r_into_rtrancl succsr_def succsr_isNode<span class="main">)</span> 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> reachable_redef<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="main">{</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span> <span class="main">=</span> reach <span class="main">(</span>set <span class="free">Σ</span><span class="main">)</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">moreover</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="main">{</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span> <span class="main">⊆</span> Q<span class="hidden">⇩</span><sub>L</sub> <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> reachable_imp_dfs<span class="main">[</span><span class="operator">OF</span> _ list_all_init<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> list.set reachable_redef
      <span class="keyword1"><span class="command">unfolding</span></span>  reach_redef Q<span class="hidden">⇩</span><sub>L</sub>_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Σ</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">moreover</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Q<span class="hidden">⇩</span><sub>L</sub> <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊆</span> reach <span class="main">(</span>set <span class="free">Σ</span><span class="main">)</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> dfs_invariant<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> _ list_all_init<span class="main">]</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_redef Q<span class="hidden">⇩</span><sub>L</sub>_def<span class="main">)</span>

    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">Σ</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> dfs_invariant<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> _ list_all_init<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_def Q<span class="hidden">⇩</span><sub>L</sub>_def<span class="main">)</span>

<span class="keyword1" id="DTS-δ"><span class="command">lemma</span></span> δ<span class="hidden">⇩</span><sub>L</sub>_reach<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reach<span class="hidden">⇩</span><sub>t</sub> <span class="main">(</span>set <span class="free">Σ</span><span class="main">)</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"δ<span class="hidden">⇩</span><sub>L</sub> <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> reach<span class="hidden">⇩</span><sub>t</sub> <span class="main">(</span>set <span class="free">Σ</span><span class="main">)</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">w</span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">w</span> <span class="main">⊆</span> set <span class="free">Σ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> foldl <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span><span class="free">δ</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">Σ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ν</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">x</span> <span class="skolem">ν</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ν</span> <span class="main">∈</span> set <span class="free">Σ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> foldl <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="skolem">w</span><span class="main">@</span><span class="main">[</span><span class="skolem">ν</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="skolem">w</span><span class="main">@</span><span class="main">[</span><span class="skolem">ν</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> set <span class="free">Σ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">w'</span><span class="main">.</span> set <span class="bound">w'</span> <span class="main">⊆</span> set <span class="free">Σ</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">=</span> foldl  <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">w'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> extend_run <span class="main">=</span> this

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?succs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">ν</span><span class="main">.</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">ν</span><span class="main">,</span> <span class="free">δ</span> <span class="bound">q</span> <span class="bound">ν</span><span class="main">)</span><span class="main">)</span> <span class="free">Σ</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">interpret</span></span> DFS <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">ν</span><span class="main">.</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">ν</span><span class="main">,</span> <span class="free">δ</span> <span class="bound">q</span> <span class="bound">ν</span><span class="main">)</span><span class="main">)</span> <span class="free">Σ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> reach<span class="hidden">⇩</span><sub>t</sub> <span class="main">(</span>set <span class="free">Σ</span><span class="main">)</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">S</span><span class="main">.</span> set <span class="bound">S</span> <span class="main">⊆</span> reach<span class="hidden">⇩</span><sub>t</sub> <span class="main">(</span>set <span class="free">Σ</span><span class="main">)</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted">List.insert</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">xs</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="bound">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="quoted">id</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> member_rec reach<span class="hidden">⇩</span><sub>t</sub>_foldl_def list_all_iff <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> extend_run<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> extend_run image_eqI set_map<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span>  assms <span class="keyword1"><span class="command">unfolding</span></span> reach<span class="hidden">⇩</span><sub>t</sub>_foldl_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> Nil1<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">[]</span> <span class="main">⊆</span> set <span class="free">Σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Nil2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> foldl <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> list_all_init<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> reach<span class="hidden">⇩</span><sub>t</sub> <span class="main">(</span>set <span class="free">Σ</span><span class="main">)</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">ν</span><span class="main">.</span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="bound">ν</span><span class="main">,</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">ν</span><span class="main">)</span><span class="main">)</span> <span class="free">Σ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> list_all_iff reach<span class="hidden">⇩</span><sub>t</sub>_foldl_def set_map image_def <span class="keyword1"><span class="command">using</span></span> Nil2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">ν</span><span class="main">.</span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="bound">ν</span><span class="main">,</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">ν</span><span class="main">)</span><span class="main">)</span> <span class="free">Σ</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="skolem">ν</span> <span class="skolem">q'</span>  
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">q</span><span class="main">,</span> <span class="skolem">ν</span><span class="main">,</span> <span class="skolem">q'</span><span class="main">)</span> <span class="main">∈</span> reach<span class="hidden">⇩</span><sub>t</sub> <span class="main">(</span>set <span class="free">Σ</span><span class="main">)</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> q_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> foldl <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> q'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">=</span> foldl <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="skolem">w</span><span class="main">@</span><span class="main">[</span><span class="skolem">ν</span><span class="main">]</span><span class="main">)</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">w</span> <span class="main">⊆</span> set <span class="free">Σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ν</span> <span class="main">∈</span> set <span class="free">Σ</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> reach<span class="hidden">⇩</span><sub>t</sub>_foldl_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>foldl <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">w</span><span class="main">,</span> <span class="skolem">ν</span><span class="main">,</span> foldl <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="skolem">w</span><span class="main">@</span><span class="main">[</span><span class="skolem">ν</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> reachable <span class="var">?q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">q</span></span> <span class="quoted"><span class="skolem">q'</span></span> <span class="quoted"><span class="skolem">ν</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">ν'</span> <span class="skolem">w</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>foldl <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">w</span><span class="main">,</span> <span class="skolem">ν'</span><span class="main">,</span> foldl <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="skolem">w</span><span class="main">@</span><span class="main">[</span><span class="skolem">ν'</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> reachable <span class="var">?q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?q</span><span class="main">,</span> <span class="skolem">ν'</span><span class="main">,</span> <span class="var">?q'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span><span class="main">.</span> <span class="free">δ</span> <span class="bound">q</span> <span class="skolem">ν</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span><span class="free">δ</span> <span class="bound">q</span><span class="main">)</span> <span class="free">Σ</span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ν</span> <span class="main">∈</span> set <span class="free">Σ</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="main">(</span><span class="var">?q</span><span class="main">,</span> <span class="skolem">ν'</span><span class="main">,</span> <span class="var">?q'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span><span class="var">?succs</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="var">?q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> reachable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="var">?q</span><span class="main">,</span> <span class="skolem">ν'</span><span class="main">,</span> <span class="var">?q'</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="var">?q'</span><span class="main">,</span> <span class="skolem">ν</span><span class="main">,</span> <span class="free">δ</span> <span class="var">?q'</span> <span class="skolem">ν</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span><span class="var">?succs</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> snoc <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">q</span><span class="main">.</span> <span class="free">δ</span> <span class="bound">q</span> <span class="skolem">ν</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span><span class="free">δ</span> <span class="bound">q</span><span class="main">)</span> <span class="free">Σ</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> rtrancl.rtrancl_into_rtrancl<span class="main">[</span><span class="operator">OF</span> 1 3<span class="main">]</span> 2 <span class="keyword1"><span class="command">unfolding</span></span> reachable_def foldl_append foldl.simps  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reachable_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">q</span><span class="main">,</span> <span class="skolem">ν</span><span class="main">,</span> <span class="skolem">q'</span><span class="main">)</span> <span class="main">∈</span> reachable <span class="var">?q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> q_def q'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"reach<span class="hidden">⇩</span><sub>t</sub> <span class="main">(</span>set <span class="free">Σ</span><span class="main">)</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊆</span> reachable <span class="var">?q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>  
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> reachable <span class="var">?q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> 
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span> <span class="main">⇒</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">ν</span><span class="main">.</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">ν</span><span class="main">,</span> <span class="free">δ</span> <span class="bound">q</span> <span class="bound">ν</span><span class="main">)</span><span class="main">)</span> <span class="free">Σ</span><span class="main">)</span><span class="main">}</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> reachable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> reach<span class="hidden">⇩</span><sub>t</sub> <span class="main">(</span>set <span class="free">Σ</span><span class="main">)</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
      <span class="keyword3"><span class="command">case</span></span> base
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="bound">ps</span><span class="main">.</span> list_all <span class="bound">p</span> <span class="bound">ps</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">pa</span><span class="main">.</span> <span class="bound">pa</span> <span class="main">∈</span> set <span class="bound">ps</span> <span class="main">⟶</span> <span class="bound">p</span> <span class="bound">pa</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> list_all_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span>foldl <span class="free">δ</span> <span class="main">(</span>foldl <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">[]</span><span class="main">)</span> <span class="bound">bs</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> foldl <span class="free">δ</span> <span class="main">(</span>foldl <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">[]</span><span class="main">)</span> <span class="main">(</span><span class="bound">bs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">b</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">bs</span> <span class="bound">b</span><span class="main">.</span> set <span class="bound">bs</span> <span class="main">⊆</span> set <span class="free">Σ</span> <span class="main">∧</span> <span class="bound">b</span> <span class="main">∈</span> set <span class="free">Σ</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> base <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Nil2 list_all_init reach<span class="hidden">⇩</span><sub>t</sub>_foldl_def<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> reach<span class="hidden">⇩</span><sub>t</sub>_foldl_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">x'</span> <span class="skolem">y'</span><span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> succsr_def succsr_isNode <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"reachable <span class="var">?q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊆</span> reach<span class="hidden">⇩</span><sub>t</sub> <span class="main">(</span>set <span class="free">Σ</span><span class="main">)</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> reachable_redef<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="var">?q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> reach<span class="hidden">⇩</span><sub>t</sub> <span class="main">(</span>set <span class="free">Σ</span><span class="main">)</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">moreover</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reachable <span class="var">?q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊆</span> <span class="main">(</span>δ<span class="hidden">⇩</span><sub>L</sub> <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reachable_imp_dfs<span class="main">[</span><span class="operator">OF</span> _ list_all_init<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> δ<span class="hidden">⇩</span><sub>L</sub>_def reachable_redef list_dfs_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span><span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"δ<span class="hidden">⇩</span><sub>L</sub> <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊆</span> reach<span class="hidden">⇩</span><sub>t</sub> <span class="main">(</span>set <span class="free">Σ</span><span class="main">)</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dfs_invariant<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> _ list_all_init<span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach<span class="hidden">⇩</span><sub>t</sub>_foldl_def δ<span class="hidden">⇩</span><sub>L</sub>_def list_dfs_def<span class="main">)</span>

  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DTS-reach_reach"><span class="command">lemma</span></span> reach_reach<span class="hidden">⇩</span><sub>t</sub>_fst<span class="main">:</span>
  <span class="quoted"><span class="quoted">"reach <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> fst <span class="main">`</span> reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> reach<span class="hidden">⇩</span><sub>t</sub>_def reach_def image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="DTS-finite_reach"><span class="command">lemma</span></span> finite_reach<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">⟹</span> finite <span class="main">(</span>reach <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_reach<span class="hidden">⇩</span><sub>t</sub>_fst<span class="main">)</span>

<span class="keyword1" id="DTS-finite_reach"><span class="command">lemma</span></span> finite_reach<span class="hidden">⇩</span><sub>t</sub><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reach <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⊆</span> reach <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">×</span> <span class="free">Σ</span> <span class="main">×</span> reach <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> reach<span class="hidden">⇩</span><sub>t</sub>_def reach_def run<span class="hidden">⇩</span><sub>t</sub>.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DTS-Q"><span class="command">lemma</span></span> Q<span class="hidden">⇩</span><sub>L</sub>_eq_δ<span class="hidden">⇩</span><sub>L</sub><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reach<span class="hidden">⇩</span><sub>t</sub> <span class="main">(</span>set <span class="free">Σ</span><span class="main">)</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Q<span class="hidden">⇩</span><sub>L</sub> <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> fst <span class="main">`</span> <span class="main">(</span>δ<span class="hidden">⇩</span><sub>L</sub> <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> set_map δ<span class="hidden">⇩</span><sub>L</sub>_reach<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> Q<span class="hidden">⇩</span><sub>L</sub>_reach<span class="main">[</span><span class="operator">OF</span> finite_reach<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">]</span> reach_reach<span class="hidden">⇩</span><sub>t</sub>_fst <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Product of DTS›</span></span> 

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">simple_product</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> DTS <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> DTS <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> DTS"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">×</span> _"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">δ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main"><span class="free">×</span></span> <span class="free"><span class="bound"><span class="entity">δ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">q<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">q<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="bound">ν</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">δ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="bound">q<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">ν</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">δ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="bound">q<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">ν</span><span class="main">)</span><span class="main">)</span>"</span></span>  

<span class="keyword1" id="DTS-simple_product_run"><span class="command">lemma</span></span> simple_product_run<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">δ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">δ<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">w</span> <span class="free">q<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">q<span class="hidden">⇩</span><sub>2</sub></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">≡</span> run <span class="main">(</span><span class="free">δ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">×</span> <span class="free">δ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">q<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≡</span> run <span class="free">δ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">q<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≡</span> run <span class="free">δ<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">q<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">ρ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">i</span><span class="main">,</span> <span class="free">ρ<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> finite_reach_simple_product<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reach <span class="free">Σ</span> <span class="free">δ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">q<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reach <span class="free">Σ</span> <span class="free">δ<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">q<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reach <span class="free">Σ</span> <span class="main">(</span><span class="free">δ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">×</span> <span class="free">δ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">q<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reach <span class="free">Σ</span> <span class="main">(</span><span class="free">δ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">×</span> <span class="free">δ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">q<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">⊆</span> reach <span class="free">Σ</span> <span class="free">δ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">q<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">×</span> reach <span class="free">Σ</span> <span class="free">δ<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">q<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> reach_def simple_product_run <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹(Generalised) Product of DTS›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">product</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> DTS<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> DTS"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">Δ<span class="hidden">⇩</span><sub>×</sub></span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">Δ<span class="hidden">⇩</span><sub>×</sub></span></span> <span class="free"><span class="bound"><span class="entity">δ<span class="hidden">⇩</span><sub>m</sub></span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">q</span> <span class="bound">ν</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">q</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> None <span class="main">|</span> Some <span class="bound">y</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">δ<span class="hidden">⇩</span><sub>m</sub></span></span></span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">ν</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>  

<span class="keyword1" id="DTS-product_run_None"><span class="command">lemma</span></span> product_run_None<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ι<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">w</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">≡</span> run <span class="main">(</span><span class="keyword1">Δ<span class="hidden">⇩</span><sub>×</sub></span> <span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span> <span class="free">ι<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ι<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">k</span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="free">i</span> <span class="free">k</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="DTS-product_run_Some"><span class="command">lemma</span></span> product_run_Some<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ι<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">w</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">k</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">≡</span> run <span class="main">(</span><span class="keyword1">Δ<span class="hidden">⇩</span><sub>×</sub></span> <span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span> <span class="free">ι<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ'</span> <span class="main">≡</span> run <span class="main">(</span><span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">k</span><span class="main">)</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ι<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="free">i</span> <span class="free">k</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">ρ'</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> finite_reach_product<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>dom <span class="free">ι<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> dom <span class="free">ι<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">⟹</span> finite <span class="main">(</span>reach <span class="free">Σ</span> <span class="main">(</span><span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span><span class="free">ι<span class="hidden">⇩</span><sub>m</sub></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reach <span class="free">Σ</span> <span class="main">(</span><span class="keyword1">Δ<span class="hidden">⇩</span><sub>×</sub></span> <span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span> <span class="free">ι<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"dom <span class="free">ι<span class="hidden">⇩</span><sub>m</sub></span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ι<span class="hidden">⇩</span><sub>m</sub></span></span><span class="main">)</span> 
  <span class="keyword3"><span class="command">case</span></span> empty
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ι<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">=</span> Map.empty"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span> <span class="bound">i</span><span class="main">.</span> run <span class="main">(</span><span class="keyword1">Δ<span class="hidden">⇩</span><sub>×</sub></span> <span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span> <span class="skolem">ι<span class="hidden">⇩</span><sub>m</sub></span> <span class="bound">w</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> None<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> product_run_None <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> reach_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">k</span> <span class="skolem">K</span><span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">q</span> <span class="main">::</span> <span class="tfree">'b</span><span class="main">,</span> <span class="bound">m</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span><span class="main">)</span><span class="main">.</span> <span class="bound">m</span><span class="main">(</span><span class="skolem">k</span> <span class="main">:=</span> Some <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Reach</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Reach</span> <span class="main">=</span> <span class="main">(</span>reach <span class="free">Σ</span> <span class="main">(</span><span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span><span class="skolem">ι<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="main">(</span>reach <span class="free">Σ</span> <span class="main">(</span><span class="keyword1">Δ<span class="hidden">⇩</span><sub>×</sub></span> <span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">ι<span class="hidden">⇩</span><sub>m</sub></span><span class="main">(</span><span class="skolem">k</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>reach <span class="free">Σ</span> <span class="main">(</span><span class="keyword1">Δ<span class="hidden">⇩</span><sub>×</sub></span> <span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span> <span class="skolem">ι<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span> <span class="main">⊆</span> <span class="skolem">f</span> <span class="main">`</span> <span class="skolem">Reach</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> reach <span class="free">Σ</span> <span class="main">(</span><span class="keyword1">Δ<span class="hidden">⇩</span><sub>×</sub></span> <span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span> <span class="skolem">ι<span class="hidden">⇩</span><sub>m</sub></span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> run <span class="main">(</span><span class="keyword1">Δ<span class="hidden">⇩</span><sub>×</sub></span> <span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span> <span class="skolem">ι<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">w</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"range <span class="skolem">w</span> <span class="main">⊆</span> <span class="free">Σ</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> reach_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k'</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">∉</span> dom <span class="skolem">ι<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="skolem">k'</span> <span class="main">=</span> run <span class="main">(</span><span class="keyword1">Δ<span class="hidden">⇩</span><sub>×</sub></span> <span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">ι<span class="hidden">⇩</span><sub>m</sub></span><span class="main">(</span><span class="skolem">k</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="skolem">w</span> <span class="skolem">n</span> <span class="skolem">k'</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> x_def dom_def <span class="keyword1"><span class="command">using</span></span> product_run_None<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">∈</span> dom <span class="skolem">ι<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">-</span> <span class="main">{</span><span class="skolem">k</span><span class="main">}</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="skolem">k'</span> <span class="main">=</span> run <span class="main">(</span><span class="keyword1">Δ<span class="hidden">⇩</span><sub>×</sub></span> <span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">ι<span class="hidden">⇩</span><sub>m</sub></span><span class="main">(</span><span class="skolem">k</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="skolem">w</span> <span class="skolem">n</span> <span class="skolem">k'</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> x_def dom_def <span class="keyword1"><span class="command">using</span></span> product_run_Some<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">≠</span> <span class="skolem">k</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="skolem">k'</span> <span class="main">=</span> run <span class="main">(</span><span class="keyword1">Δ<span class="hidden">⇩</span><sub>×</sub></span> <span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">ι<span class="hidden">⇩</span><sub>m</sub></span><span class="main">(</span><span class="skolem">k</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="skolem">w</span> <span class="skolem">n</span> <span class="skolem">k'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">(</span><span class="skolem">k</span> <span class="main">:=</span> None<span class="main">)</span> <span class="main">=</span> run <span class="main">(</span><span class="keyword1">Δ<span class="hidden">⇩</span><sub>×</sub></span> <span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">ι<span class="hidden">⇩</span><sub>m</sub></span><span class="main">(</span><span class="skolem">k</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="skolem">w</span> <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> product_run_None<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="skolem">k</span> <span class="main">=</span> Some <span class="main">(</span>run <span class="main">(</span><span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span><span class="skolem">ι<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">w</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> x_def <span class="keyword1"><span class="command">using</span></span> product_run_Some<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ι<span class="hidden">⇩</span><sub>m</sub></span></span> <span class="quoted"><span class="skolem">k</span></span> <span class="main">_</span> <span class="quoted"><span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span></span><span class="main">]</span> insert.hyps<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>the <span class="main">(</span><span class="skolem">x</span> <span class="skolem">k</span><span class="main">)</span><span class="main">,</span> <span class="skolem">x</span><span class="main">(</span><span class="skolem">k</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">Reach</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> Reach_def reach_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹range <span class="skolem">w</span> <span class="main">⊆</span> <span class="free">Σ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">(</span>the <span class="main">(</span><span class="skolem">x</span> <span class="skolem">k</span><span class="main">)</span><span class="main">,</span> <span class="skolem">x</span><span class="main">(</span><span class="skolem">k</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="skolem">k</span> <span class="main">=</span> Some <span class="main">(</span>run <span class="main">(</span><span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span><span class="skolem">ι<span class="hidden">⇩</span><sub>m</sub></span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">w</span> <span class="skolem">n</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">f</span> <span class="main">`</span> <span class="skolem">Reach</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reach <span class="free">Σ</span> <span class="main">(</span><span class="keyword1">Δ<span class="hidden">⇩</span><sub>×</sub></span> <span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">ι<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="skolem">k</span> <span class="main">:=</span> None<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> insert insert<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">ι<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span><span class="skolem">k</span><span class="main">:=</span>None<span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">Reach</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> insert Reach_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="skolem">Reach</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">..</span></span> 
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Simple Product Construction Helper Functions and Lemmas›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">embed_transition_fst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> transition <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> transition set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">embed_transition_fst</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">q'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q'</span></span></span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> True<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">embed_transition_snd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> transition <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> transition set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">embed_transition_snd</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">q'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">,</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">q'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> True<span class="main">}</span>"</span></span>

<span class="keyword1" id="DTS-embed_transition_snd_unfold"><span class="command">lemma</span></span> embed_transition_snd_unfold<span class="main">:</span>
  <span class="quoted"><span class="quoted">"embed_transition_snd <span class="free">t</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> fst <span class="free">t</span><span class="main">)</span><span class="main">,</span> fst <span class="main">(</span>snd <span class="free">t</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> snd <span class="main">(</span>snd <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> True<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> embed_transition_snd.simps<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">project_transition_fst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> transition <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> transition"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">project_transition_fst</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">,</span> fst <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">project_transition_snd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> transition <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> transition"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">project_transition_snd</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">,</span> snd <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">δ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">δ<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">w</span> <span class="free">q<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">q<span class="hidden">⇩</span><sub>2</sub></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">≡</span> run<span class="hidden">⇩</span><sub>t</sub> <span class="main">(</span><span class="free">δ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">×</span> <span class="free">δ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">q<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≡</span> run<span class="hidden">⇩</span><sub>t</sub> <span class="free">δ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">q<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≡</span> run<span class="hidden">⇩</span><sub>t</sub> <span class="free">δ<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">q<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> product_run_project_fst<span class="main">:</span> <span class="quoted"><span class="quoted">"project_transition_fst <span class="main">(</span><span class="free">ρ</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">ρ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">i</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> product_run_project_snd<span class="main">:</span> <span class="quoted"><span class="quoted">"project_transition_snd <span class="main">(</span><span class="free">ρ</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">ρ<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">i</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> product_run_embed_fst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="free">i</span> <span class="main">∈</span> embed_transition_fst <span class="main">(</span><span class="free">ρ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> product_run_embed_snd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="free">i</span> <span class="main">∈</span> embed_transition_snd <span class="main">(</span><span class="free">ρ<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> assms run<span class="hidden">⇩</span><sub>t</sub>.simps simple_product_run <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">δ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">δ<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">w</span> <span class="free">q<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">q<span class="hidden">⇩</span><sub>2</sub></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">≡</span> run<span class="hidden">⇩</span><sub>t</sub> <span class="main">(</span><span class="free">δ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">×</span> <span class="free">δ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">q<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≡</span> run<span class="hidden">⇩</span><sub>t</sub> <span class="free">δ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">q<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≡</span> run<span class="hidden">⇩</span><sub>t</sub> <span class="free">δ<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">q<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="free">ρ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> product_run_finite_fst<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="free">ρ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> product_run_finite_snd<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="free">ρ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> project_transition_fst <span class="main">(</span><span class="free">ρ</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">ρ<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">k</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> project_transition_snd <span class="main">(</span><span class="free">ρ</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">ρ<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">k</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> assms product_run_project_fst product_run_project_snd <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"project_transition_fst <span class="main">`</span> range <span class="free">ρ</span> <span class="main">=</span> range <span class="free">ρ<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"project_transition_snd <span class="main">`</span> range <span class="free">ρ</span> <span class="main">=</span> range <span class="free">ρ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> range_composition<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted">project_transition_fst</span> <span class="quoted"><span class="free">ρ</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> range_composition<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted">project_transition_snd</span> <span class="quoted"><span class="free">ρ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="free">ρ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="free">ρ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms finite_imageI <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">δ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">δ<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">w</span> <span class="free">q<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">q<span class="hidden">⇩</span><sub>2</sub></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">≡</span> run<span class="hidden">⇩</span><sub>t</sub> <span class="main">(</span><span class="free">δ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">×</span> <span class="free">δ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">q<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≡</span> run<span class="hidden">⇩</span><sub>t</sub> <span class="free">δ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">q<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="free">ρ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> product_run_project_limit_fst<span class="main">:</span> <span class="quoted"><span class="quoted">"project_transition_fst <span class="main">`</span> limit <span class="free">ρ</span> <span class="main">=</span> limit <span class="free">ρ<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> product_run_embed_limit_fst<span class="main">:</span> <span class="quoted"><span class="quoted">"limit <span class="free">ρ</span> <span class="main">⊆</span> <span class="main">⋃</span> <span class="main">(</span>embed_transition_fst <span class="main">`</span> <span class="main">(</span>limit <span class="free">ρ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="free">ρ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms product_run_finite_fst <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"limit <span class="free">ρ</span> <span class="main">=</span> range <span class="main">(</span>suffix <span class="skolem">i</span> <span class="free">ρ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"limit <span class="free">ρ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> range <span class="main">(</span>suffix <span class="skolem">i</span> <span class="free">ρ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> common_range_limit assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> project_transition_fst <span class="main">(</span>suffix <span class="skolem">i</span> <span class="free">ρ</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>suffix <span class="skolem">i</span> <span class="free">ρ<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> assms run<span class="hidden">⇩</span><sub>t</sub>.simps<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> ρ<span class="hidden">⇩</span><sub>1</sub>_def product_run_project_fst suffix_nth<span class="main">)</span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"project_transition_fst <span class="main">`</span> range <span class="main">(</span>suffix <span class="skolem">i</span> <span class="free">ρ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>range <span class="main">(</span>suffix <span class="skolem">i</span> <span class="free">ρ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> range_composition<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"project_transition_fst"</span></span> <span class="quoted"><span class="quoted">"suffix <span class="skolem">i</span> <span class="free">ρ</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span>suffix <span class="skolem">i</span> <span class="free">ρ</span> <span class="bound">k</span><span class="main">)</span> <span class="main">∈</span> embed_transition_fst <span class="main">(</span>suffix <span class="skolem">i</span> <span class="free">ρ<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms product_run_embed_fst <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"project_transition_fst <span class="main">`</span> limit <span class="free">ρ</span> <span class="main">=</span> limit <span class="free">ρ<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"limit <span class="free">ρ</span> <span class="main">⊆</span> <span class="main">⋃</span> <span class="main">(</span>embed_transition_fst <span class="main">`</span> <span class="main">(</span>limit <span class="free">ρ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">δ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">δ<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">w</span> <span class="free">q<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">q<span class="hidden">⇩</span><sub>2</sub></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">≡</span> run<span class="hidden">⇩</span><sub>t</sub> <span class="main">(</span><span class="free">δ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">×</span> <span class="free">δ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">q<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≡</span> run<span class="hidden">⇩</span><sub>t</sub> <span class="free">δ<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">q<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="free">ρ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> product_run_project_limit_snd<span class="main">:</span> <span class="quoted"><span class="quoted">"project_transition_snd <span class="main">`</span> limit <span class="free">ρ</span> <span class="main">=</span> limit <span class="free">ρ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> product_run_embed_limit_snd<span class="main">:</span> <span class="quoted"><span class="quoted">"limit <span class="free">ρ</span> <span class="main">⊆</span> <span class="main">⋃</span> <span class="main">(</span>embed_transition_snd <span class="main">`</span> <span class="main">(</span>limit <span class="free">ρ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="free">ρ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms product_run_finite_snd <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"limit <span class="free">ρ</span> <span class="main">=</span> range <span class="main">(</span>suffix <span class="skolem">i</span> <span class="free">ρ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"limit <span class="free">ρ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> range <span class="main">(</span>suffix <span class="skolem">i</span> <span class="free">ρ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> common_range_limit assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> project_transition_snd <span class="main">(</span>suffix <span class="skolem">i</span> <span class="free">ρ</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>suffix <span class="skolem">i</span> <span class="free">ρ<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> assms run<span class="hidden">⇩</span><sub>t</sub>.simps<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> ρ<span class="hidden">⇩</span><sub>2</sub>_def product_run_project_snd suffix_nth<span class="main">)</span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"project_transition_snd <span class="main">`</span> range <span class="main">(</span><span class="main">(</span>suffix <span class="skolem">i</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>range <span class="main">(</span>suffix <span class="skolem">i</span> <span class="free">ρ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> range_composition<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"project_transition_snd"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>suffix <span class="skolem">i</span> <span class="free">ρ</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span>suffix <span class="skolem">i</span> <span class="free">ρ</span> <span class="bound">k</span><span class="main">)</span> <span class="main">∈</span> embed_transition_snd <span class="main">(</span>suffix <span class="skolem">i</span> <span class="free">ρ<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms product_run_embed_snd <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"project_transition_snd <span class="main">`</span> limit <span class="free">ρ</span> <span class="main">=</span> limit <span class="free">ρ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"limit <span class="free">ρ</span> <span class="main">⊆</span> <span class="main">⋃</span> <span class="main">(</span>embed_transition_snd <span class="main">`</span> <span class="main">(</span>limit <span class="free">ρ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">δ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">δ<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">w</span> <span class="free">q<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">q<span class="hidden">⇩</span><sub>2</sub></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">≡</span> run<span class="hidden">⇩</span><sub>t</sub> <span class="main">(</span><span class="free">δ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">×</span> <span class="free">δ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">q<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≡</span> run<span class="hidden">⇩</span><sub>t</sub> <span class="free">δ<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">q<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">≡</span> run<span class="hidden">⇩</span><sub>t</sub> <span class="free">δ<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">q<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="free">ρ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> product_run_embed_limit_finiteness_fst<span class="main">:</span> <span class="quoted"><span class="quoted">"limit <span class="free">ρ</span> <span class="main">∩</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>embed_transition_fst <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> limit <span class="free">ρ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∩</span> <span class="free">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis1</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> product_run_embed_limit_finiteness_snd<span class="main">:</span> <span class="quoted"><span class="quoted">"limit <span class="free">ρ</span> <span class="main">∩</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>embed_transition_snd <span class="main">`</span> <span class="free">S'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> limit <span class="free">ρ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∩</span> <span class="free">S'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis2</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis1</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms product_run_project_limit_fst <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis2</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms product_run_project_limit_snd <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Product Construction Helper Functions and Lemmas›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">embed_transition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> transition <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> transition set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">↿⇩</span>_"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">↿⇩</span></span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">q'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">m</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">,</span> <span class="bound">m'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">m</span> <span class="bound">m'</span><span class="main">.</span> <span class="bound">m</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">∧</span> <span class="bound">m'</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">q'</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">project_transition</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> transition <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> transition"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⇃⇩</span>_"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⇃⇩</span></span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">,</span> the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">embed_pair</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> transition set <span class="main">×</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> transition set<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> transition set <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> transition set<span class="main">)</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>↿</b>⇩</span>_"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free"><span class="hidden">❙</span><b>↿</b>⇩</span></span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">S'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="main">↿⇩</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">⋃</span><span class="main">(</span><span class="main">↿⇩</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">S'</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">project_pair</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> transition set <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> transition set<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> transition set <span class="main">×</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> transition set<span class="main">)</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>⇃</b>⇩</span>_"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free"><span class="hidden">❙</span><b>⇃</b>⇩</span></span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">S'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⇃⇩</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">,</span> <span class="main">⇃⇩</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">S'</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1" id="DTS-embed_transition_unfold"><span class="command">lemma</span></span> embed_transition_unfold<span class="main">:</span>
  <span class="quoted"><span class="quoted">"embed_transition <span class="free">x</span> <span class="free">t</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">m</span><span class="main">,</span> fst <span class="main">(</span>snd <span class="free">t</span><span class="main">)</span><span class="main">,</span> <span class="bound">m'</span><span class="main">)</span> <span class="main">|</span> <span class="bound">m</span> <span class="bound">m'</span><span class="main">.</span> <span class="bound">m</span> <span class="free">x</span> <span class="main">=</span> Some <span class="main">(</span>fst <span class="free">t</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">m'</span> <span class="free">x</span> <span class="main">=</span> Some <span class="main">(</span>snd <span class="main">(</span>snd <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> embed_transition.simps<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ι<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">w</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">≡</span> run<span class="hidden">⇩</span><sub>t</sub> <span class="main">(</span><span class="keyword1">Δ<span class="hidden">⇩</span><sub>×</sub></span> <span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span> <span class="free">ι<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ'</span> <span class="main">≡</span> run<span class="hidden">⇩</span><sub>t</sub> <span class="main">(</span><span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">x</span><span class="main">)</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ι<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> product_run_project<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⇃⇩</span><span class="free">x</span> <span class="main">(</span><span class="free">ρ</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">ρ'</span> <span class="free">i</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> product_run_embed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="free">i</span> <span class="main">∈</span> <span class="main">↿⇩</span><span class="free">x</span> <span class="main">(</span><span class="free">ρ'</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms product_run_Some<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ι<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">w</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">x</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">≡</span> run<span class="hidden">⇩</span><sub>t</sub> <span class="main">(</span><span class="keyword1">Δ<span class="hidden">⇩</span><sub>×</sub></span> <span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span> <span class="free">ι<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ'</span> <span class="main">≡</span> run<span class="hidden">⇩</span><sub>t</sub> <span class="main">(</span><span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">x</span><span class="main">)</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ι<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="free">ρ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> product_run_project_limit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⇃⇩</span><span class="free">x</span> <span class="main">`</span> limit <span class="free">ρ</span> <span class="main">=</span> limit <span class="free">ρ'</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> product_run_embed_limit<span class="main">:</span> <span class="quoted"><span class="quoted">"limit <span class="free">ρ</span> <span class="main">⊆</span> <span class="main">⋃</span> <span class="main">(</span><span class="main">↿⇩</span><span class="free">x</span> <span class="main">`</span> <span class="main">(</span>limit <span class="free">ρ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="main">⇃⇩</span><span class="free">x</span> <span class="main">(</span><span class="free">ρ</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">ρ'</span> <span class="bound">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms product_run_embed<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⇃⇩</span><span class="free">x</span> <span class="main">`</span> range <span class="free">ρ</span> <span class="main">=</span> range <span class="free">ρ'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> range_composition<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⇃⇩</span><span class="free">x</span>"</span></span> <span class="quoted"><span class="free">ρ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="free">ρ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms finite_imageI <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"limit <span class="free">ρ</span> <span class="main">=</span> range <span class="main">(</span>suffix <span class="skolem">i</span> <span class="free">ρ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"limit <span class="free">ρ'</span> <span class="main">=</span> range <span class="main">(</span>suffix <span class="skolem">i</span> <span class="free">ρ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> common_range_limit assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span>  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="main">⇃⇩</span><span class="free">x</span> <span class="main">(</span>suffix <span class="skolem">i</span> <span class="free">ρ</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>suffix <span class="skolem">i</span> <span class="free">ρ'</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms product_run_embed<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⇃⇩</span><span class="free">x</span> <span class="main">`</span> range <span class="main">(</span><span class="main">(</span>suffix <span class="skolem">i</span> <span class="free">ρ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>range <span class="main">(</span>suffix <span class="skolem">i</span> <span class="free">ρ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> range_composition<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⇃⇩</span><span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>suffix <span class="skolem">i</span>  <span class="free">ρ</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span>suffix <span class="skolem">i</span> <span class="free">ρ</span> <span class="bound">k</span><span class="main">)</span> <span class="main">∈</span> <span class="main">↿⇩</span><span class="free">x</span> <span class="main">(</span>suffix <span class="skolem">i</span> <span class="free">ρ'</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms product_run_embed<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⇃⇩</span><span class="free">x</span> <span class="main">`</span> limit <span class="free">ρ</span> <span class="main">=</span> limit <span class="free">ρ'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"limit <span class="free">ρ</span> <span class="main">⊆</span> <span class="main">⋃</span> <span class="main">(</span><span class="main">↿⇩</span><span class="free">x</span> <span class="main">`</span> <span class="main">(</span>limit <span class="free">ρ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DTS-product_run_embed_limit_finiteness"><span class="command">lemma</span></span> product_run_embed_limit_finiteness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ι<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">w</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">k</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ</span> <span class="main">≡</span> run<span class="hidden">⇩</span><sub>t</sub> <span class="main">(</span><span class="keyword1">Δ<span class="hidden">⇩</span><sub>×</sub></span> <span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span> <span class="free">ι<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ρ'</span> <span class="main">≡</span> run<span class="hidden">⇩</span><sub>t</sub> <span class="main">(</span><span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">k</span><span class="main">)</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ι<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="free">ρ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"limit <span class="free">ρ</span> <span class="main">∩</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="main">↿⇩</span><span class="free">k</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> limit <span class="free">ρ'</span> <span class="main">∩</span> <span class="free">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⇃⇩</span><span class="free">k</span> <span class="main">`</span> limit <span class="free">ρ</span> <span class="main">∩</span> <span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟶</span> limit <span class="free">ρ</span> <span class="main">∩</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="main">↿⇩</span><span class="free">k</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⇃⇩</span><span class="free">k</span> <span class="main">`</span> limit <span class="free">ρ</span> <span class="main">∩</span> <span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">ν</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">q</span><span class="main">,</span> <span class="skolem">ν</span><span class="main">,</span> <span class="skolem">q'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⇃⇩</span><span class="free">k</span> <span class="main">`</span> limit <span class="free">ρ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">q</span><span class="main">,</span> <span class="skolem">ν</span><span class="main">,</span> <span class="skolem">q'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span> <span class="bound">ν</span> <span class="bound">m'</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">m</span><span class="main">,</span> <span class="bound">ν</span><span class="main">,</span> <span class="bound">m'</span><span class="main">)</span> <span class="main">=</span> <span class="free">ρ</span> <span class="bound">i</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">p</span> <span class="bound">p'</span><span class="main">.</span> <span class="bound">m</span> <span class="free">k</span> <span class="main">=</span> Some <span class="bound">p</span> <span class="main">∧</span> <span class="bound">m'</span> <span class="free">k</span> <span class="main">=</span> Some <span class="bound">p'</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> assms product_run_Some<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ι<span class="hidden">⇩</span><sub>m</sub></span></span> <span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span> <span class="bound">ν</span> <span class="bound">m'</span><span class="main">.</span> <span class="main">(</span><span class="bound">m</span><span class="main">,</span> <span class="bound">ν</span><span class="main">,</span> <span class="bound">m'</span><span class="main">)</span> <span class="main">∈</span> limit <span class="free">ρ</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">p</span> <span class="bound">p'</span><span class="main">.</span> <span class="bound">m</span> <span class="free">k</span> <span class="main">=</span> Some <span class="bound">p</span> <span class="main">∧</span> <span class="bound">m'</span> <span class="free">k</span> <span class="main">=</span> Some <span class="bound">p'</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> limit_in_range <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="free">k</span> <span class="main">=</span> Some <span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m'</span> <span class="free">k</span> <span class="main">=</span> Some <span class="skolem">q'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">m</span><span class="main">,</span> <span class="skolem">ν</span><span class="main">,</span> <span class="skolem">m'</span><span class="main">)</span> <span class="main">∈</span> limit <span class="free">ρ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">m</span><span class="main">,</span> <span class="skolem">ν</span><span class="main">,</span> <span class="skolem">m'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⋃</span> <span class="main">(</span><span class="main">↿⇩</span><span class="free">k</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">q</span><span class="main">,</span> <span class="skolem">ν</span><span class="main">,</span> <span class="skolem">q'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"limit <span class="free">ρ</span> <span class="main">∩</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="main">↿⇩</span><span class="free">k</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> <span class="main">⇃⇩</span><span class="free">k</span> <span class="main">`</span> limit <span class="free">ρ</span> <span class="main">∩</span> <span class="free">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms product_run_project_limit<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Transfer Rules›</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">includes</span></span> lifting_syntax
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="DTS-product_parametric"><span class="command">lemma</span></span> product_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="main">===&gt;</span> <span class="free">B</span> <span class="main">===&gt;</span> <span class="free">C</span> <span class="main">===&gt;</span> <span class="free">B</span><span class="main">)</span> <span class="main">===&gt;</span> <span class="main">(</span><span class="free">A</span> <span class="main">===&gt;</span> rel_option <span class="free">B</span><span class="main">)</span> <span class="main">===&gt;</span> <span class="free">C</span> <span class="main">===&gt;</span> <span class="free">A</span> <span class="main">===&gt;</span> rel_option <span class="free">B</span><span class="main">)</span> product product"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def rel_option_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>

<span class="keyword1" id="DTS-run_parametric"><span class="command">lemma</span></span> run_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="main">===&gt;</span> <span class="free">B</span> <span class="main">===&gt;</span> <span class="free">A</span><span class="main">)</span> <span class="main">===&gt;</span> <span class="free">A</span> <span class="main">===&gt;</span> <span class="main">(</span><span class="main">(=)</span> <span class="main">===&gt;</span> <span class="free">B</span><span class="main">)</span> <span class="main">===&gt;</span> <span class="main">(=)</span> <span class="main">===&gt;</span> <span class="free">A</span><span class="main">)</span> run run"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">δ</span> <span class="skolem">δ'</span> <span class="skolem">q</span> <span class="skolem">q'</span> <span class="skolem">n</span> <span class="skolem">w</span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'d</span>"</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">===&gt;</span> <span class="free">B</span> <span class="main">===&gt;</span> <span class="free">A</span><span class="main">)</span> <span class="skolem">δ</span> <span class="skolem">δ'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="skolem">q</span> <span class="skolem">q'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(=)</span> <span class="main">===&gt;</span> <span class="free">B</span><span class="main">)</span> <span class="skolem">w</span> <span class="skolem">w'</span>"</span></span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">(</span>run <span class="skolem">δ</span> <span class="skolem">q</span> <span class="skolem">w</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>run <span class="skolem">δ'</span> <span class="skolem">q'</span> <span class="skolem">w'</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DTS-reach_parametric"><span class="command">lemma</span></span> reach_parametric <span class="main">[</span><span class="operator">transfer_rule</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bi_total <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bi_unique <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_set <span class="free">B</span> <span class="main">===&gt;</span> <span class="main">(</span><span class="free">A</span> <span class="main">===&gt;</span> <span class="free">B</span> <span class="main">===&gt;</span> <span class="free">A</span><span class="main">)</span> <span class="main">===&gt;</span> <span class="free">A</span> <span class="main">===&gt;</span> rel_set <span class="free">A</span><span class="main">)</span> reach reach"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">standard</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Σ</span> <span class="skolem">Σ'</span> <span class="skolem">δ</span> <span class="skolem">δ'</span> <span class="skolem">q</span> <span class="skolem">q'</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"rel_set <span class="free">B</span> <span class="skolem">Σ</span> <span class="skolem">Σ'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">===&gt;</span> <span class="free">B</span> <span class="main">===&gt;</span> <span class="free">A</span><span class="main">)</span> <span class="skolem">δ</span> <span class="skolem">δ'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="skolem">q</span> <span class="skolem">q'</span>"</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> 
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> reach <span class="skolem">Σ</span> <span class="skolem">δ</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> run <span class="skolem">δ</span> <span class="skolem">q</span> <span class="skolem">w</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"range <span class="skolem">w</span> <span class="main">⊆</span> <span class="skolem">Σ</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> reach_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">w'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> <span class="free">B</span> <span class="main">(</span><span class="skolem">w</span> <span class="skolem">n</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
    
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">w</span> <span class="bound">n</span> <span class="main">∈</span> <span class="skolem">Σ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹range <span class="skolem">w</span> <span class="main">⊆</span> <span class="skolem">Σ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">w'</span> <span class="bound">n</span> <span class="main">∈</span> <span class="skolem">Σ'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹rel_set <span class="free">B</span> <span class="skolem">Σ</span> <span class="skolem">Σ'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> w'_def bi_unique_def rel_set_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">metis</span> someI<span class="main">)</span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"run <span class="skolem">δ'</span> <span class="skolem">q'</span> <span class="skolem">w'</span> <span class="skolem">n</span> <span class="main">∈</span> reach <span class="skolem">Σ'</span> <span class="skolem">δ'</span> <span class="skolem">q'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> reach_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     
    <span class="keyword1"><span class="command">moreover</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="skolem">z</span> <span class="main">(</span>run <span class="skolem">δ'</span> <span class="skolem">q'</span> <span class="skolem">w'</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="main">=</span> run <span class="skolem">δ</span> <span class="skolem">q</span> <span class="skolem">w</span> <span class="skolem">n</span>›</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="skolem">q</span> <span class="skolem">q'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">A</span> <span class="main">===&gt;</span> <span class="free">B</span> <span class="main">===&gt;</span> <span class="free">A</span><span class="main">)</span> <span class="skolem">δ</span> <span class="skolem">δ'</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>  
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def bi_total_def w'_def<span class="main">)</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> tfl_some<span class="main">)</span>  

    <span class="keyword1"><span class="command">ultimately</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">z'</span> <span class="main">∈</span> reach <span class="skolem">Σ'</span> <span class="skolem">δ'</span> <span class="skolem">q'</span><span class="main">.</span> <span class="free">A</span> <span class="skolem">z</span> <span class="bound">z'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">moreover</span></span>
  
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> 
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> reach <span class="skolem">Σ'</span> <span class="skolem">δ'</span> <span class="skolem">q'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> run <span class="skolem">δ'</span> <span class="skolem">q'</span> <span class="skolem">w</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"range <span class="skolem">w</span> <span class="main">⊆</span> <span class="skolem">Σ'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> reach_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">w'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> <span class="free">B</span> <span class="bound">x</span> <span class="main">(</span><span class="skolem">w</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">n</span>
    
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">w</span> <span class="bound">n</span> <span class="main">∈</span> <span class="skolem">Σ'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹range <span class="skolem">w</span> <span class="main">⊆</span> <span class="skolem">Σ'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">w'</span> <span class="bound">n</span> <span class="main">∈</span> <span class="skolem">Σ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹rel_set <span class="free">B</span> <span class="skolem">Σ</span> <span class="skolem">Σ'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> w'_def bi_unique_def rel_set_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">metis</span> someI<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"run <span class="skolem">δ</span> <span class="skolem">q</span> <span class="skolem">w'</span> <span class="skolem">n</span> <span class="main">∈</span> reach <span class="skolem">Σ</span> <span class="skolem">δ</span> <span class="skolem">q</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> reach_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     
    <span class="keyword1"><span class="command">moreover</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">(</span>run <span class="skolem">δ</span> <span class="skolem">q</span> <span class="skolem">w'</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">z</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="main">=</span> run <span class="skolem">δ'</span> <span class="skolem">q'</span> <span class="skolem">w</span> <span class="skolem">n</span>›</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="skolem">q</span> <span class="skolem">q'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">A</span> <span class="main">===&gt;</span> <span class="free">B</span> <span class="main">===&gt;</span> <span class="free">A</span><span class="main">)</span> <span class="skolem">δ</span> <span class="skolem">δ'</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>  
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_def bi_total_def w'_def<span class="main">)</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> tfl_some<span class="main">)</span>  

    <span class="keyword1"><span class="command">ultimately</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">z'</span> <span class="main">∈</span> reach <span class="skolem">Σ</span> <span class="skolem">δ</span> <span class="skolem">q</span><span class="main">.</span> <span class="free">A</span> <span class="bound">z'</span> <span class="skolem">z</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"rel_set <span class="free">A</span> <span class="main">(</span>reach <span class="skolem">Σ</span> <span class="skolem">δ</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">(</span>reach <span class="skolem">Σ'</span> <span class="skolem">δ'</span> <span class="skolem">q'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rel_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lift to Mapping›</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> product_abs <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> DTS<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> mapping<span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> DTS"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">↑Δ<span class="hidden">⇩</span><sub>×</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">product</span> 
  <span class="keyword2"><span class="keyword">parametric</span></span> product_parametric <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="DTS-product_abs_run_None"><span class="command">lemma</span></span> product_abs_run_None<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">ι<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">k</span> <span class="main">=</span> None <span class="main">⟹</span> Mapping.lookup <span class="main">(</span>run <span class="main">(</span><span class="keyword1">↑Δ<span class="hidden">⇩</span><sub>×</sub></span> <span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span> <span class="free">ι<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">w</span> <span class="free">i</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">insert</span> product_run_None<span class="main">)</span>

<span class="keyword1" id="DTS-product_abs_run_Some"><span class="command">lemma</span></span> product_abs_run_Some<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">ι<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟹</span> Mapping.lookup <span class="main">(</span>run <span class="main">(</span><span class="keyword1">↑Δ<span class="hidden">⇩</span><sub>×</sub></span> <span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span> <span class="free">ι<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">w</span> <span class="free">i</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> Some <span class="main">(</span>run <span class="main">(</span><span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span> <span class="free">k</span><span class="main">)</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">w</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">insert</span> product_run_Some<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> finite_reach_product_abs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>Mapping.keys <span class="free">ι<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span>Mapping.keys <span class="free">ι<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span> <span class="main">⟹</span> finite <span class="main">(</span>reach <span class="free">Σ</span> <span class="main">(</span><span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span>Mapping.lookup <span class="free">ι<span class="hidden">⇩</span><sub>m</sub></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reach <span class="free">Σ</span> <span class="main">(</span><span class="keyword1">↑Δ<span class="hidden">⇩</span><sub>×</sub></span> <span class="free">δ<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span> <span class="free">ι<span class="hidden">⇩</span><sub>m</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_reach_product<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Semi_Mojmir">
<div class="head">
<h1>Theory Semi_Mojmir</h1>
</div>
<pre class="source"><span class="comment1">(*
    Author:      Salomon Sickert
    License:     BSD
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Mojmir Automata (Without Final States)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Semi_Mojmir
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <span class="quoted">"<a href="Preliminaries2.html">Auxiliary/Preliminaries2</a>"</span> <a href="DTS.html">DTS</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definitions›</span></span>

<span class="keyword1"><span class="command">locale</span></span> semi_mojmir_def <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="comment1">― ‹Alphapet›</span>
    <span class="free">Σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="comment1">― ‹Transition Function›</span>
    <span class="free">δ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> DTS"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="comment1">― ‹Initial State›</span>
    <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="comment1">― ‹$\omega$-Word›</span>
    <span class="free">w</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> word"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sink</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sink</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ν</span> <span class="main">∈</span> <span class="free">Σ</span><span class="main">.</span> <span class="free">δ</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="bound">ν</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> sink_def <span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">token_run</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">token_run</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> run <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>suffix <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free">w</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">configuration</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> nat <span class="main">⇒</span> nat set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">configuration</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> token_run <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">oldest_token</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> nat <span class="main">⇒</span> nat option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">oldest_token</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> configuration <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≠</span> <span class="main">{}</span> <span class="keyword1">then</span> Some <span class="main">(</span>Min <span class="main">(</span>configuration <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">senior</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">senior</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> the <span class="main">(</span>oldest_token <span class="main">(</span>token_run <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">older_seniors</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">older_seniors</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> senior <span class="bound">y</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> <span class="bound">s</span> <span class="main">&lt;</span> senior <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> <span class="main">¬</span> sink <span class="main">(</span>token_run <span class="bound">s</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rank</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rank</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> <span class="main">¬</span>sink <span class="main">(</span>token_run <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="keyword1">then</span> Some <span class="main">(</span>card <span class="main">(</span>older_seniors <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">senior_states</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'b</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">senior_states</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span>
    <span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> oldest_token <span class="bound">p</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> Some <span class="bound">y</span> <span class="main">∧</span> oldest_token <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> Some <span class="bound">x</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span> <span class="main">∧</span> <span class="main">¬</span> sink <span class="bound">p</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">state_rank</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> nat <span class="main">⇒</span> nat option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">state_rank</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> configuration <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∧</span> <span class="main">¬</span>sink <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="keyword1">then</span> Some <span class="main">(</span>card <span class="main">(</span>senior_states <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">max_rank</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">max_rank</span> <span class="main">=</span> card <span class="main">(</span>reach <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">-</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> sink <span class="bound">q</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Iterative Computation of State-Ranks›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">initial</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> nat option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">initial</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">then</span> Some <span class="main">0</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pre_ranks</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> nat option<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> nat set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pre_ranks</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span> <span class="main">.</span> <span class="main">∃</span><span class="bound">q'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">q'</span> <span class="main">=</span> Some <span class="bound">i</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="free">δ</span> <span class="bound">q'</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">then</span> <span class="main">{</span>max_rank<span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> nat option<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> nat option<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">if</span>
      <span class="main">¬</span>sink <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">∧</span> pre_ranks <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≠</span> <span class="main">{}</span>
    <span class="keyword1">then</span>
      Some <span class="main">(</span>card <span class="main">{</span><span class="bound">q'</span><span class="main">.</span> <span class="main">¬</span>sink <span class="bound">q'</span> <span class="main">∧</span> pre_ranks <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="bound">q'</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∧</span> Min <span class="main">(</span>pre_ranks <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="bound">q'</span><span class="main">)</span> <span class="main">&lt;</span> Min <span class="main">(</span>pre_ranks <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span><span class="main">}</span><span class="main">)</span>
    <span class="keyword1">else</span>
      None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Properties of Tokens›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">token_squats</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">token_squats</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="main">¬</span>sink <span class="main">(</span>token_run <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> semi_mojmir <span class="main">=</span> semi_mojmir_def <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="comment1">― ‹The alphabet is finite. Non-emptiness is derived from well-formed w›</span>
    finite_Σ<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="comment1">― ‹The set of reachable states is finite›</span>
    finite_reach<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reach <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="comment1">― ‹w only contains letters from the alphabet›</span>
    bounded_w<span class="main">:</span> <span class="quoted"><span class="quoted">"range <span class="free">w</span> <span class="main">⊆</span> <span class="free">Σ</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Semi_Mojmir-nonempty_Σ"><span class="command">lemma</span></span> nonempty_Σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Σ</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bounded_w <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Semi_Mojmir-bounded_w'"><span class="command">lemma</span></span> bounded_w'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="free">i</span> <span class="main">∈</span> <span class="free">Σ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bounded_w <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="comment1">― ‹Naming Scheme:

This theory uses the following naming scheme to consistently name variables.

* Tokens: x, y, z
* Time: n, m
* Rank: i, j, k
* States: p, q›</span>

<span class="keyword1" id="Semi_Mojmir-sink_rev_step"><span class="command">lemma</span></span> sink_rev_step<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="free">q</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="free">q'</span> <span class="free">ν</span> <span class="main">⟹</span> <span class="free">ν</span> <span class="main">∈</span> <span class="free">Σ</span> <span class="main">⟹</span> <span class="main">¬</span>sink <span class="free">q'</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="free">q</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="free">q'</span> <span class="main">(</span><span class="free">w</span> <span class="free">i</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span>sink <span class="free">q'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bounded_w' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sink_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Token Run›</span></span>

<span class="keyword1" id="Semi_Mojmir-token_stays_in_sink"><span class="command">lemma</span></span> token_stays_in_sink<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sink <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"token_run <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"token_run <span class="free">x</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">n</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">+</span> <span class="skolem">m</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">w</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">Σ</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> bounded_w <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> token_run <span class="free">x</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span>  <span class="main">=</span> <span class="free">q</span> <span class="main">⟹</span> token_run <span class="free">x</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="skolem">m</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹sink <span class="free">q</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> sink_def<span class="main">]</span> upt_add_eq_append<span class="main">[</span><span class="operator">OF</span> le0<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">+</span> <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">using</span></span> Suc_diff_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sink_def<span class="main">)</span>

<span class="keyword1" id="Semi_Mojmir-token_is_not_in_sink"><span class="command">lemma</span></span> token_is_not_in_sink<span class="main">:</span>
  <span class="quoted"><span class="quoted">"token_run <span class="free">x</span> <span class="free">n</span> <span class="main">∉</span> <span class="free">A</span> <span class="main">⟹</span> token_run <span class="free">x</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">¬</span>sink <span class="main">(</span>token_run <span class="free">x</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 token_stays_in_sink<span class="main">)</span>

<span class="keyword1" id="Semi_Mojmir-token_run_intial_state"><span class="command">lemma</span></span> token_run_intial_state<span class="main">:</span>
  <span class="quoted"><span class="quoted">"token_run <span class="free">x</span> <span class="free">x</span> <span class="main">=</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Semi_Mojmir-token_run_P"><span class="command">lemma</span></span> token_run_P<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">P</span> <span class="main">(</span>token_run <span class="free">x</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>token_run <span class="free">x</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">m'</span></span> <span class="main">≤</span> <span class="free">m</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="main">(</span>token_run <span class="free">x</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="bound">m'</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">(</span>token_run <span class="free">x</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="bound">m'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> add_Suc_right le_Suc_eq<span class="main">)</span>

<span class="keyword1" id="Semi_Mojmir-token_run_merge_Suc"><span class="command">lemma</span></span> token_run_merge_Suc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"token_run <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> token_run <span class="free">y</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"token_run <span class="free">x</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> token_run <span class="free">y</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"run <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>suffix <span class="free">x</span> <span class="free">w</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> run <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>suffix <span class="free">y</span> <span class="free">w</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc_diff_le assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Semi_Mojmir-token_run_merge"><span class="command">lemma</span></span> token_run_merge<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">x</span> <span class="main">≤</span> <span class="free">n</span><span class="main">;</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">n</span><span class="main">;</span> token_run <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> token_run <span class="free">y</span> <span class="free">n</span><span class="main">⟧</span> <span class="main">⟹</span> token_run <span class="free">x</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> token_run <span class="free">y</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> token_run_merge_Suc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="main">_</span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Semi_Mojmir-token_run_mergepoint"><span class="command">lemma</span></span> token_run_mergepoint<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"token_run <span class="free">x</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> token_run <span class="free">y</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">m</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≤</span> <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> Suc <span class="free">m</span> <span class="main">∨</span> token_run <span class="free">x</span> <span class="free">m</span> <span class="main">≠</span> token_run <span class="free">y</span> <span class="free">m</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"token_run <span class="free">x</span> <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span> <span class="main">=</span> token_run <span class="free">y</span> <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
    <span class="main">(</span><span class="main">(</span><span class="operator">metis</span> add_0_iff le_Suc_eq le_add1 less_imp_Suc_add<span class="main">)</span><span class="main"><span class="keyword3">,</span></span>
     <span class="main">(</span><span class="operator">metis</span> add_Suc_right le_add1 less_or_eq_imp_le order_trans<span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Step Lemmas›</span></span>

<span class="keyword1" id="Semi_Mojmir-token_run_step"><span class="command">lemma</span></span> token_run_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"token_run <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> <span class="free">q'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="free">q'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"token_run <span class="free">x</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> token_run.simps Suc_diff_le<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≤</span> <span class="free">n</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Semi_Mojmir-token_run_step'"><span class="command">lemma</span></span> token_run_step'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> token_run <span class="free">x</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">δ</span> <span class="main">(</span>token_run <span class="free">x</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> token_run_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Configuration›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Properties›</span></span>

<span class="keyword1" id="Semi_Mojmir-configuration_distinct"><span class="command">lemma</span></span> configuration_distinct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≠</span> <span class="free">q'</span> <span class="main">⟹</span> configuration <span class="free">q</span> <span class="free">n</span> <span class="main">∩</span> configuration <span class="free">q'</span> <span class="free">n</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Semi_Mojmir-configuration_finite"><span class="command">lemma</span></span> configuration_finite<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>configuration <span class="free">q</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Semi_Mojmir-configuration_non_empty"><span class="command">lemma</span></span> configuration_non_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> configuration <span class="main">(</span>token_run <span class="free">x</span> <span class="free">n</span><span class="main">)</span> <span class="free">n</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Semi_Mojmir-configuration_token"><span class="command">lemma</span></span> configuration_token<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> configuration <span class="main">(</span>token_run <span class="free">x</span> <span class="free">n</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemmas</span></span> configuration_Max_in <span class="main">=</span> Max_in<span class="main">[</span><span class="operator">OF</span> configuration_finite<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> configuration_Min_in <span class="main">=</span> Min_in<span class="main">[</span><span class="operator">OF</span> configuration_finite<span class="main">]</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Monotonicity›</span></span>

<span class="keyword1" id="Semi_Mojmir-configuration_monotonic_Suc"><span class="command">lemma</span></span> configuration_monotonic_Suc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> configuration <span class="main">(</span>token_run <span class="free">x</span> <span class="free">n</span><span class="main">)</span> <span class="free">n</span> <span class="main">⊆</span> configuration <span class="main">(</span>token_run <span class="free">x</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> configuration <span class="main">(</span>token_run <span class="free">x</span> <span class="free">n</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"token_run <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> token_run <span class="skolem">y</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"token_run <span class="free">x</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> token_run <span class="skolem">y</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> token_run_merge_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> configuration <span class="main">(</span>token_run <span class="free">x</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> configuration_token <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">≤</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Pull-Up and Push-Down›</span></span>

<span class="keyword1" id="Semi_Mojmir-pull_up_token_run_tokens"><span class="command">lemma</span></span> pull_up_token_run_tokens<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">x</span> <span class="main">≤</span> <span class="free">n</span><span class="main">;</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">n</span><span class="main">;</span> token_run <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> token_run <span class="free">y</span> <span class="free">n</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> configuration <span class="bound">q</span> <span class="free">n</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">∈</span> configuration <span class="bound">q</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Semi_Mojmir-push_down_configuration_token_run"><span class="command">lemma</span></span> push_down_configuration_token_run<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">x</span> <span class="main">∈</span> configuration <span class="free">q</span> <span class="free">n</span><span class="main">;</span> <span class="free">y</span> <span class="main">∈</span> configuration <span class="free">q</span> <span class="free">n</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> token_run <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> token_run <span class="free">y</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Step Lemmas›</span></span>

<span class="keyword1" id="Semi_Mojmir-configuration_step"><span class="command">lemma</span></span> configuration_step<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> configuration <span class="free">q'</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="free">q'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> configuration <span class="free">q</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Suc_diff_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Semi_Mojmir-configuration_step_non_empty"><span class="command">lemma</span></span> configuration_step_non_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"configuration <span class="free">q'</span> <span class="free">n</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="free">q'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> configuration <span class="free">q</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> configuration_step<span class="main">)</span>

<span class="keyword1" id="Semi_Mojmir-configuration_rev_step'"><span class="command">lemma</span></span> configuration_rev_step'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> Suc <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> configuration <span class="free">q</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">q'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="free">q'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> configuration <span class="free">q'</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms Suc_diff_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Semi_Mojmir-configuration_rev_step''"><span class="command">lemma</span></span> configuration_rev_step''<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> configuration <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> Suc <span class="free">n</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q'</span><span class="main">.</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">δ</span> <span class="bound">q'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∈</span> configuration <span class="bound">q'</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms configuration_rev_step' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="Semi_Mojmir-configuration_step_eq_q"><span class="command">lemma</span></span> configuration_step_eq_q<span class="hidden">⇩</span><sub>0</sub><span class="main">:</span>
  <span class="quoted"><span class="quoted">"configuration <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>Suc <span class="free">n</span><span class="main">}</span> <span class="main">∪</span> <span class="main">⋃</span><span class="main">{</span>configuration <span class="bound">q'</span> <span class="free">n</span> <span class="main">|</span> <span class="bound">q'</span><span class="main">.</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">δ</span> <span class="bound">q'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span> <span class="keyword1"><span class="command">using</span></span> configuration_rev_step'' <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fast</span> <span class="keyword1"><span class="command">using</span></span> configuration_step<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Semi_Mojmir-configuration_rev_step"><span class="command">lemma</span></span> configuration_rev_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≠</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> configuration <span class="free">q</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">q'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="free">q'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> configuration <span class="free">q'</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> configuration_rev_step'<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Semi_Mojmir-configuration_step_eq"><span class="command">lemma</span></span> configuration_step_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≠</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"configuration <span class="free">q</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">{</span>configuration <span class="bound">q'</span> <span class="free">n</span> <span class="main">|</span> <span class="bound">q'</span><span class="main">.</span> <span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="bound">q'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> configuration_rev_step<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> configuration_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Semi_Mojmir-configuration_step_eq_unified"><span class="command">lemma</span></span> configuration_step_eq_unified<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"configuration <span class="free">q</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">{</span>configuration <span class="bound">q'</span> <span class="free">n</span> <span class="main">|</span> <span class="bound">q'</span><span class="main">.</span> <span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="bound">q'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">q</span> <span class="main">=</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">then</span> <span class="main">{</span>Suc <span class="free">n</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span> "</span></span>
  <span class="keyword1"><span class="command">using</span></span> configuration_step_eq configuration_step_eq_q<span class="hidden">⇩</span><sub>0</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Oldest Token›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Properties›</span></span>

<span class="keyword1" id="Semi_Mojmir-oldest_token_always_def"><span class="command">lemma</span></span> oldest_token_always_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">∧</span> oldest_token <span class="main">(</span>token_run <span class="free">x</span> <span class="free">n</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> Some <span class="bound">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">n</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"token_run <span class="free">x</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> configuration <span class="var">?q</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"configuration <span class="var">?q</span> <span class="free">n</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"oldest_token <span class="var">?q</span> <span class="free">n</span> <span class="main">=</span> Some <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Min.coboundedI oldest_token.simps configuration_finite<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Semi_Mojmir-oldest_token_bounded"><span class="command">lemma</span></span> oldest_token_bounded<span class="main">:</span>
  <span class="quoted"><span class="quoted">"oldest_token <span class="free">q</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> oldest_token.simps configuration_Min_in option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> option.inject push_down_configuration_token_run<span class="main">)</span>

<span class="keyword1" id="Semi_Mojmir-oldest_token_distinct"><span class="command">lemma</span></span> oldest_token_distinct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≠</span> <span class="free">q'</span> <span class="main">⟹</span> oldest_token <span class="free">q</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">i</span> <span class="main">⟹</span> oldest_token <span class="free">q'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">j</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≠</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> configuration_Min_in configuration_distinct disjoint_iff_not_equal option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> oldest_token.simps option.sel<span class="main">)</span>

<span class="keyword1" id="Semi_Mojmir-oldest_token_equal"><span class="command">lemma</span></span> oldest_token_equal<span class="main">:</span>
  <span class="quoted"><span class="quoted">"oldest_token <span class="free">q</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">i</span> <span class="main">⟹</span> oldest_token <span class="free">q'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">i</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">=</span> <span class="free">q'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> oldest_token_distinct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Monotonicity›</span></span>

<span class="keyword1" id="Semi_Mojmir-oldest_token_monotonic_Suc"><span class="command">lemma</span></span> oldest_token_monotonic_Suc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"oldest_token <span class="main">(</span>token_run <span class="free">x</span> <span class="free">n</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"oldest_token <span class="main">(</span>token_run <span class="free">x</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≥</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> Min <span class="main">(</span>configuration <span class="main">(</span>token_run <span class="free">x</span> <span class="free">n</span><span class="main">)</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">=</span> Min <span class="main">(</span>configuration <span class="main">(</span>token_run <span class="free">x</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> oldest_token.elims option.discI option.sel<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Min_antimono<span class="main">[</span><span class="operator">OF</span> configuration_monotonic_Suc<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> configuration_non_empty<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> configuration_finite<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Pull-Up and Push-Down›</span></span>

<span class="keyword1" id="Semi_Mojmir-push_down_oldest_token_configuration"><span class="command">lemma</span></span> push_down_oldest_token_configuration<span class="main">:</span>
  <span class="quoted"><span class="quoted">"oldest_token <span class="free">q</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> configuration <span class="free">q</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> configuration_Min_in oldest_token.simps option.distinct<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> option.inject<span class="main">)</span>

<span class="keyword1" id="Semi_Mojmir-push_down_oldest_token_token_run"><span class="command">lemma</span></span> push_down_oldest_token_token_run<span class="main">:</span>
  <span class="quoted"><span class="quoted">"oldest_token <span class="free">q</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">x</span> <span class="main">⟹</span> token_run <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> push_down_oldest_token_configuration configuration.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Senior Token›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Properties›</span></span>

<span class="keyword1" id="Semi_Mojmir-senior_le_token"><span class="command">lemma</span></span> senior_le_token<span class="main">:</span>
  <span class="quoted"><span class="quoted">"senior <span class="free">x</span> <span class="free">n</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> oldest_token_always_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Semi_Mojmir-senior_token_run"><span class="command">lemma</span></span> senior_token_run<span class="main">:</span>
  <span class="quoted"><span class="quoted">"senior <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> senior <span class="free">y</span> <span class="free">n</span> <span class="main">⟷</span> token_run <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> token_run <span class="free">y</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> oldest_token_always_def oldest_token_distinct option.sel senior.simps<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The senior of a token is always in the same state›</span></span>

<span class="keyword1" id="Semi_Mojmir-senior_same_state"><span class="command">lemma</span></span> senior_same_state<span class="main">:</span>
  <span class="quoted"><span class="quoted">"token_run <span class="main">(</span>senior <span class="free">x</span> <span class="free">n</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> token_run <span class="free">x</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> token_run <span class="bound">t</span> <span class="free">n</span> <span class="main">=</span> token_run <span class="free">x</span> <span class="free">n</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">n</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Min_in<span class="main">[</span><span class="operator">OF</span> _ X<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Semi_Mojmir-senior_senior"><span class="command">lemma</span></span> senior_senior<span class="main">:</span>
  <span class="quoted"><span class="quoted">"senior <span class="main">(</span>senior <span class="free">x</span> <span class="free">n</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> senior <span class="free">x</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> senior_same_state senior_token_run <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Monotonicity›</span></span>

<span class="keyword1" id="Semi_Mojmir-senior_monotonic_Suc"><span class="command">lemma</span></span> senior_monotonic_Suc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> senior <span class="free">x</span> <span class="free">n</span> <span class="main">≥</span> senior <span class="free">x</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> oldest_token_always_def oldest_token_monotonic_Suc option.sel senior.simps<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Pull-Up and Push-Down›</span></span>

<span class="keyword1" id="Semi_Mojmir-pull_up_configuration_senior"><span class="command">lemma</span></span> pull_up_configuration_senior<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">x</span> <span class="main">∈</span> configuration <span class="free">q</span> <span class="free">n</span><span class="main">;</span> <span class="free">y</span> <span class="main">∈</span> configuration <span class="free">q</span> <span class="free">n</span><span class="main">⟧</span> <span class="main">⟹</span> senior <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> senior <span class="free">y</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Semi_Mojmir-push_down_senior_tokens"><span class="command">lemma</span></span> push_down_senior_tokens<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">x</span> <span class="main">≤</span> <span class="free">n</span><span class="main">;</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">n</span><span class="main">;</span> senior <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> senior <span class="free">y</span> <span class="free">n</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> configuration <span class="bound">q</span> <span class="free">n</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">∈</span> configuration <span class="bound">q</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> senior_token_run pull_up_token_run_tokens <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Set of Older Seniors›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Properties›</span></span>

<span class="keyword1" id="Semi_Mojmir-older_seniors_cases_subseteq"><span class="command">lemma</span></span> older_seniors_cases_subseteq <span class="main">[</span><span class="operator">case_names</span> le ge<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"older_seniors <span class="free">x</span> <span class="free">n</span> <span class="main">⊆</span> older_seniors <span class="free">y</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"older_seniors <span class="free">x</span> <span class="free">n</span> <span class="main">⊇</span> older_seniors <span class="free">y</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Semi_Mojmir-older_seniors_cases_subset"><span class="command">lemma</span></span> older_seniors_cases_subset <span class="main">[</span><span class="operator">case_names</span> less equal greater<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"older_seniors <span class="free">x</span> <span class="free">n</span> <span class="main">⊂</span> older_seniors <span class="free">y</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"older_seniors <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> older_seniors <span class="free">y</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"older_seniors <span class="free">x</span> <span class="free">n</span> <span class="main">⊃</span> older_seniors <span class="free">y</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms older_seniors_cases_subseteq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Semi_Mojmir-older_seniors_finite"><span class="command">lemma</span></span> older_seniors_finite<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>older_seniors <span class="free">x</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Semi_Mojmir-older_seniors_older"><span class="command">lemma</span></span> older_seniors_older<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> older_seniors <span class="free">x</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">&lt;</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> less_le_trans<span class="main">[</span><span class="operator">OF</span> _ senior_le_token<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Semi_Mojmir-older_seniors_senior_simp"><span class="command">lemma</span></span> older_seniors_senior_simp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"older_seniors <span class="main">(</span>senior <span class="free">x</span> <span class="free">n</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> older_seniors <span class="free">x</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> older_seniors.simps senior_senior <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1" id="Semi_Mojmir-older_seniors_not_self_referential"><span class="command">lemma</span></span> older_seniors_not_self_referential<span class="main">:</span>
  <span class="quoted"><span class="quoted">"senior <span class="free">x</span> <span class="free">n</span> <span class="main">∉</span> older_seniors <span class="free">x</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Semi_Mojmir-older_seniors_not_self_referential_2"><span class="command">lemma</span></span> older_seniors_not_self_referential_2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> older_seniors <span class="free">x</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> older_seniors_older older_seniors_not_self_referential less_not_refl <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Semi_Mojmir-older_seniors_subset"><span class="command">lemma</span></span> older_seniors_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> older_seniors <span class="free">x</span> <span class="free">n</span> <span class="main">⟹</span> older_seniors <span class="free">y</span> <span class="free">n</span> <span class="main">⊂</span> older_seniors <span class="free">x</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> older_seniors_not_self_referential_2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> older_seniors_cases_subset<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Semi_Mojmir-older_seniors_subset_2"><span class="command">lemma</span></span> older_seniors_subset_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> sink <span class="main">(</span>token_run <span class="free">x</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"older_seniors <span class="free">x</span> <span class="free">n</span> <span class="main">⊂</span> older_seniors <span class="free">y</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"senior <span class="free">x</span> <span class="free">n</span> <span class="main">∈</span> older_seniors <span class="free">y</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"senior <span class="free">x</span> <span class="free">n</span> <span class="main">&lt;</span> senior <span class="free">y</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> senior_same_state<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> older_seniors.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> older_seniors_Max_in <span class="main">=</span> Max_in<span class="main">[</span><span class="operator">OF</span> older_seniors_finite<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> older_seniors_Min_in <span class="main">=</span> Min_in<span class="main">[</span><span class="operator">OF</span> older_seniors_finite<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> older_seniors_Max_coboundedI <span class="main">=</span> Max.coboundedI<span class="main">[</span><span class="operator">OF</span> older_seniors_finite<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> older_seniors_Min_coboundedI <span class="main">=</span> Min.coboundedI<span class="main">[</span><span class="operator">OF</span> older_seniors_finite<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> older_seniors_card_mono <span class="main">=</span> card_mono<span class="main">[</span><span class="operator">OF</span> older_seniors_finite<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> older_seniors_psubset_card_mono <span class="main">=</span> psubset_card_mono<span class="main">[</span><span class="operator">OF</span> older_seniors_finite<span class="main">]</span>

<span class="keyword1" id="Semi_Mojmir-older_seniors_recursive"><span class="command">lemma</span></span> older_seniors_recursive<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">n</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">os</span> <span class="main">≡</span> older_seniors <span class="free">x</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">os</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">os</span> <span class="main">=</span> <span class="main">{</span>Max <span class="free">os</span><span class="main">}</span> <span class="main">∪</span> older_seniors <span class="main">(</span>Max <span class="free">os</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⊆</span> <span class="var">?rhs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?lhs</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Max <span class="free">os</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> Max <span class="free">os</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> older_seniors_Max_coboundedI os_def <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">os</span>›</span></span> dual_order.order_iff_strict<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"Max <span class="free">os</span> <span class="main">=</span> senior <span class="skolem">y'</span> <span class="free">n</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> older_seniors_Max_in assms<span class="main">(</span>2<span class="main">)</span>
          <span class="keyword1"><span class="command">unfolding</span></span> os_def older_seniors.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> senior <span class="main">(</span>Max <span class="free">os</span><span class="main">)</span> <span class="free">n</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> senior_senior <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?lhs</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> senior <span class="skolem">y</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> sink <span class="main">(</span>token_run <span class="skolem">x</span> <span class="free">n</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> os_def older_seniors.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> older_seniors.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⊇</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> older_seniors_subset older_seniors_Max_in assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> os_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Semi_Mojmir-older_seniors_recursive_card"><span class="command">lemma</span></span> older_seniors_recursive_card<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">n</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">os</span> <span class="main">≡</span> older_seniors <span class="free">x</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">os</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="free">os</span> <span class="main">=</span> Suc <span class="main">(</span>card <span class="main">(</span>older_seniors <span class="main">(</span>Max <span class="free">os</span><span class="main">)</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> older_seniors_recursive assms Un_empty_left Un_insert_left card_insert_disjoint older_seniors_finite older_seniors_not_self_referential_2<span class="main">)</span>

<span class="keyword1" id="Semi_Mojmir-older_seniors_card"><span class="command">lemma</span></span> older_seniors_card<span class="main">:</span>
  <span class="quoted"><span class="quoted">"card <span class="main">(</span>older_seniors <span class="free">x</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>older_seniors <span class="free">y</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟷</span> older_seniors <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> older_seniors <span class="free">y</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_not_refl older_seniors_cases_subset older_seniors_psubset_card_mono<span class="main">)</span>

<span class="keyword1" id="Semi_Mojmir-older_seniors_card_le"><span class="command">lemma</span></span> older_seniors_card_le<span class="main">:</span>
  <span class="quoted"><span class="quoted">"card <span class="main">(</span>older_seniors <span class="free">x</span> <span class="free">n</span><span class="main">)</span> <span class="main">&lt;</span> card <span class="main">(</span>older_seniors <span class="free">y</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟷</span> older_seniors <span class="free">x</span> <span class="free">n</span> <span class="main">⊂</span> older_seniors <span class="free">y</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_mono card_psubset not_le older_seniors_cases_subseteq older_seniors_finite psubset_card_mono<span class="main">)</span>

<span class="keyword1" id="Semi_Mojmir-older_seniors_card_less"><span class="command">lemma</span></span> older_seniors_card_less<span class="main">:</span>
  <span class="quoted"><span class="quoted">"card <span class="main">(</span>older_seniors <span class="free">x</span> <span class="free">n</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>older_seniors <span class="free">y</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟷</span> older_seniors <span class="free">x</span> <span class="free">n</span> <span class="main">⊆</span> older_seniors <span class="free">y</span> <span class="free">n</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> not_le older_seniors_card_mono older_seniors_cases_subseteq older_seniors_psubset_card_mono subset_not_subset_eq<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Monotonicity›</span></span>

<span class="keyword1" id="Semi_Mojmir-older_seniors_monotonic_Suc"><span class="command">lemma</span></span> older_seniors_monotonic_Suc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"older_seniors <span class="free">x</span> <span class="free">n</span> <span class="main">⊇</span> older_seniors <span class="free">x</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> older_seniors <span class="free">x</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ox</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> senior <span class="skolem">ox</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&lt;</span> senior <span class="free">x</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> sink <span class="main">(</span>token_run <span class="skolem">y</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> older_seniors.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> senior <span class="skolem">y</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> senior_senior senior_le_token senior_monotonic_Suc assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute add.left_commute dual_order.order_iff_strict linear not_add_less1 not_less le_iff_add<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&lt;</span> senior <span class="free">x</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms less_le_trans<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">&lt;</span> senior <span class="free">x</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>›</span></span> senior_monotonic_Suc<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> sink <span class="main">(</span>token_run <span class="skolem">y</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> sink <span class="main">(</span>token_run <span class="skolem">y</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span>›</span></span> token_stays_in_sink
    <span class="keyword1"><span class="command">unfolding</span></span> Suc_eq_plus1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> older_seniors <span class="free">x</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> older_seniors.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Semi_Mojmir-older_seniors_monotonic"><span class="command">lemma</span></span> older_seniors_monotonic<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> older_seniors <span class="free">x</span> <span class="free">n</span> <span class="main">⊇</span> older_seniors <span class="free">x</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> older_seniors_monotonic_Suc add_Suc_right dual_order.trans trans_le_add1<span class="main">)</span>

<span class="keyword1" id="Semi_Mojmir-older_seniors_stable"><span class="command">lemma</span></span> older_seniors_stable<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> older_seniors <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> older_seniors <span class="free">x</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span> <span class="main">+</span> <span class="free">m'</span><span class="main">)</span> <span class="main">⟹</span> older_seniors <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> older_seniors <span class="free">x</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> set_eq_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> dual_order.trans le_add1 older_seniors_monotonic<span class="main">)</span>

<span class="keyword1" id="Semi_Mojmir-card_older_seniors_monotonic"><span class="command">lemma</span></span> card_older_seniors_monotonic<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> card <span class="main">(</span>older_seniors <span class="free">x</span> <span class="free">n</span><span class="main">)</span> <span class="main">≥</span> card <span class="main">(</span>older_seniors <span class="free">x</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> older_seniors_monotonic older_seniors_card_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Pull-Up and Push-Down›</span></span>

<span class="keyword1" id="Semi_Mojmir-pull_up_senior_older_seniors"><span class="command">lemma</span></span> pull_up_senior_older_seniors<span class="main">:</span>
  <span class="quoted"><span class="quoted">"senior <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> senior <span class="free">y</span> <span class="free">n</span> <span class="main">⟹</span> older_seniors <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> older_seniors <span class="free">y</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> older_seniors.simps senior.simps senior_token_run <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>

<span class="keyword1" id="Semi_Mojmir-pull_up_senior_older_seniors_less"><span class="command">lemma</span></span> pull_up_senior_older_seniors_less<span class="main">:</span>
  <span class="quoted"><span class="quoted">"senior <span class="free">x</span> <span class="free">n</span> <span class="main">&lt;</span> senior <span class="free">y</span> <span class="free">n</span> <span class="main">⟹</span> older_seniors <span class="free">x</span> <span class="free">n</span> <span class="main">⊆</span> older_seniors <span class="free">y</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Semi_Mojmir-pull_up_senior_older_seniors_less_2"><span class="command">lemma</span></span> pull_up_senior_older_seniors_less_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> sink <span class="main">(</span>token_run <span class="free">x</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"senior <span class="free">x</span> <span class="free">n</span> <span class="main">&lt;</span> senior <span class="free">y</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"older_seniors <span class="free">x</span> <span class="free">n</span> <span class="main">⊂</span> older_seniors <span class="free">y</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"senior <span class="free">x</span> <span class="free">n</span> <span class="main">∈</span> older_seniors <span class="free">y</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> senior_same_state<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> older_seniors.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> older_seniors_not_self_referential pull_up_senior_older_seniors_less<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Semi_Mojmir-pull_up_senior_older_seniors_le"><span class="command">lemma</span></span> pull_up_senior_older_seniors_le<span class="main">:</span>
  <span class="quoted"><span class="quoted">"senior <span class="free">x</span> <span class="free">n</span> <span class="main">≤</span> senior <span class="free">y</span> <span class="free">n</span> <span class="main">⟹</span> older_seniors <span class="free">x</span> <span class="free">n</span> <span class="main">⊆</span> older_seniors <span class="free">y</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pull_up_senior_older_seniors pull_up_senior_older_seniors_less
  <span class="keyword1"><span class="command">unfolding</span></span> dual_order.order_iff_strict <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Semi_Mojmir-push_down_older_seniors_senior"><span class="command">lemma</span></span> push_down_older_seniors_senior<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> sink <span class="main">(</span>token_run <span class="free">x</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> sink <span class="main">(</span>token_run <span class="free">y</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"older_seniors <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> older_seniors <span class="free">y</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"senior <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> senior <span class="free">y</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"senior <span class="free">x</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">" senior <span class="free">y</span> <span class="free">n</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linorder_cases<span class="main">)</span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> pull_up_senior_older_seniors_less_2<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Tower Lemma›</span></span>

<span class="keyword1" id="Semi_Mojmir-older_seniors_tower''"><span class="command">lemma</span></span> older_seniors_tower''<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="main">(</span>token_run <span class="free">x</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="main">(</span>token_run <span class="free">y</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"older_seniors <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> older_seniors <span class="free">x</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"older_seniors <span class="free">y</span> <span class="free">n</span> <span class="main">⊆</span> older_seniors <span class="free">x</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"older_seniors <span class="free">y</span> <span class="free">n</span> <span class="main">=</span> older_seniors <span class="free">y</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> older_seniors <span class="free">y</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"older_seniors <span class="free">y</span> <span class="free">n</span> <span class="main">⊂</span> older_seniors <span class="free">x</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> older_seniors <span class="free">x</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="main">(</span>token_run <span class="skolem">s</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">z</span><span class="main">.</span> <span class="skolem">s</span> <span class="main">=</span> senior <span class="bound">z</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"senior <span class="free">y</span> <span class="free">n</span> <span class="main">≤</span> senior <span class="free">y</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>senior <span class="free">y</span> <span class="free">n</span> <span class="main">≤</span> senior <span class="free">y</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"senior <span class="free">y</span> <span class="free">n</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> senior_le_token le_trans<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span><span class="main">.</span> senior <span class="free">y</span> <span class="free">n</span> <span class="main">≠</span> senior <span class="bound">z</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> token_run_merge_Suc<span class="main">[</span><span class="operator">unfolded</span> senior_token_run<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">≤</span> <span class="free">n</span>›</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> senior_senior le_refl<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"senior <span class="free">y</span> <span class="free">n</span> <span class="main">∉</span> older_seniors <span class="free">x</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"senior <span class="free">y</span> <span class="free">n</span> <span class="main">∈</span> older_seniors <span class="free">x</span> <span class="free">n</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹older_seniors <span class="free">y</span> <span class="free">n</span> <span class="main">⊂</span> older_seniors <span class="free">x</span> <span class="free">n</span>›</span></span> older_seniors_subset_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">unfolding</span></span> assms <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">&lt;</span> senior <span class="free">y</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">s</span> <span class="main">∈</span> older_seniors <span class="free">y</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> older_seniors <span class="free">y</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> older_seniors.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> older_seniors <span class="free">y</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"older_seniors <span class="free">y</span> <span class="free">n</span> <span class="main">=</span> older_seniors <span class="free">x</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"senior <span class="free">y</span> <span class="free">n</span> <span class="main">=</span> senior <span class="free">x</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3-4<span class="main">)</span> push_down_older_seniors_senior <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"senior <span class="free">y</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> senior <span class="free">x</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> token_run_merge_Suc<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> senior_token_run <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> older_seniors <span class="free">y</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> older_seniors_senior_simp<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"older_seniors <span class="free">y</span> <span class="free">n</span> <span class="main">⊆</span> older_seniors <span class="free">y</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">metis</span> older_seniors_monotonic_Suc assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Semi_Mojmir-older_seniors_tower''2"><span class="command">lemma</span></span> older_seniors_tower''2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="main">(</span>token_run <span class="free">x</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="main">(</span>token_run <span class="free">y</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"older_seniors <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> older_seniors <span class="free">x</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"older_seniors <span class="free">y</span> <span class="free">n</span> <span class="main">⊆</span> older_seniors <span class="free">x</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"older_seniors <span class="free">y</span> <span class="free">n</span> <span class="main">=</span> older_seniors <span class="free">y</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="main">(</span>token_run <span class="free">x</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="main">(</span>token_run <span class="free">y</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span>sink <span class="main">(</span>token_run <span class="free">x</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span>sink <span class="main">(</span>token_run <span class="free">y</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> token_stays_in_sink<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> Suc_eq_plus1 add.assoc<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"older_seniors <span class="free">x</span> <span class="skolem">n</span> <span class="main">=</span> older_seniors <span class="free">x</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>5<span class="main">)</span> older_seniors_stable<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≤</span> <span class="skolem">n</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> Suc_eq_plus1 add.assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"older_seniors <span class="free">x</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> older_seniors <span class="free">x</span> <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Suc.prems add_Suc_right <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"older_seniors <span class="free">y</span> <span class="skolem">n</span> <span class="main">=</span> older_seniors <span class="free">y</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> older_seniors <span class="free">y</span> <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> older_seniors_tower''<span class="main">[</span><span class="operator">OF</span> _ _ <span class="quoted"><span class="quoted">‹<span class="main">¬</span>sink <span class="main">(</span>token_run <span class="free">x</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span>sink <span class="main">(</span>token_run <span class="free">y</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹older_seniors <span class="free">x</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> older_seniors <span class="free">x</span> <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span>›</span></span><span class="main">]</span> Suc
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹older_seniors <span class="free">x</span> <span class="skolem">n</span> <span class="main">=</span> older_seniors <span class="free">x</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span>›</span></span> add.commute add.left_commute calculation le_iff_add<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> add_Suc_right <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Semi_Mojmir-older_seniors_tower'"><span class="command">lemma</span></span> older_seniors_tower'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> older_seniors <span class="free">x</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"older_seniors <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> older_seniors <span class="free">x</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"older_seniors <span class="free">y</span> <span class="free">n</span> <span class="main">=</span> older_seniors <span class="free">y</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>older_seniors <span class="free">x</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"older_seniors <span class="skolem">x</span> <span class="free">n</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> older_seniors_finite card_eq_0_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">c</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?os</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"older_seniors <span class="skolem">x</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?os</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> Max <span class="var">?os</span> <span class="main">∨</span> <span class="skolem">y</span> <span class="main">∈</span> older_seniors <span class="main">(</span>Max <span class="var">?os</span><span class="main">)</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>1<span class="main">)</span> older_seniors_recursive <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"older_seniors <span class="main">(</span>Max <span class="var">?os</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> older_seniors <span class="main">(</span>Max <span class="var">?os</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>2<span class="main">)</span> older_seniors_recursive <span class="quoted"><span class="quoted">‹<span class="var">?os</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span> older_seniors_not_self_referential_2
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_empty_left Un_insert_left insert_ident<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> older_seniors <span class="main">(</span>Max <span class="var">?os</span><span class="main">)</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> Suc.hyps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>older_seniors <span class="main">(</span>Max <span class="var">?os</span><span class="main">)</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> older_seniors_recursive_card<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="var">?os</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"older_seniors <span class="skolem">s</span> <span class="free">n</span> <span class="main">=</span> older_seniors <span class="skolem">s</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹older_seniors <span class="main">(</span>Max <span class="var">?os</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> older_seniors <span class="main">(</span>Max <span class="var">?os</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Semi_Mojmir-older_seniors_tower"><span class="command">lemma</span></span> older_seniors_tower<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">x</span> <span class="main">≤</span> <span class="free">n</span><span class="main">;</span> <span class="free">y</span> <span class="main">∈</span> older_seniors <span class="free">x</span> <span class="free">n</span><span class="main">;</span> older_seniors <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> older_seniors <span class="free">x</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> older_seniors <span class="free">y</span> <span class="free">n</span> <span class="main">=</span> older_seniors <span class="free">y</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"older_seniors <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> older_seniors <span class="free">x</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> older_seniors_monotonic older_seniors_monotonic_Suc subset_antisym
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Nat.add_0_right add.assoc add_Suc_shift trans_le_add1<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"older_seniors <span class="free">y</span> <span class="free">n</span> <span class="main">=</span> older_seniors <span class="free">y</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc.IH<span class="main">[</span><span class="operator">OF</span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> older_seniors <span class="free">y</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> Suc <span class="skolem">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> older_seniors_tower'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">+</span> <span class="skolem">m</span>"</span></span><span class="main">]</span> Suc.prems <span class="keyword1"><span class="command">unfolding</span></span> add_Suc_right
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹older_seniors <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> older_seniors <span class="free">x</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Rank›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Properties›</span></span>

<span class="keyword1" id="Semi_Mojmir-rank_None_before"><span class="command">lemma</span></span> rank_None_before<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="free">n</span> <span class="main">⟹</span> rank <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Semi_Mojmir-rank_None_Suc"><span class="command">lemma</span></span> rank_None_Suc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">x</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sink <span class="main">(</span>token_run <span class="free">x</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> rank.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sink <span class="main">(</span>token_run <span class="free">x</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> token_stays_in_sink <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>erased<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> Suc_leD le_Suc_ex not_less_eq_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Semi_Mojmir-rank_Some_time"><span class="command">lemma</span></span> rank_Some_time<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rank <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">j</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> rank.simps<span class="main">)</span>

<span class="keyword1" id="Semi_Mojmir-rank_Some_sink"><span class="command">lemma</span></span> rank_Some_sink<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rank <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">j</span> <span class="main">⟹</span> <span class="main">¬</span>sink <span class="main">(</span>token_run <span class="free">x</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Semi_Mojmir-rank_Some_card"><span class="command">lemma</span></span> rank_Some_card<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rank <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">j</span> <span class="main">⟹</span> card <span class="main">(</span>older_seniors <span class="free">x</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> option.inject rank.simps<span class="main">)</span>

<span class="keyword1" id="Semi_Mojmir-rank_initial"><span class="command">lemma</span></span> rank_initial<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> rank <span class="free">x</span> <span class="free">x</span> <span class="main">=</span> Some <span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rank.simps sink_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Semi_Mojmir-rank_continuous"><span class="command">lemma</span></span> rank_continuous<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">x</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m'</span> <span class="main">≤</span> <span class="free">m</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span><span class="main">.</span> rank <span class="free">x</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m'</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">k</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">m'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">m'</span> <span class="main">=</span> Suc <span class="skolem">m</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> Suc.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m'</span> <span class="main">≤</span> <span class="skolem">m</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">x</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">j'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> rank_Some_time rank_None_Suc
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_Suc_right add_lessD1 not_less rank.simps<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> Suc.IH<span class="main">[</span><span class="operator">OF</span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Semi_Mojmir-rank_token_squats"><span class="command">lemma</span></span> rank_token_squats<span class="main">:</span>
  <span class="quoted"><span class="quoted">"token_squats <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> rank <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> Some <span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> token_squats_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Semi_Mojmir-rank_older_seniors_bounded"><span class="command">lemma</span></span> rank_older_seniors_bounded<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> older_seniors <span class="free">x</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j'</span></span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">.</span> rank <span class="free">y</span> <span class="free">n</span> <span class="main">=</span> Some <span class="bound">j'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="main">(</span>token_run <span class="free">y</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dual_order.trans linear not_less older_seniors_older option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> rank.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"older_seniors <span class="free">y</span> <span class="free">n</span> <span class="main">⊂</span> older_seniors <span class="free">x</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> older_seniors_subset assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>older_seniors <span class="free">y</span> <span class="free">n</span><span class="main">)</span> <span class="main">&lt;</span> card <span class="main">(</span>older_seniors <span class="free">x</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> older_seniors_psubset_card_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> rank_Some_card<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> rank.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Bounds›</span></span>

<span class="keyword1" id="Semi_Mojmir-max_rank_lowerbound"><span class="command">lemma</span></span> max_rank_lowerbound<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> max_rank"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">Σ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nonempty_Σ <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"range <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> run <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> reach <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> reach_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> reach_card_0<span class="main">[</span><span class="operator">OF</span> nonempty_Σ<span class="main">]</span> finite_reach max_rank_def sink_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Semi_Mojmir-older_seniors_card_bounded"><span class="command">lemma</span></span> older_seniors_card_bounded<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="main">(</span>token_run <span class="free">x</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>older_seniors <span class="free">x</span> <span class="free">n</span><span class="main">)</span> <span class="main">&lt;</span> card <span class="main">(</span>reach <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">-</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> sink <span class="bound">q</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?S4</span> <span class="main">&lt;</span> card <span class="var">?S0</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>token_run <span class="bound">x</span> <span class="bound">n</span> <span class="main">|</span> <span class="bound">x</span> <span class="bound">n</span><span class="main">.</span> True<span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> sink <span class="bound">q</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> the <span class="main">(</span>oldest_token <span class="bound">q</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="var">?S1</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S3</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> senior <span class="bound">x</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">¬</span><span class="main">(</span>sink <span class="main">(</span>token_run <span class="bound">s</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S1</span> <span class="main">⊆</span> <span class="var">?S0</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> reach_def token_run.simps <span class="keyword1"><span class="command">using</span></span> bounded_w <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?S1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> C1<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="var">?S1</span> <span class="main">≤</span> card <span class="var">?S0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_reach card_mono finite_subset
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">{</span>token_run <span class="bound">x</span> <span class="bound">n</span> <span class="main">|</span><span class="bound">x</span> <span class="bound">n</span><span class="main">.</span> True<span class="main">}</span> <span class="main">-</span> Collect sink <span class="main">⊆</span> reach <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">-</span> Collect sink›</span></span> card_mono finite_Diff local.finite_reach<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?S2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> C2<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="var">?S2</span> <span class="main">≤</span> card <span class="var">?S1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_imageI card_image_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S3</span> <span class="main">⊆</span> <span class="var">?S2</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="var">?S3</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> senior <span class="skolem">s</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="main">(</span>token_run <span class="skolem">s</span> <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> senior_senior <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="var">?S2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?S3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> C3<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="var">?S3</span> <span class="main">≤</span> card <span class="var">?S2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> card_mono finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"senior <span class="free">x</span> <span class="free">n</span> <span class="main">∈</span> <span class="var">?S3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"senior <span class="free">x</span> <span class="free">n</span> <span class="main">∉</span> <span class="var">?S4</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S4</span> <span class="main">⊆</span> <span class="var">?S3</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms older_seniors_not_self_referential senior_same_state <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S4</span> <span class="main">⊂</span> <span class="var">?S3</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?S4</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> C4<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="var">?S4</span> <span class="main">&lt;</span> card <span class="var">?S3</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> psubset_card_mono finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> C1 C2 C3 C4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Semi_Mojmir-rank_upper_bound"><span class="command">lemma</span></span> rank_upper_bound<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rank <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">i</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> max_rank"</span></span>
  <span class="keyword1"><span class="command">using</span></span> older_seniors_card_bounded <span class="keyword1"><span class="command">unfolding</span></span> max_rank_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> rank_Some_card rank_Some_time rank_Some_sink <span class="main">)</span>

<span class="keyword1" id="Semi_Mojmir-rank_range"><span class="command">lemma</span></span> rank_range<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> range <span class="main">(</span>rank <span class="free">x</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>None<span class="main">}</span> <span class="main">∪</span> Some <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">i</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i_option</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i_option</span> <span class="main">∈</span> range <span class="main">(</span>rank <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i_option</span> <span class="main">∈</span> <span class="main">{</span>None<span class="main">}</span> <span class="main">∪</span> Some <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>max_rank<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i_option</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">i</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>max_rank<span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i_option</span> <span class="main">∈</span> range <span class="main">(</span>rank <span class="free">x</span><span class="main">)</span>›</span></span> rank_upper_bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> Some <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"range <span class="main">(</span>rank <span class="free">x</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">{</span>None<span class="main">}</span> <span class="main">∪</span> Some <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>max_rank<span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Monotonicity›</span></span>

<span class="keyword1" id="Semi_Mojmir-rank_monotonic"><span class="command">lemma</span></span> rank_monotonic<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>rank <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">i</span><span class="main">;</span> rank <span class="free">x</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">j</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≥</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> card_older_seniors_monotonic rank_Some_card rank_Some_time <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Pull-Up and Push-Down›</span></span>

<span class="keyword1" id="Semi_Mojmir-pull_up_senior_rank"><span class="command">lemma</span></span> pull_up_senior_rank<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">x</span> <span class="main">≤</span> <span class="free">n</span><span class="main">;</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">n</span><span class="main">;</span> senior <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> senior <span class="free">y</span> <span class="free">n</span><span class="main">⟧</span> <span class="main">⟹</span> rank <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> rank <span class="free">y</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> senior_token_run rank.simps pull_up_senior_older_seniors<span class="main">)</span>

<span class="keyword1" id="Semi_Mojmir-pull_up_configuration_rank"><span class="command">lemma</span></span> pull_up_configuration_rank<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">x</span> <span class="main">∈</span> configuration <span class="free">q</span> <span class="free">n</span><span class="main">;</span> <span class="free">y</span> <span class="main">∈</span> configuration <span class="free">q</span> <span class="free">n</span><span class="main">⟧</span> <span class="main">⟹</span> rank <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> rank <span class="free">y</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Semi_Mojmir-push_down_rank_older_seniors"><span class="command">lemma</span></span> push_down_rank_older_seniors<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>rank <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> rank <span class="free">y</span> <span class="free">n</span><span class="main">;</span> rank <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">i</span><span class="main">⟧</span> <span class="main">⟹</span> older_seniors <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> older_seniors <span class="free">y</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> older_seniors_card option.distinct<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> option.sel rank.simps<span class="main">)</span>

<span class="keyword1" id="Semi_Mojmir-push_down_rank_senior"><span class="command">lemma</span></span> push_down_rank_senior<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>rank <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> rank <span class="free">y</span> <span class="free">n</span><span class="main">;</span> rank <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">i</span><span class="main">⟧</span> <span class="main">⟹</span> senior <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> senior <span class="free">y</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> push_down_rank_older_seniors push_down_older_seniors_senior option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> rank.elims<span class="main">)</span>

<span class="keyword1" id="Semi_Mojmir-push_down_rank_tokens"><span class="command">lemma</span></span> push_down_rank_tokens<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>rank <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> rank <span class="free">y</span> <span class="free">n</span><span class="main">;</span> rank <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">i</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> configuration <span class="bound">q</span> <span class="free">n</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">∈</span> configuration <span class="bound">q</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> push_down_senior_tokens rank_Some_time push_down_rank_senior<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Pulled-Up Lemmas›</span></span>

<span class="keyword1" id="Semi_Mojmir-rank_senior_senior"><span class="command">lemma</span></span> rank_senior_senior<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> rank <span class="main">(</span>senior <span class="free">x</span> <span class="free">n</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> rank <span class="free">x</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_iff_add add.commute add.left_commute pull_up_senior_rank senior_le_token senior_senior<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Stable Rank›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">stable_rank</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">stable_rank</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">n</span><span class="main">.</span> rank <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">n</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Semi_Mojmir-stable_rank_unique"><span class="command">lemma</span></span> stable_rank_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"stable_rank <span class="free">x</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"stable_rank <span class="free">x</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n'</span><span class="main">.</span> <span class="bound">n'</span> <span class="main">≥</span> <span class="skolem">n</span> <span class="main">⟹</span> rank <span class="free">x</span> <span class="bound">n'</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m'</span><span class="main">.</span> <span class="bound">m'</span> <span class="main">≥</span> <span class="skolem">m</span> <span class="main">⟹</span> rank <span class="free">x</span> <span class="bound">m'</span> <span class="main">=</span> Some <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> stable_rank_def MOST_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">x</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">x</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute le_add1<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Semi_Mojmir-stable_rank_equiv_token_squats"><span class="command">lemma</span></span> stable_rank_equiv_token_squats<span class="main">:</span>
  <span class="quoted"><span class="quoted">"token_squats <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> stable_rank <span class="free">x</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ranks</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ranks</span> <span class="main">=</span> <span class="main">{</span><span class="bound">j</span> <span class="main">|</span> <span class="bound">j</span> <span class="bound">n</span><span class="main">.</span> rank <span class="free">x</span> <span class="bound">n</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ranks</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>max_rank<span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>rank <span class="free">x</span> <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">ranks</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rank_upper_bound rank_initial<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> ranks_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span> <span class="comment1">(* Takes roughly 10s *)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">ranks</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ranks</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_reach finite_atLeastAtMost infinite_super <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> Min <span class="skolem">ranks</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">x</span> <span class="skolem">n</span> <span class="main">=</span> Some <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Min_in<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">ranks</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ranks</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> i_def ranks_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∈</span> <span class="skolem">ranks</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">≥</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Min_in<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">ranks</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ranks</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> i_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Min.coboundedI <span class="quoted"><span class="quoted">‹finite <span class="skolem">ranks</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span> <span class="bound">j</span><span class="main">.</span> rank <span class="free">x</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="bound">m</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">j</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">≥</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ranks_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span> <span class="bound">j</span><span class="main">.</span> rank <span class="free">x</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="bound">m</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">j</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rank_monotonic<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹rank <span class="free">x</span> <span class="skolem">n</span> <span class="main">=</span> Some <span class="skolem">i</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span><span class="main">.</span> <span class="main">∃</span><span class="bound">j</span><span class="main">.</span> rank <span class="free">x</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="bound">m</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rank_token_squats<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="var">?lhs</span>›</span></span><span class="main">]</span> rank_Some_time<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹rank <span class="free">x</span> <span class="skolem">n</span> <span class="main">=</span> Some <span class="skolem">i</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span><span class="main">.</span> rank <span class="free">x</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="bound">m</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> stable_rank_def MOST_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_iff_add<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> token_squats_def stable_rank_def MOST_nat_le
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_add2 rank_Some_sink token_stays_in_sink<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Semi_Mojmir-stable_rank_same_tokens"><span class="command">lemma</span></span> stable_rank_same_tokens<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"stable_rank <span class="free">x</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"stable_rank <span class="free">y</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> configuration <span class="free">q</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> configuration <span class="free">q</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n_i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n_i</span> <span class="main">≥</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t</span></span> <span class="main">≥</span> <span class="skolem">n_i</span><span class="main">.</span> rank <span class="free">x</span> <span class="bound">t</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> stable_rank_def MOST_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> linear order_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n_j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n_j</span> <span class="main">≥</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">t</span></span> <span class="main">≥</span> <span class="skolem">n_j</span><span class="main">.</span> rank <span class="free">y</span> <span class="bound">t</span> <span class="main">=</span> Some <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> stable_rank_def MOST_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> linear order_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> max <span class="skolem">n_i</span> <span class="skolem">n_j</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">x</span> <span class="skolem">m</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">y</span> <span class="skolem">m</span> <span class="main">=</span> Some <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> max.bounded_iff order_refl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≥</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">≤</span> <span class="skolem">n_j</span>›</span></span> le_trans max.cobounded2 m_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q'</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> configuration <span class="bound">q'</span> <span class="skolem">m</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">∈</span> configuration <span class="bound">q'</span> <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> push_down_configuration_token_run<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> token_run_merge<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> pull_up_token_run_tokens<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="skolem">m</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">≥</span> <span class="free">n</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> le_iff_add<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> pull_up_configuration_rank <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.inject<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Tower Lemma›</span></span>

<span class="keyword1" id="Semi_Mojmir-rank_tower"><span class="command">lemma</span></span> rank_tower<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">x</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">y</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">y</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linorder_cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> less
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>older_seniors <span class="main">(</span>senior <span class="free">y</span> <span class="free">n</span><span class="main">)</span> <span class="free">n</span><span class="main">)</span> <span class="main">&lt;</span> card <span class="main">(</span>older_seniors <span class="free">x</span> <span class="free">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms rank_Some_card senior_same_state <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"senior <span class="free">y</span> <span class="free">n</span> <span class="main">∈</span> older_seniors <span class="free">x</span> <span class="free">n</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> older_seniors_card_le rank_Some_sink assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> older_seniors_senior_simp older_seniors_subset_2<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"older_seniors <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> older_seniors <span class="free">x</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> rank_Some_card rank_Some_time card_subset_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> older_seniors_finite<span class="main"><span class="main">]</span></span> older_seniors_monotonic<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"older_seniors <span class="main">(</span>senior <span class="free">y</span> <span class="free">n</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> older_seniors <span class="main">(</span>senior <span class="free">y</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"senior <span class="free">y</span> <span class="free">n</span> <span class="main">∈</span> older_seniors <span class="free">x</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> older_seniors_tower rank_Some_time assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rank <span class="main">(</span>senior <span class="free">y</span> <span class="free">n</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> rank_Some_time rank_senior_senior<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rank <span class="main">(</span>senior <span class="free">y</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rank_older_seniors_bounded<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> rank_Some_card<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"senior <span class="free">y</span> <span class="free">n</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹rank <span class="main">(</span>senior <span class="free">y</span> <span class="free">n</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">i</span>›</span></span> rank_Some_time<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"senior <span class="free">y</span> <span class="free">n</span> <span class="main">∈</span> configuration <span class="main">(</span>token_run <span class="free">y</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> token_run_merge<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ rank_Some_time<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> senior_same_state<span class="main"><span class="main">]</span></span> configuration_token trans_le_add1<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> pull_up_configuration_rank le_iff_add add.assoc assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> configuration_token rank_Some_time<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> equal
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"token_run <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> token_run <span class="free">y</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2-4<span class="main">)</span> push_down_rank_tokens <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"token_run <span class="free">x</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> token_run <span class="free">y</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> token_run_merge <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> equal rank_senior_senior senior_token_run le_iff_add add.assoc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>›</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">linarith</span><span class="main">)</span>

<span class="keyword1" id="Semi_Mojmir-stable_rank_alt_def"><span class="command">lemma</span></span> stable_rank_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rank <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">j</span> <span class="main">∧</span> stable_rank <span class="free">x</span> <span class="free">j</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">m</span></span> <span class="main">≥</span> <span class="free">n</span><span class="main">.</span> rank <span class="free">x</span> <span class="bound">m</span> <span class="main">=</span> Some <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">⟷</span> <span class="var">?lhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">m</span></span> <span class="main">≥</span> <span class="skolem">m'</span><span class="main">.</span> rank <span class="free">x</span> <span class="bound">m</span> <span class="main">=</span> Some <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> stable_rank_def MOST_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"rank <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">x</span> <span class="skolem">m'</span> <span class="main">=</span> Some <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?rhs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">+</span> <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">+</span> <span class="skolem">m</span> <span class="main">&lt;</span> <span class="skolem">m'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">x</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">j'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="var">?rhs</span>›</span></span> stable_rank_equiv_token_squats rank_Some_time rank_token_squats trans_le_add1<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹rank <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">j</span>›</span></span> rank_monotonic <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="skolem">j'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹rank <span class="free">x</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">j'</span>›</span></span> <span class="quoted"><span class="quoted">‹rank <span class="free">x</span> <span class="skolem">m'</span> <span class="main">=</span> Some <span class="free">j</span>›</span></span>  <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">+</span> <span class="skolem">m</span> <span class="main">&lt;</span> <span class="skolem">m'</span>›</span></span> rank_monotonic
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_Suc_right less_imp_Suc_add<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">x</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_add_diff_inverse not_le<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">unfold</span> stable_rank_def MOST_nat_le<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="Semi_Mojmir-stable_rank_tower"><span class="command">lemma</span></span> stable_rank_tower<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">y</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"stable_rank <span class="free">y</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"stable_rank <span class="free">x</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms rank_tower<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">≤</span> <span class="free">i</span>›</span></span><span class="main">]</span> stable_rank_alt_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> stable_rank_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">,</span> <span class="operator">unfolded</span> MOST_nat_le<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_Suc_ex<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Senior States›</span></span>

<span class="keyword1" id="Semi_Mojmir-senior_states_initial"><span class="command">lemma</span></span> senior_states_initial<span class="main">:</span>
  <span class="quoted"><span class="quoted">"senior_states <span class="free">q</span> <span class="main">0</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Semi_Mojmir-senior_states_cases_subseteq"><span class="command">lemma</span></span> senior_states_cases_subseteq <span class="main">[</span><span class="operator">case_names</span> le ge<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"senior_states <span class="free">p</span> <span class="free">n</span> <span class="main">⊆</span> senior_states <span class="free">q</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"senior_states <span class="free">p</span> <span class="free">n</span> <span class="main">⊇</span> senior_states <span class="free">q</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Semi_Mojmir-senior_states_cases_subset"><span class="command">lemma</span></span> senior_states_cases_subset <span class="main">[</span><span class="operator">case_names</span> less equal greater<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"senior_states <span class="free">p</span> <span class="free">n</span> <span class="main">⊂</span> senior_states <span class="free">q</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"senior_states <span class="free">p</span> <span class="free">n</span> <span class="main">=</span> senior_states <span class="free">q</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"senior_states <span class="free">p</span> <span class="free">n</span> <span class="main">⊃</span> senior_states <span class="free">q</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms senior_states_cases_subseteq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Semi_Mojmir-senior_states_finite"><span class="command">lemma</span></span> senior_states_finite<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>senior_states <span class="free">q</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemmas</span></span> senior_states_card_mono <span class="main">=</span> card_mono<span class="main">[</span><span class="operator">OF</span> senior_states_finite<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> senior_states_psubset_card_mono <span class="main">=</span> psubset_card_mono<span class="main">[</span><span class="operator">OF</span> senior_states_finite<span class="main">]</span>

<span class="keyword1" id="Semi_Mojmir-senior_states_card"><span class="command">lemma</span></span> senior_states_card<span class="main">:</span>
  <span class="quoted"><span class="quoted">"card <span class="main">(</span>senior_states <span class="free">p</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>senior_states <span class="free">q</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟷</span> senior_states <span class="free">p</span> <span class="free">n</span> <span class="main">=</span> senior_states <span class="free">q</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_not_refl senior_states_cases_subset senior_states_psubset_card_mono<span class="main">)</span>

<span class="keyword1" id="Semi_Mojmir-senior_states_card_le"><span class="command">lemma</span></span> senior_states_card_le<span class="main">:</span>
  <span class="quoted"><span class="quoted">"card <span class="main">(</span>senior_states <span class="free">p</span> <span class="free">n</span><span class="main">)</span> <span class="main">&lt;</span> card <span class="main">(</span>senior_states <span class="free">q</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟷</span> senior_states <span class="free">p</span> <span class="free">n</span> <span class="main">⊂</span> senior_states <span class="free">q</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_mono not_less senior_states_cases_subseteq senior_states_finite senior_states_psubset_card_mono subset_not_subset_eq<span class="main">)</span>

<span class="keyword1" id="Semi_Mojmir-senior_states_card_less"><span class="command">lemma</span></span> senior_states_card_less<span class="main">:</span>
  <span class="quoted"><span class="quoted">"card <span class="main">(</span>senior_states <span class="free">p</span> <span class="free">n</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>senior_states <span class="free">q</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟷</span> senior_states <span class="free">p</span> <span class="free">n</span> <span class="main">⊆</span> senior_states <span class="free">q</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_mono card_seteq senior_states_cases_subseteq senior_states_finite<span class="main">)</span>

<span class="keyword1" id="Semi_Mojmir-senior_states_older_seniors"><span class="command">lemma</span></span> senior_states_older_seniors<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> token_run <span class="bound">y</span> <span class="free">n</span><span class="main">)</span> <span class="main">`</span> older_seniors <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> senior_states <span class="main">(</span>token_run <span class="free">x</span> <span class="free">n</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="main">{</span><span class="bound">q'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">ost</span> <span class="bound">ot</span><span class="main">.</span> <span class="bound">q'</span> <span class="main">=</span> token_run <span class="bound">ost</span> <span class="free">n</span> <span class="main">∧</span> <span class="bound">ost</span> <span class="main">=</span> senior <span class="bound">ot</span> <span class="free">n</span> <span class="main">∧</span> <span class="bound">ost</span> <span class="main">&lt;</span> senior <span class="free">x</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">¬</span> sink <span class="bound">q'</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">{</span><span class="bound">q'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">t</span> <span class="bound">ot</span><span class="main">.</span> oldest_token <span class="bound">q'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="bound">t</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">=</span> senior <span class="bound">ot</span> <span class="free">n</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">&lt;</span> senior <span class="free">x</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">¬</span> sink <span class="bound">q'</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> senior.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>erased<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> oldest_token_always_def push_down_oldest_token_token_run option.sel<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">{</span><span class="bound">q'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">t</span><span class="main">.</span> oldest_token <span class="bound">q'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="bound">t</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">&lt;</span> senior <span class="free">x</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">¬</span> sink <span class="bound">q'</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> senior_states.simps senior.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>erased<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> oldest_token_always_def option.sel<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Semi_Mojmir-card_older_senior_senior_states"><span class="command">lemma</span></span> card_older_senior_senior_states<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> configuration <span class="free">q</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>older_seniors <span class="free">x</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>senior_states <span class="free">q</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> token_run <span class="bound">t</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>older_seniors <span class="free">x</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command">using</span></span> senior_same_state
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> token_run.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"token_run <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> card_image<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> token_run <span class="bound">t</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"older_seniors <span class="free">x</span> <span class="free">n</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> senior_states_older_seniors <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Rank of States›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Alternative Definitions›</span></span>

<span class="keyword1" id="Semi_Mojmir-state_rank_eq_rank"><span class="command">lemma</span></span> state_rank_eq_rank<span class="main">:</span>
  <span class="quoted"><span class="quoted">"state_rank <span class="free">q</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> oldest_token <span class="free">q</span> <span class="free">n</span> <span class="keyword1">of</span> None <span class="main">⇒</span> None <span class="main">|</span> Some <span class="bound">t</span> <span class="main">⇒</span> rank <span class="bound">t</span> <span class="free">n</span><span class="main">)</span> "</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"oldest_token <span class="free">q</span> <span class="free">n</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>None<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> not_Some_eq oldest_token.elims option.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> state_rank.elims<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">¬</span>sink <span class="free">q</span> <span class="keyword1">then</span> Some <span class="main">(</span>card <span class="main">(</span>older_seniors <span class="skolem">x</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> emptyE push_down_oldest_token_configuration<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Some<span class="main"><span class="main">]</span></span> card_older_senior_senior_states state_rank.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> rank <span class="skolem">x</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> oldest_token_bounded<span class="main">[</span><span class="operator">OF</span> Some<span class="main">]</span> push_down_oldest_token_token_run<span class="main">[</span><span class="operator">OF</span> Some<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Some <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Semi_Mojmir-state_rank_eq_rank_SOME"><span class="command">lemma</span></span> state_rank_eq_rank_SOME<span class="main">:</span>
  <span class="quoted"><span class="quoted">"state_rank <span class="free">q</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> configuration <span class="free">q</span> <span class="free">n</span> <span class="main">≠</span> <span class="main">{}</span> <span class="keyword1">then</span> rank <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> configuration <span class="free">q</span> <span class="free">n</span><span class="main">)</span> <span class="free">n</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"oldest_token <span class="free">q</span> <span class="free">n</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> state_rank_eq_rank Some option.simps<span class="main">(</span>5<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Some ex_in_conv pull_up_configuration_rank push_down_oldest_token_configuration someI_ex<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">unfold</span> state_rank_eq_rank<span class="main"><span class="keyword3">;</span></span> <span class="operator">metis</span> not_Some_eq oldest_token.elims option.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Semi_Mojmir-rank_eq_state_rank"><span class="command">lemma</span></span> rank_eq_state_rank<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> rank <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> state_rank <span class="main">(</span>token_run <span class="free">x</span> <span class="free">n</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> state_rank_eq_rank_SOME<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"token_run <span class="free">x</span> <span class="free">n</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> all_not_in_conv configuration_token pull_up_configuration_rank someI_ex<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Pull-Up and Push-Down›</span></span>

<span class="keyword1" id="Semi_Mojmir-pull_up_configuration_state_rank"><span class="command">lemma</span></span> pull_up_configuration_state_rank<span class="main">:</span>
  <span class="quoted"><span class="quoted">"configuration <span class="free">q</span> <span class="free">n</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> state_rank <span class="free">q</span> <span class="free">n</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Semi_Mojmir-push_down_state_rank_tokens"><span class="command">lemma</span></span> push_down_state_rank_tokens<span class="main">:</span>
  <span class="quoted"><span class="quoted">"state_rank <span class="free">q</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">i</span> <span class="main">⟹</span> configuration <span class="free">q</span> <span class="free">n</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> not_Some_eq state_rank.elims<span class="main">)</span>

<span class="keyword1" id="Semi_Mojmir-push_down_state_rank_configuration_None"><span class="command">lemma</span></span> push_down_state_rank_configuration_None<span class="main">:</span>
  <span class="quoted"><span class="quoted">"state_rank <span class="free">q</span> <span class="free">n</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="main">¬</span>sink <span class="free">q</span> <span class="main">⟹</span> configuration <span class="free">q</span> <span class="free">n</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> state_rank.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Semi_Mojmir-push_down_state_rank_oldest_token"><span class="command">lemma</span></span> push_down_state_rank_oldest_token<span class="main">:</span>
  <span class="quoted"><span class="quoted">"state_rank <span class="free">q</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">i</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> oldest_token <span class="free">q</span> <span class="free">n</span> <span class="main">=</span> Some <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> oldest_token.elims state_rank.elims<span class="main">)</span>

<span class="keyword1" id="Semi_Mojmir-push_down_state_rank_token_run"><span class="command">lemma</span></span> push_down_state_rank_token_run<span class="main">:</span>
  <span class="quoted"><span class="quoted">"state_rank <span class="free">q</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">i</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> token_run <span class="bound">x</span> <span class="free">n</span> <span class="main">=</span> <span class="free">q</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> push_down_state_rank_oldest_token push_down_oldest_token_token_run oldest_token_bounded<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Properties›</span></span>

<span class="keyword1" id="Semi_Mojmir-state_rank_distinct"><span class="command">lemma</span></span> state_rank_distinct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ranked_1<span class="main">:</span> <span class="quoted"><span class="quoted">"state_rank <span class="free">p</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ranked_2<span class="main">:</span> <span class="quoted"><span class="quoted">"state_rank <span class="free">q</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> configuration <span class="free">p</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> configuration <span class="free">q</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms push_down_state_rank_tokens <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rank <span class="skolem">x</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rank <span class="skolem">y</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms pull_up_configuration_rank <span class="keyword1"><span class="command">unfolding</span></span> state_rank_eq_rank_SOME
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> all_not_in_conv someI_ex<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> configuration <span class="free">q</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> configuration <span class="free">q</span> <span class="free">n</span>›</span></span> push_down_rank_tokens
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">=</span> <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> configuration <span class="free">p</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
    <span class="keyword1"><span class="command">using</span></span> distinct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Semi_Mojmir-state_rank_initial_state"><span class="command">lemma</span></span> state_rank_initial_state<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">i</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"state_rank <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> state_rank.simps sink_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Semi_Mojmir-state_rank_sink"><span class="command">lemma</span></span> state_rank_sink<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sink <span class="free">q</span> <span class="main">⟹</span> state_rank <span class="free">q</span> <span class="free">n</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Semi_Mojmir-state_rank_upper_bound"><span class="command">lemma</span></span> state_rank_upper_bound<span class="main">:</span>
  <span class="quoted"><span class="quoted">"state_rank <span class="free">q</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">i</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> max_rank"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> rank_upper_bound push_down_state_rank_oldest_token state_rank_eq_rank<span class="main">)</span>

<span class="keyword1" id="Semi_Mojmir-state_rank_range"><span class="command">lemma</span></span> state_rank_range<span class="main">:</span>
  <span class="quoted"><span class="quoted">"state_rank <span class="free">q</span> <span class="free">n</span> <span class="main">∈</span> <span class="main">{</span>None<span class="main">}</span> <span class="main">∪</span> Some <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>max_rank<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"state_rank <span class="free">q</span> <span class="free">n</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> state_rank_upper_bound<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Semi_Mojmir-state_rank_None"><span class="command">lemma</span></span> state_rank_None<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="free">q</span> <span class="main">⟹</span> state_rank <span class="free">q</span> <span class="free">n</span> <span class="main">=</span> None <span class="main">⟷</span> oldest_token <span class="free">q</span> <span class="free">n</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Semi_Mojmir-state_rank_Some"><span class="command">lemma</span></span> state_rank_Some<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="free">q</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> state_rank <span class="free">q</span> <span class="free">n</span> <span class="main">=</span> Some <span class="bound">i</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j</span><span class="main">.</span> oldest_token <span class="free">q</span> <span class="free">n</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Semi_Mojmir-state_rank_oldest_token"><span class="command">lemma</span></span> state_rank_oldest_token<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"state_rank <span class="free">p</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"state_rank <span class="free">q</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"oldest_token <span class="free">p</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"oldest_token <span class="free">q</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"configuration <span class="free">p</span> <span class="free">n</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"configuration <span class="free">q</span> <span class="free">n</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> oldest_token.simps option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> state_rank_sink <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> i_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> card <span class="main">(</span>senior_states <span class="free">p</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> j_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">=</span> card <span class="main">(</span>senior_states <span class="free">q</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> option.sel <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟷</span> senior_states <span class="free">p</span> <span class="free">n</span> <span class="main">⊂</span> senior_states <span class="free">q</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> senior_states_card_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> assms<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> senior_states_cases_subset<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">q</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> equal
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> assms state_rank_distinct i_def j_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_irrefl option.sel<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Semi_Mojmir-state_rank_oldest_token_le"><span class="command">lemma</span></span> state_rank_oldest_token_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"state_rank <span class="free">p</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"state_rank <span class="free">q</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"oldest_token <span class="free">p</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"oldest_token <span class="free">q</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> state_rank_oldest_token<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> assms state_rank_distinct oldest_token_equal
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="operator">metis</span> option.sel order_refl<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">metis</span> le_eq_less_or_eq option.inject<span class="main">)</span><span class="main">)</span>

<span class="keyword1" id="Semi_Mojmir-state_rank_in_function_set"><span class="command">lemma</span></span> state_rank_in_function_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> state_rank <span class="bound">q</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">f</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> reach <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟶</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> reach <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟶</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span>None<span class="main">}</span> <span class="main">∪</span> Some <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>max_rank<span class="main">}</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> reach <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">token</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">≠</span> token_run <span class="bound">token</span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> reach_def token_run.simps <span class="keyword1"><span class="command">using</span></span> bounded_w <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"state_rank <span class="skolem">x</span> <span class="free">t</span> <span class="main">=</span> None"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pull_up_configuration_state_rank <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> state_rank_range <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Step Function›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pre_oldest_tokens</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> nat <span class="main">⇒</span> nat set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pre_oldest_tokens</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q'</span><span class="main">.</span> oldest_token <span class="bound">q'</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> Some <span class="bound">x</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="free">δ</span> <span class="bound">q'</span> <span class="main">(</span><span class="free">w</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="keyword1">then</span> <span class="main">{</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Semi_Mojmir-pre_oldest_configuration_range"><span class="command">lemma</span></span> pre_oldest_configuration_range<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pre_oldest_tokens <span class="free">q</span> <span class="free">n</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span>Suc <span class="free">n</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q'</span><span class="main">.</span> oldest_token <span class="bound">q'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="bound">x</span> <span class="main">∧</span> <span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="bound">q'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⊆</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?lhs</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"oldest_token <span class="skolem">q'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?rhs</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> atLeastAtMost_iff <span class="keyword1"><span class="command">using</span></span> oldest_token_bounded<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">q'</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span><span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Semi_Mojmir-pre_oldest_configuration_finite"><span class="command">lemma</span></span> pre_oldest_configuration_finite<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>pre_oldest_tokens <span class="free">q</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pre_oldest_configuration_range finite_atLeastAtMost <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> pre_oldest_configuration_Min_in <span class="main">=</span> Min_in<span class="main">[</span><span class="operator">OF</span> pre_oldest_configuration_finite<span class="main">]</span>

<span class="keyword1" id="Semi_Mojmir-pre_oldest_configuration_obtain"><span class="command">lemma</span></span> pre_oldest_configuration_obtain<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> pre_oldest_tokens <span class="free">q</span> <span class="free">n</span> <span class="main">-</span> <span class="main">{</span>Suc <span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">q'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"oldest_token <span class="free">q'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="free">q'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Semi_Mojmir-pre_oldest_configuration_element"><span class="command">lemma</span></span> pre_oldest_configuration_element<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"oldest_token <span class="free">q'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">ot</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="free">q'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ot</span> <span class="main">∈</span> pre_oldest_tokens <span class="free">q</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ot</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">ot</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q'</span><span class="main">.</span> oldest_token <span class="bound">q'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="bound">ot</span> <span class="main">∧</span> <span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="bound">q'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">⊆</span> pre_oldest_tokens <span class="free">q</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Semi_Mojmir-pre_oldest_configuration_initial_state"><span class="command">lemma</span></span> pre_oldest_configuration_initial_state<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Suc <span class="free">n</span> <span class="main">∈</span> pre_oldest_tokens <span class="free">q</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">=</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> oldest_token_bounded<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">n</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Semi_Mojmir-pre_oldest_configuration_initial_state_2"><span class="command">lemma</span></span> pre_oldest_configuration_initial_state_2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟹</span> Suc <span class="free">n</span> <span class="main">∈</span> pre_oldest_tokens <span class="free">q</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Semi_Mojmir-pre_oldest_configuration_tokens"><span class="command">lemma</span></span> pre_oldest_configuration_tokens<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pre_oldest_tokens <span class="free">q</span> <span class="free">n</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟷</span> configuration <span class="free">q</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ot</span></span> <span class="keyword2"><span class="keyword">where</span></span> ot_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ot</span> <span class="main">∈</span> pre_oldest_tokens <span class="free">q</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">ot</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> pre_oldest_configuration_initial_state configuration_non_empty<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">n</span>"</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ot</span> <span class="main">∈</span> pre_oldest_tokens <span class="free">q</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> token_run_intial_state  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"oldest_token <span class="skolem">q'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="skolem">ot</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">q'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ot_def pre_oldest_configuration_obtain <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"configuration <span class="skolem">q'</span> <span class="free">n</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> oldest_token.simps option.distinct<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> configuration_step_non_empty<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">token</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">token</span> <span class="main">∈</span> configuration <span class="free">q</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">token</span> <span class="main">≤</span> Suc <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">token</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">token</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">token</span> <span class="free">n</span> <span class="main">=</span> <span class="skolem">q'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">q'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹token_run <span class="skolem">token</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> token_run.simps Suc_diff_le<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">token</span> <span class="main">≤</span> <span class="free">n</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ot</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"oldest_token <span class="skolem">q'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="skolem">ot</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> oldest_token_always_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">q'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> pre_oldest_configuration_element <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> pre_oldest_configuration_initial_state_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Semi_Mojmir-oldest_token_rec"><span class="command">lemma</span></span> oldest_token_rec<span class="main">:</span>
  <span class="quoted"><span class="quoted">"oldest_token <span class="free">q</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> pre_oldest_tokens <span class="free">q</span> <span class="free">n</span> <span class="main">≠</span> <span class="main">{}</span> <span class="keyword1">then</span> Some <span class="main">(</span>Min <span class="main">(</span>pre_oldest_tokens <span class="free">q</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"oldest_token <span class="free">q</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">ot</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ot</span> <span class="main">∈</span> configuration <span class="free">q</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> push_down_oldest_token_configuration<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"configuration <span class="free">q</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"pre_oldest_tokens <span class="free">q</span> <span class="free">n</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> pre_oldest_configuration_tokens <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ot</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Min <span class="main">(</span>pre_oldest_tokens <span class="free">q</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ot</span> <span class="main">&lt;</span> Suc <span class="free">n</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ot</span> <span class="main">≠</span> Suc <span class="free">n</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ot</span> <span class="main">∈</span> configuration <span class="skolem">q'</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">q'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> configuration_rev_step' <span class="quoted"><span class="quoted">‹<span class="skolem">ot</span> <span class="main">∈</span> configuration <span class="free">q</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">token</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">token</span> <span class="main">∈</span> configuration <span class="skolem">q'</span> <span class="free">n</span>"</span></span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">token</span> <span class="main">∈</span> configuration <span class="free">q</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">q'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> configuration_step<span class="main">)</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ot</span> <span class="main">≤</span> <span class="skolem">token</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> Some <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Min.coboundedI <span class="quoted"><span class="quoted">‹configuration <span class="free">q</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span> configuration_finite oldest_token.simps option.inject<span class="main">)</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Min <span class="main">(</span>configuration <span class="skolem">q'</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">ot</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Min_eqI <span class="quoted"><span class="quoted">‹<span class="skolem">ot</span> <span class="main">∈</span> configuration <span class="skolem">q'</span> <span class="free">n</span>›</span></span> configuration_finite<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"oldest_token <span class="skolem">q'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="skolem">ot</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ot</span> <span class="main">∈</span> configuration <span class="skolem">q'</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> oldest_token.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ot</span> <span class="main">∈</span> pre_oldest_tokens <span class="free">q</span> <span class="free">n</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">q'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> pre_oldest_configuration_element<span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ot</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Some <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> push_down_oldest_token_token_run token_run_intial_state<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ot</span> <span class="main">∈</span> pre_oldest_tokens <span class="free">q</span> <span class="free">n</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ot</span> <span class="main">∈</span> pre_oldest_tokens <span class="free">q</span> <span class="free">n</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Some<span class="main">[</span><span class="operator">THEN</span> oldest_token_bounded<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ot'</span> <span class="skolem">q'</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"oldest_token <span class="skolem">q'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="skolem">ot'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">q'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ot'</span> <span class="main">∈</span> configuration <span class="free">q</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> push_down_oldest_token_configuration configuration_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ot</span> <span class="main">≤</span> <span class="skolem">ot'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Some <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Min.coboundedI <span class="quoted"><span class="quoted">‹configuration <span class="free">q</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span> configuration_finite oldest_token.simps option.inject<span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> pre_oldest_tokens <span class="free">q</span> <span class="free">n</span> <span class="main">-</span> <span class="main">{</span>Suc <span class="free">n</span><span class="main">}</span> <span class="main">⟹</span> <span class="skolem">ot</span> <span class="main">≤</span> <span class="bound">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> pre_oldest_configuration_obtain <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> pre_oldest_tokens <span class="free">q</span> <span class="free">n</span> <span class="main">⟹</span> <span class="skolem">ot</span> <span class="main">≤</span> <span class="bound">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Some<span class="main">[</span><span class="operator">THEN</span> oldest_token_bounded<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ot</span> <span class="main">=</span> <span class="skolem">ot</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Min_eqI<span class="main">[</span><span class="operator">OF</span> pre_oldest_configuration_finite<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="skolem">ot</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> pre_oldest_configuration_tokens oldest_token.simps
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹configuration <span class="free">q</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">unfold</span> pre_oldest_configuration_tokens oldest_token.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> option.distinct<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Semi_Mojmir-pre_ranks_range"><span class="command">lemma</span></span> pre_ranks_range<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pre_ranks <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> state_rank <span class="bound">q</span> <span class="free">n</span><span class="main">)</span> <span class="free">ν</span> <span class="free">q</span>  <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span>max_rank<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span> <span class="main">|</span> <span class="bound">q'</span> <span class="bound">i</span><span class="main">.</span> state_rank <span class="bound">q'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="bound">i</span> <span class="main">∧</span> <span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="bound">q'</span> <span class="free">ν</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span>max_rank<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> state_rank_upper_bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Semi_Mojmir-pre_ranks_finite"><span class="command">lemma</span></span> pre_ranks_finite<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>pre_ranks <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> state_rank <span class="bound">q</span> <span class="free">n</span><span class="main">)</span> <span class="free">ν</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pre_ranks_range finite_atLeastAtMost <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> pre_ranks_Min_in <span class="main">=</span> Min_in<span class="main">[</span><span class="operator">OF</span> pre_ranks_finite<span class="main">]</span>

<span class="keyword1" id="Semi_Mojmir-pre_ranks_state_obtain"><span class="command">lemma</span></span> pre_ranks_state_obtain<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">r<span class="hidden">⇩</span><sub>q</sub></span> <span class="main">∈</span> pre_ranks <span class="free">r</span> <span class="free">ν</span> <span class="free">q</span> <span class="main">-</span> <span class="main">{</span>max_rank<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">q'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="free">q'</span> <span class="main">=</span> Some <span class="free">r<span class="hidden">⇩</span><sub>q</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="free">q'</span> <span class="free">ν</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Semi_Mojmir-pre_ranks_element"><span class="command">lemma</span></span> pre_ranks_element<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"state_rank <span class="free">q'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="free">q'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> pre_ranks <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> state_rank <span class="bound">q</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q'</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> state_rank <span class="bound">q</span> <span class="free">n</span><span class="main">)</span> <span class="bound">q'</span> <span class="main">=</span> Some <span class="bound">i</span> <span class="main">∧</span> <span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="bound">q'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">⊆</span> pre_ranks <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> state_rank <span class="bound">q</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Semi_Mojmir-pre_ranks_initial_state"><span class="command">lemma</span></span> pre_ranks_initial_state<span class="main">:</span>
  <span class="quoted"><span class="quoted">"max_rank <span class="main">∈</span> pre_ranks <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> state_rank <span class="bound">q</span> <span class="free">n</span><span class="main">)</span> <span class="free">ν</span> <span class="free">q</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">=</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> state_rank_upper_bound <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Semi_Mojmir-pre_ranks_initial_state_2"><span class="command">lemma</span></span> pre_ranks_initial_state_2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟹</span> max_rank <span class="main">∈</span> pre_ranks <span class="free">r</span> <span class="free">ν</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Semi_Mojmir-pre_ranks_tokens"><span class="command">lemma</span></span> pre_ranks_tokens<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pre_ranks <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> state_rank <span class="bound">q</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="free">q</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟷</span> configuration <span class="free">q</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≠</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q'</span><span class="main">.</span> state_rank <span class="bound">q'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="bound">i</span> <span class="main">∧</span> <span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="bound">q'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?lhs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"state_rank <span class="skolem">q'</span> <span class="free">n</span> <span class="main">≠</span> None"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">q'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"configuration <span class="skolem">q'</span> <span class="free">n</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> state_rank.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> configuration_step_non_empty<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">token</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">token</span> <span class="main">∈</span> configuration <span class="free">q</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">token</span> <span class="main">≤</span> Suc <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">token</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">token</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">token</span> <span class="free">n</span> <span class="main">=</span> <span class="skolem">q'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">q'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹token_run <span class="skolem">token</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> token_run.simps Suc_diff_le<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">token</span> <span class="main">≤</span> <span class="free">n</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="skolem">q'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span>sink <span class="free">q</span>›</span></span> sink_rev_step bounded_w <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"state_rank <span class="skolem">q'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span>sink <span class="free">q</span>›</span></span> configuration_non_empty<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">token</span> <span class="main">≤</span> <span class="free">n</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹token_run <span class="skolem">token</span> <span class="free">n</span> <span class="main">=</span> <span class="skolem">q'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">q'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> pre_ranks_element <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Semi_Mojmir-pre_ranks_pre_oldest_token_Min_state_special"><span class="command">lemma</span></span> pre_ranks_pre_oldest_token_Min_state_special<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"configuration <span class="free">q</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Min <span class="main">(</span>pre_ranks <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> state_rank <span class="bound">q</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> max_rank <span class="main">⟷</span> Min <span class="main">(</span>pre_oldest_tokens <span class="free">q</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pre_oldest_tokens <span class="free">q</span> <span class="free">n</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"pre_ranks  <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> state_rank <span class="bound">q</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="free">q</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pre_ranks_tokens pre_oldest_configuration_tokens <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> state_rank_upper_bound pre_ranks_Min_in<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹pre_ranks <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> state_rank <span class="bound">q</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="free">q</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="var">?lhs</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q'</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">q'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="skolem">q'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span>sink <span class="free">q</span>›</span></span> bounded_w <span class="keyword1"><span class="command">unfolding</span></span> sink_def
        <span class="keyword1"><span class="command">using</span></span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"state_rank <span class="skolem">q'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">q'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> Min.coboundedI<span class="main">[</span><span class="operator">OF</span> pre_ranks_finite<span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">q</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?lhs</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> state_rank_upper_bound<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">q'</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"state_rank <span class="skolem">q'</span> <span class="free">n</span> <span class="main">=</span> None"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"oldest_token <span class="skolem">q'</span> <span class="free">n</span> <span class="main">=</span> None"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span>sink <span class="skolem">q'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> state_rank_None<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">ot</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q'</span><span class="main">.</span> oldest_token <span class="bound">q'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="bound">ot</span> <span class="main">∧</span> <span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="bound">q'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q'</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">q'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"state_rank <span class="skolem">q'</span> <span class="free">n</span> <span class="main">=</span> None"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"oldest_token <span class="skolem">q'</span> <span class="free">n</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">t</span><span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> oldest_token_bounded<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">q'</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">n</span> <span class="main">≤</span> <span class="skolem">t</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">q'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span>›</span></span>
            <span class="keyword1"><span class="command">using</span></span> Min.coboundedI<span class="main">[</span><span class="operator">OF</span> pre_oldest_configuration_finite<span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?rhs</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹oldest_token <span class="skolem">q'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="skolem">t</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">unfold</span> state_rank_eq_rank<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">hence</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q'</span><span class="main">.</span>  <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> state_rank <span class="bound">q</span> <span class="free">n</span><span class="main">)</span> <span class="bound">q'</span> <span class="main">=</span> Some <span class="bound">i</span> <span class="main">∧</span> <span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="bound">q'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹pre_ranks <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> state_rank <span class="bound">q</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="free">q</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> pre_ranks.simps X <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"pre_ranks <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> state_rank <span class="bound">q</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="free">q</span> <span class="main">=</span> <span class="main">{</span>max_rank<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> pre_ranks.simps X <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Semi_Mojmir-pre_ranks_pre_oldest_token_Min_state"><span class="command">lemma</span></span> pre_ranks_pre_oldest_token_Min_state<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="free">q'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"configuration <span class="free">q</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">min_r</span> <span class="main">≡</span> Min <span class="main">(</span>pre_ranks <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> state_rank <span class="bound">q</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">min_ot</span> <span class="main">≡</span> Min <span class="main">(</span>pre_oldest_tokens <span class="free">q</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"state_rank <span class="free">q'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">min_r</span> <span class="main">⟷</span> oldest_token <span class="free">q'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">min_ot</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pre_oldest_tokens <span class="free">q</span> <span class="free">n</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="free">q'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"pre_ranks <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> state_rank <span class="bound">q</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="free">q</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pre_ranks_tokens pre_oldest_configuration_tokens bounded_w <span class="keyword1"><span class="command">unfolding</span></span> sink_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> rangeI subset_iff<span class="main">)</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">min_r</span></span> <span class="quoted">max_rank</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linorder_cases<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> less
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ot</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"oldest_token <span class="free">q'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="skolem">ot</span>"</span></span>
           <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> push_down_state_rank_oldest_token <span class="quoted"><span class="quoted">‹<span class="var">?lhs</span>›</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q''</span> <span class="skolem">ot''</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">q''</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span>"</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"oldest_token <span class="skolem">q''</span> <span class="free">n</span> <span class="main">=</span> Some <span class="skolem">ot''</span>"</span></span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="skolem">q''</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">q''</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span>›</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> sink_def
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rangeI subset_eq bounded_w<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"state_rank <span class="skolem">q''</span> <span class="free">n</span> <span class="main">=</span> Some <span class="skolem">r''</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹oldest_token <span class="skolem">q''</span> <span class="free">n</span> <span class="main">=</span> Some <span class="skolem">ot''</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> state_rank_Some<span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r''</span> <span class="main">∈</span> pre_ranks <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> state_rank <span class="bound">q</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="free">q</span>"</span></span> <span class="comment1">(* Move to special lemma *)</span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">q''</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pre_ranks.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">min_r</span> <span class="main">≤</span> <span class="skolem">r''</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> min_r_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Min.coboundedI pre_ranks_finite<span class="main">)</span>
            <span class="keyword1"><span class="command">ultimately</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ot</span> <span class="main">≤</span> <span class="skolem">ot''</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> state_rank_oldest_token_le<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="var">?lhs</span>›</span></span> _ <span class="quoted"><span class="quoted">‹oldest_token <span class="free">q'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="skolem">ot</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">ot</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q'</span><span class="main">.</span> oldest_token <span class="bound">q'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="bound">ot</span> <span class="main">∧</span> <span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="bound">q'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span><span class="main">}</span> <span class="main">⟹</span> <span class="skolem">ot</span> <span class="main">≤</span> <span class="bound">x</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ot</span> <span class="main">≤</span> Suc <span class="free">n</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> oldest_token_bounded<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹oldest_token <span class="free">q'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="skolem">ot</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">ultimately</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> pre_oldest_tokens <span class="free">q</span> <span class="free">n</span> <span class="main">⟹</span> <span class="skolem">ot</span> <span class="main">≤</span> <span class="bound">x</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> pre_oldest_tokens.simps <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">q</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ot</span> <span class="main">≤</span> <span class="free">min_ot</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> min_ot_def
            <span class="keyword1"><span class="command">unfolding</span></span> Min_ge_iff<span class="main">[</span><span class="operator">OF</span> pre_oldest_configuration_finite <span class="quoted"><span class="quoted">‹pre_oldest_tokens <span class="free">q</span> <span class="free">n</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">ot</span></span><span class="main">]</span>
             <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ot</span> <span class="main">≥</span> <span class="free">min_ot</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Min.coboundedI<span class="main">[</span><span class="operator">OF</span> pre_oldest_configuration_finite<span class="main">]</span> pre_oldest_configuration_element
          <span class="keyword1"><span class="command">unfolding</span></span> min_ot_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> not_less<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> state_rank_upper_bound less_imp_le_nat<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">min_ot</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">n</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linorder_cases<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> less
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"state_rank <span class="free">q'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="skolem">r</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?rhs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span>sink <span class="free">q'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> state_rank_Some<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r''</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r''</span> <span class="main">∈</span> pre_ranks <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> state_rank <span class="bound">q</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="free">q</span> <span class="main">-</span> <span class="main">{</span>max_rank<span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"state_rank <span class="skolem">q''</span> <span class="free">n</span> <span class="main">=</span> Some <span class="skolem">r''</span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">q''</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> pre_ranks_state_obtain <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ot''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"oldest_token <span class="skolem">q''</span> <span class="free">n</span> <span class="main">=</span> Some <span class="skolem">ot''</span>"</span></span>
               <span class="keyword1"><span class="command">using</span></span> push_down_state_rank_oldest_token <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="free">min_ot</span> <span class="main">≤</span> <span class="skolem">ot''</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">q''</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span>›</span></span> pre_oldest_configuration_element Min.coboundedI pre_oldest_configuration_finite
              <span class="keyword1"><span class="command">unfolding</span></span> min_ot_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword1"><span class="command">ultimately</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≤</span> <span class="skolem">r''</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> state_rank_oldest_token_le<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹state_rank <span class="free">q'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="skolem">r</span>›</span></span> _ <span class="quoted"><span class="quoted">‹<span class="var">?rhs</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≤</span> max_rank"</span></span>
            <span class="keyword1"><span class="command">using</span></span> state_rank_upper_bound<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹state_rank <span class="free">q'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="skolem">r</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
          <span class="keyword1"><span class="command">ultimately</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span>  pre_ranks <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> state_rank <span class="bound">q</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="free">q</span> <span class="main">⟹</span> <span class="skolem">r</span> <span class="main">≤</span> <span class="bound">x</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> pre_ranks.simps <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">q</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≤</span> <span class="free">min_r</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> min_r_def Min_ge_iff<span class="main">[</span><span class="operator">OF</span> pre_ranks_finite <span class="quoted"><span class="quoted">‹pre_ranks <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> state_rank <span class="bound">q</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="free">q</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">≥</span> <span class="free">min_r</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Min.coboundedI<span class="main">[</span><span class="operator">OF</span> pre_ranks_finite<span class="main">]</span> pre_ranks_element
          <span class="keyword1"><span class="command">unfolding</span></span> min_r_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> not_less<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> oldest_token_bounded Suc_lessD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Semi_Mojmir-Min_pre_ranks_pre_oldest_tokens"><span class="command">lemma</span></span> Min_pre_ranks_pre_oldest_tokens<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> state_rank <span class="bound">q</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"configuration <span class="free">p</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"configuration <span class="free">q</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="free">q</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Min <span class="main">(</span>pre_ranks <span class="free">r</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span> <span class="main">&lt;</span> Min <span class="main">(</span>pre_ranks <span class="free">r</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span> <span class="main">⟷</span> Min <span class="main">(</span>pre_oldest_tokens <span class="free">p</span> <span class="free">n</span><span class="main">)</span> <span class="main">&lt;</span> Min <span class="main">(</span>pre_oldest_tokens <span class="free">q</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">have</span></span> pre_ranks_Min<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">ν</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">&lt;</span> Min <span class="main">(</span>pre_ranks <span class="free">r</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span> <span class="main">∈</span> pre_ranks <span class="free">r</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="free">q</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms pre_ranks_finite Min.bounded_iff pre_ranks_tokens <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> pre_oldest_configuration_Min<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">&lt;</span> Min <span class="main">(</span>pre_oldest_tokens <span class="free">q</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>pre_oldest_tokens <span class="free">q</span> <span class="free">n</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms pre_oldest_configuration_finite Min.bounded_iff pre_oldest_configuration_tokens <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">w</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">Σ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bounded_w <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?min_i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Min <span class="main">(</span>pre_ranks <span class="free">r</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?min_j</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Min <span class="main">(</span>pre_ranks <span class="free">r</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span>"</span></span>

    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?min_i</span> <span class="main">∈</span> pre_ranks <span class="free">r</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?min_j</span> <span class="main">∈</span> pre_ranks <span class="free">r</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="free">q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Min_in<span class="main">[</span><span class="operator">OF</span> pre_ranks_finite<span class="main">]</span> assms pre_ranks_tokens <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?min_i</span> <span class="main">≤</span> max_rank"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?min_j</span> <span class="main">≤</span> max_rank"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pre_ranks_range atLeastAtMost_iff <span class="keyword1"><span class="command">unfolding</span></span> r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?lhs</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?min_i</span> <span class="main">≠</span> max_rank"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">=</span> <span class="var">?min_i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="skolem">p'</span> <span class="main">=</span> Some <span class="skolem">i'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">p'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?min_i</span> <span class="main">∈</span> pre_ranks <span class="free">r</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ot'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"oldest_token <span class="skolem">p'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="skolem">ot'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> push_down_state_rank_oldest_token<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"state_rank <span class="skolem">p'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="var">?min_i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">=</span> <span class="var">?min_i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="skolem">p'</span> <span class="main">=</span> Some <span class="skolem">i'</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ot'</span> <span class="main">=</span> Min <span class="main">(</span>pre_oldest_tokens <span class="free">p</span> <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pre_ranks_pre_oldest_token_Min_state<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span>sink <span class="free">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">p'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹configuration <span class="free">p</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹oldest_token <span class="skolem">p'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="skolem">ot'</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> r_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.inject<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ot'</span> <span class="main">&lt;</span> Suc <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ot'</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">n</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linorder_cases<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> equal
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?min_i</span> <span class="main">=</span> max_rank"</span></span>
          <span class="keyword1"><span class="command">using</span></span> pre_ranks_pre_oldest_token_Min_state_special<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span>sink <span class="free">p</span>›</span></span> <span class="quoted"><span class="quoted">‹configuration <span class="free">p</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span><span class="main">]</span> assms
          <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ot'</span> <span class="main">=</span> Min <span class="main">(</span>pre_oldest_tokens <span class="free">p</span> <span class="free">n</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?min_i</span> <span class="main">≠</span> max_rank›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> greater
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ot'</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span>Suc <span class="free">n</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹oldest_token <span class="skolem">p'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="skolem">ot'</span>›</span></span><span class="main">[</span><span class="operator">THEN</span> oldest_token_bounded<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ot<span class="hidden">⇩</span><sub>q</sub></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ot<span class="hidden">⇩</span><sub>q</sub></span> <span class="main">∈</span> pre_oldest_tokens <span class="free">q</span> <span class="free">n</span> <span class="main">-</span> <span class="main">{</span>Suc <span class="free">n</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"oldest_token <span class="skolem">q'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="skolem">ot<span class="hidden">⇩</span><sub>q</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">q'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> pre_oldest_configuration_obtain <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="skolem">q'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span>sink <span class="free">q</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">w</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">Σ</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sink_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r<span class="hidden">⇩</span><sub>q</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"state_rank <span class="skolem">q'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="skolem">r<span class="hidden">⇩</span><sub>q</sub></span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> assms state_rank.simps <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹oldest_token <span class="skolem">q'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="skolem">ot<span class="hidden">⇩</span><sub>q</sub></span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> oldest_token.simps option.distinct<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>q</sub></span> <span class="main">∈</span> pre_ranks <span class="free">r</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="free">q</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">q'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> pre_ranks.simps assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?min_j</span> <span class="main">≤</span> <span class="skolem">r<span class="hidden">⇩</span><sub>q</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Min.coboundedI<span class="main">[</span><span class="operator">OF</span> pre_ranks_finite<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?min_i</span> <span class="main">&lt;</span> <span class="skolem">r<span class="hidden">⇩</span><sub>q</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?lhs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ot'</span> <span class="main">&lt;</span> <span class="skolem">ot<span class="hidden">⇩</span><sub>q</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> state_rank_oldest_token<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹state_rank <span class="skolem">p'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="var">?min_i</span>›</span></span> <span class="quoted"><span class="quoted">‹state_rank <span class="skolem">q'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="skolem">r<span class="hidden">⇩</span><sub>q</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹oldest_token <span class="skolem">p'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="skolem">ot'</span>›</span></span> <span class="quoted"><span class="quoted">‹oldest_token <span class="skolem">q'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="skolem">ot<span class="hidden">⇩</span><sub>q</sub></span>›</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> pre_oldest_configuration_Min <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ot_p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ot_p</span> <span class="main">=</span> Min <span class="main">(</span>pre_oldest_tokens <span class="free">p</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ot_q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ot_q</span> <span class="main">=</span> Min <span class="main">(</span>pre_oldest_tokens <span class="free">q</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ot_p</span> <span class="main">&lt;</span> <span class="skolem">ot_q</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ot_p_def ot_q_def <span class="keyword1"><span class="command">.</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"oldest_token <span class="free">p</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">ot_p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"oldest_token <span class="free">q</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">ot_q</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ot_p_def ot_q_def oldest_token_rec pre_oldest_configuration_tokens <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

   <span class="comment1">(* Min oldest ⟷ Min rank *)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">min_r<span class="hidden">⇩</span><sub>p</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">min_r<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">=</span> Min <span class="main">(</span>pre_ranks <span class="free">r</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">min_r<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">∈</span> pre_ranks <span class="free">r</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pre_ranks_Min_in assms pre_ranks_tokens <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">min_r<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">&lt;</span> max_rank"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">min_r<span class="hidden">⇩</span><sub>p</sub></span></span> <span class="quoted">max_rank</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linorder_cases<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> equal
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ot_p</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> pre_ranks_pre_oldest_token_Min_state_special<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">,</span> <span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹configuration <span class="free">p</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span><span class="main">]</span> assms
          <span class="keyword1"><span class="command">unfolding</span></span> ot_p_def min_r<span class="hidden">⇩</span><sub>p</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Min <span class="main">(</span>pre_oldest_tokens <span class="free">q</span> <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> pre_oldest_tokens <span class="free">q</span> <span class="free">n</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Min_in<span class="main">[</span><span class="operator">OF</span> pre_oldest_configuration_finite <span class="main">]</span> assms pre_oldest_configuration_tokens <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ot_q</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span>Suc <span class="free">n</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> pre_oldest_configuration_range<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">unfolding</span></span> ot_q_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ot_q</span> <span class="main">≤</span> Suc <span class="free">n</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ot_p</span> <span class="main">&lt;</span> <span class="skolem">ot_q</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> greater
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">min_r<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span>max_rank<span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> pre_ranks_range <span class="quoted"><span class="quoted">‹<span class="skolem">min_r<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">∈</span> pre_ranks <span class="free">r</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="free">p</span>›</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> r_def <span class="keyword1"><span class="command">..</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">min_r<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">∈</span> pre_ranks <span class="free">r</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="free">p</span> <span class="main">-</span> <span class="main">{</span>max_rank<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">min_r<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">∈</span> pre_ranks <span class="free">r</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="free">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="skolem">p'</span> <span class="main">=</span> Some <span class="skolem">min_r<span class="hidden">⇩</span><sub>p</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">p'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pre_ranks_state_obtain <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"oldest_token <span class="skolem">p'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="skolem">ot_p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pre_ranks_pre_oldest_token_Min_state<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span>sink <span class="free">p</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">p'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹configuration <span class="free">p</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> r_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> min_r<span class="hidden">⇩</span><sub>p</sub>_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> ot_p_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> r_def<span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r<span class="hidden">⇩</span><sub>q</sub></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>q</sub></span> <span class="main">∈</span> pre_ranks <span class="free">r</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="free">q</span> <span class="main">-</span> <span class="main">{</span>max_rank<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> q'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="skolem">q'</span> <span class="main">=</span> Some <span class="skolem">r<span class="hidden">⇩</span><sub>q</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">q'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> pre_ranks_state_obtain <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> q' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ot_q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ot_q'<span class="main">:</span> <span class="quoted"><span class="quoted">"oldest_token <span class="skolem">q'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="skolem">ot_q'</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> push_down_state_rank_oldest_token<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> ot_q' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ot_q'</span> <span class="main">∈</span> pre_oldest_tokens <span class="free">q</span> <span class="free">n</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">q'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> pre_oldest_tokens.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ot_q</span> <span class="main">≤</span> <span class="skolem">ot_q'</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> ot_q_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Min.coboundedI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> pre_oldest_configuration_finite<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ot_p</span> <span class="main">&lt;</span> <span class="skolem">ot_q'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ot_p</span> <span class="main">&lt;</span> <span class="skolem">ot_q</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">min_r<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">&lt;</span> <span class="skolem">r<span class="hidden">⇩</span><sub>q</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> state_rank_oldest_token <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="skolem">p'</span> <span class="main">=</span> Some <span class="skolem">min_r<span class="hidden">⇩</span><sub>p</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹oldest_token <span class="skolem">p'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="skolem">ot_p</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> pre_ranks_Min <span class="keyword1"><span class="command">unfolding</span></span> min_r<span class="hidden">⇩</span><sub>p</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Definition of initial and step›</span></span>

<span class="keyword1" id="Semi_Mojmir-state_rank_initial"><span class="command">lemma</span></span> state_rank_initial<span class="main">:</span>
  <span class="quoted"><span class="quoted">"state_rank <span class="free">q</span> <span class="main">0</span> <span class="main">=</span> initial <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> state_rank_initial_state <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Semi_Mojmir-state_rank_step"><span class="command">lemma</span></span> state_rank_step<span class="main">:</span>
  <span class="quoted"><span class="quoted">"state_rank <span class="free">q</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> step <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> state_rank <span class="bound">q</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="free">q</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"sink <span class="free">q</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"configuration <span class="free">q</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> False pull_up_configuration_state_rank pre_ranks_tokens
        <span class="keyword1"><span class="command">unfolding</span></span> step.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"configuration <span class="free">q</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> Some <span class="main">(</span>card <span class="main">(</span>senior_states <span class="free">q</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">unfolding</span></span> state_rank.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
      <span class="keyword1"><span class="command">also</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">q</span><span class="main">.</span> state_rank <span class="bound">q</span> <span class="free">n</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">q'</span><span class="main">.</span> <span class="main">¬</span>sink <span class="bound">q'</span> <span class="main">∧</span> pre_ranks <span class="var">?r</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="bound">q'</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∧</span> Min <span class="main">(</span>pre_ranks <span class="var">?r</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="bound">q'</span><span class="main">)</span> <span class="main">&lt;</span> Min <span class="main">(</span>pre_ranks <span class="var">?r</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> senior_states <span class="free">q</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
          <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">=</span> <span class="var">?S'</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q'</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">∈</span> <span class="var">?S</span> <span class="main">⟷</span> <span class="main">¬</span>sink <span class="skolem">q'</span> <span class="main">∧</span> configuration <span class="skolem">q'</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∧</span> Min <span class="main">(</span>pre_ranks  <span class="var">?r</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="skolem">q'</span><span class="main">)</span> <span class="main">&lt;</span> Min <span class="main">(</span>pre_ranks <span class="var">?r</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="free">q</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> pre_ranks_tokens <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">also</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="main">¬</span>sink <span class="skolem">q'</span> <span class="main">∧</span> configuration <span class="skolem">q'</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∧</span> Min <span class="main">(</span>pre_oldest_tokens <span class="skolem">q'</span> <span class="free">n</span><span class="main">)</span> <span class="main">&lt;</span> Min <span class="main">(</span>pre_oldest_tokens <span class="free">q</span> <span class="free">n</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹configuration <span class="free">q</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span>sink <span class="free">q</span>›</span></span> Min_pre_ranks_pre_oldest_tokens<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="main">¬</span>sink <span class="skolem">q'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> oldest_token <span class="skolem">q'</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">y</span> <span class="main">∧</span> oldest_token <span class="free">q</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">x</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> oldest_token_rec <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> pre_oldest_configuration_tokens <span class="quoted"><span class="quoted">‹configuration <span class="free">q</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span> option.distinct<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> option.sel<span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">∈</span> <span class="var">?S</span> <span class="main">⟷</span> <span class="skolem">q'</span> <span class="main">∈</span> <span class="var">?S'</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> senior_states.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span>sink <span class="free">q</span>›</span></span> <span class="quoted"><span class="quoted">‹configuration <span class="free">q</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> step.simps pre_ranks_tokens<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span>sink <span class="free">q</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">finally</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Semi_Mojmir-state_rank_step_foldl"><span class="command">lemma</span></span> state_rank_step_foldl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> state_rank <span class="bound">q</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> foldl step initial <span class="main">(</span>map <span class="free">w</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">unfold</span> state_rank_initial state_rank_step<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Mojmir">
<div class="head">
<h1>Theory Mojmir</h1>
</div>
<pre class="source"><span class="comment1">(*
    Author:      Salomon Sickert
    License:     BSD
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Mojmir Automata›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Mojmir
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <a href="Semi_Mojmir.html">Semi_Mojmir</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definitions›</span></span>

<span class="keyword1"><span class="command">locale</span></span> mojmir_def <span class="main">=</span> semi_mojmir_def <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="comment1">― ‹Final States›</span>
    <span class="free">F</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> set"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">token_succeeds</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">token_succeeds</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> token_run <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">n</span> <span class="main">∈</span> <span class="free">F</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">token_fails</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">token_fails</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> sink <span class="main">(</span>token_run <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> token_run <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">n</span> <span class="main">∉</span> <span class="free">F</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">accept</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">accept<span class="hidden">⇩</span><sub>M</sub></span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">accept</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">x</span><span class="main">.</span> token_succeeds <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fail</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fail</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> token_fails <span class="bound">x</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">merge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">|</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">n</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span>
    <span class="main">∧</span> <span class="main">(</span>token_run <span class="bound">x</span> <span class="bound">n</span> <span class="main">≠</span> token_run <span class="bound">y</span> <span class="bound">n</span> <span class="main">∧</span> rank <span class="bound">y</span> <span class="bound">n</span> <span class="main">≠</span> None <span class="main">∨</span> <span class="bound">y</span> <span class="main">=</span> Suc <span class="bound">n</span><span class="main">)</span>
    <span class="main">∧</span> token_run <span class="bound">x</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> token_run <span class="bound">y</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span>
    <span class="main">∧</span> token_run <span class="bound">x</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="main">∉</span> <span class="free">F</span>
    <span class="main">∧</span> rank <span class="bound">x</span> <span class="bound">n</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">succeed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">succeed</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> rank <span class="bound">x</span> <span class="bound">n</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">i</span></span></span>
    <span class="main">∧</span> token_run <span class="bound">x</span> <span class="bound">n</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">-</span> <span class="main">{</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span>
    <span class="main">∧</span> token_run <span class="bound">x</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">smallest_accepting_rank</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">smallest_accepting_rank</span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">if</span> accept <span class="keyword1">then</span>
    Some <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i</span><span class="main">.</span> finite fail <span class="main">∧</span> finite <span class="main">(</span>merge <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> infinite <span class="main">(</span>succeed <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fail_t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fail_t</span> <span class="main">=</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span> <span class="bound">q'</span><span class="main">.</span> state_rank <span class="bound">q</span> <span class="bound">n</span> <span class="main">≠</span> None <span class="main">∧</span> <span class="bound">q'</span> <span class="main">=</span> <span class="free">δ</span> <span class="bound">q</span> <span class="main">(</span><span class="free">w</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">q'</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">∧</span> sink <span class="bound">q'</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">merge_t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_t</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span> <span class="bound">q'</span> <span class="bound">j</span><span class="main">.</span> state_rank <span class="bound">q</span> <span class="bound">n</span> <span class="main">=</span> Some <span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="bound">q'</span> <span class="main">=</span> <span class="free">δ</span> <span class="bound">q</span> <span class="main">(</span><span class="free">w</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">q'</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">q''</span><span class="main">.</span> <span class="bound">q''</span> <span class="main">≠</span> <span class="bound">q</span> <span class="main">∧</span> <span class="bound">q'</span> <span class="main">=</span> <span class="free">δ</span> <span class="bound">q''</span> <span class="main">(</span><span class="free">w</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> state_rank <span class="bound">q''</span> <span class="bound">n</span> <span class="main">≠</span> None<span class="main">)</span> <span class="main">∨</span> <span class="bound">q'</span> <span class="main">=</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">succeed_t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">succeed_t</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">.</span> state_rank <span class="bound">q</span> <span class="bound">n</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">-</span> <span class="main">{</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span> <span class="main">∧</span> <span class="free">δ</span> <span class="bound">q</span> <span class="main">(</span><span class="free">w</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="quoted">"<span class="entity">𝒮</span>"</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">𝒮</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="free">F</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> the smallest_accepting_rank<span class="main">.</span> state_rank <span class="bound">q</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> mojmir <span class="main">=</span> semi_mojmir <span class="main">+</span> mojmir_def <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="comment1">― ‹All states reachable from final states are also final›</span>
    wellformed_F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">ν</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> <span class="free">F</span> <span class="main">⟹</span> <span class="free">δ</span> <span class="bound">q</span> <span class="bound">ν</span> <span class="main">∈</span> <span class="free">F</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Mojmir-token_stays_in_final_states"><span class="command">lemma</span></span> token_stays_in_final_states<span class="main">:</span>
  <span class="quoted"><span class="quoted">"token_run <span class="free">x</span> <span class="free">n</span> <span class="main">∈</span> <span class="free">F</span> <span class="main">⟹</span> token_run <span class="free">x</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">+</span> <span class="skolem">m</span> <span class="main">&lt;</span> <span class="free">x</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">+</span> <span class="skolem">m</span> <span class="main">≥</span> <span class="free">x</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">+</span> <span class="skolem">m</span> <span class="main">=</span> <span class="free">x</span> <span class="main">+</span> <span class="skolem">j</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> le_Suc_ex <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">(</span>token_run <span class="free">x</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>suffix <span class="free">x</span> <span class="free">w</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> token_run <span class="free">x</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> suffix_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> wellformed_F Suc suffix_nth <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Mojmir-token_run_enter_final_states"><span class="command">lemma</span></span> token_run_enter_final_states<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"token_run <span class="free">x</span> <span class="free">n</span> <span class="main">∈</span> <span class="free">F</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">m</span></span> <span class="main">≥</span> <span class="free">x</span><span class="main">.</span> token_run <span class="free">x</span> <span class="bound">m</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">-</span> <span class="main">{</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span> <span class="main">∧</span> token_run <span class="free">x</span> <span class="main">(</span>Suc <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">n</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"token_run <span class="free">x</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="skolem">n'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">m</span><span class="main">.</span> token_run <span class="free">x</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">-</span> <span class="main">{</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span> <span class="main">∧</span> token_run <span class="free">x</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> Suc <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">n'</span></span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>erased<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> token_stays_in_final_states token_run_intial_state  Diff_iff Nat.add_0_right Suc_eq_plus1 insertCI <span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_Suc_right le_add1<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"token_run <span class="free">x</span> <span class="free">x</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">-</span> <span class="main">{</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"token_run <span class="free">x</span> <span class="main">(</span>Suc <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms wellformed_F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Token Properties›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Alternative Definitions›</span></span>

<span class="keyword1" id="Mojmir-token_succeeds_alt_def"><span class="command">lemma</span></span> token_succeeds_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"token_succeeds <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">n</span><span class="main">.</span> token_run <span class="free">x</span> <span class="bound">n</span> <span class="main">∈</span> <span class="free">F</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> token_succeeds_def MOST_nat_le le_iff_add
  <span class="keyword1"><span class="command">using</span></span> token_stays_in_final_states <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Mojmir-token_fails_alt_def"><span class="command">lemma</span></span> token_fails_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"token_fails <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">n</span><span class="main">.</span> sink <span class="main">(</span>token_run <span class="free">x</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> token_run <span class="free">x</span> <span class="bound">n</span> <span class="main">∉</span> <span class="free">F</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"sink <span class="main">(</span>token_run <span class="free">x</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"token_run <span class="free">x</span> <span class="skolem">n</span> <span class="main">∉</span> <span class="free">F</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> token_fails_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">m</span></span> <span class="main">≥</span> <span class="skolem">n</span><span class="main">.</span> sink <span class="main">(</span>token_run <span class="free">x</span> <span class="bound">m</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">m</span></span> <span class="main">≥</span> <span class="skolem">n</span><span class="main">.</span> token_run <span class="free">x</span> <span class="bound">m</span> <span class="main">∉</span> <span class="free">F</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> token_stays_in_sink <span class="keyword1"><span class="command">unfolding</span></span> le_iff_add <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> MOST_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">unfold</span> MOST_nat_le token_fails_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="Mojmir-token_fails_alt_def_2"><span class="command">lemma</span></span> token_fails_alt_def_2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"token_fails <span class="free">x</span> <span class="main">⟷</span> <span class="main">¬</span>token_succeeds <span class="free">x</span> <span class="main">∧</span> <span class="main">¬</span>token_squats <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute token_fails_def token_squats_def token_stays_in_final_states token_stays_in_sink token_succeeds_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Properties›</span></span>

<span class="keyword1" id="Mojmir-token_succeeds_run_merge"><span class="command">lemma</span></span> token_succeeds_run_merge<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> token_run <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> token_run <span class="free">y</span> <span class="free">n</span> <span class="main">⟹</span> token_succeeds <span class="free">x</span> <span class="main">⟹</span> token_succeeds <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> token_run_merge token_stays_in_final_states add.commute <span class="keyword1"><span class="command">unfolding</span></span> token_succeeds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="Mojmir-token_squats_run_merge"><span class="command">lemma</span></span> token_squats_run_merge<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> token_run <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> token_run <span class="free">y</span> <span class="free">n</span> <span class="main">⟹</span> token_squats <span class="free">x</span> <span class="main">⟹</span> token_squats <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> token_run_merge token_stays_in_sink add.commute <span class="keyword1"><span class="command">unfolding</span></span> token_squats_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Pulled-Up Lemmas›</span></span>

<span class="keyword1" id="Mojmir-configuration_token_succeeds"><span class="command">lemma</span></span> configuration_token_succeeds<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">x</span> <span class="main">∈</span> configuration <span class="free">q</span> <span class="free">n</span><span class="main">;</span> <span class="free">y</span> <span class="main">∈</span> configuration <span class="free">q</span> <span class="free">n</span><span class="main">⟧</span> <span class="main">⟹</span> token_succeeds <span class="free">x</span> <span class="main">=</span> token_succeeds <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> token_succeeds_run_merge push_down_configuration_token_run <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>

<span class="keyword1" id="Mojmir-configuration_token_squats"><span class="command">lemma</span></span> configuration_token_squats<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">x</span> <span class="main">∈</span> configuration <span class="free">q</span> <span class="free">n</span><span class="main">;</span> <span class="free">y</span> <span class="main">∈</span> configuration <span class="free">q</span> <span class="free">n</span><span class="main">⟧</span> <span class="main">⟹</span> token_squats <span class="free">x</span> <span class="main">=</span> token_squats <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> token_squats_run_merge push_down_configuration_token_run <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Mojmir Acceptance›</span></span>

<span class="keyword1" id="Mojmir-Mojmir_reject"><span class="command">lemma</span></span> Mojmir_reject<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> accept <span class="main">⟷</span> <span class="main">(</span><span class="main">∃<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span>token_succeeds <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> accept_def Alm_all_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Mojmir-mojmir_accept_alt_def"><span class="command">lemma</span></span> mojmir_accept_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"accept <span class="main">⟷</span> finite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span>token_succeeds <span class="bound">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Inf_many_def Mojmir_reject <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Mojmir-mojmir_accept_initial"><span class="command">lemma</span></span> mojmir_accept_initial<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="free">F</span> <span class="main">⟹</span> accept"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> accept_def MOST_nat_le token_succeeds_def
  <span class="keyword1"><span class="command">using</span></span> token_run_intial_state <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Equivalent Acceptance Conditions›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Token-Based Definitions›</span></span>

<span class="keyword1" id="Mojmir-merge_token_succeeds"><span class="command">lemma</span></span> merge_token_succeeds<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> merge <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"token_succeeds <span class="free">x</span> <span class="main">⟷</span> token_succeeds <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"token_run <span class="free">x</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> token_run <span class="free">y</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">x</span> <span class="skolem">n</span> <span class="main">=</span> Some <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">y</span> <span class="skolem">n</span> <span class="main">=</span> Some <span class="skolem">j'</span> <span class="main">∨</span> <span class="free">y</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> merge_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> Suc <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≤</span> Suc <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rank_Some_time le_Suc_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> configuration <span class="skolem">q</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> configuration <span class="skolem">q</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹token_run <span class="free">x</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> token_run <span class="free">y</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>›</span></span> pull_up_token_run_tokens <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> configuration_token_succeeds <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Mojmir-merge_subset"><span class="command">lemma</span></span> merge_subset<span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> merge <span class="free">i</span> <span class="main">⊆</span> merge <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> merge <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">x</span> <span class="skolem">n</span> <span class="main">≠</span> token_run <span class="skolem">y</span> <span class="skolem">n</span> <span class="main">∧</span> rank <span class="skolem">y</span> <span class="skolem">n</span> <span class="main">≠</span> None <span class="main">∨</span> <span class="skolem">y</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">x</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> token_run <span class="skolem">y</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">x</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">∉</span> <span class="free">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rank <span class="skolem">x</span> <span class="skolem">n</span> <span class="main">=</span> Some <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> merge_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> merge <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> merge_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> merge <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Mojmir-merge_finite"><span class="command">lemma</span></span> merge_finite<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> finite <span class="main">(</span>merge <span class="free">j</span><span class="main">)</span> <span class="main">⟹</span> finite <span class="main">(</span>merge <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> merge_subset <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rev_finite_subset<span class="main">)</span>

<span class="keyword1" id="Mojmir-merge_finite'"><span class="command">lemma</span></span> merge_finite'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span> finite <span class="main">(</span>merge <span class="free">j</span><span class="main">)</span> <span class="main">⟹</span> finite <span class="main">(</span>merge <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> merge_finite<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Mojmir-succeed_membership"><span class="command">lemma</span></span> succeed_membership<span class="main">:</span>
  <span class="quoted"><span class="quoted">"token_succeeds <span class="free">x</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> succeed <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"token_run <span class="free">x</span> <span class="skolem">m</span> <span class="main">∈</span> <span class="free">F</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> token_succeeds_alt_def MOST_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"token_run <span class="free">x</span> <span class="skolem">n</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">-</span> <span class="main">{</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"token_run <span class="free">x</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> token_run_enter_final_states <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="main">(</span>token_run <span class="free">x</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"token_run <span class="free">x</span> <span class="skolem">n</span> <span class="main">≠</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"token_run <span class="free">x</span> <span class="skolem">n</span> <span class="main">∉</span> <span class="free">F</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹token_run <span class="free">x</span> <span class="skolem">n</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">-</span> <span class="main">{</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹token_run <span class="free">x</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span>›</span></span> token_stays_in_sink <span class="keyword1"><span class="command">unfolding</span></span> Suc_eq_plus1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sink_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">x</span> <span class="skolem">n</span> <span class="main">=</span> Some <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≤</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> succeed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">unfold</span> token_succeeds_def succeed_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="Mojmir-stable_rank_succeed"><span class="command">lemma</span></span> stable_rank_succeed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>succeed <span class="free">i</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> succeed <span class="free">i</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∉</span> <span class="free">F</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>stable_rank <span class="free">x</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"stable_rank <span class="free">x</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n'</span></span> <span class="main">≥</span> <span class="skolem">n</span><span class="main">.</span> rank <span class="free">x</span> <span class="bound">n'</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> stable_rank_def MOST_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"token_run <span class="free">x</span> <span class="skolem">m</span> <span class="main">∉</span> <span class="free">F</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"token_run <span class="free">x</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">x</span> <span class="skolem">m</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> succeed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&gt;</span> max <span class="skolem">n</span> <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> succeed <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> infinite_nat_iff_unbounded <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">y</span> <span class="skolem">m'</span> <span class="main">∉</span> <span class="free">F</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">y</span> <span class="main">(</span>Suc <span class="skolem">m'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rank <span class="skolem">y</span> <span class="skolem">m'</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> succeed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1"><span class="command">moreover</span></span>

  <span class="comment1">― ‹token has still rank i at m'›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m'</span> <span class="main">≥</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rank_Some_time<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹rank <span class="skolem">y</span> <span class="skolem">m'</span> <span class="main">=</span> Some <span class="free">i</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">&gt;</span> max <span class="skolem">n</span> <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">x</span> <span class="skolem">m'</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound"><span class="bound">n'</span></span> <span class="main">≥</span> <span class="skolem">n</span><span class="main">.</span> rank <span class="free">x</span> <span class="bound">n'</span> <span class="main">=</span> Some <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">moreover</span></span>

  <span class="comment1">― ‹but x and y are not in the same state›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m'</span> <span class="main">≥</span> Suc <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rank_Some_time<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹rank <span class="skolem">y</span> <span class="skolem">m'</span> <span class="main">=</span> Some <span class="free">i</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">&gt;</span> max <span class="skolem">n</span> <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"token_run <span class="free">x</span> <span class="skolem">m'</span> <span class="main">∈</span> <span class="free">F</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> token_stays_in_final_states<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹token_run <span class="free">x</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> le_iff_add <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹token_run <span class="skolem">y</span> <span class="skolem">m'</span> <span class="main">∉</span> <span class="free">F</span> ›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">y</span> <span class="skolem">m'</span> <span class="main">≠</span> token_run <span class="free">x</span> <span class="skolem">m'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1"><span class="command">ultimately</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
    <span class="keyword1"><span class="command">using</span></span> push_down_rank_tokens <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Mojmir-stable_rank_bounded"><span class="command">lemma</span></span> stable_rank_bounded<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> stable<span class="main">:</span> <span class="quoted"><span class="quoted">"stable_rank <span class="free">x</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inf<span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>succeed <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∉</span> <span class="free">F</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> stable <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">m'</span></span> <span class="main">≥</span> <span class="skolem">m</span><span class="main">.</span> rank <span class="free">x</span> <span class="bound">m'</span> <span class="main">=</span> Some <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> stable_rank_def MOST_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command">from</span></span> inf <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≥</span> <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> succeed <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> infinite_nat_iff_unbounded_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"rank <span class="skolem">y</span> <span class="skolem">n</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> succeed_def MOST_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">moreover</span></span>

  <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rank_Some_time<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">x</span> <span class="skolem">n</span> <span class="main">=</span> Some <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound"><span class="bound">m'</span></span> <span class="main">≥</span> <span class="skolem">m</span><span class="main">.</span> rank <span class="free">x</span> <span class="bound">m'</span> <span class="main">=</span> Some <span class="free">j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">≥</span> <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1"><span class="command">ultimately</span></span>

  <span class="comment1">― ‹In the case <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span><span class="antiquote">}</span></span>, the token y has also to stabilise with <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">i</span></span><span class="antiquote">}</span></span> at <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">n</span></span><span class="antiquote">}</span></span>.›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> stable_rank <span class="skolem">y</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> stable <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> stable_rank_tower<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> stable_rank_succeed<span class="main">[</span><span class="operator">OF</span> inf <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∈</span> succeed <span class="free">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∉</span> <span class="free">F</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹Relation to Mojmir Acceptance›</span>

<span class="keyword1" id="Mojmir-mojmir_accept_token_set_def1"><span class="command">lemma</span></span> mojmir_accept_token_set_def1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"accept"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> max_rank<span class="main">.</span> finite fail <span class="main">∧</span> finite <span class="main">(</span>merge <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> infinite <span class="main">(</span>succeed <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="bound">i</span><span class="main">.</span> finite <span class="main">(</span>succeed <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">k</span><span class="main">.</span> infinite <span class="main">(</span>succeed <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound">t</span><span class="main">.</span> token_succeeds <span class="bound">t</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mojmir_accept_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1"><span class="command">moreover</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> token_succeeds <span class="bound">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">{</span>succeed <span class="bound">i</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> max_rank<span class="main">}</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">{</span>succeed <span class="bound">i</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> True<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> succeed_membership <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> <span class="var">?rhs</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">{</span>succeed <span class="bound">i</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> True<span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> succeed <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="comment1">― ‹Obtain upper bound for succeed ranks›</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">u</span><span class="main">.</span> <span class="bound">u</span> <span class="main">≥</span> max_rank <span class="main">⟹</span> succeed <span class="bound">u</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> succeed_def <span class="keyword1"><span class="command">using</span></span> rank_upper_bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">{</span>succeed <span class="bound">i</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> max_rank<span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> max_rank"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">ultimately</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> infinite <span class="main">(</span>succeed <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>succeed <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="skolem">i</span> <span class="main">⟹</span> finite <span class="main">(</span>succeed <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> i_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeastI_ex<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> not_less_Least<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> fin_succeed_ranks<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">⋃</span><span class="main">{</span>succeed <span class="bound">j</span> <span class="main">|</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="skolem">i</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">i</span></span><span class="antiquote">}</span></span> is bounded by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">max_rank</span><span class="antiquote">}</span></span>›</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> succeed <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹infinite <span class="main">(</span>succeed <span class="skolem">i</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"rank <span class="skolem">x</span> <span class="skolem">n</span> <span class="main">=</span> Some <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> succeed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> max_rank"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rank_upper_bound<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> token_succeeds <span class="bound">x</span> <span class="main">∧</span> token_succeeds <span class="bound">y</span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>merge <span class="skolem">i</span> <span class="main">∩</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> finite_product<span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>merge <span class="skolem">i</span> <span class="main">∩</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>

      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">k''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rank <span class="skolem">x</span> <span class="skolem">n</span> <span class="main">=</span> Some <span class="skolem">k</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rank <span class="skolem">y</span> <span class="skolem">n</span> <span class="main">=</span> Some <span class="skolem">k''</span> <span class="main">∨</span> <span class="skolem">y</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">x</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">∉</span> <span class="free">F</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">x</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> token_run <span class="skolem">y</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"token_succeeds <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> merge_def S_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">x</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">∉</span> <span class="free">F</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">x</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 add.commute token_run_P<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">q</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">q</span></span></span> <span class="main"><span class="main"><span class="main">∈</span></span></span> <span class="free"><span class="free"><span class="free">F</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> token_stays_in_final_states token_succeeds_def<span class="main">)</span>

      <span class="keyword1"><span class="command">moreover</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> Suc <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≤</span> Suc <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> Suc <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≤</span> Suc <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rank_Some_time <span class="quoted"><span class="quoted">‹rank <span class="skolem">x</span> <span class="skolem">n</span> <span class="main">=</span> Some <span class="skolem">k</span>›</span></span> <span class="quoted"><span class="quoted">‹rank <span class="skolem">y</span> <span class="skolem">n</span> <span class="main">=</span> Some <span class="skolem">k''</span> <span class="main">∨</span> <span class="skolem">y</span> <span class="main">=</span> Suc <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">y</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">∉</span> <span class="free">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">y</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹token_run <span class="skolem">x</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">∉</span> <span class="free">F</span>›</span></span> <span class="quoted"><span class="quoted">‹token_run <span class="skolem">x</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span>›</span></span> <span class="quoted"><span class="quoted">‹token_run <span class="skolem">x</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> token_run <span class="skolem">y</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> token_run_merge token_run_merge_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>

      <span class="keyword1"><span class="command">moreover</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="main">(</span>token_run <span class="skolem">x</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹token_run <span class="skolem">x</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">∉</span> <span class="free">F</span>›</span></span> <span class="quoted"><span class="quoted">‹token_run <span class="skolem">x</span> <span class="main">(</span>Suc<span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> token_is_not_in_sink <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

      <span class="comment1">― ‹Obtain rank used to enter final›</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"rank <span class="skolem">x</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">k'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span>sink <span class="main">(</span>token_run <span class="skolem">x</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≤</span> Suc <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

      <span class="keyword1"><span class="command">moreover</span></span>

      <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"rank <span class="skolem">y</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">k'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≤</span> Suc <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">≤</span> Suc <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span>›</span></span> token_run_merge <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≤</span> Suc <span class="skolem">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">≤</span> Suc <span class="skolem">n</span>›</span></span>
                  <span class="quoted"><span class="quoted">‹token_run <span class="skolem">x</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> token_run <span class="skolem">y</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>›</span></span> pull_up_token_run_tokens
                  pull_up_configuration_rank<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="skolem"><span class="skolem"><span class="skolem">n</span></span></span> <span class="main"><span class="main"><span class="main">+</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">m</span></span></span>"</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">y</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

      <span class="keyword1"><span class="command">moreover</span></span>

      <span class="comment1">― ‹Rank used to enter final states is strictly bounded by i›</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹rank <span class="skolem">x</span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">k'</span>›</span></span> rank_monotonic<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹rank <span class="skolem">x</span> <span class="skolem">n</span> <span class="main">=</span> Some <span class="skolem">k</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">i</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> add_Suc_shift <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

      <span class="keyword1"><span class="command">ultimately</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">{</span>succeed <span class="bound">j</span> <span class="main">|</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="skolem">i</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">{</span>succeed <span class="bound">j</span> <span class="main">|</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="skolem">i</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> succeed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> <span class="main">(</span>merge <span class="skolem">i</span> <span class="main">∩</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="main">{</span>succeed <span class="bound">j</span> <span class="main">|</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="skolem">i</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">`</span> <span class="main">(</span>merge <span class="skolem">i</span> <span class="main">∩</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="main">{</span>succeed <span class="bound">j</span> <span class="main">|</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="skolem">i</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>fst <span class="main">`</span> <span class="main">(</span>merge <span class="skolem">i</span> <span class="main">∩</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>snd <span class="main">`</span> <span class="main">(</span>merge <span class="skolem">i</span> <span class="main">∩</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_subset<span class="main">[</span><span class="operator">OF</span> _ fin_succeed_ranks<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">moreover</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>merge <span class="skolem">i</span> <span class="main">∩</span> <span class="main">(</span>UNIV <span class="main">-</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> l_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x</span></span> <span class="main">≥</span> <span class="skolem">l</span><span class="main">.</span> token_succeeds <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> accept_def MOST_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> merge <span class="skolem">i</span> <span class="main">∩</span> <span class="main">(</span>UNIV <span class="main">-</span> <span class="skolem">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>token_succeeds <span class="skolem">x</span> <span class="main">∨</span> <span class="main">¬</span>token_succeeds <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> S_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>token_succeeds <span class="skolem">x</span> <span class="main">∧</span> <span class="main">¬</span>token_succeeds <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> merge_token_succeeds <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> merge <span class="skolem">i</span> <span class="main">∩</span> <span class="main">(</span>UNIV <span class="main">-</span> <span class="skolem">S</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&lt;</span> <span class="skolem">l</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> l_def le_eq_less_or_eq linear<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"merge <span class="skolem">i</span> <span class="main">∩</span> <span class="main">(</span>UNIV <span class="main">-</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">l</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span><span class="skolem">l</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">ultimately</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>merge <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_Diff Un_Diff_Int finite_UnI inf_top_right<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite fail"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms mojmir_accept_alt_def fail_def token_fails_alt_def_2 infinite_nat_iff_unbounded_le mem_Collect_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite fail <span class="main">∧</span> finite <span class="main">(</span>merge <span class="skolem">i</span><span class="main">)</span> <span class="main">∧</span> infinite <span class="main">(</span>succeed <span class="skolem">i</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="skolem">i</span><span class="main">.</span> finite <span class="main">(</span>succeed <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹infinite <span class="main">(</span>succeed <span class="skolem">i</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="skolem">i</span> <span class="main">⟹</span> finite <span class="main">(</span>succeed <span class="bound">j</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Mojmir-mojmir_accept_token_set_def2"><span class="command">lemma</span></span> mojmir_accept_token_set_def2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite fail"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>merge <span class="free">i</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>succeed <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"accept"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∉</span> <span class="free">F</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> accept"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span>token_succeeds <span class="bound">x</span> <span class="main">∧</span> <span class="main">¬</span>token_squats <span class="bound">x</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite fail›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> fail_def token_fails_alt_def_2<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> token_succeeds <span class="bound">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> token_succeeds <span class="bound">x</span> <span class="main">∧</span> token_squats <span class="bound">x</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> token_succeeds <span class="bound">x</span> <span class="main">∧</span> <span class="main">¬</span> token_squats <span class="bound">x</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> inf<span class="main">:</span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span>token_succeeds <span class="bound">x</span> <span class="main">∧</span> token_squats <span class="bound">x</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mojmir_accept_alt_def X <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="comment1">― ‹Obtain j, where j is the rank used by infinitely many configuration stabilising and not succeeding›</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span>token_succeeds <span class="bound">x</span> <span class="main">∧</span> token_squats <span class="bound">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="free">i</span><span class="main">.</span> <span class="main">¬</span>token_succeeds <span class="bound">x</span> <span class="main">∧</span> token_squats <span class="bound">x</span> <span class="main">∧</span> stable_rank <span class="bound">x</span> <span class="bound">j</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> stable_rank_bounded <span class="quoted"><span class="quoted">‹infinite <span class="main">(</span>succeed <span class="free">i</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∉</span> <span class="free">F</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> stable_rank_equiv_token_squats <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">{</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span>  <span class="main">¬</span>token_succeeds <span class="bound">x</span> <span class="main">∧</span> token_squats <span class="bound">x</span> <span class="main">∧</span> stable_rank <span class="bound">x</span> <span class="bound">j</span><span class="main">}</span> <span class="main">|</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">i</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound">t</span><span class="main">.</span> <span class="main">¬</span>token_succeeds <span class="bound">t</span> <span class="main">∧</span> token_squats <span class="bound">t</span> <span class="main">∧</span> stable_rank <span class="bound">t</span> <span class="skolem">j</span><span class="main">}</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"infinite <span class="var">?S</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> inf <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

    <span class="comment1">― ‹Obtain such a token x›</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>token_succeeds <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"token_squats <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"stable_rank <span class="skolem">x</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> infinite_nat_iff_unbounded_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">m</span></span> <span class="main">≥</span> <span class="skolem">n</span><span class="main">.</span> rank <span class="skolem">x</span> <span class="bound">m</span> <span class="main">=</span> Some <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> stable_rank_def MOST_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="comment1">― ‹All configuration with same stable rank are bought at some n with rank smaller i›</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">|</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="skolem">n</span> <span class="main">∧</span> stable_rank <span class="bound">y</span> <span class="skolem">j</span><span class="main">}</span> <span class="main">⊆</span> merge <span class="free">i</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⊆</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="var">?lhs</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&gt;</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"stable_rank <span class="skolem">y</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rank_Some_time <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound"><span class="bound">n'</span></span><span class="main">≥</span><span class="skolem">n</span><span class="main">.</span> rank <span class="skolem">x</span> <span class="bound">n'</span> <span class="main">=</span> Some <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

      <span class="keyword1"><span class="command">moreover</span></span>

      <span class="comment1">― ‹Obtain a time n'' where x and y have the same rank›</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"rank <span class="skolem">x</span> <span class="skolem">n''</span> <span class="main">=</span> Some <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rank <span class="skolem">y</span> <span class="skolem">n''</span> <span class="main">=</span> Some <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound"><span class="bound">n'</span></span><span class="main">≥</span><span class="skolem">n</span><span class="main">.</span> rank <span class="skolem">x</span> <span class="bound">n'</span> <span class="main">=</span> Some <span class="skolem">j</span>›</span></span> <span class="quoted"><span class="quoted">‹stable_rank <span class="skolem">y</span> <span class="skolem">j</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> stable_rank_def MOST_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute le_add2<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">x</span> <span class="skolem">n''</span> <span class="main">=</span> token_run <span class="skolem">y</span> <span class="skolem">n''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">n''</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> push_down_rank_tokens rank_Some_time<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹rank <span class="skolem">y</span> <span class="skolem">n''</span> <span class="main">=</span> Some <span class="skolem">j</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

      <span class="comment1">― ‹Obtain the time n' where x merges y and proof all necessary properties›</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">x</span> <span class="skolem">n'</span> <span class="main">≠</span> token_run <span class="skolem">y</span> <span class="skolem">n'</span> <span class="main">∨</span> <span class="skolem">y</span> <span class="main">=</span> Suc <span class="skolem">n'</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">x</span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span> <span class="main">=</span> token_run <span class="skolem">y</span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≤</span> Suc <span class="skolem">n'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> token_run_mergepoint<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">y</span>›</span></span><span class="main">]</span> le_add_diff_inverse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

      <span class="keyword1"><span class="command">moreover</span></span>

      <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">j'</span><span class="main">.</span> rank <span class="skolem">y</span> <span class="skolem">n'</span> <span class="main">=</span> Some <span class="bound">j'</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">y</span> <span class="main">=</span> Suc <span class="skolem">n'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹stable_rank <span class="skolem">y</span> <span class="skolem">j</span>›</span></span> stable_rank_equiv_token_squats rank_token_squats
        <span class="keyword1"><span class="command">unfolding</span></span> le_Suc_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

      <span class="keyword1"><span class="command">moreover</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rank <span class="skolem">x</span> <span class="skolem">n'</span> <span class="main">=</span> Some <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound"><span class="bound">n'</span></span><span class="main">≥</span><span class="skolem">n</span><span class="main">.</span> rank <span class="skolem">x</span> <span class="bound">n'</span> <span class="main">=</span> Some <span class="skolem">j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">≤</span> Suc <span class="skolem">n'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">&gt;</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

      <span class="keyword1"><span class="command">moreover</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">x</span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span> <span class="main">∉</span> <span class="free">F</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> token_succeeds <span class="skolem">x</span>›</span></span> token_succeeds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="var">?rhs</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> merge_def <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">moreover</span></span>

    <span class="comment1">― ‹However, x merges infinitely many configuration›</span>
    <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">|</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="skolem">n</span> <span class="main">∧</span> stable_rank <span class="bound">y</span> <span class="skolem">j</span><span class="main">}</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"infinite <span class="var">?S'</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"stable_rank <span class="skolem">y</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&gt;</span> <span class="skolem">n</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"rank <span class="skolem">y</span> <span class="skolem">n'</span> <span class="main">=</span> Some <span class="skolem">j</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> stable_rank_def MOST_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">n'</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rank_Some_time<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">&gt;</span> <span class="skolem">n</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">&gt;</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rank <span class="skolem">x</span> <span class="skolem">n'</span> <span class="main">=</span> Some <span class="skolem">j</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound"><span class="bound">n'</span></span> <span class="main">≥</span> <span class="skolem">n</span><span class="main">.</span> rank <span class="skolem">x</span> <span class="bound">n'</span> <span class="main">=</span> Some <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">ultimately</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>token_succeeds <span class="skolem">y</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span>token_succeeds <span class="skolem">x</span>›</span></span> configuration_token_succeeds push_down_rank_tokens<span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">y</span> <span class="main">|</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="skolem">n</span> <span class="main">∧</span> stable_rank <span class="bound">y</span> <span class="skolem">j</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">y</span> <span class="main">|</span> <span class="bound">y</span><span class="main">.</span> token_squats <span class="bound">y</span> <span class="main">∧</span> <span class="main">¬</span>token_succeeds <span class="bound">y</span> <span class="main">∧</span> stable_rank <span class="bound">y</span> <span class="skolem">j</span> <span class="main">∧</span>  <span class="bound">y</span> <span class="main">&gt;</span> <span class="skolem">n</span><span class="main">}</span>"</span></span>
          <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?S''</span>"</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> stable_rank_equiv_token_squats <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">y</span> <span class="main">|</span> <span class="bound">y</span><span class="main">.</span> token_squats <span class="bound">y</span> <span class="main">∧</span> <span class="main">¬</span>token_succeeds <span class="bound">y</span> <span class="main">∧</span> stable_rank <span class="bound">y</span> <span class="skolem">j</span> <span class="main">∧</span>  <span class="bound">y</span> <span class="main">≤</span> <span class="skolem">n</span><span class="main">}</span>"</span></span>
          <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?S'''</span>"</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">=</span> <span class="var">?S''</span> <span class="main">∪</span> <span class="var">?S'''</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound">y</span> <span class="main">|</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="skolem">n</span> <span class="main">∧</span> stable_rank <span class="bound">y</span> <span class="skolem">j</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹infinite <span class="var">?S</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">&gt;</span> <span class="skolem">n</span> <span class="main">∧</span> stable_rank <span class="bound">y</span> <span class="skolem">j</span><span class="main">}</span> <span class="main">=</span> <span class="var">?S'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> empty_iff finite_cartesian_productD2 singletonI<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">ultimately</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>merge <span class="free">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> infinite_super<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>merge <span class="free">i</span><span class="main">)</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mojmir_accept_initial<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> mojmir_accept_iff_token_set_accept<span class="main">:</span>
  <span class="quoted"><span class="quoted">"accept <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> max_rank<span class="main">.</span> finite fail <span class="main">∧</span> finite <span class="main">(</span>merge <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> infinite <span class="main">(</span>succeed <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mojmir_accept_token_set_def1 mojmir_accept_token_set_def2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">theorem</span></span> mojmir_accept_iff_token_set_accept2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"accept <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> max_rank<span class="main">.</span> finite fail <span class="main">∧</span> finite <span class="main">(</span>merge <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> infinite <span class="main">(</span>succeed <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="bound">i</span><span class="main">.</span> finite <span class="main">(</span>merge <span class="bound">j</span><span class="main">)</span> <span class="main">∧</span> finite <span class="main">(</span>succeed <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mojmir_accept_token_set_def1 mojmir_accept_token_set_def2 merge_finite' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Time-Based Definitions›</span></span>

<span class="comment1">― ‹Proof Rules›</span>

<span class="keyword1" id="Mojmir-finite_monotonic_image"><span class="command">lemma</span></span> finite_monotonic_image<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="free">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟷</span> finite <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">≤</span> Max <span class="free">B</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms Max_ge_iff <span class="quoted"><span class="quoted">‹finite <span class="free">B</span>›</span></span> imageI<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> finite_nat_set_iff_bounded_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> image_is_empty<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> finite_imageI<span class="main">)</span>

<span class="keyword1" id="Mojmir-finite_monotonic_image_pairs"><span class="command">lemma</span></span> finite_monotonic_image_pairs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">(</span>fst <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">+</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">(</span>snd <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">i</span> <span class="main">+</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟷</span> finite <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> fst <span class="bound">i</span> <span class="main">≤</span> Max <span class="free">B</span> <span class="main">+</span> <span class="free">c</span> <span class="main">∧</span> snd <span class="bound">i</span> <span class="main">≤</span> Max <span class="free">B</span> <span class="main">+</span> <span class="free">d</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms Max_ge_iff <span class="quoted"><span class="quoted">‹finite <span class="free">B</span>›</span></span> imageI le_diff_conv<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> finite_product<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> finite_nat_set_iff_bounded_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> finite.emptyI image_is_empty<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> finite_imageI<span class="main">)</span>

<span class="keyword1" id="Mojmir-token_time_finite_rule"><span class="command">lemma</span></span> token_time_finite_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="free">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> unique<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">z</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">=</span> <span class="bound">z</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> existsA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> existsB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> inA<span class="main">:</span>     <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> inB<span class="main">:</span>     <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">B</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> mono<span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟷</span> finite <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> finite_monotonic_image<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">then</span> The <span class="main">(</span><span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> undefined<span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="var">?f</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> existsA the_equality unique <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="var">?f</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="var">?f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">=</span> The <span class="main">(</span><span class="free">P</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inA existsA unique the_equality<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="free">B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> inB existsB <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="var">?f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⟷</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="free">B</span>"</span></span>
      <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Mojmir-token_time_finite_pair_rule"><span class="command">lemma</span></span> token_time_finite_pair_rule<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> unique<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">z</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">=</span> <span class="bound">z</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> existsA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> existsB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> inA<span class="main">:</span>     <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> inB<span class="main">:</span>     <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">B</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> mono<span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> fst <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span> <span class="main">+</span> <span class="free">c</span> <span class="main">∧</span> snd <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span> <span class="main">+</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟷</span> finite <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> finite_monotonic_image_pairs<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">then</span> The <span class="main">(</span><span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> undefined<span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="var">?f</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> existsA the_equality unique <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">x</span> <span class="main">≤</span> <span class="var">?f</span> <span class="skolem">x</span> <span class="main">+</span> <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">x</span> <span class="main">≤</span> <span class="var">?f</span> <span class="skolem">x</span> <span class="main">+</span> <span class="free">d</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="var">?f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">=</span> The <span class="main">(</span><span class="free">P</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inA existsA unique the_equality<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="free">B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> inB existsB <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="var">?f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⟷</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="free">B</span>"</span></span>
      <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹Correspondence Between Token- and Time-Based Definitions›</span>

<span class="keyword1" id="Mojmir-fail_t_inclusion"><span class="command">lemma</span></span> fail_t_inclusion<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="main">(</span>token_run <span class="free">x</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sink <span class="main">(</span>token_run <span class="free">x</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"token_run <span class="free">x</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">∉</span> <span class="free">F</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> fail_t"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> token_run <span class="free">x</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">=</span> token_run <span class="free">x</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"sink <span class="skolem">q'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">∉</span> <span class="free">F</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> * <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"state_rank <span class="skolem">q</span> <span class="free">n</span> <span class="main">≠</span> None"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> q_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> oldest_token_always_def option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> state_rank_None<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> ** <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">q</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> q_def q'_def <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> token_run_step' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> fail_t"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fail_t_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Mojmir-merge_t_inclusion"><span class="command">lemma</span></span> merge_t_inclusion<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">j'</span><span class="main">.</span> token_run <span class="free">x</span> <span class="free">n</span> <span class="main">≠</span> token_run <span class="free">y</span> <span class="free">n</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> state_rank <span class="main">(</span>token_run <span class="free">y</span> <span class="free">n</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> Some <span class="bound">j'</span><span class="main">)</span> <span class="main">∨</span> <span class="free">y</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"token_run <span class="free">x</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> token_run <span class="free">y</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"token_run <span class="free">x</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">∉</span> <span class="free">F</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"state_rank <span class="main">(</span>token_run <span class="free">x</span> <span class="free">n</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> merge_t <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="skolem"><span class="skolem">q''</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> token_run <span class="free">x</span> <span class="free">n</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">=</span> token_run <span class="free">x</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q''</span> <span class="main">=</span> token_run <span class="free">y</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≤</span> Suc <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">q'</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">q''</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="main">∧</span> state_rank <span class="skolem">q''</span> <span class="free">n</span> <span class="main">≠</span> None <span class="main">∧</span> <span class="skolem">q''</span> <span class="main">≠</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">q'</span> <span class="main">=</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> q_def q'_def q''_def <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2-3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="operator">metis</span> token_run_intial_state<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">metis</span> option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> token_run_step<span class="main">)</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"state_rank <span class="skolem">q</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">j</span> <span class="main">∧</span> <span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">∧</span> <span class="skolem">q'</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">q</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">q'</span> <span class="main">∉</span> <span class="free">F</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> q_def q'_def <span class="keyword1"><span class="command">using</span></span> token_run_step<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> assms<span class="main">(</span>4-6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> merge_t <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> merge_t_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Mojmir-succeed_t_inclusion"><span class="command">lemma</span></span> succeed_t_inclusion<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rank <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"token_run <span class="free">x</span> <span class="free">n</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">-</span> <span class="main">{</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"token_run <span class="free">x</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> succeed_t <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> token_run <span class="free">x</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"state_rank <span class="skolem">q</span> <span class="free">n</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">-</span> <span class="main">{</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="skolem">q</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> token_run_step' rank_Some_time<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> assms rank_eq_state_rank <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> succeed_t <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> succeed_t_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Mojmir-finite_fail_t"><span class="command">lemma</span></span> finite_fail_t<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite fail <span class="main">=</span> finite fail_t"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> token_time_finite_rule<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">n</span>
    <span class="main">∧</span> <span class="main">¬</span>sink <span class="main">(</span>token_run <span class="bound">x</span> <span class="bound">n</span><span class="main">)</span>
    <span class="main">∧</span> sink <span class="main">(</span>token_run <span class="bound">x</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span>
    <span class="main">∧</span> token_run <span class="bound">x</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="main">∉</span> <span class="free">F</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="main">(</span>token_run <span class="skolem">x</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> sink_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> fail"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"token_fails <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> fail_def <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"sink <span class="main">(</span>token_run <span class="skolem">x</span> <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> token_fails_alt_def MOST_nat
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> sink <span class="main">(</span>token_run <span class="skolem">x</span> <span class="skolem">x</span><span class="main">)</span>›</span></span> less_add_Suc2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="main">(</span>token_run <span class="skolem">x</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sink <span class="main">(</span>token_run <span class="skolem">x</span> <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> token_run_P<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">q</span><span class="main">.</span> sink <span class="bound">q</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span>sink <span class="main">(</span>token_run <span class="skolem">x</span> <span class="skolem">x</span><span class="main">)</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="var">?P</span> <span class="skolem">x</span> <span class="bound">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> token_fails_alt_def_2 token_succeeds_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_add1<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> fail_t"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"state_rank <span class="skolem">q</span> <span class="skolem">y</span> <span class="main">=</span> Some <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">q</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">∉</span> <span class="free">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sink <span class="skolem">q'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> fail_t_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> push_down_state_rank_token_run<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">x</span> <span class="main">(</span>Suc <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> token_run_step<span class="main">[</span><span class="operator">OF</span> _ _ <span class="quoted"><span class="quoted">‹<span class="skolem">q'</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">q</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">y</span><span class="main">)</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">x</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> state_rank_sink<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> fail"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> fail_t"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> fail_def <span class="keyword1"><span class="command">using</span></span> token_fails_def fail_t_inclusion <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="comment1">― ‹Uniqueness›</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">x</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">x</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="main">(</span>token_run <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sink <span class="main">(</span>token_run <span class="skolem">x</span> <span class="main">(</span>Suc <span class="skolem">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">x</span> <span class="skolem">z</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="main">(</span>token_run <span class="skolem">x</span> <span class="skolem">z</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sink <span class="main">(</span>token_run <span class="skolem">x</span> <span class="main">(</span>Suc <span class="skolem">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> token_stays_in_sink
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">z</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linorder_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
         <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Suc_leI le_add_diff_inverse<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Mojmir-finite_succeed_t'"><span class="command">lemma</span></span> finite_succeed_t'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∉</span> <span class="free">F</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>succeed <span class="free">i</span><span class="main">)</span> <span class="main">=</span> finite <span class="main">(</span>succeed_t <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> token_time_finite_rule<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">n</span>
    <span class="main">∧</span> state_rank <span class="main">(</span>token_run <span class="bound">x</span> <span class="bound">n</span><span class="main">)</span> <span class="bound">n</span> <span class="main">=</span> Some <span class="free">i</span>
    <span class="main">∧</span> <span class="main">(</span>token_run <span class="bound">x</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">-</span> <span class="main">{</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span>
    <span class="main">∧</span> <span class="main">(</span>token_run <span class="bound">x</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> succeed <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">-</span> <span class="main">{</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">x</span> <span class="main">(</span>Suc <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rank <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span>
       <span class="keyword1"><span class="command">unfolding</span></span> succeed_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"rank <span class="main">(</span>senior <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rank_Some_time<span class="main">[</span><span class="operator">THEN</span> rank_senior_senior<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"state_rank <span class="main">(</span>token_run <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> state_rank_eq_rank senior.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> oldest_token_always_def option.sel option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="var">?P</span> <span class="skolem">x</span> <span class="bound">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rank_Some_time <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> succeed_t <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"state_rank <span class="skolem">q</span> <span class="skolem">y</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">-</span> <span class="main">{</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">δ</span> <span class="skolem">q</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> succeed_t_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> token_run <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> oldest_token_bounded push_down_oldest_token_token_run push_down_state_rank_oldest_token<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">x</span> <span class="main">(</span>Suc <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> token_run_step <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">δ</span> <span class="skolem">q</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">x</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> succeed <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> succeed_t <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> succeed_def <span class="keyword1"><span class="command">using</span></span> rank_eq_state_rank<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span> succeed_t_inclusion
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> mem_Collect_eq<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="comment1">― ‹Uniqueness›</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">x</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">x</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">∉</span> <span class="free">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">x</span> <span class="main">(</span>Suc <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∉</span> <span class="free">F</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">x</span> <span class="skolem">z</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">x</span> <span class="skolem">z</span> <span class="main">∉</span> <span class="free">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">x</span> <span class="main">(</span>Suc <span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∉</span> <span class="free">F</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> token_stays_in_final_states
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">z</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linorder_cases<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
         <span class="main">(</span><span class="operator">metis</span> le_Suc_ex less_Suc_eq_le not_le<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Mojmir-initial_in_F_token_run"><span class="command">lemma</span></span> initial_in_F_token_run<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="free">F</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"token_run <span class="free">x</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">F</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms token_stays_in_final_states<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Mojmir-finite_succeed_t''"><span class="command">lemma</span></span> finite_succeed_t''<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="free">F</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>succeed <span class="free">i</span><span class="main">)</span> <span class="main">=</span> finite <span class="main">(</span>succeed_t <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"succeed_t <span class="free">i</span> <span class="main">=</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> state_rank <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">n</span> <span class="main">=</span> Some <span class="free">i</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> succeed_t_def <span class="keyword1"><span class="command">using</span></span> initial_in_F_token_run assms wellformed_F <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> rank <span class="bound">n</span> <span class="bound">n</span> <span class="main">=</span> Some <span class="free">i</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rank_eq_state_rank<span class="main">[</span><span class="operator">OF</span> order_refl<span class="main">]</span> token_run_intial_state <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword1"><span class="command">have</span></span> succeed_t_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"succeed_t <span class="free">i</span> <span class="main">=</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> rank <span class="bound">n</span> <span class="bound">n</span> <span class="main">=</span> Some <span class="free">i</span> <span class="main">∧</span> token_run <span class="bound">n</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> succeed_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"succeed <span class="free">i</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> rank <span class="bound">x</span> <span class="bound">n</span> <span class="main">=</span> Some <span class="free">i</span> <span class="main">∧</span> token_run <span class="bound">x</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> succeed_def <span class="keyword1"><span class="command">using</span></span> initial_in_F_token_run<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"succeed_t <span class="free">i</span> <span class="main">⊆</span> succeed <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> succeed_t_alt_def succeed_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> rev_finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">U</span></span> <span class="keyword2"><span class="keyword">where</span></span> U_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> succeed_t <span class="free">i</span> <span class="main">⟹</span> <span class="skolem">U</span> <span class="main">≥</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> finite_nat_set_iff_bounded_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> succeed <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"rank <span class="skolem">x</span> <span class="skolem">n</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">x</span> <span class="skolem">n</span> <span class="main">=</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> succeed_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> rank_Some_time<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"rank <span class="skolem">n</span> <span class="skolem">n</span> <span class="main">=</span> Some <span class="free">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹rank <span class="skolem">x</span> <span class="skolem">n</span> <span class="main">=</span> Some <span class="free">i</span>›</span></span> <span class="quoted"><span class="quoted">‹token_run <span class="skolem">x</span> <span class="skolem">n</span> <span class="main">=</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> order_refl token_run_intial_state<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> pull_up_token_run_tokens pull_up_configuration_rank<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> succeed_t <span class="free">i</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> succeed_t_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">U</span> <span class="main">≥</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> U_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> finite_nat_set_iff_bounded_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Mojmir-finite_succeed_t"><span class="command">lemma</span></span> finite_succeed_t<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>succeed <span class="free">i</span><span class="main">)</span> <span class="main">=</span> finite <span class="main">(</span>succeed_t <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> finite_succeed_t' finite_succeed_t'' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Mojmir-finite_merge_t"><span class="command">lemma</span></span> finite_merge_t<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>merge <span class="free">i</span><span class="main">)</span> <span class="main">=</span> finite <span class="main">(</span>merge_t <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> token_time_finite_pair_rule<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="bound">n</span><span class="main">.</span> <span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">n</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">j'</span><span class="main">.</span> token_run <span class="bound">x</span> <span class="bound">n</span> <span class="main">≠</span> token_run <span class="bound">y</span> <span class="bound">n</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">≤</span> <span class="bound">n</span> <span class="main">∧</span> state_rank <span class="main">(</span>token_run <span class="bound">y</span> <span class="bound">n</span><span class="main">)</span> <span class="bound">n</span> <span class="main">=</span> Some <span class="bound">j'</span><span class="main">)</span> <span class="main">∨</span> <span class="bound">y</span> <span class="main">=</span> Suc <span class="bound">n</span><span class="main">)</span>
    <span class="main">∧</span> token_run <span class="bound">x</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> token_run <span class="bound">y</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span>
    <span class="main">∧</span> token_run <span class="bound">x</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="main">∉</span> <span class="free">F</span>
    <span class="main">∧</span> state_rank <span class="main">(</span>token_run <span class="bound">x</span> <span class="bound">n</span><span class="main">)</span> <span class="bound">n</span> <span class="main">=</span> Some <span class="bound">j</span>
    <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">i</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> merge <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">j'</span><span class="main">.</span> token_run <span class="skolem">t</span> <span class="skolem">n</span> <span class="main">≠</span> token_run <span class="skolem">t'</span> <span class="skolem">n</span> <span class="main">∧</span> rank <span class="skolem">t'</span> <span class="skolem">n</span> <span class="main">=</span> Some <span class="bound">j'</span><span class="main">)</span> <span class="main">∨</span>  <span class="skolem">t'</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">t</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> token_run <span class="skolem">t'</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">t</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">∉</span> <span class="free">F</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"rank <span class="skolem">t</span> <span class="skolem">n</span> <span class="main">=</span> Some <span class="skolem">j</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> 7<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> merge_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> 8<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 9<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">≤</span> Suc <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rank_Some_time le_Suc_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> 10<span class="main">:</span> <span class="quoted"><span class="quoted">"state_rank <span class="main">(</span>token_run <span class="skolem">t</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">n</span> <span class="main">=</span> Some <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹rank <span class="skolem">t</span> <span class="skolem">n</span> <span class="main">=</span> Some <span class="skolem">j</span>›</span></span> rank_eq_state_rank <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="var">?P</span> <span class="skolem">x</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="main">≤</span> Suc <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">with</span></span> 1 3 4 5 7 8 10 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> rank_eq_state_rank<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="main">≤</span> <span class="skolem">n</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> merge_t <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"state_rank <span class="skolem">q</span> <span class="skolem">y</span> <span class="main">=</span> Some <span class="skolem">j</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">q</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">∉</span> <span class="free">F</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">q''</span><span class="main">.</span> <span class="skolem">q'</span> <span class="main">=</span> <span class="free">δ</span> <span class="bound">q''</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∧</span> state_rank <span class="bound">q''</span> <span class="skolem">y</span> <span class="main">≠</span> None <span class="main">∧</span> <span class="bound">q''</span> <span class="main">≠</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">q'</span> <span class="main">=</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> merge_t_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> token_run <span class="skolem">t</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 7<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> push_down_state_rank_token_run <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">hence</span></span> 8<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">=</span> token_run <span class="skolem">t</span> <span class="main">(</span>Suc <span class="skolem">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">q'</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">q</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">y</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> token_run_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">=</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">t</span> <span class="main">(</span>Suc <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> token_run <span class="main">(</span>Suc <span class="skolem">y</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">y</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> 8 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> Suc <span class="skolem">y</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 1 2 3 4 5 7 <span class="keyword1"><span class="command">unfolding</span></span> 6 8 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">x</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">≠</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q''</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 9<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">q''</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"state_rank <span class="skolem">q''</span> <span class="skolem">y</span> <span class="main">=</span> Some <span class="skolem">j'</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q''</span> <span class="main">≠</span> <span class="skolem">q</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 5 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q''</span> <span class="main">=</span> token_run <span class="skolem">t'</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> push_down_state_rank_token_run<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">t</span> <span class="main">(</span>Suc <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> token_run <span class="skolem">t'</span> <span class="main">(</span>Suc <span class="skolem">y</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 8 9 token_run_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">t</span> <span class="skolem">y</span> <span class="main">≠</span> token_run <span class="skolem">t'</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">q''</span> <span class="main">≠</span> <span class="skolem">q</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 6 12 <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 1 2 4 7 <span class="keyword1"><span class="command">unfolding</span></span> 6 8 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">x</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">x</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">j'</span><span class="main">.</span> token_run <span class="skolem">t</span> <span class="skolem">y</span> <span class="main">≠</span> token_run <span class="skolem">t'</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="skolem">t'</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">∧</span> state_rank <span class="main">(</span>token_run <span class="skolem">t'</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">=</span> Some <span class="bound">j'</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">t'</span> <span class="main">=</span> Suc <span class="skolem">y</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">t</span> <span class="main">(</span>Suc <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> token_run <span class="skolem">t'</span> <span class="main">(</span>Suc <span class="skolem">y</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">t</span> <span class="main">(</span>Suc <span class="skolem">y</span><span class="main">)</span> <span class="main">∉</span> <span class="free">F</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> 7<span class="main">:</span> <span class="quoted"><span class="quoted">"state_rank <span class="main">(</span>token_run <span class="skolem">t</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">=</span> Some <span class="skolem">j</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> 8<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> merge <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> Suc <span class="skolem">y</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> 1 3 4 5 6 7 8 <span class="keyword1"><span class="command">unfolding</span></span> merge_def
          <span class="keyword1"><span class="command">unfolding</span></span> rank_eq_state_rank<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">t'</span> <span class="main">≤</span> <span class="skolem">y</span>›</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> rank_eq_state_rank<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">≤</span> <span class="skolem">y</span>›</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">unfold</span> rank_eq_state_rank<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">≤</span> <span class="skolem">y</span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> merge_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> merge_t <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">+</span> <span class="main">0</span> <span class="main">∧</span> snd <span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> merge_t_inclusion <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">x</span> <span class="skolem">y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="comment1">― ‹Uniqueness›</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">x</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">x</span> <span class="skolem">y</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">)</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> y1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> y2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>token_run <span class="skolem">t</span> <span class="skolem">y</span> <span class="main">≠</span> token_run <span class="skolem">t'</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="skolem">t'</span> <span class="main">≤</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">t'</span> <span class="main">=</span> Suc <span class="skolem">y</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> y3<span class="main">:</span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">t</span> <span class="main">(</span>Suc <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> token_run <span class="skolem">t'</span> <span class="main">(</span>Suc <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?P</span> <span class="skolem">x</span> <span class="skolem">z</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">t'</span><span class="main">)</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> z1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> <span class="skolem">z</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> z2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>token_run <span class="skolem">t</span> <span class="skolem">z</span> <span class="main">≠</span> token_run <span class="skolem">t'</span> <span class="skolem">z</span> <span class="main">∧</span> <span class="skolem">t'</span> <span class="main">≤</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">t'</span> <span class="main">=</span> Suc <span class="skolem">z</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> z3<span class="main">:</span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">t</span> <span class="main">(</span>Suc <span class="skolem">z</span><span class="main">)</span> <span class="main">=</span> token_run <span class="skolem">t'</span> <span class="main">(</span>Suc <span class="skolem">z</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> y4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">≤</span> Suc <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> z4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">≤</span> Suc <span class="skolem">z</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> y2 z2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">z</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> linorder_cases<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> less
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">y</span> <span class="main">+</span> <span class="skolem">d</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_Suc_right add_Suc_shift less_imp_Suc_add<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> y1 y2 z2 token_run_merge<span class="main">[</span><span class="operator">OF</span> _ y4 y3<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> greater
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">z</span> <span class="main">+</span> <span class="skolem">d</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_Suc_right add_Suc_shift less_imp_Suc_add<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> z1 y2 z2 token_run_merge<span class="main">[</span><span class="operator">OF</span> _ z4 z3<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Relation to Mojmir Acceptance›</span></span>

<span class="keyword1" id="Mojmir-token_iff_time_accept"><span class="command">lemma</span></span> token_iff_time_accept<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>finite fail <span class="main">∧</span> finite <span class="main">(</span>merge <span class="free">i</span><span class="main">)</span> <span class="main">∧</span> infinite <span class="main">(</span>succeed <span class="free">i</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="free">i</span><span class="main">.</span> finite <span class="main">(</span>succeed <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
       <span class="main">=</span> <span class="main">(</span>finite fail_t <span class="main">∧</span> finite <span class="main">(</span>merge_t <span class="free">i</span><span class="main">)</span> <span class="main">∧</span> infinite <span class="main">(</span>succeed_t <span class="free">i</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="free">i</span><span class="main">.</span> finite <span class="main">(</span>succeed_t <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> finite_fail_t finite_merge_t finite_succeed_t <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Succeeding Tokens (Alternative Definition)›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">stable_rank_at</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">stable_rank_at</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">m</span></span> <span class="main">≥</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> rank <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">m</span> <span class="main">=</span> Some <span class="bound">i</span>"</span></span>

<span class="keyword1" id="Mojmir-stable_rank_at_ge"><span class="command">lemma</span></span> stable_rank_at_ge<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">m</span> <span class="main">⟹</span> stable_rank_at <span class="free">x</span> <span class="free">n</span> <span class="main">⟹</span> stable_rank_at <span class="free">x</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> stable_rank_at_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Mojmir-stable_rank_equiv"><span class="command">lemma</span></span> stable_rank_equiv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> stable_rank <span class="free">x</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> stable_rank_at <span class="free">x</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> stable_rank_def MOST_nat_le stable_rank_at_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Mojmir-smallest_accepting_rank_properties"><span class="command">lemma</span></span> smallest_accepting_rank_properties<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"smallest_accepting_rank <span class="main">=</span> Some <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"accept"</span></span> <span class="quoted"><span class="quoted">"finite fail"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>merge <span class="free">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>succeed <span class="free">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="free">i</span><span class="main">.</span> finite <span class="main">(</span>succeed <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> max_rank"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"accept"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> smallest_accepting_rank_def <span class="keyword1"><span class="command">using</span></span> option.distinct<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"finite fail"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>merge <span class="skolem">i'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>succeed <span class="skolem">i'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="skolem">i'</span><span class="main">.</span> finite <span class="main">(</span>succeed <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> max_rank"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mojmir_accept_iff_token_set_accept2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> finite fail <span class="main">∧</span> finite <span class="main">(</span>merge <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span> infinite <span class="main">(</span>succeed <span class="bound">y</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">i'</span> <span class="main">≤</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> not_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i</span><span class="main">.</span> finite fail <span class="main">∧</span> finite <span class="main">(</span>merge <span class="bound">i</span><span class="main">)</span> <span class="main">∧</span> infinite <span class="main">(</span>succeed <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> le_antisym <span class="keyword1"><span class="command">unfolding</span></span> Least_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> the_equality<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">i'</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹smallest_accepting_rank <span class="main">=</span> Some <span class="free">i</span>›</span></span> <span class="quoted"><span class="quoted">‹accept›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> smallest_accepting_rank_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"finite fail"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>merge <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>succeed <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="free">i</span><span class="main">.</span> finite <span class="main">(</span>succeed <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> max_rank"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite fail›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>merge <span class="skolem">i'</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹infinite <span class="main">(</span>succeed <span class="skolem">i'</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="skolem">i'</span><span class="main">.</span> finite <span class="main">(</span>succeed <span class="bound">j</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i'</span> <span class="main">&lt;</span> max_rank›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Mojmir-token_smallest_accepting_rank"><span class="command">lemma</span></span> token_smallest_accepting_rank<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"smallest_accepting_rank <span class="main">=</span> Some <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">n</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> token_succeeds <span class="bound">x</span> <span class="main">⟷</span> <span class="main">(</span><span class="bound">x</span> <span class="main">&gt;</span> <span class="bound">n</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> <span class="free">i</span><span class="main">.</span> rank <span class="bound">x</span> <span class="bound">n</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">)</span> <span class="main">∨</span> token_run <span class="bound">x</span> <span class="bound">n</span> <span class="main">∈</span> <span class="free">F</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"accept"</span></span> <span class="quoted"><span class="quoted">"finite fail"</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>succeed <span class="free">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="free">i</span><span class="main">.</span> finite <span class="main">(</span>succeed <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> smallest_accepting_rank_properties <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="hidden">⇩</span><sub>1</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">x</span></span> <span class="main">≥</span> <span class="skolem">n<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> token_succeeds <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> accept_def MOST_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> Suc <span class="main">(</span>Max <span class="main">(</span>fail_t <span class="main">∪</span> <span class="main">⋃</span><span class="main">{</span>succeed_t <span class="bound">j</span> <span class="main">|</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> Suc <span class="main">(</span>Max <span class="var">?S</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n<span class="hidden">⇩</span><sub>3</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">=</span> Max <span class="main">(</span><span class="main">{</span><span class="keyword1">LEAST</span> <span class="bound">m</span><span class="main">.</span> stable_rank_at <span class="bound">x</span> <span class="bound">m</span> <span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">n<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> token_squats <span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> Max <span class="var">?S'</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> Max <span class="main">{</span><span class="skolem">n<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">n<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">n<span class="hidden">⇩</span><sub>3</sub></span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?S'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite fail›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="free">i</span><span class="main">.</span> finite <span class="main">(</span>succeed <span class="bound">j</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> finite_fail_t finite_succeed_t <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">n<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"token_squats <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">m</span><span class="main">.</span> stable_rank_at <span class="skolem">x</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?S'</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?m</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?m</span> <span class="main">≤</span> <span class="skolem">n<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Max.coboundedI<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="var">?S'</span>›</span></span><span class="main">]</span> n<span class="hidden">⇩</span><sub>3</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"stable_rank <span class="skolem">x</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">n<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹token_squats <span class="skolem">x</span>›</span></span> stable_rank_equiv_token_squats <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"stable_rank_at <span class="skolem">x</span> <span class="var">?m</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> stable_rank_equiv LeastI<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stable_rank_at <span class="skolem">x</span> <span class="skolem">n<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stable_rank_at_ge<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">m'</span></span> <span class="main">≥</span> <span class="skolem">n</span><span class="main">.</span> rank <span class="skolem">x</span> <span class="bound">m'</span> <span class="main">=</span> Some <span class="bound">i</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> n_def stable_rank_at_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> Stable <span class="main">=</span> this

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟹</span> <span class="bound">m</span> <span class="main">∈</span> succeed_t <span class="bound">j</span> <span class="main">⟹</span> <span class="bound">m</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Max.coboundedI<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="var">?S</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> n_def n<span class="hidden">⇩</span><sub>2</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> Succeed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span> <span class="bound">j</span> <span class="bound">x</span><span class="main">.</span> <span class="skolem">n</span> <span class="main">≤</span> <span class="bound">m</span> <span class="main">⟹</span> token_run <span class="bound">x</span> <span class="bound">m</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">-</span> <span class="main">{</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span> <span class="main">⟹</span> token_run <span class="bound">x</span> <span class="main">(</span>Suc <span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span> <span class="main">⟹</span> rank <span class="bound">x</span> <span class="bound">m</span> <span class="main">=</span> Some <span class="bound">j</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> not_le succeed_t_inclusion<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span><span class="main">.</span> <span class="bound">m</span> <span class="main">∈</span> fail_t <span class="main">⟹</span> <span class="bound">m</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Max.coboundedI<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="var">?S</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> n_def n<span class="hidden">⇩</span><sub>2</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> Fail<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span> <span class="bound">x</span><span class="main">.</span> <span class="skolem">n</span> <span class="main">≤</span> <span class="bound">m</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">m</span> <span class="main">⟹</span> sink <span class="main">(</span>token_run <span class="bound">x</span> <span class="bound">m</span><span class="main">)</span> <span class="main">∨</span> <span class="main">¬</span>sink <span class="main">(</span>token_run <span class="bound">x</span> <span class="main">(</span>Suc <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">¬</span>token_run <span class="bound">x</span> <span class="main">(</span>Suc <span class="bound">m</span><span class="main">)</span> <span class="main">∉</span> <span class="free">F</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fail_t_inclusion <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≥</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≥</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"token_succeeds <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">x</span> <span class="skolem">m</span> <span class="main">∉</span> <span class="free">F</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">m'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">x</span> <span class="skolem">m'</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">-</span> <span class="main">{</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">x</span> <span class="main">(</span>Suc <span class="skolem">m'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> token_run_enter_final_states <span class="keyword1"><span class="command">unfolding</span></span> token_succeeds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="main">(</span>token_run <span class="skolem">x</span> <span class="skolem">m'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_empty Diff_insert0 <span class="quoted"><span class="quoted">‹token_run <span class="skolem">x</span> <span class="skolem">m</span> <span class="main">∉</span> <span class="free">F</span>›</span></span> initial_in_F_token_run token_is_not_in_sink<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"rank <span class="skolem">x</span> <span class="skolem">m'</span> <span class="main">=</span> Some <span class="skolem">j'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≤</span> <span class="skolem">m'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹token_run <span class="skolem">x</span> <span class="skolem">m</span> <span class="main">∉</span> <span class="free">F</span>›</span></span> token_stays_in_final_states<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹token_run <span class="skolem">x</span> <span class="main">(</span>Suc <span class="skolem">m'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span>›</span></span><span class="main"><span class="main">]</span></span> add_Suc_right add_Suc_shift less_imp_Suc_add not_le<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m'</span> <span class="main">≥</span> <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">m</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">≥</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">≥</span> <span class="free">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Succeed<span class="main">[</span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹token_run <span class="skolem">x</span> <span class="skolem">m'</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">-</span> <span class="main">{</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹token_run <span class="skolem">x</span> <span class="main">(</span>Suc <span class="skolem">m'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span>›</span></span> <span class="quoted"><span class="quoted">‹rank <span class="skolem">x</span> <span class="skolem">m'</span> <span class="main">=</span> Some <span class="skolem">j'</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"rank <span class="skolem">x</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rank_initial<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"rank <span class="skolem">x</span> <span class="skolem">m</span> <span class="main">=</span> Some <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rank_continuous<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹rank <span class="skolem">x</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="skolem">k</span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">m'</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">m'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">m</span>›</span></span> diff_le_mono le_add_diff_inverse<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> <span class="free">i</span><span class="main">.</span> rank <span class="skolem">x</span> <span class="skolem">m</span> <span class="main">=</span> Some <span class="bound">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> rank_monotonic <span class="quoted"><span class="quoted">‹rank <span class="skolem">x</span> <span class="skolem">m'</span> <span class="main">=</span> Some <span class="skolem">j'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j'</span> <span class="main">≥</span> <span class="free">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">≤</span> <span class="skolem">m'</span>›</span></span><span class="main">[</span><span class="operator">THEN</span> le_Suc_ex<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> le_Suc_ex trans_le_add1<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>token_succeeds <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span><span class="main">.</span> token_run <span class="skolem">x</span> <span class="bound">m</span> <span class="main">∉</span> <span class="free">F</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> token_succeeds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> <span class="free">i</span><span class="main">.</span> rank <span class="skolem">x</span> <span class="skolem">m</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"token_squats <span class="skolem">x</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
          <span class="comment1">― ‹The token already stabilised›</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">n<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span>token_succeeds <span class="skolem">x</span>›</span></span> n<span class="hidden">⇩</span><sub>1</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> not_le<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">m'</span></span> <span class="main">≥</span> <span class="skolem">n</span><span class="main">.</span> rank <span class="skolem">x</span> <span class="bound">m'</span> <span class="main">=</span> Some <span class="skolem">k</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Stable<span class="main">[</span><span class="operator">OF</span> _ True<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"stable_rank <span class="skolem">x</span> <span class="skolem">k</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> stable_rank_def MOST_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∉</span> <span class="free">F</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">m</span><span class="main">.</span> token_run <span class="skolem">x</span> <span class="bound">m</span> <span class="main">∉</span> <span class="free">F</span>›</span></span> initial_in_F_token_run<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span>
          <span class="comment1">― ‹Hence the rank is smaller than i›</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"rank <span class="skolem">x</span> <span class="skolem">m</span> <span class="main">=</span> Some <span class="skolem">k</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> stable_rank_bounded <span class="quoted"><span class="quoted">‹infinite <span class="main">(</span>succeed <span class="free">i</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">≤</span> <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
          <span class="comment1">― ‹Then token is already in a sink›</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sink <span class="main">(</span>token_run <span class="skolem">x</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="main">(</span>token_run <span class="skolem">x</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> <span class="skolem">m'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sink <span class="main">(</span>token_run <span class="skolem">x</span> <span class="skolem">m'</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False token_squats_def le_add2 not_le not_less_eq_eq token_stays_in_sink<span class="main">)</span>
            <span class="keyword1"><span class="command">ultimately</span></span>
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≤</span> <span class="skolem">m''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="main">(</span>token_run <span class="skolem">x</span> <span class="skolem">m''</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sink <span class="main">(</span>token_run <span class="skolem">x</span> <span class="main">(</span>Suc <span class="skolem">m''</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_add1 less_imp_Suc_add token_run_P<span class="main">)</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Fail <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">m</span><span class="main">.</span> token_run <span class="skolem">x</span> <span class="bound">m</span> <span class="main">∉</span> <span class="free">F</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">≤</span> <span class="skolem">m</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">m</span>›</span></span> le_trans<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="comment1">― ‹Hence there is no rank›</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> <span class="free">i</span><span class="main">.</span> rank <span class="skolem">x</span> <span class="skolem">m</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">)</span> <span class="main">∧</span> token_run <span class="skolem">x</span> <span class="skolem">m</span> <span class="main">∉</span> <span class="free">F</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> <span class="free">i</span><span class="main">.</span> rank <span class="skolem">x</span> <span class="skolem">m</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">)</span> <span class="main">∨</span> token_run <span class="skolem">x</span> <span class="skolem">m</span> <span class="main">∈</span> <span class="free">F</span> <span class="main">⟷</span> token_succeeds <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"token_succeeds <span class="skolem">x</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="comment1">― ‹By definition of n all tokens <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> <span class="skolem">n</span>"</span><span class="antiquote">}</span></span> succeed›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">m</span> <span class="main">≥</span> <span class="skolem">n</span> <span class="main">⟹</span> <span class="main">¬</span><span class="bound">x</span> <span class="main">≤</span> <span class="bound">m</span> <span class="main">⟹</span> token_succeeds <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> n_def n<span class="hidden">⇩</span><sub>1</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> MOST_nat_le not_le<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Mojmir-succeeding_states"><span class="command">lemma</span></span> succeeding_states<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"smallest_accepting_rank <span class="main">=</span> Some <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">n</span><span class="main">.</span> <span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> configuration <span class="bound">q</span> <span class="bound">n</span><span class="main">.</span> token_succeeds <span class="bound">x</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">q</span> <span class="main">∈</span> 𝒮 <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">q</span> <span class="main">∈</span> 𝒮 <span class="bound">n</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> configuration <span class="bound">q</span> <span class="bound">n</span><span class="main">.</span> token_succeeds <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">m</span> <span class="main">≥</span> <span class="skolem">n</span> <span class="main">⟹</span> token_succeeds <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="bound">x</span> <span class="main">&gt;</span> <span class="bound">m</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> <span class="free">i</span><span class="main">.</span> rank <span class="bound">x</span> <span class="bound">m</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">)</span> <span class="main">∨</span> token_run <span class="bound">x</span> <span class="bound">m</span> <span class="main">∈</span> <span class="free">F</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> token_smallest_accepting_rank<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> MOST_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> <span class="skolem">q</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≥</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∉</span> <span class="free">F</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> configuration <span class="skolem">q</span> <span class="skolem">m</span><span class="main">.</span> token_succeeds <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">x</span> <span class="skolem">m</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"token_succeeds <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> <span class="free">i</span><span class="main">.</span> rank <span class="skolem">x</span> <span class="skolem">m</span> <span class="main">=</span> Some <span class="bound">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> <span class="free">i</span><span class="main">.</span> state_rank <span class="skolem">q</span> <span class="skolem">m</span> <span class="main">=</span> Some <span class="bound">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rank_eq_state_rank <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">m</span>›</span></span> <span class="quoted"><span class="quoted">‹token_run <span class="skolem">x</span> <span class="skolem">m</span> <span class="main">=</span> <span class="skolem">q</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> <span class="skolem">q</span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≥</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> configuration <span class="skolem">q</span> <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">x</span> <span class="skolem">m</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> 𝒮 <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> <span class="free">i</span><span class="main">.</span> state_rank <span class="skolem">q</span> <span class="skolem">m</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">q</span> <span class="main">∈</span> <span class="free">F</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> <span class="free">i</span><span class="main">.</span> rank <span class="skolem">x</span> <span class="skolem">m</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">q</span> <span class="main">∈</span> <span class="free">F</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rank_eq_state_rank <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"token_succeeds <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> n_def<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">m</span> <span class="main">≥</span> <span class="skolem">n</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹token_run <span class="skolem">x</span> <span class="skolem">m</span> <span class="main">=</span> <span class="skolem">q</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> MOST_nat_le 𝒮.simps assms option.sel <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Rabin">
<div class="head">
<h1>Theory Rabin</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Author:      Salomon Sickert
    License:     BSD
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹(Generalized) Rabin Automata›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Rabin
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <a href="DTS.html">DTS</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rabin_pair <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> transition set <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> transition set<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> generalized_rabin_pair <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> transition set <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> transition set set<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rabin_condition <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rabin_pair set"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> generalized_rabin_condition <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> generalized_rabin_pair set"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rabin_automaton <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> DTS <span class="main">×</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rabin_condition"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> generalized_rabin_automaton <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> DTS <span class="main">×</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> generalized_rabin_condition"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">accepting_pair<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> DTS <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rabin_pair <span class="main">⇒</span> <span class="tfree">'b</span> word <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">accepting_pair<span class="hidden">⇩</span><sub>R</sub></span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> limit <span class="main">(</span>run<span class="hidden">⇩</span><sub>t</sub> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span> <span class="main">∩</span> fst <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> limit <span class="main">(</span>run<span class="hidden">⇩</span><sub>t</sub> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span> <span class="main">∩</span> snd <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">accept<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rabin_automaton <span class="main">⇒</span> <span class="tfree">'b</span> word <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">accept<span class="hidden">⇩</span><sub>R</sub></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∃</span><span class="bound">P</span> <span class="main">∈</span> <span class="main">(</span>snd <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">.</span> accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">P</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> DTS <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> generalized_rabin_pair <span class="main">⇒</span> <span class="tfree">'b</span> word <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> limit <span class="main">(</span>run<span class="hidden">⇩</span><sub>t</sub> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span> <span class="main">∩</span> fst <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">I</span> <span class="main">∈</span> snd <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">.</span> limit <span class="main">(</span>run<span class="hidden">⇩</span><sub>t</sub> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span> <span class="main">∩</span> <span class="bound">I</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> generalized_rabin_automaton <span class="main">⇒</span> <span class="tfree">'b</span> word <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">Fin</span><span class="main">,</span> <span class="bound">Inf</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>snd <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">.</span> accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">Fin</span><span class="main">,</span> <span class="bound">Inf</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> accepting_pair<span class="hidden">⇩</span><sub>R</sub>_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_def<span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1" id="Rabin-accepting_pair"><span class="command">lemma</span></span> accepting_pair<span class="hidden">⇩</span><sub>R</sub>_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="free">F</span><span class="main">,</span><span class="free">I</span><span class="main">)</span> <span class="free">w</span> <span class="main">≡</span> limit <span class="main">(</span>run<span class="hidden">⇩</span><sub>t</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">w</span><span class="main">)</span> <span class="main">∩</span> <span class="free">F</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> limit <span class="main">(</span>run<span class="hidden">⇩</span><sub>t</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">w</span><span class="main">)</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Rabin-accepting_pair"><span class="command">lemma</span></span> accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="free">F</span><span class="main">,</span> <span class="free">ℐ</span><span class="main">)</span> <span class="free">w</span> <span class="main">≡</span> limit <span class="main">(</span>run<span class="hidden">⇩</span><sub>t</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">w</span><span class="main">)</span> <span class="main">∩</span> <span class="free">F</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">I</span> <span class="main">∈</span> <span class="free">ℐ</span><span class="main">.</span> limit <span class="main">(</span>run<span class="hidden">⇩</span><sub>t</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">w</span><span class="main">)</span> <span class="main">∩</span> <span class="bound">I</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Rabin-accept"><span class="command">lemma</span></span> accept<span class="hidden">⇩</span><sub>R</sub>_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"accept<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span><span class="free">δ</span><span class="main">,</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">α</span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">Fin</span><span class="main">,</span> <span class="bound">Inf</span><span class="main">)</span> <span class="main">∈</span> <span class="free">α</span><span class="main">.</span> limit <span class="main">(</span>run<span class="hidden">⇩</span><sub>t</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">w</span><span class="main">)</span> <span class="main">∩</span> <span class="bound">Fin</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> limit <span class="main">(</span>run<span class="hidden">⇩</span><sub>t</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">w</span><span class="main">)</span> <span class="main">∩</span> <span class="bound">Inf</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> accept<span class="hidden">⇩</span><sub>R</sub>_def accepting_pair<span class="hidden">⇩</span><sub>R</sub>_def case_prod_unfold fst_conv snd_conv<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span><span class="main">)</span>

<span class="keyword1" id="Rabin-accept"><span class="command">lemma</span></span> accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span><span class="free">δ</span><span class="main">,</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">α</span><span class="main">)</span> <span class="free">w</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">Fin</span><span class="main">,</span> <span class="bound">Inf</span><span class="main">)</span> <span class="main">∈</span> <span class="free">α</span><span class="main">.</span> limit <span class="main">(</span>run<span class="hidden">⇩</span><sub>t</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">w</span><span class="main">)</span> <span class="main">∩</span> <span class="bound">Fin</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">I</span> <span class="main">∈</span> <span class="bound">Inf</span><span class="main">.</span> limit <span class="main">(</span>run<span class="hidden">⇩</span><sub>t</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">w</span><span class="main">)</span> <span class="main">∩</span> <span class="bound">I</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_def accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_def case_prod_unfold fst_conv snd_conv<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span><span class="main">)</span>

<span class="keyword1" id="Rabin-accept"><span class="command">lemma</span></span> accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_simp2<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span><span class="free">δ</span><span class="main">,</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">α</span><span class="main">)</span> <span class="free">w</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">P</span> <span class="main">∈</span> <span class="free">α</span><span class="main">.</span> accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">P</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_def accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_def case_prod_unfold fst_conv snd_conv<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span><span class="main">)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> LTS <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> transition set"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">LTS_is_inf_run</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'q</span><span class="main">,</span><span class="tfree">'a</span><span class="main">)</span> LTS <span class="main">⇒</span> <span class="tfree">'a</span> word <span class="main">⇒</span> <span class="tfree">'q</span> word <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">LTS_is_inf_run</span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">i</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="bound">i</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">Δ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">accept<span class="hidden">⇩</span><sub>R</sub>_LTS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> LTS <span class="main">×</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rabin_condition<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> word <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">accept<span class="hidden">⇩</span><sub>R</sub>_LTS</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">Fin</span><span class="main">,</span> <span class="bound">Inf</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">.</span> <span class="main">∃</span><span class="bound">r</span><span class="main">.</span> 
      LTS_is_inf_run <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="bound">r</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">0</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span> 
    <span class="main">∧</span> limit <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span> <span class="bound">i</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="bound">i</span><span class="main">,</span> <span class="bound">r</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="bound">Fin</span> <span class="main">=</span> <span class="main">{}</span> 
    <span class="main">∧</span> limit <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span> <span class="bound">i</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="bound">i</span><span class="main">,</span> <span class="bound">r</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="bound">Inf</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_LTS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> LTS <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> generalized_rabin_pair <span class="main">⇒</span> <span class="tfree">'b</span> word <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_LTS</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">r</span><span class="main">.</span> LTS_is_inf_run <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="bound">r</span> <span class="main">∧</span> <span class="bound">r</span> <span class="main">0</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span> 
    <span class="main">∧</span> limit <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span> <span class="bound">i</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="bound">i</span><span class="main">,</span> <span class="bound">r</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> fst <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">{}</span> 
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">I</span> <span class="main">∈</span> snd <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">.</span> limit <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span> <span class="bound">i</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="bound">i</span><span class="main">,</span> <span class="bound">r</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="bound">I</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_LTS</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> LTS <span class="main">×</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> generalized_rabin_condition<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> word <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_LTS</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">Fin</span><span class="main">,</span> <span class="bound">Inf</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">.</span> accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_LTS <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">(</span><span class="bound">Fin</span><span class="main">,</span> <span class="bound">Inf</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Rabin-accept"><span class="command">lemma</span></span> accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_LTS_E<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_LTS <span class="free">R</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">F</span> <span class="free">I</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">F</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="main">∈</span> snd <span class="main">(</span>snd <span class="free">R</span><span class="main">)</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_LTS <span class="main">(</span>fst <span class="free">R</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>snd <span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">F</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">δ</span></span> <span class="skolem"><span class="skolem">q<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">α</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">δ</span><span class="main">,</span> <span class="skolem">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">α</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prod_cases3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">F</span> <span class="bound">I</span><span class="main">.</span> <span class="main">(</span><span class="bound">F</span><span class="main">,</span> <span class="bound">I</span><span class="main">)</span> <span class="main">∈</span> snd <span class="main">(</span>snd <span class="free">R</span><span class="main">)</span> <span class="main">⟹</span> accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_LTS <span class="main">(</span>fst <span class="free">R</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>snd <span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">F</span><span class="main">,</span> <span class="bound">I</span><span class="main">)</span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">thesis</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">thesis</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="free">R</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">δ</span><span class="main">,</span> <span class="skolem">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">α</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Rabin-accept"><span class="command">lemma</span></span> accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_LTS_I<span class="main">:</span>
  <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_LTS <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="free">F</span><span class="main">,</span> <span class="free">ℐ</span><span class="main">)</span> <span class="free">w</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">F</span><span class="main">,</span> <span class="free">ℐ</span><span class="main">)</span> <span class="main">∈</span> <span class="free">α</span> <span class="main">⟹</span> accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_LTS <span class="main">(</span><span class="free">δ</span><span class="main">,</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">α</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Rabin-accept"><span class="command">lemma</span></span> accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_I<span class="main">:</span>
  <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="free">F</span><span class="main">,</span> <span class="free">ℐ</span><span class="main">)</span> <span class="free">w</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">F</span><span class="main">,</span> <span class="free">ℐ</span><span class="main">)</span> <span class="main">∈</span> <span class="free">α</span> <span class="main">⟹</span> accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span><span class="free">δ</span><span class="main">,</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">α</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Rabin-transfer_accept"><span class="command">lemma</span></span> transfer_accept<span class="main">:</span>
  <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="free">F</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="free">w</span> <span class="main">⟷</span> accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="free">F</span><span class="main">,</span> <span class="main">{</span><span class="free">I</span><span class="main">}</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="quoted"><span class="quoted">"accept<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span><span class="free">δ</span><span class="main">,</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">α</span><span class="main">)</span> <span class="free">w</span> <span class="main">⟷</span> accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span><span class="free">δ</span><span class="main">,</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">F</span><span class="main">,</span> <span class="bound">I</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">F</span><span class="main">,</span> <span class="main">{</span><span class="bound">I</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free">α</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_unfold<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Restriction Lemmas›</span></span>

<span class="keyword1" id="Rabin-accepting_pair"><span class="command">lemma</span></span> accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_restrict<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"range <span class="free">w</span> <span class="main">⊆</span> <span class="free">Σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="free">F</span><span class="main">,</span> <span class="free">ℐ</span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span> accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="free">F</span> <span class="main">∩</span> reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="main">(</span><span class="main">λ</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="main">∩</span> reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">`</span> <span class="free">ℐ</span><span class="main">)</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"limit <span class="main">(</span>run<span class="hidden">⇩</span><sub>t</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">w</span><span class="main">)</span> <span class="main">∩</span> <span class="free">F</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> limit <span class="main">(</span>run<span class="hidden">⇩</span><sub>t</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">w</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free">F</span> <span class="main">∩</span> reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">[</span><span class="operator">THEN</span> limit_subseteq_reach<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">δ</span></span> <span class="quoted"><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">I</span><span class="main">∈</span><span class="free">ℐ</span><span class="main">.</span> limit <span class="main">(</span>run<span class="hidden">⇩</span><sub>t</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">w</span><span class="main">)</span> <span class="main">∩</span> <span class="bound">I</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">I</span><span class="main">∈</span><span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="free">ℐ</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">∩</span> reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span><span class="main">.</span> limit <span class="main">(</span>run<span class="hidden">⇩</span><sub>t</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">w</span><span class="main">)</span> <span class="main">∩</span> <span class="bound">I</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> assms<span class="main">[</span><span class="operator">THEN</span> limit_subseteq_reach<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">δ</span></span> <span class="quoted"><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_simp image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Rabin-accept"><span class="command">lemma</span></span> accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_restrict<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"range <span class="free">w</span> <span class="main">⊆</span> <span class="free">Σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span><span class="free">δ</span><span class="main">,</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="main">{</span><span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span> accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span><span class="free">δ</span><span class="main">,</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="main">{</span><span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="main">∩</span> reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="main">(</span><span class="main">λ</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="main">∩</span> reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">`</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_simp<span class="main">)</span>  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_restrict<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> imageE<span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Rabin-accepting_pair"><span class="command">lemma</span></span> accepting_pair<span class="hidden">⇩</span><sub>R</sub>_restrict<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"range <span class="free">w</span> <span class="main">⊆</span> <span class="free">Σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="free">F</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span> accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="free">F</span> <span class="main">∩</span> reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">I</span> <span class="main">∩</span> reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> transfer_accept<span class="main"><span class="keyword3">;</span></span> <span class="operator">subst</span> accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_restrict<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Rabin-accept"><span class="command">lemma</span></span> accept<span class="hidden">⇩</span><sub>R</sub>_restrict<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"range <span class="free">w</span> <span class="main">⊆</span> <span class="free">Σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"accept<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span><span class="free">δ</span><span class="main">,</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="main">{</span><span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span> accept<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span><span class="free">δ</span><span class="main">,</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="main">{</span><span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="main">∩</span> reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">∩</span> reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> accept<span class="hidden">⇩</span><sub>R</sub>_simp<span class="main"><span class="keyword3">;</span></span> <span class="operator">subst</span> accepting_pair<span class="hidden">⇩</span><sub>R</sub>_restrict<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Abstraction Lemmas›</span></span>

<span class="keyword1" id="Rabin-accepting_pair"><span class="command">lemma</span></span> accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_abstract<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="free">δ'</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"range <span class="free">w</span> <span class="main">⊆</span> <span class="free">Σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"run<span class="hidden">⇩</span><sub>t</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">w</span> <span class="main">=</span> <span class="free">f</span> <span class="keyword1">o</span> <span class="main">(</span>run<span class="hidden">⇩</span><sub>t</sub> <span class="free">δ'</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="free">δ'</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">F</span> <span class="main">⟷</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">F'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">ℐ</span> <span class="main">⟹</span> <span class="bound">t</span> <span class="main">∈</span> reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="free">δ'</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">I</span> <span class="bound">i</span> <span class="main">⟷</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">I'</span> <span class="bound">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="free">F</span><span class="main">,</span> <span class="main">{</span><span class="free">I</span> <span class="bound">i</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">ℐ</span><span class="main">}</span><span class="main">)</span> <span class="free">w</span> <span class="main">⟷</span> accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub> <span class="free">δ'</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">(</span><span class="free">F'</span><span class="main">,</span> <span class="main">{</span><span class="free">I'</span> <span class="bound">i</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">ℐ</span><span class="main">}</span><span class="main">)</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="main">(</span>run<span class="hidden">⇩</span><sub>t</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">w</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">(</span>range <span class="var">?r</span><span class="main">)</span>"</span></span><span class="main">)</span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="main">(</span>run<span class="hidden">⇩</span><sub>t</sub> <span class="free">δ'</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">(</span>range <span class="var">?r'</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">)</span> run_subseteq_reach<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_subset<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"limit <span class="var">?r</span> <span class="main">=</span> range <span class="main">(</span>suffix <span class="skolem">k</span> <span class="var">?r</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"limit <span class="var">?r'</span> <span class="main">=</span> range <span class="main">(</span>suffix <span class="skolem">k</span> <span class="var">?r'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> common_range_limit <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"limit <span class="main">(</span>run<span class="hidden">⇩</span><sub>t</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">`</span> limit <span class="main">(</span>run<span class="hidden">⇩</span><sub>t</sub> <span class="free">δ'</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="free">w</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> 1 2 suffix_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>limit <span class="var">?r</span> <span class="main">∩</span> <span class="free">F</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>limit <span class="var">?r'</span> <span class="main">∩</span> <span class="free">F'</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">ℐ</span><span class="main">.</span> limit <span class="var">?r</span> <span class="main">∩</span> <span class="free">I</span> <span class="bound">i</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">ℐ</span><span class="main">.</span> limit <span class="var">?r'</span> <span class="main">∩</span> <span class="free">I'</span> <span class="bound">i</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">,</span>6<span class="main">)</span> limit_subseteq_reach<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> X<span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_simp <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Rabin-accepting_pair"><span class="command">lemma</span></span> accepting_pair<span class="hidden">⇩</span><sub>R</sub>_abstract<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="free">δ'</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"range <span class="free">w</span> <span class="main">⊆</span> <span class="free">Σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"run<span class="hidden">⇩</span><sub>t</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">w</span>  <span class="main">=</span> <span class="free">f</span> <span class="keyword1">o</span> <span class="main">(</span>run<span class="hidden">⇩</span><sub>t</sub> <span class="free">δ'</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="free">δ'</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">F</span> <span class="main">⟷</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">F'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="free">δ'</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟷</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">I'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="free">F</span><span class="main">,</span> <span class="free">I</span><span class="main">)</span> <span class="free">w</span> <span class="main">⟷</span> accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="free">δ'</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">(</span><span class="free">F'</span><span class="main">,</span> <span class="free">I'</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_abstract<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-5<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted">UNIV</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">I'</span>"</span></span><span class="main">]</span> assms<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹LTS Lemmas›</span></span>

<span class="keyword1" id="Rabin-accepting_pair"><span class="command">lemma</span></span> accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_LTS<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"range <span class="free">w</span> <span class="main">⊆</span> <span class="free">Σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="free">F</span><span class="main">,</span> <span class="free">ℐ</span><span class="main">)</span> <span class="free">w</span> <span class="main">⟷</span> accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_LTS <span class="main">(</span>reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="free">F</span><span class="main">,</span> <span class="free">ℐ</span><span class="main">)</span> <span class="free">w</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LTS_is_inf_run <span class="main">(</span>reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">w</span> <span class="main">(</span>run <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">w</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> LTS_is_inf_run_def reach<span class="hidden">⇩</span><sub>t</sub>_def <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"run <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">w</span> <span class="main">0</span> <span class="main">=</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_simp accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_LTS.simps accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_simp run<span class="hidden">⇩</span><sub>t</sub>.simps limit_def accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_LTS_def snd_conv fst_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"LTS_is_inf_run <span class="main">(</span>reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">w</span> <span class="skolem">r</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">0</span> <span class="main">=</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"limit <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="skolem">r</span> <span class="bound">i</span><span class="main">,</span> <span class="free">w</span> <span class="bound">i</span><span class="main">,</span> <span class="skolem">r</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="free">F</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="main">∈</span> <span class="free">ℐ</span> <span class="main">⟹</span> limit <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="skolem">r</span> <span class="bound">i</span><span class="main">,</span> <span class="free">w</span> <span class="bound">i</span><span class="main">,</span> <span class="skolem">r</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="bound">I</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_LTS_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">0</span> <span class="main">=</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹LTS_is_inf_run <span class="main">(</span>reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">w</span> <span class="skolem">r</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="skolem">i</span> <span class="main">=</span> run <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">w</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">i</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LTS_is_inf_run_def reach<span class="hidden">⇩</span><sub>t</sub>_def<span class="main">)</span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> run <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="skolem">r</span> <span class="bound">i</span><span class="main">,</span> <span class="free">w</span> <span class="bound">i</span><span class="main">,</span> <span class="skolem">r</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> run<span class="hidden">⇩</span><sub>t</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Rabin-accept"><span class="command">lemma</span></span> accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_LTS<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"range <span class="free">w</span> <span class="main">⊆</span> <span class="free">Σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span><span class="free">δ</span><span class="main">,</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">α</span><span class="main">)</span> <span class="free">w</span> <span class="main">⟷</span> accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_LTS <span class="main">(</span>reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">α</span><span class="main">)</span> <span class="free">w</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_def fst_conv snd_conv accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_LTS<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Rabin-accept"><span class="command">lemma</span></span> accept<span class="hidden">⇩</span><sub>R</sub>_LTS<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"range <span class="free">w</span> <span class="main">⊆</span> <span class="free">Σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"accept<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span><span class="free">δ</span><span class="main">,</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">α</span><span class="main">)</span> <span class="free">w</span> <span class="main">⟷</span> accept<span class="hidden">⇩</span><sub>R</sub>_LTS <span class="main">(</span>reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">α</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> transfer_accept accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_LTS.simps accept<span class="hidden">⇩</span><sub>R</sub>_LTS.simps accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_LTS<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> case_prod_unfold accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_LTS_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Combination Lemmas›</span></span>

<span class="keyword1" id="Rabin-combine_rabin_pairs"><span class="command">lemma</span></span> combine_rabin_pairs<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span> <span class="main">⟹</span> accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="main">⋃</span><span class="main">{</span><span class="free">f</span> <span class="bound">x</span> <span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">I</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="free">g</span> <span class="bound">x</span> <span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">I</span><span class="main">}</span><span class="main">)</span> <span class="free">w</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Rabin-combine_rabin_pairs_UNIV"><span class="command">lemma</span></span> combine_rabin_pairs_UNIV<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="free">fin</span><span class="main">,</span> UNIV<span class="main">)</span> <span class="free">w</span> <span class="main">⟹</span> accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="free">fin'</span><span class="main">,</span> <span class="free">inf'</span><span class="main">)</span> <span class="free">w</span> <span class="main">⟹</span> accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="free">fin</span> <span class="main">∪</span> <span class="free">fin'</span><span class="main">,</span> <span class="free">inf'</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="List2">
<div class="head">
<h1>Theory List2</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Author:      Salomon Sickert
    License:     BSD
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary List Facts›</span></span>

<span class="keyword1"><span class="command">theory</span></span> List2                  
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <span class="quoted">"<a href="../../HOL/HOL-Library/Omega_Words_Fun.html">HOL-Library.Omega_Words_Fun</a>"</span> <span class="quoted">"<a href="../List-Index/List_Index.html">List-Index.List_Index</a>"</span> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹remdups\_fwd›</span></span>
<span class="comment1">― ‹Remove duplicates of a list in a forward moving direction›</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">remdups_fwd_acc</span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">remdups_fwd_acc</span> <span class="free"><span class="bound"><span class="entity">Acc</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">remdups_fwd_acc</span> <span class="free"><span class="bound"><span class="entity">Acc</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">Acc</span></span></span> <span class="keyword1">then</span> <span class="main">[]</span> <span class="keyword1">else</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="free">remdups_fwd_acc</span> <span class="main">(</span>insert <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">Acc</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1" id="List2-remdups_fwd_acc_append"><span class="command">lemma</span></span> remdups_fwd_acc_append<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"remdups_fwd_acc <span class="free">Acc</span> <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>remdups_fwd_acc <span class="free">Acc</span> <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>remdups_fwd_acc <span class="main">(</span><span class="free">Acc</span> <span class="main">∪</span> set <span class="free">xs</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Acc</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="List2-remdups_fwd_acc_set"><span class="command">lemma</span></span> remdups_fwd_acc_set<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>remdups_fwd_acc <span class="free">Acc</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span> <span class="main">-</span> <span class="free">Acc</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Acc</span></span><span class="main">)</span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="List2-remdups_fwd_acc_distinct"><span class="command">lemma</span></span> remdups_fwd_acc_distinct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>remdups_fwd_acc <span class="free">Acc</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Acc</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="List2-remdups_fwd_acc_empty"><span class="command">lemma</span></span> remdups_fwd_acc_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">Acc</span> <span class="main">⟷</span> remdups_fwd_acc <span class="free">Acc</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> remdups_fwd_acc_set set_empty Diff_eq_empty_iff Diff_eq_empty_iff<span class="main">)</span>

<span class="keyword1" id="List2-remdups_fwd_acc_drop"><span class="command">lemma</span></span> remdups_fwd_acc_drop<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="free">ys</span> <span class="main">⊆</span> <span class="free">Acc</span> <span class="main">∪</span> set <span class="free">xs</span> <span class="main">⟹</span> remdups_fwd_acc <span class="free">Acc</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span> <span class="main">=</span> remdups_fwd_acc <span class="free">Acc</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remdups_fwd_acc_empty sup.absorb1<span class="main">)</span>

<span class="keyword1" id="List2-remdups_fwd_acc_filter"><span class="command">lemma</span></span> remdups_fwd_acc_filter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"remdups_fwd_acc <span class="free">Acc</span> <span class="main">(</span>filter <span class="free">P</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> filter <span class="free">P</span> <span class="main">(</span>remdups_fwd_acc <span class="free">Acc</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">remdups_fwd</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">remdups_fwd</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> remdups_fwd_acc <span class="main">{}</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> "</span></span>

<span class="keyword1" id="List2-remdups_fwd_eq"><span class="command">lemma</span></span> remdups_fwd_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"remdups_fwd <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span>rev <span class="keyword1">o</span> remdups <span class="keyword1">o</span> rev<span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="List2-remdups_fwd_set"><span class="command">lemma</span></span> remdups_fwd_set<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>remdups_fwd <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="List2-remdups_fwd_distinct"><span class="command">lemma</span></span> remdups_fwd_distinct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>remdups_fwd <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> remdups_fwd_acc_distinct <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="List2-remdups_fwd_filter"><span class="command">lemma</span></span> remdups_fwd_filter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"remdups_fwd <span class="main">(</span>filter <span class="free">P</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> filter <span class="free">P</span> <span class="main">(</span>remdups_fwd <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> remdups_fwd_acc_filter <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Split Lemmas›</span></span>

<span class="keyword1" id="List2-map_splitE"><span class="command">lemma</span></span> map_splitE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">@</span> <span class="free">zs</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">us</span> <span class="free">vs</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">us</span> <span class="main">@</span> <span class="free">vs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="free">us</span> <span class="main">=</span> <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="free">vs</span> <span class="main">=</span> <span class="free">zs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">;</span></span> <span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> 
     <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_eq_Cons_conv<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> append_Cons<span class="main">)</span> 
  
<span class="keyword1" id="List2-filter_split'"><span class="command">lemma</span></span> filter_split'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"filter <span class="free">P</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">@</span> <span class="free">zs</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">us</span> <span class="bound">vs</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">us</span> <span class="main">@</span> <span class="bound">vs</span> <span class="main">∧</span> filter <span class="free">P</span> <span class="bound">us</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">∧</span> filter <span class="free">P</span> <span class="bound">vs</span> <span class="main">=</span> <span class="free">zs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">zs</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">us</span></span> <span class="skolem"><span class="skolem">vs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">us</span> <span class="main">@</span> <span class="skolem">vs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"filter <span class="free">P</span> <span class="skolem">us</span> <span class="main">=</span> <span class="skolem">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"filter <span class="free">P</span> <span class="skolem">vs</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">zs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> snoc<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> append_assoc<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">vs'</span></span> <span class="skolem"><span class="skolem">vs''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> <span class="skolem">vs'</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">vs''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∉</span> set <span class="skolem">vs'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">∈</span>set <span class="skolem">vs'</span><span class="main">.</span> <span class="main">¬</span> <span class="free">P</span> <span class="bound">u</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"filter <span class="free">P</span> <span class="skolem">vs''</span> <span class="main">=</span> <span class="skolem">zs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> filter_eq_Cons_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">us</span> <span class="main">@</span> <span class="skolem">vs'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">vs''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"filter <span class="free">P</span> <span class="main">(</span><span class="skolem">us</span> <span class="main">@</span> <span class="skolem">vs'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"filter <span class="free">P</span> <span class="main">(</span><span class="skolem">vs''</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">zs</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> filter_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="List2-filter_splitE"><span class="command">lemma</span></span> filter_splitE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"filter <span class="free">P</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">@</span> <span class="free">zs</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">us</span> <span class="free">vs</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">us</span> <span class="main">@</span> <span class="free">vs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"filter <span class="free">P</span> <span class="free">us</span> <span class="main">=</span> <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"filter <span class="free">P</span> <span class="free">vs</span> <span class="main">=</span> <span class="free">zs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> filter_split'<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="List2-filter_map_splitE"><span class="command">lemma</span></span> filter_map_splitE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"filter <span class="free">P</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">@</span> <span class="free">zs</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">us</span> <span class="free">vs</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">us</span> <span class="main">@</span> <span class="free">vs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"filter <span class="free">P</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">us</span><span class="main">)</span> <span class="main">=</span> <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"filter <span class="free">P</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">vs</span><span class="main">)</span> <span class="main">=</span> <span class="free">zs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> filter_splitE map_splitE<span class="main">)</span>

<span class="keyword1" id="List2-filter_map_split_iff"><span class="command">lemma</span></span> filter_map_split_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"filter <span class="free">P</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">@</span> <span class="free">zs</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">us</span> <span class="bound">vs</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">us</span> <span class="main">@</span> <span class="bound">vs</span> <span class="main">∧</span> filter <span class="free">P</span> <span class="main">(</span>map <span class="free">f</span> <span class="bound">us</span><span class="main">)</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">∧</span> filter <span class="free">P</span> <span class="main">(</span>map <span class="free">f</span> <span class="bound">vs</span><span class="main">)</span> <span class="main">=</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> filter_map_splitE<span class="main">)</span>

<span class="keyword1" id="List2-list_empty_prefix"><span class="command">lemma</span></span> list_empty_prefix<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">zs</span> <span class="main">=</span> <span class="free">y</span> <span class="main">#</span> <span class="free">us</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∉</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> hd_append2 list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.set_sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="List2-remdups_fwd_split"><span class="command">lemma</span></span> remdups_fwd_split<span class="main">:</span>
  <span class="quoted"><span class="quoted">"remdups_fwd_acc <span class="free">Acc</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">@</span> <span class="free">zs</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">us</span> <span class="bound">vs</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">us</span> <span class="main">@</span> <span class="bound">vs</span> <span class="main">∧</span> remdups_fwd_acc <span class="free">Acc</span> <span class="bound">us</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">∧</span> remdups_fwd_acc <span class="main">(</span><span class="free">Acc</span> <span class="main">∪</span> set <span class="free">ys</span><span class="main">)</span> <span class="bound">vs</span> <span class="main">=</span> <span class="free">zs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">zs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">us</span></span> <span class="skolem"><span class="skolem">vs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="skolem">us</span> <span class="main">@</span> <span class="skolem">vs</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"remdups_fwd_acc <span class="free">Acc</span> <span class="skolem">us</span> <span class="main">=</span> <span class="skolem">ys</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"remdups_fwd_acc <span class="main">(</span><span class="free">Acc</span> <span class="main">∪</span> set <span class="skolem">ys</span><span class="main">)</span> <span class="skolem">vs</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">zs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set <span class="skolem">vs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∉</span> <span class="free">Acc</span> <span class="main">∪</span> set <span class="skolem">ys</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> remdups_fwd_acc_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">Acc</span> <span class="main">∪</span> set <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="skolem">vs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">vs'</span></span> <span class="skolem"><span class="skolem">vs''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> <span class="skolem">vs'</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">vs''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∉</span> set <span class="skolem">vs'</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> split_list_first <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"remdups_fwd_acc <span class="main">(</span><span class="free">Acc</span> <span class="main">∪</span> set <span class="skolem">ys</span><span class="main">)</span> <span class="skolem">vs'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹remdups_fwd_acc <span class="main">(</span><span class="free">Acc</span> <span class="main">∪</span> set <span class="skolem">ys</span><span class="main">)</span> <span class="skolem">vs</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">zs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">∉</span> <span class="free">Acc</span> <span class="main">∪</span> set <span class="skolem">ys</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> list_empty_prefix<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">us</span> <span class="main">@</span> <span class="skolem">vs'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">vs''</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"remdups_fwd_acc <span class="free">Acc</span> <span class="main">(</span><span class="skolem">us</span> <span class="main">@</span> <span class="skolem">vs'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"remdups_fwd_acc <span class="main">(</span><span class="free">Acc</span> <span class="main">∪</span> set <span class="main">(</span><span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="skolem">vs''</span> <span class="main">=</span> <span class="skolem">zs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remdups_fwd_acc_empty sup.absorb1<span class="main">)</span> 
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">force</span>

<span class="keyword1" id="List2-remdups_fwd_split_exact"><span class="command">lemma</span></span> remdups_fwd_split_exact<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"remdups_fwd_acc <span class="free">Acc</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">zs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">us</span> <span class="bound">vs</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">us</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">vs</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∉</span> <span class="free">Acc</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∉</span> set <span class="free">ys</span> <span class="main">∧</span> remdups_fwd_acc <span class="free">Acc</span> <span class="bound">us</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">∧</span> remdups_fwd_acc <span class="main">(</span><span class="free">Acc</span> <span class="main">∪</span> set <span class="free">ys</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="bound">vs</span> <span class="main">=</span> <span class="free">zs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">us</span></span> <span class="skolem"><span class="skolem">vs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="skolem">us</span> <span class="main">@</span> <span class="skolem">vs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"remdups_fwd_acc <span class="free">Acc</span> <span class="skolem">us</span> <span class="main">=</span> <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"remdups_fwd_acc <span class="main">(</span><span class="free">Acc</span> <span class="main">∪</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">vs</span> <span class="main">=</span> <span class="free">x</span> <span class="main">#</span> <span class="free">zs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> remdups_fwd_split<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="skolem">vs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">Acc</span> <span class="main">∪</span> set <span class="free">ys</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> remdups_fwd_acc_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">Acc</span> <span class="main">∪</span> set <span class="free">ys</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Diff_iff list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">vs'</span></span> <span class="skolem"><span class="skolem">vs''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> <span class="skolem">vs'</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">vs''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="skolem">vs'</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> split_list_first<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">vs'</span> <span class="main">⊆</span> <span class="free">Acc</span> <span class="main">∪</span> set <span class="free">ys</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹remdups_fwd_acc <span class="main">(</span><span class="free">Acc</span> <span class="main">∪</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">vs</span> <span class="main">=</span> <span class="free">x</span> <span class="main">#</span> <span class="free">zs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∉</span> <span class="free">Acc</span> <span class="main">∪</span> set <span class="free">ys</span>›</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> remdups_fwd_acc_empty <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> list_empty_prefix<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"remdups_fwd_acc <span class="main">(</span><span class="free">Acc</span> <span class="main">∪</span> set <span class="free">ys</span><span class="main">)</span> <span class="skolem">vs'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> remdups_fwd_acc_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">us</span> <span class="main">@</span> <span class="skolem">vs'</span><span class="main">)</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">vs''</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"remdups_fwd_acc <span class="free">Acc</span> <span class="main">(</span><span class="skolem">us</span> <span class="main">@</span> <span class="skolem">vs'</span><span class="main">)</span> <span class="main">=</span> <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"remdups_fwd_acc <span class="main">(</span><span class="free">Acc</span> <span class="main">∪</span> set <span class="free">ys</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="skolem">vs''</span> <span class="main">=</span> <span class="free">zs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sup.absorb1<span class="main">)</span><span class="main"><span class="keyword3">+</span></span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∉</span> <span class="free">Acc</span> <span class="main">∪</span> set <span class="free">ys</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="List2-remdups_fwd_split_exactE"><span class="command">lemma</span></span> remdups_fwd_split_exactE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"remdups_fwd_acc <span class="free">Acc</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">zs</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">us</span> <span class="free">vs</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="free">us</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">vs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="free">us</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"remdups_fwd_acc <span class="free">Acc</span> <span class="free">us</span> <span class="main">=</span> <span class="free">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"remdups_fwd_acc <span class="main">(</span><span class="free">Acc</span> <span class="main">∪</span> set <span class="free">ys</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="free">vs</span> <span class="main">=</span> <span class="free">zs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> remdups_fwd_split_exact<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="List2-remdups_fwd_split_exact_iff"><span class="command">lemma</span></span> remdups_fwd_split_exact_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"remdups_fwd_acc <span class="free">Acc</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">zs</span> <span class="main">⟷</span> 
    <span class="main">(</span><span class="main">∃</span><span class="bound">us</span> <span class="bound">vs</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">us</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">vs</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∉</span> <span class="free">Acc</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">∉</span> set <span class="bound">us</span> <span class="main">∧</span> remdups_fwd_acc <span class="free">Acc</span> <span class="bound">us</span> <span class="main">=</span> <span class="free">ys</span> <span class="main">∧</span> remdups_fwd_acc <span class="main">(</span><span class="free">Acc</span> <span class="main">∪</span> set <span class="free">ys</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="bound">vs</span> <span class="main">=</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> remdups_fwd_split_exact <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 

<span class="keyword1" id="List2-sorted_pre"><span class="command">lemma</span></span> sorted_pre<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">zs</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">]</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span> sorted <span class="free">zs</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">zs</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Nil append_Cons list.exhaust sorted1 sorted2<span class="main">)</span>

<span class="keyword1" id="List2-sorted_list"><span class="command">lemma</span></span> sorted_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xs'</span> <span class="bound">xs''</span> <span class="bound">xs'''</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">xs'</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">xs''</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="bound">xs'''</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="skolem">zs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> set <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> split_list_first<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map <span class="free">f</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹sorted <span class="main">(</span>map <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_append<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span>map <span class="free">f</span> <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="free">y</span> <span class="main">≤</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="free">y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="main">(</span><span class="free">y</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">x</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="free">xs</span> <span class="main">=</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="skolem">zs</span>›</span></span> set_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys'</span></span> <span class="skolem"><span class="skolem">zs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">ys'</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">zs'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> split_list_first<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword1" id="List2-takeWhile_foo"><span class="command">lemma</span></span> takeWhile_foo<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="free">ys</span> <span class="main">⟹</span> <span class="free">ys</span> <span class="main">=</span> takeWhile <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≠</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">ys</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> append_Nil2 takeWhile.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> takeWhile_append2<span class="main">)</span>

<span class="keyword1" id="List2-takeWhile_split"><span class="command">lemma</span></span> takeWhile_split<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> set <span class="main">(</span>takeWhile <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≠</span> <span class="free">x</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">xs'</span> <span class="bound">xs''</span> <span class="bound">xs'''</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">xs'</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="bound">xs''</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">xs'''</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> split_list_first <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons append_assoc takeWhile_foo<span class="main">)</span>
 
<span class="keyword1" id="List2-takeWhile_distinct"><span class="command">lemma</span></span> takeWhile_distinct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">xs'</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs''</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> set <span class="main">(</span>takeWhile <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≠</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">xs'</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs''</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">y</span> <span class="main">∈</span> set <span class="free">xs'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs'</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="List2-finite_lists_length_eqE"><span class="command">lemma</span></span> finite_lists_length_eqE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">=</span> <span class="free">A</span> <span class="main">∧</span> length <span class="bound">xs</span> <span class="main">=</span> <span class="free">n</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">=</span> <span class="free">A</span> <span class="main">∧</span> length <span class="bound">xs</span> <span class="main">=</span> <span class="free">n</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">∧</span> length <span class="bound">xs</span> <span class="main">=</span> <span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_lists_length_eq<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="List2-finite_set2"><span class="command">lemma</span></span> finite_set2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">A</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">=</span> <span class="free">A</span> <span class="main">∧</span> distinct <span class="bound">xs</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">=</span> <span class="free">A</span> <span class="main">∧</span> distinct <span class="bound">xs</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">=</span> <span class="free">A</span> <span class="main">∧</span> length <span class="bound">xs</span> <span class="main">=</span> <span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> distinct_card <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> finite_lists_length_eqE<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> finite_subset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="List2-set_list"><span class="command">lemma</span></span> set_list<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set <span class="main">`</span> <span class="free">XS</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> <span class="free">XS</span> <span class="main">⟹</span> distinct <span class="bound">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">XS</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">XS</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">xs</span> <span class="main">|</span> <span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">∈</span> set <span class="main">`</span> <span class="free">XS</span> <span class="main">∧</span> distinct <span class="bound">xs</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">xs</span> <span class="main">|</span><span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">∈</span> set <span class="main">`</span> <span class="free">XS</span> <span class="main">∧</span> distinct <span class="bound">xs</span><span class="main">}</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">{</span><span class="main">{</span><span class="bound">xs</span> <span class="main">|</span> <span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">=</span> <span class="bound">A</span> <span class="main">∧</span> distinct <span class="bound">xs</span><span class="main">}</span> <span class="main">|</span> <span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> set <span class="main">`</span> <span class="free">XS</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">xs</span> <span class="main">|</span><span class="bound">xs</span><span class="main">.</span> set <span class="bound">xs</span> <span class="main">∈</span> set <span class="main">`</span> <span class="free">XS</span> <span class="main">∧</span> distinct <span class="bound">xs</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_set2<span class="main">[</span><span class="operator">OF</span> _ finite_set<span class="main">]</span> distinct_card  assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="List2-set_foldl_append"><span class="command">lemma</span></span> set_foldl_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>foldl <span class="main">(@)</span> <span class="free">i</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="free">i</span> <span class="main">∪</span> <span class="main">⋃</span><span class="main">{</span>set <span class="bound">x</span> <span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Short-circuited Version of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> foldl<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">foldl_break</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">foldl_break</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">foldl_break</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">else</span> <span class="free">foldl_break</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="List2-foldl_break_append"><span class="command">lemma</span></span> foldl_break_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">"foldl_break <span class="free">f</span> <span class="free">s</span> <span class="free">a</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">s</span> <span class="main">(</span>foldl_break <span class="free">f</span> <span class="free">s</span> <span class="free">a</span> <span class="free">xs</span><span class="main">)</span> <span class="keyword1">then</span> foldl_break <span class="free">f</span> <span class="free">s</span> <span class="free">a</span> <span class="free">xs</span> <span class="keyword1">else</span> <span class="main">(</span>foldl_break <span class="free">f</span> <span class="free">s</span> <span class="main">(</span>foldl_break <span class="free">f</span> <span class="free">s</span> <span class="free">a</span> <span class="free">xs</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ys</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Suffixes›</span></span>

<span class="comment1">― ‹Non empty suffixes of finite words - specialised!›</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">suffixes</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">suffixes</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">suffixes</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">suffixes</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1" id="List2-suffixes_append"><span class="command">lemma</span></span> suffixes_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">"suffixes <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>suffixes <span class="free">ys</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">zs</span><span class="main">.</span> <span class="bound">zs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">(</span>suffixes <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="List2-suffixes_alt_def"><span class="command">lemma</span></span> suffixes_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"suffixes <span class="free">xs</span> <span class="main">=</span> rev <span class="main">(</span>prefix <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> drop <span class="bound">i</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subsequence_def suffixes_append snoc rev_map<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Mojmir_Rabin">
<div class="head">
<h1>Theory Mojmir_Rabin</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Author:      Salomon Sickert
    License:     BSD
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Translation to Deterministic Transition-Based Rabin Automata›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Mojmir_Rabin
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <a href="Mojmir.html">Mojmir</a> <a href="Rabin.html">Rabin</a> <span class="quoted">"<a href="List2.html">Auxiliary/List2</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">locale</span></span> mojmir_to_rabin_def <span class="main">=</span> mojmir_def 
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fail<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> nat option<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> transition set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fail<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">ν</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">|</span> <span class="bound">r</span> <span class="bound">ν</span> <span class="bound">s</span> <span class="bound">q</span> <span class="bound">q'</span><span class="main">.</span> <span class="bound">r</span> <span class="bound">q</span> <span class="main">≠</span> None <span class="main">∧</span> <span class="bound">q'</span> <span class="main">=</span> <span class="free">δ</span> <span class="bound">q</span> <span class="bound">ν</span> <span class="main">∧</span> <span class="bound">q'</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">∧</span> sink <span class="bound">q'</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">succeed<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> nat option<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> transition set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">succeed<span class="hidden">⇩</span><sub>R</sub></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">ν</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">|</span> <span class="bound">r</span> <span class="bound">ν</span> <span class="bound">s</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">r</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">∉</span> <span class="free">F</span> <span class="main">-</span> <span class="main">{</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">}</span> <span class="main">∧</span> <span class="main">(</span><span class="free">δ</span> <span class="bound">q</span> <span class="bound">ν</span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">merge<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> nat option<span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> transition set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge<span class="hidden">⇩</span><sub>R</sub></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">ν</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span> <span class="main">|</span> <span class="bound">r</span> <span class="bound">ν</span> <span class="bound">s</span> <span class="bound">q</span> <span class="bound">q'</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">r</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="bound">q'</span> <span class="main">=</span> <span class="free">δ</span> <span class="bound">q</span> <span class="bound">ν</span> <span class="main">∧</span>
        <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">q''</span><span class="main">.</span> <span class="bound">q'</span> <span class="main">=</span> <span class="free">δ</span> <span class="bound">q''</span> <span class="bound">ν</span> <span class="main">∧</span> <span class="bound">r</span> <span class="bound">q''</span> <span class="main">≠</span> None <span class="main">∧</span> <span class="bound">q''</span> <span class="main">≠</span> <span class="bound">q</span><span class="main">)</span> <span class="main">∨</span> <span class="bound">q'</span> <span class="main">=</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">∧</span> <span class="bound">q'</span> <span class="main">∉</span> <span class="free">F</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Q<span class="hidden">⇩</span><sub>R</sub></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Q<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">≡</span> reach <span class="free">Σ</span> step initial"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">q<span class="hidden">⇩</span><sub>ℛ</sub></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">q<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">≡</span> initial"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">δ<span class="hidden">⇩</span><sub>ℛ</sub></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">δ<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">≡</span> step"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Acc<span class="hidden">⇩</span><sub>ℛ</sub></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Acc<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≡</span> <span class="main">(</span>fail<span class="hidden">⇩</span><sub>R</sub> <span class="main">∪</span> merge<span class="hidden">⇩</span><sub>R</sub> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">,</span> succeed<span class="hidden">⇩</span><sub>R</sub> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">ℛ</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ℛ</span> <span class="main">≡</span> <span class="main">(</span>δ<span class="hidden">⇩</span><sub>ℛ</sub><span class="main">,</span> q<span class="hidden">⇩</span><sub>ℛ</sub><span class="main">,</span> <span class="main">{</span>Acc<span class="hidden">⇩</span><sub>ℛ</sub> <span class="bound">j</span> <span class="main">|</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> max_rank<span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Well-formedness›</span></span>

<span class="keyword1" id="Mojmir_Rabin-function_set_finite"><span class="command">lemma</span></span> function_set_finite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">f</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">R</span> <span class="main">⟶</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">c</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟶</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?F</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">R</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">f</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{}</span> <span class="main">⟶</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="main">{}</span> <span class="main">⟶</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">c</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">c</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">r</span> <span class="skolem">R</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?F</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">f</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="skolem">R</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">r</span><span class="main">}</span> <span class="main">⟶</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">c</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">R</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">r</span><span class="main">}</span> <span class="main">⟶</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?F'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">f</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="skolem">R</span> <span class="main">⟶</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">c</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">R</span> <span class="main">⟶</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">)</span><span class="main">}</span>"</span></span>
 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?F</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">f</span><span class="main">(</span><span class="skolem">r</span> <span class="main">:=</span> <span class="bound">a</span><span class="main">)</span> <span class="main">|</span> <span class="bound">f</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="var">?F'</span> <span class="main">∧</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⊆</span> <span class="var">?X</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> 
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="var">?F</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span><span class="main">(</span><span class="skolem">r</span> <span class="main">:=</span> <span class="free">c</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?F'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">r</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span><span class="main">(</span><span class="skolem">r</span> <span class="main">:=</span> <span class="free">c</span><span class="main">,</span> <span class="skolem">r</span> <span class="main">:=</span> <span class="main">(</span><span class="skolem">f</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?X</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="var">?X</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="var">?F'</span> <span class="main">×</span> <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> insert<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="skolem">r</span><span class="main">:=</span><span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="var">?F'</span> <span class="main">×</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="var">?X</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?X</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_imageI<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span><span class="var">?F'</span> <span class="main">×</span> <span class="free">A</span><span class="main">)</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">a</span><span class="main">)</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="skolem">r</span><span class="main">:=</span><span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?F</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> insert_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> semi_mojmir<span class="main">)</span> wellformed_ℛ<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reach <span class="free">Σ</span> step initial<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">f</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> reach <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟶</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">∧</span> 
    <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> reach <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟶</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span>None<span class="main">}</span> <span class="main">∪</span> Some <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>max_rank<span class="main">}</span><span class="main">)</span><span class="main">}</span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"reach <span class="free">Σ</span> step initial <span class="main">⊆</span> <span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> 
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> reach <span class="free">Σ</span> step initial"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> foldl step initial <span class="skolem">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">w</span> <span class="main">⊆</span> <span class="free">Σ</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> reach_foldl_def<span class="main">[</span><span class="operator">OF</span> nonempty_Σ<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">Σ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nonempty_Σ <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"range <span class="main">(</span><span class="skolem">w</span> <span class="main">⌢</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Σ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹set <span class="skolem">w</span> <span class="main">⊆</span> <span class="free">Σ</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> <span class="free">Σ</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> conc_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> ℌ<span class="main">:</span> semi_mojmir <span class="quoted"><span class="free">Σ</span></span> <span class="quoted"><span class="free">δ</span></span> <span class="quoted"><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span> <span class="main">⌢</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_reach finite_Σ <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> ℌ.state_rank <span class="bound">q</span> <span class="main">(</span>length <span class="skolem">w</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> ℌ.state_rank_step_foldl x_def <span class="keyword1"><span class="command">using</span></span> prefix_conc_length subsequence_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ℌ.state_rank_in_function_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">{</span>None<span class="main">}</span> <span class="main">∪</span> Some <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>max_rank<span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_reach <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> function_set_finite<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">locale</span></span> mojmir_to_rabin <span class="main">=</span> mojmir <span class="main">+</span> mojmir_to_rabin_def <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Correctness›</span></span>

<span class="keyword1" id="Mojmir_Rabin-imp_and_not_imp_eq"><span class="command">lemma</span></span> imp_and_not_imp_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⟹</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">P</span> <span class="main">⟹</span> <span class="main">¬</span><span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  

<span class="keyword1" id="Mojmir_Rabin-finite_limit_intersection"><span class="command">lemma</span></span> finite_limit_intersection<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">::</span>nat<span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟷</span> limit <span class="free">f</span> <span class="main">∩</span> <span class="free">B</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> imp_and_not_imp_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&gt;</span> Max <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Max.coboundedI 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_iff insert_is_Un not_le sup.commute<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">∉</span> <span class="free">B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="main">{</span>Suc <span class="main">(</span>Max <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">..}</span> <span class="main">∩</span> <span class="free">B</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"limit <span class="free">f</span> <span class="main">∩</span> <span class="free">B</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> limit_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"infinite <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> image_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> limit_def Inf_many_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> infinite_iff_countable_subset subset_UNIV subset_image_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">`</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">n</span><span class="main">.</span> <span class="free">f</span> <span class="bound">n</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Inf_many_def <span class="keyword1"><span class="command">using</span></span> pigeonhole_infinite<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹infinite <span class="free">A</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"limit <span class="free">f</span> <span class="main">∩</span> <span class="free">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> limit_iff_frequent <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Mojmir_Rabin-finite_range_run"><span class="command">lemma</span></span> finite_range_run<span class="main">:</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≡</span> run<span class="hidden">⇩</span><sub>t</sub> δ<span class="hidden">⇩</span><sub>ℛ</sub> q<span class="hidden">⇩</span><sub>ℛ</sub> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="free">w</span> <span class="bound">n</span> <span class="main">∈</span> <span class="free">Σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map <span class="free">w</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span> map <span class="free">w</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">n</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">Σ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> bounded_w <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="skolem">n</span> <span class="main">∈</span> Q<span class="hidden">⇩</span><sub>R</sub> <span class="main">×</span> <span class="free">Σ</span> <span class="main">×</span> Q<span class="hidden">⇩</span><sub>R</sub>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> run<span class="hidden">⇩</span><sub>t</sub>.simps run_foldl reach_foldl_def<span class="main">[</span><span class="operator">OF</span> nonempty_Σ<span class="main">]</span> r_def 
      <span class="keyword1"><span class="command">unfolding</span></span> fst_conv comp_def snd_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"range <span class="free">r</span> <span class="main">⊆</span> Q<span class="hidden">⇩</span><sub>R</sub> <span class="main">×</span> <span class="free">Σ</span> <span class="main">×</span> Q<span class="hidden">⇩</span><sub>R</sub>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_Σ wellformed_ℛ 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> mojmir_accept_iff_rabin_accept_rank<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>finite <span class="main">(</span>fail<span class="main">)</span> <span class="main">∧</span> finite <span class="main">(</span>merge <span class="free">i</span><span class="main">)</span> <span class="main">∧</span> infinite <span class="main">(</span>succeed  <span class="free">i</span><span class="main">)</span><span class="main">)</span>
    <span class="main">⟷</span> accepting_pair<span class="hidden">⇩</span><sub>R</sub> δ<span class="hidden">⇩</span><sub>ℛ</sub> q<span class="hidden">⇩</span><sub>ℛ</sub> <span class="main">(</span>Acc<span class="hidden">⇩</span><sub>ℛ</sub> <span class="free">i</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> run<span class="hidden">⇩</span><sub>t</sub> δ<span class="hidden">⇩</span><sub>ℛ</sub> q<span class="hidden">⇩</span><sub>ℛ</sub> <span class="free">w</span>"</span></span> 
  <span class="keyword1"><span class="command">have</span></span> r_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">r</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> state_rank <span class="bound">q</span> <span class="bound">i</span><span class="main">,</span> <span class="free">w</span> <span class="bound">i</span><span class="main">,</span> <span class="main">λ</span><span class="bound">q</span><span class="main">.</span> state_rank <span class="bound">q</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> r_def state_rank_step_foldl run_foldl <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1"><span class="command">have</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> fail_t <span class="main">⟷</span> <span class="main">(</span><span class="skolem">r</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> fail<span class="hidden">⇩</span><sub>R</sub>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fail_t_def fail<span class="hidden">⇩</span><sub>R</sub>_def r_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> merge_t <span class="bound">i</span> <span class="main">⟷</span> <span class="main">(</span><span class="skolem">r</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> merge<span class="hidden">⇩</span><sub>R</sub> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> merge_t_def merge<span class="hidden">⇩</span><sub>R</sub>_def r_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> succeed_t <span class="bound">i</span> <span class="main">⟷</span> <span class="main">(</span><span class="skolem">r</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> succeed<span class="hidden">⇩</span><sub>R</sub> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> succeed_t_def succeed<span class="hidden">⇩</span><sub>R</sub>_def r_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_range_run r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">note</span></span> finite_limit_rule <span class="main">=</span> finite_limit_intersection<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>range <span class="skolem">r</span><span class="main">)</span>›</span></span><span class="main">]</span>
 
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite fail_t"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>merge_t <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>succeed_t <span class="free">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> finite_fail_t finite_merge_t finite_succeed_t <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"limit <span class="skolem">r</span> <span class="main">∩</span> fail<span class="hidden">⇩</span><sub>R</sub> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_limit_rule F <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>fail_t<span class="main">)</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"limit <span class="skolem">r</span> <span class="main">∩</span> merge<span class="hidden">⇩</span><sub>R</sub> <span class="free">i</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_limit_rule B <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>merge_t <span class="free">i</span><span class="main">)</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"limit <span class="skolem">r</span> <span class="main">∩</span> fst <span class="main">(</span>Acc<span class="hidden">⇩</span><sub>ℛ</sub> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"limit <span class="skolem">r</span> <span class="main">∩</span> succeed<span class="hidden">⇩</span><sub>R</sub> <span class="free">i</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_limit_rule S <span class="quoted"><span class="quoted">‹infinite <span class="main">(</span>succeed_t <span class="free">i</span><span class="main">)</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"limit <span class="skolem">r</span> <span class="main">∩</span> snd <span class="main">(</span>Acc<span class="hidden">⇩</span><sub>ℛ</sub> <span class="free">i</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"limit <span class="skolem">r</span> <span class="main">∩</span> fail<span class="hidden">⇩</span><sub>R</sub> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"limit <span class="skolem">r</span> <span class="main">∩</span> merge<span class="hidden">⇩</span><sub>R</sub> <span class="free">i</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"limit <span class="skolem">r</span> <span class="main">∩</span> <span class="main">(</span>succeed<span class="hidden">⇩</span><sub>R</sub> <span class="free">i</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite fail_t"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_limit_rule F <span class="quoted"><span class="quoted">‹limit <span class="skolem">r</span> <span class="main">∩</span> fail<span class="hidden">⇩</span><sub>R</sub> <span class="main">=</span> <span class="main">{}</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>merge_t <span class="free">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_limit_rule B <span class="quoted"><span class="quoted">‹limit <span class="skolem">r</span> <span class="main">∩</span> merge<span class="hidden">⇩</span><sub>R</sub> <span class="free">i</span> <span class="main">=</span> <span class="main">{}</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">(</span>succeed_t <span class="free">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_limit_rule S <span class="quoted"><span class="quoted">‹limit <span class="skolem">r</span> <span class="main">∩</span> <span class="main">(</span>succeed<span class="hidden">⇩</span><sub>R</sub> <span class="free">i</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> finite_fail_t finite_merge_t finite_succeed_t <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> mojmir_accept_iff_rabin_accept<span class="main">:</span>
  <span class="quoted"><span class="quoted">"accept <span class="main">⟷</span> accept<span class="hidden">⇩</span><sub>R</sub> ℛ <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mojmir_accept_iff_token_set_accept mojmir_accept_iff_rabin_accept_rank <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">smallest_accepting_rank<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">smallest_accepting_rank<span class="hidden">⇩</span><sub>ℛ</sub></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">if</span> accept<span class="hidden">⇩</span><sub>R</sub> ℛ <span class="free">w</span> <span class="keyword1">then</span> 
    Some <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">i</span><span class="main">.</span> accepting_pair<span class="hidden">⇩</span><sub>R</sub> δ<span class="hidden">⇩</span><sub>ℛ</sub> q<span class="hidden">⇩</span><sub>ℛ</sub> <span class="main">(</span>Acc<span class="hidden">⇩</span><sub>ℛ</sub> <span class="bound">i</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> Mojmir_rabin_smallest_accepting_rank<span class="main">:</span>
  <span class="quoted"><span class="quoted">"smallest_accepting_rank <span class="main">=</span> smallest_accepting_rank<span class="hidden">⇩</span><sub>ℛ</sub>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> smallest_accepting_rank_def smallest_accepting_rank<span class="hidden">⇩</span><sub>ℛ</sub>_def 
    mojmir_accept_iff_rabin_accept mojmir_accept_iff_rabin_accept_rank<span class="main">)</span>

<span class="keyword1" id="Mojmir_Rabin-smallest_accepting_rank"><span class="command">lemma</span></span> smallest_accepting_rank<span class="hidden">⇩</span><sub>ℛ</sub>_properties<span class="main">:</span>
  <span class="quoted"><span class="quoted">"smallest_accepting_rank<span class="hidden">⇩</span><sub>ℛ</sub> <span class="main">=</span> Some <span class="free">i</span> <span class="main">⟹</span> accepting_pair<span class="hidden">⇩</span><sub>R</sub> δ<span class="hidden">⇩</span><sub>ℛ</sub> q<span class="hidden">⇩</span><sub>ℛ</sub> <span class="main">(</span>Acc<span class="hidden">⇩</span><sub>ℛ</sub> <span class="free">i</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> Mojmir_rabin_smallest_accepting_rank<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> mojmir_accept_iff_rabin_accept_rank<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span>
      <span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> smallest_accepting_rank_properties<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="LTL_FGXU">
<div class="head">
<h1>Theory LTL_FGXU</h1>
</div>
<pre class="source"><span class="comment1">(*
    Author:      Salomon Sickert
    License:     BSD
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹LTL (in Negation-Normal-Form, FGXU-Syntax)›</span></span>

<span class="keyword1"><span class="command">theory</span></span> LTL_FGXU
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <span class="quoted">"<a href="../../HOL/HOL-Library/Omega_Words_Fun.html">HOL-Library.Omega_Words_Fun</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Inspired/Based on schimpf/LTL›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Syntax›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span>vars<span class="main">:</span> <span class="tfree">'a</span><span class="main">)</span> ltl  <span class="main">=</span>
    LTLTrue                       <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">true</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span><span class="main">)</span>
  <span class="main">|</span> LTLFalse                      <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">false</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span><span class="main">)</span>
  <span class="main">|</span> LTLProp <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>                    <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">p'(</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">')</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span><span class="main">)</span>
  <span class="main">|</span> LTLPropNeg <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>                 <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">np'(</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>_<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">')</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>"</span> <span class="main">[</span>86<span class="main">]</span> 85<span class="main">)</span>
  <span class="main">|</span> LTLAnd <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl"</span></span>      <span class="main">(</span><span class="quoted">"_ <span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">and</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _"</span> <span class="main">[</span>83<span class="main">,</span>83<span class="main">]</span> 82<span class="main">)</span>
  <span class="main">|</span> LTLOr <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl"</span></span>       <span class="main">(</span><span class="quoted">"_ <span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">or</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _"</span> <span class="main">[</span>82<span class="main">,</span>82<span class="main">]</span> 81<span class="main">)</span>
  <span class="main">|</span> LTLNext <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl"</span></span>              <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">X</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _"</span> <span class="main">[</span>88<span class="main">]</span> 87<span class="main">)</span>
  <span class="main">|</span> LTLGlobal <span class="main">(</span><span class="free"><span class="entity">theG</span></span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl"</span></span><span class="main">)</span>    <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">G</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _"</span> <span class="main">[</span>85<span class="main">]</span> 84<span class="main">)</span>
  <span class="main">|</span> LTLFinal <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl"</span></span>             <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">F</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _"</span> <span class="main">[</span>84<span class="main">]</span> 83<span class="main">)</span>
  <span class="main">|</span> LTLUntil <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl"</span></span>    <span class="main">(</span><span class="quoted">"_ <span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="keyword1">U</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> _"</span> <span class="main">[</span>87<span class="main">,</span>87<span class="main">]</span> 86<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Semantics›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ltl_semantics</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'a</span> set word<span class="main">,</span> <span class="tfree">'a</span> ltl<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊨</span>"</span> 80<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main"><span class="free">⊨</span></span> <span class="keyword1">true</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main"><span class="free">⊨</span></span> <span class="keyword1">false</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main"><span class="free">⊨</span></span> <span class="keyword1">p(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main"><span class="free">⊨</span></span> <span class="keyword1">np(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">and</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">or</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main"><span class="free">⊨</span></span> <span class="keyword1">X</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">(</span>suffix <span class="main">1</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main"><span class="free">⊨</span></span> <span class="keyword1">G</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> suffix <span class="bound">k</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main"><span class="free">⊨</span></span> <span class="keyword1">F</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span><span class="main">.</span> suffix <span class="bound">k</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">U</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span><span class="main">.</span> suffix <span class="bound">k</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="bound">k</span><span class="main">.</span> suffix <span class="bound">j</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main"><span class="free">⊨</span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ltl_prop_entailment</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'a</span> ltl set<span class="main">,</span> <span class="tfree">'a</span> ltl<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span>"</span> 80<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">𝒜</span></span></span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>P</sub></span></span> <span class="keyword1">true</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">𝒜</span></span></span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>P</sub></span></span> <span class="keyword1">false</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">𝒜</span></span></span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>P</sub></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">and</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">𝒜</span></span></span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>P</sub></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">𝒜</span></span></span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>P</sub></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">𝒜</span></span></span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>P</sub></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">or</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">𝒜</span></span></span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>P</sub></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">𝒜</span></span></span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>P</sub></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">𝒜</span></span></span> <span class="keyword1"><span class="free">⊨<span class="hidden">⇩</span><sub>P</sub></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">𝒜</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Properties›</span></span>

<span class="keyword1" id="LTL_FGXU-LTL_G_one_step_unfolding"><span class="command">lemma</span></span> LTL_G_one_step_unfolding<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">G</span> <span class="free">φ</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span> <span class="main">∧</span> <span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">X</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> suffix_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span> ltl_semantics.simps<span class="main">(</span>8<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">φ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?lhs</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">X</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">X</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> suffix <span class="main">(</span><span class="bound">k</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">.</span> suffix <span class="bound">k</span> <span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 gr0_implies_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?rhs</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>suffix <span class="main">0</span> <span class="free">w</span><span class="main">)</span> <span class="main">⊨</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> neq0_conv ltl_semantics.simps<span class="main">(</span>8<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">φ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LTL_FGXU-LTL_F_one_step_unfolding"><span class="command">lemma</span></span> LTL_F_one_step_unfolding<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">F</span> <span class="free">φ</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span> <span class="main">∨</span> <span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">X</span> <span class="main">(</span><span class="keyword1">F</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"suffix <span class="skolem">k</span> <span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> suffix_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span> suffix_suffix<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ltl_semantics.simps<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> ltl_semantics.simps<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LTL_FGXU-LTL_U_one_step_unfolding"><span class="command">lemma</span></span> LTL_U_one_step_unfolding<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span> <span class="keyword1">U</span> <span class="free">ψ</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">w</span> <span class="main">⊨</span> <span class="free">ψ</span> <span class="main">∨</span> <span class="main">(</span><span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span> <span class="main">∧</span> <span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">X</span> <span class="main">(</span><span class="free">φ</span> <span class="keyword1">U</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"suffix <span class="skolem">k</span> <span class="free">w</span> <span class="main">⊨</span> <span class="free">ψ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="skolem">k</span><span class="main">.</span> suffix <span class="bound">j</span> <span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⊨</span> <span class="free">ψ</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span> <span class="main">∧</span> <span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">X</span> <span class="main">(</span><span class="free">φ</span> <span class="keyword1">U</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?rhs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"suffix <span class="skolem">k</span> <span class="main">(</span>suffix <span class="main">1</span> <span class="free">w</span><span class="main">)</span> <span class="main">⊨</span> <span class="free">ψ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="skolem">k</span><span class="main">.</span> suffix <span class="bound">j</span> <span class="main">(</span>suffix <span class="main">1</span> <span class="free">w</span><span class="main">)</span> <span class="main">⊨</span> <span class="free">φ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> False <span class="quoted"><span class="quoted">‹<span class="var">?rhs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">+</span> <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"suffix <span class="skolem">j</span> <span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span> <span class="main">∧</span> <span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">X</span> <span class="main">(</span><span class="free">φ</span> <span class="keyword1">U</span> <span class="free">ψ</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="skolem">k</span><span class="main">.</span> suffix <span class="bound">j</span> <span class="main">(</span>suffix <span class="main">1</span> <span class="free">w</span><span class="main">)</span> <span class="main">⊨</span> <span class="free">φ</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> suffix_suffix<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LTL_FGXU-LTL_GF_infinitely_many_suffixes"><span class="command">lemma</span></span> LTL_GF_infinitely_many_suffixes<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">G</span> <span class="main">(</span><span class="keyword1">F</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">i</span><span class="main">.</span> suffix <span class="bound">i</span> <span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span> <span class="main">|</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> suffix <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="bound">j</span><span class="main">)</span> <span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span> <span class="main">+</span> <span class="bound">j</span> <span class="main">|</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> suffix <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="bound">j</span><span class="main">)</span> <span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span><span class="main">}</span>"</span></span>

  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"infinite <span class="var">?S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span> <span class="main">∈</span> <span class="var">?S</span><span class="main">.</span> <span class="main">∃</span><span class="bound">s'</span> <span class="main">∈</span> <span class="var">?S'</span><span class="main">.</span> <span class="bound">s</span> <span class="main">≤</span> <span class="bound">s'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="var">?S'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> infinite_nat_iff_unbounded_le le_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S'</span> <span class="main">=</span> <span class="main">{</span><span class="bound">k</span> <span class="main">|</span> <span class="bound">k</span><span class="main">.</span> suffix <span class="bound">k</span> <span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> monoid_add_class.add.left_neutral <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"infinite <span class="main">{</span><span class="bound">k</span> <span class="main">|</span> <span class="bound">k</span><span class="main">.</span> suffix <span class="bound">k</span> <span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> Inf_many_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?rhs</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"suffix <span class="skolem">k</span> <span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> INFM_nat_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span><span class="main">.</span> suffix <span class="bound">n</span> <span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">+</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> le_iff_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"suffix <span class="skolem">j</span> <span class="main">(</span>suffix <span class="skolem">i</span> <span class="free">w</span><span class="main">)</span> <span class="main">⊨</span> <span class="free">φ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹suffix <span class="skolem">k</span> <span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span>›</span></span> suffix_suffix <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"suffix <span class="skolem">i</span> <span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">F</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LTL_FGXU-LTL_FG_almost_all_suffixes"><span class="command">lemma</span></span> LTL_FG_almost_all_suffixes<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">F</span> <span class="keyword1">G</span> <span class="free">φ</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">i</span><span class="main">.</span> suffix <span class="bound">i</span> <span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">k</span><span class="main">.</span> <span class="main">¬</span> suffix <span class="bound">k</span> <span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span><span class="main">}</span>"</span></span>

  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"suffix <span class="skolem">i</span> <span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">G</span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≥</span> <span class="skolem">i</span> <span class="main">⟹</span> <span class="main">(</span>suffix <span class="bound">j</span> <span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> le_iff_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="main">¬</span>suffix <span class="bound">j</span> <span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> le_less_linear <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="skolem">i</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Alm_all_def Inf_many_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> S_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">{</span><span class="bound">k</span><span class="main">.</span> <span class="main">¬</span> suffix <span class="bound">k</span> <span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?rhs</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Alm_all_def Inf_many_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> Max <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∉</span> <span class="skolem">S</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">=</span> Max <span class="skolem">S</span>›</span></span> Max.coboundedI<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">S</span>›</span></span><span class="main">]</span> less_le_not_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"suffix <span class="skolem">j</span> <span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> S_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&gt;</span> <span class="skolem">i</span><span class="main">.</span> <span class="main">(</span>suffix <span class="bound">j</span> <span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"suffix <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">G</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ltl_semantics.simps<span class="main">(</span>9<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">G</span> <span class="free">φ</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LTL_FGXU-LTL_FG_suffix"><span class="command">lemma</span></span> LTL_FG_suffix<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>suffix <span class="free">i</span> <span class="free">w</span><span class="main">)</span> <span class="main">⊨</span> <span class="keyword1">F</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> <span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">F</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="bound">m</span><span class="main">.</span> suffix <span class="bound">n</span> <span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="bound">m</span><span class="main">.</span> suffix <span class="bound">n</span> <span class="main">(</span>suffix <span class="free">i</span> <span class="free">w</span><span class="main">)</span> <span class="main">⊨</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="skolem">m</span><span class="main">.</span> suffix <span class="bound">n</span> <span class="main">(</span>suffix <span class="free">i</span> <span class="free">w</span><span class="main">)</span> <span class="main">⊨</span> <span class="free">φ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="free">i</span><span class="main">+</span><span class="skolem">m</span><span class="main">.</span> suffix <span class="bound">n</span> <span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> suffix_suffix <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_iff_add add_leE add_le_cancel_left<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">metis</span> suffix_suffix trans_le_add2<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> LTL_FG_almost_all_suffixes MOST_nat_le <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LTL_FGXU-LTL_GF_suffix"><span class="command">lemma</span></span> LTL_GF_suffix<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>suffix <span class="free">i</span> <span class="free">w</span><span class="main">)</span> <span class="main">⊨</span> <span class="keyword1">G</span> <span class="main">(</span><span class="keyword1">F</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> <span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">G</span> <span class="main">(</span><span class="keyword1">F</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">m</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="bound">m</span><span class="main">.</span> suffix <span class="bound">n</span> <span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">m</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="bound">m</span><span class="main">.</span> suffix <span class="bound">n</span> <span class="main">(</span>suffix <span class="free">i</span> <span class="free">w</span><span class="main">)</span> <span class="main">⊨</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> suffix_suffix add_leE add_le_cancel_left le_Suc_ex<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">metis</span> suffix_suffix trans_le_add2<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> LTL_GF_infinitely_many_suffixes INFM_nat_le <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LTL_FGXU-LTL_suffix_G"><span class="command">lemma</span></span> LTL_suffix_G<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">G</span> <span class="free">φ</span> <span class="main">⟹</span> suffix <span class="free">i</span> <span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">G</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> suffix_0 suffix_suffix <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="LTL_FGXU-LTL_prop_entailment_monotonI"><span class="command">lemma</span></span> LTL_prop_entailment_monotonI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">φ</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">⊆</span> <span class="free">S'</span> <span class="main">⟹</span> <span class="free">S'</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> ltl_prop_entailment.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="LTL_FGXU-ltl_models_equiv_prop_entailment"><span class="command">lemma</span></span> ltl_models_equiv_prop_entailment<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span> <span class="main">=</span> <span class="main">{</span><span class="bound">χ</span><span class="main">.</span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">χ</span><span class="main">}</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Limit Behaviour of the G-operator›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Only_G</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Only_G</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="keyword1">G</span> <span class="bound">y</span>"</span></span>

<span class="keyword1" id="LTL_FGXU-ltl_G_stabilize"><span class="command">lemma</span></span> ltl_G_stabilize<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">𝒢</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Only_G <span class="free">𝒢</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">i</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> <span class="free">𝒢</span> <span class="main">⟹</span> suffix <span class="free">i</span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">χ</span> <span class="main">=</span> suffix <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="bound">j</span><span class="main">)</span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">χ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">𝒢</span> <span class="main">⟹</span> Only_G <span class="free">𝒢</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">χ</span> <span class="main">∈</span> <span class="free">𝒢</span><span class="main">.</span> <span class="main">∀</span><span class="bound">j</span><span class="main">.</span> suffix <span class="bound">i</span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">χ</span> <span class="main">=</span> suffix <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="bound">j</span><span class="main">)</span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">χ</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">χ</span> <span class="skolem">𝒢</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i<span class="hidden">⇩</span><sub>1</sub></span></span>  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> <span class="skolem">𝒢</span> <span class="main">⟹</span> suffix <span class="skolem">i<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">χ</span> <span class="main">=</span> suffix <span class="main">(</span><span class="skolem">i<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="bound">j</span><span class="main">)</span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">χ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> insert <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ψ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">χ</span> <span class="main">=</span> <span class="keyword1">G</span> <span class="skolem">ψ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">j</span><span class="main">.</span> suffix <span class="bound">i</span> <span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">G</span> <span class="skolem">ψ</span> <span class="main">=</span> suffix <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="bound">j</span><span class="main">)</span> <span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">G</span> <span class="skolem">ψ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LTL_suffix_G plus_nat.add_0 suffix_0 suffix_suffix<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> suffix <span class="skolem">i<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">w</span> <span class="main">⊨</span> <span class="skolem">χ</span> <span class="main">=</span> suffix <span class="main">(</span><span class="skolem">i<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">+</span> <span class="bound">j</span><span class="main">)</span> <span class="free">w</span> <span class="main">⊨</span> <span class="skolem">χ</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">χ</span> <span class="main">=</span> <span class="keyword1">G</span> <span class="skolem">ψ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ'</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">χ'</span> <span class="main">∈</span> <span class="skolem">𝒢</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">χ</span><span class="main">}</span> <span class="main">⟹</span> suffix <span class="main">(</span><span class="skolem">i<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="skolem">i<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">χ'</span> <span class="main">=</span> suffix <span class="main">(</span><span class="skolem">i<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="skolem">i<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">+</span> <span class="bound">j</span><span class="main">)</span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">χ'</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> Un_iff singleton_iff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute add.left_commute<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> <span class="free">𝒢</span> <span class="main">⟹</span> suffix <span class="skolem">i</span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">χ</span> <span class="main">=</span> suffix <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="bound">j</span><span class="main">)</span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">χ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LTL_FGXU-ltl_G_stabilize_property"><span class="command">lemma</span></span> ltl_G_stabilize_property<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">𝒢</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Only_G <span class="free">𝒢</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> <span class="free">𝒢</span> <span class="main">⟹</span> suffix <span class="free">i</span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">χ</span> <span class="main">=</span> suffix <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="bound">j</span><span class="main">)</span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">χ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">G</span> <span class="free">ψ</span> <span class="main">∈</span> <span class="free">𝒢</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">χ</span><span class="main">.</span> <span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">F</span> <span class="bound">χ</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"suffix <span class="free">i</span> <span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">G</span> <span class="free">ψ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"suffix <span class="skolem">j</span> <span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">G</span> <span class="free">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"suffix <span class="free">i</span> <span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">G</span> <span class="free">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> le_iff_add<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>erased<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> LTL_suffix_G <span class="quoted"><span class="quoted">‹suffix <span class="skolem">j</span> <span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">G</span> <span class="free">ψ</span>›</span></span> le_add_diff_inverse nat_le_linear suffix_suffix<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Subformulae›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Propositions›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">propos</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl <span class="main">⇒</span><span class="tfree">'a</span> ltl set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">propos</span> <span class="keyword1">true</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">propos</span> <span class="keyword1">false</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">propos</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">and</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">propos</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∪</span> <span class="free">propos</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">propos</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">or</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">propos</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∪</span> <span class="free">propos</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">propos</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nested_propos</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl <span class="main">⇒</span><span class="tfree">'a</span> ltl set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nested_propos</span> <span class="keyword1">true</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nested_propos</span> <span class="keyword1">false</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nested_propos</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">and</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">nested_propos</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∪</span> <span class="free">nested_propos</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nested_propos</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">or</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">nested_propos</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∪</span> <span class="free">nested_propos</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nested_propos</span> <span class="main">(</span><span class="keyword1">F</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="keyword1">F</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">}</span> <span class="main">∪</span> <span class="free">nested_propos</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nested_propos</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="keyword1">G</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">}</span> <span class="main">∪</span> <span class="free">nested_propos</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nested_propos</span> <span class="main">(</span><span class="keyword1">X</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="keyword1">X</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">}</span> <span class="main">∪</span> <span class="free">nested_propos</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nested_propos</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">U</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">U</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">}</span> <span class="main">∪</span> <span class="free">nested_propos</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∪</span> <span class="free">nested_propos</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">nested_propos</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="LTL_FGXU-finite_propos"><span class="command">lemma</span></span> finite_propos<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>propos <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>nested_propos <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="LTL_FGXU-propos_subset"><span class="command">lemma</span></span> propos_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"propos <span class="free">φ</span> <span class="main">⊆</span> nested_propos <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="LTL_FGXU-LTL_prop_entailment_restrict_to_propos"><span class="command">lemma</span></span> LTL_prop_entailment_restrict_to_propos<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">φ</span> <span class="main">=</span> <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> propos <span class="free">φ</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="LTL_FGXU-propos_foldl"><span class="command">lemma</span></span> propos_foldl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> propos <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> propos <span class="bound">x</span> <span class="main">∪</span> propos <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">{</span>propos <span class="bound">y</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">i</span> <span class="main">∨</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">}</span> <span class="main">=</span> propos <span class="main">(</span>foldl <span class="free">f</span> <span class="free">i</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">{</span>propos <span class="bound">y</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">i</span> <span class="main">∨</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">xs</span><span class="main">@</span><span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">{</span>propos <span class="bound">y</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">i</span> <span class="main">∨</span> <span class="bound">y</span> <span class="main">∈</span> set <span class="skolem">xs</span><span class="main">}</span> <span class="main">∪</span> propos <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> propos <span class="main">(</span>foldl <span class="free">f</span> <span class="free">i</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">∪</span> propos <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> propos <span class="main">(</span>foldl <span class="free">f</span> <span class="free">i</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">@</span><span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹G-Subformulae›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Notation for paper: mathds{G}›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">G_nested_propos</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl <span class="main">⇒</span><span class="tfree">'a</span> ltl set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>G</b></span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free"><span class="hidden">❙</span><b>G</b></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">and</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="free"><span class="hidden">❙</span><b>G</b></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∪</span> <span class="keyword1"><span class="free"><span class="hidden">❙</span><b>G</b></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free"><span class="hidden">❙</span><b>G</b></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">or</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="free"><span class="hidden">❙</span><b>G</b></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∪</span> <span class="keyword1"><span class="free"><span class="hidden">❙</span><b>G</b></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free"><span class="hidden">❙</span><b>G</b></span></span> <span class="main">(</span><span class="keyword1">F</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="free"><span class="hidden">❙</span><b>G</b></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free"><span class="hidden">❙</span><b>G</b></span></span> <span class="main">(</span><span class="keyword1">G</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="free"><span class="hidden">❙</span><b>G</b></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="keyword1">G</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free"><span class="hidden">❙</span><b>G</b></span></span> <span class="main">(</span><span class="keyword1">X</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="free"><span class="hidden">❙</span><b>G</b></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free"><span class="hidden">❙</span><b>G</b></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">U</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="free"><span class="hidden">❙</span><b>G</b></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∪</span> <span class="keyword1"><span class="free"><span class="hidden">❙</span><b>G</b></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free"><span class="hidden">❙</span><b>G</b></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="keyword1" id="LTL_FGXU-G_nested_finite"><span class="command">lemma</span></span> G_nested_finite<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="LTL_FGXU-G_nested_propos_alt_def"><span class="command">lemma</span></span> G_nested_propos_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span> <span class="main">=</span> nested_propos <span class="free">φ</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">ψ</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">ψ</span> <span class="main">=</span> <span class="keyword1">G</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="LTL_FGXU-G_nested_propos_Only_G"><span class="command">lemma</span></span> G_nested_propos_Only_G<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Only_G <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> G_nested_propos_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="LTL_FGXU-G_not_in_G"><span class="command">lemma</span></span> G_not_in_G<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">G</span> <span class="free">φ</span> <span class="main">∉</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span> <span class="main">⟹</span> size <span class="free">φ</span> <span class="main">≥</span> size <span class="bound">χ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LTL_FGXU-G_subset_G"><span class="command">lemma</span></span> G_subset_G<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">∈</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span> <span class="main">⟹</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">ψ</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">G</span> <span class="free">ψ</span> <span class="main">∈</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span> <span class="main">⟹</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">ψ</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="LTL_FGXU-𝒢_properties"><span class="command">lemma</span></span> 𝒢_properties<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝒢</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> 𝒢_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">𝒢</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 𝒢_elements<span class="main">:</span> <span class="quoted"><span class="quoted">"Only_G <span class="free">𝒢</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms G_nested_finite G_nested_propos_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Propositional Implication and Equivalence›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ltl_prop_implies</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'a</span> ltl<span class="main">,</span> <span class="tfree">'a</span> ltl<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⟶<span class="hidden">⇩</span><sub>P</sub></span>"</span> 75<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1"><span class="free">⟶<span class="hidden">⇩</span><sub>P</sub></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">𝒜</span><span class="main">.</span> <span class="bound">𝒜</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">⟶</span> <span class="bound">𝒜</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ltl_prop_equiv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'a</span> ltl<span class="main">,</span> <span class="tfree">'a</span> ltl<span class="main">]</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span>"</span> 75<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1"><span class="free">≡<span class="hidden">⇩</span><sub>P</sub></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">𝒜</span><span class="main">.</span> <span class="bound">𝒜</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">⟷</span> <span class="bound">𝒜</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>

<span class="keyword1" id="LTL_FGXU-ltl_prop_implies_equiv"><span class="command">lemma</span></span> ltl_prop_implies_equiv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="keyword1">⟶<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">ψ</span> <span class="main">∧</span> <span class="free">ψ</span> <span class="keyword1">⟶<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">φ</span> <span class="main">⟷</span> <span class="free">φ</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ltl_prop_implies_def ltl_prop_equiv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>

<span class="keyword1" id="LTL_FGXU-ltl_prop_equiv_equivp"><span class="command">lemma</span></span> ltl_prop_equiv_equivp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"equivp <span class="keyword1">(≡<span class="hidden">⇩</span><sub>P</sub>)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> equivpI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="keyword1">(≡<span class="hidden">⇩</span><sub>P</sub>)</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span> transp_def symp_def reflp_def ltl_prop_equiv_def<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">ψ</span> <span class="main">⟹</span> <span class="free">ψ</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">χ</span> <span class="main">⟹</span> <span class="free">φ</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">χ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ltl_prop_equiv_equivp<span class="main">[</span><span class="operator">THEN</span> equivp_transp<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Quotient Type for Propositional Equivalence›</span></span>

<span class="keyword1"><span class="command">quotient_type</span></span> <span class="tfree">'a</span> ltl_prop_equiv_quotient <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl"</span></span> <span class="main">/</span> <span class="quoted"><span class="quoted">"<span class="keyword1">(≡<span class="hidden">⇩</span><sub>P</sub>)</span>"</span></span>
  <span class="keyword2"><span class="keyword">morphisms</span></span> Rep Abs
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ltl_prop_equiv_equivp<span class="main">)</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl_prop_equiv_quotient"</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> ltl_prop_equiv_quotient <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">equal</span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> ltl_prop_equiv_quotient_eq_test <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub> <span class="main">⇒</span> <span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ltl_prop_equiv_quotient.abs_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span>
  eq<span class="main">:</span> <span class="quoted"><span class="quoted">"equal_class.equal <span class="main">≡</span> ltl_prop_equiv_quotient_eq_test"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq ltl_prop_equiv_quotient_eq_test.rep_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> Quotient_ltl_prop_equiv_quotient Quotient_rel_rep<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="LTL_FGXU-ltl"><span class="command">lemma</span></span> ltl<span class="hidden">⇩</span><sub>P</sub>_abs_rep<span class="main">:</span> <span class="quoted"><span class="quoted">"Abs <span class="main">(</span>Rep <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Quotient3_abs_rep Quotient3_ltl_prop_equiv_quotient<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> ltl_prop_entails_abs <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl set <span class="main">⇒</span> <span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> _"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">(⊨<span class="hidden">⇩</span><sub>P</sub>)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ltl_prop_equiv_def<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> ltl_prop_implies_abs <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub> <span class="main">⇒</span> <span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">↑⟶<span class="hidden">⇩</span><sub>P</sub></span> _"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">(⟶<span class="hidden">⇩</span><sub>P</sub>)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ltl_prop_equiv_def ltl_prop_implies_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Propositional Equivalence implies LTL Equivalence›</span></span>

<span class="keyword1" id="LTL_FGXU-ltl_prop_implication_implies_ltl_implication"><span class="command">lemma</span></span> ltl_prop_implication_implies_ltl_implication<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span> <span class="main">⟹</span> <span class="free">φ</span> <span class="keyword1">⟶<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">ψ</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">⊨</span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">unfold_abs_def</span> <span class="main"><span class="main">=</span></span> <span class="quasi_keyword">false</span><span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> ltl_prop_implies_def ltl_models_equiv_prop_entailment <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="LTL_FGXU-ltl_prop_equiv_implies_ltl_equiv"><span class="command">lemma</span></span> ltl_prop_equiv_implies_ltl_equiv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">ψ</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span> <span class="main">=</span> <span class="free">w</span> <span class="main">⊨</span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ltl_prop_implication_implies_ltl_implication ltl_prop_implies_equiv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Substitution›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">subst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> ltl <span class="main">⇀</span> <span class="tfree">'a</span> ltl<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> ltl"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="keyword1">true</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="keyword1">true</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="keyword1">false</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="keyword1">false</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">and</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">and</span> <span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">or</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="keyword1">or</span> <span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">subst</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">of</span> Some <span class="bound">φ'</span> <span class="main">⇒</span> <span class="bound">φ'</span> <span class="main">|</span> None <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Based on Uwe Schoening's Translation Lemma (Logic for CS, p. 54)›</span></span>

<span class="keyword1" id="LTL_FGXU-ltl_prop_equiv_subst_S"><span class="command">lemma</span></span> ltl_prop_equiv_subst_S<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> subst <span class="free">φ</span> <span class="free">m</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">S</span> <span class="main">-</span> dom <span class="free">m</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">χ</span> <span class="main">|</span> <span class="bound">χ</span> <span class="bound">χ'</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="free">m</span> <span class="main">∧</span> <span class="free">m</span> <span class="bound">χ</span> <span class="main">=</span> Some <span class="bound">χ'</span> <span class="main">∧</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">χ'</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>

<span class="keyword1" id="LTL_FGXU-subst_respects_ltl_prop_entailment"><span class="command">lemma</span></span> subst_respects_ltl_prop_entailment<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="keyword1">⟶<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">ψ</span> <span class="main">⟹</span> subst <span class="free">φ</span> <span class="free">m</span> <span class="keyword1">⟶<span class="hidden">⇩</span><sub>P</sub></span> subst <span class="free">ψ</span> <span class="free">m</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">ψ</span> <span class="main">⟹</span> subst <span class="free">φ</span> <span class="free">m</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> subst <span class="free">ψ</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ltl_prop_equiv_def ltl_prop_implies_def ltl_prop_equiv_subst_S <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="LTL_FGXU-subst_respects_ltl_prop_entailment_generalized"><span class="command">lemma</span></span> subst_respects_ltl_prop_entailment_generalized<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">𝒜</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="bound">𝒜</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">𝒜</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">y</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">𝒜</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> subst <span class="bound">x</span> <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">𝒜</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> subst <span class="free">y</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ltl_prop_equiv_subst_S <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="LTL_FGXU-decomposable_function_subst"><span class="command">lemma</span></span> decomposable_function_subst<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">f</span> <span class="keyword1">true</span> <span class="main">=</span> <span class="keyword1">true</span><span class="main">;</span> <span class="free">f</span> <span class="keyword1">false</span> <span class="main">=</span> <span class="keyword1">false</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">φ</span> <span class="bound">ψ</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">φ</span> <span class="keyword1">and</span> <span class="bound">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">φ</span> <span class="keyword1">and</span> <span class="free">f</span> <span class="bound">ψ</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">φ</span> <span class="bound">ψ</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">φ</span> <span class="keyword1">or</span> <span class="bound">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">φ</span> <span class="keyword1">or</span> <span class="free">f</span> <span class="bound">ψ</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">φ</span> <span class="main">=</span> subst <span class="free">φ</span> <span class="main">(</span><span class="main">λ</span><span class="bound">χ</span><span class="main">.</span> Some <span class="main">(</span><span class="free">f</span> <span class="bound">χ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Additional Operators›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹And›</span></span>

<span class="keyword1" id="LTL_FGXU-foldl_LTLAnd_prop_entailment"><span class="command">lemma</span></span> foldl_LTLAnd_prop_entailment<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> foldl LTLAnd <span class="free">i</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">i</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">And</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl list <span class="main">⇒</span> <span class="tfree">'a</span> ltl"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">And</span> <span class="main">[]</span> <span class="main">=</span> <span class="keyword1">true</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">And</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> foldl LTLAnd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1" id="LTL_FGXU-And_prop_entailment"><span class="command">lemma</span></span> And_prop_entailment<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> And <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> foldl_LTLAnd_prop_entailment <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="LTL_FGXU-And_propos"><span class="command">lemma</span></span> And_propos<span class="main">:</span>
  <span class="quoted"><span class="quoted">"propos <span class="main">(</span>And <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">{</span>propos <span class="bound">x</span><span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> propos_foldl<span class="main">[</span><span class="operator">of</span> <span class="quoted">LTLAnd</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LTL_FGXU-And_semantics"><span class="command">lemma</span></span> And_semantics<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⊨</span> And <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> And_propos'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> propos <span class="bound">x</span> <span class="main">⊆</span> propos <span class="main">(</span>And <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> And_propos <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⊨</span> And <span class="free">xs</span> <span class="main">=</span> <span class="main">{</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> propos <span class="main">(</span>And <span class="free">xs</span><span class="main">)</span> <span class="main">∧</span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">χ</span><span class="main">}</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">(</span>And <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ltl_models_equiv_prop_entailment LTL_prop_entailment_restrict_to_propos <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">{</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> propos <span class="main">(</span>And <span class="free">xs</span><span class="main">)</span> <span class="main">∧</span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">χ</span><span class="main">}</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> And_prop_entailment <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">{</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> propos <span class="bound">x</span> <span class="main">∧</span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">χ</span><span class="main">}</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> LTL_prop_entailment_restrict_to_propos And_propos' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ltl_models_equiv_prop_entailment LTL_prop_entailment_restrict_to_propos <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LTL_FGXU-And_append_syntactic"><span class="command">lemma</span></span> And_append_syntactic<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> And <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> And <span class="main">(</span><span class="main">(</span>And <span class="free">xs</span><span class="main">)</span><span class="main">#</span><span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_nonempty_induct<span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="LTL_FGXU-And_append_S"><span class="command">lemma</span></span> And_append_S<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> And <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> And <span class="free">xs</span> <span class="keyword1">and</span> And <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> And_prop_entailment<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LTL_FGXU-And_append"><span class="command">lemma</span></span> And_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">"And <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> And <span class="free">xs</span> <span class="keyword1">and</span> And <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ltl_prop_equiv_def <span class="keyword1"><span class="command">using</span></span> And_append_S <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Lifted Variant›</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> and_abs <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub> <span class="main">⇒</span> <span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub> <span class="main">⇒</span> <span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub>"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">↑and</span> _"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="keyword1">and</span> <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ltl_prop_equiv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">And_abs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub> list <span class="main">⇒</span> <span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">↑And</span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">↑And</span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> foldl and_abs <span class="main">(</span>Abs <span class="keyword1">true</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1" id="LTL_FGXU-foldl_LTLAnd_prop_entailment_abs"><span class="command">lemma</span></span> foldl_LTLAnd_prop_entailment_abs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> foldl and_abs <span class="free">i</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="free">S</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">i</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> <span class="free">S</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> and_abs_def ltl_prop_entails_abs.abs_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> ltl_prop_entails_abs.rep_eq<span class="main">)</span>

<span class="keyword1" id="LTL_FGXU-And_prop_entailment_abs"><span class="command">lemma</span></span> And_prop_entailment_abs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword1">↑And</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">S</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> foldl_LTLAnd_prop_entailment_abs ltl_prop_entails_abs.abs_eq<span class="main">)</span>

<span class="keyword1" id="LTL_FGXU-and_abs_conjunction"><span class="command">lemma</span></span> and_abs_conjunction<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">φ</span> <span class="keyword1">↑and</span> <span class="free">ψ</span> <span class="main">⟷</span> <span class="free">S</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">φ</span> <span class="main">∧</span> <span class="free">S</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> and_abs.abs_eq ltl<span class="hidden">⇩</span><sub>P</sub>_abs_rep ltl_prop_entailment.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> ltl_prop_entails_abs.abs_eq<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Or›</span></span>

<span class="keyword1" id="LTL_FGXU-foldl_LTLOr_prop_entailment"><span class="command">lemma</span></span> foldl_LTLOr_prop_entailment<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> foldl LTLOr <span class="free">i</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">i</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">Or</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl list <span class="main">⇒</span> <span class="tfree">'a</span> ltl"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Or</span> <span class="main">[]</span> <span class="main">=</span> <span class="keyword1">false</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Or</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> foldl LTLOr <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1" id="LTL_FGXU-Or_prop_entailment"><span class="command">lemma</span></span> Or_prop_entailment<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Or <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> foldl_LTLOr_prop_entailment <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="LTL_FGXU-Or_propos"><span class="command">lemma</span></span> Or_propos<span class="main">:</span>
  <span class="quoted"><span class="quoted">"propos <span class="main">(</span>Or <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">{</span>propos <span class="bound">x</span><span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> propos_foldl<span class="main">[</span><span class="operator">of</span> <span class="quoted">LTLOr</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LTL_FGXU-Or_semantics"><span class="command">lemma</span></span> Or_semantics<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⊨</span> Or <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> Or_propos'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> propos <span class="bound">x</span> <span class="main">⊆</span> propos <span class="main">(</span>Or <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Or_propos <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⊨</span> Or <span class="free">xs</span> <span class="main">=</span> <span class="main">{</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> propos <span class="main">(</span>Or <span class="free">xs</span><span class="main">)</span> <span class="main">∧</span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">χ</span><span class="main">}</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">(</span>Or <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ltl_models_equiv_prop_entailment LTL_prop_entailment_restrict_to_propos <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">{</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> propos <span class="main">(</span>Or <span class="free">xs</span><span class="main">)</span> <span class="main">∧</span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">χ</span><span class="main">}</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Or_prop_entailment <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="main">{</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> propos <span class="bound">x</span> <span class="main">∧</span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">χ</span><span class="main">}</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> LTL_prop_entailment_restrict_to_propos Or_propos' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ltl_models_equiv_prop_entailment LTL_prop_entailment_restrict_to_propos <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LTL_FGXU-Or_append_syntactic"><span class="command">lemma</span></span> Or_append_syntactic<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> Or <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> Or <span class="main">(</span><span class="main">(</span>Or <span class="free">xs</span><span class="main">)</span><span class="main">#</span><span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_nonempty_induct<span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="LTL_FGXU-Or_append_S"><span class="command">lemma</span></span> Or_append_S<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Or <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Or <span class="free">xs</span> <span class="keyword1">or</span> Or <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Or_prop_entailment<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LTL_FGXU-Or_append"><span class="command">lemma</span></span> Or_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Or <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> Or <span class="free">xs</span> <span class="keyword1">or</span> Or <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ltl_prop_equiv_def <span class="keyword1"><span class="command">using</span></span> Or_append_S <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹$eval_G$›</span></span>

<span class="comment1">― ‹Partly evaluate a formula by only considering G-subformulae›</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eval<span class="hidden">⇩</span><sub>G</sub></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval<span class="hidden">⇩</span><sub>G</sub></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">and</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">eval<span class="hidden">⇩</span><sub>G</sub></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">and</span> <span class="free">eval<span class="hidden">⇩</span><sub>G</sub></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval<span class="hidden">⇩</span><sub>G</sub></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">or</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">eval<span class="hidden">⇩</span><sub>G</sub></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">or</span> <span class="free">eval<span class="hidden">⇩</span><sub>G</sub></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval<span class="hidden">⇩</span><sub>G</sub></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">(</span><span class="keyword1">G</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="keyword1">G</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="keyword1">then</span> <span class="keyword1">true</span> <span class="keyword1">else</span> <span class="keyword1">false</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval<span class="hidden">⇩</span><sub>G</sub></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>

<span class="comment1">― ‹Syntactic Properties›</span>

<span class="keyword1" id="LTL_FGXU-eval"><span class="command">lemma</span></span> eval<span class="hidden">⇩</span><sub>G</sub>_And_map<span class="main">:</span>
  <span class="quoted"><span class="quoted">"eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">S</span> <span class="main">(</span>And <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> And <span class="main">(</span>map <span class="main">(</span>eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">S</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="LTL_FGXU-eval"><span class="command">lemma</span></span> eval<span class="hidden">⇩</span><sub>G</sub>_Or_map<span class="main">:</span>
  <span class="quoted"><span class="quoted">"eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">S</span> <span class="main">(</span>Or <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> Or <span class="main">(</span>map <span class="main">(</span>eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">S</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="LTL_FGXU-eval"><span class="command">lemma</span></span> eval<span class="hidden">⇩</span><sub>G</sub>_G_nested<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="main">(</span>eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">𝒢</span> <span class="free">φ</span><span class="main">)</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="LTL_FGXU-eval"><span class="command">lemma</span></span> eval<span class="hidden">⇩</span><sub>G</sub>_subst<span class="main">:</span>
  <span class="quoted"><span class="quoted">"eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">S</span> <span class="free">φ</span> <span class="main">=</span> subst <span class="free">φ</span> <span class="main">(</span><span class="main">λ</span><span class="bound">χ</span><span class="main">.</span> Some <span class="main">(</span>eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">S</span> <span class="bound">χ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="comment1">― ‹Semantic Properties›</span>

<span class="keyword1" id="LTL_FGXU-eval"><span class="command">lemma</span></span> eval<span class="hidden">⇩</span><sub>G</sub>_prop_entailment<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">S</span> <span class="free">φ</span> <span class="main">⟷</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="LTL_FGXU-eval"><span class="command">lemma</span></span> eval<span class="hidden">⇩</span><sub>G</sub>_respectfulness<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="keyword1">⟶<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">ψ</span> <span class="main">⟹</span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">S</span> <span class="free">φ</span> <span class="keyword1">⟶<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">S</span> <span class="free">ψ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">ψ</span> <span class="main">⟹</span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">S</span> <span class="free">φ</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">S</span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> subst_respects_ltl_prop_entailment eval<span class="hidden">⇩</span><sub>G</sub>_subst <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="LTL_FGXU-eval"><span class="command">lemma</span></span> eval<span class="hidden">⇩</span><sub>G</sub>_respectfulness_generalized<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">𝒜</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="bound">𝒜</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">𝒜</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">y</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">𝒜</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">𝒜</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">P</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> subst_respects_ltl_prop_entailment_generalized<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">𝒜</span></span><span class="main">]</span> eval<span class="hidden">⇩</span><sub>G</sub>_subst<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lift_definition</span></span> eval<span class="hidden">⇩</span><sub>G</sub>_abs <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl set <span class="main">⇒</span> <span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub> <span class="main">⇒</span> <span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">↑eval<span class="hidden">⇩</span><sub>G</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">eval<span class="hidden">⇩</span><sub>G</sub></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> eval<span class="hidden">⇩</span><sub>G</sub>_respectfulness<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Finite Quotient Set›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If we restrict formulas to a finite set of propositions, the set of quotients of these is finite›</span></span>

<span class="keyword1" id="LTL_FGXU-Rep_Abs_prop_entailment"><span class="command">lemma</span></span> Rep_Abs_prop_entailment<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="main">(</span>Abs <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Quotient3_ltl_prop_equiv_quotient<span class="main">[</span><span class="operator">THEN</span> rep_abs_rsp<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ltl_prop_equiv_def<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">sat_models</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl_prop_equiv_quotient <span class="main">⇒</span> <span class="tfree">'a</span> ltl set set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sat_models</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep<span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="LTL_FGXU-sat_models_invariant"><span class="command">lemma</span></span> sat_models_invariant<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> sat_models <span class="main">(</span>Abs <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Rep_Abs_prop_entailment <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LTL_FGXU-sat_models_inj"><span class="command">lemma</span></span> sat_models_inj<span class="main">:</span>
  <span class="quoted"><span class="quoted">"inj sat_models"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Quotient3_ltl_prop_equiv_quotient<span class="main">[</span><span class="operator">THEN</span> Quotient3_rel_rep<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ltl_prop_equiv_def inj_on_def<span class="main">)</span>

<span class="keyword1" id="LTL_FGXU-sat_models_finite_image"><span class="command">lemma</span></span> sat_models_finite_image<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>sat_models <span class="main">`</span> <span class="main">{</span>Abs <span class="bound">φ</span> <span class="main">|</span> <span class="bound">φ</span><span class="main">.</span> nested_propos <span class="bound">φ</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sat_models <span class="main">(</span>Abs <span class="skolem">φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">A</span> <span class="main">∪</span> <span class="bound">B</span> <span class="main">|</span> <span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⊆</span> <span class="free">P</span> <span class="main">∧</span> <span class="bound">A</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="skolem">φ</span> <span class="main">∧</span> <span class="bound">B</span> <span class="main">⊆</span> UNIV <span class="main">-</span> <span class="free">P</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"nested_propos <span class="skolem">φ</span> <span class="main">⊆</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">φ</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> sat_models <span class="main">(</span>Abs <span class="skolem">φ</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">A</span> <span class="main">∪</span> <span class="bound">B</span> <span class="main">∈</span> sat_models <span class="main">(</span>Abs <span class="skolem">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> sat_models_invariant <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">A</span> <span class="main">|</span> <span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⊆</span> <span class="free">P</span> <span class="main">∧</span> <span class="bound">A</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="skolem">φ</span><span class="main">}</span> <span class="main">⊆</span> sat_models <span class="main">(</span>Abs <span class="skolem">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sat_models_invariant <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">⊆</span> <span class="var">?lhs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"propos <span class="skolem">φ</span> <span class="main">⊆</span> <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that propos_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">A</span> <span class="main">∪</span> <span class="bound">B</span> <span class="main">|</span> <span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⊆</span> <span class="free">P</span> <span class="main">∧</span> <span class="bound">A</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="skolem">φ</span> <span class="main">∧</span> <span class="bound">B</span> <span class="main">⊆</span> UNIV <span class="main">-</span> <span class="free">P</span><span class="main">}</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> sat_models <span class="main">(</span>Abs <span class="skolem">φ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">A</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> prems<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> prems
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="skolem">φ</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> that sat_models_invariant <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">∩</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">=</span> <span class="skolem">A</span> <span class="main">-</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="skolem">C</span> <span class="main">∪</span> <span class="skolem">D</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="skolem">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">⊆</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">⊆</span> UNIV <span class="main">-</span> <span class="free">P</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="skolem">φ</span>›</span></span> LTL_prop_entailment_restrict_to_propos <span class="quoted"><span class="quoted">‹propos <span class="skolem">φ</span> <span class="main">⊆</span> <span class="free">P</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∪</span> <span class="skolem">D</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">A</span> <span class="main">∪</span> <span class="bound">B</span> <span class="main">|</span> <span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⊆</span> <span class="free">P</span> <span class="main">∧</span> <span class="bound">A</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="skolem">φ</span> <span class="main">∧</span> <span class="bound">B</span> <span class="main">⊆</span> UNIV <span class="main">-</span> <span class="free">P</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">=</span> <span class="skolem">C</span> <span class="main">∪</span> <span class="skolem">D</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⊆</span> <span class="var">?rhs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> Equal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>sat_models <span class="main">(</span>Abs <span class="bound">φ</span><span class="main">)</span> <span class="main">|</span> <span class="bound">φ</span><span class="main">.</span> nested_propos <span class="bound">φ</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">{</span><span class="bound">A</span> <span class="main">∪</span> <span class="bound">B</span> <span class="main">|</span> <span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⊆</span> <span class="free">P</span> <span class="main">∧</span> <span class="bound">A</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">φ</span> <span class="main">∧</span> <span class="bound">B</span> <span class="main">⊆</span> UNIV <span class="main">-</span> <span class="free">P</span><span class="main">}</span> <span class="main">|</span> <span class="bound">φ</span><span class="main">.</span> nested_propos <span class="bound">φ</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> Finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">{</span><span class="bound">A</span> <span class="main">∪</span> <span class="bound">B</span> <span class="main">|</span> <span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⊆</span> <span class="free">P</span> <span class="main">∧</span> <span class="bound">A</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">φ</span> <span class="main">∧</span> <span class="bound">B</span> <span class="main">⊆</span> UNIV <span class="main">-</span> <span class="free">P</span><span class="main">}</span> <span class="main">|</span> <span class="bound">φ</span><span class="main">.</span> nested_propos <span class="bound">φ</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?map</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">P</span> <span class="bound">S</span><span class="main">.</span> <span class="main">{</span><span class="bound">A</span> <span class="main">∪</span> <span class="bound">B</span> <span class="main">|</span> <span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> <span class="bound">S</span> <span class="main">∧</span> <span class="bound">B</span> <span class="main">⊆</span> UNIV <span class="main">-</span> <span class="bound">P</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S'</span></span> <span class="keyword2"><span class="keyword">where</span></span> S'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S'</span> <span class="main">=</span> <span class="main">{</span><span class="main">{</span><span class="bound">A</span> <span class="main">∪</span> <span class="bound">B</span> <span class="main">|</span> <span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⊆</span> <span class="free">P</span> <span class="main">∧</span> <span class="bound">A</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">φ</span> <span class="main">∧</span> <span class="bound">B</span> <span class="main">⊆</span> UNIV <span class="main">-</span> <span class="free">P</span><span class="main">}</span> <span class="main">|</span> <span class="bound">φ</span><span class="main">.</span> nested_propos <span class="bound">φ</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> S_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">{</span><span class="main">{</span><span class="bound">A</span> <span class="main">|</span> <span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⊆</span> <span class="free">P</span> <span class="main">∧</span> <span class="bound">A</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">φ</span><span class="main">}</span> <span class="main">|</span> <span class="bound">φ</span><span class="main">.</span> nested_propos <span class="bound">φ</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="comment1">― ‹Prove S and ?map applied to it is finite›</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">⊆</span> Pow <span class="main">(</span>Pow <span class="free">P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">S</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">P</span>›</span></span> finite_Pow_iff infinite_super <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="var">?map</span> <span class="free">P</span> <span class="bound">A</span> <span class="main">|</span> <span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> <span class="skolem">S</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

    <span class="comment1">― ‹Prove that S' can be embedded into S using ?map›</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S'</span> <span class="main">⊆</span> <span class="main">{</span><span class="var">?map</span> <span class="free">P</span> <span class="bound">A</span> <span class="main">|</span> <span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> <span class="skolem">S</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> <span class="skolem">S'</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">φ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"nested_propos <span class="skolem">φ</span> <span class="main">⊆</span> <span class="free">P</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">{</span><span class="bound">A</span> <span class="main">∪</span> <span class="bound">B</span> <span class="main">|</span> <span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⊆</span> <span class="free">P</span> <span class="main">∧</span> <span class="bound">A</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="skolem">φ</span> <span class="main">∧</span> <span class="bound">B</span> <span class="main">⊆</span> UNIV <span class="main">-</span> <span class="free">P</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> S'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?map</span> <span class="free">P</span> <span class="main">{</span><span class="bound">A</span> <span class="main">|</span> <span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⊆</span> <span class="free">P</span> <span class="main">∧</span> <span class="bound">A</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="skolem">φ</span><span class="main">}</span> <span class="main">=</span> <span class="skolem">A</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">A</span> <span class="main">|</span> <span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⊆</span> <span class="free">P</span> <span class="main">∧</span> <span class="bound">A</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="skolem">φ</span><span class="main">}</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹nested_propos <span class="skolem">φ</span> <span class="main">⊆</span> <span class="free">P</span>›</span></span> S_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> <span class="main">{</span><span class="var">?map</span> <span class="free">P</span> <span class="bound">A</span> <span class="main">|</span> <span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> <span class="skolem">S</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> rev_finite_subset<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="main">{</span><span class="var">?map</span> <span class="free">P</span> <span class="bound">A</span> <span class="main">|</span> <span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> <span class="skolem">S</span><span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S'</span> <span class="main">⊆</span> <span class="main">{</span><span class="var">?map</span> <span class="free">P</span> <span class="bound">A</span> <span class="main">|</span> <span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> <span class="skolem">S</span><span class="main">}</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> S'_def <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> Finite2<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span>sat_models <span class="main">(</span>Abs <span class="bound">φ</span><span class="main">)</span> <span class="main">|</span> <span class="bound">φ</span><span class="main">.</span> nested_propos <span class="bound">φ</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Equal <span class="keyword1"><span class="command">using</span></span> Finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> Equal2<span class="main">:</span> <span class="quoted"><span class="quoted">"sat_models <span class="main">`</span> <span class="main">{</span>Abs <span class="bound">φ</span> <span class="main">|</span> <span class="bound">φ</span><span class="main">.</span> nested_propos <span class="bound">φ</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span>sat_models <span class="main">(</span>Abs <span class="bound">φ</span><span class="main">)</span> <span class="main">|</span> <span class="bound">φ</span><span class="main">.</span> nested_propos <span class="bound">φ</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Equal2 <span class="keyword1"><span class="command">using</span></span> Finite2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LTL_FGXU-ltl_prop_equiv_quotient_restricted_to_P_finite"><span class="command">lemma</span></span> ltl_prop_equiv_quotient_restricted_to_P_finite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span>Abs <span class="bound">φ</span> <span class="main">|</span> <span class="bound">φ</span><span class="main">.</span> nested_propos <span class="bound">φ</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on sat_models <span class="main">{</span>Abs <span class="bound">φ</span> <span class="main">|</span><span class="bound">φ</span><span class="main">.</span> nested_propos <span class="bound">φ</span> <span class="main">⊆</span> <span class="free">P</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sat_models_inj subset_inj_on <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_imageD<span class="main">[</span><span class="operator">OF</span> sat_models_finite_image<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">locale</span></span> lift_ltl_transformer <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> ltl"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    respectfulness<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">ψ</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">φ</span> <span class="free">ν</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">f</span> <span class="free">ψ</span> <span class="free">ν</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    nested_propos_bounded<span class="main">:</span> <span class="quoted"><span class="quoted">"nested_propos <span class="main">(</span><span class="free">f</span> <span class="free">φ</span> <span class="free">ν</span><span class="main">)</span> <span class="main">⊆</span> nested_propos <span class="free">φ</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> f_abs <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub>"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="free">f</span></span>
  <span class="keyword1"><span class="command">using</span></span> respectfulness <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> f_foldl_abs <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub> <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> <span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub>"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"foldl <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span> <span class="skolem">ψ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl"</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> list"</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> <span class="skolem">ψ</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"foldl <span class="free">f</span> <span class="skolem">φ</span> <span class="skolem">w</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> foldl <span class="free">f</span> <span class="skolem">ψ</span> <span class="skolem">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> respectfulness <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">φ</span></span> <span class="quoted"><span class="skolem">ψ</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LTL_FGXU-f_foldl_abs_alt_def"><span class="command">lemma</span></span> f_foldl_abs_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"f_foldl_abs <span class="main">(</span>Abs <span class="free">φ</span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span> foldl f_abs <span class="main">(</span>Abs <span class="free">φ</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="main">(</span><span class="operator">unfold</span> f_foldl_abs.abs_eq foldl.simps foldl_append<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">metis</span> f_abs.abs_eq<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">abs_reach</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl_prop_equiv_quotient <span class="main">⇒</span> <span class="tfree">'a</span> ltl_prop_equiv_quotient set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">abs_reach</span> <span class="free"><span class="bound"><span class="entity">Φ</span></span></span> <span class="main">=</span> <span class="main">{</span>foldl f_abs <span class="free"><span class="bound"><span class="entity">Φ</span></span></span> <span class="bound">w</span> <span class="main">|</span><span class="bound">w</span><span class="main">.</span> True<span class="main">}</span>"</span></span>

<span class="keyword1" id="LTL_FGXU-finite_abs_reach"><span class="command">lemma</span></span> finite_abs_reach<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>abs_reach <span class="main">(</span>Abs <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nested_propos <span class="main">(</span>foldl <span class="free">f</span> <span class="free">φ</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">⊆</span> nested_propos <span class="free">φ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> foldl_Cons nested_propos_bounded subset_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"abs_reach <span class="main">(</span>Abs <span class="free">φ</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>Abs <span class="bound">χ</span> <span class="main">|</span> <span class="bound">χ</span><span class="main">.</span> nested_propos <span class="bound">χ</span> <span class="main">⊆</span> nested_propos <span class="free">φ</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> abs_reach_def f_foldl_abs_alt_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> f_foldl_abs.abs_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ltl_prop_equiv_quotient_restricted_to_P_finite finite_propos
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="af">
<div class="head">
<h1>Theory af</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Author:      Salomon Sickert
    License:     BSD
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹af - Unfolding Functions›</span></span>

<span class="keyword1"><span class="command">theory</span></span> af
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <a href="LTL_FGXU.html">LTL_FGXU</a> <span class="quoted">"<a href="List2.html">Auxiliary/List2</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹af›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">af_letter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> ltl"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">af_letter</span> <span class="keyword1">true</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="keyword1">true</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_letter</span> <span class="keyword1">false</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="keyword1">false</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_letter</span> <span class="keyword1">p(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">then</span> <span class="keyword1">true</span> <span class="keyword1">else</span> <span class="keyword1">false</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_letter</span> <span class="main">(</span><span class="keyword1">np(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span>  <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">then</span> <span class="keyword1">true</span> <span class="keyword1">else</span> <span class="keyword1">false</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_letter</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">and</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">af_letter</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span> <span class="keyword1">and</span> <span class="main">(</span><span class="free">af_letter</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_letter</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">or</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">af_letter</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span> <span class="keyword1">or</span> <span class="main">(</span><span class="free">af_letter</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_letter</span> <span class="main">(</span><span class="keyword1">X</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_letter</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="keyword1">and</span> <span class="main">(</span><span class="free">af_letter</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_letter</span> <span class="main">(</span><span class="keyword1">F</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">F</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="keyword1">or</span> <span class="main">(</span><span class="free">af_letter</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_letter</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">U</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">U</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="keyword1">and</span> <span class="main">(</span><span class="free">af_letter</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">or</span> <span class="main">(</span><span class="free">af_letter</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">af</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl <span class="main">⇒</span> <span class="tfree">'a</span> set list <span class="main">⇒</span> <span class="tfree">'a</span> ltl"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">af</span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">af</span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> foldl af_letter <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span>"</span></span>

<span class="keyword1" id="af-af_decompose"><span class="command">lemma</span></span> af_decompose<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">af</span> <span class="main">(</span><span class="free">φ</span> <span class="keyword1">and</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">af</span> <span class="free">φ</span> <span class="free">w</span><span class="main">)</span> <span class="keyword1">and</span> <span class="main">(</span><span class="keyword1">af</span> <span class="free">ψ</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">af</span> <span class="main">(</span><span class="free">φ</span> <span class="keyword1">or</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">af</span> <span class="free">φ</span> <span class="free">w</span><span class="main">)</span> <span class="keyword1">or</span> <span class="main">(</span><span class="keyword1">af</span> <span class="free">ψ</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="af-af_simps"><span class="command">lemma</span></span> af_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">af</span> <span class="keyword1">true</span> <span class="free">w</span> <span class="main">=</span> <span class="keyword1">true</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">af</span> <span class="keyword1">false</span> <span class="free">w</span> <span class="main">=</span> <span class="keyword1">false</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">af</span> <span class="main">(</span><span class="keyword1">X</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">af</span> <span class="free">φ</span> <span class="main">(</span><span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="af-af_F"><span class="command">lemma</span></span> af_F<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">af</span> <span class="main">(</span><span class="keyword1">F</span> <span class="free">φ</span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span> Or <span class="main">(</span><span class="keyword1">F</span> <span class="free">φ</span> <span class="main">#</span> map <span class="main">(</span><span class="keyword1">af</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>suffixes <span class="free">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">af</span> <span class="main">(</span><span class="keyword1">F</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">af</span> <span class="main">(</span>af_letter <span class="main">(</span><span class="keyword1">F</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">af</span> <span class="main">(</span><span class="keyword1">F</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword1">or</span> <span class="main">(</span><span class="keyword1">af</span> <span class="main">(</span>af_letter <span class="main">(</span><span class="free">φ</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> af_decompose<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons Or_append_syntactic <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="af-af_G"><span class="command">lemma</span></span> af_G<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">af</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">φ</span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span> And <span class="main">(</span><span class="keyword1">G</span> <span class="free">φ</span> <span class="main">#</span> map <span class="main">(</span><span class="keyword1">af</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>suffixes <span class="free">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">af</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">af</span> <span class="main">(</span>af_letter <span class="main">(</span><span class="keyword1">G</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">af</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword1">and</span> <span class="main">(</span><span class="keyword1">af</span> <span class="main">(</span>af_letter <span class="main">(</span><span class="free">φ</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> af_decompose<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons Or_append_syntactic <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="af-af_U"><span class="command">lemma</span></span> af_U<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">af</span> <span class="main">(</span><span class="free">φ</span> <span class="keyword1">U</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">af</span> <span class="main">(</span><span class="free">φ</span> <span class="keyword1">U</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">xs</span> <span class="keyword1">and</span> <span class="keyword1">af</span> <span class="free">φ</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">or</span> <span class="keyword1">af</span> <span class="free">ψ</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> af_decompose<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="af-af_respectfulness"><span class="command">lemma</span></span> af_respectfulness<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="keyword1">⟶<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">ψ</span> <span class="main">⟹</span> af_letter <span class="free">φ</span> <span class="free">ν</span> <span class="keyword1">⟶<span class="hidden">⇩</span><sub>P</sub></span> af_letter <span class="free">ψ</span> <span class="free">ν</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">ψ</span> <span class="main">⟹</span> af_letter <span class="free">φ</span> <span class="free">ν</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> af_letter <span class="free">ψ</span> <span class="free">ν</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"af_letter <span class="skolem">φ</span> <span class="free">ν</span> <span class="main">=</span> subst <span class="skolem">φ</span> <span class="main">(</span><span class="main">λ</span><span class="bound">χ</span><span class="main">.</span> Some <span class="main">(</span>af_letter <span class="bound">χ</span> <span class="free">ν</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="keyword1">⟶<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">ψ</span> <span class="main">⟹</span> af_letter <span class="free">φ</span> <span class="free">ν</span> <span class="keyword1">⟶<span class="hidden">⇩</span><sub>P</sub></span> af_letter <span class="free">ψ</span> <span class="free">ν</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">ψ</span> <span class="main">⟹</span> af_letter <span class="free">φ</span> <span class="free">ν</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> af_letter <span class="free">ψ</span> <span class="free">ν</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subst_respects_ltl_prop_entailment <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="af-af_respectfulness'"><span class="command">lemma</span></span> af_respectfulness'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="keyword1">⟶<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">ψ</span> <span class="main">⟹</span> <span class="keyword1">af</span> <span class="free">φ</span> <span class="free">w</span> <span class="keyword1">⟶<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword1">af</span> <span class="free">ψ</span> <span class="free">w</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">ψ</span> <span class="main">⟹</span> <span class="keyword1">af</span> <span class="free">φ</span> <span class="free">w</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword1">af</span> <span class="free">ψ</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="free">ψ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> af_respectfulness<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="af-af_nested_propos"><span class="command">lemma</span></span> af_nested_propos<span class="main">:</span>
  <span class="quoted"><span class="quoted">"nested_propos <span class="main">(</span>af_letter <span class="free">φ</span> <span class="free">ν</span><span class="main">)</span> <span class="main">⊆</span> nested_propos <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">af<span class="hidden">⇩</span><sub>G</sub></span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">af_G_letter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> ltl"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">af_G_letter</span> <span class="keyword1">true</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="keyword1">true</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_G_letter</span> <span class="keyword1">false</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="keyword1">false</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_G_letter</span> <span class="keyword1">p(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">then</span> <span class="keyword1">true</span> <span class="keyword1">else</span> <span class="keyword1">false</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_G_letter</span> <span class="main">(</span><span class="keyword1">np(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span>  <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">then</span> <span class="keyword1">true</span> <span class="keyword1">else</span> <span class="keyword1">false</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_G_letter</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">and</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">af_G_letter</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span> <span class="keyword1">and</span> <span class="main">(</span><span class="free">af_G_letter</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_G_letter</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">or</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">af_G_letter</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span> <span class="keyword1">or</span> <span class="main">(</span><span class="free">af_G_letter</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_G_letter</span> <span class="main">(</span><span class="keyword1">X</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_G_letter</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_G_letter</span> <span class="main">(</span><span class="keyword1">F</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">F</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="keyword1">or</span> <span class="main">(</span><span class="free">af_G_letter</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_G_letter</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">U</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">U</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="keyword1">and</span> <span class="main">(</span><span class="free">af_G_letter</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">or</span> <span class="main">(</span><span class="free">af_G_letter</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">af<span class="hidden">⇩</span><sub>G</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl <span class="main">⇒</span> <span class="tfree">'a</span> set list <span class="main">⇒</span> <span class="tfree">'a</span> ltl"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">af<span class="hidden">⇩</span><sub>G</sub></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> <span class="main">(</span>foldl af_G_letter <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="af-af"><span class="command">lemma</span></span> af<span class="hidden">⇩</span><sub>G</sub>_decompose<span class="main">:</span>
  <span class="quoted"><span class="quoted">"af<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">φ</span> <span class="keyword1">and</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span> <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">w</span><span class="main">)</span> <span class="keyword1">and</span> <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="free">ψ</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"af<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">φ</span> <span class="keyword1">or</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span> <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">w</span><span class="main">)</span> <span class="keyword1">or</span> <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="free">ψ</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="af-af"><span class="command">lemma</span></span> af<span class="hidden">⇩</span><sub>G</sub>_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"af<span class="hidden">⇩</span><sub>G</sub> <span class="keyword1">true</span> <span class="free">w</span> <span class="main">=</span> <span class="keyword1">true</span>"</span></span>
  <span class="quoted"><span class="quoted">"af<span class="hidden">⇩</span><sub>G</sub> <span class="keyword1">false</span> <span class="free">w</span> <span class="main">=</span> <span class="keyword1">false</span>"</span></span>
  <span class="quoted"><span class="quoted">"af<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="keyword1">G</span> <span class="free">φ</span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span> <span class="keyword1">G</span> <span class="free">φ</span>"</span></span>
  <span class="quoted"><span class="quoted">"af<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="keyword1">X</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">=</span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="main">(</span><span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="af-af"><span class="command">lemma</span></span> af<span class="hidden">⇩</span><sub>G</sub>_F<span class="main">:</span>
  <span class="quoted"><span class="quoted">"af<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="keyword1">F</span> <span class="free">φ</span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span> Or <span class="main">(</span><span class="keyword1">F</span> <span class="free">φ</span> <span class="main">#</span> map <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>suffixes <span class="free">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"af<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="keyword1">F</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> af<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>af_G_letter <span class="main">(</span><span class="keyword1">F</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="keyword1">F</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword1">or</span> <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>af_G_letter <span class="main">(</span><span class="free">φ</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> af<span class="hidden">⇩</span><sub>G</sub>_decompose<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons Or_append_syntactic <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="af-af"><span class="command">lemma</span></span> af<span class="hidden">⇩</span><sub>G</sub>_U<span class="main">:</span>
  <span class="quoted"><span class="quoted">"af<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">φ</span> <span class="keyword1">U</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">φ</span> <span class="keyword1">U</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">xs</span> <span class="keyword1">and</span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">or</span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">ψ</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> af<span class="hidden">⇩</span><sub>G</sub>_decompose<span class="main">)</span>

<span class="keyword1" id="af-af"><span class="command">lemma</span></span> af<span class="hidden">⇩</span><sub>G</sub>_subsequence_U<span class="main">:</span>
  <span class="quoted"><span class="quoted">"af<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">φ</span> <span class="keyword1">U</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> Suc <span class="free">n</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="free">φ</span> <span class="keyword1">U</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="main">1</span> <span class="main">→</span> Suc <span class="free">n</span><span class="main">]</span><span class="main">)</span> <span class="keyword1">and</span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> Suc <span class="free">n</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">or</span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">ψ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> Suc <span class="free">n</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="free">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> Suc <span class="bound">n</span><span class="main">]</span> <span class="main">=</span> <span class="free">w</span> <span class="main">0</span> <span class="main">#</span> <span class="free">w</span> <span class="main">[</span><span class="main">1</span> <span class="main">→</span> Suc <span class="bound">n</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subsequence_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="main">1</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subsequence_def upt_conv_Cons<span class="main">)</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> af<span class="hidden">⇩</span><sub>G</sub>_U <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="af-af_G_respectfulness"><span class="command">lemma</span></span> af_G_respectfulness<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="keyword1">⟶<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">ψ</span> <span class="main">⟹</span> af_G_letter <span class="free">φ</span> <span class="free">ν</span> <span class="keyword1">⟶<span class="hidden">⇩</span><sub>P</sub></span> af_G_letter <span class="free">ψ</span> <span class="free">ν</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">ψ</span> <span class="main">⟹</span> af_G_letter <span class="free">φ</span> <span class="free">ν</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> af_G_letter <span class="free">ψ</span> <span class="free">ν</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"af_G_letter <span class="skolem">φ</span> <span class="free">ν</span> <span class="main">=</span> subst <span class="skolem">φ</span> <span class="main">(</span><span class="main">λ</span><span class="bound">χ</span><span class="main">.</span> Some <span class="main">(</span>af_G_letter <span class="bound">χ</span> <span class="free">ν</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="keyword1">⟶<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">ψ</span> <span class="main">⟹</span> af_G_letter <span class="free">φ</span> <span class="free">ν</span> <span class="keyword1">⟶<span class="hidden">⇩</span><sub>P</sub></span> af_G_letter <span class="free">ψ</span> <span class="free">ν</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">ψ</span> <span class="main">⟹</span> af_G_letter <span class="free">φ</span> <span class="free">ν</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> af_G_letter <span class="free">ψ</span> <span class="free">ν</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subst_respects_ltl_prop_entailment <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="af-af_G_respectfulness'"><span class="command">lemma</span></span> af_G_respectfulness'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="keyword1">⟶<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">ψ</span> <span class="main">⟹</span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">w</span> <span class="keyword1">⟶<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">ψ</span> <span class="free">w</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">ψ</span> <span class="main">⟹</span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">w</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">ψ</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="free">ψ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> af_G_respectfulness<span class="main"><span class="keyword3">,</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span> 

<span class="keyword1" id="af-af_G_nested_propos"><span class="command">lemma</span></span> af_G_nested_propos<span class="main">:</span>
  <span class="quoted"><span class="quoted">"nested_propos <span class="main">(</span>af_G_letter <span class="free">φ</span> <span class="free">ν</span><span class="main">)</span> <span class="main">⊆</span> nested_propos <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="af-af_G_letter_sat_core"><span class="command">lemma</span></span> af_G_letter_sat_core<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Only_G <span class="free">𝒢</span> <span class="main">⟹</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">φ</span> <span class="main">⟹</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af_G_letter <span class="free">φ</span> <span class="free">ν</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="af-af"><span class="command">lemma</span></span> af<span class="hidden">⇩</span><sub>G</sub>_sat_core<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Only_G <span class="free">𝒢</span> <span class="main">⟹</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">φ</span> <span class="main">⟹</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> af_G_letter_sat_core <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="af-af"><span class="command">lemma</span></span> af<span class="hidden">⇩</span><sub>G</sub>_sat_core_generalized<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Only_G <span class="free">𝒢</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="free">j</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> af<span class="hidden">⇩</span><sub>G</sub>_sat_core foldl_append subsequence_append le_add_diff_inverse<span class="main">)</span>

<span class="keyword1" id="af-af"><span class="command">lemma</span></span> af<span class="hidden">⇩</span><sub>G</sub>_eval<span class="hidden">⇩</span><sub>G</sub><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Only_G <span class="free">𝒢</span> <span class="main">⟹</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">𝒢</span> <span class="free">φ</span><span class="main">)</span> <span class="free">w</span> <span class="main">⟷</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">𝒢</span> <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">w</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval<span class="hidden">⇩</span><sub>G</sub>_prop_entailment af<span class="hidden">⇩</span><sub>G</sub>_decompose<span class="main">)</span>

<span class="keyword1" id="af-af"><span class="command">lemma</span></span> af<span class="hidden">⇩</span><sub>G</sub>_keeps_F_and_S<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="keyword1">F</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">ys</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>suffixes <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> suffixes_append map_append
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> List.list_nonempty_induct<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> af<span class="hidden">⇩</span><sub>G</sub>_F Or_prop_entailment <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹G-Subformulae Simplification›</span></span>

<span class="keyword1" id="af-G_af_simp"><span class="command">lemma</span></span> G_af_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="main">(</span><span class="keyword1">af</span> <span class="free">φ</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span> <span class="skolem">ν</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="main">(</span>af_letter <span class="skolem">φ</span> <span class="skolem">ν</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="af-G_af"><span class="command">lemma</span></span> G_af<span class="hidden">⇩</span><sub>G</sub>_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span> <span class="skolem">ν</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="main">(</span>af_G_letter <span class="skolem">φ</span> <span class="skolem">ν</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="operator">auto</span> <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Relation between af and $af_G$›</span></span>

<span class="keyword1" id="af-af_G_letter_free_F"><span class="command">lemma</span></span> af_G_letter_free_F<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="main">(</span>af_letter <span class="free">φ</span> <span class="free">ν</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="main">(</span>af_G_letter <span class="free">φ</span> <span class="free">ν</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="af-af_G_free"><span class="command">lemma</span></span> af_G_free<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">af</span> <span class="free">φ</span> <span class="free">w</span> <span class="main">=</span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">af</span> <span class="main">(</span>af_letter <span class="skolem">φ</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">xs</span> <span class="main">=</span> af<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>af_letter <span class="skolem">φ</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> af_G_letter_free_F<span class="main">[</span><span class="operator">OF</span> Cons.prems<span class="main">,</span> <span class="operator">THEN</span> Cons.IH<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"af_letter <span class="skolem">φ</span> <span class="skolem">x</span> <span class="main">=</span> af_G_letter <span class="skolem">φ</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="af-af_equals_af"><span class="command">lemma</span></span> af_equals_af<span class="hidden">⇩</span><sub>G</sub>_base_cases<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">af</span> <span class="keyword1">true</span> <span class="free">w</span> <span class="main">=</span> af<span class="hidden">⇩</span><sub>G</sub> <span class="keyword1">true</span> <span class="free">w</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">af</span> <span class="keyword1">false</span> <span class="free">w</span> <span class="main">=</span> af<span class="hidden">⇩</span><sub>G</sub> <span class="keyword1">false</span> <span class="free">w</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">af</span> <span class="keyword1">p(</span><span class="free">a</span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span> af<span class="hidden">⇩</span><sub>G</sub> <span class="keyword1">p(</span><span class="free">a</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">af</span> <span class="main">(</span><span class="keyword1">np(</span><span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span> af<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="keyword1">np(</span><span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> af_G_free<span class="main">)</span>

<span class="keyword1" id="af-af_implies_af"><span class="command">lemma</span></span> af_implies_af<span class="hidden">⇩</span><sub>G</sub><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword1">af</span> <span class="free">φ</span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af_letter <span class="main">(</span><span class="keyword1">af</span> <span class="free">φ</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af_letter <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> af_respectfulness<span class="main">(</span>1<span class="main">)</span> snoc.IH <span class="keyword1"><span class="command">unfolding</span></span> ltl_prop_implies_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ν</span><span class="main">.</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af_letter <span class="skolem">φ</span> <span class="bound">ν</span> <span class="main">⟹</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af_G_letter <span class="skolem">φ</span> <span class="bound">ν</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc.prems foldl_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="af-af_implies_af"><span class="command">lemma</span></span> af_implies_af<span class="hidden">⇩</span><sub>G</sub>_2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">af</span> <span class="free">φ</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">⊨</span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ltl_prop_implication_implies_ltl_implication af_implies_af<span class="hidden">⇩</span><sub>G</sub> ltl_prop_implies_def<span class="main">)</span>

<span class="keyword1" id="af-af"><span class="command">lemma</span></span> af<span class="hidden">⇩</span><sub>G</sub>_implies_af_eval<span class="hidden">⇩</span><sub>G</sub>'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">𝒢</span> <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ψ</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="free">𝒢</span> <span class="main">⟹</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword1">G</span> <span class="bound">ψ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ψ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="free">𝒢</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">w</span> <span class="main">⟹</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">𝒢</span> <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="bound">ψ</span> <span class="main">(</span>drop <span class="bound">i</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword1">af</span> <span class="free">φ</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LTLGlobal <span class="skolem">φ</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">G</span> <span class="skolem">φ</span> <span class="main">∈</span> <span class="free">𝒢</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> af<span class="hidden">⇩</span><sub>G</sub>_simps eval<span class="hidden">⇩</span><sub>G</sub>.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="keyword1">G</span> <span class="skolem">φ</span> <span class="main">∈</span> <span class="free">𝒢</span>"</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword1">G</span> <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> LTLGlobal <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span><span class="keyword1">af</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">(</span>suffixes <span class="skolem">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="keyword1">af</span> <span class="skolem">φ</span> <span class="skolem">w'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="main">∈</span> set <span class="main">(</span>suffixes <span class="skolem">w</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="main">=</span> drop <span class="skolem">i</span> <span class="skolem">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">w</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> suffixes_alt_def subsequence_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">𝒢</span> <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ</span> <span class="skolem">w'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> LTLGlobal.prems <span class="quoted"><span class="quoted">‹<span class="keyword1">G</span> <span class="skolem">φ</span> <span class="main">∈</span> <span class="free">𝒢</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> LTLGlobal<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">𝒢</span> <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ</span> <span class="skolem">w'</span><span class="main">)</span>›</span></span><span class="main">]</span> LTLGlobal<span class="main">(</span>3-4<span class="main">)</span> drop_drop
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="keyword1">af</span> <span class="skolem">φ</span> <span class="skolem">w'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">w'</span> <span class="main">=</span> drop <span class="skolem">i</span> <span class="skolem">w</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> af_G eval<span class="hidden">⇩</span><sub>G</sub>_And_map And_prop_entailment <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LTLFinal <span class="skolem">φ</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="main">(</span><span class="keyword1">F</span> <span class="skolem">φ</span> <span class="main">#</span> map <span class="main">(</span>eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">𝒢</span> <span class="keyword1">o</span> af<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ</span><span class="main">)</span> <span class="main">(</span>suffixes <span class="skolem">w</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Or_prop_entailment af<span class="hidden">⇩</span><sub>G</sub>_F eval<span class="hidden">⇩</span><sub>G</sub>_Or_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span><span class="keyword1">F</span> <span class="skolem">φ</span> <span class="main">#</span> map <span class="main">(</span><span class="keyword1">af</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">(</span>suffixes <span class="skolem">w</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> <span class="keyword1">F</span> <span class="skolem">φ</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">𝒢</span> <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ</span> <span class="skolem">w'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="main">∈</span> set <span class="main">(</span>suffixes <span class="skolem">w</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> x_def <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="skolem">x</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ψ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="free">𝒢</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">w'</span> <span class="main">⟹</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">𝒢</span> <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="bound">ψ</span> <span class="main">(</span>drop <span class="bound">i</span> <span class="skolem">w'</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> LTLFinal.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> suffixes_alt_def subsequence_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ψ</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="free">𝒢</span> <span class="main">⟹</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">𝒢</span> <span class="main">(</span><span class="keyword1">G</span> <span class="bound">ψ</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> LTLFinal <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword1">af</span> <span class="skolem">φ</span> <span class="skolem">w'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> LTLFinal.IH<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">𝒢</span> <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ</span> <span class="skolem">w'</span><span class="main">)</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">w'</span> <span class="main">∈</span> set <span class="main">(</span>suffixes <span class="skolem">w</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> af_F Or_prop_entailment eval<span class="hidden">⇩</span><sub>G</sub>_Or_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LTLNext <span class="skolem">φ</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">w</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ψ</span> <span class="skolem">i</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">G</span> <span class="skolem">ψ</span> <span class="main">∈</span> <span class="free">𝒢</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">𝒢</span> <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">ψ</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> LTLNext.prems <span class="keyword1"><span class="command">unfolding</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">𝒢</span> <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">ψ</span> <span class="main">(</span>drop <span class="skolem">i</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ψ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="free">𝒢</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">xs</span> <span class="main">⟹</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">𝒢</span> <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="bound">ψ</span> <span class="main">(</span>drop <span class="bound">i</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> LTLNext Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LTLUntil <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">w</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">𝒢</span> <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">ψ</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ψ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="free">𝒢</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">𝒢</span> <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="bound">ψ</span> <span class="main">(</span>drop <span class="bound">i</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">ultimately</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword1">af</span> <span class="skolem">ψ</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> af_U <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">𝒢</span> <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="skolem">φ</span> <span class="keyword1">U</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">𝒢</span> <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ψ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="free">𝒢</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">𝒢</span> <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="bound">ψ</span> <span class="main">(</span>drop <span class="bound">i</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">ultimately</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword1">af</span> <span class="skolem">φ</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword1">af</span> <span class="main">(</span><span class="skolem">φ</span> <span class="keyword1">U</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>  
            <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span> 
          <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> af_U <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> af<span class="hidden">⇩</span><sub>G</sub>_U <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LTLProp <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">w</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> LTLProp <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="skolem">x</span>"</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LTLPropNeg <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">w</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> LTLPropNeg <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="skolem">x</span>"</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">unfold</span> af_equals_af<span class="hidden">⇩</span><sub>G</sub>_base_cases af<span class="hidden">⇩</span><sub>G</sub>_decompose af_decompose<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="af-af"><span class="command">lemma</span></span> af<span class="hidden">⇩</span><sub>G</sub>_implies_af_eval<span class="hidden">⇩</span><sub>G</sub><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">𝒢</span> <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="main">0</span><span class="main">→</span><span class="free">j</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ψ</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="free">𝒢</span> <span class="main">⟹</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword1">G</span> <span class="bound">ψ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ψ</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="free">𝒢</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">𝒢</span> <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="bound">ψ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="bound">i</span> <span class="main">→</span> <span class="free">j</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword1">af</span> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="main">0</span><span class="main">→</span><span class="free">j</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> af<span class="hidden">⇩</span><sub>G</sub>_implies_af_eval<span class="hidden">⇩</span><sub>G</sub>'<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">unfolded</span> subsequence_length subsequence_drop<span class="main">]</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Continuation›</span></span>

<span class="comment1">― ‹af fulfills the infinite continuation w' of a word after skipping some finite prefix w.
    Corresponds to Lemma 7 in arXiv: 1402.3388v2›</span>

<span class="keyword1" id="af-af_ltl_continuation"><span class="command">lemma</span></span> af_ltl_continuation<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">w</span> <span class="main">⌢</span> <span class="free">w'</span><span class="main">)</span> <span class="main">⊨</span> <span class="free">φ</span> <span class="main">⟷</span> <span class="free">w'</span> <span class="main">⊨</span> <span class="keyword1">af</span> <span class="free">φ</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="free">w'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">⌢</span> <span class="skolem">w'</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> conc_def nth_Cons_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"suffix <span class="main">1</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">⌢</span> <span class="skolem">w'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">⌢</span> <span class="skolem">w'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> suffix_def conc_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">⊨</span> <span class="skolem">φ</span> <span class="main">⟷</span> suffix <span class="main">1</span> <span class="bound">w</span> <span class="main">⊨</span> af_letter <span class="skolem">φ</span> <span class="main">(</span><span class="bound">w</span> <span class="main">0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="operator">unfold</span> LTL_F_one_step_unfolding LTL_G_one_step_unfolding LTL_U_one_step_unfolding<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">⌢</span> <span class="skolem">w'</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">φ</span> <span class="main">⟷</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">⌢</span> <span class="skolem">w'</span><span class="main">)</span> <span class="main">⊨</span> af_letter <span class="skolem">φ</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="skolem">w'</span> <span class="main">⊨</span> <span class="keyword1">af</span> <span class="skolem">φ</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="af-af_ltl_continuation_suffix"><span class="command">lemma</span></span> af_ltl_continuation_suffix<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span> <span class="main">⟷</span> suffix <span class="free">i</span> <span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">af</span> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span><span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> af_ltl_continuation prefix_suffix subsequence_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="af-af_G_ltl_continuation"><span class="command">lemma</span></span> af_G_ltl_continuation<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ψ</span> <span class="main">∈</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span><span class="main">.</span> <span class="free">w'</span> <span class="main">⊨</span> <span class="bound">ψ</span> <span class="main">=</span> <span class="main">(</span><span class="free">w</span> <span class="main">⌢</span> <span class="free">w'</span><span class="main">)</span> <span class="main">⊨</span> <span class="bound">ψ</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">w</span> <span class="main">⌢</span> <span class="free">w'</span><span class="main">)</span> <span class="main">⊨</span> <span class="free">φ</span> <span class="main">⟷</span> <span class="free">w'</span> <span class="main">⊨</span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w'</span></span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ψ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl"</span></span> <span class="keyword3"><span class="command">fix</span></span>  <span class="skolem">w</span> <span class="skolem">w'</span> <span class="skolem">w''</span> 
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w''</span> <span class="main">⊨</span> <span class="keyword1">G</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">w</span> <span class="main">@</span> <span class="skolem">w'</span><span class="main">)</span> <span class="main">⌢</span> <span class="skolem">w''</span><span class="main">)</span> <span class="main">⊨</span> <span class="keyword1">G</span> <span class="skolem">ψ</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w''</span> <span class="main">⊨</span> <span class="keyword1">G</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">w'</span> <span class="main">⌢</span>  <span class="skolem">w''</span><span class="main">)</span> <span class="main">⊨</span> <span class="keyword1">G</span> <span class="skolem">ψ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w'</span> <span class="main">⌢</span> <span class="skolem">w''</span><span class="main">)</span> <span class="main">⊨</span> <span class="keyword1">G</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">w</span> <span class="main">@</span> <span class="skolem">w'</span><span class="main">)</span> <span class="main">⌢</span> <span class="skolem">w''</span><span class="main">)</span> <span class="main">⊨</span> <span class="keyword1">G</span> <span class="skolem">ψ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">w'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> LTL_suffix_G suffix_conc_length conc_conc<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">note</span></span> G_stable <span class="main">=</span> this
    <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ψ</span><span class="main">∈</span><span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> <span class="skolem">w'</span> <span class="main">⊨</span> <span class="bound">ψ</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">⌢</span> <span class="skolem">w'</span><span class="main">)</span> <span class="main">⊨</span> <span class="bound">ψ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> G_stable<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">w'</span></span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span><span class="main">]</span> Cons.prems <span class="keyword1"><span class="command">unfolding</span></span> G_af<span class="hidden">⇩</span><sub>G</sub>_simp conc_conc append.simps <span class="keyword1"><span class="command">unfolding</span></span> G_nested_propos_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ψ</span><span class="main">∈</span><span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="skolem">φ</span><span class="main">.</span> <span class="main">(</span><span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">⌢</span> <span class="skolem">xs</span> <span class="main">⌢</span> <span class="skolem">w'</span><span class="main">)</span> <span class="main">⊨</span> <span class="bound">ψ</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">⌢</span> <span class="skolem">w'</span><span class="main">)</span> <span class="main">⊨</span> <span class="bound">ψ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> G_stable<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">w'</span></span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span><span class="main">]</span> Cons.prems <span class="keyword1"><span class="command">unfolding</span></span> conc_conc append.simps <span class="keyword1"><span class="command">unfolding</span></span> G_nested_propos_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">⌢</span> <span class="skolem">xs</span> <span class="main">⌢</span> <span class="skolem">w'</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">φ</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">⌢</span> <span class="skolem">w'</span><span class="main">)</span> <span class="main">⊨</span> af<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LTLFinal <span class="skolem">φ</span><span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> LTL_F_one_step_unfolding
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> suffix_conc_length<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LTLUntil <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> LTL_U_one_step_unfolding
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> suffix_conc_length<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> conc_fst<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span><span class="main"><span class="main">]</span></span> suffix_conc_length<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">w'</span> <span class="main">⊨</span> af<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"af<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="skolem">w'</span></span><span class="main">]</span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> conc_conc 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="af-af"><span class="command">lemma</span></span> af<span class="hidden">⇩</span><sub>G</sub>_ltl_continuation_suffix<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ψ</span> <span class="main">∈</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span><span class="main">.</span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">ψ</span> <span class="main">=</span> <span class="main">(</span>suffix <span class="free">i</span> <span class="free">w</span><span class="main">)</span> <span class="main">⊨</span> <span class="bound">ψ</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span> <span class="main">⟷</span> suffix <span class="free">i</span> <span class="free">w</span> <span class="main">⊨</span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> af_G_ltl_continuation<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">φ</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"suffix <span class="free"><span class="free"><span class="free">i</span></span></span> <span class="free"><span class="free"><span class="free">w</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> prefix_suffix subsequence_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Eager Unfolding <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="keyword1"><span class="quoted"><span class="keyword1">af</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">af<span class="hidden">⇩</span><sub>G</sub></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span> 

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">Unf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl <span class="main">⇒</span> <span class="tfree">'a</span> ltl"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Unf</span> <span class="main">(</span><span class="keyword1">F</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">F</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">or</span> <span class="free">Unf</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Unf</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">G</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">and</span> <span class="free">Unf</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Unf</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">U</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">U</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="keyword1">and</span> <span class="free">Unf</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="keyword1">or</span> <span class="free">Unf</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Unf</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">and</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">Unf</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">and</span> <span class="free">Unf</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Unf</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">or</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">Unf</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">or</span> <span class="free">Unf</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Unf</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">Unf<span class="hidden">⇩</span><sub>G</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl <span class="main">⇒</span> <span class="tfree">'a</span> ltl"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Unf<span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span><span class="keyword1">F</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">F</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">or</span> <span class="free">Unf<span class="hidden">⇩</span><sub>G</sub></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Unf<span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span><span class="keyword1">G</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">G</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span> 
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Unf<span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">U</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">U</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="keyword1">and</span> <span class="free">Unf<span class="hidden">⇩</span><sub>G</sub></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="keyword1">or</span> <span class="free">Unf<span class="hidden">⇩</span><sub>G</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Unf<span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">and</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">Unf<span class="hidden">⇩</span><sub>G</sub></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">and</span> <span class="free">Unf<span class="hidden">⇩</span><sub>G</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Unf<span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">or</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">Unf<span class="hidden">⇩</span><sub>G</sub></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">or</span> <span class="free">Unf<span class="hidden">⇩</span><sub>G</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Unf<span class="hidden">⇩</span><sub>G</sub></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">step</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> ltl"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="keyword1">p(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">then</span> <span class="keyword1">true</span> <span class="keyword1">else</span> <span class="keyword1">false</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="main">(</span><span class="keyword1">np(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">then</span> <span class="keyword1">true</span> <span class="keyword1">else</span> <span class="keyword1">false</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="main">(</span><span class="keyword1">X</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">and</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="free">step</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">and</span> <span class="free">step</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">or</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="free">step</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">or</span> <span class="free">step</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">af_letter_opt</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">af_letter_opt</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> Unf <span class="main">(</span>step <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">af_G_letter_opt</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">af_G_letter_opt</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> Unf<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>step <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">af_opt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl <span class="main">⇒</span> <span class="tfree">'a</span> set list <span class="main">⇒</span> <span class="tfree">'a</span> ltl"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">af<span class="hidden">⇩</span><sub>𝔘</sub></span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">af<span class="hidden">⇩</span><sub>𝔘</sub></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> <span class="main">(</span>foldl af_letter_opt <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">af_G_opt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl <span class="main">⇒</span> <span class="tfree">'a</span> set list <span class="main">⇒</span> <span class="tfree">'a</span> ltl"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">af<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>𝔘</sub></span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">af<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>𝔘</sub></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> <span class="main">(</span>foldl af_G_letter_opt <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="af-af_letter_alt_def"><span class="command">lemma</span></span> af_letter_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"af_letter <span class="free">φ</span> <span class="free">ν</span> <span class="main">=</span> step <span class="main">(</span>Unf <span class="free">φ</span><span class="main">)</span> <span class="free">ν</span>"</span></span>
  <span class="quoted"><span class="quoted">"af_G_letter <span class="free">φ</span> <span class="free">ν</span> <span class="main">=</span> step <span class="main">(</span>Unf<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span><span class="main">)</span> <span class="free">ν</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="af-af_to_af_opt"><span class="command">lemma</span></span> af_to_af_opt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Unf <span class="main">(</span><span class="keyword1">af</span> <span class="free">φ</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">af<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">(</span>Unf <span class="free">φ</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="quoted"><span class="quoted">"Unf<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">af<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">(</span>Unf<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> af_letter_alt_def<span class="main">)</span>

<span class="keyword1" id="af-af_equiv"><span class="command">lemma</span></span> af_equiv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">af</span> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span> <span class="main">@</span> <span class="main">[</span><span class="free">ν</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> step <span class="main">(</span><span class="keyword1">af<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">(</span>Unf <span class="free">φ</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span> <span class="free">ν</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> af_to_af_opt<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> af_letter_alt_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> foldl_Cons foldl_Nil foldl_append<span class="main">)</span>

<span class="keyword1" id="af-af_equiv'"><span class="command">lemma</span></span> af_equiv'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">af</span> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> Suc <span class="free">i</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> step <span class="main">(</span><span class="keyword1">af<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">(</span>Unf <span class="free">φ</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> af_equiv <span class="keyword1"><span class="command">unfolding</span></span> subsequence_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lifted Functions›</span></span>

<span class="keyword1" id="af-respectfulness"><span class="command">lemma</span></span> respectfulness<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="keyword1">⟶<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">ψ</span> <span class="main">⟹</span> af_letter_opt <span class="free">φ</span> <span class="free">ν</span> <span class="keyword1">⟶<span class="hidden">⇩</span><sub>P</sub></span> af_letter_opt <span class="free">ψ</span> <span class="free">ν</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">ψ</span> <span class="main">⟹</span> af_letter_opt <span class="free">φ</span> <span class="free">ν</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> af_letter_opt <span class="free">ψ</span> <span class="free">ν</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="keyword1">⟶<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">ψ</span> <span class="main">⟹</span> af_G_letter_opt <span class="free">φ</span> <span class="free">ν</span> <span class="keyword1">⟶<span class="hidden">⇩</span><sub>P</sub></span> af_G_letter_opt <span class="free">ψ</span> <span class="free">ν</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">ψ</span> <span class="main">⟹</span> af_G_letter_opt <span class="free">φ</span> <span class="free">ν</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> af_G_letter_opt <span class="free">ψ</span> <span class="free">ν</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="keyword1">⟶<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">ψ</span> <span class="main">⟹</span> step <span class="free">φ</span> <span class="free">ν</span> <span class="keyword1">⟶<span class="hidden">⇩</span><sub>P</sub></span> step <span class="free">ψ</span> <span class="free">ν</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">ψ</span> <span class="main">⟹</span> step <span class="free">φ</span> <span class="free">ν</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> step <span class="free">ψ</span> <span class="free">ν</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="keyword1">⟶<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">ψ</span> <span class="main">⟹</span> Unf <span class="free">φ</span> <span class="keyword1">⟶<span class="hidden">⇩</span><sub>P</sub></span> Unf <span class="free">ψ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">ψ</span> <span class="main">⟹</span> Unf <span class="free">φ</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> Unf <span class="free">ψ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="keyword1">⟶<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">ψ</span> <span class="main">⟹</span> Unf<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="keyword1">⟶<span class="hidden">⇩</span><sub>P</sub></span> Unf<span class="hidden">⇩</span><sub>G</sub> <span class="free">ψ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">ψ</span> <span class="main">⟹</span> Unf<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> Unf<span class="hidden">⇩</span><sub>G</sub> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> decomposable_function_subst<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">χ</span><span class="main">.</span> af_letter_opt <span class="bound">χ</span> <span class="free">ν</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> af_letter_opt.simps
  <span class="keyword1"><span class="command">using</span></span> decomposable_function_subst<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">χ</span><span class="main">.</span> af_G_letter_opt <span class="bound">χ</span> <span class="free">ν</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> af_G_letter_opt.simps
  <span class="keyword1"><span class="command">using</span></span> decomposable_function_subst<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">χ</span><span class="main">.</span> step <span class="bound">χ</span> <span class="free">ν</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> decomposable_function_subst<span class="main">[</span><span class="operator">of</span> <span class="quoted">Unf</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> 
  <span class="keyword1"><span class="command">using</span></span> decomposable_function_subst<span class="main">[</span><span class="operator">of</span> <span class="quoted">Unf<span class="hidden">⇩</span><sub>G</sub></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> subst_respects_ltl_prop_entailment <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="af-nested_propos"><span class="command">lemma</span></span> nested_propos<span class="main">:</span>
  <span class="quoted"><span class="quoted">"nested_propos <span class="main">(</span>step <span class="free">φ</span> <span class="free">ν</span><span class="main">)</span> <span class="main">⊆</span> nested_propos <span class="free">φ</span>"</span></span>
  <span class="quoted"><span class="quoted">"nested_propos <span class="main">(</span>Unf <span class="free">φ</span><span class="main">)</span> <span class="main">⊆</span> nested_propos <span class="free">φ</span>"</span></span>
  <span class="quoted"><span class="quoted">"nested_propos <span class="main">(</span>Unf<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span><span class="main">)</span> <span class="main">⊆</span> nested_propos <span class="free">φ</span>"</span></span>
  <span class="quoted"><span class="quoted">"nested_propos <span class="main">(</span>af_letter_opt <span class="free">φ</span> <span class="free">ν</span><span class="main">)</span> <span class="main">⊆</span> nested_propos <span class="free">φ</span>"</span></span>
  <span class="quoted"><span class="quoted">"nested_propos <span class="main">(</span>af_G_letter_opt <span class="free">φ</span> <span class="free">ν</span><span class="main">)</span> <span class="main">⊆</span> nested_propos <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lift functions and bind to new names›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> af_abs<span class="main">:</span> lift_ltl_transformer <span class="quoted">af_letter</span>
  <span class="keyword1"><span class="command">using</span></span> lift_ltl_transformer_def af_respectfulness af_nested_propos <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">af_letter_abs</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">↑af</span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">↑af</span></span> <span class="main">≡</span> af_abs.f_abs"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> af_G_abs<span class="main">:</span> lift_ltl_transformer <span class="quoted">af_G_letter</span>
  <span class="keyword1"><span class="command">using</span></span> lift_ltl_transformer_def af_G_respectfulness af_G_nested_propos <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">af_G_letter_abs</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub></span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">↑af<span class="hidden">⇩</span><sub>G</sub></span></span> <span class="main">≡</span> af_G_abs.f_abs"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> af_abs_opt<span class="main">:</span> lift_ltl_transformer <span class="quoted">af_letter_opt</span>
  <span class="keyword1"><span class="command">using</span></span> lift_ltl_transformer_def respectfulness nested_propos <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">af_letter_abs_opt</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">↑af<span class="hidden">⇩</span><sub>𝔘</sub></span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">↑af<span class="hidden">⇩</span><sub>𝔘</sub></span></span> <span class="main">≡</span> af_abs_opt.f_abs"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> af_G_abs_opt<span class="main">:</span> lift_ltl_transformer <span class="quoted">af_G_letter_opt</span>
  <span class="keyword1"><span class="command">using</span></span> lift_ltl_transformer_def respectfulness nested_propos <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">af_G_letter_abs_opt</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>𝔘</sub></span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">↑af<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>𝔘</sub></span></span> <span class="main">≡</span> af_G_abs_opt.f_abs"</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> step_abs <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">↑step</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">step</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> respectfulness<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> Unf_abs <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub> <span class="main">⇒</span> <span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">↑Unf</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">Unf</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> respectfulness<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> Unf<span class="hidden">⇩</span><sub>G</sub>_abs <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub> <span class="main">⇒</span> <span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">↑Unf<span class="hidden">⇩</span><sub>G</sub></span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">Unf<span class="hidden">⇩</span><sub>G</sub></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> respectfulness<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Properties›</span></span>

<span class="keyword1" id="af-af_G_letter_opt_sat_core"><span class="command">lemma</span></span> af_G_letter_opt_sat_core<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Only_G <span class="free">𝒢</span> <span class="main">⟹</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">φ</span> <span class="main">⟹</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af_G_letter_opt <span class="free">φ</span> <span class="free">ν</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span> 

<span class="keyword1" id="af-af_G_letter_sat_core_lifted"><span class="command">lemma</span></span> af_G_letter_sat_core_lifted<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Only_G <span class="free">𝒢</span> <span class="main">⟹</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="free">φ</span> <span class="main">⟹</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="main">(</span>af_G_letter_abs <span class="free">φ</span> <span class="free">ν</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> af_G_letter_sat_core Quotient_ltl_prop_equiv_quotient<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> Quotient_rep_abs<span class="main"><span class="main">]</span></span> Quotient3_ltl_prop_equiv_quotient<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> Quotient3_abs_rep<span class="main"><span class="main">]</span></span> af_G_abs.f_abs.abs_eq ltl_prop_equiv_def af_G_letter_abs_def<span class="main">)</span> 

<span class="keyword1" id="af-af_G_letter_opt_sat_core_lifted"><span class="command">lemma</span></span> af_G_letter_opt_sat_core_lifted<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Only_G <span class="free">𝒢</span> <span class="main">⟹</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="free">φ</span> <span class="main">⟹</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="main">(</span><span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="free">φ</span> <span class="free">ν</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> af_G_letter_abs_opt_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> af_G_letter_opt_sat_core Quotient_ltl_prop_equiv_quotient<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> Quotient_rep_abs<span class="main"><span class="main">]</span></span> Quotient3_ltl_prop_equiv_quotient<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> Quotient3_abs_rep<span class="main"><span class="main">]</span></span> af_G_abs_opt.f_abs.abs_eq ltl_prop_equiv_def<span class="main">)</span> 

<span class="keyword1" id="af-af_G_letter_abs_opt_split"><span class="command">lemma</span></span> af_G_letter_abs_opt_split<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">↑Unf<span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span><span class="keyword1">↑step</span> <span class="free">Φ</span> <span class="free">ν</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="free">Φ</span> <span class="free">ν</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> af_G_letter_abs_opt_def step_abs_def comp_def af_G_abs_opt.f_abs_def 
  <span class="keyword1"><span class="command">using</span></span> map_fun_apply Unf<span class="hidden">⇩</span><sub>G</sub>_abs.abs_eq af_G_letter_opt.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="af-af_unfold"><span class="command">lemma</span></span> af_unfold<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="keyword1">↑af</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span> <span class="bound">ν</span><span class="main">.</span> <span class="keyword1">↑step</span> <span class="main">(</span><span class="keyword1">↑Unf</span> <span class="bound">φ</span><span class="main">)</span> <span class="bound">ν</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Unf_abs_def af_abs.f_abs.abs_eq af_letter_abs_def af_letter_alt_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ltl<span class="hidden">⇩</span><sub>P</sub>_abs_rep map_fun_apply step_abs.abs_eq<span class="main">)</span>
 
<span class="keyword1" id="af-af_opt_unfold"><span class="command">lemma</span></span> af_opt_unfold<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="keyword1">↑af<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">φ</span> <span class="bound">ν</span><span class="main">.</span> <span class="keyword1">↑Unf</span> <span class="main">(</span><span class="keyword1">↑step</span> <span class="bound">φ</span> <span class="bound">ν</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Quotient3_abs_rep Quotient3_ltl_prop_equiv_quotient Unf_abs.abs_eq af_abs_opt.f_abs.abs_eq af_letter_abs_opt_def af_letter_opt.elims id_apply map_fun_apply  step_abs_def<span class="main">)</span>

<span class="keyword1" id="af-af_abs_equiv"><span class="command">lemma</span></span> af_abs_equiv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"foldl <span class="keyword1">↑af</span> <span class="free">ψ</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">↑step</span> <span class="main">(</span>foldl <span class="keyword1">↑af<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">(</span><span class="keyword1">↑Unf</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="free">x</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> af_unfold af_opt_unfold <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">ψ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="af-Rep_Abs_equiv"><span class="command">lemma</span></span> Rep_Abs_equiv<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"Rep <span class="main">(</span>Abs <span class="free">φ</span><span class="main">)</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Rep_Abs_prop_entailment <span class="keyword1"><span class="command">unfolding</span></span> ltl_prop_equiv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="af-Rep_step"><span class="command">lemma</span></span> Rep_step<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"Rep <span class="main">(</span><span class="keyword1">↑step</span> <span class="free">Φ</span> <span class="free">ν</span><span class="main">)</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> step <span class="main">(</span>Rep <span class="free">Φ</span><span class="main">)</span> <span class="free">ν</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Quotient3_abs_rep Quotient3_ltl_prop_equiv_quotient ltl_prop_equiv_quotient.abs_eq_iff step_abs.abs_eq<span class="main">)</span>

<span class="keyword1" id="af-step_𝒢"><span class="command">lemma</span></span> step_𝒢<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Only_G <span class="free">𝒢</span> <span class="main">⟹</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">φ</span> <span class="main">⟹</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> step <span class="free">φ</span> <span class="free">ν</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="af-Unf"><span class="command">lemma</span></span> Unf<span class="hidden">⇩</span><sub>G</sub>_𝒢<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Only_G <span class="free">𝒢</span> <span class="main">⟹</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">φ</span> <span class="main">⟹</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Unf<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">hide_fact</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> respectfulness nested_propos

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Logical_Characterization">
<div class="head">
<h1>Theory Logical_Characterization</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Author:      Salomon Sickert
    License:     BSD
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Logical Characterization Theorems›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Logical_Characterization
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <a href="af.html">af</a> <span class="quoted">"<a href="Preliminaries2.html">Auxiliary/Preliminaries2</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Eventually True G-Subformulae›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl <span class="main">⇒</span> <span class="tfree">'a</span> set word <span class="main">⇒</span> <span class="tfree">'a</span> ltl set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub></span> <span class="keyword1">true</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span><span class="keyword1">false</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span><span class="keyword1">p(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span><span class="keyword1">np(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">and</span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> <span class="free">𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">∪</span> <span class="free">𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="keyword1">or</span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> <span class="free">𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">∪</span> <span class="free">𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub></span> <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span><span class="keyword1">F</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> <span class="free">𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span><span class="keyword1">G</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">⊨</span> <span class="keyword1">F</span> <span class="keyword1">G</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">then</span> <span class="main">{</span><span class="keyword1">G</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">}</span> <span class="main">∪</span> <span class="free">𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="keyword1">else</span> <span class="free">𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span><span class="keyword1">X</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> <span class="free">𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">U</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> <span class="free">𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">∪</span> <span class="free">𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span>"</span></span>
 
<span class="keyword1" id="Logical_Characterization-𝒢"><span class="command">lemma</span></span> 𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub>_alt_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">w</span> <span class="main">=</span> <span class="main">{</span><span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">|</span> <span class="bound">ψ</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span> <span class="main">∧</span> <span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">F</span> <span class="main">(</span><span class="keyword1">G</span> <span class="bound">ψ</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Logical_Characterization-𝒢"><span class="command">lemma</span></span> 𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub>_Only_G<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Only_G <span class="main">(</span>𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">w</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Logical_Characterization-𝒢"><span class="command">lemma</span></span> 𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub>_suffix<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="main">(</span>suffix <span class="free">i</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> 𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> 𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub>_alt_def LTL_FG_suffix <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Eventually Provable and Almost All Eventually Provable›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">𝔓</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">𝔓</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒢</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">𝒢</span></span></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">→</span> <span class="bound">j</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">almost_all_eventually_provable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl <span class="main">⇒</span> <span class="tfree">'a</span> ltl set <span class="main">⇒</span> <span class="tfree">'a</span> set word <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝔓<span class="hidden">⇩</span><sub>∞</sub></span>"</span><span class="main">)</span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝔓<span class="hidden">⇩</span><sub>∞</sub></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒢</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> <span class="main">∀<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">i</span><span class="main">.</span> 𝔓 <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒢</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="bound">i</span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Proof Rules›</span></span>

<span class="keyword1" id="Logical_Characterization-almost_all_eventually_provable_monotonI"><span class="command">lemma</span></span> almost_all_eventually_provable_monotonI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">𝔓<span class="hidden">⇩</span><sub>∞</sub></span> <span class="free">φ</span> <span class="free">𝒢</span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">𝒢</span> <span class="main">⊆</span> <span class="free">𝒢'</span> <span class="main">⟹</span> <span class="keyword1">𝔓<span class="hidden">⇩</span><sub>∞</sub></span> <span class="free">φ</span> <span class="free">𝒢'</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> almost_all_eventually_provable_def MOST_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Logical_Characterization-almost_all_eventually_provable_restrict_to_G"><span class="command">lemma</span></span> almost_all_eventually_provable_restrict_to_G<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">𝔓<span class="hidden">⇩</span><sub>∞</sub></span> <span class="free">φ</span> <span class="free">𝒢</span> <span class="free">w</span> <span class="main">⟹</span> Only_G <span class="free">𝒢</span> <span class="main">⟹</span> <span class="keyword1">𝔓<span class="hidden">⇩</span><sub>∞</sub></span> <span class="free">φ</span> <span class="main">(</span><span class="free">𝒢</span> <span class="main">∩</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span><span class="main">)</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Only_G <span class="free">𝒢</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔓<span class="hidden">⇩</span><sub>∞</sub></span> <span class="free">φ</span> <span class="free">𝒢</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span><span class="main">.</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">φ</span> <span class="main">=</span> <span class="main">(</span><span class="free">𝒢</span> <span class="main">∩</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="bound">φ</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">φ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> LTL_prop_entailment_restrict_to_propos propos_subset
    <span class="keyword1"><span class="command">unfolding</span></span> G_nested_propos_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> almost_all_eventually_provable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">G_depth</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl <span class="main">⇒</span> nat"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">G_depth</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">and</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span><span class="free">G_depth</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">G_depth</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">G_depth</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">or</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span><span class="free">G_depth</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">G_depth</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">G_depth</span> <span class="main">(</span><span class="keyword1">F</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">G_depth</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">G_depth</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">G_depth</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">G_depth</span> <span class="main">(</span><span class="keyword1">X</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">G_depth</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">G_depth</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">U</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span><span class="free">G_depth</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">G_depth</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">G_depth</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">0</span>"</span></span>

<span class="keyword1" id="Logical_Characterization-almost_all_eventually_provable_restrict_to_G_depth"><span class="command">lemma</span></span> almost_all_eventually_provable_restrict_to_G_depth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔓<span class="hidden">⇩</span><sub>∞</sub></span> <span class="free">φ</span> <span class="free">𝒢</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Only_G <span class="free">𝒢</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔓<span class="hidden">⇩</span><sub>∞</sub></span> <span class="free">φ</span> <span class="main">(</span><span class="free">𝒢</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">ψ</span><span class="main">.</span> G_depth <span class="bound">ψ</span> <span class="main">≤</span> G_depth <span class="free">φ</span><span class="main">}</span><span class="main">)</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span> 
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="skolem">φ</span> <span class="main">=</span> <span class="main">(</span><span class="free">𝒢</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">ψ</span><span class="main">.</span> G_depth <span class="bound">ψ</span> <span class="main">≤</span> G_depth <span class="skolem">φ</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">insert</span> <span class="quoted"><span class="quoted">‹Only_G <span class="free">𝒢</span>›</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">}</span></span> 
  <span class="keyword1"><span class="command">note</span></span> Unfold1 <span class="main">=</span> this
  
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
    <span class="keyword1"><span class="command">{</span></span> 
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">φ</span> <span class="skolem">ν</span> 
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">ψ</span><span class="main">.</span> G_depth <span class="bound">ψ</span> <span class="main">≤</span> G_depth <span class="main">(</span>af_G_letter <span class="skolem">φ</span> <span class="skolem">ν</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">ψ</span><span class="main">.</span> G_depth <span class="bound">ψ</span> <span class="main">≤</span> G_depth <span class="skolem">φ</span><span class="main">}</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">unfold</span> af_G_letter.simps G_depth.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">metis</span> le_max_iff_disj mem_Collect_eq<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">ψ</span><span class="main">.</span> G_depth <span class="bound">ψ</span> <span class="main">≤</span> G_depth <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="skolem">w</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">ψ</span><span class="main">.</span> G_depth <span class="bound">ψ</span> <span class="main">≤</span> G_depth <span class="free">φ</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> Unfold2 <span class="main">=</span> this

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> almost_all_eventually_provable_def Unfold1 Unfold2 <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Logical_Characterization-almost_all_eventually_provable_suffix"><span class="command">lemma</span></span> almost_all_eventually_provable_suffix<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">𝔓<span class="hidden">⇩</span><sub>∞</sub></span> <span class="free">φ</span> <span class="free">𝒢'</span> <span class="free">w</span> <span class="main">⟹</span> <span class="keyword1">𝔓<span class="hidden">⇩</span><sub>∞</sub></span> <span class="free">φ</span> <span class="free">𝒢'</span> <span class="main">(</span>suffix <span class="free">i</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> almost_all_eventually_provable_def MOST_nat_le
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Nat.add_0_right subsequence_shift subsequence_prefix_suffix suffix_0 add.assoc diff_zero trans_le_add2<span class="main">)</span> 

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Threshold›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The first index, such that the formula is eventually provable from this time on›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">threshold</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl <span class="main">⇒</span> <span class="tfree">'a</span> set  word <span class="main">⇒</span> <span class="tfree">'a</span> ltl set <span class="main">⇒</span> nat option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">threshold</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒢</span></span></span> <span class="main">=</span> index <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> 𝔓 <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒢</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="bound">j</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Logical_Characterization-threshold_properties"><span class="command">lemma</span></span> threshold_properties<span class="main">:</span>
  <span class="quoted"><span class="quoted">"threshold <span class="free">φ</span> <span class="free">w</span> <span class="free">𝒢</span> <span class="main">=</span> Some <span class="free">i</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">→</span> <span class="free">k</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"threshold <span class="free">φ</span> <span class="free">w</span> <span class="free">𝒢</span> <span class="main">=</span> Some <span class="free">i</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">≥</span> <span class="free">i</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="free">j</span> <span class="main">→</span> <span class="bound">k</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> index_properties <span class="keyword1"><span class="command">unfolding</span></span> threshold.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Logical_Characterization-threshold_suffix"><span class="command">lemma</span></span> threshold_suffix<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"threshold <span class="free">φ</span> <span class="free">w</span> <span class="free">𝒢</span> <span class="main">=</span> Some <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"threshold <span class="free">φ</span> <span class="main">(</span>suffix <span class="free">i</span> <span class="free">w</span><span class="main">)</span> <span class="free">𝒢</span> <span class="main">=</span> Some <span class="free">k'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">k'</span> <span class="main">+</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">k</span> <span class="main">≤</span> <span class="free">k'</span> <span class="main">+</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&gt;</span> <span class="free">k'</span> <span class="main">+</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> <span class="free">k'</span> <span class="main">+</span> <span class="free">i</span> <span class="main">+</span> Suc <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_diff_Suc le_Suc_eq le_add1 le_add_diff_inverse less_imp_Suc_add<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">k'</span> <span class="main">+</span> <span class="free">i</span> <span class="main">+</span> Suc <span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="free">i</span> <span class="main">+</span> <span class="main">(</span><span class="free">k'</span> <span class="main">+</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">&gt;</span> <span class="free">k'</span> <span class="main">+</span> <span class="free">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> threshold_properties<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">&lt;</span> <span class="free">k</span>›</span></span><span class="main">]</span> threshold_properties<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">k'</span> <span class="main">+</span> <span class="skolem">j</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> le_add1<span class="main">]</span> 
    <span class="keyword1"><span class="command">unfolding</span></span> subsequence_shift <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">=</span> <span class="free">k'</span> <span class="main">+</span> <span class="free">i</span> <span class="main">+</span> Suc <span class="skolem">j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k'</span> <span class="main">+</span> <span class="free">i</span> <span class="main">+</span> Suc <span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="free">i</span> <span class="main">+</span> <span class="main">(</span><span class="free">k'</span> <span class="main">+</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Relation to LTL semantics›</span></span>

<span class="keyword1" id="Logical_Characterization-ltl_implies_provable"><span class="command">lemma</span></span> ltl_implies_provable<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span> <span class="main">⟹</span> 𝔓 <span class="free">φ</span> <span class="main">(</span>𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">w</span><span class="main">)</span> <span class="free">w</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LTLProp <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="keyword1">p(</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subsequence_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LTLPropNeg <span class="skolem">a</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="keyword1">np(</span><span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="main">1</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subsequence_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LTLAnd <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">i<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">w</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="skolem">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="skolem">i<span class="hidden">⇩</span><sub>1</sub></span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">w</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="skolem">i<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> LTLAnd <span class="keyword1"><span class="command">unfolding</span></span> ltl_semantics.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">w</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="skolem">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="skolem">i<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="skolem">i<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">w</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="skolem">i<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">+</span> <span class="skolem">i<span class="hidden">⇩</span><sub>1</sub></span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> af<span class="hidden">⇩</span><sub>G</sub>_sat_core_generalized<span class="main">[</span><span class="operator">OF</span> 𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub>_Only_G _ <span class="quoted"><span class="quoted">‹<span class="main">(</span>𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">w</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">(</span><span class="skolem">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="skolem">i<span class="hidden">⇩</span><sub>1</sub></span><span class="main">]</span><span class="main">)</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> af<span class="hidden">⇩</span><sub>G</sub>_sat_core_generalized<span class="main">[</span><span class="operator">OF</span> 𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub>_Only_G _ <span class="quoted"><span class="quoted">‹<span class="main">(</span>𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">w</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">(</span><span class="skolem">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="skolem">i<span class="hidden">⇩</span><sub>2</sub></span><span class="main">]</span><span class="main">)</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> af<span class="hidden">⇩</span><sub>G</sub>_decompose add.commute<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LTLOr <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">φ<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> af<span class="hidden">⇩</span><sub>G</sub>_decompose <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">⊨</span> <span class="skolem">φ<span class="hidden">⇩</span><sub>1</sub></span>"</span></span><span class="main">)</span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LTLNext <span class="skolem">φ</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ</span> <span class="skolem">w</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ</span> <span class="main">(</span>suffix <span class="main">1</span> <span class="skolem">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="skolem">i</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> LTLNext<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> LTLNext<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ltl_semantics.simps<span class="main"><span class="main">]</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">unfolding</span></span> 𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub>_suffix <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="keyword1">X</span> <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">w</span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="keyword1">X</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="main">1</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">]</span><span class="main">)</span>"</span></span>  
      <span class="keyword1"><span class="command">unfolding</span></span> subsequence_shift subsequence_append <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subsequence_def<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LTLFinal <span class="skolem">φ</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"suffix <span class="skolem">i</span> <span class="skolem">w</span> <span class="main">⊨</span> <span class="skolem">φ</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ</span> <span class="skolem">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ</span> <span class="main">(</span>suffix <span class="skolem">i</span> <span class="skolem">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> LTLFinal 𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub>_suffix <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ</span> <span class="skolem">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ</span> <span class="main">(</span>suffix <span class="skolem">i</span> <span class="skolem">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> Suc <span class="skolem">j</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> af<span class="hidden">⇩</span><sub>G</sub>_sat_core_generalized<span class="main">[</span><span class="operator">OF</span> 𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub>_Only_G<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> le_SucI<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> af<span class="hidden">⇩</span><sub>G</sub>_keeps_F_and_S<span class="main">[</span><span class="operator">OF</span> _ A<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ</span> <span class="skolem">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="keyword1">F</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> Suc <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">j</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>  
      <span class="keyword1"><span class="command">unfolding</span></span> subsequence_shift subsequence_append Suc_eq_plus1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub>.simps<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LTLUntil <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"suffix <span class="skolem">k</span> <span class="skolem">w</span> <span class="main">⊨</span> <span class="skolem">ψ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="skolem">k</span><span class="main">.</span> suffix <span class="bound">j</span> <span class="skolem">w</span> <span class="main">⊨</span> <span class="skolem">φ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">k</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">w</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="skolem">ψ</span> <span class="skolem">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">ψ</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="skolem">i</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> LTLUntil <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> suffix_0<span class="main">)</span> 
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="skolem">ψ</span> <span class="skolem">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">ψ</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> Suc <span class="skolem">i</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> af<span class="hidden">⇩</span><sub>G</sub>_sat_core_generalized<span class="main">[</span><span class="operator">OF</span> 𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub>_Only_G<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span><span class="main">,</span> <span class="operator">OF</span>  le_SucI<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="skolem">φ</span> <span class="keyword1">U</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="skolem">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="skolem">φ</span> <span class="keyword1">U</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> Suc <span class="skolem">i</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> af<span class="hidden">⇩</span><sub>G</sub>_subsequence_U ltl_prop_entailment.simps 𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub>.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">⊨</span> <span class="skolem">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"suffix <span class="skolem">k</span> <span class="main">(</span>suffix <span class="main">1</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">ψ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">&lt;</span><span class="skolem">k</span><span class="main">.</span> suffix <span class="bound">j</span> <span class="main">(</span>suffix <span class="main">1</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">φ</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> suffix_0 suffix_suffix <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> Suc_less_eq<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i_def<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="skolem">φ</span> <span class="keyword1">U</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="skolem">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="skolem">φ</span> <span class="keyword1">U</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="main">(</span>suffix <span class="main">1</span> <span class="skolem">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="skolem">i</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"suffix <span class="main">1</span> <span class="skolem">w</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> LTL_FG_suffix 𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub>_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_def<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ</span> <span class="skolem">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> LTLUntil<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">w</span> <span class="main">⊨</span> <span class="skolem">φ</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="skolem">φ</span> <span class="keyword1">U</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="skolem">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="skolem">φ</span> <span class="keyword1">U</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="skolem">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="skolem">j</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> af<span class="hidden">⇩</span><sub>G</sub>_sat_core_generalized<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub>_Only_G le_add1<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="skolem">φ</span> <span class="keyword1">U</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="skolem">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="skolem">φ</span> <span class="keyword1">U</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">[</span><span class="main">1</span> <span class="main">→</span> <span class="skolem">j</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> af<span class="hidden">⇩</span><sub>G</sub>_sat_core_generalized<span class="main">[</span><span class="operator">OF</span> 𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub>_Only_G le_add1 i_def<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">unfolding</span></span> subsequence_shift 𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub>_suffix <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="skolem">φ</span> <span class="keyword1">U</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="skolem">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="skolem">φ</span> <span class="keyword1">U</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">[</span><span class="main">1</span> <span class="main">→</span> Suc <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="keyword1">and</span> af<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> Suc <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="skolem">φ</span> <span class="keyword1">U</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="skolem">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="skolem">φ</span> <span class="keyword1">U</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> Suc <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> af<span class="hidden">⇩</span><sub>G</sub>_subsequence_U ltl_prop_entailment.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> af<span class="hidden">⇩</span><sub>G</sub>_subsequence_U ltl_prop_entailment.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Logical_Characterization-ltl_implies_provable_almost_all"><span class="command">lemma</span></span> ltl_implies_provable_almost_all<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span> <span class="main">⟹</span> <span class="main">∀<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">i</span><span class="main">.</span> 𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="bound">i</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ltl_implies_provable af<span class="hidden">⇩</span><sub>G</sub>_sat_core_generalized<span class="main">[</span><span class="operator">OF</span> 𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub>_Only_G<span class="main">]</span> 
  <span class="keyword1"><span class="command">unfolding</span></span> MOST_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Closed Sets›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">closed</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">closed</span> <span class="free"><span class="bound"><span class="entity">𝒢</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> finite <span class="free"><span class="bound"><span class="entity">𝒢</span></span></span> <span class="main">∧</span> Only_G <span class="free"><span class="bound"><span class="entity">𝒢</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ψ</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">𝒢</span></span></span> <span class="main">⟶</span> <span class="keyword1">𝔓<span class="hidden">⇩</span><sub>∞</sub></span> <span class="bound">ψ</span> <span class="free"><span class="bound"><span class="entity">𝒢</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Logical_Characterization-closed_FG"><span class="command">lemma</span></span> closed_FG<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">𝒢</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">G</span> <span class="free">ψ</span> <span class="main">∈</span> <span class="free">𝒢</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">F</span> <span class="keyword1">G</span> <span class="free">ψ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">𝒢</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Only_G <span class="free">𝒢</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">ψ</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="free">𝒢</span> <span class="main">⟹</span> <span class="keyword1">𝔓<span class="hidden">⇩</span><sub>∞</sub></span> <span class="bound">ψ</span> <span class="free">𝒢</span> <span class="free">w</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">G</span> <span class="free">ψ</span> <span class="main">∈</span> <span class="free">𝒢</span>›</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">F</span> <span class="keyword1">G</span> <span class="free">ψ</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ψ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_ranking_induct<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">G_depth</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">𝒢</span><span class="main">)</span>
      <span class="comment1">(* Split ψ' out *)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ψ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="keyword1">G</span> <span class="skolem">ψ'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ψ</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">G</span> <span class="skolem">ψ</span> <span class="main">∈</span> insert <span class="skolem">x</span> <span class="skolem">𝒢</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∈</span> <span class="var">?𝒢'</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔓<span class="hidden">⇩</span><sub>∞</sub></span> <span class="skolem">ψ</span> <span class="main">(</span><span class="var">?𝒢'</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">ψ'</span><span class="main">.</span> G_depth <span class="bound">ψ'</span> <span class="main">≤</span> G_depth <span class="skolem">ψ</span><span class="main">}</span><span class="main">)</span> <span class="free">w</span>"</span></span>  
          <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>4-5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> almost_all_eventually_provable_restrict_to_G_depth<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"G_depth <span class="skolem">ψ</span> <span class="main">&lt;</span> G_depth <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="keyword1">G</span> <span class="skolem">ψ</span> <span class="main">∈</span> insert <span class="skolem">x</span> <span class="skolem">𝒢</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="keyword1">G</span> <span class="skolem">ψ'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔓<span class="hidden">⇩</span><sub>∞</sub></span> <span class="skolem">ψ</span> <span class="skolem">𝒢</span> <span class="free">w</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔓<span class="hidden">⇩</span><sub>∞</sub></span> <span class="skolem">ψ'</span> <span class="skolem">𝒢</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"closed <span class="skolem">𝒢</span> <span class="free">w</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> insert <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="keyword1">G</span> <span class="skolem">ψ'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  
      <span class="comment1">(* Wait until all G-subformulae are "stable" *)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Only_G <span class="skolem">𝒢</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Only_G <span class="main">(</span><span class="skolem">𝒢</span> <span class="main">∪</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="skolem">ψ'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="skolem">𝒢</span> <span class="main">∪</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="skolem">ψ'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> G_nested_finite G_nested_propos_Only_G insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> k1_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ψ</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span> <span class="main">∪</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="skolem">ψ'</span> <span class="main">⟹</span> suffix <span class="skolem">k<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">ψ</span> <span class="main">=</span> suffix <span class="main">(</span><span class="skolem">k<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="bound">i</span><span class="main">)</span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">ψ</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ltl_G_stabilize<span class="main">)</span>
       
      <span class="comment1">(* Wait until the formula is provable for all suffixes *)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ψ</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">F</span> <span class="main">(</span><span class="keyword1">G</span> <span class="bound">ψ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> insert <span class="quoted"><span class="quoted">‹closed <span class="skolem">𝒢</span> <span class="free">w</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> k2_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">≥</span> <span class="skolem">k<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="main">∃</span><span class="bound">j</span><span class="main">.</span> 𝔓 <span class="skolem">ψ'</span> <span class="skolem">𝒢</span> <span class="free">w</span> <span class="bound">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">𝔓<span class="hidden">⇩</span><sub>∞</sub></span> <span class="skolem">ψ'</span> <span class="skolem">𝒢</span> <span class="free">w</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> almost_all_eventually_provable_def MOST_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
       
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> 
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≥</span> max <span class="skolem">k<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">k<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≥</span> <span class="skolem">k<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≥</span> <span class="skolem">k<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">ψ'</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="skolem">i</span> <span class="main">→</span> <span class="skolem">j'</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> k2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">ψ'</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="skolem">i</span> <span class="main">→</span> <span class="skolem">i</span> <span class="main">+</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">j'</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> le_Suc_ex<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> subsequence_empty le_add_diff_inverse nat_le_linear<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ψ</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span>  <span class="main">⟹</span> suffix <span class="skolem">k<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">G</span> <span class="bound">ψ</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ltl_G_stabilize_property<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span><span class="skolem">𝒢</span> <span class="main">∪</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="skolem">ψ'</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹Only_G <span class="main">(</span><span class="skolem">𝒢</span> <span class="main">∪</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="skolem">ψ'</span><span class="main">)</span>›</span></span> k1_def<span class="main">]</span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">ψ</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">F</span> <span class="main">(</span><span class="keyword1">G</span> <span class="bound">ψ</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ψ</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span> <span class="main">⟹</span> suffix <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">G</span> <span class="bound">ψ</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≥</span> max <span class="skolem">k<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">k<span class="hidden">⇩</span><sub>2</sub></span>›</span></span> LTL_suffix_G suffix_suffix le_Suc_ex max.cobounded1<span class="main">)</span> 
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ψ</span><span class="main">.</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span> <span class="main">⟹</span> suffix <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">ψ</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Only_G <span class="skolem">𝒢</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> Suffix<span class="main">:</span> <span class="quoted"><span class="quoted">"suffix <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">w</span> <span class="main">⊨</span> af<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">ψ'</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="skolem">i</span> <span class="main">→</span> <span class="skolem">i</span> <span class="main">+</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ltl_models_equiv_prop_entailment <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
        
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="skolem">k<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">+</span> <span class="skolem">c</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≥</span> <span class="skolem">k<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> le_iff_add <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">hence</span></span> Stable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ψ</span> <span class="main">∈</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="skolem">ψ'</span><span class="main">.</span> suffix <span class="skolem">i</span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">ψ</span> <span class="main">=</span> suffix <span class="skolem">j</span> <span class="main">(</span>suffix <span class="skolem">i</span> <span class="free">w</span><span class="main">)</span> <span class="main">⊨</span> <span class="bound">ψ</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> k1_def k1_def<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">+</span> <span class="skolem">j</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> suffix_suffix add.assoc<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">from</span></span> Suffix <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"suffix <span class="skolem">i</span> <span class="free">w</span> <span class="main">⊨</span> <span class="skolem">ψ'</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> suffix_suffix subsequence_shift af<span class="hidden">⇩</span><sub>G</sub>_ltl_continuation_suffix<span class="main">[</span><span class="operator">OF</span> Stable<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">F</span> <span class="keyword1">G</span> <span class="skolem">ψ'</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> MOST_nat_le LTL_FG_almost_all_suffixes <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">ψ</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">F</span> <span class="keyword1">G</span> <span class="bound">ψ</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="keyword1">G</span> <span class="skolem">ψ'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Logical_Characterization-closed_𝒢"><span class="command">lemma</span></span> closed_𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub><span class="main">:</span>
  <span class="quoted"><span class="quoted">"closed <span class="main">(</span>𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">w</span><span class="main">)</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LTLGlobal <span class="skolem">φ</span><span class="main">)</span>  
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">F</span> <span class="keyword1">G</span> <span class="skolem">φ</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">i</span><span class="main">.</span> suffix <span class="bound">i</span> <span class="free">w</span> <span class="main">⊨</span> <span class="skolem">φ</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> LTL_FG_almost_all_suffixes <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> <span class="skolem">i</span><span class="main">.</span> suffix <span class="bound">j</span> <span class="free">w</span> <span class="main">⊨</span> <span class="skolem">φ</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> MOST_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≥</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"suffix <span class="skolem">k</span> <span class="free">w</span> <span class="main">⊨</span> <span class="skolem">φ</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="skolem">i</span><span class="main">.</span> suffix <span class="bound">j</span> <span class="free">w</span> <span class="main">⊨</span> <span class="skolem">φ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"𝔓 <span class="skolem">φ</span> <span class="main">{</span><span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">|</span><span class="bound">ψ</span><span class="main">.</span> <span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">F</span> <span class="keyword1">G</span> <span class="bound">ψ</span><span class="main">}</span> <span class="main">(</span>suffix <span class="skolem">k</span> <span class="free">w</span><span class="main">)</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> LTL_FG_suffix 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ltl_implies_provable<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> 𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub>_alt_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"𝔓 <span class="skolem">φ</span> <span class="main">{</span><span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">|</span><span class="bound">ψ</span><span class="main">.</span> <span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">F</span> <span class="keyword1">G</span> <span class="bound">ψ</span><span class="main">}</span> <span class="free">w</span> <span class="skolem">k</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> subsequence_shift <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔓<span class="hidden">⇩</span><sub>∞</sub></span> <span class="skolem">φ</span> <span class="main">{</span><span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">|</span> <span class="bound">ψ</span><span class="main">.</span> <span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">F</span> <span class="keyword1">G</span> <span class="bound">ψ</span><span class="main">}</span> <span class="free">w</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> almost_all_eventually_provable_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">φ</span></span> <span class="main">_</span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">unfolding</span></span> MOST_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔓<span class="hidden">⇩</span><sub>∞</sub></span> <span class="skolem">φ</span> <span class="main">(</span>𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ</span> <span class="free">w</span><span class="main">)</span> <span class="free">w</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> 𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub>_alt_def
          <span class="keyword1"><span class="command">using</span></span> almost_all_eventually_provable_restrict_to_G <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> LTLGlobal insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Conjunction of Eventually Provable Formulas›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ℱ</span> 
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">ℱ</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒢</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> And <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">[</span><span class="bound">i</span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span>the <span class="main">(</span>threshold <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒢</span></span></span><span class="main">)</span> <span class="main">..&lt;</span> Suc <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Logical_Characterization-almost_all_suffixes_model_ℱ"><span class="command">lemma</span></span> almost_all_suffixes_model_ℱ<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">𝒢</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">G</span> <span class="free">φ</span> <span class="main">∈</span> <span class="free">𝒢</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">j</span><span class="main">.</span> suffix <span class="bound">j</span> <span class="free">w</span> <span class="main">⊨</span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">𝒢</span> <span class="main">(</span>ℱ <span class="free">φ</span> <span class="free">w</span> <span class="free">𝒢</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Only_G <span class="free">𝒢</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝒢</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">χ</span><span class="main">.</span> <span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">F</span> <span class="bound">χ</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔓<span class="hidden">⇩</span><sub>∞</sub></span> <span class="free">φ</span> <span class="free">𝒢</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> closed_FG<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"threshold <span class="free">φ</span> <span class="free">w</span> <span class="free">𝒢</span> <span class="main">=</span> Some <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> almost_all_eventually_provable_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> k_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> the <span class="main">(</span>threshold <span class="free">φ</span> <span class="free">w</span> <span class="free">𝒢</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span> <span class="main">∪</span> <span class="free">𝒢</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Only_G <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span> <span class="main">∪</span> <span class="free">𝒢</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> G_nested_finite <span class="keyword1"><span class="command">unfolding</span></span> G_nested_propos_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span> <span class="bound">ψ</span><span class="main">.</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span> <span class="main">∪</span> <span class="free">𝒢</span> <span class="main">⟹</span> suffix <span class="skolem">l</span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">ψ</span> <span class="main">=</span> suffix <span class="main">(</span><span class="skolem">l</span> <span class="main">+</span> <span class="bound">j</span><span class="main">)</span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ltl_G_stabilize <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">hence</span></span> 𝒢_sat<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span> <span class="bound">ψ</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="free">𝒢</span> <span class="main">⟹</span> suffix <span class="main">(</span><span class="skolem">l</span> <span class="main">+</span> <span class="bound">j</span><span class="main">)</span> <span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">G</span> <span class="bound">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ltl_G_stabilize_property <span class="quoted"><span class="quoted">‹<span class="free">𝒢</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">χ</span><span class="main">.</span> <span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">F</span> <span class="bound">χ</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> 
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">+</span> <span class="skolem">j'</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> le_Suc_ex<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> <span class="skolem">i</span><span class="main">.</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="skolem">i</span> <span class="main">→</span> <span class="bound">j</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">𝔓<span class="hidden">⇩</span><sub>∞</sub></span> <span class="free">φ</span> <span class="free">𝒢</span> <span class="free">w</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> almost_all_eventually_provable_def MOST_nat_le
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">i</span>›</span></span> <span class="quoted"><span class="quoted">‹threshold <span class="free">φ</span> <span class="free">w</span> <span class="free">𝒢</span> <span class="main">=</span> Some <span class="skolem">k</span>›</span></span> threshold_properties<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> linear subsequence_empty<span class="main">)</span>  
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="skolem">i</span> <span class="main">→</span> <span class="skolem">j''</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">j''</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"suffix <span class="skolem">j</span> <span class="free">w</span> <span class="main">⊨</span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">𝒢</span> <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="skolem">i</span> <span class="main">→</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j''</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="skolem">i</span> <span class="main">→</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> af<span class="hidden">⇩</span><sub>G</sub>_sat_core_generalized<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Only_G <span class="free">𝒢</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">j'</span></span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="quoted">"suffix <span class="skolem">i</span> <span class="free">w</span>"</span></span><span class="main">]</span> le_Suc_ex<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">j''</span>›</span></span><span class="main">]</span> le_Suc_ex<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j''</span> <span class="main">≤</span> <span class="skolem">j</span>›</span></span><span class="main">]</span>  
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.right_neutral subsequence_shift <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">+</span> <span class="skolem">j'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="skolem">i</span> <span class="main">→</span> <span class="skolem">j''</span><span class="main">]</span><span class="main">)</span>›</span></span> nat_add_left_cancel_le <span class="main">)</span> 
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">𝒢</span> <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="skolem">i</span> <span class="main">→</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> eval<span class="hidden">⇩</span><sub>G</sub>_prop_entailment <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝒢</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">χ</span><span class="main">.</span> suffix <span class="skolem">j</span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">χ</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 𝒢_sat <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">j</span>›</span></span> <span class="quoted"><span class="quoted">‹Only_G <span class="free">𝒢</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> le_Suc_ex<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">χ</span><span class="main">.</span> suffix <span class="skolem">j</span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">χ</span><span class="main">}</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">𝒢</span> <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="skolem">i</span> <span class="main">→</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> ltl_models_equiv_prop_entailment<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">𝒢</span> <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="skolem">i</span> <span class="main">→</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="skolem">j</span> <span class="main">→</span> <span class="skolem">j''</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> foldl_append<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> eval<span class="hidden">⇩</span><sub>G</sub>_prop_entailment
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_iff_add <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">j</span>›</span></span> map_append upt_add_eq_append nat_le_linear subsequence_def <span class="quoted"><span class="quoted">‹<span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="skolem">i</span> <span class="main">→</span> <span class="skolem">j''</span><span class="main">]</span><span class="main">)</span>›</span></span><span class="main">)</span> 
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">𝒢</span> <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="skolem">i</span> <span class="main">→</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="skolem">j</span> <span class="main">→</span> <span class="skolem">j''</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="var">?af<span class="hidden">⇩</span><sub>G</sub></span>"</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">using</span></span> af<span class="hidden">⇩</span><sub>G</sub>_eval<span class="hidden">⇩</span><sub>G</sub><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Only_G <span class="free">𝒢</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">j''</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> False <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝒢</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">χ</span><span class="main">.</span> suffix <span class="skolem">j''</span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">χ</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> 𝒢_sat <span class="quoted"><span class="quoted">‹Only_G <span class="free">𝒢</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> le_Suc_ex<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"suffix <span class="skolem">j''</span> <span class="free">w</span> <span class="main">⊨</span> <span class="var">?af<span class="hidden">⇩</span><sub>G</sub></span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> ltl_models_equiv_prop_entailment<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ψ</span><span class="main">.</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span> <span class="main">∪</span> <span class="free">𝒢</span> <span class="main">⟹</span> suffix <span class="skolem">j</span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">ψ</span> <span class="main">=</span> suffix <span class="skolem">j''</span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">ψ</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> S <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">j''</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_add_diff_inverse<span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="main">(</span>eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">𝒢</span> <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="skolem">i</span> <span class="main">→</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?G</span> <span class="main">⊆</span> <span class="main">_</span>"</span></span><span class="main">)</span>
              <span class="keyword1"><span class="command">using</span></span> eval<span class="hidden">⇩</span><sub>G</sub>_G_nested <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
            <span class="keyword1"><span class="command">ultimately</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ψ</span><span class="main">.</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="var">?G</span> <span class="main">⟹</span> suffix <span class="skolem">j</span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">ψ</span> <span class="main">=</span> suffix <span class="skolem">j''</span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">ψ</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> af<span class="hidden">⇩</span><sub>G</sub>_ltl_continuation_suffix<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">𝒢</span> <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="skolem">i</span> <span class="main">→</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"suffix <span class="skolem">j</span> <span class="free">w</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> suffix_suffix<span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False le_Suc_ex nat_le_linear add_diff_cancel_left' subsequence_prefix_suffix<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>   
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"suffix <span class="skolem">j</span> <span class="free">w</span> <span class="main">⊨</span> And <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">𝒢</span> <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="bound">i</span> <span class="main">→</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="skolem">k</span><span class="main">..&lt;</span>Suc <span class="skolem">j</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> And_semantics set_map set_upt image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"suffix <span class="skolem">j</span> <span class="free">w</span> <span class="main">⊨</span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">𝒢</span> <span class="main">(</span>And <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="bound">i</span> <span class="main">→</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="skolem">k</span><span class="main">..&lt;</span>Suc <span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> eval<span class="hidden">⇩</span><sub>G</sub>_And_map map_map comp_def <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> ℱ_def And_semantics MOST_nat_le k_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Logical_Characterization-almost_all_commutative''"><span class="command">lemma</span></span> almost_all_commutative''<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Only_G <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">∀<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">(</span><span class="bound">i</span><span class="main">::</span>nat<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">∀<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">i</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>theG <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="bound">i</span><span class="main">::</span>nat<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>theG <span class="bound">x</span><span class="main">)</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> almost_all_commutative' <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> MOST_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Logical_Characterization-almost_all_suffixes_model_ℱ_generalized"><span class="command">lemma</span></span> almost_all_suffixes_model_ℱ_generalized<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">𝒢</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">j</span><span class="main">.</span> <span class="main">∀</span><span class="bound">ψ</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="free">𝒢</span> <span class="main">⟶</span> suffix <span class="bound">j</span> <span class="free">w</span> <span class="main">⊨</span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="free">𝒢</span> <span class="main">(</span>ℱ <span class="bound">ψ</span> <span class="free">w</span> <span class="free">𝒢</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> almost_all_suffixes_model_ℱ<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> almost_all_commutative''<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">𝒢</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Technical Lemmas›</span></span>

<span class="keyword1" id="Logical_Characterization-threshold_suffix_2"><span class="command">lemma</span></span> threshold_suffix_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"threshold <span class="free">ψ</span> <span class="free">w</span> <span class="free">𝒢'</span> <span class="main">=</span> Some <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≤</span> <span class="free">l</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"threshold <span class="free">ψ</span> <span class="main">(</span>suffix <span class="free">l</span> <span class="free">w</span><span class="main">)</span> <span class="free">𝒢'</span> <span class="main">=</span> Some <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔓<span class="hidden">⇩</span><sub>∞</sub></span> <span class="free">ψ</span> <span class="free">𝒢'</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹threshold <span class="free">ψ</span> <span class="free">w</span> <span class="free">𝒢'</span> <span class="main">=</span> Some <span class="free">k</span>›</span></span>  option.distinct<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> threshold.simps index.simps almost_all_eventually_provable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔓<span class="hidden">⇩</span><sub>∞</sub></span> <span class="free">ψ</span> <span class="free">𝒢'</span> <span class="main">(</span>suffix <span class="free">l</span> <span class="free">w</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> almost_all_eventually_provable_suffix <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">≥</span> <span class="free">k</span><span class="main">.</span> <span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="free">𝒢'</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">ψ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="bound">i</span> <span class="main">→</span> <span class="bound">j</span><span class="main">]</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> threshold_properties<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">m</span><span class="main">.</span> <span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="free">𝒢'</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">ψ</span> <span class="main">(</span><span class="main">(</span>suffix <span class="free">l</span> <span class="free">w</span><span class="main">)</span> <span class="main">[</span><span class="bound">m</span> <span class="main">→</span> <span class="bound">j</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> subsequence_shift <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">k</span> <span class="main">≤</span> <span class="free">l</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">≥</span> <span class="free">k</span><span class="main">.</span> <span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="free">𝒢'</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">ψ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="bound">i</span> <span class="main">→</span> <span class="bound">j</span><span class="main">]</span><span class="main">)</span>›</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> leI less_imp_add_positive order_refl subsequence_empty trans_le_add1<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Logical_Characterization-threshold_closed"><span class="command">lemma</span></span> threshold_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">𝒢</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="main">∀</span><span class="bound">ψ</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="free">𝒢</span> <span class="main">⟶</span> threshold <span class="bound">ψ</span> <span class="main">(</span>suffix <span class="bound">k</span> <span class="free">w</span><span class="main">)</span> <span class="free">𝒢</span> <span class="main">=</span> Some <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> Max <span class="main">{</span>the <span class="main">(</span>threshold <span class="bound">ψ</span> <span class="free">w</span> <span class="free">𝒢</span><span class="main">)</span> <span class="main">|</span> <span class="bound">ψ</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="free">𝒢</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> Max <span class="var">?S</span>"</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">𝒢</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Only_G <span class="free">𝒢</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ψ</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="free">𝒢</span> <span class="main">⟹</span> <span class="keyword1">𝔓<span class="hidden">⇩</span><sub>∞</sub></span> <span class="bound">ψ</span> <span class="free">𝒢</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ψ</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="free">𝒢</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">k</span><span class="main">.</span> threshold <span class="bound">ψ</span> <span class="free">w</span> <span class="free">𝒢</span> <span class="main">=</span> Some <span class="bound">k</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> almost_all_eventually_provable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> the <span class="main">(</span>threshold <span class="main">(</span>theG <span class="bound">x</span><span class="main">)</span> <span class="free">w</span> <span class="free">𝒢</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free">𝒢</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> image_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Only_G <span class="free">𝒢</span>›</span></span> ltl.sel<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">𝒢</span>›</span></span> finite_imageI <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ψ</span> <span class="bound">k'</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="free">𝒢</span> <span class="main">⟹</span> threshold <span class="bound">ψ</span> <span class="free">w</span> <span class="free">𝒢</span> <span class="main">=</span> Some <span class="bound">k'</span> <span class="main">⟹</span> <span class="bound">k'</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> CollectI Max_ge k_def option.sel<span class="main">)</span>  
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ψ</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="free">𝒢</span> <span class="main">⟹</span> threshold <span class="bound">ψ</span> <span class="main">(</span>suffix <span class="skolem">k</span> <span class="free">w</span><span class="main">)</span> <span class="free">𝒢</span> <span class="main">=</span> Some <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> threshold_suffix<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">𝒢</span></span> <span class="main">_</span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> threshold_suffix_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Logical_Characterization-ℱ_drop"><span class="command">lemma</span></span> ℱ_drop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔓<span class="hidden">⇩</span><sub>∞</sub></span> <span class="free">φ</span> <span class="free">𝒢'</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> ℱ <span class="free">φ</span> <span class="free">w</span> <span class="free">𝒢'</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> ℱ <span class="free">φ</span> <span class="main">(</span>suffix <span class="free">i</span> <span class="free">w</span><span class="main">)</span> <span class="free">𝒢'</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> k_def<span class="main">:</span> <span class="quoted"><span class="quoted">"threshold <span class="free">φ</span> <span class="free">w</span> <span class="free">𝒢'</span> <span class="main">=</span> Some <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> k'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"threshold <span class="free">φ</span> <span class="main">(</span>suffix <span class="free">i</span> <span class="free">w</span><span class="main">)</span> <span class="free">𝒢'</span> <span class="main">=</span> Some <span class="skolem">k'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms almost_all_eventually_provable_suffix 
    <span class="keyword1"><span class="command">unfolding</span></span> threshold.simps index.simps almost_all_eventually_provable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> k_def_2<span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>threshold <span class="free">φ</span> <span class="free">w</span> <span class="free">𝒢'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> k'_def_2<span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>threshold <span class="free">φ</span> <span class="main">(</span>suffix <span class="free">i</span> <span class="free">w</span><span class="main">)</span> <span class="free">𝒢'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">k'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">+</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> ℱ <span class="free">φ</span> <span class="free">w</span> <span class="free">𝒢'</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">j</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ℱ_def And_semantics And_prop_entailment <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subsequence_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="skolem">k</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">+</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> k_def k'_def threshold_suffix <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>threshold <span class="free">φ</span> <span class="main">(</span>suffix <span class="free">i</span> <span class="free">w</span><span class="main">)</span> <span class="free">𝒢'</span><span class="main">)</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">pos</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">≤</span> <span class="skolem">pos</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pos</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">+</span> <span class="skolem">pos</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> threshold_suffix k_def k'_def <span class="quoted"><span class="quoted">‹<span class="skolem">k'</span> <span class="main">≤</span> <span class="skolem">pos</span>›</span></span> add.commute add_le_cancel_right order.trans<span class="main">)</span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="skolem">pos</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">[</span><span class="skolem">k</span><span class="main">..&lt;</span>Suc <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">j</span><span class="main">)</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">pos</span> <span class="main">≤</span> <span class="free">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="main">(</span><span class="main">(</span>suffix <span class="free">i</span> <span class="free">w</span><span class="main">)</span> <span class="main">[</span><span class="skolem">pos</span> <span class="main">→</span> <span class="free">j</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">ia</span><span class="main">.</span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="main">(</span>subsequence <span class="free">w</span> <span class="bound">ia</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="skolem">k</span><span class="main">..&lt;</span>Suc <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="free">j</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> subsequence_shift set_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="main">(</span><span class="main">(</span>suffix <span class="free">i</span> <span class="free">w</span><span class="main">)</span> <span class="main">[</span><span class="skolem">pos</span> <span class="main">→</span> <span class="free">j</span><span class="main">]</span><span class="main">)</span>"</span></span>  
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> ℱ_def And_prop_entailment k_def_2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">+</span> <span class="free">j</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
     <span class="keyword1"><span class="command">unfolding</span></span> ℱ_def And_prop_entailment k'_def_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Main Results›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">accept<span class="hidden">⇩</span><sub>M</sub></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">accept<span class="hidden">⇩</span><sub>M</sub></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒢</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">j</span><span class="main">.</span> <span class="main">∀</span><span class="bound">S</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ψ</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">𝒢</span></span></span> <span class="main">⟶</span> <span class="bound">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∧</span> <span class="bound">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="free"><span class="bound"><span class="entity">𝒢</span></span></span> <span class="main">(</span>ℱ <span class="bound">ψ</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒢</span></span></span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword1">af</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="bound">j</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Logical_Characterization-lemmaD"><span class="command">lemma</span></span> lemmaD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ψ</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> 𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">w</span> <span class="main">⟹</span> threshold <span class="bound">ψ</span> <span class="free">w</span> <span class="main">(</span>𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"accept<span class="hidden">⇩</span><sub>M</sub> <span class="free">φ</span> <span class="main">(</span>𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">w</span><span class="main">)</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="skolem">i</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ltl_implies_provable<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> assm1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> assm2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ψ</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> 𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">w</span> <span class="main">⟹</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∧</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">w</span><span class="main">)</span> <span class="main">(</span>ℱ <span class="bound">ψ</span> <span class="free">w</span> <span class="main">(</span>𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">w</span><span class="main">)</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="skolem">i</span><span class="main">]</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≥</span> <span class="skolem">i</span>›</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> af<span class="hidden">⇩</span><sub>G</sub>_sat_core_generalized 𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub>_Only_G<span class="main">)</span> 
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">w</span> <span class="main">⊆</span> <span class="skolem">S</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assm2 <span class="keyword1"><span class="command">unfolding</span></span> 𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub>_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">w</span><span class="main">)</span> <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> eval<span class="hidden">⇩</span><sub>G</sub>_prop_entailment <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ψ</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">G</span> <span class="skolem">ψ</span> <span class="main">∈</span> 𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>threshold <span class="skolem">ψ</span> <span class="free">w</span> <span class="main">(</span>𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">w</span><span class="main">)</span> <span class="main">(</span>ℱ <span class="skolem">ψ</span> <span class="free">w</span> <span class="main">(</span>𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">w</span><span class="main">)</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms assm2 option.sel <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="skolem">j</span> <span class="main">⟹</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">w</span><span class="main">)</span> <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">ψ</span> <span class="main">(</span><span class="free">w</span><span class="main">[</span><span class="bound">i</span> <span class="main">→</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> ℱ_def And_prop_entailment eval<span class="hidden">⇩</span><sub>G</sub>_And_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword1">af</span> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> af<span class="hidden">⇩</span><sub>G</sub>_implies_af_eval<span class="hidden">⇩</span><sub>G</sub><span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="free">φ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
     <span class="keyword1"><span class="command">unfolding</span></span> accept<span class="hidden">⇩</span><sub>M</sub>_def MOST_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> ltl_FG_logical_characterization<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">F</span> <span class="keyword1">G</span> <span class="free">φ</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">𝒢</span></span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="main">(</span><span class="keyword1">F</span> <span class="keyword1">G</span> <span class="free">φ</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">G</span> <span class="free">φ</span> <span class="main">∈</span> <span class="bound">𝒢</span> <span class="main">∧</span> closed <span class="bound">𝒢</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">G</span> <span class="free">φ</span> <span class="main">∈</span> 𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="keyword1">F</span> <span class="keyword1">G</span> <span class="free">φ</span><span class="main">)</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span><span class="keyword1">F</span> <span class="keyword1">G</span> <span class="free">φ</span><span class="main">)</span> <span class="free">w</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="main">(</span><span class="keyword1">F</span> <span class="keyword1">G</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> 𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub>_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> closed_𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> closed_FG<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> ltl_logical_characterization<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">𝒢</span></span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span><span class="main">.</span> accept<span class="hidden">⇩</span><sub>M</sub> <span class="free">φ</span> <span class="bound">𝒢</span> <span class="free">w</span> <span class="main">∧</span> closed <span class="bound">𝒢</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>

  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ψ</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> 𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">w</span> <span class="main">⟹</span> threshold <span class="bound">ψ</span> <span class="main">(</span>suffix <span class="skolem">k</span> <span class="free">w</span><span class="main">)</span> <span class="main">(</span>𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> threshold_closed<span class="main">[</span><span class="operator">OF</span> closed_𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="comment1">(* Define new constants *)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">w'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="main">=</span> suffix <span class="skolem">k</span> <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">φ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ'</span> <span class="main">=</span> <span class="keyword1">af</span> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span><span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="skolem">k</span><span class="main">]</span><span class="main">)</span>"</span></span>

  <span class="comment1">(* Facts about w' and φ' *)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?lhs</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="main">⊨</span> <span class="skolem">φ'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> af_ltl_continuation_suffix<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> w'_def φ'_def <span class="keyword1"><span class="command">.</span></span>   
  <span class="keyword1"><span class="command">have</span></span> G_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="skolem">φ'</span> <span class="main">=</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> φ'_def G_af_simp <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">have</span></span> 𝒢_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ'</span> <span class="skolem">w'</span> <span class="main">=</span> 𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> 𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub>_alt_def w'_def φ'_def G_af_simp LTL_FG_suffix <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">have</span></span> φ'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="keyword1">af</span> <span class="skolem">φ'</span> <span class="main">(</span><span class="skolem">w'</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span><span class="bound">j</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">af</span> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="skolem">k</span> <span class="main">+</span> <span class="bound">j</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> φ'_def w'_def foldl_append<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> subsequence_shift
    <span class="keyword1"><span class="command">unfolding</span></span> Nat.add_0_right <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subsequence_append<span class="main">)</span> 

  <span class="comment1">(* Apply helper lemma *)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"accept<span class="hidden">⇩</span><sub>M</sub> <span class="skolem">φ'</span> <span class="main">(</span>𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ'</span> <span class="skolem">w'</span><span class="main">)</span> <span class="skolem">w'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lemmaD<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">w'</span> <span class="main">⊨</span> <span class="skolem">φ'</span>›</span></span><span class="main">]</span> k_def 
    <span class="keyword1"><span class="command">unfolding</span></span> 𝒢_eq w'_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> j'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span> <span class="bound">S</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≥</span> <span class="skolem">j'</span> <span class="main">⟹</span> 
    <span class="main">(</span><span class="main">∀</span><span class="bound">ψ</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> 𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ'</span> <span class="skolem">w'</span> <span class="main">⟶</span> <span class="bound">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∧</span> <span class="bound">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ'</span> <span class="skolem">w'</span><span class="main">)</span> <span class="main">(</span>ℱ <span class="bound">ψ</span> <span class="skolem">w'</span> <span class="main">(</span>𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ'</span> <span class="skolem">w'</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword1">af</span> <span class="skolem">φ'</span> <span class="main">(</span><span class="skolem">w'</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="bound">j</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> accept<span class="hidden">⇩</span><sub>M</sub>_def MOST_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

 
  <span class="comment1">(* Change formula, s.t. it matches ?lhs *)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> <span class="skolem">S</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?af</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">af</span> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span><span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="skolem">k</span> <span class="main">+</span> <span class="skolem">j'</span> <span class="main">+</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">ψ</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="main">(</span>𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ'</span> <span class="skolem">w'</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∧</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ'</span> <span class="skolem">w'</span><span class="main">)</span> <span class="main">(</span>ℱ <span class="bound">ψ</span> <span class="free">w</span> <span class="main">(</span>𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ'</span> <span class="skolem">w'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="skolem">j'</span> <span class="main">+</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ψ</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">G</span> <span class="skolem">ψ</span> <span class="main">∈</span> 𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ'</span> <span class="skolem">w'</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∈</span> <span class="var">?𝒢</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">𝔓<span class="hidden">⇩</span><sub>∞</sub></span> <span class="skolem">ψ</span> <span class="var">?𝒢</span> <span class="free">w</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> 𝒢_eq <span class="keyword1"><span class="command">using</span></span> closed_𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">S</span><span class="main">.</span> <span class="bound">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="var">?𝒢</span> <span class="main">(</span>ℱ <span class="skolem">ψ</span> <span class="free">w</span> <span class="var">?𝒢</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="skolem">j'</span> <span class="main">+</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="var">?𝒢</span> <span class="main">(</span>ℱ <span class="skolem">ψ</span> <span class="skolem">w'</span> <span class="var">?𝒢</span> <span class="main">(</span><span class="skolem">j'</span> <span class="main">+</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ℱ_drop<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="keyword1">𝔓<span class="hidden">⇩</span><sub>∞</sub></span> <span class="skolem">ψ</span> <span class="main">(</span>𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="skolem">φ'</span> <span class="skolem">w'</span><span class="main">)</span> <span class="free">w</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">+</span> <span class="skolem">j</span>"</span></span><span class="main">]</span> eval<span class="hidden">⇩</span><sub>G</sub>_respectfulness<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> ltl_prop_implies_def<span class="main">]</span> 
        <span class="keyword1"><span class="command">unfolding</span></span> add.assoc w'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">moreover</span></span> 
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="var">?𝒢</span> <span class="main">(</span>ℱ <span class="skolem">ψ</span> <span class="free">w</span> <span class="var">?𝒢</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">+</span> <span class="skolem">j'</span> <span class="main">+</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="var">?𝒢</span> <span class="main">(</span>ℱ <span class="skolem">ψ</span> <span class="skolem">w'</span> <span class="var">?𝒢</span> <span class="main">(</span><span class="skolem">j'</span> <span class="main">+</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="var">?af</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> j'_def <span class="keyword1"><span class="command">unfolding</span></span> φ'_eq add.assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"accept<span class="hidden">⇩</span><sub>M</sub> <span class="free">φ</span> <span class="main">(</span>𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">w</span><span class="main">)</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> accept<span class="hidden">⇩</span><sub>M</sub>_def MOST_nat_le 𝒢_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_Suc_ex<span class="main">)</span> 
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="free">w</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> 𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub>_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> closed_𝒢<span class="hidden">⇩</span><sub>F</sub><span class="hidden">⇩</span><sub>G</sub><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">𝒢</span></span> <span class="keyword2"><span class="keyword">where</span></span> 𝒢_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">𝒢</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">𝒢</span>"</span></span> <span class="quoted"><span class="quoted">"Only_G <span class="skolem">𝒢</span>"</span></span> <span class="quoted"><span class="quoted">"accept<span class="hidden">⇩</span><sub>M</sub> <span class="free">φ</span> <span class="skolem">𝒢</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"closed <span class="skolem">𝒢</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 𝒢_elements 𝒢_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> <span class="skolem">𝒢</span> <span class="main">⟹</span> suffix <span class="skolem">i</span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">χ</span> <span class="main">=</span> suffix <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="bound">j</span><span class="main">)</span> <span class="free">w</span> <span class="main">⊨</span> <span class="bound">χ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ltl_G_stabilize <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> i_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ψ</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span> <span class="main">⟹</span> suffix <span class="skolem">i</span> <span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">G</span> <span class="bound">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ltl_G_stabilize_property<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">𝒢</span>›</span></span> <span class="quoted"><span class="quoted">‹Only_G <span class="skolem">𝒢</span>›</span></span><span class="main">]</span> 𝒢_prop closed_FG<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">𝒢</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j'</span> <span class="bound">S</span><span class="main">.</span> <span class="bound">j'</span> <span class="main">≥</span> <span class="skolem">j</span> <span class="main">⟹</span> 
    <span class="main">(</span><span class="main">∀</span><span class="bound">ψ</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span> <span class="main">⟶</span> <span class="bound">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∧</span> <span class="bound">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">𝒢</span> <span class="main">(</span>ℱ <span class="bound">ψ</span> <span class="free">w</span> <span class="skolem">𝒢</span> <span class="bound">j'</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword1">af</span> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="bound">j'</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹accept<span class="hidden">⇩</span><sub>M</sub> <span class="free">φ</span> <span class="skolem">𝒢</span> <span class="free">w</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> accept<span class="hidden">⇩</span><sub>M</sub>_def MOST_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> lemma19<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span> <span class="bound">ψ</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≥</span> <span class="skolem">j'</span> <span class="main">⟹</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span> <span class="main">⟹</span> suffix <span class="bound">j</span> <span class="free">w</span> <span class="main">⊨</span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">𝒢</span> <span class="main">(</span>ℱ <span class="bound">ψ</span> <span class="free">w</span> <span class="skolem">𝒢</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> almost_all_suffixes_model_ℱ_generalized<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹closed <span class="skolem">𝒢</span> <span class="free">w</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> MOST_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
  <span class="comment1">(* Define new constants *)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> max <span class="main">(</span>max <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">j'</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">w'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="main">=</span> suffix <span class="skolem">k</span> <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">φ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ'</span> <span class="main">=</span> <span class="keyword1">af</span> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span><span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="skolem">k</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">{</span><span class="bound">χ</span><span class="main">.</span> <span class="skolem">w'</span> <span class="main">⊨</span> <span class="bound">χ</span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">ψ</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span> <span class="main">⟹</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∧</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">𝒢</span> <span class="main">(</span>ℱ <span class="bound">ψ</span> <span class="free">w</span> <span class="skolem">𝒢</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="skolem">φ'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> j_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="skolem">S</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> φ'_def k_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ψ</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">G</span> <span class="skolem">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">⟹</span> suffix <span class="skolem">i</span> <span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">G</span> <span class="skolem">ψ</span> <span class="main">⟹</span> suffix <span class="bound">j</span> <span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">G</span> <span class="skolem">ψ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LTL_suffix_G le_Suc_ex suffix_suffix<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="main">⊨</span> <span class="keyword1">G</span> <span class="skolem">ψ</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> w'_def k_def max_def 
      <span class="keyword1"><span class="command">using</span></span> i_def<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="keyword1">G</span> <span class="skolem">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="main">⊨</span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">𝒢</span> <span class="main">(</span>ℱ <span class="skolem">ψ</span> <span class="free">w</span> <span class="skolem">𝒢</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lemma19<span class="main">[</span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="keyword1">G</span> <span class="skolem">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> w'_def k_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword1">G</span> <span class="skolem">ψ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">𝒢</span> <span class="main">(</span>ℱ <span class="skolem">ψ</span> <span class="free">w</span> <span class="skolem">𝒢</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> S_def ltl_models_equiv_prop_entailment<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="skolem">φ'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="main">⊨</span> <span class="skolem">φ'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> S_def ltl_models_equiv_prop_entailment <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> w'_def φ'_def af_ltl_continuation_suffix <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="LTL_Rabin">
<div class="head">
<h1>Theory LTL_Rabin</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Author:      Salomon Sickert
    License:     BSD
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Translation from LTL to (Deterministic Transitions-Based) Generalised Rabin Automata›</span></span>

<span class="keyword1"><span class="command">theory</span></span> LTL_Rabin
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <a href="Mojmir_Rabin.html">Mojmir_Rabin</a> <a href="Logical_Characterization.html">Logical_Characterization</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Preliminary Facts›</span></span>

<span class="keyword1" id="LTL_Rabin-run_af_G_letter_abs_eq_Abs_af_G_letter"><span class="command">lemma</span></span> run_af_G_letter_abs_eq_Abs_af_G_letter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"run <span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span>Abs <span class="free">φ</span><span class="main">)</span> <span class="free">w</span> <span class="free">i</span> <span class="main">=</span> Abs <span class="main">(</span>run af_G_letter <span class="free">φ</span> <span class="free">w</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> af_G_abs.f_foldl_abs.abs_eq af_G_abs.f_foldl_abs_alt_def run_foldl af_G_letter_abs_def<span class="main">)</span>

<span class="keyword1" id="LTL_Rabin-finite_reach_af"><span class="command">lemma</span></span> finite_reach_af<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reach <span class="free">Σ</span> <span class="keyword1">↑af</span> <span class="main">(</span>Abs <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">Σ</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> af_abs.finite_abs_reach <span class="keyword1"><span class="command">unfolding</span></span> af_abs.abs_reach_def reach_foldl_def<span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> finite_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>foldl <span class="keyword1">↑af</span> <span class="main">(</span>Abs <span class="free">φ</span><span class="main">)</span> <span class="bound">w</span> <span class="main">|</span><span class="bound">w</span><span class="main">.</span> set <span class="bound">w</span> <span class="main">⊆</span> <span class="free">Σ</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>foldl <span class="keyword1">↑af</span><span class="main">(</span>Abs <span class="free">φ</span><span class="main">)</span> <span class="bound">w</span> <span class="main">|</span><span class="bound">w</span><span class="main">.</span> True<span class="main">}</span>"</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">unfolding</span></span> af_letter_abs_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_def<span class="main">)</span>

<span class="keyword1" id="LTL_Rabin-ltl_semi_mojmir"><span class="command">lemma</span></span> ltl_semi_mojmir<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"range <span class="free">w</span> <span class="main">⊆</span> <span class="free">Σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"semi_mojmir <span class="free">Σ</span> <span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span>Abs <span class="free">ψ</span><span class="main">)</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ψ</span>
  <span class="keyword1"><span class="command">have</span></span> nonempty_Σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Σ</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reach <span class="free">Σ</span> <span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span>Abs <span class="skolem">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?A</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> af_G_abs.finite_abs_reach finite_subset<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A <span class="main"><span class="main">=</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"lift_ltl_transformer.abs_reach af_G_letter <span class="main">(</span>Abs <span class="skolem">ψ</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> af_G_abs.abs_reach_def af_G_letter_abs_def reach_foldl_def<span class="main">[</span><span class="operator">OF</span> nonempty_Σ<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Single Secondary Automaton›</span></span>

<span class="keyword1"><span class="command">locale</span></span> ltl_FG_to_rabin_def <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> 
    <span class="free">Σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">𝒢</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> 
    <span class="free">w</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set word"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> mojmir_to_rabin_def <span class="quoted"><span class="free">Σ</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub></span>"</span></span> <span class="quoted"><span class="quoted">"Abs <span class="free">φ</span>"</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="comment1">― ‹Import abbreviations from parent locale to simplify terms›</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">≡</span> step"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">q<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">≡</span> initial"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">Acc<span class="hidden">⇩</span><sub>R</sub></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≡</span> <span class="main">(</span>fail<span class="hidden">⇩</span><sub>R</sub> <span class="main">∪</span> merge<span class="hidden">⇩</span><sub>R</sub> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">,</span> succeed<span class="hidden">⇩</span><sub>R</sub> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">max_rank<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">≡</span> max_rank"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">smallest_accepting_rank<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">≡</span> smallest_accepting_rank"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">accept<span class="hidden">⇩</span><sub>R</sub>'</span> <span class="main">≡</span> accept"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝒮<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">≡</span> 𝒮"</span></span>

<span class="keyword1" id="LTL_Rabin-Rep_token_run_af"><span class="command">lemma</span></span> Rep_token_run_af<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Rep <span class="main">(</span>token_run <span class="free">x</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="free">x</span> <span class="main">→</span> <span class="free">n</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"token_run <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> Abs <span class="main">(</span>af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="main">(</span><span class="main">(</span>suffix <span class="free">x</span> <span class="free">w</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subsequence_def run_foldl<span class="main"><span class="keyword3">;</span></span> <span class="operator">metis</span> af_G_abs.f_foldl_abs.abs_eq af_G_abs.f_foldl_abs_alt_def af_G_letter_abs_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Rep <span class="main">(</span>token_run <span class="free">x</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="main">(</span><span class="main">(</span>suffix <span class="free">x</span> <span class="free">w</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ltl<span class="hidden">⇩</span><sub>P</sub>_abs_rep ltl_prop_equiv_quotient.abs_eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ltl_prop_equiv_def subsequence_shift <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">n</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subsequence_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> ltl_FG_to_rabin <span class="main">=</span> ltl_FG_to_rabin_def <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
    wellformed_𝒢<span class="main">:</span> <span class="quoted"><span class="quoted">"Only_G <span class="free">𝒢</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    bounded_w<span class="main">:</span> <span class="quoted"><span class="quoted">"range <span class="free">w</span> <span class="main">⊆</span> <span class="free">Σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    finite_Σ<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Σ</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">sublocale</span></span> mojmir_to_rabin <span class="quoted"><span class="free">Σ</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub></span>"</span></span> <span class="quoted"><span class="quoted">"Abs <span class="free">φ</span>"</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">ν</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">}</span> <span class="main">⟹</span> <span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub></span><span class="bound">q</span> <span class="bound">ν</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wellformed_𝒢 af_G_letter_sat_core_lifted <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> nonempty_Σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Σ</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bounded_w <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reach <span class="free">Σ</span> <span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub></span><span class="main">(</span>Abs <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?A</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> af_G_abs.finite_abs_reach finite_subset<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A <span class="main"><span class="main">=</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"lift_ltl_transformer.abs_reach af_G_letter <span class="main">(</span>Abs <span class="free">φ</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> af_G_abs.abs_reach_def af_G_letter_abs_def reach_foldl_def<span class="main">[</span><span class="operator">OF</span> nonempty_Σ<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> finite_Σ bounded_w<span class="main">)</span>

<span class="keyword1" id="LTL_Rabin-ltl_to_rabin_correct_exposed'"><span class="command">lemma</span></span> ltl_to_rabin_correct_exposed'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">𝔓<span class="hidden">⇩</span><sub>∞</sub></span> <span class="free">φ</span> <span class="free">𝒢</span> <span class="free">w</span> <span class="main">⟷</span> accept"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="main">(</span>map <span class="free">w</span> <span class="main">[</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">(</span><span class="bound">j</span> <span class="main">-</span> <span class="skolem">i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 𝔓 <span class="free">φ</span> <span class="free">𝒢</span> <span class="free">w</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subsequence_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> add_diff_cancel_left' le_Suc_ex nat_le_linear upt_conv_Nil <span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="skolem">i</span> <span class="main">→</span> <span class="bound">j</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> run af_G_letter <span class="free">φ</span> <span class="main">(</span>suffix <span class="skolem">i</span> <span class="free">w</span><span class="main">)</span> <span class="main">(</span><span class="bound">j</span><span class="main">-</span><span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">⟷</span> <span class="main">_</span>"</span></span><span class="main">)</span> 
      <span class="keyword1"><span class="command">unfolding</span></span> run_foldl <span class="keyword1"><span class="command">using</span></span> subsequence_shift subsequence_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="main">(</span>run <span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub></span><span class="main">(</span>Abs <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>suffix <span class="skolem">i</span> <span class="free">w</span><span class="main">)</span> <span class="main">(</span><span class="bound">j</span><span class="main">-</span><span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Quotient3_ltl_prop_equiv_quotient<span class="main">[</span><span class="operator">THEN</span> Quotient3_rep_abs<span class="main">]</span> 
      <span class="keyword1"><span class="command">unfolding</span></span> ltl_prop_equiv_def run_af_G_letter_abs_eq_Abs_af_G_letter <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j</span><span class="main">.</span> token_run <span class="skolem">i</span> <span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> token_succeeds <span class="skolem">i</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟷</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> token_succeeds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">⟷</span> <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> almost_all_eventually_provable_def accept_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LTL_Rabin-ltl_to_rabin_correct_exposed"><span class="command">lemma</span></span> ltl_to_rabin_correct_exposed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">𝔓<span class="hidden">⇩</span><sub>∞</sub></span> <span class="free">φ</span> <span class="free">𝒢</span> <span class="free">w</span> <span class="main">⟷</span> accept<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>δ<span class="hidden">⇩</span><sub>R</sub><span class="main">,</span> q<span class="hidden">⇩</span><sub>R</sub><span class="main">,</span> <span class="main">{</span>Acc<span class="hidden">⇩</span><sub>R</sub> <span class="bound">i</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> max_rank<span class="hidden">⇩</span><sub>R</sub><span class="main">}</span><span class="main">)</span> <span class="free">w</span>"</span></span>  
  <span class="keyword1"><span class="command">unfolding</span></span> ltl_to_rabin_correct_exposed' mojmir_accept_iff_rabin_accept <span class="keyword1"><span class="command">..</span></span>

<span class="comment1">― ‹Import lemmas from parent locale to simplify assumptions›</span>
<span class="keyword1"><span class="command">lemmas</span></span> max_rank_lowerbound <span class="main">=</span> max_rank_lowerbound
<span class="keyword1"><span class="command">lemmas</span></span> state_rank_step_foldl <span class="main">=</span> state_rank_step_foldl
<span class="keyword1"><span class="command">lemmas</span></span> smallest_accepting_rank_properties <span class="main">=</span> smallest_accepting_rank_properties 
<span class="keyword1"><span class="command">lemmas</span></span> wellformed_ℛ <span class="main">=</span> wellformed_ℛ

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ltl_to_rabin</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ltl_to_rabin</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒢</span></span></span> <span class="main">=</span> <span class="main">(</span>ltl_FG_to_rabin_def.δ<span class="hidden">⇩</span><sub>R</sub> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">,</span> ltl_FG_to_rabin_def.q<span class="hidden">⇩</span><sub>R</sub> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">,</span> <span class="main">{</span>ltl_FG_to_rabin_def.Acc<span class="hidden">⇩</span><sub>R</sub> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">𝒢</span></span></span> <span class="bound">i</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> ltl_FG_to_rabin_def.max_rank<span class="hidden">⇩</span><sub>R</sub> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> 
    <span class="free">Σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
    finite_Σ<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Σ</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="LTL_Rabin-ltl_to_rabin_correct"><span class="command">lemma</span></span> ltl_to_rabin_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"range <span class="free">w</span> <span class="main">⊆</span> <span class="free">Σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">F</span> <span class="keyword1">G</span> <span class="free">φ</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">𝒢</span></span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">φ</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">G</span> <span class="free">φ</span> <span class="main">∈</span> <span class="bound">𝒢</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ψ</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="bound">𝒢</span> <span class="main">⟶</span> accept<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>ltl_to_rabin <span class="free">Σ</span> <span class="bound">ψ</span> <span class="bound">𝒢</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">𝒢</span> <span class="bound">ψ</span><span class="main">.</span> <span class="bound">𝒢</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">φ</span><span class="main">)</span> <span class="main">⟹</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="bound">𝒢</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">𝔓<span class="hidden">⇩</span><sub>∞</sub></span> <span class="bound">ψ</span> <span class="bound">𝒢</span> <span class="free">w</span> <span class="main">⟷</span> accept<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>ltl_to_rabin <span class="free">Σ</span> <span class="bound">ψ</span> <span class="bound">𝒢</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">𝒢</span> <span class="skolem">ψ</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">𝒢</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">G</span> <span class="skolem">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> ltl_FG_to_rabin <span class="quoted"><span class="free">Σ</span></span> <span class="quoted"><span class="skolem">ψ</span></span> <span class="quoted"><span class="skolem">𝒢</span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_Σ assms G_nested_propos_alt_def 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">𝔓<span class="hidden">⇩</span><sub>∞</sub></span> <span class="skolem">ψ</span> <span class="skolem">𝒢</span> <span class="free">w</span> <span class="main">⟷</span> accept<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>ltl_to_rabin <span class="free">Σ</span> <span class="skolem">ψ</span> <span class="skolem">𝒢</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> ltl_to_rabin_correct_exposed <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> 𝒢_elements<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="keyword1">G</span> <span class="free">φ</span>"</span></span><span class="main">]</span> 𝒢_finite<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="keyword1">G</span> <span class="free">φ</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> ltl_FG_logical_characterization G_nested_propos.simps 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹LTL-to-Mojmir Lemmas›</span></span> 
                        
<span class="keyword1" id="LTL_Rabin-ℱ_eq_𝒮"><span class="command">lemma</span></span> ℱ_eq_𝒮<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite_Σ<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bounded_w<span class="main">:</span> <span class="quoted"><span class="quoted">"range <span class="free">w</span> <span class="main">⊆</span> <span class="free">Σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">𝒢</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">G</span> <span class="free">ψ</span> <span class="main">∈</span> <span class="free">𝒢</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">S</span><span class="main">.</span> <span class="main">(</span><span class="bound">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> ℱ <span class="free">ψ</span> <span class="free">w</span> <span class="free">𝒢</span> <span class="bound">j</span> <span class="main">∧</span> <span class="free">𝒢</span> <span class="main">⊆</span> <span class="bound">S</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> <span class="main">(</span>ltl_FG_to_rabin_def.𝒮<span class="hidden">⇩</span><sub>R</sub> <span class="free">Σ</span> <span class="free">ψ</span> <span class="free">𝒢</span> <span class="free">w</span> <span class="bound">j</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?F</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">}</span>"</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> the <span class="main">(</span>threshold <span class="free">ψ</span> <span class="free">w</span> <span class="free">𝒢</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"threshold <span class="free">ψ</span> <span class="free">w</span> <span class="free">𝒢</span> <span class="main">=</span> Some <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> threshold.simps index.simps almost_all_eventually_provable_def  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Only_G <span class="free">𝒢</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms G_nested_propos_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> ltl_FG_to_rabin <span class="quoted"><span class="free">Σ</span></span> <span class="quoted"><span class="free">ψ</span></span> <span class="quoted"><span class="free">𝒢</span></span> <span class="quoted"><span class="free">w</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_Σ bounded_w <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"accept"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ltl_to_rabin_correct_exposed' assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"smallest_accepting_rank <span class="main">=</span> Some <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> smallest_accepting_rank_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  
  <span class="comment1">(* Wait until succeeding states can be recognised *)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">m</span> <span class="main">≥</span> <span class="skolem">n<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> configuration <span class="bound">q</span> <span class="bound">m</span><span class="main">.</span> token_succeeds <span class="bound">x</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">q</span> <span class="main">∈</span> 𝒮 <span class="bound">m</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">q</span> <span class="main">∈</span> 𝒮 <span class="bound">m</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> configuration <span class="bound">q</span> <span class="bound">m</span><span class="main">.</span> token_succeeds <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> succeeding_states<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹smallest_accepting_rank <span class="main">=</span> Some <span class="skolem">i</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> MOST_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="comment1">(* Wait until all "early" succeeding tokens reached the final states *)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">k</span> <span class="main">⟹</span> token_succeeds <span class="bound">x</span> <span class="main">⟹</span> token_run <span class="bound">x</span> <span class="skolem">n<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> <span class="var">?F</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> token_stays_in_final_states add.commute le_neq_implies_less not_less not_less_eq token_succeeds_def<span class="main">)</span> 
  
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> Max <span class="main">{</span><span class="skolem">n<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">n<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">k</span><span class="main">}</span>"</span></span>
  
  <span class="comment1">(* Prove properties for the larger n *)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> <span class="skolem">q</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> <span class="skolem">m</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> n_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> configuration <span class="skolem">q</span> <span class="skolem">m</span><span class="main">.</span> token_succeeds <span class="bound">x</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">q</span> <span class="main">∈</span> 𝒮 <span class="skolem">m</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">q</span> <span class="main">∈</span> 𝒮 <span class="skolem">m</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> configuration <span class="skolem">q</span> <span class="skolem">m</span><span class="main">.</span> token_succeeds <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">m</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">m</span> <span class="main">≥</span> <span class="skolem">n<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> configuration <span class="bound">q</span> <span class="bound">m</span><span class="main">.</span> token_succeeds <span class="bound">x</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">q</span> <span class="main">∈</span> 𝒮 <span class="bound">m</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">q</span> <span class="main">∈</span> 𝒮 <span class="bound">m</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> configuration <span class="bound">q</span> <span class="bound">m</span><span class="main">.</span> token_succeeds <span class="bound">x</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> n_def_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">m</span> <span class="main">≥</span> <span class="skolem">n</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> configuration <span class="bound">q</span> <span class="bound">m</span><span class="main">.</span> token_succeeds <span class="bound">x</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">q</span> <span class="main">∈</span> 𝒮 <span class="bound">m</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">q</span> <span class="main">∈</span> 𝒮 <span class="bound">m</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> configuration <span class="bound">q</span> <span class="bound">m</span><span class="main">.</span> token_succeeds <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">have</span></span> n_def_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">m</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">k</span> <span class="main">⟹</span> <span class="bound">m</span> <span class="main">≥</span> <span class="skolem">n</span> <span class="main">⟹</span> token_succeeds <span class="bound">x</span> <span class="main">⟹</span> token_run <span class="bound">x</span> <span class="bound">m</span> <span class="main">∈</span> <span class="var">?F</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="skolem">k</span> <span class="main">⟹</span> token_succeeds <span class="bound">x</span> <span class="main">⟹</span> token_run <span class="bound">x</span> <span class="skolem">n<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">∈</span> <span class="var">?F</span>›</span></span> Max.coboundedI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">n<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">n<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="skolem">k</span><span class="main">}</span>"</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">using</span></span> token_stays_in_final_states<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">n<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main">]</span> le_Suc_ex <span class="keyword1"><span class="command">unfolding</span></span> n_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span> <span class="skolem">m</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> Suc <span class="skolem">m</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> ℱ <span class="free">ψ</span> <span class="free">w</span> <span class="free">𝒢</span> <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝒢</span> <span class="main">⊆</span> <span class="skolem">S</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">k</span> <span class="main">≤</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≤</span> Suc <span class="skolem">m</span> <span class="main">⟹</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">ψ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="bound">x</span> <span class="main">→</span> <span class="skolem">m</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> And_prop_entailment ℱ_def k_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> subsequence_def
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> 𝒮 <span class="skolem">m</span>"</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="skolem">q</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="var">?F</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">from</span></span> False <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"state_rank <span class="skolem">q</span> <span class="skolem">m</span> <span class="main">=</span> Some <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> <span class="skolem">i</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">q</span> <span class="main">∈</span> 𝒮 <span class="skolem">m</span>›</span></span> <span class="quoted"><span class="quoted">‹smallest_accepting_rank <span class="main">=</span> Some <span class="skolem">i</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> configuration <span class="skolem">q</span> <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">x</span> <span class="skolem">m</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"token_succeeds <span class="skolem">x</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> n_def_1<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">≤</span> <span class="skolem">m</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">q</span> <span class="main">∈</span> 𝒮 <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">ultimately</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">ψ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">m</span><span class="main">]</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">k</span> <span class="main">≤</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≤</span> Suc <span class="skolem">m</span> <span class="main">⟹</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">ψ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="bound">x</span> <span class="main">→</span> <span class="skolem">m</span><span class="main">]</span><span class="main">)</span>›</span></span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> n_def_2<span class="main">[</span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">≤</span> <span class="skolem">m</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> Rep_token_run_af <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹token_run <span class="skolem">x</span> <span class="skolem">m</span> <span class="main">=</span> <span class="skolem">q</span>›</span></span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> ltl_prop_equiv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
       <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> <span class="quoted"><span class="quoted">‹<span class="free">𝒢</span> <span class="main">⊆</span> <span class="skolem">S</span>›</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    
    <span class="keyword1"><span class="command">moreover</span></span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> 𝒮 <span class="skolem">m</span> <span class="main">⟹</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> <span class="var">?F</span> <span class="main">⟹</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝒢</span> <span class="main">⊆</span> <span class="skolem">S</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> 
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">𝒢</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹Only_G <span class="free">𝒢</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> <span class="var">?F</span> <span class="main">⟹</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span>›</span></span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Abs <span class="skolem">x</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword1"><span class="command">{</span></span> 
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">m</span>"</span></span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> token_run <span class="skolem">x</span> <span class="skolem">m</span>"</span></span>

        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"token_succeeds <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> threshold_properties<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted"><span class="quoted">‹threshold <span class="free"><span class="free">ψ</span></span> <span class="free"><span class="free">w</span></span> <span class="free"><span class="free">𝒢</span></span> <span class="main"><span class="main">=</span></span> Some <span class="skolem"><span class="skolem">k</span></span>›</span></span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≥</span> <span class="skolem">k</span>›</span></span> Rep_token_run_af  
          <span class="keyword1"><span class="command">unfolding</span></span> token_succeeds_def ltl_prop_equiv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> 𝒮 <span class="skolem">m</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> n_def_1<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">≤</span> <span class="skolem">m</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">m</span>›</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> q_def configuration.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="skolem">q</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> 𝒮 <span class="skolem">m</span> <span class="main">⟹</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span>›</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">ψ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="skolem">x</span> <span class="main">→</span> <span class="skolem">m</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Rep_token_run_af <span class="keyword1"><span class="command">unfolding</span></span> q_def ltl_prop_equiv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span>set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> af<span class="hidden">⇩</span><sub>G</sub> <span class="free">ψ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="bound">i</span> <span class="main">→</span> <span class="skolem">m</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="skolem">k</span><span class="main">..&lt;</span>Suc <span class="skolem">m</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> set_map set_upt <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> ℱ <span class="free">ψ</span> <span class="free">w</span> <span class="free">𝒢</span> <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝒢</span> <span class="main">⊆</span> <span class="skolem">S</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> ℱ_def And_prop_entailment<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">S</span></span><span class="main">]</span> k_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">≤</span> <span class="skolem">m</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">𝒢</span> <span class="main">⊆</span> <span class="skolem">S</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span> 
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> ℱ <span class="free">ψ</span> <span class="free">w</span> <span class="free">𝒢</span> <span class="skolem">m</span> <span class="main">∧</span> <span class="free">𝒢</span> <span class="main">⊆</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> 𝒮 <span class="skolem">m</span> <span class="main">⟶</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> MOST_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LTL_Rabin-ℱ_eq_𝒮_generalized"><span class="command">lemma</span></span> ℱ_eq_𝒮_generalized<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite_Σ<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bounded_w<span class="main">:</span> <span class="quoted"><span class="quoted">"range <span class="free">w</span> <span class="main">⊆</span> <span class="free">Σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"closed <span class="free">𝒢</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">j</span><span class="main">.</span> <span class="main">∀</span><span class="bound">ψ</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="free">𝒢</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">S</span><span class="main">.</span> <span class="main">(</span><span class="bound">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> ℱ <span class="bound">ψ</span> <span class="free">w</span> <span class="free">𝒢</span> <span class="bound">j</span> <span class="main">∧</span> <span class="free">𝒢</span> <span class="main">⊆</span> <span class="bound">S</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> <span class="main">(</span>ltl_FG_to_rabin_def.𝒮<span class="hidden">⇩</span><sub>R</sub> <span class="free">Σ</span> <span class="bound">ψ</span> <span class="free">𝒢</span><span class="main">)</span> <span class="free">w</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="bound">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Only_G <span class="free">𝒢</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">𝒢</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> almost_all_commutative''<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="free">𝒢</span>›</span></span> <span class="quoted"><span class="quoted">‹Only_G <span class="free">𝒢</span>›</span></span><span class="main">]</span> ℱ_eq_𝒮<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Product of Secondary Automata›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> 
    <span class="free">Σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">product_initial_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇀</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ι<span class="hidden">⇩</span><sub>×</sub></span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ι<span class="hidden">⇩</span><sub>×</sub></span></span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>m</sub></span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">k</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">K</span></span></span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>m</sub></span></span></span> <span class="bound">k</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">combine_pairs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> transition set <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> transition set<span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> transition set <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> transition set set<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">combine_pairs</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>fst <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span><span class="main">,</span> snd <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">combine_pairs'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> ltl <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> ltl_prop_equiv_quotient <span class="main">⇒</span> nat option<span class="main">)</span> option<span class="main">,</span> <span class="tfree">'a</span> set<span class="main">)</span> transition set <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> ltl <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> ltl_prop_equiv_quotient <span class="main">⇒</span> nat option<span class="main">)</span> option<span class="main">,</span> <span class="tfree">'a</span> set<span class="main">)</span> transition set<span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> ltl <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> ltl_prop_equiv_quotient <span class="main">⇒</span> nat option<span class="main">)</span> option<span class="main">,</span> <span class="tfree">'a</span> set<span class="main">)</span> transition set <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> ltl <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> ltl_prop_equiv_quotient <span class="main">⇒</span> nat option<span class="main">)</span> option<span class="main">,</span> <span class="tfree">'a</span> set<span class="main">)</span> transition set set<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">combine_pairs'</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>fst <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span><span class="main">,</span> snd <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="LTL_Rabin-combine_pairs_prop"><span class="command">lemma</span></span> combine_pairs_prop<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">P</span> <span class="main">∈</span> <span class="free">𝒫</span><span class="main">.</span> accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">P</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>combine_pairs <span class="free">𝒫</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LTL_Rabin-combine_pairs2"><span class="command">lemma</span></span> combine_pairs2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"combine_pairs <span class="free">𝒫</span> <span class="main">∈</span> <span class="free">α</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> <span class="bound">P</span> <span class="main">∈</span> <span class="free">𝒫</span> <span class="main">⟹</span> accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">P</span> <span class="free">w</span> <span class="main">)</span> <span class="main">⟹</span> accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span><span class="free">δ</span><span class="main">,</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">α</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> combine_pairs_prop<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">𝒫</span></span> <span class="quoted"><span class="free">δ</span></span> <span class="quoted"><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="LTL_Rabin-combine_pairs'_prop"><span class="command">lemma</span></span> combine_pairs'_prop<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">P</span> <span class="main">∈</span> <span class="free">𝒫</span><span class="main">.</span> accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">P</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>combine_pairs' <span class="free">𝒫</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ltl_FG_to_generalized_rabin</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> ltl <span class="main">⇀</span> <span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub> <span class="main">⇀</span> nat<span class="main">,</span> <span class="tfree">'a</span> set<span class="main">)</span> generalized_rabin_automaton"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒫</span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ltl_FG_to_generalized_rabin</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">Δ<span class="hidden">⇩</span><sub>×</sub></span> <span class="main">(</span><span class="main">λ</span><span class="bound">χ</span><span class="main">.</span> ltl_FG_to_rabin_def.δ<span class="hidden">⇩</span><sub>R</sub> <span class="free">Σ</span> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> 
    <span class="keyword1">ι<span class="hidden">⇩</span><sub>×</sub></span> <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="main">(</span><span class="keyword1">G</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">χ</span><span class="main">.</span> ltl_FG_to_rabin_def.q<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
    <span class="main">{</span>combine_pairs' <span class="main">{</span>embed_pair <span class="bound">χ</span> <span class="main">(</span>ltl_FG_to_rabin_def.Acc<span class="hidden">⇩</span><sub>R</sub> <span class="free">Σ</span> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span> <span class="bound">𝒢</span> <span class="main">(</span><span class="bound">π</span> <span class="bound">χ</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> <span class="bound">𝒢</span><span class="main">}</span> 
      <span class="main">|</span> <span class="bound">𝒢</span> <span class="bound">π</span><span class="main">.</span> <span class="bound">𝒢</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="main">(</span><span class="keyword1">G</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="keyword1">G</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∈</span> <span class="bound">𝒢</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">π</span> <span class="bound">χ</span> <span class="main">&lt;</span> ltl_FG_to_rabin_def.max_rank<span class="hidden">⇩</span><sub>R</sub> <span class="free">Σ</span> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
    finite_Σ<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Σ</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="LTL_Rabin-ltl_FG_to_generalized_rabin_wellformed"><span class="command">lemma</span></span> ltl_FG_to_generalized_rabin_wellformed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reach <span class="free">Σ</span> <span class="main">(</span>fst <span class="main">(</span><span class="keyword1">𝒫</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span><span class="keyword1">𝒫</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">Σ</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reach <span class="free">Σ</span> <span class="main">(</span><span class="keyword1">Δ<span class="hidden">⇩</span><sub>×</sub></span> <span class="main">(</span><span class="main">λ</span><span class="bound">χ</span><span class="main">.</span> ltl_FG_to_rabin_def.δ<span class="hidden">⇩</span><sub>R</sub> <span class="free">Σ</span> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span><span class="keyword1">𝒫</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> finite_reach_product<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 1
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> G_nested_finite<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dom_def LTL_Rabin.product_initial_state.simps<span class="main">)</span> 
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span><span class="keyword1">𝒫</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> ltl_FG_to_rabin_def.q<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>theG <span class="skolem">x</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LTL_Rabin.product_initial_state.simps<span class="main">)</span> 
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> ltl_FG_to_rabin.wellformed_ℛ<span class="main">[</span><span class="operator">unfolded</span> ltl_FG_to_rabin_def<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="main">_</span> <span class="quoted"><span class="free">Σ</span></span> <span class="quoted"><span class="quoted">"theG <span class="skolem">x</span>"</span></span><span class="main">]</span> finite_Σ False <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_def<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> ltl_FG_to_generalized_rabin_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"range <span class="free">w</span> <span class="main">⊆</span> <span class="free">Σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⊨</span> <span class="keyword1">F</span> <span class="keyword1">G</span> <span class="free">φ</span> <span class="main">=</span> accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span><span class="keyword1">𝒫</span> <span class="free">φ</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> run<span class="hidden">⇩</span><sub>t</sub> <span class="main">(</span>fst <span class="main">(</span><span class="keyword1">𝒫</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span><span class="keyword1">𝒫</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">w</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">Σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Σ</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>reach <span class="free">Σ</span> <span class="main">(</span>fst <span class="main">(</span><span class="keyword1">𝒫</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span><span class="keyword1">𝒫</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">)</span> <span class="main">×</span> <span class="free">Σ</span> <span class="main">×</span> <span class="main">(</span>reach <span class="free">Σ</span> <span class="main">(</span>fst <span class="main">(</span><span class="keyword1">𝒫</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span><span class="keyword1">𝒫</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">r</span> <span class="bound">n</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> run<span class="hidden">⇩</span><sub>t</sub>.simps run_foldl reach_foldl_def<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">Σ</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span><span class="main">]</span> r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"range <span class="skolem">r</span> <span class="main">⊆</span> <span class="var">?S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"finite <span class="var">?S</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ltl_FG_to_generalized_rabin_wellformed assms <span class="quoted"><span class="quoted">‹finite <span class="free">Σ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">𝒢</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">𝒢</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">G</span> <span class="free">φ</span> <span class="main">∈</span> <span class="skolem">𝒢</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ψ</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span> <span class="main">⟶</span> accept<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>ltl_to_rabin <span class="free">Σ</span> <span class="bound">ψ</span> <span class="skolem">𝒢</span><span class="main">)</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ltl_to_rabin_correct<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="free">Σ</span>›</span></span> <span class="quoted"><span class="quoted">‹range <span class="free">w</span> <span class="main">⊆</span> <span class="free">Σ</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> ltl_to_rabin.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
    <span class="keyword1"><span class="command">note</span></span> 𝒢_properties<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted"><span class="quoted">‹<span class="skolem"><span class="skolem">𝒢</span></span> <span class="main"><span class="main">⊆</span></span> <span class="keyword1"><span class="keyword1"><span class="hidden">❙</span><b>G</b></span></span> <span class="main"><span class="main">(</span></span><span class="keyword1"><span class="keyword1">G</span></span> <span class="free"><span class="free">φ</span></span><span class="main"><span class="main">)</span></span>›</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ltl_FG_to_rabin <span class="free">Σ</span> <span class="skolem">𝒢</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">Σ</span>›</span></span> <span class="quoted"><span class="quoted">‹range <span class="free">w</span> <span class="main">⊆</span> <span class="free">Σ</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ltl_FG_to_rabin_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">π</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="skolem">ψ</span> <span class="main">=</span>
        <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span> <span class="keyword1">then</span> the <span class="main">(</span>ltl_FG_to_rabin_def.smallest_accepting_rank<span class="hidden">⇩</span><sub>R</sub> <span class="free">Σ</span> <span class="main">(</span>theG <span class="skolem">ψ</span><span class="main">)</span> <span class="skolem">𝒢</span> <span class="free">w</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ψ</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main"><span class="hidden">❙</span><b>↿</b>⇩</span><span class="bound">χ</span> <span class="main">(</span>ltl_FG_to_rabin_def.Acc<span class="hidden">⇩</span><sub>R</sub> <span class="free">Σ</span> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span> <span class="skolem">𝒢</span> <span class="main">(</span><span class="skolem">π</span> <span class="bound">χ</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> <span class="skolem">𝒢</span><span class="main">}</span>"</span></span>
     
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P</span> <span class="main">∈</span> <span class="var">?P'</span><span class="main">.</span> accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>fst <span class="main">(</span><span class="keyword1">𝒫</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span><span class="keyword1">𝒫</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">P</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> 
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> <span class="var">?P'</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">χ</span></span> <span class="keyword2"><span class="keyword">where</span></span> P_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>↿</b>⇩</span><span class="skolem">χ</span> <span class="main">(</span>ltl_FG_to_rabin_def.Acc<span class="hidden">⇩</span><sub>R</sub> <span class="free">Σ</span> <span class="main">(</span>theG <span class="skolem">χ</span><span class="main">)</span> <span class="skolem">𝒢</span> <span class="main">(</span><span class="skolem">π</span> <span class="skolem">χ</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">χ</span> <span class="main">∈</span> <span class="skolem">𝒢</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">χ'</span><span class="main">.</span> <span class="skolem">χ</span> <span class="main">=</span> <span class="keyword1">G</span> <span class="bound">χ'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">𝒢</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">φ</span><span class="main">)</span>›</span></span> G_nested_propos_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      
      <span class="keyword1"><span class="command">interpret</span></span> ltl_FG_to_rabin <span class="quoted"><span class="free">Σ</span></span> <span class="quoted"><span class="quoted">"theG <span class="skolem">χ</span>"</span></span> <span class="quoted"><span class="skolem">𝒢</span></span> <span class="quoted"><span class="free">w</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> <span class="quoted"><span class="quoted">‹ltl_FG_to_rabin <span class="free">Σ</span> <span class="skolem">𝒢</span> <span class="free">w</span>›</span></span><span class="main">)</span>
     
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r<span class="hidden">⇩</span><sub>χ</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>χ</sub></span> <span class="main">=</span> run<span class="hidden">⇩</span><sub>t</sub> δ<span class="hidden">⇩</span><sub>ℛ</sub> q<span class="hidden">⇩</span><sub>ℛ</sub> <span class="free">w</span>"</span></span>
      
      <span class="keyword1"><span class="command">moreover</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"accept"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"accept<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>δ<span class="hidden">⇩</span><sub>ℛ</sub><span class="main">,</span> q<span class="hidden">⇩</span><sub>ℛ</sub><span class="main">,</span> <span class="main">{</span>Acc<span class="hidden">⇩</span><sub>ℛ</sub> <span class="bound">j</span> <span class="main">|</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> max_rank<span class="main">}</span><span class="main">)</span> <span class="free">w</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">χ</span> <span class="main">∈</span> <span class="skolem">𝒢</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">χ'</span><span class="main">.</span> <span class="skolem">χ</span> <span class="main">=</span> <span class="keyword1">G</span> <span class="bound">χ'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">ψ</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span> <span class="main">⟶</span> accept<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>ltl_to_rabin <span class="free">Σ</span> <span class="bound">ψ</span> <span class="skolem">𝒢</span><span class="main">)</span> <span class="free">w</span>›</span></span> 
        <span class="keyword1"><span class="command">using</span></span> mojmir_accept_iff_rabin_accept <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"smallest_accepting_rank<span class="hidden">⇩</span><sub>ℛ</sub> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">π</span> <span class="skolem">χ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> π_def smallest_accepting_rank_def Mojmir_rabin_smallest_accepting_rank<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">χ</span> <span class="main">∈</span> <span class="skolem">𝒢</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>R</sub> δ<span class="hidden">⇩</span><sub>ℛ</sub> q<span class="hidden">⇩</span><sub>ℛ</sub> <span class="main">(</span>Acc<span class="hidden">⇩</span><sub>ℛ</sub> <span class="main">(</span><span class="skolem">π</span> <span class="skolem">χ</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹accept<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>δ<span class="hidden">⇩</span><sub>ℛ</sub><span class="main">,</span> q<span class="hidden">⇩</span><sub>ℛ</sub><span class="main">,</span> <span class="main">{</span>Acc<span class="hidden">⇩</span><sub>ℛ</sub> <span class="bound">j</span> <span class="main">|</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> max_rank<span class="main">}</span><span class="main">)</span> <span class="free">w</span>›</span></span> LeastI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> accepting_pair<span class="hidden">⇩</span><sub>R</sub> δ<span class="hidden">⇩</span><sub>ℛ</sub> q<span class="hidden">⇩</span><sub>ℛ</sub> <span class="main">(</span>Acc<span class="hidden">⇩</span><sub>ℛ</sub> <span class="bound">i</span><span class="main">)</span> <span class="free">w</span>"</span></span><span class="main">]</span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> smallest_accepting_rank<span class="hidden">⇩</span><sub>ℛ</sub>_def<span class="main">)</span>

      <span class="keyword1"><span class="command">ultimately</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"limit <span class="skolem">r<span class="hidden">⇩</span><sub>χ</sub></span> <span class="main">∩</span> fst <span class="main">(</span>Acc<span class="hidden">⇩</span><sub>ℛ</sub> <span class="main">(</span><span class="skolem">π</span> <span class="skolem">χ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"limit <span class="skolem">r<span class="hidden">⇩</span><sub>χ</sub></span> <span class="main">∩</span> snd <span class="main">(</span>Acc<span class="hidden">⇩</span><sub>ℛ</sub> <span class="main">(</span><span class="skolem">π</span> <span class="skolem">χ</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

      <span class="keyword1"><span class="command">moreover</span></span>

      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">ι<span class="hidden">⇩</span><sub>×</sub></span> <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">χ</span><span class="main">.</span> ltl_FG_to_rabin_def.q<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">χ</span> <span class="main">=</span> Some q<span class="hidden">⇩</span><sub>ℛ</sub>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">χ</span> <span class="main">∈</span> <span class="skolem">𝒢</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">𝒢</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">φ</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LTL_Rabin.product_initial_state.simps subset_iff<span class="main">)</span> 
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="main">(</span>run<span class="hidden">⇩</span><sub>t</sub> 
              <span class="main">(</span><span class="keyword1">Δ<span class="hidden">⇩</span><sub>×</sub></span> <span class="main">(</span><span class="main">λ</span><span class="bound">χ</span><span class="main">.</span> ltl_FG_to_rabin_def.δ<span class="hidden">⇩</span><sub>R</sub> <span class="free">Σ</span> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="main">(</span><span class="keyword1">ι<span class="hidden">⇩</span><sub>×</sub></span> <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">χ</span><span class="main">.</span> ltl_FG_to_rabin_def.q<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
              <span class="free">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>range <span class="skolem">r</span><span class="main">)</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> r_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"limit <span class="skolem">r</span> <span class="main">∩</span> fst <span class="skolem">P</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"limit <span class="skolem">r</span> <span class="main">∩</span> snd <span class="skolem">P</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> product_run_embed_limit_finiteness<span class="main">[</span><span class="operator">OF</span> 1 2<span class="main">]</span> 
        <span class="keyword1"><span class="command">unfolding</span></span> r_def r<span class="hidden">⇩</span><sub>χ</sub>_def P_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>fst <span class="main">(</span><span class="keyword1">𝒫</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span><span class="keyword1">𝒫</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">P</span> <span class="free">w</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> P_def r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>fst <span class="main">(</span><span class="keyword1">𝒫</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span><span class="keyword1">𝒫</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>combine_pairs' <span class="var">?P'</span><span class="main">)</span> <span class="free">w</span>"</span></span>  
      <span class="keyword1"><span class="command">using</span></span> combine_pairs'_prop <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ψ</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">χ</span><span class="main">.</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="keyword1">G</span> <span class="bound">χ</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">𝒢</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">φ</span><span class="main">)</span>›</span></span> G_nested_propos_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">interpret</span></span> ltl_FG_to_rabin <span class="quoted"><span class="free">Σ</span></span> <span class="quoted"><span class="quoted">"theG <span class="skolem">ψ</span>"</span></span> <span class="quoted"><span class="skolem">𝒢</span></span> <span class="quoted"><span class="free">w</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> <span class="quoted"><span class="quoted">‹ltl_FG_to_rabin <span class="free">Σ</span> <span class="skolem">𝒢</span> <span class="free">w</span>›</span></span><span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"accept"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">χ</span><span class="main">.</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="keyword1">G</span> <span class="bound">χ</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">ψ</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span> <span class="main">⟶</span> accept<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>ltl_to_rabin <span class="free">Σ</span> <span class="bound">ψ</span> <span class="skolem">𝒢</span><span class="main">)</span> <span class="free">w</span>›</span></span>  mojmir_accept_iff_rabin_accept <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"smallest_accepting_rank <span class="main">=</span> Some <span class="skolem">i</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> smallest_accepting_rank_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="skolem">ψ</span> <span class="main">&lt;</span> max_rank<span class="hidden">⇩</span><sub>R</sub>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> smallest_accepting_rank_properties π_def <span class="quoted"><span class="quoted">‹<span class="skolem">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="skolem">π</span> <span class="bound">χ</span> <span class="main">&lt;</span> ltl_FG_to_rabin_def.max_rank<span class="hidden">⇩</span><sub>R</sub> <span class="free">Σ</span> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> π_def <span class="keyword1"><span class="command">using</span></span> ltl_FG_to_rabin.max_rank_lowerbound<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹ltl_FG_to_rabin <span class="free">Σ</span> <span class="skolem">𝒢</span> <span class="free">w</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"combine_pairs' <span class="var">?P'</span> <span class="main">∈</span> snd <span class="main">(</span>snd <span class="main">(</span><span class="keyword1">𝒫</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">𝒢</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">φ</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">G</span> <span class="free">φ</span> <span class="main">∈</span> <span class="skolem">𝒢</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_simp2 ltl_FG_to_generalized_rabin.simps fst_conv snd_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">𝒢</span></span> <span class="skolem"><span class="skolem">π</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> combine_pairs' <span class="main">{</span><span class="main"><span class="hidden">❙</span><b>↿</b>⇩</span><span class="bound">χ</span> <span class="main">(</span>ltl_FG_to_rabin_def.Acc<span class="hidden">⇩</span><sub>R</sub> <span class="free">Σ</span> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span> <span class="skolem">𝒢</span> <span class="main">(</span><span class="skolem">π</span> <span class="bound">χ</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> <span class="skolem">𝒢</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> combine_pairs' <span class="var">?P'</span>"</span></span><span class="main">)</span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>fst <span class="main">(</span><span class="keyword1">𝒫</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span><span class="keyword1">𝒫</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">P</span> <span class="free">w</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">𝒢</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">G</span> <span class="free">φ</span> <span class="main">∈</span> <span class="skolem">𝒢</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="skolem">π</span> <span class="bound">χ</span> <span class="main">&lt;</span> ltl_FG_to_rabin_def.max_rank<span class="hidden">⇩</span><sub>R</sub> <span class="free">Σ</span> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> P'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> <span class="bound">P</span> <span class="main">∈</span> <span class="var">?P'</span> <span class="main">⟹</span> accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>fst <span class="main">(</span><span class="keyword1">𝒫</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span><span class="keyword1">𝒫</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">P</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> combine_pairs'_prop <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span>
    <span class="keyword1"><span class="command">note</span></span> 𝒢_properties<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted"><span class="quoted">‹<span class="skolem"><span class="skolem">𝒢</span></span> <span class="main"><span class="main">⊆</span></span> <span class="keyword1"><span class="keyword1"><span class="hidden">❙</span><b>G</b></span></span> <span class="main"><span class="main">(</span></span><span class="keyword1"><span class="keyword1">G</span></span> <span class="free"><span class="free">φ</span></span><span class="main"><span class="main">)</span></span>›</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ltl_FG_to_rabin <span class="free">Σ</span> <span class="skolem">𝒢</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">Σ</span>›</span></span> <span class="quoted"><span class="quoted">‹range <span class="free">w</span> <span class="main">⊆</span> <span class="free">Σ</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ltl_FG_to_rabin_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ψ</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span> <span class="main">⟶</span> accept<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>ltl_to_rabin <span class="free">Σ</span> <span class="bound">ψ</span> <span class="skolem">𝒢</span><span class="main">)</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ψ</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">G</span> <span class="skolem">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">χ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">χ</span> <span class="main">=</span> <span class="keyword1">G</span> <span class="skolem">ψ</span>"</span></span> 
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> <span class="main"><span class="hidden">❙</span><b>↿</b>⇩</span><span class="skolem">χ</span> <span class="main">(</span>ltl_FG_to_rabin_def.Acc<span class="hidden">⇩</span><sub>R</sub> <span class="free">Σ</span> <span class="skolem">ψ</span> <span class="skolem">𝒢</span> <span class="main">(</span><span class="skolem">π</span> <span class="skolem">χ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">χ</span> <span class="main">∈</span> <span class="skolem">𝒢</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"theG <span class="skolem">χ</span> <span class="main">=</span> <span class="skolem">ψ</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> χ_def <span class="quoted"><span class="quoted">‹<span class="keyword1">G</span> <span class="skolem">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> <span class="var">?P'</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> P_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>fst <span class="main">(</span><span class="keyword1">𝒫</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span><span class="keyword1">𝒫</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">P</span> <span class="free">w</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> P'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

      <span class="keyword1"><span class="command">interpret</span></span> ltl_FG_to_rabin <span class="quoted"><span class="free">Σ</span></span> <span class="quoted"><span class="skolem">ψ</span></span> <span class="quoted"><span class="skolem">𝒢</span></span> <span class="quoted"><span class="free">w</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> <span class="quoted"><span class="quoted">‹ltl_FG_to_rabin <span class="free">Σ</span> <span class="skolem">𝒢</span> <span class="free">w</span>›</span></span><span class="main">)</span>

      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r<span class="hidden">⇩</span><sub>χ</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>χ</sub></span> <span class="main">=</span> run<span class="hidden">⇩</span><sub>t</sub> δ<span class="hidden">⇩</span><sub>ℛ</sub> q<span class="hidden">⇩</span><sub>ℛ</sub> <span class="free">w</span>"</span></span>
      
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"limit <span class="skolem">r</span> <span class="main">∩</span> fst <span class="skolem">P</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"limit <span class="skolem">r</span> <span class="main">∩</span> snd <span class="skolem">P</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>fst <span class="main">(</span><span class="keyword1">𝒫</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span><span class="keyword1">𝒫</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">P</span> <span class="free">w</span>›</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> r_def accepting_pair<span class="hidden">⇩</span><sub>R</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>

      <span class="keyword1"><span class="command">moreover</span></span>

      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">ι<span class="hidden">⇩</span><sub>×</sub></span> <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">χ</span><span class="main">.</span> ltl_FG_to_rabin_def.q<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">G</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="main">=</span> Some q<span class="hidden">⇩</span><sub>ℛ</sub>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">G</span> <span class="skolem">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">𝒢</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">φ</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> LTL_Rabin.product_initial_state.simps subset_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="main">(</span>run<span class="hidden">⇩</span><sub>t</sub> <span class="main">(</span><span class="keyword1">Δ<span class="hidden">⇩</span><sub>×</sub></span> <span class="main">(</span><span class="main">λ</span><span class="bound">χ</span><span class="main">.</span> ltl_FG_to_rabin_def.δ<span class="hidden">⇩</span><sub>R</sub> <span class="free">Σ</span> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">ι<span class="hidden">⇩</span><sub>×</sub></span> <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">χ</span><span class="main">.</span> ltl_FG_to_rabin_def.q<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>  <span class="free">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>range <span class="skolem">r</span><span class="main">)</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> r_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">S</span><span class="main">.</span> limit <span class="skolem">r</span> <span class="main">∩</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="main">↿⇩</span><span class="skolem">χ</span> <span class="main">`</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> limit <span class="skolem">r<span class="hidden">⇩</span><sub>χ</sub></span> <span class="main">∩</span> <span class="bound">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> product_run_embed_limit_finiteness<span class="main">[</span><span class="operator">OF</span> 1 2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_def r<span class="hidden">⇩</span><sub>χ</sub>_def χ_def<span class="main">)</span>

      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"limit <span class="skolem">r<span class="hidden">⇩</span><sub>χ</sub></span> <span class="main">∩</span> fst <span class="main">(</span>Acc<span class="hidden">⇩</span><sub>ℛ</sub> <span class="main">(</span><span class="skolem">π</span> <span class="skolem">χ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"limit <span class="skolem">r<span class="hidden">⇩</span><sub>χ</sub></span> <span class="main">∩</span> snd <span class="main">(</span>Acc<span class="hidden">⇩</span><sub>ℛ</sub> <span class="main">(</span><span class="skolem">π</span> <span class="skolem">χ</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> P_def fst_conv snd_conv embed_pair.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">meson</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>R</sub> δ<span class="hidden">⇩</span><sub>ℛ</sub> q<span class="hidden">⇩</span><sub>ℛ</sub> <span class="main">(</span>Acc<span class="hidden">⇩</span><sub>ℛ</sub> <span class="main">(</span><span class="skolem">π</span> <span class="skolem">χ</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> r<span class="hidden">⇩</span><sub>χ</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"accept<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>δ<span class="hidden">⇩</span><sub>ℛ</sub><span class="main">,</span> q<span class="hidden">⇩</span><sub>ℛ</sub><span class="main">,</span> <span class="main">{</span>Acc<span class="hidden">⇩</span><sub>ℛ</sub> <span class="bound">j</span> <span class="main">|</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> max_rank<span class="main">}</span><span class="main">)</span> <span class="free">w</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="skolem">π</span> <span class="bound">χ</span> <span class="main">&lt;</span> ltl_FG_to_rabin_def.max_rank<span class="hidden">⇩</span><sub>R</sub> <span class="free">Σ</span> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹theG <span class="skolem">χ</span> <span class="main">=</span> <span class="skolem">ψ</span>›</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> accept<span class="hidden">⇩</span><sub>R</sub>_simp accepting_pair<span class="hidden">⇩</span><sub>R</sub>_def fst_conv snd_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"accept<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>ltl_to_rabin <span class="free">Σ</span> <span class="skolem">ψ</span> <span class="skolem">𝒢</span><span class="main">)</span> <span class="free">w</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ltl_to_rabin_correct<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="free">Σ</span>›</span></span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Automaton Template›</span></span>

<span class="comment1">― ‹This locale provides the construction template for all composed constructions.›</span>

<span class="keyword1"><span class="command">locale</span></span> ltl_to_rabin_base_def <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">δ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">δ<span class="hidden">⇩</span><sub>M</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl <span class="main">⇒</span> <span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> 
    <span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl <span class="main">⇒</span> <span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">M_fin</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> ltl <span class="main">⇀</span> nat<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> ltl <span class="main">⇀</span> <span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub> <span class="main">⇀</span> nat<span class="main">)</span><span class="main">,</span> <span class="tfree">'a</span> set<span class="main">)</span> transition set"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">― ‹Transition Function and Initial State›</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">delta</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">delta</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">=</span> <span class="free">δ</span> <span class="main">×</span> <span class="keyword1">Δ<span class="hidden">⇩</span><sub>×</sub></span> <span class="main">(</span>semi_mojmir_def.step <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free">δ<span class="hidden">⇩</span><sub>M</sub></span> <span class="keyword1">o</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="keyword1">o</span> theG<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">initial</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">initial</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">,</span> <span class="keyword1">ι<span class="hidden">⇩</span><sub>×</sub></span> <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>semi_mojmir_def.initial <span class="keyword1">o</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="keyword1">o</span> theG<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">― ‹Acceptance Condition›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">max_rank_of</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">max_rank_of</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">≡</span> semi_mojmir_def.max_rank <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free">δ<span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span>theG <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">Acc_fin</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Acc_fin</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">χ</span></span></span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>embed_transition_snd <span class="main">`</span> <span class="main">⋃</span><span class="main">(</span>embed_transition <span class="free"><span class="bound"><span class="entity">χ</span></span></span> <span class="main">`</span> 
     <span class="main">(</span>mojmir_to_rabin_def.fail<span class="hidden">⇩</span><sub>R</sub> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free">δ<span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span>theG <span class="free"><span class="bound"><span class="entity">χ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> dom <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">q</span><span class="main">}</span>
     <span class="main">∪</span> mojmir_to_rabin_def.merge<span class="hidden">⇩</span><sub>R</sub> <span class="free">δ<span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span>theG <span class="free"><span class="bound"><span class="entity">χ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> dom <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">q</span><span class="main">}</span> <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">χ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">Acc_inf</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Acc_inf</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">χ</span></span></span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span>embed_transition_snd <span class="main">`</span> <span class="main">⋃</span><span class="main">(</span>embed_transition <span class="free"><span class="bound"><span class="entity">χ</span></span></span> <span class="main">`</span> 
    <span class="main">(</span>mojmir_to_rabin_def.succeed<span class="hidden">⇩</span><sub>R</sub> <span class="free">δ<span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span>theG <span class="free"><span class="bound"><span class="entity">χ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> dom <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">q</span><span class="main">}</span> <span class="main">(</span>the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">χ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Acc</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Acc</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">χ</span></span></span> <span class="main">≡</span> <span class="main">(</span>Acc_fin <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">χ</span></span></span><span class="main">,</span> Acc_inf <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">χ</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rabin_pairs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> ltl <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> ltl <span class="main">⇀</span> <span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub> <span class="main">⇀</span> nat<span class="main">)</span><span class="main">,</span> <span class="tfree">'a</span> set<span class="main">)</span> generalized_rabin_condition"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rabin_pairs</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="free">M_fin</span> <span class="bound">π</span> <span class="main">∪</span> <span class="main">⋃</span><span class="main">{</span>Acc_fin <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="bound">π</span> <span class="bound">χ</span> <span class="main">|</span> <span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="bound">π</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span>Acc_inf <span class="bound">π</span> <span class="bound">χ</span> <span class="main">|</span> <span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="bound">π</span><span class="main">}</span><span class="main">)</span> 
    <span class="main">|</span> <span class="bound">π</span><span class="main">.</span> dom <span class="bound">π</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">χ</span> <span class="main">∈</span> dom <span class="bound">π</span><span class="main">.</span> the <span class="main">(</span><span class="bound">π</span> <span class="bound">χ</span><span class="main">)</span> <span class="main">&lt;</span> max_rank_of <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="bound">χ</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ltl_to_generalized_rabin</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> ltl <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> ltl <span class="main">⇀</span> <span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub> <span class="main">⇀</span> nat<span class="main">)</span><span class="main">,</span> <span class="tfree">'a</span> set<span class="main">)</span> generalized_rabin_automaton"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒜</span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">𝒜</span></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">(</span>delta <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">,</span> initial <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">,</span> rabin_pairs <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> ltl_to_rabin_base <span class="main">=</span> ltl_to_rabin_base_def <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">Σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">w</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set word"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    finite_Σ<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    bounded_w<span class="main">:</span> <span class="quoted"><span class="quoted">"range <span class="free">w</span> <span class="main">⊆</span> <span class="free">Σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    M_fin_monotonic<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="free">π</span> <span class="main">=</span> dom <span class="free">π'</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="free">π</span> <span class="main">⟹</span> the <span class="main">(</span><span class="free">π</span> <span class="bound">χ</span><span class="main">)</span> <span class="main">≤</span> the <span class="main">(</span><span class="free">π'</span> <span class="bound">χ</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">M_fin</span> <span class="free">π</span> <span class="main">⊆</span> <span class="free">M_fin</span> <span class="free">π'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
    finite_reach'<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reach <span class="free">Σ</span> <span class="free">δ</span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    mojmir_to_rabin<span class="main">:</span> <span class="quoted"><span class="quoted">"Only_G <span class="free">𝒢</span> <span class="main">⟹</span> mojmir_to_rabin <span class="free">Σ</span> <span class="free">δ<span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="free">ψ</span><span class="main">)</span> <span class="free">w</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free">𝒢</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">q</span><span class="main">}</span>"</span></span> 
<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="keyword1" id="LTL_Rabin-semi_mojmir"><span class="command">lemma</span></span> semi_mojmir<span class="main">:</span>
  <span class="quoted"><span class="quoted">"semi_mojmir <span class="free">Σ</span> <span class="free">δ<span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="free">ψ</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mojmir_to_rabin<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mojmir_to_rabin_def mojmir_def<span class="main">)</span>

<span class="keyword1" id="LTL_Rabin-finite_reach"><span class="command">lemma</span></span> finite_reach<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reach <span class="free">Σ</span> <span class="main">(</span>delta <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">Σ</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ltl_to_rabin_base_def.initial.simps ltl_to_rabin_base_def.delta.simps<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_reach_simple_product<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_reach' finite_reach_product<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> mojmir_to_rabin<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{}</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> mojmir_to_rabin_def mojmir_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dom_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> G_nested_finite semi_mojmir.wellformed_ℛ<span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="LTL_Rabin-run_limit_not_empty"><span class="command">lemma</span></span> run_limit_not_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"limit <span class="main">(</span>run<span class="hidden">⇩</span><sub>t</sub> <span class="main">(</span>delta <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial <span class="free">φ</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> emptyE finite_Σ limit_nonemptyE finite_reach bounded_w run<span class="hidden">⇩</span><sub>t</sub>_finite<span class="main">)</span> 

<span class="keyword1" id="LTL_Rabin-run_properties"><span class="command">lemma</span></span> run_properties<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≡</span> run <span class="main">(</span>delta <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial <span class="free">φ</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">r</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> foldl <span class="free">δ</span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span> <span class="main">⟹</span> the <span class="main">(</span>snd <span class="main">(</span><span class="free">r</span> <span class="free">i</span><span class="main">)</span> <span class="bound">χ</span><span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> semi_mojmir_def.state_rank <span class="free">Σ</span> <span class="free">δ<span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span> <span class="bound">q</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> sm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ψ</span><span class="main">.</span> semi_mojmir <span class="free">Σ</span> <span class="free">δ<span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="bound">ψ</span><span class="main">)</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mojmir_to_rabin<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> mojmir_to_rabin_def mojmir_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span>foldl <span class="free">δ</span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> 
    <span class="main">λ</span><span class="bound">χ</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">χ</span> <span class="main">∈</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="main">λ</span><span class="bound">ψ</span><span class="main">.</span> foldl <span class="main">(</span>semi_mojmir_def.step <span class="free">Σ</span> <span class="free">δ<span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>semi_mojmir_def.initial <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="free">w</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span> <span class="bound">ψ</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> 
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> r_def run_foldl upt_Suc less_eq_nat.simps if_True map_append foldl_append 
        <span class="keyword1"><span class="command">unfolding</span></span> Suc<span class="main">[</span><span class="operator">unfolded</span> r_def run_foldl<span class="main">]</span> subsequence_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subsequence_def r_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> state_run<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span>foldl <span class="free">δ</span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> 
    <span class="main">λ</span><span class="bound">χ</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">χ</span> <span class="main">∈</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="main">λ</span><span class="bound">ψ</span><span class="main">.</span> semi_mojmir_def.state_rank <span class="free">Σ</span> <span class="free">δ<span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span> <span class="bound">ψ</span> <span class="free">i</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> semi_mojmir.state_rank_step_foldl<span class="main">[</span><span class="operator">OF</span> sm<span class="main">]</span> r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">r</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> foldl <span class="free">δ</span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> state_run <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span> <span class="main">⟹</span> the <span class="main">(</span>snd <span class="main">(</span><span class="free">r</span> <span class="free">i</span><span class="main">)</span> <span class="bound">χ</span><span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> semi_mojmir_def.state_rank <span class="free">Σ</span> <span class="free">δ<span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span> <span class="bound">q</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> state_run <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LTL_Rabin-accept"><span class="command">lemma</span></span> accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_I<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span><span class="keyword1">𝒜</span> <span class="free">Σ</span> <span class="free">φ</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">π</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"dom <span class="free">π</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="free">π</span> <span class="main">⟹</span> the <span class="main">(</span><span class="free">π</span> <span class="bound">χ</span><span class="main">)</span> <span class="main">&lt;</span> max_rank_of <span class="free">Σ</span> <span class="bound">χ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>delta <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial <span class="free">φ</span><span class="main">)</span> <span class="main">(</span><span class="free">M_fin</span> <span class="free">π</span><span class="main">,</span> UNIV<span class="main">)</span> <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="free">π</span> <span class="main">⟹</span> accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>delta <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>Acc <span class="free">Σ</span> <span class="free">π</span> <span class="bound">χ</span><span class="main">)</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> rabin_pairs <span class="free">Σ</span> <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>delta <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial <span class="free">φ</span><span class="main">)</span> <span class="skolem">P</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_def ltl_to_generalized_rabin.simps fst_conv snd_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">π</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π</span><span class="main">.</span> the <span class="main">(</span><span class="skolem">π</span> <span class="bound">χ</span><span class="main">)</span> <span class="main">&lt;</span> max_rank_of <span class="free">Σ</span> <span class="bound">χ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> P_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> <span class="main">(</span><span class="free">M_fin</span> <span class="skolem">π</span> <span class="main">∪</span> <span class="main">⋃</span><span class="main">{</span>Acc_fin <span class="free">Σ</span> <span class="skolem">π</span> <span class="bound">χ</span> <span class="main">|</span> <span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span>Acc_inf <span class="skolem">π</span> <span class="bound">χ</span> <span class="main">|</span> <span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"limit <span class="main">(</span>run<span class="hidden">⇩</span><sub>t</sub> <span class="main">(</span>delta <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial <span class="free">φ</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span> <span class="main">∩</span> UNIV <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> run_limit_not_empty assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>delta <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial <span class="free">φ</span><span class="main">)</span> <span class="main">(</span><span class="free">M_fin</span> <span class="skolem">π</span><span class="main">,</span> UNIV<span class="main">)</span> <span class="free">w</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π</span> <span class="main">⟹</span> accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>delta <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>Acc <span class="free">Σ</span> <span class="skolem">π</span> <span class="bound">χ</span><span class="main">)</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> P_def accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_simp accepting_pair<span class="hidden">⇩</span><sub>R</sub>_simp <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span> <span class="comment1">(* Slow... *)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="quoted"><span class="quoted">‹dom <span class="skolem">π</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π</span><span class="main">.</span> the <span class="main">(</span><span class="skolem">π</span> <span class="bound">χ</span><span class="main">)</span> <span class="main">&lt;</span> max_rank_of <span class="free">Σ</span> <span class="bound">χ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> 
    <span class="free">ψ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> 
    <span class="free">π</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl <span class="main">⇀</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="keyword1">G</span> <span class="free">ψ</span> <span class="main">∈</span> dom <span class="free">π</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"dom <span class="free">π</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> 𝔐<span class="main">:</span> mojmir_to_rabin <span class="quoted"><span class="free">Σ</span></span> <span class="quoted"><span class="free">δ<span class="hidden">⇩</span><sub>M</sub></span></span> <span class="quoted"><span class="quoted">"<span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="free">ψ</span>"</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">q</span><span class="main">.</span> dom <span class="free">π</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">q</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mojmir_to_rabin <span class="quoted"><span class="quoted">‹dom <span class="free">π</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>›</span></span> 𝒢_elements<span class="main">)</span>

<span class="keyword1" id="LTL_Rabin-Acc_property"><span class="command">lemma</span></span> Acc_property<span class="main">:</span>
  <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>delta <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>Acc <span class="free">Σ</span> <span class="free">π</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span> <span class="main">⟷</span> accepting_pair<span class="hidden">⇩</span><sub>R</sub> 𝔐.δ<span class="hidden">⇩</span><sub>ℛ</sub> 𝔐.q<span class="hidden">⇩</span><sub>ℛ</sub> <span class="main">(</span>𝔐.Acc<span class="hidden">⇩</span><sub>ℛ</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">π</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Acc</span> <span class="main">=</span> <span class="var">?Acc<span class="hidden">⇩</span><sub>ℛ</sub></span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>  
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="skolem"><span class="skolem">r<span class="hidden">⇩</span><sub>ψ</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> run<span class="hidden">⇩</span><sub>t</sub> <span class="main">(</span>delta <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial <span class="free">φ</span><span class="main">)</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>ψ</sub></span> <span class="main">=</span> run<span class="hidden">⇩</span><sub>t</sub> 𝔐.δ<span class="hidden">⇩</span><sub>ℛ</sub> 𝔐.q<span class="hidden">⇩</span><sub>ℛ</sub> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> run<span class="hidden">⇩</span><sub>t</sub>_finite<span class="main">[</span><span class="operator">OF</span> finite_reach<span class="main">]</span> bounded_w finite_Σ
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span> 

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">S</span><span class="main">.</span> limit <span class="skolem">r<span class="hidden">⇩</span><sub>ψ</sub></span> <span class="main">∩</span> <span class="bound">S</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> limit <span class="skolem">r</span> <span class="main">∩</span> <span class="main">⋃</span><span class="main">(</span>embed_transition_snd <span class="main">`</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="main">(</span>embed_transition <span class="main">(</span><span class="keyword1">G</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>initial <span class="free">φ</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> Some 𝔐.q<span class="hidden">⇩</span><sub>ℛ</sub>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">G</span> <span class="free">ψ</span> <span class="main">∈</span> dom <span class="free">π</span>›</span></span> <span class="quoted"><span class="quoted">‹dom <span class="free">π</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="main">(</span>run<span class="hidden">⇩</span><sub>t</sub> <span class="main">(</span><span class="keyword1">Δ<span class="hidden">⇩</span><sub>×</sub></span> <span class="main">(</span>semi_mojmir_def.step <span class="free">Σ</span> <span class="free">δ<span class="hidden">⇩</span><sub>M</sub></span> <span class="keyword1">o</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="keyword1">o</span> theG<span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="main">(</span>initial <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>range <span class="skolem">r</span><span class="main">)</span>›</span></span> r_def comp_apply
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> product_run_finite_snd <span class="quasi_keyword">cong</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> image_cong_simp<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span> <span class="skolem">S</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> r_def r<span class="hidden">⇩</span><sub>ψ</sub>_def product_run_embed_limit_finiteness<span class="main">[</span><span class="operator">OF</span> 1 2<span class="main">,</span> <span class="operator">unfolded</span> ltl.sel comp_def<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> 
      <span class="keyword1"><span class="command">using</span></span> product_run_embed_limit_finiteness_snd<span class="main">[</span><span class="operator">OF</span>  <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>range <span class="skolem">r</span><span class="main">)</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> r_def delta.simps initial.simps<span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> simple_product.simps product.simps product_initial_state.simps <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_def <span class="quasi_keyword">cong</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> SUP_cong_simp<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"limit <span class="skolem">r</span> <span class="main">∩</span> fst <span class="main">(</span>Acc <span class="free">Σ</span> <span class="free">π</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> limit <span class="skolem">r</span> <span class="main">∩</span> snd <span class="main">(</span>Acc <span class="free">Σ</span> <span class="free">π</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span> 
     <span class="main">⟷</span> limit <span class="skolem">r<span class="hidden">⇩</span><sub>ψ</sub></span> <span class="main">∩</span> fst <span class="main">(</span>𝔐.Acc<span class="hidden">⇩</span><sub>ℛ</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">π</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∧</span> limit <span class="skolem">r<span class="hidden">⇩</span><sub>ψ</sub></span> <span class="main">∩</span> snd <span class="main">(</span>𝔐.Acc<span class="hidden">⇩</span><sub>ℛ</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">π</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fst_conv snd_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Acc</span> <span class="main">⟷</span> <span class="var">?Acc<span class="hidden">⇩</span><sub>ℛ</sub></span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> r<span class="hidden">⇩</span><sub>ψ</sub>_def r_def accepting_pair<span class="hidden">⇩</span><sub>R</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LTL_Rabin-Acc_to_rabin_accept"><span class="command">lemma</span></span> Acc_to_rabin_accept<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>delta <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>Acc <span class="free">Σ</span> <span class="free">π</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span><span class="main">;</span> the <span class="main">(</span><span class="free">π</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> 𝔐.max_rank<span class="main">⟧</span> <span class="main">⟹</span> accept<span class="hidden">⇩</span><sub>R</sub> 𝔐.ℛ <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Acc_property <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LTL_Rabin-Acc_to_mojmir_accept"><span class="command">lemma</span></span> Acc_to_mojmir_accept<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>delta <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>Acc <span class="free">Σ</span> <span class="free">π</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span><span class="main">;</span> the <span class="main">(</span><span class="free">π</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> 𝔐.max_rank<span class="main">⟧</span> <span class="main">⟹</span> 𝔐.accept"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Acc_to_rabin_accept <span class="keyword1"><span class="command">unfolding</span></span> 𝔐.mojmir_accept_iff_rabin_accept <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="LTL_Rabin-rabin_accept_to_Acc"><span class="command">lemma</span></span> rabin_accept_to_Acc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>accept<span class="hidden">⇩</span><sub>R</sub> 𝔐.ℛ <span class="free">w</span><span class="main">;</span> <span class="free">π</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> 𝔐.smallest_accepting_rank<span class="main">⟧</span> <span class="main">⟹</span> accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>delta <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>Acc <span class="free">Σ</span> <span class="free">π</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Acc_property 𝔐.Mojmir_rabin_smallest_accepting_rank 
  <span class="keyword1"><span class="command">using</span></span> 𝔐.smallest_accepting_rank<span class="hidden">⇩</span><sub>ℛ</sub>_properties 𝔐.smallest_accepting_rank<span class="hidden">⇩</span><sub>ℛ</sub>_def  
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> option.sel<span class="main">)</span>

<span class="keyword1" id="LTL_Rabin-mojmir_accept_to_Acc"><span class="command">lemma</span></span> mojmir_accept_to_Acc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>𝔐.accept<span class="main">;</span> <span class="free">π</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> 𝔐.smallest_accepting_rank<span class="main">⟧</span> <span class="main">⟹</span> accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>delta <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>Acc <span class="free">Σ</span> <span class="free">π</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> 𝔐.mojmir_accept_iff_rabin_accept <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> rabin_accept_to_Acc<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="LTL_Rabin-normalize_π"><span class="command">lemma</span></span> normalize_π<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dom_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="free">π</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="free">π</span> <span class="main">⟹</span> the <span class="main">(</span><span class="free">π</span> <span class="bound">χ</span><span class="main">)</span> <span class="main">&lt;</span> max_rank_of <span class="free">Σ</span> <span class="bound">χ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>delta <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial <span class="free">φ</span><span class="main">)</span> <span class="main">(</span><span class="free">M_fin</span> <span class="free">π</span><span class="main">,</span> UNIV<span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="free">π</span> <span class="main">⟹</span> accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>delta <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>Acc <span class="free">Σ</span> <span class="free">π</span> <span class="bound">χ</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"dom <span class="free">π</span> <span class="main">=</span> dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">⟹</span> <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="bound">χ</span> <span class="main">=</span> mojmir_def.smallest_accepting_rank <span class="free">Σ</span> <span class="free">δ<span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">q</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>delta <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial <span class="free">φ</span><span class="main">)</span> <span class="main">(</span><span class="free">M_fin</span> <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">,</span> UNIV<span class="main">)</span> <span class="free">w</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">⟹</span> accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>delta <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>Acc <span class="free">Σ</span> <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="bound">χ</span><span class="main">)</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">𝒢</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">𝒢</span> <span class="main">=</span> dom <span class="free">π</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> 𝒢_properties<span class="main">[</span><span class="operator">OF</span> dom_subset<span class="main">]</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">χ</span><span class="main">.</span>  mojmir_def.smallest_accepting_rank <span class="free">Σ</span> <span class="free">δ<span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> dom <span class="free">π</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">q</span><span class="main">}</span><span class="main">)</span> <span class="main">|`</span> <span class="skolem">𝒢</span>"</span></span>

  <span class="keyword1"><span class="command">moreover</span></span>
  
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">χ</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">χ</span> <span class="main">∈</span> dom <span class="free">π</span>"</span></span>
  
    <span class="keyword1"><span class="command">interpret</span></span> 𝔐<span class="main">:</span> mojmir_to_rabin <span class="quoted"><span class="free">Σ</span></span> <span class="quoted"><span class="free">δ<span class="hidden">⇩</span><sub>M</sub></span></span> <span class="quoted"><span class="quoted">"<span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span>theG <span class="skolem">χ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">q</span><span class="main">.</span> dom <span class="free">π</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">q</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mojmir_to_rabin <span class="quoted"><span class="quoted">‹dom <span class="free">π</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>›</span></span> 𝒢_elements<span class="main">)</span>
  
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">χ</span> <span class="main">∈</span> dom <span class="free">π</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>delta <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>Acc <span class="free">Σ</span> <span class="free">π</span> <span class="skolem">χ</span><span class="main">)</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>R</sub> 𝔐.δ<span class="hidden">⇩</span><sub>ℛ</sub> 𝔐.q<span class="hidden">⇩</span><sub>ℛ</sub> <span class="main">(</span>𝔐.Acc<span class="hidden">⇩</span><sub>ℛ</sub> <span class="main">(</span>the <span class="main">(</span><span class="free">π</span> <span class="skolem">χ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">χ</span> <span class="main">∈</span> dom <span class="free">π</span>›</span></span> Acc_property<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ dom_subset<span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹Only_G <span class="main">(</span>dom <span class="free">π</span><span class="main">)</span>›</span></span> ltl.sel<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"accept<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>𝔐.δ<span class="hidden">⇩</span><sub>ℛ</sub><span class="main">,</span> 𝔐.q<span class="hidden">⇩</span><sub>ℛ</sub><span class="main">,</span> <span class="main">{</span>𝔐.Acc<span class="hidden">⇩</span><sub>ℛ</sub> <span class="bound">j</span> <span class="main">|</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> 𝔐.max_rank<span class="main">}</span><span class="main">)</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">χ</span> <span class="main">∈</span> dom <span class="free">π</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> max_rank_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>𝔐.smallest_accepting_rank<span class="hidden">⇩</span><sub>ℛ</sub><span class="main">)</span> <span class="main">≤</span> the <span class="main">(</span><span class="free">π</span> <span class="skolem">χ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"𝔐.smallest_accepting_rank <span class="main">≠</span> None"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Least_le<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="free">π</span> <span class="skolem">χ</span><span class="main">)</span>"</span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">χ</span> <span class="main">∈</span> dom <span class="free">π</span>›</span></span><span class="main">]</span> 𝔐.mojmir_accept_iff_rabin_accept option.distinct<span class="main">(</span>1<span class="main">)</span> 𝔐.smallest_accepting_rank_def 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 𝔐.smallest_accepting_rank<span class="hidden">⇩</span><sub>ℛ</sub>_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="skolem">χ</span><span class="main">)</span> <span class="main">≤</span> the <span class="main">(</span><span class="free">π</span> <span class="skolem">χ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">χ</span> <span class="main">∈</span> dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> π<span class="hidden">⇩</span><sub>𝒜</sub>_def dom_restrict <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">χ</span> <span class="main">∈</span> dom <span class="free">π</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 𝔐.Mojmir_rabin_smallest_accepting_rank 𝒢_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> dom_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 𝒢_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dom <span class="free">π</span> <span class="main">=</span> dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> π<span class="hidden">⇩</span><sub>𝒜</sub>_def dom_restrict 𝒢_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">moreover</span></span>
  
  <span class="keyword1"><span class="command">note</span></span> 𝒢_properties<span class="main">[</span><span class="operator">OF</span> dom_subset<span class="main">,</span> <span class="operator">unfolded</span> <span class="quoted"><span class="quoted"><span class="quoted">‹dom <span class="free"><span class="free">π</span></span> <span class="main"><span class="main">=</span></span> dom <span class="skolem"><span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span></span>›</span></span></span><span class="main">]</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M_fin</span> <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">⊆</span> <span class="free">M_fin</span> <span class="free">π</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹dom <span class="free">π</span> <span class="main">=</span> dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M_fin_monotonic <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="free">π</span> <span class="main">⟹</span> the <span class="main">(</span><span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="bound">χ</span><span class="main">)</span> <span class="main">≤</span> the <span class="main">(</span><span class="free">π</span> <span class="bound">χ</span><span class="main">)</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>delta <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial <span class="free">φ</span><span class="main">)</span> <span class="main">(</span><span class="free">M_fin</span> <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">,</span> UNIV<span class="main">)</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> accepting_pair<span class="hidden">⇩</span><sub>R</sub>_simp <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
   
  <span class="keyword1"><span class="command">moreover</span></span>

  <span class="comment1">― ‹Goal 2›</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">χ</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">χ</span> <span class="main">∈</span> dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">χ</span> <span class="main">=</span> <span class="keyword1">G</span> <span class="main">(</span>theG <span class="skolem">χ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹dom <span class="free">π</span> <span class="main">=</span> dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span>›</span></span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="quoted"><span class="quoted">‹Only_G <span class="main">(</span>dom <span class="free">π</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹Only_G <span class="main">(</span>dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">χ</span> <span class="main">∈</span> dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span>›</span></span> ltl.collapse<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> ltl.disc<span class="main"><span class="main">(</span></span>58<span class="main"><span class="main">)</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">G</span> <span class="main">(</span>theG <span class="skolem">χ</span><span class="main">)</span> <span class="main">∈</span> dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">χ</span> <span class="main">∈</span> dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"mojmir_def.accept <span class="free">δ<span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span>theG <span class="skolem">χ</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> dom <span class="free">π</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">q</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>4<span class="main">)</span> <span class="quoted"><span class="quoted">‹dom <span class="free">π</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>›</span></span> ltl.sel<span class="main">(</span>8<span class="main">)</span> Acc_to_mojmir_accept <span class="quoted"><span class="quoted">‹dom <span class="free">π</span> <span class="main">=</span> dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> max_rank_of_def<span class="main">)</span>  
    <span class="keyword1"><span class="command">have</span></span> Y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">(</span><span class="keyword1">G</span> theG <span class="skolem">χ</span><span class="main">)</span> <span class="main">=</span> mojmir_def.smallest_accepting_rank <span class="free">Σ</span> <span class="free">δ<span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span>theG <span class="skolem">χ</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">q</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">G</span> <span class="main">(</span>theG <span class="skolem">χ</span><span class="main">)</span> <span class="main">∈</span> dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">χ</span> <span class="main">=</span> <span class="keyword1">G</span> <span class="main">(</span>theG <span class="skolem">χ</span><span class="main">)</span>›</span></span> π<span class="hidden">⇩</span><sub>𝒜</sub>_def <span class="quoted"><span class="quoted">‹dom <span class="free">π</span> <span class="main">=</span> dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span>›</span></span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>delta <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>Acc <span class="free">Σ</span> <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="skolem">χ</span><span class="main">)</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mojmir_accept_to_Acc<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="keyword1">G</span> <span class="main">(</span>theG <span class="skolem">χ</span><span class="main">)</span> <span class="main">∈</span> dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹dom <span class="free">π</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹dom <span class="free">π</span> <span class="main">=</span> dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span>›</span></span><span class="main"><span class="main">]</span></span> X<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹dom <span class="free">π</span> <span class="main">=</span> dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span>›</span></span><span class="main"><span class="main">]</span></span> Y<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">ultimately</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> that<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span></span><span class="main">]</span> restrict_in <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹dom <span class="free">π</span> <span class="main">=</span> dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span>›</span></span> 𝒢_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Generalized Deterministic Rabin Automaton›</span></span>

<span class="comment1">― ‹Instantiate Automaton Template›</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Definition›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">M_fin</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> ltl <span class="main">⇀</span> nat<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> ltl <span class="main">⇀</span> <span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub> <span class="main">⇀</span> nat<span class="main">)</span><span class="main">,</span> <span class="tfree">'a</span> set<span class="main">)</span> transition set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">M_fin</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">φ'</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span><span class="main">,</span> <span class="bound">ν</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> 
    <span class="main">¬</span><span class="main">(</span><span class="main">∀</span><span class="bound">S</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">χ</span> <span class="main">∈</span> dom <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">.</span> <span class="bound">S</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> Abs <span class="bound">χ</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="bound">χ</span><span class="main">)</span><span class="main">.</span> the <span class="main">(</span><span class="bound">m</span> <span class="bound">χ</span><span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">S</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword1">↑eval<span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span>dom <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">S</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">φ'</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> ltl_to_rabin_af <span class="main">=</span> ltl_to_rabin_base <span class="quoted"><span class="quoted">"<span class="keyword1">↑af</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub></span>"</span></span> <span class="quoted"><span class="quoted">"Abs"</span></span> <span class="quoted"><span class="quoted">"Abs"</span></span> <span class="quoted">M_fin</span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">≡</span> delta"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">ι<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">≡</span> initial"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">Acc<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">≡</span> Acc"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">F<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">≡</span> rabin_pairs"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝒜</span> <span class="main">≡</span> ltl_to_generalized_rabin"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Correctness Theorem›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> ltl_to_generalized_rabin_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span> <span class="main">=</span> accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>ltl_to_generalized_rabin <span class="free">Σ</span> <span class="free">φ</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Δ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"δ<span class="hidden">⇩</span><sub>𝒜</sub> <span class="free">Σ</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"ι<span class="hidden">⇩</span><sub>𝒜</sub> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?F</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"F<span class="hidden">⇩</span><sub>𝒜</sub> <span class="free">Σ</span> <span class="free">φ</span>"</span></span>
 
  <span class="comment1">― ‹Preliminary facts needed by both proof directions›</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> run<span class="hidden">⇩</span><sub>t</sub> <span class="var">?Δ</span> <span class="var">?q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> r_alt_def'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> fst <span class="main">(</span>fst <span class="main">(</span><span class="skolem">r</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Abs <span class="main">(</span><span class="keyword1">af</span> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="bound">i</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> run_properties<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> r_def run<span class="hidden">⇩</span><sub>t</sub>.simps fst_conv
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> af_abs.f_foldl_abs.abs_eq af_abs.f_foldl_abs_alt_def af_letter_abs_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">have</span></span> r_alt_def''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span> <span class="bound">i</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span> <span class="main">⟹</span> the <span class="main">(</span>snd <span class="main">(</span>fst <span class="main">(</span><span class="skolem">r</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="bound">χ</span><span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> semi_mojmir_def.state_rank <span class="free">Σ</span> <span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub></span><span class="main">(</span>Abs <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span> <span class="bound">q</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> run_properties<span class="main">(</span>2<span class="main">)</span> r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> φ'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">af</span> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="bound">i</span><span class="main">]</span><span class="main">)</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="main">(</span>fst <span class="main">(</span>fst <span class="main">(</span><span class="skolem">r</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> r_alt_def' Quotient3_ltl_prop_equiv_quotient ltl_prop_equiv_quotient.abs_eq_iff Quotient3_abs_rep<span class="main">)</span>
 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> run<span class="hidden">⇩</span><sub>t</sub>_finite<span class="main">[</span><span class="operator">OF</span> finite_reach<span class="main">]</span> bounded_w finite_Σ
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_def<span class="main">)</span>

  <span class="comment1">― ‹Assuming <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span>"</span><span class="antiquote">}</span></span> holds, we prove that <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"ltl_to_generalized_rabin <span class="free">Σ</span> <span class="free">φ</span>"</span><span class="antiquote">}</span></span> accepts <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">w</span></span><span class="antiquote">}</span></span>›</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">𝒢</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">𝒢</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"accept<span class="hidden">⇩</span><sub>M</sub> <span class="free">φ</span> <span class="skolem">𝒢</span> <span class="free">w</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"closed <span class="skolem">𝒢</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ltl_logical_characterization <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    
    <span class="keyword1"><span class="command">note</span></span> 𝒢_properties<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted"><span class="quoted">‹<span class="skolem"><span class="skolem">𝒢</span></span> <span class="main"><span class="main">⊆</span></span> <span class="keyword1"><span class="keyword1"><span class="hidden">❙</span><b>G</b></span></span> <span class="free"><span class="free">φ</span></span>›</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ltl_FG_to_rabin <span class="free">Σ</span> <span class="skolem">𝒢</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_Σ bounded_w <span class="keyword1"><span class="command">unfolding</span></span> ltl_FG_to_rabin_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">π</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="skolem">χ</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">χ</span> <span class="main">∈</span> <span class="skolem">𝒢</span> <span class="keyword1">then</span> <span class="main">(</span>ltl_FG_to_rabin_def.smallest_accepting_rank<span class="hidden">⇩</span><sub>R</sub> <span class="free">Σ</span> <span class="main">(</span>theG <span class="skolem">χ</span><span class="main">)</span> <span class="skolem">𝒢</span> <span class="free">w</span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">χ</span>
    
    <span class="keyword1"><span class="command">have</span></span> 𝔐_accept<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ψ</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span> <span class="main">⟹</span> ltl_FG_to_rabin_def.accept<span class="hidden">⇩</span><sub>R</sub>' <span class="bound">ψ</span> <span class="skolem">𝒢</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹closed <span class="skolem">𝒢</span> <span class="free">w</span>›</span></span> <span class="quoted"><span class="quoted">‹ltl_FG_to_rabin <span class="free">Σ</span> <span class="skolem">𝒢</span> <span class="free">w</span>›</span></span> ltl_FG_to_rabin.ltl_to_rabin_correct_exposed' <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ψ</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span> <span class="main">⟹</span> accept<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>ltl_to_rabin <span class="free">Σ</span> <span class="bound">ψ</span> <span class="skolem">𝒢</span><span class="main">)</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹closed <span class="skolem">𝒢</span> <span class="free">w</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ltl_FG_to_rabin.ltl_to_rabin_correct_exposed<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹ltl_FG_to_rabin <span class="free">Σ</span> <span class="skolem">𝒢</span> <span class="free">w</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ψ</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">G</span> <span class="skolem">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span>"</span></span>
      <span class="keyword1"><span class="command">interpret</span></span> 𝔐<span class="main">:</span> ltl_FG_to_rabin <span class="quoted"><span class="free">Σ</span></span> <span class="quoted"><span class="skolem">ψ</span></span> <span class="quoted"><span class="skolem">𝒢</span></span> <span class="quoted"><span class="free">w</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> <span class="quoted"><span class="quoted">‹ltl_FG_to_rabin <span class="free">Σ</span> <span class="skolem">𝒢</span> <span class="free">w</span>›</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"𝔐.smallest_accepting_rank <span class="main">=</span> Some <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 𝔐_accept<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="keyword1">G</span> <span class="skolem">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span>›</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> 𝔐.smallest_accepting_rank_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="skolem">π</span> <span class="main">(</span><span class="keyword1">G</span> <span class="skolem">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> 𝔐.max_rank"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="main">(</span><span class="keyword1">G</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="main">≠</span> None"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 𝔐.smallest_accepting_rank_properties <span class="quoted"><span class="quoted">‹<span class="keyword1">G</span> <span class="skolem">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span>›</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> π_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">𝒢</span> <span class="main">=</span> dom <span class="skolem">π</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> <span class="skolem">𝒢</span> <span class="main">⟹</span> the <span class="main">(</span><span class="skolem">π</span> <span class="bound">χ</span><span class="main">)</span> <span class="main">&lt;</span> ltl_FG_to_rabin_def.max_rank<span class="hidden">⇩</span><sub>R</sub> <span class="free">Σ</span> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Only_G <span class="skolem">𝒢</span>›</span></span> π_def <span class="keyword1"><span class="command">unfolding</span></span> dom_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>M_fin <span class="skolem">π</span> <span class="main">∪</span> <span class="main">⋃</span><span class="main">{</span>Acc_fin <span class="free">Σ</span> <span class="skolem">π</span> <span class="bound">χ</span> <span class="main">|</span> <span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span>Acc_inf <span class="skolem">π</span> <span class="bound">χ</span> <span class="main">|</span> <span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?F</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">𝒢</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>›</span></span> max_rank_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">moreover</span></span>

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="var">?Δ</span> <span class="var">?q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>M_fin <span class="skolem">π</span><span class="main">,</span> UNIV<span class="main">)</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="comment1">(* Wait until the Mojmir automata provide enough information *)</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i_def<span class="main">:</span> 
          <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≥</span> <span class="skolem">i</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">S</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">ψ</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span> <span class="main">⟶</span> <span class="bound">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∧</span> <span class="bound">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">𝒢</span> <span class="main">(</span>ℱ <span class="bound">ψ</span> <span class="free">w</span> <span class="skolem">𝒢</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword1">af</span> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="bound">j</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹accept<span class="hidden">⇩</span><sub>M</sub> <span class="free">φ</span> <span class="skolem">𝒢</span> <span class="free">w</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> MOST_nat_le accept<span class="hidden">⇩</span><sub>M</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
        <span class="comment1">(* Wait until the states with succeeding tokens are (prop.) equivalent to ℱ *)</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> i'_def<span class="main">:</span> 
          <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span> <span class="bound">ψ</span> <span class="bound">S</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≥</span> <span class="skolem">i'</span> <span class="main">⟹</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> ℱ <span class="bound">ψ</span> <span class="free">w</span> <span class="skolem">𝒢</span> <span class="bound">j</span> <span class="main">∧</span> <span class="skolem">𝒢</span> <span class="main">⊆</span> <span class="bound">S</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> ltl_FG_to_rabin_def.𝒮<span class="hidden">⇩</span><sub>R</sub> <span class="free">Σ</span> <span class="bound">ψ</span> <span class="skolem">𝒢</span> <span class="free">w</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="bound">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ℱ_eq_𝒮_generalized<span class="main">[</span><span class="operator">OF</span> finite_Σ bounded_w <span class="quoted"><span class="quoted">‹closed <span class="skolem">𝒢</span> <span class="free">w</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> MOST_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span> 
  
        <span class="comment1">(* From now on the run does not visit forbidden states *)</span>  
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≥</span> max <span class="skolem">i</span> <span class="skolem">i'</span> <span class="main">⟹</span> <span class="skolem">r</span> <span class="bound">j</span> <span class="main">∉</span> M_fin <span class="skolem">π</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> max <span class="skolem">i</span> <span class="skolem">i'</span>"</span></span>
  
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?φ'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>fst <span class="main">(</span><span class="skolem">r</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>fst <span class="main">(</span><span class="skolem">r</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
          
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> <span class="skolem">𝒢</span> <span class="main">⟹</span> <span class="skolem">S</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> Abs <span class="bound">χ</span>"</span></span>
            <span class="keyword1"><span class="command">hence</span></span> assm1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> <span class="skolem">𝒢</span> <span class="main">⟹</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">χ</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> ltl_prop_entails_abs.abs_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> <span class="skolem">𝒢</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> the <span class="main">(</span><span class="skolem">π</span> <span class="bound">χ</span><span class="main">)</span><span class="main">.</span> the <span class="main">(</span><span class="var">?m</span> <span class="bound">χ</span><span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">S</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword1">↑eval<span class="hidden">⇩</span><sub>G</sub></span> <span class="skolem">𝒢</span> <span class="bound">q</span>"</span></span>
            <span class="keyword1"><span class="command">hence</span></span> assm2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> <span class="skolem">𝒢</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> the <span class="main">(</span><span class="skolem">π</span> <span class="bound">χ</span><span class="main">)</span><span class="main">.</span> the <span class="main">(</span><span class="var">?m</span> <span class="bound">χ</span><span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">𝒢</span> <span class="main">(</span>Rep <span class="bound">q</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> ltl_prop_entails_abs.rep_eq eval<span class="hidden">⇩</span><sub>G</sub>_abs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
            <span class="keyword1"><span class="command">{</span></span>
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ψ</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">G</span> <span class="skolem">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span>"</span></span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">G</span> <span class="skolem">ψ</span> <span class="main">∈</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">𝒢</span> <span class="main">⊆</span> <span class="skolem">S</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">𝒢</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>›</span></span> assm1 <span class="quoted"><span class="quoted">‹Only_G <span class="skolem">𝒢</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
  
              <span class="keyword1"><span class="command">interpret</span></span> 𝔐<span class="main">:</span> ltl_FG_to_rabin <span class="quoted"><span class="free">Σ</span></span> <span class="quoted"><span class="skolem">ψ</span></span> <span class="quoted"><span class="skolem">𝒢</span></span> <span class="quoted"><span class="free">w</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">insert</span> <span class="quoted"><span class="quoted">‹Only_G <span class="skolem">𝒢</span>›</span></span> finite_Σ bounded_w<span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span><span class="main">)</span> 
    
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">S</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> 𝔐.𝒮 <span class="skolem">j</span> <span class="main">⟹</span> <span class="bound">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> ℱ <span class="skolem">ψ</span> <span class="free">w</span> <span class="skolem">𝒢</span> <span class="skolem">j</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> i'_def <span class="quoted"><span class="quoted">‹<span class="keyword1">G</span> <span class="skolem">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≥</span> max <span class="skolem">i</span> <span class="skolem">i'</span>›</span></span> max.bounded_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">S</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> Rep <span class="main">`</span> 𝔐.𝒮 <span class="skolem">j</span> <span class="main">⟹</span> <span class="bound">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">q</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> ℱ <span class="skolem">ψ</span> <span class="free">w</span> <span class="skolem">𝒢</span> <span class="skolem">j</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
              <span class="keyword1"><span class="command">moreover</span></span>
  
              <span class="keyword1"><span class="command">have</span></span> 𝒮_def<span class="main">:</span> <span class="quoted"><span class="quoted">"𝔐.𝒮 <span class="skolem">j</span> <span class="main">=</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="skolem">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">q</span> <span class="main">.</span> <span class="main">∃</span><span class="bound">j'</span><span class="main">.</span> the <span class="main">(</span><span class="skolem">π</span> <span class="main">(</span><span class="keyword1">G</span> <span class="skolem">ψ</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="bound">j'</span> <span class="main">∧</span> the <span class="main">(</span><span class="var">?m</span> <span class="main">(</span><span class="keyword1">G</span> <span class="skolem">ψ</span><span class="main">)</span><span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="bound">j'</span><span class="main">}</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> r_alt_def''<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="keyword1">G</span> <span class="skolem">ψ</span> <span class="main">∈</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>›</span></span><span class="main">,</span> <span class="operator">unfolded</span> ltl.sel<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="keyword1">G</span> <span class="skolem">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> π_def<span class="main">)</span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span><span class="main">.</span> <span class="skolem">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span> <span class="main">⟹</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">𝒢</span> <span class="main">(</span>Rep <span class="bound">q</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">𝒢</span> <span class="main">⊆</span> <span class="skolem">S</span>›</span></span> eval<span class="hidden">⇩</span><sub>G</sub>_prop_entailment <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> Rep <span class="main">`</span> 𝔐.𝒮 <span class="skolem">j</span> <span class="main">⟹</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">𝒢</span> <span class="bound">q</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> assm2 <span class="quoted"><span class="quoted">‹<span class="keyword1">G</span> <span class="skolem">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 𝒮_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
              <span class="keyword1"><span class="command">ultimately</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">𝒢</span> <span class="main">(</span>ℱ <span class="skolem">ψ</span> <span class="free">w</span> <span class="skolem">𝒢</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eval<span class="hidden">⇩</span><sub>G</sub>_respectfulness_generalized<span class="main">)</span>
            <span class="keyword1"><span class="command">}</span></span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword1">af</span> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> max.bounded_iff i_def <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≥</span> max <span class="skolem">i</span> <span class="skolem">i'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> <span class="skolem">𝒢</span> <span class="main">⟹</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">χ</span>›</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="var">?φ'</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> φ'_def ltl_prop_equiv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="var">?φ'</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> ltl_prop_entails_abs.rep_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="skolem">j</span> <span class="main">∉</span> M_fin <span class="skolem">π</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> <span class="skolem">𝒢</span> <span class="main">⟹</span> the <span class="main">(</span><span class="skolem">π</span> <span class="bound">χ</span><span class="main">)</span> <span class="main">&lt;</span> ltl_FG_to_rabin_def.max_rank<span class="hidden">⇩</span><sub>R</sub> <span class="free">Σ</span> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">𝒢</span> <span class="main">=</span> dom <span class="skolem">π</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"range <span class="main">(</span>suffix <span class="main">(</span>max <span class="skolem">i</span> <span class="skolem">i'</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∩</span> M_fin <span class="skolem">π</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> suffix_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> le_add1 <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> rangeE<span class="main">)</span> 
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"limit <span class="skolem">r</span> <span class="main">∩</span> M_fin <span class="skolem">π</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> limit_in_range_suffix<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">r</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"limit <span class="skolem">r</span> <span class="main">∩</span> UNIV <span class="main">≠</span> <span class="main">{}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>range <span class="skolem">r</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> empty_iff limit_nonemptyE<span class="main">)</span> 
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> r_def accepting_pair<span class="hidden">⇩</span><sub>R</sub>_simp <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
  
      <span class="keyword1"><span class="command">moreover</span></span>
  
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> <span class="skolem">𝒢</span> <span class="main">⟹</span> accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="var">?Δ</span> <span class="var">?q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>Acc <span class="free">Σ</span> <span class="skolem">π</span> <span class="bound">χ</span><span class="main">)</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">χ</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">χ</span> <span class="main">∈</span> <span class="skolem">𝒢</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ψ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">χ</span> <span class="main">=</span> <span class="keyword1">G</span> <span class="skolem">ψ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">G</span> <span class="skolem">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Only_G <span class="skolem">𝒢</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span> <span class="skolem">χ</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">ψ</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span> <span class="main">⟹</span> accept<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>ltl_to_rabin <span class="free">Σ</span> <span class="bound">ψ</span> <span class="skolem">𝒢</span><span class="main">)</span> <span class="free">w</span>›</span></span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="keyword1">G</span> <span class="skolem">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span>›</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">using</span></span> rabin_accept_to_Acc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ψ</span></span> <span class="quoted"><span class="skolem">π</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="keyword1">G</span> <span class="skolem">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">𝒢</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">χ</span> <span class="main">∈</span> <span class="skolem">𝒢</span>›</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> ltl.sel <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">χ</span> <span class="main">=</span> <span class="keyword1">G</span> <span class="skolem">ψ</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">𝒢</span> <span class="main">=</span> dom <span class="skolem">π</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> π_def <span class="quoted"><span class="quoted">‹<span class="skolem">𝒢</span> <span class="main">=</span> dom <span class="skolem">π</span>›</span></span> ltl.sel<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> ltl_prop_entails_abs.rep_eq ltl_to_rabin.simps
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Collect_cong<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub> <span class="var">?Δ</span> <span class="var">?q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>M_fin <span class="skolem">π</span> <span class="main">∪</span> <span class="main">⋃</span><span class="main">{</span>Acc_fin <span class="free">Σ</span> <span class="skolem">π</span> <span class="bound">χ</span> <span class="main">|</span> <span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span>Acc_inf <span class="skolem">π</span> <span class="bound">χ</span> <span class="main">|</span> <span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π</span><span class="main">}</span><span class="main">)</span> <span class="free">w</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_def accepting_pair<span class="hidden">⇩</span><sub>R</sub>_def fst_conv snd_conv <span class="quoted"><span class="quoted">‹<span class="skolem">𝒢</span> <span class="main">=</span> dom <span class="skolem">π</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ltl_to_rabin_base_def.ltl_to_generalized_rabin.simps accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_def fst_conv snd_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="comment1">― ‹Assuming <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"ltl_to_generalized_rabin <span class="free">Σ</span> <span class="free">φ</span>"</span><span class="antiquote">}</span></span> accepts <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">w</span></span><span class="antiquote">}</span></span>, we prove that <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span>"</span><span class="antiquote">}</span></span> holds›</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">π'</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π'</span> <span class="main">⟹</span> the <span class="main">(</span><span class="skolem">π'</span> <span class="bound">χ</span><span class="main">)</span> <span class="main">&lt;</span> ltl_FG_to_rabin_def.max_rank<span class="hidden">⇩</span><sub>R</sub> <span class="free">Σ</span> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="var">?Δ</span> <span class="var">?q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>M_fin <span class="skolem">π'</span><span class="main">,</span> UNIV<span class="main">)</span> <span class="free">w</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π'</span> <span class="main">⟹</span> accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="var">?Δ</span> <span class="var">?q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>Acc <span class="free">Σ</span> <span class="skolem">π'</span> <span class="bound">χ</span><span class="main">)</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_I<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="var">?rhs</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> max_rank_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">𝒢</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">𝒢</span> <span class="main">=</span> dom <span class="skolem">π'</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">𝒢</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">π'</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">moreover</span></span>
    
    <span class="keyword1"><span class="command">note</span></span> 𝒢_properties<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted"><span class="quoted">‹dom <span class="skolem"><span class="skolem">π'</span></span> <span class="main"><span class="main">⊆</span></span> <span class="keyword1"><span class="keyword1"><span class="hidden">❙</span><b>G</b></span></span> <span class="free"><span class="free">φ</span></span>›</span></span></span><span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">unfolded</span></span> 𝒢_def<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">symmetric</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> 𝔐_Accept<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> <span class="skolem">𝒢</span> <span class="main">⟹</span> ltl_FG_to_rabin_def.accept<span class="hidden">⇩</span><sub>R</sub>' <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span> <span class="skolem">𝒢</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Acc_to_mojmir_accept<span class="main">[</span><span class="operator">OF</span> _ 0 3<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"theG <span class="main">_</span>"</span></span><span class="main">]</span> 1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="keyword1">G</span> theG <span class="main">_</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> ltl.sel<span class="main">]</span> 𝒢_def 
      <span class="keyword1"><span class="command">unfolding</span></span> ltl_prop_entails_abs.rep_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> ltl.sel<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span><span class="main">)</span> 
 
    <span class="comment1">― ‹Normalise <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">π</span><span class="antiquote">}</span></span> to the smallest accepting ranks›</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">π'</span> <span class="main">=</span> dom <span class="skolem">π</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π</span> <span class="main">⟹</span> <span class="skolem">π</span> <span class="bound">χ</span> <span class="main">=</span> ltl_FG_to_rabin_def.smallest_accepting_rank<span class="hidden">⇩</span><sub>R</sub> <span class="free">Σ</span> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span> <span class="main">(</span>dom <span class="skolem">π</span><span class="main">)</span> <span class="free">w</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>δ<span class="hidden">⇩</span><sub>𝒜</sub> <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>ι<span class="hidden">⇩</span><sub>𝒜</sub> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>M_fin <span class="skolem">π</span><span class="main">,</span> UNIV<span class="main">)</span> <span class="free">w</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π</span> <span class="main">⟹</span> accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>δ<span class="hidden">⇩</span><sub>𝒜</sub> <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>ι<span class="hidden">⇩</span><sub>𝒜</sub> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>Acc <span class="free">Σ</span> <span class="skolem">π</span> <span class="bound">χ</span><span class="main">)</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> normalize_π<span class="main">[</span><span class="operator">OF</span> 0 _ 2 3<span class="main">]</span> 1 <span class="keyword1"><span class="command">unfolding</span></span> max_rank_of_def ltl_prop_entails_abs.rep_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ltl_FG_to_rabin <span class="free">Σ</span> <span class="skolem">𝒢</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_Σ bounded_w <span class="quoted"><span class="quoted">‹Only_G <span class="skolem">𝒢</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ltl_FG_to_rabin_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closed <span class="skolem">𝒢</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 𝔐_Accept <span class="quoted"><span class="quoted">‹Only_G <span class="skolem">𝒢</span>›</span></span> ltl.sel<span class="main">(</span>8<span class="main">)</span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">𝒢</span>›</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> ltl_FG_to_rabin.ltl_to_rabin_correct_exposed'<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹ltl_FG_to_rabin <span class="free">Σ</span> <span class="skolem">𝒢</span> <span class="free">w</span>›</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

    <span class="keyword1"><span class="command">moreover</span></span>
    
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"accept<span class="hidden">⇩</span><sub>M</sub> <span class="free">φ</span> <span class="skolem">𝒢</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="comment1">(* Wait until the run gets trapped in the "good" states *)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≥</span> <span class="skolem">i</span> <span class="main">⟹</span> <span class="skolem">r</span> <span class="bound">j</span> <span class="main">∉</span> M_fin <span class="skolem">π</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹accepting_pair<span class="hidden">⇩</span><sub>R</sub>  <span class="var">?Δ</span> <span class="var">?q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>M_fin <span class="skolem">π</span><span class="main">,</span> UNIV<span class="main">)</span> <span class="free">w</span>›</span></span> limit_inter_empty<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>range <span class="skolem">r</span><span class="main">)</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"M_fin <span class="skolem">π</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> r_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> MOST_nat_le accepting_pair<span class="hidden">⇩</span><sub>R</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      
      <span class="comment1">(* Wait until the states with succeeding tokens are (prop.) equivalent to ℱ *)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> i'_def<span class="main">:</span> 
        <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span> <span class="bound">ψ</span> <span class="bound">S</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≥</span> <span class="skolem">i'</span> <span class="main">⟹</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> ℱ <span class="bound">ψ</span> <span class="free">w</span> <span class="skolem">𝒢</span> <span class="bound">j</span> <span class="main">∧</span> <span class="skolem">𝒢</span> <span class="main">⊆</span> <span class="bound">S</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> ltl_FG_to_rabin_def.𝒮<span class="hidden">⇩</span><sub>R</sub> <span class="free">Σ</span> <span class="bound">ψ</span> <span class="skolem">𝒢</span> <span class="free">w</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="bound">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ℱ_eq_𝒮_generalized<span class="main">[</span><span class="operator">OF</span> finite_Σ bounded_w <span class="quoted"><span class="quoted">‹closed <span class="skolem">𝒢</span> <span class="free">w</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> MOST_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span> 

      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> <span class="skolem">S</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> max <span class="skolem">i</span> <span class="skolem">i'</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> <span class="skolem">i'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword3"><span class="command">assume</span></span> 𝒢_def'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ψ</span><span class="main">.</span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span> <span class="main">⟶</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword1">G</span> <span class="bound">ψ</span> <span class="main">∧</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">𝒢</span> <span class="main">(</span>ℱ <span class="bound">ψ</span> <span class="free">w</span> <span class="skolem">𝒢</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
        
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?φ'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>fst <span class="main">(</span><span class="skolem">r</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>fst <span class="main">(</span><span class="skolem">r</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
        
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> <span class="skolem">𝒢</span> <span class="main">⟹</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">χ</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 𝒢_def' <span class="quoted"><span class="quoted">‹<span class="skolem">𝒢</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> G_nested_propos_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span>

        <span class="comment1">(* Proof that the chosen S propositionally implies all succeeding states of the projected Mojmir automaton *)</span>
        <span class="keyword1"><span class="command">{</span></span> 
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">χ</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">χ</span> <span class="main">∈</span> <span class="skolem">𝒢</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ψ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">χ</span> <span class="main">=</span> <span class="keyword1">G</span> <span class="skolem">ψ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">G</span> <span class="skolem">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Only_G <span class="skolem">𝒢</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">G</span> <span class="skolem">ψ</span> <span class="main">∈</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">𝒢</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          
          <span class="keyword1"><span class="command">interpret</span></span> 𝔐<span class="main">:</span> ltl_FG_to_rabin <span class="quoted"><span class="free">Σ</span></span> <span class="quoted"><span class="skolem">ψ</span></span> <span class="quoted"><span class="skolem">𝒢</span></span> <span class="quoted"><span class="free">w</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> <span class="quoted"><span class="quoted">‹ltl_FG_to_rabin <span class="free">Σ</span> <span class="skolem">𝒢</span> <span class="free">w</span>›</span></span><span class="main">)</span>

          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> 𝔐.𝒮 <span class="skolem">j</span>"</span></span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">𝒢</span> <span class="main">(</span>ℱ <span class="skolem">ψ</span> <span class="free">w</span> <span class="skolem">𝒢</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> 𝒢_def' <span class="quoted"><span class="quoted">‹<span class="keyword1">G</span> <span class="skolem">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">moreover</span></span> 
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">⊇</span> <span class="skolem">𝒢</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> 𝒢_def' <span class="quoted"><span class="quoted">‹Only_G <span class="skolem">𝒢</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">𝒢</span> <span class="main">⟹</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">𝒢</span> <span class="bound">x</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Only_G <span class="skolem">𝒢</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">⊇</span> <span class="skolem">𝒢</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">{</span></span>
              <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">𝒢</span> <span class="main">∪</span> <span class="main">{</span>ℱ <span class="skolem">ψ</span> <span class="free">w</span> <span class="skolem">𝒢</span> <span class="skolem">j</span><span class="main">}</span> <span class="main">⟹</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">x</span>"</span></span> 
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">𝒢</span> <span class="main">⊆</span> <span class="skolem">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> ℱ <span class="skolem">ψ</span> <span class="free">w</span> <span class="skolem">𝒢</span> <span class="skolem">j</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Only_G <span class="skolem">𝒢</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="skolem">q</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">q</span> <span class="main">∈</span> ltl_FG_to_rabin_def.𝒮<span class="hidden">⇩</span><sub>R</sub> <span class="free">Σ</span> <span class="skolem">ψ</span> <span class="skolem">𝒢</span> <span class="free">w</span> <span class="skolem">j</span>›</span></span>
                <span class="keyword1"><span class="command">using</span></span> i'_def<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≥</span> <span class="skolem">i'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">G</span> <span class="skolem">ψ</span> <span class="main">∈</span> <span class="skolem">𝒢</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">}</span></span>
            <span class="keyword1"><span class="command">ultimately</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">𝒢</span> <span class="main">(</span>Rep <span class="skolem">q</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> eval<span class="hidden">⇩</span><sub>G</sub>_respectfulness_generalized<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">𝒢</span> <span class="main">∪</span> <span class="main">{</span>ℱ <span class="skolem">ψ</span> <span class="free">w</span> <span class="skolem">𝒢</span> <span class="skolem">j</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"Rep <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="skolem">S</span></span> <span class="quoted"><span class="skolem">𝒢</span></span><span class="main">]</span> 
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">moreover</span></span> 
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝔐.𝒮 <span class="skolem">j</span> <span class="main">=</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="skolem">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">q</span> <span class="main">.</span> <span class="main">∃</span><span class="bound">j'</span><span class="main">.</span> the 𝔐.smallest_accepting_rank <span class="main">≤</span> <span class="bound">j'</span> <span class="main">∧</span> the <span class="main">(</span><span class="var">?m</span> <span class="main">(</span><span class="keyword1">G</span> <span class="skolem">ψ</span><span class="main">)</span><span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="bound">j'</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> 𝔐.𝒮.simps <span class="keyword1"><span class="command">using</span></span> run_properties<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="keyword1">G</span> <span class="skolem">ψ</span> <span class="main">∈</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>›</span></span><span class="main">]</span> r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">ultimately</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≥</span> the <span class="main">(</span><span class="skolem">π</span> <span class="skolem">χ</span><span class="main">)</span> <span class="main">⟹</span> the <span class="main">(</span><span class="var">?m</span> <span class="skolem">χ</span><span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="bound">j</span> <span class="main">⟹</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">𝒢</span> <span class="main">(</span>Rep <span class="bound">q</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">χ</span> <span class="main">∈</span> <span class="skolem">𝒢</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> 𝒢_def <span class="quoted"><span class="quoted">‹dom <span class="skolem">π'</span> <span class="main">=</span> dom <span class="skolem">π</span>›</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">χ</span> <span class="main">=</span> <span class="keyword1">G</span> <span class="skolem">ψ</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π</span> <span class="main">⟹</span> <span class="skolem">π</span> <span class="bound">χ</span> <span class="main">=</span> ltl_FG_to_rabin_def.smallest_accepting_rank<span class="hidden">⇩</span><sub>R</sub> <span class="free">Σ</span> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span> <span class="main">(</span>dom <span class="skolem">π</span><span class="main">)</span> <span class="free">w</span>›</span></span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">χ</span> <span class="main">∈</span> <span class="skolem">𝒢</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> 𝒢_def <span class="quoted"><span class="quoted">‹dom <span class="skolem">π'</span> <span class="main">=</span> dom <span class="skolem">π</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="skolem">χ</span> <span class="main">=</span> <span class="keyword1">G</span> <span class="skolem">ψ</span>›</span></span><span class="main">]</span> ltl.sel<span class="main">(</span>8<span class="main">)</span>
            <span class="keyword1"><span class="command">unfolding</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">𝒢</span> <span class="main">≡</span> dom <span class="skolem">π'</span>›</span></span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">π'</span> <span class="main">=</span> dom <span class="skolem">π</span>›</span></span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> 

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> <span class="skolem">𝒢</span> <span class="main">⟹</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">χ</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">j'</span></span> <span class="main">≥</span> the <span class="main">(</span><span class="skolem">π</span> <span class="bound">χ</span><span class="main">)</span><span class="main">.</span> the <span class="main">(</span><span class="var">?m</span> <span class="bound">χ</span><span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="bound">j'</span> <span class="main">⟶</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="skolem">𝒢</span> <span class="main">(</span>Rep <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="var">?φ'</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> i_def<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≥</span> <span class="skolem">i</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eval<span class="hidden">⇩</span><sub>G</sub>_abs_def ltl_prop_entails_abs.rep_eq case_prod_beta option.case_eq_if<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> <span class="quoted"><span class="quoted">‹<span class="skolem">𝒢</span> <span class="main">≡</span> dom <span class="skolem">π'</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">π'</span> <span class="main">=</span> dom <span class="skolem">π</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">meson</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        
        <span class="keyword1"><span class="command">ultimately</span></span>

        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="var">?φ'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword1">af</span> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="main">0</span> <span class="main">→</span> <span class="skolem">j</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> φ'_def ltl_prop_equiv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"accept<span class="hidden">⇩</span><sub>M</sub> <span class="free">φ</span> <span class="skolem">𝒢</span> <span class="free">w</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> accept<span class="hidden">⇩</span><sub>M</sub>_def MOST_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">𝒢</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>›</span></span> ltl_logical_characterization <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ltl_to_generalized_rabin_af</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ltl_to_generalized_rabin_af</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> ltl_to_rabin_base_def.ltl_to_generalized_rabin <span class="keyword1">↑af</span> <span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub></span> Abs Abs M_fin <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>  

<span class="keyword1" id="LTL_Rabin-ltl_to_generalized_rabin_af_wellformed"><span class="command">lemma</span></span> ltl_to_generalized_rabin_af_wellformed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="free">Σ</span> <span class="main">⟹</span> range <span class="free">w</span> <span class="main">⊆</span> <span class="free">Σ</span> <span class="main">⟹</span> ltl_to_rabin_af <span class="free">Σ</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> af_G_letter_sat_core_lifted ltl_prop_entails_abs.rep_eq <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_reach_af<span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> le_trans ltl_semi_mojmir<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> semi_mojmir_def<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">theorem</span></span> ltl_to_generalized_rabin_af_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"range <span class="free">w</span> <span class="main">⊆</span> <span class="free">Σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span> <span class="main">=</span> accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>ltl_to_generalized_rabin_af <span class="free">Σ</span> <span class="free">φ</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ltl_to_generalized_rabin_af_wellformed<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">THEN</span> ltl_to_rabin_af.ltl_to_generalized_rabin_correct<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">thm</span></span> ltl_to_generalized_rabin_af_correct ltl_FG_to_generalized_rabin_correct

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="LTL_Rabin_Unfold_Opt">
<div class="head">
<h1>Theory LTL_Rabin_Unfold_Opt</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Author:      Salomon Sickert
    License:     BSD
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Eager Unfolding Optimisation›</span></span>

<span class="keyword1"><span class="command">theory</span></span> LTL_Rabin_Unfold_Opt
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <a href="LTL_Rabin.html">LTL_Rabin</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Preliminary Facts›</span></span>

<span class="keyword1" id="LTL_Rabin_Unfold_Opt-finite_reach_af_opt"><span class="command">lemma</span></span> finite_reach_af_opt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reach <span class="free">Σ</span> <span class="keyword1">↑af<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">(</span>Abs <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">Σ</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> af_abs_opt.finite_abs_reach <span class="keyword1"><span class="command">unfolding</span></span> af_abs_opt.abs_reach_def reach_foldl_def<span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> finite_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>foldl <span class="keyword1">↑af<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">(</span>Abs <span class="free">φ</span><span class="main">)</span> <span class="bound">w</span> <span class="main">|</span><span class="bound">w</span><span class="main">.</span> set <span class="bound">w</span> <span class="main">⊆</span> <span class="free">Σ</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>foldl <span class="keyword1">↑af<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">(</span>Abs <span class="free">φ</span><span class="main">)</span> <span class="bound">w</span> <span class="main">|</span><span class="bound">w</span><span class="main">.</span> True<span class="main">}</span>"</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">unfolding</span></span> af_letter_abs_opt_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_def<span class="main">)</span>

<span class="keyword1" id="LTL_Rabin_Unfold_Opt-finite_reach_af_G_opt"><span class="command">lemma</span></span> finite_reach_af_G_opt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reach <span class="free">Σ</span> <span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">(</span>Abs <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">Σ</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> af_G_abs_opt.finite_abs_reach <span class="keyword1"><span class="command">unfolding</span></span> af_G_abs_opt.abs_reach_def reach_foldl_def<span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> finite_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>foldl <span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">(</span>Abs <span class="free">φ</span><span class="main">)</span> <span class="bound">w</span> <span class="main">|</span><span class="bound">w</span><span class="main">.</span> set <span class="bound">w</span> <span class="main">⊆</span> <span class="free">Σ</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span>foldl <span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">(</span>Abs <span class="free">φ</span><span class="main">)</span> <span class="bound">w</span> <span class="main">|</span><span class="bound">w</span><span class="main">.</span> True<span class="main">}</span>"</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">unfolding</span></span> af_G_letter_abs_opt_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_def<span class="main">)</span>

<span class="keyword1" id="LTL_Rabin_Unfold_Opt-wellformed_mojmir_opt"><span class="command">lemma</span></span> wellformed_mojmir_opt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Only_G <span class="free">𝒢</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"range <span class="free">w</span> <span class="main">⊆</span> <span class="free">Σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mojmir <span class="free">Σ</span> <span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">(</span>Abs <span class="free">φ</span><span class="main">)</span> <span class="free">w</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="bound">ν</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">}</span> <span class="main">⟶</span> af_G_letter_abs_opt <span class="bound">q</span> <span class="bound">ν</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Only_G <span class="free">𝒢</span>›</span></span> af_G_letter_opt_sat_core_lifted <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_reach_af_G_opt assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">locale</span></span> ltl_FG_to_rabin_opt_def <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> 
    <span class="free">Σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">𝒢</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> 
    <span class="free">w</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set word"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> mojmir_to_rabin_def <span class="quoted"><span class="free">Σ</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>𝔘</sub></span>"</span></span> <span class="quoted"><span class="quoted">"Abs <span class="main">(</span>Unf<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> ltl_FG_to_rabin_opt <span class="main">=</span> ltl_FG_to_rabin_opt_def <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
    wellformed_𝒢<span class="main">:</span> <span class="quoted"><span class="quoted">"Only_G <span class="free">𝒢</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    bounded_w<span class="main">:</span> <span class="quoted"><span class="quoted">"range <span class="free">w</span> <span class="main">⊆</span> <span class="free">Σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    finite_Σ<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">Σ</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">sublocale</span></span> mojmir_to_rabin <span class="quoted"><span class="free">Σ</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>𝔘</sub></span>"</span></span> <span class="quoted"><span class="quoted">"Abs <span class="main">(</span>Unf<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">ν</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">}</span> <span class="main">⟹</span> <span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="bound">q</span> <span class="bound">ν</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wellformed_𝒢 af_G_letter_opt_sat_core_lifted <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> nonempty_Σ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Σ</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bounded_w <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reach <span class="free">Σ</span> <span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">(</span>Abs <span class="main">(</span>Unf<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?A</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> finite_reach_af_G_opt wellformed_𝒢 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> finite_Σ bounded_w<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Equivalences between the standard and the eager Mojmir construction›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> 
    <span class="free">Σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> 
    <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">𝒢</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl set"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">w</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set word"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> 
    context_assms<span class="main">:</span> <span class="quoted"><span class="quoted">"Only_G <span class="free">𝒢</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Σ</span>"</span></span> <span class="quoted"><span class="quoted">"range <span class="free">w</span> <span class="main">⊆</span> <span class="free">Σ</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">― ‹Create an interpretation of the mojmir locale for the standard construction›</span>
<span class="keyword1"><span class="command">interpretation</span></span> 𝔐<span class="main">:</span> ltl_FG_to_rabin <span class="quoted"><span class="free">Σ</span></span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="free">𝒢</span></span> <span class="quoted"><span class="free">w</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">insert</span> context_assms<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="comment1">― ‹Create an interpretation of the mojmir locale for the optimised construction›</span>
<span class="keyword1"><span class="command">interpretation</span></span> 𝔘<span class="main">:</span> ltl_FG_to_rabin_opt <span class="quoted"><span class="free">Σ</span></span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="free">𝒢</span></span> <span class="quoted"><span class="free">w</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">insert</span> context_assms<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="LTL_Rabin_Unfold_Opt-unfold_token_run_eq"><span class="command">lemma</span></span> unfold_token_run_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"𝔐.token_run <span class="free">x</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">↑step</span> <span class="main">(</span>𝔘.token_run <span class="free">x</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">+</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">+</span> <span class="main">(</span>Suc <span class="free">n</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> Suc <span class="free">n</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">[</span><span class="free">x</span> <span class="main">→</span> Suc <span class="free">n</span><span class="main">]</span> <span class="main">=</span> <span class="free">w</span> <span class="main">[</span><span class="free">x</span> <span class="main">→</span> <span class="free">n</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">w</span> <span class="free">n</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> upt_Suc subsequence_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"af<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="free">x</span> <span class="main">→</span> Suc <span class="free">n</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> step <span class="main">(</span><span class="keyword1">af<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">(</span>Unf<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="main">[</span><span class="free">x</span> <span class="main">→</span> <span class="free">n</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> af_to_af_opt<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">w</span> <span class="main">[</span><span class="free">x</span> <span class="main">→</span> Suc <span class="free">n</span><span class="main">]</span> <span class="main">=</span> <span class="free">w</span> <span class="main">[</span><span class="free">x</span> <span class="main">→</span> <span class="free">n</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">w</span> <span class="free">n</span><span class="main">]</span>›</span></span> foldl_append
    <span class="keyword1"><span class="command">using</span></span> af_letter_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> Abs <span class="var">?l</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> 𝔐.token_run.simps run_foldl 
    <span class="keyword1"><span class="command">using</span></span> subsequence_shift <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">+</span> <span class="main">(</span>Suc <span class="free">n</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> Suc <span class="free">n</span>›</span></span> Nat.add_0_right subsequence_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> af_G_abs.f_foldl_abs_alt_def af_G_abs.f_foldl_abs.abs_eq af_G_letter_abs_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Abs <span class="var">?r</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> 𝔘.token_run.simps run_foldl subsequence_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> subsequence_shift <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">+</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>›</span></span> Nat.add_0_right af_G_letter_abs_opt_def
    <span class="keyword1"><span class="command">unfolding</span></span> af_G_abs_opt.f_foldl_abs_alt_def<span class="main">[</span><span class="operator">unfolded</span> af_G_abs_opt.f_foldl_abs.abs_eq<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> step_abs.abs_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LTL_Rabin_Unfold_Opt-unfold_token_succeeds_eq"><span class="command">lemma</span></span> unfold_token_succeeds_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"𝔐.token_succeeds <span class="free">x</span> <span class="main">=</span> 𝔘.token_succeeds <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"𝔐.token_succeeds <span class="free">x</span>"</span></span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span><span class="main">.</span> <span class="bound">m</span> <span class="main">&gt;</span> <span class="skolem">n</span> <span class="main">⟹</span> 𝔐.token_run <span class="free">x</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> 𝔐.token_succeeds_alt_def MOST_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"𝔐.token_run <span class="free">x</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="main">(</span>step_abs <span class="main">(</span>𝔘.token_run <span class="free">x</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unfold_token_run_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span> <span class="main">-</span> <span class="free">x</span> <span class="main">=</span> Suc <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≤</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝔘.token_run <span class="free">x</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> Unf<span class="hidden">⇩</span><sub>G</sub>_abs <span class="main">(</span>step_abs <span class="main">(</span>𝔘.token_run <span class="free">x</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> af_G_letter_abs_opt_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="main">(</span>𝔘.token_run <span class="free">x</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 1 Unf<span class="hidden">⇩</span><sub>G</sub>_𝒢<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Only_G <span class="free">𝒢</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Rep_Abs_equiv Unf<span class="hidden">⇩</span><sub>G</sub>_abs_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"𝔘.token_succeeds <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> 𝔘.token_succeeds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"𝔘.token_succeeds <span class="free">x</span>"</span></span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span><span class="main">.</span> <span class="bound">m</span> <span class="main">&gt;</span> <span class="skolem">n</span> <span class="main">⟹</span> 𝔘.token_run <span class="free">x</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> 𝔘.token_succeeds_alt_def MOST_nat <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"𝔘.token_run <span class="free">x</span> <span class="skolem">n</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="main">(</span>step_abs <span class="main">(</span>𝔘.token_run <span class="free">x</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> step_𝒢<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Only_G <span class="free">𝒢</span>›</span></span><span class="main">]</span> Rep_step<span class="main">[</span><span class="operator">unfolded</span> ltl_prop_equiv_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"𝔐.token_succeeds <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> 𝔐.token_succeeds_def unfold_token_run_eq<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">≤</span> <span class="skolem">n</span>›</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>    

<span class="keyword1" id="LTL_Rabin_Unfold_Opt-unfold_accept_eq"><span class="command">lemma</span></span> unfold_accept_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"𝔐.accept <span class="main">=</span> 𝔘.accept"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> 𝔐.accept_def 𝔘.accept_def MOST_nat_le unfold_token_succeeds_eq <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1" id="LTL_Rabin_Unfold_Opt-unfold_𝒮_eq"><span class="command">lemma</span></span> unfold_𝒮_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"𝔐.accept"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">n</span><span class="main">.</span> 𝔐.𝒮 <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> step_abs <span class="bound">q</span> <span class="main">(</span><span class="free">w</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>𝔘.𝒮 <span class="bound">n</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span>Abs <span class="free">φ</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="comment1">― ‹Obtain lower bounds for proof›</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i<span class="hidden">⇩</span><sub>𝔐</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="hidden">⇩</span><sub>𝔐</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"𝔐.smallest_accepting_rank <span class="main">=</span> Some <span class="skolem">i<span class="hidden">⇩</span><sub>𝔐</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> 𝔐.smallest_accepting_rank_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n<span class="hidden">⇩</span><sub>𝔐</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="hidden">⇩</span><sub>𝔐</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">m</span><span class="main">.</span> <span class="bound">m</span> <span class="main">≥</span> <span class="skolem">n<span class="hidden">⇩</span><sub>𝔐</sub></span> <span class="main">⟹</span> 𝔐.token_succeeds <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="bound">m</span> <span class="main">&lt;</span> <span class="bound">x</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="skolem">i<span class="hidden">⇩</span><sub>𝔐</sub></span><span class="main">.</span> 𝔐.rank <span class="bound">x</span> <span class="bound">m</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">)</span> <span class="main">∨</span> 𝔐.token_run <span class="bound">x</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 𝔐.token_smallest_accepting_rank<span class="main">[</span><span class="operator">OF</span> i<span class="hidden">⇩</span><sub>𝔐</sub>_def<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> MOST_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝔘.accept"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms unfold_accept_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i<span class="hidden">⇩</span><sub>𝔘</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> i<span class="hidden">⇩</span><sub>𝔘</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"𝔘.smallest_accepting_rank <span class="main">=</span> Some <span class="skolem">i<span class="hidden">⇩</span><sub>𝔘</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹𝔘.accept›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 𝔘.smallest_accepting_rank_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n<span class="hidden">⇩</span><sub>𝔘</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="hidden">⇩</span><sub>𝔘</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">m</span><span class="main">.</span> <span class="bound">m</span> <span class="main">≥</span> <span class="skolem">n<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">⟹</span> 𝔘.token_succeeds <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="bound">m</span> <span class="main">&lt;</span> <span class="bound">x</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="skolem">i<span class="hidden">⇩</span><sub>𝔘</sub></span><span class="main">.</span> 𝔘.rank <span class="bound">x</span> <span class="bound">m</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">)</span> <span class="main">∨</span> 𝔘.token_run <span class="bound">x</span> <span class="bound">m</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 𝔘.token_smallest_accepting_rank<span class="main">[</span><span class="operator">OF</span> i<span class="hidden">⇩</span><sub>𝔘</sub>_def<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> MOST_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> MOST_nat_le<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> 
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≥</span> max <span class="skolem">n<span class="hidden">⇩</span><sub>𝔐</sub></span> <span class="skolem">n<span class="hidden">⇩</span><sub>𝔘</sub></span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≥</span> <span class="skolem">n<span class="hidden">⇩</span><sub>𝔐</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≥</span> <span class="skolem">n<span class="hidden">⇩</span><sub>𝔘</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">m</span> <span class="main">≥</span> <span class="skolem">n<span class="hidden">⇩</span><sub>𝔐</sub></span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
    <span class="comment1">― ‹Using the properties of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">n<span class="hidden">⇩</span><sub>𝔐</sub></span></span><span class="antiquote">}</span></span> and <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="skolem">n<span class="hidden">⇩</span><sub>𝔘</sub></span></span><span class="antiquote">}</span></span> and the lemma <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">thm</span> unfold_token_succeeds_eq<span class="antiquote">}</span></span>, 
       we prove that the behaviour of x in <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">𝔐</span><span class="antiquote">}</span></span> and <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">𝔘</span><span class="antiquote">}</span></span> is similar in regards to 
       creation time, accepting rank or final states.›</span>
    <span class="keyword1"><span class="command">hence</span></span> token_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> Suc <span class="skolem">m</span> <span class="main">&lt;</span> <span class="bound">x</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="skolem">i<span class="hidden">⇩</span><sub>𝔐</sub></span><span class="main">.</span> 𝔐.rank <span class="bound">x</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">)</span> <span class="main">∨</span> 𝔐.token_run <span class="bound">x</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">}</span>
      <span class="main">⟷</span> <span class="skolem">m</span> <span class="main">&lt;</span> <span class="bound">x</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="skolem">i<span class="hidden">⇩</span><sub>𝔘</sub></span><span class="main">.</span> 𝔘.rank <span class="bound">x</span> <span class="skolem">m</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">)</span> <span class="main">∨</span> 𝔘.token_run <span class="bound">x</span> <span class="skolem">m</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> n<span class="hidden">⇩</span><sub>𝔐</sub>_def n<span class="hidden">⇩</span><sub>𝔘</sub>_def <span class="keyword1"><span class="command">unfolding</span></span> unfold_token_succeeds_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"𝔐.𝒮 <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> step_abs <span class="bound">q</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>𝔘.𝒮 <span class="skolem">m</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span>Abs <span class="free">φ</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> 
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="skolem">i<span class="hidden">⇩</span><sub>𝔐</sub></span><span class="main">.</span> 𝔐.state_rank <span class="skolem">q</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">j</span>"</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> q_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> 𝔐.token_run <span class="skolem">x</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> Suc <span class="skolem">m</span>"</span></span>
           <span class="keyword1"><span class="command">using</span></span> 𝔐.push_down_state_rank_tokens <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="skolem">i<span class="hidden">⇩</span><sub>𝔐</sub></span><span class="main">.</span> 𝔐.rank <span class="skolem">x</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">j</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> 𝔐.rank_eq_state_rank <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
        <span class="keyword1"><span class="command">hence</span></span> token_cases<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="skolem">i<span class="hidden">⇩</span><sub>𝔘</sub></span><span class="main">.</span> 𝔘.rank <span class="skolem">x</span> <span class="skolem">m</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">)</span> <span class="main">∨</span> 𝔘.token_run <span class="skolem">x</span> <span class="skolem">m</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">}</span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">=</span> Suc <span class="skolem">m</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> token_trans<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> 𝔐.rank_Some_time <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="var">?rhs</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≠</span> Suc <span class="skolem">m</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">m</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≤</span> Suc <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝔘.token_run <span class="skolem">x</span> <span class="skolem">m</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="skolem">q</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">q</span> <span class="main">=</span> 𝔐.token_run <span class="skolem">x</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>›</span></span> unfold_token_run_eq<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">m</span>›</span></span><span class="main">]</span>
              <span class="keyword1"><span class="command">using</span></span> Rep_step<span class="main">[</span><span class="operator">unfolded</span> ltl_prop_equiv_def<span class="main">]</span> step_𝒢<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Only_G <span class="free">𝒢</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">{</span></span>
              <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> <span class="skolem">i<span class="hidden">⇩</span><sub>𝔘</sub></span><span class="main">.</span> 𝔘.rank <span class="skolem">x</span> <span class="skolem">m</span> <span class="main">=</span> Some <span class="bound">j</span>"</span></span>
              <span class="keyword1"><span class="command">moreover</span></span>
              <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">=</span> 𝔘.token_run <span class="skolem">x</span> <span class="skolem">m</span>"</span></span>
              <span class="keyword1"><span class="command">ultimately</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> <span class="skolem">i<span class="hidden">⇩</span><sub>𝔘</sub></span><span class="main">.</span> 𝔘.state_rank <span class="skolem">q'</span> <span class="skolem">m</span> <span class="main">=</span> Some <span class="bound">j</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> 𝔘.rank_eq_state_rank<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">m</span>›</span></span><span class="main">]</span> q'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">∈</span> 𝔘.𝒮 <span class="skolem">m</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> assms i<span class="hidden">⇩</span><sub>𝔘</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">moreover</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> step_abs <span class="skolem">q'</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">unfolding</span></span> q_def q'_def unfold_token_run_eq<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">m</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
              <span class="keyword1"><span class="command">ultimately</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> step_abs <span class="bound">q</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>𝔘.𝒮 <span class="skolem">m</span><span class="main">)</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">}</span></span>
            <span class="keyword1"><span class="command">ultimately</span></span>
            <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
              <span class="keyword1"><span class="command">using</span></span> token_cases True <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> q_def<span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⊆</span> <span class="var">?rhs</span>"</span></span>   
        <span class="keyword1"><span class="command">unfolding</span></span> 𝔐.𝒮.simps i<span class="hidden">⇩</span><sub>𝔐</sub>_def option.sel <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>   
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> step_abs <span class="bound">q</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>𝔘.𝒮 <span class="skolem">m</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> q_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> step_abs <span class="skolem">q'</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">∈</span> 𝔘.𝒮 <span class="skolem">m</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="var">?lhs</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="skolem">q'</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> False
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> <span class="skolem">i<span class="hidden">⇩</span><sub>𝔘</sub></span><span class="main">.</span> 𝔘.state_rank <span class="skolem">q'</span> <span class="skolem">m</span> <span class="main">=</span> Some <span class="bound">j</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">q'</span> <span class="main">∈</span> 𝔘.𝒮 <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 𝔘.𝒮.simps i<span class="hidden">⇩</span><sub>𝔘</sub>_def option.sel <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> q'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">=</span> 𝔘.token_run <span class="skolem">x</span> <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> Suc <span class="skolem">m</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> 𝔘.push_down_state_rank_tokens <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
            <span class="keyword1"><span class="command">ultimately</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> <span class="skolem">i<span class="hidden">⇩</span><sub>𝔘</sub></span><span class="main">.</span> 𝔘.rank <span class="skolem">x</span> <span class="skolem">m</span> <span class="main">=</span> Some <span class="bound">j</span>"</span></span> 
              <span class="keyword1"><span class="command">unfolding</span></span> 𝔘.rank_eq_state_rank<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">m</span>›</span></span><span class="main">]</span> q'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="skolem">i<span class="hidden">⇩</span><sub>𝔐</sub></span><span class="main">.</span> 𝔐.rank <span class="skolem">x</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">)</span> <span class="main">∨</span> 𝔐.token_run <span class="skolem">x</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">}</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> token_trans<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> 𝔘.rank_Some_time <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝔐.token_run <span class="skolem">x</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> q_def q'_def unfold_token_run_eq<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">m</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
            <span class="keyword1"><span class="command">ultimately</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="skolem">i<span class="hidden">⇩</span><sub>𝔐</sub></span><span class="main">.</span> 𝔐.state_rank <span class="skolem">q</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">)</span> <span class="main">∨</span> <span class="skolem">q</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">}</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> 𝔐.rank_eq_state_rank<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≤</span> Suc <span class="skolem">m</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> 𝔐.𝒮.simps option.sel i<span class="hidden">⇩</span><sub>𝔐</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> step_𝒢<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Only_G <span class="free">𝒢</span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"Rep <span class="skolem"><span class="skolem">q'</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> q_def Rep_step<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ltl_prop_equiv_def<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="skolem">i<span class="hidden">⇩</span><sub>𝔐</sub></span><span class="main">.</span> 𝔐.rank <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">)</span> <span class="main">∨</span> <span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="main">(</span>Abs <span class="free">φ</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> token_trans<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">m</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Abs <span class="free">φ</span> <span class="main">∈</span> <span class="var">?lhs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> i<span class="hidden">⇩</span><sub>𝔐</sub>_def 𝔐.rank_eq_state_rank<span class="main">[</span><span class="operator">OF</span> order_refl<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">𝒢</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="main">(</span>Abs <span class="free">φ</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⊇</span> <span class="var">?rhs</span>"</span></span>   
        <span class="keyword1"><span class="command">unfolding</span></span> 𝔐.𝒮.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Automaton Definition›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">M<span class="hidden">⇩</span><sub>𝔘</sub>_fin</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> ltl <span class="main">⇀</span> nat<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> ltl <span class="main">⇀</span> <span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub> <span class="main">⇀</span> nat<span class="main">)</span><span class="main">,</span> <span class="tfree">'a</span> set<span class="main">)</span> transition set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">M<span class="hidden">⇩</span><sub>𝔘</sub>_fin</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">φ'</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span><span class="main">,</span> <span class="bound">ν</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span><span class="main">(</span><span class="main">∀</span><span class="bound">S</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">χ</span> <span class="main">∈</span> <span class="main">(</span>dom <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">)</span><span class="main">.</span> <span class="bound">S</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> Abs <span class="bound">χ</span> <span class="main">∧</span> <span class="bound">S</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword1">↑eval<span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span>dom <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">)</span> <span class="main">(</span>Abs <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> the <span class="main">(</span><span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="bound">χ</span><span class="main">)</span><span class="main">.</span> the <span class="main">(</span><span class="bound">m</span> <span class="bound">χ</span><span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">S</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword1">↑eval<span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span>dom <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">)</span> <span class="main">(</span><span class="keyword1">↑step</span> <span class="bound">q</span> <span class="bound">ν</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">S</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">(</span><span class="keyword1">↑step</span> <span class="bound">φ'</span> <span class="bound">ν</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> ltl_to_rabin_af_unf <span class="main">=</span> ltl_to_rabin_base <span class="quoted"><span class="quoted">"<span class="keyword1">↑af<span class="hidden">⇩</span><sub>𝔘</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>𝔘</sub></span>"</span></span> <span class="quoted"><span class="quoted">"Abs <span class="keyword1">o</span> Unf"</span></span> <span class="quoted"><span class="quoted">"Abs <span class="keyword1">o</span> Unf<span class="hidden">⇩</span><sub>G</sub>"</span></span> <span class="quoted">M<span class="hidden">⇩</span><sub>𝔘</sub>_fin</span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">≡</span> delta"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">ι<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">≡</span> initial"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">Acc<span class="hidden">⇩</span><sub>𝔘</sub>_fin</span> <span class="main">≡</span> Acc_fin"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">Acc<span class="hidden">⇩</span><sub>𝔘</sub>_inf</span> <span class="main">≡</span> Acc_inf"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">F<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">≡</span> rabin_pairs"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">Acc<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">≡</span> Acc"</span></span> 
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝒜<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">≡</span> ltl_to_generalized_rabin"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Properties›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Correctness Theorem›</span></span>

<span class="keyword1" id="LTL_Rabin_Unfold_Opt-unfold_optimisation_correct_M"><span class="command">lemma</span></span> unfold_optimisation_correct_M<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dom <span class="free">π<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">=</span> dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">⟹</span> <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="bound">χ</span> <span class="main">=</span> mojmir_def.smallest_accepting_rank <span class="free">Σ</span> <span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span>Abs <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">q</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="free">π<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">⟹</span> <span class="free">π<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="bound">χ</span> <span class="main">=</span> mojmir_def.smallest_accepting_rank <span class="free">Σ</span> af_G_letter_abs_opt <span class="main">(</span>Abs <span class="main">(</span>Unf<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> dom <span class="free">π<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">q</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>ltl_to_rabin_af.δ<span class="hidden">⇩</span><sub>𝒜</sub> <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>ltl_to_rabin_af.ι<span class="hidden">⇩</span><sub>𝒜</sub> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>M_fin <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">,</span> UNIV<span class="main">)</span> <span class="free">w</span> <span class="main">⟷</span> accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>δ<span class="hidden">⇩</span><sub>𝔘</sub> <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>ι<span class="hidden">⇩</span><sub>𝔘</sub> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>M<span class="hidden">⇩</span><sub>𝔘</sub>_fin <span class="free">π<span class="hidden">⇩</span><sub>𝔘</sub></span><span class="main">,</span> UNIV<span class="main">)</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="comment1">― ‹Preliminary Facts›</span>
  <span class="keyword1"><span class="command">note</span></span> 𝒢_properties<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted"><span class="quoted">‹dom <span class="free"><span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span></span> <span class="main"><span class="main">⊆</span></span> <span class="keyword1"><span class="keyword1"><span class="hidden">❙</span><b>G</b></span></span> <span class="free"><span class="free">φ</span></span>›</span></span></span><span class="main">]</span>

  <span class="keyword1"><span class="command">interpret</span></span> 𝒜<span class="main">:</span> ltl_to_rabin_af
    <span class="keyword1"><span class="command">using</span></span> ltl_to_generalized_rabin_af_wellformed bounded_w finite_Σ <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="comment1">― ‹Define constants for both runs›</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r<span class="hidden">⇩</span><sub>𝒜</sub></span></span> <span class="skolem"><span class="skolem">r<span class="hidden">⇩</span><sub>𝔘</sub></span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">=</span> run<span class="hidden">⇩</span><sub>t</sub> <span class="main">(</span>ltl_to_rabin_af.δ<span class="hidden">⇩</span><sub>𝒜</sub> <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>ltl_to_rabin_af.ι<span class="hidden">⇩</span><sub>𝒜</sub> <span class="free">φ</span><span class="main">)</span> <span class="free">w</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">=</span> run<span class="hidden">⇩</span><sub>t</sub> <span class="main">(</span>δ<span class="hidden">⇩</span><sub>𝔘</sub> <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>ι<span class="hidden">⇩</span><sub>𝔘</sub> <span class="free">φ</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="skolem">r<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="skolem">r<span class="hidden">⇩</span><sub>𝔘</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> run<span class="hidden">⇩</span><sub>t</sub>_finite<span class="main">[</span><span class="operator">OF</span> 𝒜.finite_reach<span class="main">]</span> run<span class="hidden">⇩</span><sub>t</sub>_finite<span class="main">[</span><span class="operator">OF</span> finite_reach<span class="main">]</span> bounded_w finite_Σ <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

  <span class="comment1">― ‹Prove that the limit of both runs behave the same in respect to the M acceptance condition›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"limit <span class="skolem">r<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">∩</span> M_fin <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> limit <span class="skolem">r<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">∩</span> M<span class="hidden">⇩</span><sub>𝔘</sub>_fin <span class="free">π<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ltl_FG_to_rabin <span class="free">Σ</span> <span class="main">(</span>dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">)</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">insert</span> 𝒢_elements<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>›</span></span><span class="main"><span class="main">]</span></span> finite_Σ bounded_w<span class="main">)</span> 
    <span class="keyword1"><span class="command">hence</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">⟹</span> mojmir_def.accept <span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span>Abs <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ltl_prop_entails_abs.rep_eq<span class="main"><span class="main">]</span></span> ltl_FG_to_rabin.smallest_accepting_rank_properties<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> domD<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">χ</span> <span class="main">∈</span> dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">.</span> mojmir_def.𝒮 <span class="free">Σ</span> <span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span>Abs <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">}</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span>
       <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> step_abs <span class="bound">q</span> <span class="main">(</span><span class="free">w</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>mojmir_def.𝒮 <span class="free">Σ</span> <span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">(</span>Abs <span class="main">(</span>Unf<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">}</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span>Abs <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> almost_all_commutative'<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">)</span>›</span></span><span class="main">]</span> X unfold_𝒮_eq<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Only_G <span class="main">(</span>dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">)</span>›</span></span><span class="main">]</span> finite_Σ bounded_w <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> i_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span> <span class="bound">χ</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≥</span> <span class="skolem">i</span> <span class="main">⟹</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">⟹</span> mojmir_def.𝒮 <span class="free">Σ</span> <span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span>Abs <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">}</span> <span class="main">(</span>Suc <span class="bound">j</span><span class="main">)</span>
       <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> step_abs <span class="bound">q</span> <span class="main">(</span><span class="free">w</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>mojmir_def.𝒮 <span class="free">Σ</span> <span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">(</span>Abs <span class="main">(</span>Unf<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">}</span> <span class="bound">j</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span>Abs <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">}</span>"</span></span>
       <span class="keyword1"><span class="command">unfolding</span></span> MOST_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"limit <span class="skolem">r<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">=</span> range <span class="main">(</span>suffix <span class="skolem">j</span> <span class="skolem">r<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"limit <span class="skolem">r<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">=</span> range <span class="main">(</span>suffix <span class="skolem">j</span> <span class="skolem">r<span class="hidden">⇩</span><sub>𝔘</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>range <span class="skolem">r<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>range <span class="skolem">r<span class="hidden">⇩</span><sub>𝔘</sub></span><span class="main">)</span>›</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> common_range_limit<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"limit <span class="skolem">r<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">=</span> range <span class="main">(</span>suffix <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">r<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"limit <span class="skolem">r<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">=</span> range <span class="main">(</span>suffix <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">r<span class="hidden">⇩</span><sub>𝔘</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> le_add1 limit_range_suffix_incr<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≥</span> <span class="skolem">i</span> <span class="main">⟹</span> <span class="skolem">r<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">(</span>Suc <span class="bound">j</span><span class="main">)</span> <span class="main">∈</span> M_fin <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">⟷</span> <span class="skolem">r<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="bound">j</span> <span class="main">∈</span> M<span class="hidden">⇩</span><sub>𝔘</sub>_fin <span class="free">π<span class="hidden">⇩</span><sub>𝔘</sub></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≥</span> <span class="skolem">i</span>"</span></span>
       
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">φ<span class="hidden">⇩</span><sub>𝒜</sub></span></span> <span class="skolem"><span class="skolem">m<span class="hidden">⇩</span><sub>𝒜</sub></span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> r<span class="hidden">⇩</span><sub>𝒜</sub>_def'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">φ<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">,</span> <span class="skolem">m<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">)</span><span class="main">,</span> <span class="free">w</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> r<span class="hidden">⇩</span><sub>𝒜</sub>_def run<span class="hidden">⇩</span><sub>t</sub>.simps <span class="keyword1"><span class="command">using</span></span> prod.exhaust <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">φ<span class="hidden">⇩</span><sub>𝔘</sub></span></span> <span class="skolem"><span class="skolem">m<span class="hidden">⇩</span><sub>𝔘</sub></span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> r<span class="hidden">⇩</span><sub>𝔘</sub>_def'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">φ<span class="hidden">⇩</span><sub>𝔘</sub></span><span class="main">,</span> <span class="skolem">m<span class="hidden">⇩</span><sub>𝔘</sub></span><span class="main">)</span><span class="main">,</span> <span class="free">w</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> r<span class="hidden">⇩</span><sub>𝔘</sub>_def run<span class="hidden">⇩</span><sub>t</sub>.simps <span class="keyword1"><span class="command">using</span></span> prod.exhaust <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

      <span class="keyword1"><span class="command">have</span></span> m<span class="hidden">⇩</span><sub>𝒜</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span> <span class="main">⟹</span> the <span class="main">(</span><span class="skolem">m<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="bound">χ</span><span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> semi_mojmir_def.state_rank <span class="free">Σ</span> <span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span>Abs <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span> <span class="bound">q</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 𝒜.run_properties<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span>"</span></span><span class="main">]</span> r<span class="hidden">⇩</span><sub>𝒜</sub>_def'<span class="main">[</span><span class="operator">unfolded</span> r<span class="hidden">⇩</span><sub>𝒜</sub>_def<span class="main">]</span> prod.sel  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">have</span></span> m<span class="hidden">⇩</span><sub>𝔘</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span> <span class="main">⟹</span> the <span class="main">(</span><span class="skolem">m<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="bound">χ</span><span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> semi_mojmir_def.state_rank <span class="free">Σ</span> <span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">(</span>Abs <span class="main">(</span>Unf<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span> <span class="bound">q</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> run_properties<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> r<span class="hidden">⇩</span><sub>𝔘</sub>_def'<span class="main">[</span><span class="operator">unfolded</span> r<span class="hidden">⇩</span><sub>𝔘</sub>_def<span class="main">]</span> prod.sel <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword1"><span class="command">have</span></span> upt_Suc_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">j</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">j</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">j</span><span class="main">]</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Rep <span class="main">(</span>fst <span class="main">(</span>fst <span class="main">(</span><span class="skolem">r<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> step <span class="main">(</span>Rep <span class="main">(</span>fst <span class="main">(</span>fst <span class="main">(</span><span class="skolem">r<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> r<span class="hidden">⇩</span><sub>𝒜</sub>_def r<span class="hidden">⇩</span><sub>𝔘</sub>_def run<span class="hidden">⇩</span><sub>t</sub>.simps fst_conv 𝒜.run_properties<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span>"</span></span><span class="main">]</span> run_properties<span class="main">(</span>1<span class="main">)</span> comp_apply 
          <span class="keyword1"><span class="command">unfolding</span></span> subsequence_def upt_Suc_0 map_append map_def list.map af_abs_equiv Unf_abs.abs_eq <span class="keyword1"><span class="command">using</span></span> Rep_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">S</span><span class="main">.</span> <span class="bound">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="skolem">φ<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">⟷</span> <span class="bound">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> step <span class="main">(</span>Rep <span class="skolem">φ<span class="hidden">⇩</span><sub>𝔘</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> r<span class="hidden">⇩</span><sub>𝒜</sub>_def' r<span class="hidden">⇩</span><sub>𝔘</sub>_def' prod.sel ltl_prop_equiv_def <span class="keyword1"><span class="command">..</span></span>
        
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">⟹</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">χ</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">⊆</span> <span class="skolem">S</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Only_G <span class="main">(</span>dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">)</span>›</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ltl_prop_entailment.simps<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> subsetI<span class="main">)</span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">χ</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">χ</span> <span class="main">∈</span> dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span>"</span></span>
          

            <span class="keyword1"><span class="command">interpret</span></span> 𝔐<span class="main">:</span> ltl_FG_to_rabin <span class="quoted"><span class="free">Σ</span></span> <span class="quoted"><span class="quoted">"theG <span class="skolem">χ</span>"</span></span> <span class="quoted"><span class="quoted">"dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span>"</span></span> 
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> <span class="quoted"><span class="quoted">‹Only_G <span class="main">(</span>dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">)</span>›</span></span> bounded_w finite_Σ<span class="main">)</span>
            <span class="keyword1"><span class="command">interpret</span></span> 𝔘<span class="main">:</span> ltl_FG_to_rabin_opt <span class="quoted"><span class="free">Σ</span></span> <span class="quoted"><span class="quoted">"theG <span class="skolem">χ</span>"</span></span> <span class="quoted"><span class="quoted">"dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> <span class="quoted"><span class="quoted">‹Only_G <span class="main">(</span>dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">)</span>›</span></span> bounded_w finite_Σ<span class="main">)</span>
  
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">ν</span><span class="main">.</span> dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span> <span class="main">⟹</span> dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="main">(</span>step_abs <span class="bound">q</span> <span class="bound">ν</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Only_G <span class="main">(</span>dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ltl_prop_equiv_def Rep_step step_𝒢<span class="main">)</span> 
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> subsetStep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ν</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> step_abs <span class="bound">q</span> <span class="bound">ν</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">}</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
               
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">)</span> <span class="main">(</span>Rep <span class="bound">q</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">ν</span><span class="main">.</span> <span class="main">(</span>dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span> <span class="main">⟹</span> <span class="var">?P</span> <span class="bound">q</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Only_G <span class="main">(</span>dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">)</span>›</span></span> eval<span class="hidden">⇩</span><sub>G</sub>_prop_entailment <span class="quoted"><span class="quoted">‹<span class="main">(</span>dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">)</span> <span class="main">⊆</span> <span class="skolem">S</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span>dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">)</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">}</span> <span class="main">⟹</span> <span class="var">?P</span> <span class="bound">q</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">have</span></span> Y<span class="main">:</span> <span class="quoted"><span class="quoted">"𝔐.𝒮 <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> step_abs <span class="bound">q</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>𝔘.𝒮 <span class="skolem">j</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span>Abs <span class="main">(</span>theG <span class="skolem">χ</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">}</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> i_def<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">≥</span> <span class="skolem">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">χ</span> <span class="main">∈</span> dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            
            <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"𝔐.smallest_accepting_rank <span class="main">=</span> <span class="main">(</span><span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="skolem">χ</span><span class="main">)</span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"𝔘.smallest_accepting_rank <span class="main">=</span> <span class="main">(</span><span class="free">π<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="skolem">χ</span><span class="main">)</span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">χ</span> <span class="main">∈</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">χ</span> <span class="main">∈</span> dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span>›</span></span> assms<span class="main">[</span><span class="operator">unfolded</span> ltl_prop_entails_abs.rep_eq<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">ultimately</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> 𝔐.𝒮 <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> step_abs <span class="bound">q</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>𝔘.𝒮 <span class="skolem">j</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span>Abs <span class="main">(</span>theG <span class="skolem">χ</span><span class="main">)</span><span class="main">}</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> Y <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">hence</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> the <span class="main">(</span><span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="skolem">χ</span><span class="main">)</span><span class="main">.</span> the <span class="main">(</span><span class="skolem">m<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="skolem">χ</span><span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">)</span> <span class="main">⟶</span> <span class="var">?P</span> <span class="bound">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> the <span class="main">(</span><span class="free">π<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="skolem">χ</span><span class="main">)</span><span class="main">.</span> the <span class="main">(</span><span class="skolem">m<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="skolem">χ</span><span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">)</span> <span class="main">⟶</span> <span class="var">?P</span> <span class="main">(</span>step_abs <span class="bound">q</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="var">?P</span> <span class="main">(</span>Abs <span class="main">(</span>theG <span class="skolem">χ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="bound">q</span><span class="main">}</span> <span class="main">⟹</span> <span class="var">?P</span> <span class="bound">q</span>›</span></span> subsetStep
              <span class="keyword1"><span class="command">unfolding</span></span> m<span class="hidden">⇩</span><sub>𝒜</sub>_def<span class="main">[</span><span class="operator">OF</span> 3<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> m<span class="hidden">⇩</span><sub>𝔘</sub>_def<span class="main">[</span><span class="operator">OF</span> 3<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> 𝔐.𝒮.simps 𝔘.𝒮.simps 1 2 Set.image_Un option.sel <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="skolem">χ</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> the <span class="main">(</span><span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="skolem">χ</span><span class="main">)</span><span class="main">.</span> the <span class="main">(</span><span class="skolem">m<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="skolem">χ</span><span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">)</span> <span class="main">(</span>Rep <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span>
              <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="skolem">χ</span> <span class="main">∧</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">)</span> <span class="main">(</span>theG <span class="skolem">χ</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> the <span class="main">(</span><span class="free">π<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="skolem">χ</span><span class="main">)</span><span class="main">.</span> the <span class="main">(</span><span class="skolem">m<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="skolem">χ</span><span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">)</span> <span class="main">(</span>step <span class="main">(</span>Rep <span class="bound">q</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> 4 <span class="keyword1"><span class="command">using</span></span> eval<span class="hidden">⇩</span><sub>G</sub>_respectfulness<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Rep_Abs_equiv<span class="main">,</span> <span class="operator">unfolded</span> ltl_prop_equiv_def<span class="main">]</span>
              <span class="keyword1"><span class="command">using</span></span> eval<span class="hidden">⇩</span><sub>G</sub>_respectfulness<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Rep_step<span class="main">,</span> <span class="operator">unfolded</span> ltl_prop_equiv_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">χ</span> <span class="main">∈</span> dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">.</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">χ</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> the <span class="main">(</span><span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="bound">χ</span><span class="main">)</span><span class="main">.</span> the <span class="main">(</span><span class="skolem">m<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="bound">χ</span><span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">)</span> <span class="main">(</span>Rep <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="skolem">φ<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">)</span>
            <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">χ</span> <span class="main">∈</span> dom <span class="free">π<span class="hidden">⇩</span><sub>𝔘</sub></span><span class="main">.</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">χ</span> <span class="main">∧</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>dom <span class="free">π<span class="hidden">⇩</span><sub>𝔘</sub></span><span class="main">)</span> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> the <span class="main">(</span><span class="free">π<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="bound">χ</span><span class="main">)</span><span class="main">.</span> the <span class="main">(</span><span class="skolem">m<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="bound">χ</span><span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>dom <span class="free">π<span class="hidden">⇩</span><sub>𝔘</sub></span><span class="main">)</span> <span class="main">(</span>step <span class="main">(</span>Rep <span class="bound">q</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> step <span class="main">(</span>Rep <span class="skolem">φ<span class="hidden">⇩</span><sub>𝔘</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">χ</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span>the <span class="main">(</span><span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="bound">χ</span><span class="main">)</span><span class="main">.</span> the <span class="main">(</span><span class="skolem">m<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="bound">χ</span><span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">)</span> <span class="main">(</span>Rep <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">χ</span> <span class="main">∧</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">)</span> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span>the <span class="main">(</span><span class="free">π<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="bound">χ</span><span class="main">)</span><span class="main">.</span> the <span class="main">(</span><span class="skolem">m<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="bound">χ</span><span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">)</span> <span class="main">(</span>step <span class="main">(</span>Rep <span class="bound">q</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span> A assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">S</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">χ</span> <span class="main">∈</span> dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">.</span> <span class="bound">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">χ</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> the <span class="main">(</span><span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="bound">χ</span><span class="main">)</span><span class="main">.</span> the <span class="main">(</span><span class="skolem">m<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="bound">χ</span><span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>dom <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">)</span> <span class="main">(</span>Rep <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Rep <span class="skolem">φ<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">)</span> <span class="main">⟷</span> 
        <span class="main">(</span><span class="main">∀</span><span class="bound">S</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">χ</span> <span class="main">∈</span> dom <span class="free">π<span class="hidden">⇩</span><sub>𝔘</sub></span><span class="main">.</span> <span class="bound">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">χ</span> <span class="main">∧</span> <span class="bound">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>dom <span class="free">π<span class="hidden">⇩</span><sub>𝔘</sub></span><span class="main">)</span> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> the <span class="main">(</span><span class="free">π<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="bound">χ</span><span class="main">)</span><span class="main">.</span> the <span class="main">(</span><span class="skolem">m<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="bound">χ</span><span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> eval<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>dom <span class="free">π<span class="hidden">⇩</span><sub>𝔘</sub></span><span class="main">)</span> <span class="main">(</span>step <span class="main">(</span>Rep <span class="bound">q</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="bound">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> step <span class="main">(</span>Rep <span class="skolem">φ<span class="hidden">⇩</span><sub>𝔘</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">φ<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">,</span> <span class="skolem">m<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">)</span><span class="main">,</span> <span class="free">w</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> M_fin <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="skolem">φ<span class="hidden">⇩</span><sub>𝔘</sub></span><span class="main">,</span> <span class="skolem">m<span class="hidden">⇩</span><sub>𝔘</sub></span><span class="main">)</span><span class="main">,</span> <span class="free">w</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> M<span class="hidden">⇩</span><sub>𝔘</sub>_fin <span class="free">π<span class="hidden">⇩</span><sub>𝔘</sub></span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> M_fin.simps M<span class="hidden">⇩</span><sub>𝔘</sub>_fin.simps ltl_prop_entails_abs.abs_eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> eval<span class="hidden">⇩</span><sub>G</sub>_abs.abs_eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> ltl<span class="hidden">⇩</span><sub>P</sub>_abs_rep step_abs.abs_eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span> <span class="skolem">j</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> r<span class="hidden">⇩</span><sub>𝒜</sub>_def' r<span class="hidden">⇩</span><sub>𝔘</sub>_def' <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">r<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> M_fin <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">⟷</span> <span class="skolem">r<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="skolem">i</span> <span class="main">+</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> M<span class="hidden">⇩</span><sub>𝔘</sub>_fin <span class="free">π<span class="hidden">⇩</span><sub>𝔘</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"range <span class="main">(</span>suffix <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">r<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">)</span> <span class="main">∩</span> M_fin <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> range <span class="main">(</span>suffix <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">r<span class="hidden">⇩</span><sub>𝔘</sub></span><span class="main">)</span> <span class="main">∩</span> M<span class="hidden">⇩</span><sub>𝔘</sub>_fin <span class="free">π<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> suffix_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"limit <span class="skolem">r<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">∩</span> M_fin <span class="free">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> limit <span class="skolem">r<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">∩</span> M<span class="hidden">⇩</span><sub>𝔘</sub>_fin <span class="free">π<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"limit <span class="skolem">r<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">∩</span> UNIV <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"limit <span class="skolem">r<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">∩</span> UNIV <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> limit_nonempty <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>range <span class="skolem">r<span class="hidden">⇩</span><sub>𝔘</sub></span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">(</span>range <span class="skolem">r<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> accepting_pair<span class="hidden">⇩</span><sub>R</sub>_def fst_conv snd_conv r<span class="hidden">⇩</span><sub>𝒜</sub>_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> r<span class="hidden">⇩</span><sub>𝔘</sub>_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> ltl_to_generalized_rabin_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span> <span class="main">⟷</span> accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>𝒜<span class="hidden">⇩</span><sub>𝔘</sub> <span class="free">Σ</span> <span class="free">φ</span><span class="main">)</span> <span class="free">w</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold</span> ltl_to_generalized_rabin_af_correct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_Σ bounded_w<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">standard</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>ltl_to_generalized_rabin_af <span class="free">Σ</span> <span class="free">φ</span><span class="main">)</span> <span class="free">w</span>"</span></span>

  <span class="keyword1"><span class="command">interpret</span></span> 𝒜<span class="main">:</span> ltl_to_rabin_af <span class="quoted"><span class="free">Σ</span></span> <span class="quoted"><span class="free">w</span></span>
    <span class="keyword1"><span class="command">using</span></span> ltl_to_generalized_rabin_af_wellformed bounded_w finite_Σ <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π</span></span> <span class="keyword2"><span class="keyword">where</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">π</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> II<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π</span> <span class="main">⟹</span> the <span class="main">(</span><span class="skolem">π</span> <span class="bound">χ</span><span class="main">)</span> <span class="main">&lt;</span> 𝒜.max_rank_of <span class="free">Σ</span> <span class="bound">χ</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> III<span class="main">:</span> <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>ltl_to_rabin_af.δ<span class="hidden">⇩</span><sub>𝒜</sub> <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>ltl_to_rabin_af.ι<span class="hidden">⇩</span><sub>𝒜</sub> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>M_fin <span class="skolem">π</span><span class="main">,</span> UNIV<span class="main">)</span> <span class="free">w</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> IV<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π</span> <span class="main">⟹</span> accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>𝒜.δ<span class="hidden">⇩</span><sub>𝒜</sub> <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>ltl_to_rabin_af.ι<span class="hidden">⇩</span><sub>𝒜</sub> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>𝒜.Acc <span class="free">Σ</span> <span class="skolem">π</span> <span class="bound">χ</span><span class="main">)</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> ltl_to_generalized_rabin_af.simps<span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> 𝒜.accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_I<span class="main">)</span>
 
    <span class="comment1">― ‹Normalise <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">π</span><span class="antiquote">}</span></span> to the smallest accepting ranks›</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">π</span> <span class="main">=</span> dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">⟹</span> <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="bound">χ</span> <span class="main">=</span> mojmir_def.smallest_accepting_rank <span class="free">Σ</span> <span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span>Abs <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">q</span><span class="main">}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>𝒜.δ<span class="hidden">⇩</span><sub>𝒜</sub> <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>𝒜.ι<span class="hidden">⇩</span><sub>𝒜</sub> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>M_fin <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">,</span> UNIV<span class="main">)</span> <span class="free">w</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">⟹</span> accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>𝒜.δ<span class="hidden">⇩</span><sub>𝒜</sub> <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>𝒜.ι<span class="hidden">⇩</span><sub>𝒜</sub> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>𝒜.Acc <span class="free">Σ</span> <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="bound">χ</span><span class="main">)</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 𝒜.normalize_π <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
    <span class="comment1">― ‹Properties about the domain of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">π</span><span class="antiquote">}</span></span>›</span>
    <span class="keyword1"><span class="command">note</span></span> 𝒢_properties<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted"><span class="quoted">‹dom <span class="skolem"><span class="skolem">π</span></span> <span class="main"><span class="main">⊆</span></span> <span class="keyword1"><span class="keyword1"><span class="hidden">❙</span><b>G</b></span></span> <span class="free"><span class="free">φ</span></span>›</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">hence</span></span> 𝔐_Accept<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π</span> <span class="main">⟹</span> mojmir_def.accept af_G_letter_abs <span class="main">(</span>Abs <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> dom <span class="skolem">π</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">q</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> I II IV 𝒜.Acc_to_mojmir_accept <span class="keyword1"><span class="command">unfolding</span></span> ltl_to_rabin_base_def.max_rank_of_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ltl.sel<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">hence</span></span> 𝔘_Accept<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π</span> <span class="main">⟹</span> mojmir_def.accept af_G_letter_abs_opt <span class="main">(</span>Abs <span class="main">(</span>Unf<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> dom <span class="skolem">π</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">q</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> unfold_accept_eq<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Only_G <span class="main">(</span>dom <span class="skolem">π</span><span class="main">)</span>›</span></span> finite_Σ bounded_w<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> ltl_prop_entails_abs.rep_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
    <span class="comment1">― ‹Define <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">π</span><span class="antiquote">}</span></span> for the other automaton›</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">π<span class="hidden">⇩</span><sub>𝔘</sub></span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="skolem">χ</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">χ</span> <span class="main">∈</span> dom <span class="skolem">π</span> <span class="keyword1">then</span> mojmir_def.smallest_accepting_rank <span class="free">Σ</span> af_G_letter_abs_opt <span class="main">(</span>Abs <span class="main">(</span>Unf<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>theG <span class="skolem">χ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> dom <span class="skolem">π</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">q</span><span class="main">}</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">χ</span>
    
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">=</span> dom <span class="skolem">π</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 𝔘_Accept <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> π<span class="hidden">⇩</span><sub>𝔘</sub>_def dom_def mojmir_def.smallest_accepting_rank_def<span class="main">)</span>   
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">=</span> dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> A <span class="quoted"><span class="quoted">‹dom <span class="skolem">π</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">⟹</span> <span class="skolem">π<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="bound">χ</span> <span class="main">=</span> mojmir_def.smallest_accepting_rank <span class="free">Σ</span> af_G_letter_abs_opt <span class="main">(</span>Abs <span class="main">(</span>Unf<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">q</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">=</span> dom <span class="skolem">π</span>›</span></span> π<span class="hidden">⇩</span><sub>𝔘</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">⟹</span> the <span class="main">(</span><span class="skolem">π<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="bound">χ</span><span class="main">)</span> <span class="main">&lt;</span> semi_mojmir_def.max_rank <span class="free">Σ</span> af_G_letter_abs_opt <span class="main">(</span>Abs <span class="main">(</span>Unf<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> "</span></span>
      <span class="keyword1"><span class="command">using</span></span> wellformed_mojmir_opt<span class="main">[</span><span class="operator">OF</span> 𝒢_elements<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>›</span></span><span class="main"><span class="main">]</span></span> finite_Σ bounded_w<span class="main">,</span> <span class="operator">THEN</span> mojmir.smallest_accepting_rank_properties<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">]</span>
       <span class="keyword1"><span class="command">unfolding</span></span> ltl_prop_entails_abs.rep_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  
    <span class="comment1">― ‹Use correctness of the translation of individual accepting pairs›</span>
    <span class="keyword1"><span class="command">have</span></span> Acc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">⟹</span> accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>δ<span class="hidden">⇩</span><sub>𝔘</sub> <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>ι<span class="hidden">⇩</span><sub>𝔘</sub> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>Acc<span class="hidden">⇩</span><sub>𝔘</sub> <span class="free">Σ</span> <span class="skolem">π<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="bound">χ</span><span class="main">)</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mojmir_accept_to_Acc<span class="main">[</span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>›</span></span><span class="main">]</span> 𝒢_elements<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>›</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">using</span></span> 1 2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="keyword1">G</span> <span class="main">_</span>"</span></span><span class="main">]</span> 3<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="keyword1">G</span> <span class="main">_</span>"</span></span><span class="main">]</span> 𝔘_Accept<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="keyword1">G</span> <span class="main">_</span>"</span></span><span class="main">]</span> ltl.sel<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> comp_apply <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">have</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>δ<span class="hidden">⇩</span><sub>𝔘</sub> <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>ι<span class="hidden">⇩</span><sub>𝔘</sub> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>M<span class="hidden">⇩</span><sub>𝔘</sub>_fin <span class="skolem">π<span class="hidden">⇩</span><sub>𝔘</sub></span><span class="main">,</span> UNIV<span class="main">)</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> unfold_optimisation_correct_M<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>›</span></span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">=</span> dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span>›</span></span> B 2<span class="main">]</span> C
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">=</span> dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Acc 3 <span class="quoted"><span class="quoted">‹dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>›</span></span> combine_rabin_pairs_UNIV<span class="main">[</span><span class="operator">OF</span> M combine_rabin_pairs<span class="main">]</span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_def fst_conv snd_conv ltl_to_generalized_rabin.simps rabin_pairs.simps max_rank_of_def comp_apply<span class="main">)</span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π</span></span> <span class="keyword2"><span class="keyword">where</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">π</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> II<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π</span> <span class="main">⟹</span> the <span class="main">(</span><span class="skolem">π</span> <span class="bound">χ</span><span class="main">)</span> <span class="main">&lt;</span> max_rank_of <span class="free">Σ</span> <span class="bound">χ</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> III<span class="main">:</span> <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>δ<span class="hidden">⇩</span><sub>𝔘</sub> <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>ι<span class="hidden">⇩</span><sub>𝔘</sub> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>M<span class="hidden">⇩</span><sub>𝔘</sub>_fin <span class="skolem">π</span><span class="main">,</span> UNIV<span class="main">)</span> <span class="free">w</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> IV<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π</span> <span class="main">⟹</span> accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>δ<span class="hidden">⇩</span><sub>𝔘</sub> <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>ι<span class="hidden">⇩</span><sub>𝔘</sub> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>Acc<span class="hidden">⇩</span><sub>𝔘</sub> <span class="free">Σ</span> <span class="skolem">π</span> <span class="bound">χ</span><span class="main">)</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_I<span class="main">)</span>
  
    <span class="comment1">― ‹Normalize <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">π</span><span class="antiquote">}</span></span> to the smallest accepting ranks›</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π<span class="hidden">⇩</span><sub>𝔘</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">π</span> <span class="main">=</span> dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝔘</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">⟹</span> <span class="skolem">π<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="bound">χ</span> <span class="main">=</span> mojmir_def.smallest_accepting_rank <span class="free">Σ</span> <span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">(</span>Abs <span class="main">(</span>Unf<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">q</span><span class="main">}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>δ<span class="hidden">⇩</span><sub>𝔘</sub> <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>ι<span class="hidden">⇩</span><sub>𝔘</sub> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>M<span class="hidden">⇩</span><sub>𝔘</sub>_fin <span class="skolem">π<span class="hidden">⇩</span><sub>𝔘</sub></span><span class="main">,</span> UNIV<span class="main">)</span> <span class="free">w</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">⟹</span> accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>δ<span class="hidden">⇩</span><sub>𝔘</sub> <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>ι<span class="hidden">⇩</span><sub>𝔘</sub> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>Acc<span class="hidden">⇩</span><sub>𝔘</sub> <span class="free">Σ</span> <span class="skolem">π<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="bound">χ</span><span class="main">)</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> normalize_π <span class="keyword1"><span class="command">unfolding</span></span> comp_apply <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
    <span class="comment1">― ‹Properties about the domain of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">π</span><span class="antiquote">}</span></span>›</span>
    <span class="keyword1"><span class="command">note</span></span> 𝒢_properties<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted"><span class="quoted">‹dom <span class="skolem"><span class="skolem">π</span></span> <span class="main"><span class="main">⊆</span></span> <span class="keyword1"><span class="keyword1"><span class="hidden">❙</span><b>G</b></span></span> <span class="free"><span class="free">φ</span></span>›</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">hence</span></span> 𝔘_Accept<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π</span> <span class="main">⟹</span> mojmir_def.accept af_G_letter_abs_opt <span class="main">(</span>Abs <span class="main">(</span>Unf<span class="hidden">⇩</span><sub>G</sub> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> dom <span class="skolem">π</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">q</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> I II IV Acc_to_mojmir_accept <span class="keyword1"><span class="command">unfolding</span></span> max_rank_of_def comp_apply <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ltl.sel<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">hence</span></span> 𝔐_Accept<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π</span> <span class="main">⟹</span> mojmir_def.accept af_G_letter_abs <span class="main">(</span>Abs <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> dom <span class="skolem">π</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">q</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> unfold_accept_eq<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Only_G <span class="main">(</span>dom <span class="skolem">π</span><span class="main">)</span>›</span></span> finite_Σ bounded_w<span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> ltl_prop_entails_abs.rep_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
    <span class="comment1">― ‹Define <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">π</span><span class="antiquote">}</span></span> for the other automaton›</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="skolem">χ</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">χ</span> <span class="main">∈</span> dom <span class="skolem">π</span> <span class="keyword1">then</span> mojmir_def.smallest_accepting_rank <span class="free">Σ</span> <span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span>Abs <span class="main">(</span>theG <span class="skolem">χ</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> dom <span class="skolem">π</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">q</span><span class="main">}</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">χ</span>
    
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">=</span> dom <span class="skolem">π</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 𝔐_Accept <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> π<span class="hidden">⇩</span><sub>𝒜</sub>_def dom_def mojmir_def.smallest_accepting_rank_def<span class="main">)</span>   
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">=</span> dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> A <span class="quoted"><span class="quoted">‹dom <span class="skolem">π</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ltl_FG_to_rabin <span class="free">Σ</span> <span class="main">(</span>dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">)</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">insert</span> 𝒢_elements<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>›</span></span><span class="main"><span class="main">]</span></span> finite_Σ bounded_w<span class="main">)</span> 
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">⟹</span> <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="bound">χ</span> <span class="main">=</span> mojmir_def.smallest_accepting_rank <span class="free">Σ</span> <span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span>Abs <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">q</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">=</span> dom <span class="skolem">π</span>›</span></span> π<span class="hidden">⇩</span><sub>𝒜</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">⟹</span> the <span class="main">(</span><span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="bound">χ</span><span class="main">)</span> <span class="main">&lt;</span> semi_mojmir_def.max_rank <span class="free">Σ</span> <span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span>Abs <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ltl_FG_to_rabin.smallest_accepting_rank_properties<span class="main">(</span>6<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹ltl_FG_to_rabin <span class="free">Σ</span> <span class="main">(</span>dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">)</span> <span class="free">w</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> ltl_prop_entails_abs.rep_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  
    <span class="comment1">― ‹Use correctness of the translation of individual accepting pairs›</span>
    <span class="keyword1"><span class="command">have</span></span> Acc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">⟹</span> accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>𝒜.δ<span class="hidden">⇩</span><sub>𝒜</sub> <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>𝒜.ι<span class="hidden">⇩</span><sub>𝒜</sub> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>𝒜.Acc <span class="free">Σ</span> <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="bound">χ</span><span class="main">)</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 𝒜.mojmir_accept_to_Acc<span class="main">[</span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>›</span></span><span class="main">]</span> 𝒢_elements<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>›</span></span><span class="main">]</span> 
      <span class="keyword1"><span class="command">using</span></span> 1 2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="keyword1">G</span> <span class="main">_</span>"</span></span><span class="main">]</span> 3<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="keyword1">G</span> <span class="main">_</span>"</span></span><span class="main">]</span> 𝔐_Accept<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="keyword1">G</span> <span class="main">_</span>"</span></span><span class="main">]</span> ltl.sel<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span> 
    <span class="keyword1"><span class="command">have</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>𝒜.δ<span class="hidden">⇩</span><sub>𝒜</sub> <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>𝒜.ι<span class="hidden">⇩</span><sub>𝒜</sub> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>M_fin <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span><span class="main">,</span> UNIV<span class="main">)</span> <span class="free">w</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> unfold_optimisation_correct_M<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>›</span></span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">=</span> dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span>›</span></span> 2 B<span class="main">]</span> C
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">=</span> dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Acc 3 <span class="quoted"><span class="quoted">‹dom <span class="skolem">π<span class="hidden">⇩</span><sub>𝒜</sub></span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>›</span></span> combine_rabin_pairs_UNIV<span class="main">[</span><span class="operator">OF</span> M combine_rabin_pairs<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_def fst_conv snd_conv 𝒜.ltl_to_generalized_rabin.simps 𝒜.rabin_pairs.simps
                     ltl_to_generalized_rabin_af.simps  𝒜.max_rank_of_def comp_apply<span class="main">)</span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ltl_to_generalized_rabin_af<span class="hidden">⇩</span><sub>𝔘</sub></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ltl_to_generalized_rabin_af<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> ltl_to_rabin_base_def.ltl_to_generalized_rabin <span class="keyword1">↑af<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">(</span>Abs <span class="main">∘</span> Unf<span class="main">)</span> <span class="main">(</span>Abs <span class="main">∘</span> Unf<span class="hidden">⇩</span><sub>G</sub><span class="main">)</span> M<span class="hidden">⇩</span><sub>𝔘</sub>_fin <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>  

<span class="keyword1" id="LTL_Rabin_Unfold_Opt-ltl_to_generalized_rabin_af"><span class="command">lemma</span></span> ltl_to_generalized_rabin_af<span class="hidden">⇩</span><sub>𝔘</sub>_wellformed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="free">Σ</span> <span class="main">⟹</span> range <span class="free">w</span> <span class="main">⊆</span> <span class="free">Σ</span> <span class="main">⟹</span> ltl_to_rabin_af_unf <span class="free">Σ</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> af_G_letter_opt_sat_core_lifted ltl_prop_entails_abs.rep_eq <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_reach_af_opt finite_reach_af_G_opt<span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> le_trans ltl_semi_mojmir<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> semi_mojmir_def<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">theorem</span></span> ltl_to_generalized_rabin_af<span class="hidden">⇩</span><sub>𝔘</sub>_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"range <span class="free">w</span> <span class="main">⊆</span> <span class="free">Σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span> <span class="main">=</span> accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>ltl_to_generalized_rabin_af<span class="hidden">⇩</span><sub>𝔘</sub> <span class="free">Σ</span> <span class="free">φ</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ltl_to_generalized_rabin_af<span class="hidden">⇩</span><sub>𝔘</sub>_wellformed<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">THEN</span> ltl_to_rabin_af_unf.ltl_to_generalized_rabin_correct<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">thm</span></span> ltl_FG_to_generalized_rabin_correct ltl_to_generalized_rabin_af_correct ltl_to_generalized_rabin_af<span class="hidden">⇩</span><sub>𝔘</sub>_correct

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="LTL_Compat">
<div class="head">
<h1>Theory LTL_Compat</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Author:      Salomon Sickert
    License:     BSD
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹LTL Translation Layer›</span></span>

<span class="keyword1"><span class="command">theory</span></span> LTL_Compat
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <a href="../LTL/LTL.html">LTL.LTL</a> <span class="quoted">"<a href="LTL_FGXU.html">../LTL_FGXU</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">― ‹The following infrastructure translates the generic <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">datatype</span> ltln<span class="antiquote">}</span></span> datatype to special structure used in this project›</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">LTLRelease</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl <span class="main">⇒</span> <span class="tfree">'a</span> ltl <span class="main">⇒</span> <span class="tfree">'a</span> ltl"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">R</span> _"</span> <span class="main">[</span>87<span class="main">,</span>87<span class="main">]</span> 86<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1"><span class="free">R</span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="keyword1">or</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="keyword1">U</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">and</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">LTLWeakUntil</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl <span class="main">⇒</span> <span class="tfree">'a</span> ltl <span class="main">⇒</span> <span class="tfree">'a</span> ltl"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">W</span> _"</span> <span class="main">[</span>87<span class="main">,</span>87<span class="main">]</span> 86<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1"><span class="free">W</span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">U</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="keyword1">or</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">LTLStrongRelease</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl <span class="main">⇒</span> <span class="tfree">'a</span> ltl <span class="main">⇒</span> <span class="tfree">'a</span> ltl"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">M</span> _"</span> <span class="main">[</span>87<span class="main">,</span>87<span class="main">]</span> 86<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1"><span class="free">M</span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="keyword1">U</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">and</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ltln_to_ltl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltln <span class="main">⇒</span> <span class="tfree">'a</span> ltl"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ltln_to_ltl</span> <span class="keyword1">true<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">=</span> <span class="keyword1">true</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltln_to_ltl</span> <span class="keyword1">false<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">=</span> <span class="keyword1">false</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltln_to_ltl</span> <span class="keyword1">prop<span class="hidden">⇩</span><sub>n</sub>(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">p(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltln_to_ltl</span> <span class="keyword1">nprop<span class="hidden">⇩</span><sub>n</sub>(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">np(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltln_to_ltl</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">and<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">ltln_to_ltl</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">and</span> <span class="free">ltln_to_ltl</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltln_to_ltl</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">or<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">ltln_to_ltl</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">or</span> <span class="free">ltln_to_ltl</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltln_to_ltl</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">U<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="keyword1">true<span class="hidden">⇩</span><sub>n</sub></span> <span class="keyword1">then</span> <span class="keyword1">F</span> <span class="main">(</span><span class="free">ltln_to_ltl</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free">ltln_to_ltl</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="keyword1">U</span> <span class="main">(</span><span class="free">ltln_to_ltl</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltln_to_ltl</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">R<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="keyword1">false<span class="hidden">⇩</span><sub>n</sub></span> <span class="keyword1">then</span> <span class="keyword1">G</span> <span class="main">(</span><span class="free">ltln_to_ltl</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free">ltln_to_ltl</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="keyword1">R</span> <span class="main">(</span><span class="free">ltln_to_ltl</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltln_to_ltl</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">W<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">=</span> <span class="keyword1">false<span class="hidden">⇩</span><sub>n</sub></span> <span class="keyword1">then</span> <span class="keyword1">G</span> <span class="main">(</span><span class="free">ltln_to_ltl</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free">ltln_to_ltl</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="keyword1">W</span> <span class="main">(</span><span class="free">ltln_to_ltl</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltln_to_ltl</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">M<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">=</span> <span class="keyword1">true<span class="hidden">⇩</span><sub>n</sub></span> <span class="keyword1">then</span> <span class="keyword1">F</span> <span class="main">(</span><span class="free">ltln_to_ltl</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free">ltln_to_ltl</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="keyword1">M</span> <span class="main">(</span><span class="free">ltln_to_ltl</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ltln_to_ltl</span> <span class="main">(</span><span class="keyword1">X<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">X</span> <span class="main">(</span><span class="free">ltln_to_ltl</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="LTL_Compat-ltln_to_ltl_semantics"><span class="command">lemma</span></span> ltln_to_ltl_semantics<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⊨</span> ltln_to_ltl <span class="free">φ</span> <span class="main">⟷</span> <span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> semantics_ltln.simps<span class="main"><span class="main">(</span></span>9-11<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> ltln_Release_alterdef ltln_weak_strong<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ltl_StrongRelease_Until_con<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> nat_less_le<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="LTL_Compat-ltln_to_ltl_atoms"><span class="command">lemma</span></span> ltln_to_ltl_atoms<span class="main">:</span>
  <span class="quoted"><span class="quoted">"vars <span class="main">(</span>ltln_to_ltl <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> atoms_ltln <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">atoms_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltln <span class="main">⇒</span><span class="tfree">'a</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">atoms_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">and<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> List.union <span class="main">(</span><span class="free">atoms_list</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">atoms_list</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">atoms_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">or<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> List.union <span class="main">(</span><span class="free">atoms_list</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">atoms_list</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">atoms_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">U<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> List.union <span class="main">(</span><span class="free">atoms_list</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">atoms_list</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">atoms_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">R<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> List.union <span class="main">(</span><span class="free">atoms_list</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">atoms_list</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">atoms_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">W<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> List.union <span class="main">(</span><span class="free">atoms_list</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">atoms_list</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">atoms_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">M<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> List.union <span class="main">(</span><span class="free">atoms_list</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">atoms_list</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">atoms_list</span> <span class="main">(</span><span class="keyword1">X<span class="hidden">⇩</span><sub>n</sub></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">atoms_list</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">atoms_list</span> <span class="main">(</span><span class="keyword1">prop<span class="hidden">⇩</span><sub>n</sub>(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">atoms_list</span> <span class="main">(</span><span class="keyword1">nprop<span class="hidden">⇩</span><sub>n</sub>(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">atoms_list</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>

<span class="keyword1" id="LTL_Compat-atoms_list_correct"><span class="command">lemma</span></span> atoms_list_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>atoms_list <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> atoms_ltln <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="LTL_Compat-atoms_list_distinct"><span class="command">lemma</span></span> atoms_list_distinct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>atoms_list <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="LTL_Impl">
<div class="head">
<h1>Theory LTL_Impl</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Author:      Salomon Sickert
    License:     BSD
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹LTL Code Equations›</span></span>

<span class="keyword1"><span class="command">theory</span></span> LTL_Impl
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> 
    <span class="quoted">"<a href="LTL_FGXU.html">../LTL_FGXU</a>"</span> 
    <a href="../Boolean_Expression_Checkers/Boolean_Expression_Checkers.html">Boolean_Expression_Checkers.Boolean_Expression_Checkers</a> 
    <a href="../Boolean_Expression_Checkers/Boolean_Expression_Checkers_AList_Mapping.html">Boolean_Expression_Checkers.Boolean_Expression_Checkers_AList_Mapping</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Subformulae›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">G_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl <span class="main">⇒</span><span class="tfree">'a</span> ltl list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">G_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">and</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> List.union <span class="main">(</span><span class="free">G_list</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">G_list</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">G_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">or</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> List.union <span class="main">(</span><span class="free">G_list</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">G_list</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">G_list</span> <span class="main">(</span><span class="keyword1">F</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">G_list</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">G_list</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> List.insert <span class="main">(</span><span class="keyword1">G</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">G_list</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">G_list</span> <span class="main">(</span><span class="keyword1">X</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">G_list</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">G_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">U</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> List.union <span class="main">(</span><span class="free">G_list</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">G_list</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">G_list</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>

<span class="keyword1" id="LTL_Impl-G_eq_G_list"><span class="command">lemma</span></span> G_eq_G_list<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span> <span class="main">=</span> set <span class="main">(</span>G_list <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="LTL_Impl-G_list_distinct"><span class="command">lemma</span></span> G_list_distinct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>G_list <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Propositional Equivalence›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ifex_of_ltl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl <span class="main">⇒</span> <span class="tfree">'a</span> ltl ifex"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ifex_of_ltl</span> <span class="keyword1">true</span> <span class="main">=</span> Trueif"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ifex_of_ltl</span> <span class="keyword1">false</span> <span class="main">=</span> Falseif"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ifex_of_ltl</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">and</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> normif Mapping.empty <span class="main">(</span><span class="free">ifex_of_ltl</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">ifex_of_ltl</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> Falseif"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ifex_of_ltl</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">or</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> normif Mapping.empty <span class="main">(</span><span class="free">ifex_of_ltl</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> Trueif <span class="main">(</span><span class="free">ifex_of_ltl</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ifex_of_ltl</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> IF <span class="free"><span class="bound"><span class="entity">φ</span></span></span> Trueif Falseif"</span></span>

<span class="keyword1" id="LTL_Impl-val_ifex"><span class="command">lemma</span></span> val_ifex<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"val_ifex <span class="main">(</span>ifex_of_ltl <span class="free">b</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="keyword1">(⊨<span class="hidden">⇩</span><sub>P</sub>)</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">s</span> <span class="bound">x</span><span class="main">}</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> agree_Nil val_normif<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="LTL_Impl-reduced_ifex"><span class="command">lemma</span></span> reduced_ifex<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"reduced <span class="main">(</span>ifex_of_ltl <span class="free">b</span><span class="main">)</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">metis</span> keys_empty reduced_normif<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="LTL_Impl-ifex_of_ltl_reduced_bdt_checker"><span class="command">lemma</span></span> ifex_of_ltl_reduced_bdt_checker<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"reduced_bdt_checkers ifex_of_ltl <span class="main">(</span><span class="main">λ</span><span class="bound">y</span> <span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">s</span> <span class="bound">x</span><span class="main">}</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> reduced_bdt_checkers_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">insert</span> val_ifex reduced_ifex<span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">φ</span> <span class="keyword1">≡<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> equiv_test ifex_of_ltl <span class="free">φ</span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ltl_prop_equiv_def reduced_bdt_checkers.equiv_test<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ifex_of_ltl_reduced_bdt_checker<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span><span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">φ</span> <span class="keyword1">⟶<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> impl_test ifex_of_ltl <span class="free">φ</span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ltl_prop_implies_def reduced_bdt_checkers.impl_test<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ifex_of_ltl_reduced_bdt_checker<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">force</span><span class="main">)</span>

<span class="comment1">― ‹Check Code Export›</span> 
<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1">(≡<span class="hidden">⇩</span><sub>P</sub>)</span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1">(⟶<span class="hidden">⇩</span><sub>P</sub>)</span>"</span></span></span> <span class="keyword2"><span class="keyword">checking</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Remove Constants›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">remove_constants<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl <span class="main">⇒</span> <span class="tfree">'a</span> ltl"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">remove_constants<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">and</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">case</span> <span class="main">(</span><span class="free">remove_constants<span class="hidden">⇩</span><sub>P</sub></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
        <span class="keyword1">false</span> <span class="main">⇒</span> <span class="keyword1">false</span>
      <span class="main">|</span> <span class="keyword1">true</span> <span class="main">⇒</span> <span class="free">remove_constants<span class="hidden">⇩</span><sub>P</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>
      <span class="main">|</span> <span class="bound">φ'</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">remove_constants<span class="hidden">⇩</span><sub>P</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="keyword1">of</span> 
          <span class="keyword1">false</span> <span class="main">⇒</span> <span class="keyword1">false</span> 
        <span class="main">|</span> <span class="keyword1">true</span> <span class="main">⇒</span> <span class="bound">φ'</span> 
        <span class="main">|</span> <span class="bound">ψ'</span> <span class="main">⇒</span> <span class="bound">φ'</span> <span class="keyword1">and</span> <span class="bound">ψ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">remove_constants<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">or</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">case</span> <span class="main">(</span><span class="free">remove_constants<span class="hidden">⇩</span><sub>P</sub></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
        <span class="keyword1">true</span> <span class="main">⇒</span> <span class="keyword1">true</span>
      <span class="main">|</span> <span class="keyword1">false</span> <span class="main">⇒</span> <span class="free">remove_constants<span class="hidden">⇩</span><sub>P</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>
      <span class="main">|</span> <span class="bound">φ'</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">remove_constants<span class="hidden">⇩</span><sub>P</sub></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="keyword1">of</span> 
          <span class="keyword1">true</span> <span class="main">⇒</span> <span class="keyword1">true</span> 
        <span class="main">|</span> <span class="keyword1">false</span> <span class="main">⇒</span> <span class="bound">φ'</span> 
        <span class="main">|</span> <span class="bound">ψ'</span> <span class="main">⇒</span> <span class="bound">φ'</span> <span class="keyword1">or</span> <span class="bound">ψ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">remove_constants<span class="hidden">⇩</span><sub>P</sub></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>

<span class="keyword1" id="LTL_Impl-remove_constants_correct"><span class="command">lemma</span></span> remove_constants_correct<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">φ</span> <span class="main">⟷</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> remove_constants<span class="hidden">⇩</span><sub>P</sub> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">S</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> ltl.split<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹And/Or Constructors›</span></span>  

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">in_and</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">in_and</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">and</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">in_and</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∨</span> <span class="free">in_and</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">in_and</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">in_or</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">in_or</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">or</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">in_or</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∨</span> <span class="free">in_or</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">in_or</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>
 
<span class="keyword1" id="LTL_Impl-in_entailment"><span class="command">lemma</span></span> in_entailment<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"in_and <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">x</span>"</span></span>
  <span class="quoted"><span class="quoted">"in_or <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mk_and</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mk_and</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> <span class="keyword1">false</span> <span class="main">⇒</span> <span class="keyword1">false</span> <span class="main">|</span> <span class="keyword1">true</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> 
    <span class="main">|</span> <span class="bound">x'</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">of</span> <span class="keyword1">false</span> <span class="main">⇒</span> <span class="keyword1">false</span> <span class="main">|</span> <span class="keyword1">true</span> <span class="main">⇒</span> <span class="bound">x'</span> 
    <span class="main">|</span> <span class="bound">y'</span> <span class="main">⇒</span> <span class="keyword1">if</span> in_and <span class="bound">x'</span> <span class="bound">y'</span> <span class="keyword1">then</span> <span class="bound">y'</span> <span class="keyword1">else</span> <span class="keyword1">if</span> in_and <span class="bound">y'</span> <span class="bound">x'</span> <span class="keyword1">then</span> <span class="bound">x'</span> <span class="keyword1">else</span> <span class="bound">x'</span> <span class="keyword1">and</span> <span class="bound">y'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mk_and'</span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mk_and'</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">of</span> <span class="keyword1">false</span> <span class="main">⇒</span> <span class="keyword1">false</span> <span class="main">|</span> <span class="keyword1">true</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">and</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mk_or</span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mk_or</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> <span class="keyword1">true</span> <span class="main">⇒</span> <span class="keyword1">true</span> <span class="main">|</span> <span class="keyword1">false</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> 
    <span class="main">|</span> <span class="bound">x'</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">of</span> <span class="keyword1">true</span> <span class="main">⇒</span> <span class="keyword1">true</span> <span class="main">|</span> <span class="keyword1">false</span> <span class="main">⇒</span> <span class="bound">x'</span> 
    <span class="main">|</span> <span class="bound">y'</span> <span class="main">⇒</span> <span class="keyword1">if</span> in_or <span class="bound">x'</span> <span class="bound">y'</span> <span class="keyword1">then</span> <span class="bound">y'</span> <span class="keyword1">else</span> <span class="keyword1">if</span> in_or <span class="bound">y'</span> <span class="bound">x'</span> <span class="keyword1">then</span> <span class="bound">x'</span> <span class="keyword1">else</span> <span class="bound">x'</span> <span class="keyword1">or</span> <span class="bound">y'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mk_or'</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mk_or'</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">of</span> <span class="keyword1">true</span> <span class="main">⇒</span> <span class="keyword1">true</span> <span class="main">|</span> <span class="keyword1">false</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">or</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1" id="LTL_Impl-mk_and_correct"><span class="command">lemma</span></span> mk_and_correct<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> mk_and <span class="free">f</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">f</span> <span class="free">x</span> <span class="keyword1">and</span> <span class="free">f</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x'</span> <span class="bound">y'</span><span class="main">.</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">(</span><span class="keyword1">if</span> in_and <span class="bound">x'</span> <span class="bound">y'</span> <span class="keyword1">then</span> <span class="bound">y'</span> <span class="keyword1">else</span> <span class="keyword1">if</span> in_and <span class="bound">y'</span> <span class="bound">x'</span> <span class="keyword1">then</span> <span class="bound">x'</span> <span class="keyword1">else</span> <span class="bound">x'</span> <span class="keyword1">and</span> <span class="bound">y'</span><span class="main">)</span>
    <span class="main">⟷</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">x'</span> <span class="keyword1">and</span> <span class="bound">y'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> in_entailment <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mk_and_def ltl.split X <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">y</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LTL_Impl-mk_and'_correct"><span class="command">lemma</span></span> mk_and'_correct<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> mk_and' <span class="free">x</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">x</span> <span class="keyword1">and</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mk_and'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">y</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span> 

<span class="keyword1" id="LTL_Impl-mk_or_correct"><span class="command">lemma</span></span> mk_or_correct<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> mk_or <span class="free">f</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">f</span> <span class="free">x</span> <span class="keyword1">or</span> <span class="free">f</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x'</span> <span class="bound">y'</span><span class="main">.</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">(</span><span class="keyword1">if</span> in_or <span class="bound">x'</span> <span class="bound">y'</span> <span class="keyword1">then</span> <span class="bound">y'</span> <span class="keyword1">else</span> <span class="keyword1">if</span> in_or <span class="bound">y'</span> <span class="bound">x'</span> <span class="keyword1">then</span> <span class="bound">x'</span> <span class="keyword1">else</span> <span class="bound">x'</span> <span class="keyword1">or</span> <span class="bound">y'</span><span class="main">)</span>
    <span class="main">⟷</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">x'</span> <span class="keyword1">or</span> <span class="bound">y'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> in_entailment <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mk_or_def ltl.split X <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">y</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LTL_Impl-mk_or'_correct"><span class="command">lemma</span></span> mk_or'_correct<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> mk_or' <span class="free">x</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">x</span> <span class="keyword1">or</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mk_or'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">y</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span> 

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="af_Impl">
<div class="head">
<h1>Theory af_Impl</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Author:      Salomon Sickert
    License:     BSD
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹af - Unfolding Functions - Optimized Code Equations›</span></span>

<span class="keyword1"><span class="command">theory</span></span> af_Impl
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <span class="quoted">"<a href="af.html">../af</a>"</span> <a href="LTL_Impl.html">LTL_Impl</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Provide optimized code definitions for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">↑af</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and other functions, which use heuristics to reduce the formula size›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Helper Function›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">remove_and_or</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">remove_and_or</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="keyword1">or</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="keyword1">of</span> 
      <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="bound">z'</span> <span class="keyword1">and</span> <span class="bound">x'</span><span class="main">)</span> <span class="keyword1">or</span> <span class="bound">y'</span><span class="main">)</span> <span class="keyword1">and</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">x'</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="bound">y'</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">(</span><span class="bound">z'</span> <span class="keyword1">and</span> <span class="bound">x'</span><span class="main">)</span> <span class="keyword1">or</span> <span class="bound">y'</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">remove_and_or</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="keyword1">or</span> <span class="free">remove_and_or</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> 
     <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free">remove_and_or</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="keyword1">or</span> <span class="free">remove_and_or</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">remove_and_or</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">and</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">remove_and_or</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">and</span> <span class="free">remove_and_or</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">remove_and_or</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1" id="af_Impl-remove_and_or_correct"><span class="command">lemma</span></span> remove_and_or_correct<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> remove_and_or <span class="free">x</span> <span class="main">⟷</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LTLOr <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> 
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LTLAnd <span class="skolem">x'</span> <span class="skolem">y'</span><span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">x'</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LTLOr <span class="skolem">x''</span> <span class="skolem">y''</span><span class="main">)</span>
              <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">x''</span></span><span class="main">)</span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Optimized Equations›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">af_letter_simp</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">af_letter_simp</span> <span class="keyword1">true</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="keyword1">true</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_letter_simp</span> <span class="keyword1">false</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="keyword1">false</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_letter_simp</span> <span class="keyword1">p(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">then</span> <span class="keyword1">true</span> <span class="keyword1">else</span> <span class="keyword1">false</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_letter_simp</span> <span class="main">(</span><span class="keyword1">np(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span>  <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">then</span> <span class="keyword1">true</span> <span class="keyword1">else</span> <span class="keyword1">false</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_letter_simp</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">and</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">of</span>
      <span class="keyword1">true</span> <span class="main">⇒</span> <span class="free">af_letter_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span>
    <span class="main">|</span> <span class="keyword1">false</span> <span class="main">⇒</span> <span class="keyword1">false</span>
    <span class="main">|</span> <span class="keyword1">p(</span><span class="bound">a</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">then</span> <span class="free">af_letter_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">else</span> <span class="keyword1">false</span>
    <span class="main">|</span> <span class="keyword1">np(</span><span class="bound">a</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">then</span> <span class="free">af_letter_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">else</span> <span class="keyword1">false</span>
    <span class="main">|</span> <span class="keyword1">G</span> <span class="bound">φ'</span> <span class="main">⇒</span>  
      <span class="main">(</span><span class="keyword1">let</span> 
        <span class="bound">φ''</span> <span class="main">=</span> <span class="free">af_letter_simp</span> <span class="bound">φ'</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">;</span> 
        <span class="bound">ψ''</span> <span class="main">=</span> <span class="free">af_letter_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> 
       <span class="keyword1">in</span>
        <span class="main">(</span><span class="keyword1">if</span> <span class="bound">φ''</span> <span class="main">=</span> <span class="bound">ψ''</span> <span class="keyword1">then</span> mk_and' <span class="main">(</span><span class="keyword1">G</span> <span class="bound">φ'</span><span class="main">)</span> <span class="bound">φ''</span> <span class="keyword1">else</span> mk_and id <span class="main">(</span>mk_and' <span class="main">(</span><span class="keyword1">G</span> <span class="bound">φ'</span><span class="main">)</span> <span class="bound">φ''</span><span class="main">)</span> <span class="bound">ψ''</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> mk_and id <span class="main">(</span><span class="free">af_letter_simp</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">af_letter_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_letter_simp</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">or</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">of</span>
      <span class="keyword1">true</span> <span class="main">⇒</span> <span class="keyword1">true</span>
    <span class="main">|</span> <span class="keyword1">false</span> <span class="main">⇒</span> <span class="free">af_letter_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span>
    <span class="main">|</span> <span class="keyword1">p(</span><span class="bound">a</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">then</span> <span class="keyword1">true</span> <span class="keyword1">else</span> <span class="free">af_letter_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span>
    <span class="main">|</span> <span class="keyword1">np(</span><span class="bound">a</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">then</span> <span class="keyword1">true</span> <span class="keyword1">else</span> <span class="free">af_letter_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span>
    <span class="main">|</span> <span class="keyword1">F</span> <span class="bound">φ'</span> <span class="main">⇒</span>  
      <span class="main">(</span><span class="keyword1">let</span> 
        <span class="bound">φ''</span> <span class="main">=</span> <span class="free">af_letter_simp</span> <span class="bound">φ'</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">;</span> 
        <span class="bound">ψ''</span> <span class="main">=</span> <span class="free">af_letter_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> 
       <span class="keyword1">in</span>
        <span class="main">(</span><span class="keyword1">if</span> <span class="bound">φ''</span> <span class="main">=</span> <span class="bound">ψ''</span> <span class="keyword1">then</span> mk_or' <span class="main">(</span><span class="keyword1">F</span> <span class="bound">φ'</span><span class="main">)</span> <span class="bound">φ''</span> <span class="keyword1">else</span> mk_or id <span class="main">(</span>mk_or' <span class="main">(</span><span class="keyword1">F</span> <span class="bound">φ'</span><span class="main">)</span> <span class="bound">φ''</span><span class="main">)</span> <span class="bound">ψ''</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> mk_or id <span class="main">(</span><span class="free">af_letter_simp</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">af_letter_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_letter_simp</span> <span class="main">(</span><span class="keyword1">X</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_letter_simp</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> mk_and' <span class="main">(</span><span class="keyword1">G</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">af_letter_simp</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_letter_simp</span> <span class="main">(</span><span class="keyword1">F</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> mk_or' <span class="main">(</span><span class="keyword1">F</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">af_letter_simp</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_letter_simp</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">U</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> mk_or' <span class="main">(</span>mk_and' <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">U</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">af_letter_simp</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">af_letter_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="af_Impl-af_letter_simp_correct"><span class="command">lemma</span></span> af_letter_simp_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af_letter <span class="free">φ</span> <span class="free">ν</span> <span class="main">⟷</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af_letter_simp <span class="free">φ</span> <span class="free">ν</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LTLAnd <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def mk_and_correct mk_and'_correct<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LTLOr <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def mk_or_correct mk_or'_correct<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_and_correct mk_and'_correct mk_or_correct mk_or'_correct<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">af_G_letter_simp</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">af_G_letter_simp</span> <span class="keyword1">true</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="keyword1">true</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_G_letter_simp</span> <span class="keyword1">false</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="keyword1">false</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_G_letter_simp</span> <span class="keyword1">p(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">then</span> <span class="keyword1">true</span> <span class="keyword1">else</span> <span class="keyword1">false</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_G_letter_simp</span> <span class="main">(</span><span class="keyword1">np(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span>  <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">then</span> <span class="keyword1">true</span> <span class="keyword1">else</span> <span class="keyword1">false</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_G_letter_simp</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">and</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">of</span>
      <span class="keyword1">true</span> <span class="main">⇒</span> <span class="free">af_G_letter_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span>
    <span class="main">|</span> <span class="keyword1">false</span> <span class="main">⇒</span> <span class="keyword1">false</span>
    <span class="main">|</span> <span class="keyword1">p(</span><span class="bound">a</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">then</span> <span class="free">af_G_letter_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">else</span> <span class="keyword1">false</span>
    <span class="main">|</span> <span class="keyword1">np(</span><span class="bound">a</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">then</span> <span class="free">af_G_letter_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">else</span> <span class="keyword1">false</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> mk_and id <span class="main">(</span><span class="free">af_G_letter_simp</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">af_G_letter_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_G_letter_simp</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">or</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">of</span>
      <span class="keyword1">true</span> <span class="main">⇒</span> <span class="keyword1">true</span>
    <span class="main">|</span> <span class="keyword1">false</span> <span class="main">⇒</span> <span class="free">af_G_letter_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span>
    <span class="main">|</span> <span class="keyword1">p(</span><span class="bound">a</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">then</span> <span class="keyword1">true</span> <span class="keyword1">else</span> <span class="free">af_G_letter_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span>
    <span class="main">|</span> <span class="keyword1">np(</span><span class="bound">a</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">then</span> <span class="keyword1">true</span> <span class="keyword1">else</span> <span class="free">af_G_letter_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span>
    <span class="main">|</span> <span class="keyword1">F</span> <span class="bound">φ'</span> <span class="main">⇒</span>  
      <span class="main">(</span><span class="keyword1">let</span> 
        <span class="bound">φ''</span> <span class="main">=</span> <span class="free">af_G_letter_simp</span> <span class="bound">φ'</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">;</span> 
        <span class="bound">ψ''</span> <span class="main">=</span> <span class="free">af_G_letter_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> 
       <span class="keyword1">in</span>
        <span class="main">(</span><span class="keyword1">if</span> <span class="bound">φ''</span> <span class="main">=</span> <span class="bound">ψ''</span> <span class="keyword1">then</span> mk_or' <span class="main">(</span><span class="keyword1">F</span> <span class="bound">φ'</span><span class="main">)</span> <span class="bound">φ''</span> <span class="keyword1">else</span> mk_or id <span class="main">(</span>mk_or' <span class="main">(</span><span class="keyword1">F</span> <span class="bound">φ'</span><span class="main">)</span> <span class="bound">φ''</span><span class="main">)</span> <span class="bound">ψ''</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> mk_or id <span class="main">(</span><span class="free">af_G_letter_simp</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">af_G_letter_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_G_letter_simp</span> <span class="main">(</span><span class="keyword1">X</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_G_letter_simp</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="keyword1">G</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_G_letter_simp</span> <span class="main">(</span><span class="keyword1">F</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> mk_or' <span class="main">(</span><span class="keyword1">F</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">af_G_letter_simp</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_G_letter_simp</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">U</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> mk_or' <span class="main">(</span>mk_and' <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">U</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">af_G_letter_simp</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">af_G_letter_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="af_Impl-af_G_letter_simp_correct"><span class="command">lemma</span></span> af_G_letter_simp_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af_G_letter <span class="free">φ</span> <span class="free">ν</span> <span class="main">⟷</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af_G_letter_simp <span class="free">φ</span> <span class="free">ν</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LTLAnd <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_and_correct<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LTLOr <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def mk_or_correct mk_or'_correct<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_and_correct mk_and'_correct mk_or_correct mk_or'_correct<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">step_simp</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">step_simp</span> <span class="keyword1">p(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">then</span> <span class="keyword1">true</span> <span class="keyword1">else</span> <span class="keyword1">false</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">step_simp</span> <span class="main">(</span><span class="keyword1">np(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span>  <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">then</span> <span class="keyword1">true</span> <span class="keyword1">else</span> <span class="keyword1">false</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">step_simp</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">and</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="main">(</span>mk_and id <span class="main">(</span><span class="free">step_simp</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">step_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">step_simp</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">or</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="main">(</span>mk_or id <span class="main">(</span><span class="free">step_simp</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">step_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">step_simp</span> <span class="main">(</span><span class="keyword1">X</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> remove_constants<span class="hidden">⇩</span><sub>P</sub> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">step_simp</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>

<span class="keyword1" id="af_Impl-step_simp_correct"><span class="command">lemma</span></span> step_simp_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> step <span class="free">φ</span> <span class="free">ν</span> <span class="main">⟷</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> step_simp <span class="free">φ</span> <span class="free">ν</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LTLAnd <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def mk_and_correct mk_and'_correct<span class="main">)</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LTLOr <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def mk_or_correct mk_or'_correct<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_and_correct mk_and'_correct mk_or_correct mk_or'_correct remove_constants_correct<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> 

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">Unf_simp</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Unf_simp</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">and</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">of</span>
      <span class="keyword1">true</span> <span class="main">⇒</span> <span class="free">Unf_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>
    <span class="main">|</span> <span class="keyword1">false</span> <span class="main">⇒</span> <span class="keyword1">false</span>
    <span class="main">|</span> <span class="keyword1">G</span> <span class="bound">φ'</span> <span class="main">⇒</span>  
      <span class="main">(</span><span class="keyword1">let</span> 
        <span class="bound">φ''</span> <span class="main">=</span> <span class="free">Unf_simp</span> <span class="bound">φ'</span><span class="main">;</span> <span class="bound">ψ''</span> <span class="main">=</span> <span class="free">Unf_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>
       <span class="keyword1">in</span>
        <span class="main">(</span><span class="keyword1">if</span> <span class="bound">φ''</span> <span class="main">=</span> <span class="bound">ψ''</span> <span class="keyword1">then</span> mk_and' <span class="main">(</span><span class="keyword1">G</span> <span class="bound">φ'</span><span class="main">)</span> <span class="bound">φ''</span> <span class="keyword1">else</span> mk_and id <span class="main">(</span>mk_and' <span class="main">(</span><span class="keyword1">G</span> <span class="bound">φ'</span><span class="main">)</span> <span class="bound">φ''</span><span class="main">)</span> <span class="bound">ψ''</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> mk_and id <span class="main">(</span><span class="free">Unf_simp</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">Unf_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Unf_simp</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">or</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">of</span>
      <span class="keyword1">true</span> <span class="main">⇒</span> <span class="keyword1">true</span>
    <span class="main">|</span> <span class="keyword1">false</span> <span class="main">⇒</span> <span class="free">Unf_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>
    <span class="main">|</span> <span class="keyword1">F</span> <span class="bound">φ'</span> <span class="main">⇒</span>  
      <span class="main">(</span><span class="keyword1">let</span> 
        <span class="bound">φ''</span> <span class="main">=</span> <span class="free">Unf_simp</span> <span class="bound">φ'</span><span class="main">;</span> <span class="bound">ψ''</span> <span class="main">=</span> <span class="free">Unf_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>
       <span class="keyword1">in</span>
        <span class="main">(</span><span class="keyword1">if</span> <span class="bound">φ''</span> <span class="main">=</span> <span class="bound">ψ''</span> <span class="keyword1">then</span> mk_or' <span class="main">(</span><span class="keyword1">F</span> <span class="bound">φ'</span><span class="main">)</span> <span class="bound">φ''</span> <span class="keyword1">else</span> mk_or id <span class="main">(</span>mk_or' <span class="main">(</span><span class="keyword1">F</span> <span class="bound">φ'</span><span class="main">)</span> <span class="bound">φ''</span><span class="main">)</span> <span class="bound">ψ''</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> mk_or id <span class="main">(</span><span class="free">Unf_simp</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">Unf_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Unf_simp</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> mk_and' <span class="main">(</span><span class="keyword1">G</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">Unf_simp</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Unf_simp</span> <span class="main">(</span><span class="keyword1">F</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> mk_or' <span class="main">(</span><span class="keyword1">F</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">Unf_simp</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Unf_simp</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">U</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> mk_or' <span class="main">(</span>mk_and' <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">U</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">Unf_simp</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">Unf_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Unf_simp</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>

<span class="keyword1" id="af_Impl-Unf_simp_correct"><span class="command">lemma</span></span> Unf_simp_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Unf <span class="free">φ</span> <span class="main">⟷</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Unf_simp <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LTLAnd <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def mk_and_correct mk_and'_correct<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LTLOr <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def mk_or_correct mk_or'_correct<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_and_correct mk_and'_correct mk_or_correct mk_or'_correct<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">Unf<span class="hidden">⇩</span><sub>G</sub>_simp</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Unf<span class="hidden">⇩</span><sub>G</sub>_simp</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">and</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> mk_and id <span class="main">(</span><span class="free">Unf<span class="hidden">⇩</span><sub>G</sub>_simp</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">Unf<span class="hidden">⇩</span><sub>G</sub>_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Unf<span class="hidden">⇩</span><sub>G</sub>_simp</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">or</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">of</span>
      <span class="keyword1">true</span> <span class="main">⇒</span> <span class="keyword1">true</span>
    <span class="main">|</span> <span class="keyword1">false</span> <span class="main">⇒</span> <span class="free">Unf<span class="hidden">⇩</span><sub>G</sub>_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>
    <span class="main">|</span> <span class="keyword1">F</span> <span class="bound">φ'</span> <span class="main">⇒</span>  
      <span class="main">(</span><span class="keyword1">let</span> 
        <span class="bound">φ''</span> <span class="main">=</span> <span class="free">Unf<span class="hidden">⇩</span><sub>G</sub>_simp</span> <span class="bound">φ'</span><span class="main">;</span> <span class="bound">ψ''</span> <span class="main">=</span> <span class="free">Unf<span class="hidden">⇩</span><sub>G</sub>_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>
       <span class="keyword1">in</span>
        <span class="main">(</span><span class="keyword1">if</span> <span class="bound">φ''</span> <span class="main">=</span> <span class="bound">ψ''</span> <span class="keyword1">then</span> mk_or' <span class="main">(</span><span class="keyword1">F</span> <span class="bound">φ'</span><span class="main">)</span> <span class="bound">φ''</span> <span class="keyword1">else</span> mk_or id <span class="main">(</span>mk_or' <span class="main">(</span><span class="keyword1">F</span> <span class="bound">φ'</span><span class="main">)</span> <span class="bound">φ''</span><span class="main">)</span> <span class="bound">ψ''</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> mk_or id <span class="main">(</span><span class="free">Unf<span class="hidden">⇩</span><sub>G</sub>_simp</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">Unf<span class="hidden">⇩</span><sub>G</sub>_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Unf<span class="hidden">⇩</span><sub>G</sub>_simp</span> <span class="main">(</span><span class="keyword1">F</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> mk_or' <span class="main">(</span><span class="keyword1">F</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">Unf<span class="hidden">⇩</span><sub>G</sub>_simp</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Unf<span class="hidden">⇩</span><sub>G</sub>_simp</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">U</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> mk_or' <span class="main">(</span>mk_and' <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">U</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">Unf<span class="hidden">⇩</span><sub>G</sub>_simp</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">Unf<span class="hidden">⇩</span><sub>G</sub>_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">Unf<span class="hidden">⇩</span><sub>G</sub>_simp</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>

<span class="keyword1" id="af_Impl-Unf"><span class="command">lemma</span></span> Unf<span class="hidden">⇩</span><sub>G</sub>_simp_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Unf<span class="hidden">⇩</span><sub>G</sub> <span class="free">φ</span> <span class="main">⟷</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> Unf<span class="hidden">⇩</span><sub>G</sub>_simp <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LTLAnd <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def mk_and_correct mk_and'_correct<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LTLOr <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def mk_or_correct mk_or'_correct<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_and_correct mk_and'_correct mk_or_correct mk_or'_correct<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">af_letter_opt_simp</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">af_letter_opt_simp</span> <span class="keyword1">true</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="keyword1">true</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_letter_opt_simp</span> <span class="keyword1">false</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="keyword1">false</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_letter_opt_simp</span> <span class="keyword1">p(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">then</span> <span class="keyword1">true</span> <span class="keyword1">else</span> <span class="keyword1">false</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_letter_opt_simp</span> <span class="main">(</span><span class="keyword1">np(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span>  <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">then</span> <span class="keyword1">true</span> <span class="keyword1">else</span> <span class="keyword1">false</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_letter_opt_simp</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">and</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">of</span>
      <span class="keyword1">true</span> <span class="main">⇒</span> <span class="free">af_letter_opt_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span>
    <span class="main">|</span> <span class="keyword1">false</span> <span class="main">⇒</span> <span class="keyword1">false</span>
    <span class="main">|</span> <span class="keyword1">p(</span><span class="bound">a</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">then</span> <span class="free">af_letter_opt_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">else</span> <span class="keyword1">false</span>
    <span class="main">|</span> <span class="keyword1">np(</span><span class="bound">a</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">then</span> <span class="free">af_letter_opt_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">else</span> <span class="keyword1">false</span>
    <span class="main">|</span> <span class="keyword1">G</span> <span class="bound">φ'</span> <span class="main">⇒</span>  
      <span class="main">(</span><span class="keyword1">let</span> 
        <span class="bound">φ''</span> <span class="main">=</span> Unf_simp <span class="bound">φ'</span><span class="main">;</span> 
        <span class="bound">ψ''</span> <span class="main">=</span> <span class="free">af_letter_opt_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> 
       <span class="keyword1">in</span>
        <span class="main">(</span><span class="keyword1">if</span> <span class="bound">φ''</span> <span class="main">=</span> <span class="bound">ψ''</span> <span class="keyword1">then</span> mk_and' <span class="main">(</span><span class="keyword1">G</span> <span class="bound">φ'</span><span class="main">)</span> <span class="bound">φ''</span> <span class="keyword1">else</span> mk_and id <span class="main">(</span>mk_and' <span class="main">(</span><span class="keyword1">G</span> <span class="bound">φ'</span><span class="main">)</span> <span class="bound">φ''</span><span class="main">)</span> <span class="bound">ψ''</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> mk_and id <span class="main">(</span><span class="free">af_letter_opt_simp</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">af_letter_opt_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_letter_opt_simp</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">or</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">of</span>
      <span class="keyword1">true</span> <span class="main">⇒</span> <span class="keyword1">true</span>
    <span class="main">|</span> <span class="keyword1">false</span> <span class="main">⇒</span> <span class="free">af_letter_opt_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span>
    <span class="main">|</span> <span class="keyword1">p(</span><span class="bound">a</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">then</span> <span class="keyword1">true</span> <span class="keyword1">else</span> <span class="free">af_letter_opt_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span>
    <span class="main">|</span> <span class="keyword1">np(</span><span class="bound">a</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">then</span> <span class="keyword1">true</span> <span class="keyword1">else</span> <span class="free">af_letter_opt_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span>
    <span class="main">|</span> <span class="keyword1">F</span> <span class="bound">φ'</span> <span class="main">⇒</span>  
      <span class="main">(</span><span class="keyword1">let</span> 
        <span class="bound">φ''</span> <span class="main">=</span> Unf_simp <span class="bound">φ'</span><span class="main">;</span> 
        <span class="bound">ψ''</span> <span class="main">=</span> <span class="free">af_letter_opt_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> 
       <span class="keyword1">in</span>
        <span class="main">(</span><span class="keyword1">if</span> <span class="bound">φ''</span> <span class="main">=</span> <span class="bound">ψ''</span> <span class="keyword1">then</span> mk_or' <span class="main">(</span><span class="keyword1">F</span> <span class="bound">φ'</span><span class="main">)</span> <span class="bound">φ''</span> <span class="keyword1">else</span> mk_or id <span class="main">(</span>mk_or' <span class="main">(</span><span class="keyword1">F</span> <span class="bound">φ'</span><span class="main">)</span> <span class="bound">φ''</span><span class="main">)</span> <span class="bound">ψ''</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> mk_or id <span class="main">(</span><span class="free">af_letter_opt_simp</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">af_letter_opt_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_letter_opt_simp</span> <span class="main">(</span><span class="keyword1">X</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> Unf_simp <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_letter_opt_simp</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> mk_and' <span class="main">(</span><span class="keyword1">G</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>Unf_simp <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_letter_opt_simp</span> <span class="main">(</span><span class="keyword1">F</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> mk_or' <span class="main">(</span><span class="keyword1">F</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>Unf_simp <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_letter_opt_simp</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">U</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> mk_or' <span class="main">(</span>mk_and' <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">U</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span>Unf_simp <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Unf_simp <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="af_Impl-af_letter_opt_simp_correct"><span class="command">lemma</span></span> af_letter_opt_simp_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af_letter_opt <span class="free">φ</span> <span class="free">ν</span> <span class="main">⟷</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af_letter_opt_simp <span class="free">φ</span> <span class="free">ν</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LTLAnd <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def mk_and_correct mk_and'_correct<span class="main">)</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LTLOr <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def mk_or_correct mk_or'_correct<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_and_correct mk_and'_correct mk_or_correct mk_or'_correct Unf_simp_correct<span class="main">)</span> 

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">af_G_letter_opt_simp</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">af_G_letter_opt_simp</span> <span class="keyword1">true</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="keyword1">true</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_G_letter_opt_simp</span> <span class="keyword1">false</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="keyword1">false</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_G_letter_opt_simp</span> <span class="keyword1">p(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">then</span> <span class="keyword1">true</span> <span class="keyword1">else</span> <span class="keyword1">false</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_G_letter_opt_simp</span> <span class="main">(</span><span class="keyword1">np(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span>  <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">then</span> <span class="keyword1">true</span> <span class="keyword1">else</span> <span class="keyword1">false</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_G_letter_opt_simp</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">and</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">of</span>
      <span class="keyword1">true</span> <span class="main">⇒</span> <span class="free">af_G_letter_opt_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span>
    <span class="main">|</span> <span class="keyword1">false</span> <span class="main">⇒</span> <span class="keyword1">false</span>
    <span class="main">|</span> <span class="keyword1">p(</span><span class="bound">a</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">then</span> <span class="free">af_G_letter_opt_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">else</span> <span class="keyword1">false</span>
    <span class="main">|</span> <span class="keyword1">np(</span><span class="bound">a</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">then</span> <span class="free">af_G_letter_opt_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">else</span> <span class="keyword1">false</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> mk_and id <span class="main">(</span><span class="free">af_G_letter_opt_simp</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">af_G_letter_opt_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_G_letter_opt_simp</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">or</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">of</span>
      <span class="keyword1">true</span> <span class="main">⇒</span> <span class="keyword1">true</span>
    <span class="main">|</span> <span class="keyword1">false</span> <span class="main">⇒</span> <span class="free">af_G_letter_opt_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span>
    <span class="main">|</span> <span class="keyword1">p(</span><span class="bound">a</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">then</span> <span class="keyword1">true</span> <span class="keyword1">else</span> <span class="free">af_G_letter_opt_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span>
    <span class="main">|</span> <span class="keyword1">np(</span><span class="bound">a</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">then</span> <span class="keyword1">true</span> <span class="keyword1">else</span> <span class="free">af_G_letter_opt_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span>
    <span class="main">|</span> <span class="keyword1">F</span> <span class="bound">φ'</span> <span class="main">⇒</span>  
      <span class="main">(</span><span class="keyword1">let</span> 
        <span class="bound">φ''</span> <span class="main">=</span> Unf<span class="hidden">⇩</span><sub>G</sub>_simp <span class="bound">φ'</span><span class="main">;</span> 
        <span class="bound">ψ''</span> <span class="main">=</span> <span class="free">af_G_letter_opt_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> 
       <span class="keyword1">in</span>
        <span class="main">(</span><span class="keyword1">if</span> <span class="bound">φ''</span> <span class="main">=</span> <span class="bound">ψ''</span> <span class="keyword1">then</span> mk_or' <span class="main">(</span><span class="keyword1">F</span> <span class="bound">φ'</span><span class="main">)</span> <span class="bound">φ''</span> <span class="keyword1">else</span> mk_or id <span class="main">(</span>mk_or' <span class="main">(</span><span class="keyword1">F</span> <span class="bound">φ'</span><span class="main">)</span> <span class="bound">φ''</span><span class="main">)</span> <span class="bound">ψ''</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> mk_or id <span class="main">(</span><span class="free">af_G_letter_opt_simp</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">af_G_letter_opt_simp</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_G_letter_opt_simp</span> <span class="main">(</span><span class="keyword1">X</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> Unf<span class="hidden">⇩</span><sub>G</sub>_simp <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_G_letter_opt_simp</span> <span class="main">(</span><span class="keyword1">G</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="keyword1">G</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_G_letter_opt_simp</span> <span class="main">(</span><span class="keyword1">F</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> mk_or' <span class="main">(</span><span class="keyword1">F</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>Unf<span class="hidden">⇩</span><sub>G</sub>_simp <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">af_G_letter_opt_simp</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">U</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> mk_or' <span class="main">(</span>mk_and' <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">U</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span>Unf<span class="hidden">⇩</span><sub>G</sub>_simp <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Unf<span class="hidden">⇩</span><sub>G</sub>_simp <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="af_Impl-af_G_letter_opt_simp_correct"><span class="command">lemma</span></span> af_G_letter_opt_simp_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af_G_letter_opt <span class="free">φ</span> <span class="free">ν</span> <span class="main">⟷</span> <span class="free">S</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>P</sub></span> af_G_letter_opt_simp <span class="free">φ</span> <span class="free">ν</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LTLAnd <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def mk_and_correct mk_and'_correct<span class="main">)</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LTLOr <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def mk_or_correct mk_or'_correct<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mk_and_correct mk_and'_correct mk_or_correct mk_or'_correct Unf<span class="hidden">⇩</span><sub>G</sub>_simp_correct<span class="main">)</span> 

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Register Code Equations›</span></span>
 
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="keyword1">↑af</span> <span class="main">(</span>Abs <span class="free">φ</span><span class="main">)</span> <span class="free">ν</span> <span class="main">=</span> Abs <span class="main">(</span>remove_and_or <span class="main">(</span>af_letter_simp <span class="free">φ</span> <span class="free">ν</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> af_abs.f_abs.abs_eq af_letter_abs_def ltl_prop_equiv_quotient.abs_eq_iff ltl_prop_equiv_def
  <span class="keyword1"><span class="command">using</span></span> af_letter_simp_correct remove_and_or_correct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span>Abs <span class="free">φ</span><span class="main">)</span> <span class="free">ν</span> <span class="main">=</span> Abs <span class="main">(</span>remove_and_or <span class="main">(</span>af_G_letter_simp <span class="free">φ</span> <span class="free">ν</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> af_G_abs.f_abs.abs_eq af_G_letter_abs_def ltl_prop_equiv_quotient.abs_eq_iff ltl_prop_equiv_def
  <span class="keyword1"><span class="command">using</span></span> af_G_letter_simp_correct remove_and_or_correct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="keyword1">↑step</span> <span class="main">(</span>Abs <span class="free">φ</span><span class="main">)</span> <span class="free">ν</span> <span class="main">=</span> Abs <span class="main">(</span>step_simp <span class="free">φ</span> <span class="free">ν</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> step_abs.abs_eq ltl_prop_equiv_quotient.abs_eq_iff ltl_prop_equiv_def
  <span class="keyword1"><span class="command">using</span></span> step_simp_correct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="keyword1">↑Unf</span> <span class="main">(</span>Abs <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> Abs <span class="main">(</span>remove_and_or <span class="main">(</span>Unf_simp <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Unf_abs.abs_eq ltl_prop_equiv_quotient.abs_eq_iff ltl_prop_equiv_def
  <span class="keyword1"><span class="command">using</span></span> Unf_simp_correct remove_and_or_correct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="keyword1">↑Unf<span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span>Abs <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> Abs <span class="main">(</span>remove_and_or <span class="main">(</span>Unf<span class="hidden">⇩</span><sub>G</sub>_simp <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Unf<span class="hidden">⇩</span><sub>G</sub>_abs.abs_eq ltl_prop_equiv_quotient.abs_eq_iff ltl_prop_equiv_def
  <span class="keyword1"><span class="command">using</span></span> Unf<span class="hidden">⇩</span><sub>G</sub>_simp_correct remove_and_or_correct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="keyword1">↑af<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">(</span>Abs <span class="free">φ</span><span class="main">)</span> <span class="free">ν</span> <span class="main">=</span> Abs <span class="main">(</span>remove_and_or <span class="main">(</span>af_letter_opt_simp <span class="free">φ</span> <span class="free">ν</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> af_abs_opt.f_abs.abs_eq af_letter_abs_opt_def ltl_prop_equiv_quotient.abs_eq_iff ltl_prop_equiv_def
  <span class="keyword1"><span class="command">using</span></span> af_letter_opt_simp_correct remove_and_or_correct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">(</span>Abs <span class="free">φ</span><span class="main">)</span> <span class="free">ν</span> <span class="main">=</span> Abs <span class="main">(</span>remove_and_or <span class="main">(</span>af_G_letter_opt_simp <span class="free">φ</span> <span class="free">ν</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> af_G_abs_opt.f_abs.abs_eq af_G_letter_abs_opt_def ltl_prop_equiv_quotient.abs_eq_iff ltl_prop_equiv_def
  <span class="keyword1"><span class="command">using</span></span> af_G_letter_opt_simp_correct remove_and_or_correct <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Mojmir_Rabin_Impl">
<div class="head">
<h1>Theory Mojmir_Rabin_Impl</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Author:      Salomon Sickert
    License:     BSD
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Executable Translation from Mojmir to Rabin Automata›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Mojmir_Rabin_Impl
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <span class="quoted">"<a href="Mojmir_Rabin.html">../Mojmir_Rabin</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">― ‹Ranking functions are stored as lists sorted ascending by the state rank›</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">init</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">nxt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> DTS <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> list<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> DTS"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nxt</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">qs</span> <span class="bound">ν</span><span class="main">.</span> remdups_fwd <span class="main">(</span><span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="main">¬</span>semi_mojmir_def.sink <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="bound">q</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="bound">q</span> <span class="bound">ν</span><span class="main">)</span> <span class="bound">qs</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> 

<span class="comment1">― ‹Recompute the rank from the list›</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rk</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> nat option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rk</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">i</span> <span class="main">=</span> index <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">≠</span> length <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="keyword1">then</span> Some <span class="bound">i</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>

<span class="comment1">― ‹Instead of computing the whole sets for fail, merge, and succeed, we define filters (a.k.a. characteristic functions)›</span> 

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">fail_filt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> DTS <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> list<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> transition <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fail_filt</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">.</span> <span class="keyword1">let</span> <span class="bound">q'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="bound">q</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">in</span> <span class="main">(</span><span class="main">¬</span><span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="bound">q'</span><span class="main">)</span> <span class="main">∧</span> semi_mojmir_def.sink <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="bound">q'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">merge_filt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> DTS <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> list<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> transition <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_filt</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">.</span> <span class="keyword1">let</span> <span class="bound">q'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="bound">q</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">in</span> the <span class="main">(</span>rk <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">q</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="main">¬</span><span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="bound">q'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">q''</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">.</span> <span class="bound">q''</span> <span class="main">≠</span> <span class="bound">q</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="bound">q''</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="bound">q'</span><span class="main">)</span> <span class="main">∨</span> <span class="bound">q'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">succeed_filt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> DTS <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> list<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> transition <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">succeed_filt</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">.</span> <span class="keyword1">let</span> <span class="bound">q'</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="bound">q</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="keyword1">in</span> rk <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">q</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">i</span></span></span>  <span class="main">∧</span> <span class="main">(</span><span class="main">¬</span><span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="bound">q</span> <span class="main">∨</span> <span class="bound">q</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="bound">q'</span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹nxt Properties›</span></span>

<span class="keyword1" id="Mojmir_Rabin_Impl-nxt_run_distinct"><span class="command">lemma</span></span> nxt_run_distinct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>run <span class="main">(</span>nxt <span class="free">Σ</span> <span class="free">Δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>init <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">w</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> remdups_fwd.simps<span class="main"><span class="keyword3">;</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> remdups_fwd_distinct<span class="main">)</span>

<span class="keyword1" id="Mojmir_Rabin_Impl-nxt_run_reverse_step"><span class="command">lemma</span></span> nxt_run_reverse_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">w</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≡</span> run <span class="main">(</span>nxt <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>init <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">w</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">r</span> <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≠</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q'</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">r</span> <span class="free">n</span><span class="main">)</span><span class="main">.</span> <span class="free">δ</span> <span class="bound">q'</span> <span class="main">(</span><span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2-3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> r_def run.simps nxt.simps remdups_fwd_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Mojmir_Rabin_Impl-nxt_run_sink_free"><span class="command">lemma</span></span> nxt_run_sink_free<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> set <span class="main">(</span>run <span class="main">(</span>nxt <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>init <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span>semi_mojmir_def.sink <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> semi_mojmir_def.sink_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> remdups_fwd.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹rk Properties›</span></span>

<span class="keyword1" id="Mojmir_Rabin_Impl-rk_bounded"><span class="command">lemma</span></span> rk_bounded<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rk <span class="free">xs</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">i</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> index_conv_size_if_notin index_less_size_conv option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> option.inject<span class="main">)</span>

<span class="keyword1" id="Mojmir_Rabin_Impl-rk_facts"><span class="command">lemma</span></span> rk_facts<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟷</span> rk <span class="free">xs</span> <span class="free">x</span> <span class="main">≠</span> None"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> rk <span class="free">xs</span> <span class="free">x</span> <span class="main">=</span> Some <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rk_bounded <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> index_size_conv<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Mojmir_Rabin_Impl-rk_split"><span class="command">lemma</span></span> rk_split<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> set <span class="free">xs</span> <span class="main">⟹</span> rk <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">zs</span><span class="main">)</span> <span class="free">y</span> <span class="main">=</span> Some <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Mojmir_Rabin_Impl-rk_split_card"><span class="command">lemma</span></span> rk_split_card<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> set <span class="free">xs</span> <span class="main">⟹</span> distinct <span class="free">xs</span> <span class="main">⟹</span> rk <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">y</span> <span class="main">#</span> <span class="free">zs</span><span class="main">)</span> <span class="free">y</span> <span class="main">=</span> Some <span class="main">(</span>card <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rk_split <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_remdups_card_conv remdups_id_iff_distinct<span class="main">)</span>

<span class="keyword1" id="Mojmir_Rabin_Impl-rk_split_card_takeWhile"><span class="command">lemma</span></span> rk_split_card_takeWhile<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rk <span class="free">xs</span> <span class="free">x</span> <span class="main">=</span> Some <span class="main">(</span>card <span class="main">(</span>set <span class="main">(</span>takeWhile <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≠</span> <span class="free">x</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">zs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> split_list_first<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">ys</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> takeWhile <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≠</span> <span class="free">x</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> takeWhile_foo assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> rk_split_card <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Mojmir_Rabin_Impl-take_rk"><span class="command">lemma</span></span> take_rk<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>take <span class="free">i</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="free">i</span><span class="main">.</span> rk <span class="free">xs</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">}</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?rhs</span> <span class="main">=</span> <span class="var">?lhs</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∪</span> set <span class="main">(</span>take <span class="skolem">i</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">also</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="skolem">i</span><span class="main">.</span> rk <span class="skolem">xs</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">finally</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Mojmir_Rabin_Impl-drop_rk"><span class="command">lemma</span></span> drop_rk<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>drop <span class="free">i</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> <span class="free">i</span><span class="main">.</span> rk <span class="free">xs</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">}</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">=</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="main">∃</span><span class="bound">j</span><span class="main">.</span> rk <span class="free">xs</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?U</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> rk_facts<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?U</span> <span class="main">=</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> <span class="free">i</span><span class="main">.</span> rk <span class="free">xs</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="free">i</span><span class="main">.</span> rk <span class="free">xs</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> <span class="free">i</span><span class="main">.</span> rk <span class="free">xs</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="free">i</span><span class="main">.</span> rk <span class="free">xs</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">=</span> set <span class="main">(</span>drop <span class="free">i</span> <span class="free">xs</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>take <span class="free">i</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">=</span> set <span class="main">(</span>drop <span class="free">i</span> <span class="free">xs</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>take <span class="free">i</span> <span class="free">xs</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms append_take_drop_id inf_sup_aci<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">)</span></span> distinct_append set_append<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> take_rk<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Relation to (Semi) Mojmir Automata›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> semi_mojmir<span class="main">)</span> nxt_run_configuration<span class="main">:</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≡</span> run <span class="main">(</span>nxt <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>init <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">r</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">¬</span>sink <span class="free">q</span> <span class="main">∧</span> configuration <span class="free">q</span> <span class="free">n</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">q</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≠</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">r</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> sink <span class="skolem">q</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> r_def nxt_run_sink_free <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">r</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="skolem">q'</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">q</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">r</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>›</span></span> nxt_run_reverse_step<span class="main">[</span><span class="operator">OF</span> _ <span class="quoted"><span class="quoted">‹<span class="skolem">q</span> <span class="main">≠</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"configuration <span class="skolem">q</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> sink <span class="skolem">q</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> configuration_step_eq<span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span> Suc <span class="keyword1"><span class="command">using</span></span> True <span class="quoted"><span class="quoted">‹<span class="main">¬</span> sink <span class="skolem">q</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"configuration <span class="skolem">q</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"configuration <span class="skolem">q'</span> <span class="skolem">n</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="skolem">q'</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> configuration_step_eq<span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">moreover</span></span> 
          <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="skolem">q'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span>sink <span class="skolem">q</span>›</span></span> sink_rev_step assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">ultimately</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">r</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">r</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">δ</span> <span class="skolem">q'</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span>sink <span class="skolem">q</span>›</span></span> 
            <span class="keyword1"><span class="command">unfolding</span></span> r_def run.simps set_filter comp_def remdups_fwd_set set_map set_append image_def
            <span class="keyword1"><span class="command">unfolding</span></span> r_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_def sink_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">insert</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_def sink_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> semi_mojmir<span class="main">)</span> nxt_run_sorted<span class="main">:</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≡</span> run <span class="main">(</span>nxt <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>init <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">w</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> the <span class="main">(</span>oldest_token <span class="bound">q</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f_n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">q</span><span class="main">.</span> the <span class="main">(</span>oldest_token <span class="bound">q</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f_Suc_n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">q</span><span class="main">.</span> the <span class="main">(</span>oldest_token <span class="bound">q</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?step</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="main">¬</span>sink <span class="bound">q</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="free">δ</span> <span class="bound">q</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">]</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">p</span> <span class="bound">qs</span> <span class="bound">ps</span><span class="main">.</span> remdups_fwd <span class="var">?step</span> <span class="main">=</span> <span class="bound">qs</span> <span class="main">@</span> <span class="bound">q</span> <span class="main">#</span> <span class="bound">p</span> <span class="main">#</span> <span class="bound">ps</span> <span class="main">⟹</span> <span class="var">?f_Suc_n</span> <span class="bound">q</span> <span class="main">≤</span> <span class="var">?f_Suc_n</span> <span class="bound">p</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="skolem">qs</span> <span class="skolem">p</span> <span class="skolem">ps</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"remdups_fwd <span class="var">?step</span> <span class="main">=</span> <span class="skolem">qs</span> <span class="main">@</span> <span class="skolem">q</span> <span class="main">#</span> <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">ps</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="skolem"><span class="skolem">zs'</span></span> <span class="skolem"><span class="skolem">zs''</span></span> <span class="keyword2"><span class="keyword">where</span></span> step_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?step</span> <span class="main">=</span> <span class="skolem">zs</span> <span class="main">@</span> <span class="skolem">q</span> <span class="main">#</span> <span class="skolem">zs'</span> <span class="main">@</span> <span class="skolem">p</span> <span class="main">#</span> <span class="skolem">zs''</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"remdups_fwd <span class="skolem">zs</span> <span class="main">=</span> <span class="skolem">qs</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"remdups_fwd_acc <span class="main">(</span>set <span class="skolem">qs</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">q</span><span class="main">}</span><span class="main">)</span> <span class="skolem">zs'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"remdups_fwd_acc <span class="main">(</span>set <span class="skolem">qs</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">q</span><span class="main">,</span> <span class="skolem">p</span><span class="main">}</span><span class="main">)</span> <span class="skolem">zs''</span> <span class="main">=</span> <span class="skolem">ps</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∉</span> set <span class="skolem">zs</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> set <span class="skolem">zs</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">q</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> remdups_fwd.simps remdups_fwd_split_exact_iff remdups_fwd_split_exact_iff<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?ys</span> <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> insert_commute
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> set <span class="skolem">zs</span> <span class="main">∪</span> set <span class="skolem">zs'</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">q</span><span class="main">}</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> remdups_fwd_acc_empty<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> set <span class="skolem">zs</span> <span class="main">∪</span> set <span class="skolem">zs'</span> <span class="main">∪</span> set <span class="main">[</span><span class="skolem">q</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">q</span><span class="main">,</span> <span class="skolem">p</span><span class="main">}</span> <span class="main">⊆</span> set <span class="var">?step</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> sink <span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> sink <span class="skolem">p</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> set_map set_filter <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f_Suc_n</span> <span class="skolem">q</span> <span class="main">≤</span> <span class="var">?f_Suc_n</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">zs''</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> q_def<span class="main">:</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="main">¬</span>sink <span class="bound">q</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="free">δ</span> <span class="bound">q</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">q</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">zs'</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> step_def <span class="keyword1"><span class="command">unfolding</span></span> sink_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∉</span> set <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="main">¬</span>sink <span class="bound">q</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="free">δ</span> <span class="bound">q</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∉</span> set <span class="skolem">zs</span> <span class="main">∪</span> set <span class="skolem">zs'</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">q</span><span class="main">}</span>›</span></span>  <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>›</span></span> sink_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∉</span> <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="free">δ</span> <span class="bound">q</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound">q'</span><span class="main">.</span> configuration <span class="bound">q'</span> <span class="skolem">n</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> nxt_run_configuration bounded_w <span class="keyword1"><span class="command">unfolding</span></span> set_map set_filter r_def sink_def init.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"configuration <span class="skolem">p</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span>Suc <span class="skolem">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
            <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>›</span></span> <span class="keyword1"><span class="command">using</span></span> configuration_step_eq_q<span class="hidden">⇩</span><sub>0</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f_Suc_n</span> <span class="skolem">p</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span>
           <span class="keyword1"><span class="command">using</span></span> assms  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="free">δ</span> <span class="bound">q</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> set <span class="main">(</span><span class="free">r</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∉</span> set <span class="skolem">zs</span> <span class="main">∪</span> set <span class="skolem">zs'</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">q</span><span class="main">}</span>›</span></span> image_set <span class="keyword1"><span class="command">unfolding</span></span> filter_map_split_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="main">¬</span> sink <span class="bound">q</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="free">δ</span> <span class="bound">q</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span>"</span></span><span class="main">]</span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Un_insert_right <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>›</span></span>  <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="skolem">q</span><span class="main">,</span> <span class="skolem">p</span><span class="main">}</span> <span class="main">⊆</span> set <span class="main">[</span><span class="bound">q</span><span class="main">←</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="free">δ</span> <span class="bound">q</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">]</span> <span class="main">.</span> <span class="main">¬</span> sink <span class="bound">q</span><span class="main">]</span>›</span></span> append_Nil2 insert_iff insert_subset list.simps<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span> mem_Collect_eq set_append set_filter<span class="main">)</span>  
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="free">δ</span> <span class="bound">q</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound">q'</span><span class="main">.</span> configuration <span class="bound">q'</span> <span class="skolem">n</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> nxt_run_configuration <span class="keyword1"><span class="command">unfolding</span></span> r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"configuration <span class="skolem">q</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> configuration_step assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f_Suc_n</span> <span class="skolem">q</span> <span class="main">≤</span> Suc <span class="skolem">n</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> assms oldest_token_bounded<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">q</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span>"</span></span><span class="main">]</span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> configuration.simps<span class="main">)</span> 
          <span class="keyword1"><span class="command">ultimately</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f_Suc_n</span> <span class="skolem">q</span> <span class="main">≤</span> <span class="var">?f_Suc_n</span> <span class="skolem">p</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">hence</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="main">¬</span>sink <span class="bound">q</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="free">δ</span> <span class="bound">q</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">q</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">zs'</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">p</span><span class="main">]</span> <span class="main">@</span> butlast <span class="skolem">zs''</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> step_def <span class="keyword1"><span class="command">unfolding</span></span> map_append filter_append sink_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> butlast.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> list.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> butlast_append append_is_Nil_conv butlast_snoc<span class="main">)</span> <span class="comment1">(* Slow *)</span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qs'</span></span> <span class="skolem"><span class="skolem">sq'</span></span> <span class="skolem"><span class="skolem">sp'</span></span> <span class="skolem"><span class="skolem">ps'</span></span> <span class="skolem"><span class="skolem">ps''</span></span> <span class="keyword2"><span class="keyword">where</span></span> r_def'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">qs'</span> <span class="main">@</span> <span class="skolem">sq'</span> <span class="main">@</span> <span class="skolem">ps'</span> <span class="main">@</span> <span class="skolem">sp'</span> <span class="main">@</span> <span class="skolem">ps''</span>"</span></span>
            <span class="keyword2"><span class="keyword">and</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="main">¬</span>sink <span class="bound">q</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="free">δ</span> <span class="bound">q</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">qs'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">zs</span>"</span></span>
            <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="main">¬</span>sink <span class="bound">q</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="free">δ</span> <span class="bound">q</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">sq'</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">q</span><span class="main">]</span>"</span></span>
            <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="main">¬</span>sink <span class="bound">q</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="free">δ</span> <span class="bound">q</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">zs'</span>"</span></span>
            <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="main">¬</span>sink <span class="bound">q</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="free">δ</span> <span class="bound">q</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">sp'</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">p</span><span class="main">]</span>"</span></span>
            <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"filter <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="main">¬</span>sink <span class="bound">q</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="free">δ</span> <span class="bound">q</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ps''</span><span class="main">)</span> <span class="main">=</span> butlast <span class="skolem">zs''</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> X  <span class="keyword1"><span class="command">unfolding</span></span> filter_map_split_iff <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> 21<span class="main">:</span> <span class="quoted"><span class="quoted">"Set.filter <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="main">¬</span>sink <span class="bound">q</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="free">δ</span> <span class="bound">q</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> set <span class="skolem">sq'</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">q</span><span class="main">}</span>"</span></span>
            <span class="keyword2"><span class="keyword">and</span></span> 41<span class="main">:</span> <span class="quoted"><span class="quoted">"Set.filter <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="main">¬</span>sink <span class="bound">q</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="free">δ</span> <span class="bound">q</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> set <span class="skolem">sp'</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">p</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> filter_set image_set list.set<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
          <span class="keyword1"><span class="command">from</span></span> 21 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">∈</span> set <span class="skolem">sq'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> sink <span class="skolem">q'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">q'</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> sink_rev_step<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> sink <span class="skolem">q</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">from</span></span> 41 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">∈</span> set <span class="skolem">sp'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> sink <span class="skolem">p'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">p'</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> sink_rev_step<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> sink <span class="skolem">p</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">from</span></span> Suc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f_n</span> <span class="skolem">q'</span> <span class="main">≤</span> <span class="var">?f_n</span> <span class="skolem">p'</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> r_def' map_append sorted_append set_append set_map <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">q'</span> <span class="main">∈</span> set <span class="skolem">sq'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p'</span> <span class="main">∈</span> set <span class="skolem">sp'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"oldest_token <span class="skolem">q'</span> <span class="skolem">n</span> <span class="main">≠</span> None"</span></span>     
              <span class="keyword1"><span class="command">using</span></span> nxt_run_configuration option.distinct<span class="main">(</span>1<span class="main">)</span> r_def r_def'  <span class="quoted"><span class="quoted">‹<span class="skolem">q'</span> <span class="main">∈</span> set <span class="skolem">sq'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p'</span> <span class="main">∈</span> set <span class="skolem">sp'</span>›</span></span> set_append
              <span class="keyword1"><span class="command">unfolding</span></span> init.simps oldest_token.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UnCI<span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"oldest_token <span class="skolem">q</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">≠</span> None"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">q'</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> oldest_token.simps option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> configuration_step_non_empty<span class="main">)</span>
            <span class="keyword1"><span class="command">ultimately</span></span> 
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_def<span class="main">:</span> <span class="quoted"><span class="quoted">"oldest_token <span class="skolem">q'</span> <span class="skolem">n</span> <span class="main">=</span> Some <span class="skolem">x</span>"</span></span>  
              <span class="keyword2"><span class="keyword">and</span></span> y_def<span class="main">:</span> <span class="quoted"><span class="quoted">"oldest_token <span class="skolem">q</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">y</span>"</span></span> 
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">x</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">q'</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> oldest_token_bounded push_down_oldest_token_token_run assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">x</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">q'</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> token_run_step<span class="main">)</span>
            <span class="keyword1"><span class="command">ultimately</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> <span class="skolem">y</span>"</span></span> 
              <span class="keyword1"><span class="command">using</span></span> oldest_token_monotonic_Suc assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">{</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q''</span><span class="main">.</span> <span class="skolem">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="bound">q''</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">q''</span> <span class="main">∉</span> set <span class="skolem">qs'</span>"</span></span>
                 <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">q</span> <span class="main">∉</span> set <span class="skolem">zs</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹filter <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="main">¬</span>sink <span class="bound">q</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="free">δ</span> <span class="bound">q</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">qs'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">zs</span>›</span></span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> set_map set_filter <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> sink <span class="skolem">q</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
              <span class="keyword1"><span class="command">moreover</span></span>
              <span class="keyword1"><span class="command">{</span></span>
                <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">us</span></span> <span class="skolem"><span class="skolem">vs</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="free">δ</span> <span class="bound">q</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">sq'</span> <span class="main">=</span> <span class="skolem">us</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">q</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">vs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span><span class="main">∈</span>set <span class="skolem">us</span><span class="main">.</span> sink <span class="bound">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">=</span> <span class="main">[</span><span class="bound">q</span><span class="main">←</span><span class="skolem">vs</span> <span class="main">.</span> <span class="main">¬</span> sink <span class="bound">q</span><span class="main">]</span>"</span></span>
                   <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹filter <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="main">¬</span>sink <span class="bound">q</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="free">δ</span> <span class="bound">q</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">sq'</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">q</span><span class="main">]</span>›</span></span>   <span class="keyword1"><span class="command">unfolding</span></span> filter_eq_Cons_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">moreover</span></span>
                <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q''</span><span class="main">.</span> <span class="bound">q''</span> <span class="main">∈</span> <span class="main">(</span>set <span class="skolem">us</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>set <span class="skolem">vs</span><span class="main">)</span> <span class="main">⟹</span> sink <span class="bound">q''</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UnE filter_empty_conv<span class="main">)</span> 
                <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∉</span> <span class="main">(</span>set <span class="skolem">us</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>set <span class="skolem">vs</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> sink <span class="skolem">q</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">ultimately</span></span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q''</span><span class="main">.</span> <span class="bound">q''</span> <span class="main">∈</span> <span class="main">(</span>set <span class="skolem">sq'</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">q'</span><span class="main">}</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">δ</span> <span class="bound">q''</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">q</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> 1 <span class="quoted"><span class="quoted">‹<span class="skolem">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">q'</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">q'</span> <span class="main">∈</span> set <span class="skolem">sq'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> split_list <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> map_splitE<span class="main">)</span>
              <span class="keyword1"><span class="command">}</span></span>
              <span class="keyword1"><span class="command">ultimately</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q''</span><span class="main">.</span> <span class="skolem">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="bound">q''</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">⟹</span> configuration <span class="bound">q''</span> <span class="skolem">n</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="bound">q''</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">ps'</span> <span class="main">@</span> <span class="skolem">sp'</span> <span class="main">@</span> <span class="skolem">ps''</span><span class="main">)</span> <span class="main">∨</span> <span class="bound">q''</span> <span class="main">=</span> <span class="skolem">q'</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> nxt_run_configuration<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> sink <span class="skolem">q</span>›</span></span> sink_rev_step 
                <span class="keyword1"><span class="command">unfolding</span></span> r_def'<span class="main">[</span><span class="operator">unfolded</span> r_def<span class="main">]</span> set_append 
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
              <span class="keyword1"><span class="command">moreover</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q''</span><span class="main">.</span> <span class="bound">q''</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">ps'</span> <span class="main">@</span> <span class="skolem">sp'</span> <span class="main">@</span> <span class="skolem">ps''</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="var">?f_n</span> <span class="bound">q''</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> x_def <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">unfolding</span></span> r_def' map_append sorted_append set_append set_map  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">q'</span> <span class="main">∈</span> set <span class="skolem">sq'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p'</span> <span class="main">∈</span> set <span class="skolem">sp'</span>›</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> oldest_token.simps<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
              <span class="keyword1"><span class="command">moreover</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q''</span><span class="main">.</span> <span class="bound">q''</span> <span class="main">=</span> <span class="skolem">q'</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="var">?f_n</span> <span class="bound">q''</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> x_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">moreover</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q''</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> configuration <span class="bound">q''</span> <span class="skolem">n</span> <span class="main">⟹</span> the <span class="main">(</span>oldest_token <span class="bound">q''</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">≤</span> <span class="bound">x</span>"</span></span>
               <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">ultimately</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">{</span>configuration <span class="bound">q'</span> <span class="skolem">n</span> <span class="main">|</span><span class="bound">q'</span><span class="main">.</span> <span class="skolem">q</span> <span class="main">=</span> <span class="free">δ</span> <span class="bound">q'</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span><span class="main">}</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="bound">z</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
            <span class="keyword1"><span class="command">}</span></span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> configuration <span class="skolem">q</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="bound">z</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> configuration_step_eq_unified <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">n</span>›</span></span> 
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> y_def Min.boundedI configuration_finite <span class="keyword1"><span class="command">using</span></span> push_down_oldest_token_configuration <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span> 
            <span class="keyword1"><span class="command">ultimately</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f_n</span> <span class="skolem">q'</span> <span class="main">=</span> <span class="var">?f_Suc_n</span> <span class="skolem">q</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> x_def y_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">moreover</span></span>
          <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"oldest_token <span class="skolem">p'</span> <span class="skolem">n</span> <span class="main">≠</span> None"</span></span>     
              <span class="keyword1"><span class="command">using</span></span> nxt_run_configuration oldest_token.simps option.distinct<span class="main">(</span>1<span class="main">)</span> r_def r_def'  <span class="quoted"><span class="quoted">‹<span class="skolem">q'</span> <span class="main">∈</span> set <span class="skolem">sq'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p'</span> <span class="main">∈</span> set <span class="skolem">sp'</span>›</span></span> set_append
              <span class="keyword1"><span class="command">unfolding</span></span> init.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UnCI<span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"oldest_token <span class="skolem">p</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">≠</span> None"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">p'</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> oldest_token.simps option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> configuration_step_non_empty<span class="main">)</span>
            <span class="keyword1"><span class="command">ultimately</span></span> 
            <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_def<span class="main">:</span> <span class="quoted"><span class="quoted">"oldest_token <span class="skolem">p'</span> <span class="skolem">n</span> <span class="main">=</span> Some <span class="skolem">x</span>"</span></span>  
              <span class="keyword2"><span class="keyword">and</span></span> y_def<span class="main">:</span> <span class="quoted"><span class="quoted">"oldest_token <span class="skolem">p</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">y</span>"</span></span> 
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">x</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">p'</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> oldest_token_bounded push_down_oldest_token_token_run assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"token_run <span class="skolem">x</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">p'</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span>›</span></span> assms token_run_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">ultimately</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> <span class="skolem">y</span>"</span></span> 
              <span class="keyword1"><span class="command">using</span></span> oldest_token_monotonic_Suc assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">moreover</span></span>
            <span class="keyword1"><span class="command">{</span></span>     
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q''</span><span class="main">.</span> <span class="skolem">p</span> <span class="main">=</span> <span class="free">δ</span> <span class="bound">q''</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">q''</span> <span class="main">∉</span> set <span class="skolem">qs'</span> <span class="main">∪</span> set <span class="skolem">sq'</span> <span class="main">∪</span> set <span class="skolem">ps'</span>"</span></span>
                 <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∉</span> set <span class="skolem">zs</span> <span class="main">∪</span> set <span class="skolem">zs'</span> <span class="main">∪</span> set <span class="main">[</span><span class="skolem">q</span><span class="main">]</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> sink <span class="skolem">p</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> 2<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> 3<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> set_map set_filter <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
              <span class="keyword1"><span class="command">moreover</span></span>
              <span class="keyword1"><span class="command">{</span></span>
                <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">us</span></span> <span class="skolem"><span class="skolem">vs</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="free">δ</span> <span class="bound">q</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">sp'</span> <span class="main">=</span> <span class="skolem">us</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">p</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">vs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span><span class="main">∈</span>set <span class="skolem">us</span><span class="main">.</span> sink <span class="bound">u</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">=</span> <span class="main">[</span><span class="bound">q</span><span class="main">←</span><span class="skolem">vs</span> <span class="main">.</span> <span class="main">¬</span> sink <span class="bound">q</span><span class="main">]</span>"</span></span>
                   <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹filter <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="main">¬</span>sink <span class="bound">q</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="free">δ</span> <span class="bound">q</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">sp'</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">p</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">unfolding</span></span> filter_eq_Cons_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
                <span class="keyword1"><span class="command">moreover</span></span>
                <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q''</span><span class="main">.</span> <span class="bound">q''</span> <span class="main">∈</span> <span class="main">(</span>set <span class="skolem">us</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>set <span class="skolem">vs</span><span class="main">)</span> <span class="main">⟹</span> sink <span class="bound">q''</span>"</span></span>
                  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UnE filter_empty_conv<span class="main">)</span> 
                <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> <span class="main">(</span>set <span class="skolem">us</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>set <span class="skolem">vs</span><span class="main">)</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> sink <span class="skolem">p</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
                <span class="keyword1"><span class="command">ultimately</span></span>
                <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q''</span><span class="main">.</span> <span class="bound">q''</span> <span class="main">∈</span> <span class="main">(</span>set <span class="skolem">sp'</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">p'</span><span class="main">}</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">δ</span> <span class="bound">q''</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">≠</span> <span class="skolem">p</span>"</span></span>
                  <span class="keyword1"><span class="command">using</span></span> 1 <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">=</span> <span class="free">δ</span> <span class="skolem">p'</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p'</span> <span class="main">∈</span> set <span class="skolem">sp'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> split_list <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> map_splitE<span class="main">)</span>
              <span class="keyword1"><span class="command">}</span></span>
              <span class="keyword1"><span class="command">ultimately</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q''</span><span class="main">.</span> <span class="skolem">p</span> <span class="main">=</span> <span class="free">δ</span> <span class="bound">q''</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">⟹</span> configuration <span class="bound">q''</span> <span class="skolem">n</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="bound">q''</span> <span class="main">∈</span> set <span class="skolem">ps''</span> <span class="main">∨</span> <span class="bound">q''</span> <span class="main">=</span> <span class="skolem">p'</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> nxt_run_configuration<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span>  <span class="quoted"><span class="quoted">‹<span class="main">¬</span> sink <span class="skolem">p</span>›</span></span><span class="main">[</span><span class="operator">THEN</span> sink_rev_step<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> r_def'<span class="main">[</span><span class="operator">unfolded</span> r_def<span class="main">]</span> set_append 
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
              <span class="keyword1"><span class="command">moreover</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q''</span><span class="main">.</span> <span class="bound">q''</span> <span class="main">∈</span> set <span class="skolem">ps''</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="var">?f_n</span> <span class="bound">q''</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> x_def <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">unfolding</span></span> r_def' map_append sorted_append set_append set_map  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">q'</span> <span class="main">∈</span> set <span class="skolem">sq'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p'</span> <span class="main">∈</span> set <span class="skolem">sp'</span>›</span></span>
                <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> oldest_token.simps<span class="main">)</span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
              <span class="keyword1"><span class="command">moreover</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q''</span><span class="main">.</span> <span class="bound">q''</span> <span class="main">=</span> <span class="skolem">p'</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="var">?f_n</span> <span class="bound">q''</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> x_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
              <span class="keyword1"><span class="command">moreover</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q''</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> configuration <span class="bound">q''</span> <span class="skolem">n</span> <span class="main">⟹</span> the <span class="main">(</span>oldest_token <span class="bound">q''</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">≤</span> <span class="bound">x</span>"</span></span>
                <span class="keyword1"><span class="command">using</span></span> assms  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
              <span class="keyword1"><span class="command">ultimately</span></span>
              <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">{</span>configuration <span class="bound">p'</span> <span class="skolem">n</span> <span class="main">|</span><span class="bound">p'</span><span class="main">.</span> <span class="skolem">p</span> <span class="main">=</span> <span class="free">δ</span> <span class="bound">p'</span> <span class="main">(</span><span class="free">w</span> <span class="skolem">n</span><span class="main">)</span><span class="main">}</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="bound">z</span>"</span></span>
                <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
            <span class="keyword1"><span class="command">}</span></span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> configuration <span class="skolem">p</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="bound">z</span>"</span></span>
              <span class="keyword1"><span class="command">unfolding</span></span> configuration_step_eq_unified <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">n</span>›</span></span> 
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> y_def Min.boundedI configuration_finite <span class="keyword1"><span class="command">using</span></span> push_down_oldest_token_configuration  <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span> 
            <span class="keyword1"><span class="command">ultimately</span></span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f_n</span> <span class="skolem">p'</span> <span class="main">=</span> <span class="var">?f_Suc_n</span> <span class="skolem">p</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> x_def y_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
       <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span> 
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> map <span class="var">?f_Suc_n</span> <span class="main">(</span>remdups_fwd <span class="var">?step</span><span class="main">)</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">]</span> <span class="main">@</span> <span class="bound">ys</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> map_splitE <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> remdups_fwd.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map <span class="var">?f_Suc_n</span> <span class="main">(</span>remdups_fwd <span class="main">(</span><span class="var">?step</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sorted_pre <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_def sink_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> semi_mojmir<span class="main">)</span> nxt_run_senior_states<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">≡</span> run <span class="main">(</span>nxt <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>init <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">w</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="free">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"configuration <span class="free">q</span> <span class="free">n</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"senior_states <span class="free">q</span> <span class="free">n</span> <span class="main">=</span> set <span class="main">(</span>takeWhile <span class="main">(</span><span class="main">λ</span><span class="bound">q'</span><span class="main">.</span> <span class="bound">q'</span> <span class="main">≠</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q'</span> <span class="keyword3"><span class="command">assume</span></span> q'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">∈</span> senior_states <span class="free">q</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"oldest_token <span class="skolem">q'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"oldest_token <span class="free">q</span> <span class="free">n</span> <span class="main">=</span> Some <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&lt;</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> senior_states.simps <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>oldest_token <span class="skolem">q'</span> <span class="free">n</span><span class="main">)</span> <span class="main">&lt;</span> the <span class="main">(</span>oldest_token <span class="free">q</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>  
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="skolem">q'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"configuration <span class="skolem">q'</span> <span class="free">n</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> q'_def option.distinct<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹oldest_token <span class="skolem">q'</span> <span class="free">n</span> <span class="main">=</span> Some <span class="skolem">y</span>›</span></span> 
     oldest_token.simps <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">r</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">r</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nxt_run_configuration assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">r</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> r_def <span class="keyword1"><span class="command">using</span></span> nxt_run_distinct <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="skolem"><span class="skolem">r''</span></span> <span class="skolem"><span class="skolem">r'''</span></span> <span class="keyword2"><span class="keyword">where</span></span> r_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="free">n</span> <span class="main">=</span> <span class="skolem">r'</span> <span class="main">@</span> <span class="skolem">q'</span> <span class="main">#</span> <span class="skolem">r''</span> <span class="main">@</span> <span class="free">q</span> <span class="main">#</span> <span class="skolem">r'''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sorted_list<span class="main">[</span><span class="operator">OF</span> _ _ nxt_run_sorted<span class="main">]</span> assms <span class="keyword1"><span class="command">unfolding</span></span> r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">r'</span> <span class="main">@</span> <span class="skolem">q'</span> <span class="main">#</span> <span class="skolem">r''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">∈</span> set <span class="main">(</span>takeWhile <span class="main">(</span><span class="main">λ</span><span class="bound">q'</span><span class="main">.</span> <span class="bound">q'</span> <span class="main">≠</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹distinct <span class="main">(</span><span class="free">r</span> <span class="free">n</span><span class="main">)</span>›</span></span> takeWhile_distinct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">@</span> <span class="skolem">q'</span> <span class="main">#</span> <span class="skolem">r''</span>"</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="skolem">r'''</span></span> <span class="quoted"><span class="skolem">q'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> r_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q'</span> <span class="keyword3"><span class="command">assume</span></span> q'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">∈</span> set <span class="main">(</span>takeWhile <span class="main">(</span><span class="main">λ</span><span class="bound">q'</span><span class="main">.</span> <span class="bound">q'</span> <span class="main">≠</span> <span class="free">q</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">r</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> set_takeWhileD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> sink <span class="skolem">q'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nxt_run_configuration assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">r</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nxt_run_configuration assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">obtain</span></span>  <span class="skolem"><span class="skolem">r'</span></span> <span class="skolem"><span class="skolem">r''</span></span> <span class="skolem"><span class="skolem">r'''</span></span> <span class="keyword2"><span class="keyword">where</span></span> r_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="free">n</span> <span class="main">=</span> <span class="skolem">r'</span> <span class="main">@</span> <span class="skolem">q'</span> <span class="main">#</span> <span class="skolem">r''</span> <span class="main">@</span> <span class="free">q</span> <span class="main">#</span> <span class="skolem">r'''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> takeWhile_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">r</span> <span class="free">n</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">unfolding</span></span> r_def <span class="keyword1"><span class="command">using</span></span> nxt_run_distinct <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>oldest_token <span class="skolem">q'</span> <span class="free">n</span><span class="main">)</span> <span class="main">≤</span> the <span class="main">(</span>oldest_token <span class="free">q</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nxt_run_sorted<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">,</span> <span class="operator">unfolded</span> r_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span> assms
    <span class="keyword1"><span class="command">unfolding</span></span> r_alt_def map_append list.map
    <span class="keyword1"><span class="command">unfolding</span></span> sorted_append <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> oldest_token.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≠</span> <span class="skolem">q'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹distinct <span class="main">(</span><span class="free">r</span> <span class="free">n</span><span class="main">)</span>›</span></span> r_alt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"oldest_token <span class="skolem">q'</span> <span class="free">n</span> <span class="main">≠</span> None"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"oldest_token <span class="free">q</span> <span class="free">n</span> <span class="main">≠</span> None"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="quoted"><span class="quoted">‹<span class="skolem">q'</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">r</span> <span class="free">n</span><span class="main">)</span>›</span></span> nxt_run_configuration <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>oldest_token <span class="skolem">q'</span> <span class="free">n</span><span class="main">)</span> <span class="main">≠</span> the <span class="main">(</span>oldest_token <span class="free">q</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> oldest_token_equal option.collapse<span class="main">)</span>
  
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">∈</span> senior_states <span class="free">q</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 1 2 3 4 5 assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> semi_mojmir<span class="main">)</span> nxt_run_state_rank<span class="main">:</span>
  <span class="quoted"><span class="quoted">"state_rank <span class="free">q</span> <span class="free">n</span> <span class="main">=</span> rk <span class="main">(</span>run <span class="main">(</span>nxt <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>init <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">w</span> <span class="free">n</span><span class="main">)</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sink <span class="free">q</span> <span class="main">∧</span> configuration <span class="free">q</span> <span class="free">n</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> state_rank.simps<span class="main">)</span> 
     <span class="main">(</span><span class="operator">metis</span> nxt_run_senior_states rk_split_card_takeWhile nxt_run_distinct nxt_run_configuration<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> nxt_run_configuration rk_facts<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> semi_mojmir<span class="main">)</span> nxt_foldl_state_rank<span class="main">:</span>
  <span class="quoted"><span class="quoted">"state_rank <span class="free">q</span> <span class="free">n</span> <span class="main">=</span> rk <span class="main">(</span>foldl <span class="main">(</span>nxt <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>init <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>map <span class="free">w</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> nxt_run_state_rank run_foldl <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> semi_mojmir<span class="main">)</span> nxt_run_step_run<span class="main">:</span>
  <span class="quoted"><span class="quoted">"run step initial <span class="free">w</span> <span class="main">=</span> rk <span class="keyword1">o</span> <span class="main">(</span>run <span class="main">(</span>nxt <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>init <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> nxt_run_state_rank state_rank_step_foldl<span class="main">[</span><span class="operator">unfolded</span> run_foldl<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> comp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>  

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> semi_mojmir_def<span class="main">)</span> <span class="entity">Q<span class="hidden">⇩</span><sub>E</sub></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Q<span class="hidden">⇩</span><sub>E</sub></span> <span class="main">≡</span> reach <span class="free">Σ</span> <span class="main">(</span>nxt <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>init <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> semi_mojmir<span class="main">)</span> finite_Q<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite Q<span class="hidden">⇩</span><sub>E</sub>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"range <span class="skolem">w</span> <span class="main">⊆</span> <span class="free">Σ</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">interpret</span></span> ℌ<span class="main">:</span> semi_mojmir <span class="quoted"><span class="free">Σ</span></span> <span class="quoted"><span class="free">δ</span></span> <span class="quoted"><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="skolem">w</span></span>
      <span class="keyword1"><span class="command">using</span></span> finite_reach finite_Σ <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>  
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>run <span class="main">(</span>nxt <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>init <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="skolem">w</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>ℌ.token_run <span class="bound">j</span> <span class="skolem">i</span> <span class="main">|</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≤</span> <span class="skolem">i</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S1</span> <span class="main">⊆</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> ℌ.nxt_run_configuration <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> reach <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⊆</span> <span class="var">?S2</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> reach_def token_run.simps <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹range <span class="skolem">w</span> <span class="main">⊆</span> <span class="free">Σ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S1</span> <span class="main">⊆</span> <span class="var">?S2</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="main">`</span> Q<span class="hidden">⇩</span><sub>E</sub> <span class="main">⊆</span> Pow <span class="main">(</span>reach <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Q<span class="hidden">⇩</span><sub>E</sub>_def reach_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set <span class="main">`</span> Q<span class="hidden">⇩</span><sub>E</sub><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_reach <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> Q<span class="hidden">⇩</span><sub>E</sub> <span class="main">⟹</span> distinct <span class="bound">xs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Q<span class="hidden">⇩</span><sub>E</sub>_def reach_def <span class="keyword1"><span class="command">using</span></span> nxt_run_distinct <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite Q<span class="hidden">⇩</span><sub>E</sub>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> set_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> mojmir_to_rabin_def<span class="main">)</span> filt_equiv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>rk <span class="free">x</span><span class="main">,</span> <span class="free">ν</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> fail<span class="hidden">⇩</span><sub>R</sub> <span class="main">⟷</span> fail_filt <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">F</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">ν</span><span class="main">,</span> <span class="free">y'</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>rk <span class="free">x</span><span class="main">,</span> <span class="free">ν</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> succeed<span class="hidden">⇩</span><sub>R</sub> <span class="free">i</span> <span class="main">⟷</span> succeed_filt <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">F</span><span class="main">)</span> <span class="free">i</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">ν</span><span class="main">,</span> <span class="free">y'</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>rk <span class="free">x</span><span class="main">,</span> <span class="free">ν</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> merge<span class="hidden">⇩</span><sub>R</sub> <span class="free">i</span> <span class="main">⟷</span> merge_filt <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">F</span><span class="main">)</span> <span class="free">i</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">ν</span><span class="main">,</span> <span class="free">y'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fail<span class="hidden">⇩</span><sub>R</sub>_def succeed<span class="hidden">⇩</span><sub>R</sub>_def merge<span class="hidden">⇩</span><sub>R</sub>_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> rk.simps<span class="main"><span class="keyword3">;</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> option.sel rk_facts<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Mojmir_Rabin_Impl-fail_filt_eq"><span class="command">lemma</span></span> fail_filt_eq<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"fail_filt <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">P</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">ν</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>rk <span class="free">x</span><span class="main">,</span> <span class="free">ν</span><span class="main">,</span> <span class="free">y'</span><span class="main">)</span> <span class="main">∈</span> mojmir_to_rabin_def.fail<span class="hidden">⇩</span><sub>R</sub> <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mojmir_to_rabin_def.filt_equiv<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y' <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Mojmir_Rabin_Impl-merge_filt_eq"><span class="command">lemma</span></span> merge_filt_eq<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"merge_filt <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">P</span> <span class="free">i</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">ν</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>rk <span class="free">x</span><span class="main">,</span> <span class="free">ν</span><span class="main">,</span> <span class="free">y'</span><span class="main">)</span> <span class="main">∈</span> mojmir_to_rabin_def.merge<span class="hidden">⇩</span><sub>R</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mojmir_to_rabin_def.filt_equiv<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y' <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Mojmir_Rabin_Impl-succeed_filt_eq"><span class="command">lemma</span></span> succeed_filt_eq<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"succeed_filt <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">P</span> <span class="free">i</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">ν</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>rk <span class="free">x</span><span class="main">,</span> <span class="free">ν</span><span class="main">,</span> <span class="free">y'</span><span class="main">)</span> <span class="main">∈</span> mojmir_to_rabin_def.succeed<span class="hidden">⇩</span><sub>R</sub> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">}</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mojmir_to_rabin_def.filt_equiv<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y' <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> mojmir_to_rabin<span class="main">)</span> rabin_accept_iff_rabin_list_accept_rank<span class="main">:</span>
  <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>R</sub> δ<span class="hidden">⇩</span><sub>ℛ</sub> q<span class="hidden">⇩</span><sub>ℛ</sub> <span class="main">(</span>Acc<span class="hidden">⇩</span><sub>ℛ</sub> <span class="free">i</span><span class="main">)</span> <span class="free">w</span> <span class="main">⟷</span> accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>nxt <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>init <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span><span class="main">{</span><span class="bound">t</span><span class="main">.</span> fail_filt <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">F</span><span class="main">)</span> <span class="bound">t</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">t</span><span class="main">.</span> merge_filt <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">F</span><span class="main">)</span> <span class="free">i</span> <span class="bound">t</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="bound">t</span><span class="main">.</span> succeed_filt <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">F</span><span class="main">)</span> <span class="free">i</span> <span class="bound">t</span><span class="main">}</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>R</sub> δ<span class="hidden">⇩</span><sub>ℛ</sub> q<span class="hidden">⇩</span><sub>ℛ</sub> <span class="main">(</span><span class="var">?F</span><span class="main">,</span> <span class="var">?I</span><span class="main">)</span> <span class="free">w</span> <span class="main">⟷</span> accepting_pair<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>nxt <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>init <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span><span class="var">?F'</span><span class="main">,</span> <span class="var">?I'</span><span class="main">)</span> <span class="free">w</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> δ<span class="hidden">⇩</span><sub>ℛ</sub> q<span class="hidden">⇩</span><sub>ℛ</sub><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wellformed_ℛ finite_Σ finite_reach<span class="hidden">⇩</span><sub>t</sub> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="main">(</span>nxt <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>init <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_Q finite_Σ finite_reach<span class="hidden">⇩</span><sub>t</sub> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Q<span class="hidden">⇩</span><sub>E</sub>_def<span class="main">)</span> 
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"run<span class="hidden">⇩</span><sub>t</sub> step initial <span class="free">w</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">ν</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>rk <span class="bound">x</span><span class="main">,</span> <span class="bound">ν</span><span class="main">,</span> rk <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">o</span> <span class="main">(</span>run<span class="hidden">⇩</span><sub>t</sub> <span class="main">(</span>nxt <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>init <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free">w</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nxt_run_step_run <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">note</span></span> bounded_w filt_equiv 
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> accepting_pair<span class="hidden">⇩</span><sub>R</sub>_abstract<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Compute Rabin Automata List Representation›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mojmir_to_rabin_exec</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mojmir_to_rabin_exec</span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> 
      <span class="bound">q<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">=</span> init <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">;</span>
      <span class="bound">δ'</span> <span class="main">=</span> δ<span class="hidden">⇩</span><sub>L</sub> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">(</span>nxt <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">)</span> <span class="bound">q<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">;</span>
      <span class="bound">max_rank</span> <span class="main">=</span> card <span class="main">(</span>Set.filter <span class="main">(</span>Not <span class="keyword1">o</span> semi_mojmir_def.sink <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">)</span> <span class="main">(</span>Q<span class="hidden">⇩</span><sub>L</sub> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">fail</span> <span class="main">=</span> Set.filter <span class="main">(</span>fail_filt <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">)</span> <span class="bound">δ'</span><span class="main">;</span>
      <span class="bound">merge</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> Set.filter <span class="main">(</span>merge_filt <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="bound">δ'</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">succeed</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> Set.filter <span class="main">(</span>succeed_filt <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">q<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="bound">δ'</span><span class="main">)</span>
    <span class="keyword1">in</span>
      <span class="main">(</span><span class="bound">δ'</span><span class="main">,</span> <span class="bound">q<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">fail</span> <span class="main">∪</span> <span class="main">(</span><span class="bound">merge</span> <span class="bound">i</span><span class="main">)</span><span class="main">,</span> <span class="bound">succeed</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">max_rank</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Code Generation›</span></span>

<span class="comment1">― ‹Setup missing equations for code generator›</span>
<span class="keyword1"><span class="command">declare</span></span> semi_mojmir_def.sink_def <span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="comment1">― ‹Drop computation of length by different code equation›</span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">index_option</span> <span class="main">::</span>  <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> nat option"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">index_option</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> None"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">index_option</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">else</span> <span class="free">index_option</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> rk.simps <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1" id="Mojmir_Rabin_Impl-rk_eq_index_option"><span class="command">lemma</span></span> rk_eq_index_option <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"rk <span class="free">xs</span> <span class="free">x</span> <span class="main">=</span> index_option <span class="main">0</span> <span class="free">xs</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> index <span class="free">xs</span> <span class="free">x</span> <span class="main">+</span> <span class="bound">n</span> <span class="main">=</span> the <span class="main">(</span>index_option <span class="bound">n</span> <span class="free">xs</span> <span class="free">x</span><span class="main">)</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="free">x</span> <span class="main">∉</span> set <span class="free">xs</span> <span class="main">⟷</span> index_option <span class="bound">n</span> <span class="free">xs</span> <span class="free">x</span> <span class="main">=</span> None"</span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> add_Suc_right<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"index <span class="free">xs</span> <span class="free">x</span> <span class="main">=</span> the <span class="main">(</span>index_option <span class="main">0</span> <span class="free">xs</span> <span class="free">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> A<span class="main">[</span><span class="operator">OF</span> True<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> rk.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> B True index_less_size_conv less_irrefl option.collapse<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">― ‹Check Code Export›</span> 
<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">init</span></span> <span class="quoted"><span class="quoted">nxt</span></span> <span class="quoted"><span class="quoted">fail_filt</span></span> <span class="quoted"><span class="quoted">succeed_filt</span></span> <span class="quoted"><span class="quoted">merge_filt</span></span> <span class="quoted"><span class="quoted">mojmir_to_rabin_exec</span></span> <span class="keyword2"><span class="keyword">checking</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> mojmir<span class="main">)</span> max_rank_card<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Σ</span> <span class="main">=</span> set <span class="free">Σ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"max_rank <span class="main">=</span> card <span class="main">(</span>Set.filter <span class="main">(</span>Not <span class="keyword1">o</span> semi_mojmir_def.sink <span class="main">(</span>set <span class="free">Σ'</span><span class="main">)</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>Q<span class="hidden">⇩</span><sub>L</sub> <span class="free">Σ'</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> max_rank_def Q<span class="hidden">⇩</span><sub>L</sub>_reach<span class="main">[</span><span class="operator">OF</span> finite_reach<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="free">Σ</span> <span class="main">=</span> set <span class="free">Σ'</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Set.filter_def set_diff_eq assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
 
<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> mojmir_to_rabin<span class="main">)</span> exec_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Σ</span> <span class="main">=</span> set <span class="free">Σ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"accept <span class="main">⟷</span> accept<span class="hidden">⇩</span><sub>R</sub>_LTS <span class="main">(</span>mojmir_to_rabin_exec <span class="free">Σ'</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">F</span><span class="main">)</span><span class="main">)</span> <span class="free">w</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">have</span></span> F1<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reach <span class="free">Σ</span> <span class="main">(</span>nxt <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>init <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_Q <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Q<span class="hidden">⇩</span><sub>E</sub>_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> F2<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="main">(</span>nxt <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>init <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_Σ <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_reach<span class="hidden">⇩</span><sub>t</sub><span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?δ'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"δ<span class="hidden">⇩</span><sub>L</sub> <span class="free">Σ'</span> <span class="main">(</span>nxt <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>init <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> δ'_Def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?δ'</span> <span class="main">=</span> reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="main">(</span>nxt <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>init <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> δ<span class="hidden">⇩</span><sub>L</sub>_reach<span class="main">[</span><span class="operator">OF</span> F2<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> assms<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span>  assms  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
 
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>snd <span class="main">(</span><span class="main">(</span>mojmir_to_rabin_exec <span class="free">Σ'</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">F</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="main">{</span><span class="bound">t</span><span class="main">.</span> fail_filt <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">F</span><span class="main">)</span> <span class="bound">t</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">t</span><span class="main">.</span> merge_filt <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">F</span><span class="main">)</span> <span class="bound">i</span> <span class="bound">t</span><span class="main">}</span><span class="main">)</span> <span class="main">∩</span> reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="main">(</span>nxt <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>init <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">,</span> 
        <span class="main">{</span><span class="bound">t</span><span class="main">.</span> succeed_filt <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">F</span><span class="main">)</span> <span class="bound">i</span> <span class="bound">t</span><span class="main">}</span>  <span class="main">∩</span> reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="main">(</span>nxt <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>init <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> max_rank<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> assms mojmir_to_rabin_exec.simps Let_def fst_conv snd_conv set_map δ'_Def<span class="main">[</span><span class="operator">unfolded</span> assms<span class="main">]</span> max_rank_card<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> 
    <span class="keyword1"><span class="command">unfolding</span></span> assms<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> Set.filter_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> accept<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>δ<span class="hidden">⇩</span><sub>ℛ</sub><span class="main">,</span> q<span class="hidden">⇩</span><sub>ℛ</sub><span class="main">,</span> <span class="main">{</span><span class="main">(</span>Acc<span class="hidden">⇩</span><sub>ℛ</sub> <span class="bound">i</span><span class="main">)</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> max_rank<span class="main">}</span><span class="main">)</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mojmir_accept_iff_rabin_accept <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">moreover</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> accept<span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>nxt <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> init <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="main">{</span><span class="main">(</span><span class="main">{</span><span class="bound">t</span><span class="main">.</span> fail_filt <span class="free">Σ</span> <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">F</span><span class="main">)</span> <span class="bound">t</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">t</span><span class="main">.</span> merge_filt <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">F</span><span class="main">)</span> <span class="bound">i</span> <span class="bound">t</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="bound">t</span><span class="main">.</span> succeed_filt <span class="free">δ</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">F</span><span class="main">)</span> <span class="bound">i</span> <span class="bound">t</span><span class="main">}</span><span class="main">)</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> max_rank<span class="main">}</span><span class="main">)</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> accept<span class="hidden">⇩</span><sub>R</sub>_def fst_conv snd_conv <span class="keyword1"><span class="command">using</span></span> rabin_accept_iff_rabin_list_accept_rank <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
 
  <span class="keyword1"><span class="command">moreover</span></span> 

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> accept<span class="hidden">⇩</span><sub>R</sub>_restrict<span class="main"><span class="main">[</span></span><span class="operator">OF</span> bounded_w<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> 3<span class="main">[</span><span class="operator">unfolded</span> mojmir_to_rabin_exec.simps Let_def snd_conv<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> assms<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> mojmir_to_rabin_exec.simps Let_def <span class="keyword1"><span class="command">unfolding</span></span> assms δ'_Def<span class="main">[</span><span class="operator">unfolded</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> accept<span class="hidden">⇩</span><sub>R</sub>_LTS<span class="main">[</span><span class="operator">OF</span> bounded_w<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> assms<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">,</span> <span class="operator">unfolded</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
  <span class="keyword1"><span class="command">ultimately</span></span>
 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="LTL_Rabin_Impl">
<div class="head">
<h1>Theory LTL_Rabin_Impl</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Author:      Salomon Sickert
    License:     BSD
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Executable Translation from LTL to Rabin Automata›</span></span>

<span class="keyword1"><span class="command">theory</span></span> LTL_Rabin_Impl
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <span class="quoted">"<a href="Map2.html">../Auxiliary/Map2</a>"</span> <span class="quoted">"<a href="LTL_Rabin.html">../LTL_Rabin</a>"</span> <span class="quoted">"<a href="LTL_Rabin_Unfold_Opt.html">../LTL_Rabin_Unfold_Opt</a>"</span> <a href="af_Impl.html">af_Impl</a> <a href="Mojmir_Rabin_Impl.html">Mojmir_Rabin_Impl</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Template›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Definition›</span></span>

<span class="keyword1"><span class="command">locale</span></span> ltl_to_rabin_base_code_def <span class="main">=</span> ltl_to_rabin_base_def <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">M_fin<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> ltl<span class="main">,</span> nat<span class="main">)</span> mapping <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> ltl<span class="main">,</span> <span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub> list<span class="main">)</span> mapping<span class="main">,</span> <span class="tfree">'a</span> set<span class="main">)</span> transition <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">― ‹Transition Function and Initial State›</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">delta<span class="hidden">⇩</span><sub>C</sub></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">delta<span class="hidden">⇩</span><sub>C</sub></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">=</span> <span class="free">δ</span> <span class="main">×</span> <span class="keyword1">↑Δ<span class="hidden">⇩</span><sub>×</sub></span> <span class="main">(</span>nxt <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free">δ<span class="hidden">⇩</span><sub>M</sub></span> <span class="keyword1">o</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="keyword1">o</span> theG<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">initial<span class="hidden">⇩</span><sub>C</sub></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">initial<span class="hidden">⇩</span><sub>C</sub></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">,</span> Mapping.tabulate <span class="main">(</span>G_list <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>init <span class="keyword1">o</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="keyword1">o</span> theG<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="comment1">― ‹Acceptance Condition›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">max_rank_of<span class="hidden">⇩</span><sub>C</sub></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">max_rank_of<span class="hidden">⇩</span><sub>C</sub></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">=</span> card <span class="main">(</span>Set.filter <span class="main">(</span>Not <span class="keyword1">o</span> semi_mojmir_def.sink <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="free">δ<span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span>theG <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Q<span class="hidden">⇩</span><sub>L</sub> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free">δ<span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span>theG <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">Acc_fin<span class="hidden">⇩</span><sub>C</sub></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Acc_fin<span class="hidden">⇩</span><sub>C</sub></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">χ</span></span></span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> 
      <span class="bound">t</span> <span class="main">=</span> <span class="main">(</span>the <span class="main">(</span>Mapping.lookup <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="free"><span class="bound"><span class="entity">χ</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">;</span> <span class="comment1">― ‹Third element is unused. Hence it is safe to pass a dummy value.›</span>
      <span class="bound">𝒢</span> <span class="main">=</span> Mapping.keys <span class="free"><span class="bound"><span class="entity">π</span></span></span>
    <span class="keyword1">in</span> 
      fail_filt <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free">δ<span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span>theG <span class="free"><span class="bound"><span class="entity">χ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ltl_prop_entails_abs <span class="bound">𝒢</span><span class="main">)</span> <span class="bound">t</span> 
    <span class="main">∨</span> merge_filt <span class="free">δ<span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span>theG <span class="free"><span class="bound"><span class="entity">χ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ltl_prop_entails_abs <span class="bound">𝒢</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span>Mapping.lookup <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">χ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">Acc_inf<span class="hidden">⇩</span><sub>C</sub></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Acc_inf<span class="hidden">⇩</span><sub>C</sub></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">χ</span></span></span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> 
      <span class="bound">t</span> <span class="main">=</span> <span class="main">(</span>the <span class="main">(</span>Mapping.lookup <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="free"><span class="bound"><span class="entity">χ</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">;</span> <span class="comment1">― ‹Third element is unused. Hence it is safe to pass a dummy value.›</span>
      <span class="bound">𝒢</span> <span class="main">=</span> Mapping.keys <span class="free"><span class="bound"><span class="entity">π</span></span></span>
    <span class="keyword1">in</span> 
      succeed_filt <span class="free">δ<span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span>theG <span class="free"><span class="bound"><span class="entity">χ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ltl_prop_entails_abs <span class="bound">𝒢</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span>Mapping.lookup <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">χ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mappings<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set list <span class="main">⇒</span> <span class="tfree">'a</span> ltl <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> ltl<span class="main">,</span> nat<span class="main">)</span> mapping set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mappings<span class="hidden">⇩</span><sub>C</sub></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">π</span><span class="main">.</span> Mapping.keys <span class="bound">π</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">χ</span> <span class="main">∈</span> <span class="main">(</span>Mapping.keys <span class="bound">π</span><span class="main">)</span><span class="main">.</span> the <span class="main">(</span>Mapping.lookup <span class="bound">π</span> <span class="bound">χ</span><span class="main">)</span> <span class="main">&lt;</span> max_rank_of<span class="hidden">⇩</span><sub>C</sub> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="bound">χ</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">reachable_transitions<span class="hidden">⇩</span><sub>C</sub></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">reachable_transitions<span class="hidden">⇩</span><sub>C</sub></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≡</span> δ<span class="hidden">⇩</span><sub>L</sub> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="main">(</span>delta<span class="hidden">⇩</span><sub>C</sub> <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>initial<span class="hidden">⇩</span><sub>C</sub> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ltl_to_generalized_rabin<span class="hidden">⇩</span><sub>C</sub></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ltl_to_generalized_rabin<span class="hidden">⇩</span><sub>C</sub></span> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span>
      <span class="bound">δ_LTS</span> <span class="main">=</span> reachable_transitions<span class="hidden">⇩</span><sub>C</sub> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">;</span> 
      <span class="bound">α_fin_filter</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">π</span> <span class="bound">t</span><span class="main">.</span> <span class="free">M_fin<span class="hidden">⇩</span><sub>C</sub></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="bound">π</span> <span class="bound">t</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">χ</span> <span class="main">∈</span> Mapping.keys <span class="bound">π</span><span class="main">.</span> Acc_fin<span class="hidden">⇩</span><sub>C</sub> <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">Σ</span></span></span><span class="main">)</span> <span class="bound">π</span> <span class="bound">χ</span> <span class="bound">t</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">to_pair</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">π</span><span class="main">.</span> <span class="main">(</span>Set.filter <span class="main">(</span><span class="bound">α_fin_filter</span> <span class="bound">π</span><span class="main">)</span> <span class="bound">δ_LTS</span><span class="main">,</span> <span class="main">(</span><span class="main">λ</span><span class="bound">χ</span><span class="main">.</span> Set.filter <span class="main">(</span>Acc_inf<span class="hidden">⇩</span><sub>C</sub> <span class="bound">π</span> <span class="bound">χ</span><span class="main">)</span> <span class="bound">δ_LTS</span><span class="main">)</span> <span class="main">`</span> Mapping.keys <span class="bound">π</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">α</span> <span class="main">=</span> <span class="bound">to_pair</span> <span class="main">`</span> <span class="main">(</span>mappings<span class="hidden">⇩</span><sub>C</sub> <span class="free"><span class="bound"><span class="entity">Σ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="comment1">― ‹Multi-thread here!, prove <span class="antiquoted"><span class="raw_text"><span class="operator">‹</span>mappings (set …)›</span></span> equation›</span>
    <span class="keyword1">in</span>
      <span class="main">(</span><span class="bound">δ_LTS</span><span class="main">,</span> initial<span class="hidden">⇩</span><sub>C</sub> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">,</span> <span class="bound">α</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="LTL_Rabin_Impl-mappings"><span class="command">lemma</span></span> mappings<span class="hidden">⇩</span><sub>C</sub>_code<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mappings<span class="hidden">⇩</span><sub>C</sub> <span class="free">Σ</span> <span class="free">φ</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> 
      <span class="bound">Gs</span> <span class="main">=</span> G_list <span class="free">φ</span><span class="main">;</span> 
      <span class="bound">max_rank</span> <span class="main">=</span> Mapping.lookup <span class="main">(</span>Mapping.tabulate <span class="bound">Gs</span> <span class="main">(</span>max_rank_of<span class="hidden">⇩</span><sub>C</sub> <span class="free">Σ</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">in</span> 
      set <span class="main">(</span>concat <span class="main">(</span>map <span class="main">(</span>mapping_generator_list <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> the <span class="main">(</span><span class="bound">max_rank</span> <span class="bound">x</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>subseqs <span class="bound">Gs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl list"</span></span>
    <span class="keyword1"><span class="command">have</span></span> subset_G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>subseqs <span class="main">(</span><span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> set <span class="bound">x</span> <span class="main">⊆</span> set <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> subseqs_powset<span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> subset_G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>subseqs <span class="main">(</span>G_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> set <span class="bound">x</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> G_eq_G_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">{</span><span class="main">{</span><span class="bound">π</span><span class="main">.</span> Mapping.keys <span class="bound">π</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">χ</span><span class="main">∈</span>Mapping.keys <span class="bound">π</span><span class="main">.</span> the <span class="main">(</span>Mapping.lookup <span class="bound">π</span> <span class="bound">χ</span><span class="main">)</span> <span class="main">&lt;</span> max_rank_of<span class="hidden">⇩</span><sub>C</sub> <span class="free">Σ</span> <span class="bound">χ</span><span class="main">)</span><span class="main">}</span> <span class="main">|</span> <span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> set <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>subseqs <span class="main">(</span>G_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mappings<span class="hidden">⇩</span><sub>C</sub>_def G_eq_G_list subseqs_powset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">{</span><span class="main">{</span><span class="bound">π</span><span class="main">.</span> Mapping.keys <span class="bound">π</span> <span class="main">=</span> set <span class="bound">xs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">χ</span> <span class="main">∈</span> set <span class="bound">xs</span><span class="main">.</span> the <span class="main">(</span>Mapping.lookup <span class="bound">π</span> <span class="bound">χ</span><span class="main">)</span> <span class="main">&lt;</span> max_rank_of<span class="hidden">⇩</span><sub>C</sub> <span class="free">Σ</span> <span class="bound">χ</span><span class="main">)</span><span class="main">}</span> <span class="main">|</span>
       <span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> set <span class="main">(</span>subseqs <span class="main">(</span>G_list <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subset_G 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def mapping_generator_code <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
        lookup_tabulate G_eq_G_list <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> mapping_generator_set_eq
        <span class="quasi_keyword">cong</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> SUP_cong_simp<span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LTL_Rabin_Impl-reach_delta_initial"><span class="command">lemma</span></span> reach_delta_initial<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> reach <span class="free">Σ</span> <span class="main">(</span>delta<span class="hidden">⇩</span><sub>C</sub> <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial<span class="hidden">⇩</span><sub>C</sub> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="main">∈</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="free">y</span> <span class="free">χ</span> <span class="main">≠</span> None"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?t1</span></span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>the <span class="main">(</span>Mapping.lookup <span class="free">y</span> <span class="free">χ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?t2</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> y_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> run <span class="main">(</span><span class="keyword1">↑Δ<span class="hidden">⇩</span><sub>×</sub></span> <span class="main">(</span>nxt <span class="free">Σ</span> <span class="free">δ<span class="hidden">⇩</span><sub>M</sub></span> <span class="keyword1">o</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="keyword1">o</span> theG<span class="main">)</span><span class="main">)</span> <span class="main">(</span>Mapping.tabulate <span class="main">(</span>G_list <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>init <span class="keyword1">o</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="keyword1">o</span> theG<span class="main">)</span><span class="main">)</span> <span class="skolem">w</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> reach_def delta<span class="hidden">⇩</span><sub>C</sub>.simps initial<span class="hidden">⇩</span><sub>C</sub>.simps simple_product_run <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> nxt_run_distinct <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?t1</span></span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> y_def <span class="keyword1"><span class="command">using</span></span> product_abs_run_Some<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Mapping.tabulate <span class="main">(</span>G_list <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>init <span class="keyword1">o</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="keyword1">o</span> theG<span class="main">)</span>"</span></span> <span class="quoted"><span class="free">χ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> G_eq_G_list 
    <span class="keyword1"><span class="command">unfolding</span></span> lookup_tabulate <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">with</span></span> nxt_run_distinct <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?t2</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> y_def <span class="keyword1"><span class="command">using</span></span> lookup_tabulate  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> G_eq_G_list assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> comp_eq_dest_lhs option.sel product_abs_run_Some<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Correctness›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">abstract_state</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'x</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'y</span><span class="main">,</span> <span class="tfree">'z</span> list<span class="main">)</span> mapping <span class="main">⇒</span> <span class="tfree">'x</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'y</span> <span class="main">⇀</span> <span class="tfree">'z</span> <span class="main">⇀</span> nat<span class="main">)</span>"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">abstract_state</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="main">(</span>map_option rk<span class="main">)</span> <span class="keyword1">o</span> <span class="main">(</span>Mapping.lookup <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">abstract_transition</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">abstract_transition</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">q'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>abstract_state <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">,</span> abstract_state <span class="free"><span class="bound"><span class="entity">q'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> ltl_to_rabin_base_code <span class="main">=</span> ltl_to_rabin_base <span class="main">+</span> ltl_to_rabin_base_code_def <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> 
    M_fin<span class="hidden">⇩</span><sub>C</sub>_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">t</span> <span class="main">∈</span> reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="main">(</span>delta<span class="hidden">⇩</span><sub>C</sub> <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial<span class="hidden">⇩</span><sub>C</sub> <span class="free">φ</span><span class="main">)</span><span class="main">;</span> dom <span class="free">π</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span><span class="main">⟧</span> <span class="main">⟹</span>
      abstract_transition <span class="free">t</span> <span class="main">∈</span> <span class="free">M_fin</span> <span class="free">π</span> <span class="main">=</span> <span class="free">M_fin<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">φ</span> <span class="main">(</span>Mapping.Mapping <span class="free">π</span><span class="main">)</span> <span class="free">t</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="LTL_Rabin_Impl-finite_reach"><span class="command">lemma</span></span> finite_reach<span class="hidden">⇩</span><sub>C</sub><span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="main">(</span>delta<span class="hidden">⇩</span><sub>C</sub> <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial<span class="hidden">⇩</span><sub>C</sub> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> finite_reach'
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span> <span class="main">⟹</span> finite <span class="main">(</span>reach <span class="free">Σ</span> <span class="main">(</span><span class="main">(</span>nxt <span class="free">Σ</span> <span class="free">δ<span class="hidden">⇩</span><sub>M</sub></span> <span class="keyword1">o</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="keyword1">o</span> theG<span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>init <span class="keyword1">o</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="keyword1">o</span> theG<span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> semi_mojmir.finite_Q<span class="main">[</span><span class="operator">OF</span> semi_mojmir<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> G_eq_G_list semi_mojmir_def.Q<span class="hidden">⇩</span><sub>E</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reach <span class="free">Σ</span> <span class="main">(</span><span class="keyword1">↑Δ<span class="hidden">⇩</span><sub>×</sub></span> <span class="main">(</span>nxt <span class="free">Σ</span> <span class="free">δ<span class="hidden">⇩</span><sub>M</sub></span> <span class="keyword1">o</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="keyword1">o</span> theG<span class="main">)</span><span class="main">)</span> <span class="main">(</span>Mapping.tabulate <span class="main">(</span>G_list <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>init <span class="keyword1">o</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="keyword1">o</span> theG<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> finite_reach_product_abs<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_keys_tabulate<span class="main"><span class="main">]</span></span> G_eq_G_list  keys_tabulate lookup_tabulate_Some<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reach <span class="free">Σ</span> <span class="main">(</span>delta<span class="hidden">⇩</span><sub>C</sub> <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial<span class="hidden">⇩</span><sub>C</sub> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_reach_simple_product <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_Σ <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_reach<span class="hidden">⇩</span><sub>t</sub><span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1" id="LTL_Rabin_Impl-max_rank_of"><span class="command">lemma</span></span> max_rank_of<span class="hidden">⇩</span><sub>C</sub>_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Σ</span> <span class="main">=</span> set <span class="free">Σ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"max_rank_of<span class="hidden">⇩</span><sub>C</sub> <span class="free">Σ'</span> <span class="free">ψ</span> <span class="main">=</span> max_rank_of <span class="free">Σ</span> <span class="free">ψ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> 𝔐<span class="main">:</span> semi_mojmir <span class="quoted"><span class="quoted">"set <span class="free">Σ'</span>"</span></span> <span class="quoted"><span class="free">δ<span class="hidden">⇩</span><sub>M</sub></span></span> <span class="quoted"><span class="quoted">"<span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span>theG <span class="free">ψ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">w</span></span>
    <span class="keyword1"><span class="command">using</span></span> semi_mojmir assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> max_rank_of_def max_rank_of<span class="hidden">⇩</span><sub>C</sub>_def Q<span class="hidden">⇩</span><sub>L</sub>_reach<span class="main">[</span><span class="operator">OF</span> 𝔐.finite_reach<span class="main">]</span> semi_mojmir_def.max_rank_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Set.filter_def set_diff_eq assms<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LTL_Rabin_Impl-reachable_transitions"><span class="command">lemma</span></span> reachable_transitions<span class="hidden">⇩</span><sub>C</sub>_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Σ</span> <span class="main">=</span> set <span class="free">Σ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"reachable_transitions<span class="hidden">⇩</span><sub>C</sub> <span class="free">Σ'</span> <span class="free">φ</span> <span class="main">=</span> reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="main">(</span>delta<span class="hidden">⇩</span><sub>C</sub> <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial<span class="hidden">⇩</span><sub>C</sub> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> reachable_transitions<span class="hidden">⇩</span><sub>C</sub>_def δ<span class="hidden">⇩</span><sub>L</sub>_reach<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_reach<span class="hidden">⇩</span><sub>C</sub><span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">unfolded</span> assms<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> assms<span class="main">)</span>

<span class="keyword1" id="LTL_Rabin_Impl-run_abstraction_correct"><span class="command">lemma</span></span> run_abstraction_correct<span class="main">:</span>
  <span class="quoted"><span class="quoted">"run <span class="main">(</span>delta <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial <span class="free">φ</span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span> abstract_state <span class="keyword1">o</span> <span class="main">(</span>run <span class="main">(</span>delta<span class="hidden">⇩</span><sub>C</sub> <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial<span class="hidden">⇩</span><sub>C</sub> <span class="free">φ</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?δ<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">Δ<span class="hidden">⇩</span><sub>×</sub></span> <span class="main">(</span><span class="main">λ</span><span class="bound">χ</span><span class="main">.</span> semi_mojmir_def.step <span class="free">Σ</span> <span class="free">δ<span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q<span class="hidden">⇩</span><sub>2</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ι<span class="hidden">⇩</span><sub>×</sub></span> <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">χ</span><span class="main">.</span> semi_mojmir_def.initial <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?δ<span class="hidden">⇩</span><sub>2</sub>'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">↑Δ<span class="hidden">⇩</span><sub>×</sub></span> <span class="main">(</span>nxt <span class="free">Σ</span> <span class="free">δ<span class="hidden">⇩</span><sub>M</sub></span> <span class="keyword1">o</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="keyword1">o</span> theG<span class="main">)</span>"</span></span>    
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q<span class="hidden">⇩</span><sub>2</sub>'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Mapping.tabulate <span class="main">(</span>G_list <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>init <span class="keyword1">o</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="keyword1">o</span> theG<span class="main">)</span>"</span></span>
    
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∉</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?q<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">q</span> <span class="main">=</span> None"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span>run <span class="var">?δ<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="var">?q<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="free">w</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">=</span> None"</span></span>
        <span class="keyword1"><span class="command">using</span></span> G_eq_G_list product_abs_run_None <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> domIff keys_dom_lookup keys_tabulate<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"run <span class="var">?δ<span class="hidden">⇩</span><sub>2</sub></span> <span class="var">?q<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">w</span> <span class="skolem">i</span> <span class="skolem">q</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="main">(</span>map_option rk<span class="main">)</span> <span class="keyword1">o</span> <span class="main">(</span>Mapping.lookup <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>run <span class="var">?δ<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="var">?q<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="free">w</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">q</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> product_run_None <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> nxt.simps rk.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>

    <span class="keyword1"><span class="command">moreover</span></span> 

    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="skolem">j</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> init<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?q<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">q</span> <span class="main">=</span> Some <span class="main">(</span>semi_mojmir_def.initial <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span>theG <span class="skolem">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="main">(</span>run <span class="var">?δ<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="var">?q<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="free">w</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">=</span> Some <span class="main">(</span>run <span class="main">(</span><span class="main">(</span>nxt <span class="free">Σ</span> <span class="free">δ<span class="hidden">⇩</span><sub>M</sub></span> <span class="main">∘</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="main">∘</span> theG<span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>init <span class="main">∘</span> <span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="main">∘</span> theG<span class="main">)</span> <span class="skolem">q</span><span class="main">)</span> <span class="free">w</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> nxt.simps<span class="main">)</span>  
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> G_eq_G_list <span class="quoted"><span class="quoted">‹<span class="skolem">q</span> <span class="main">∈</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>›</span></span> lookup_tabulate product_abs_run_Some<span class="main">)</span> 
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"run <span class="var">?δ<span class="hidden">⇩</span><sub>2</sub></span> <span class="var">?q<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">w</span> <span class="skolem">i</span> <span class="skolem">q</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="main">(</span>map_option rk<span class="main">)</span> <span class="keyword1">o</span> <span class="main">(</span>Mapping.lookup <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>run <span class="var">?δ<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="var">?q<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="free">w</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">q</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> product_run_Some<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ι<span class="hidden">⇩</span><sub>×</sub></span> <span class="main">(</span><span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">χ</span><span class="main">.</span> semi_mojmir_def.initial <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">,</span> <span class="operator">OF</span> init<span class="main">]</span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> product.simps nxt.simps rk.simps<span class="main"><span class="keyword3">;</span></span> <span class="operator">unfold</span> map_of_map semi_mojmir.nxt_run_step_run<span class="main"><span class="main">[</span></span><span class="operator">OF</span> semi_mojmir<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span> 
    <span class="keyword1"><span class="command">}</span></span>

    <span class="keyword1"><span class="command">ultimately</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"run <span class="var">?δ<span class="hidden">⇩</span><sub>2</sub></span> <span class="var">?q<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">w</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> <span class="main">(</span>map_option rk<span class="main">)</span> <span class="keyword1">o</span> <span class="main">(</span>Mapping.lookup <span class="bound">m</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>run <span class="var">?δ<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="var">?q<span class="hidden">⇩</span><sub>2</sub>'</span> <span class="free">w</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> run <span class="main">(</span>delta <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial <span class="free">φ</span><span class="main">)</span> <span class="free">w</span> <span class="bound">i</span> <span class="main">=</span> abstract_state <span class="main">(</span>run <span class="main">(</span>delta<span class="hidden">⇩</span><sub>C</sub> <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial<span class="hidden">⇩</span><sub>C</sub> <span class="free">φ</span><span class="main">)</span> <span class="free">w</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_Σ bounded_w <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simple_product_run comp_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> simple_product.simps<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="main">(</span>delta<span class="hidden">⇩</span><sub>C</sub> <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial<span class="hidden">⇩</span><sub>C</sub> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">χ</span> <span class="main">∈</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> Acc_fin<span class="hidden">⇩</span><sub>C</sub>_correct<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"abstract_transition <span class="free">t</span> <span class="main">∈</span> Acc_fin <span class="free">Σ</span> <span class="free">π</span> <span class="free">χ</span> <span class="main">⟷</span> Acc_fin<span class="hidden">⇩</span><sub>C</sub> <span class="free">Σ</span> <span class="main">(</span>Mapping.Mapping <span class="free">π</span><span class="main">)</span> <span class="free">χ</span> <span class="free">t</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?t1</span></span></span><span class="main">)</span>
    <span class="keyword2"><span class="keyword">and</span></span> Acc_inf<span class="hidden">⇩</span><sub>C</sub>_correct<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"abstract_transition <span class="free">t</span> <span class="main">∈</span> Acc_inf <span class="free">π</span> <span class="free">χ</span> <span class="main">⟷</span> Acc_inf<span class="hidden">⇩</span><sub>C</sub> <span class="main">(</span>Mapping.Mapping <span class="free">π</span><span class="main">)</span> <span class="free">χ</span> <span class="free">t</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?t2</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">ν</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="skolem"><span class="skolem">z'</span></span> <span class="keyword2"><span class="keyword">where</span></span> t_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ν</span><span class="main">,</span> <span class="main">(</span><span class="skolem">z</span><span class="main">,</span> <span class="skolem">z'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.collapse<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> reach <span class="free">Σ</span> <span class="main">(</span>delta<span class="hidden">⇩</span><sub>C</sub> <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial<span class="hidden">⇩</span><sub>C</sub> <span class="free">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">z</span><span class="main">,</span> <span class="skolem">z'</span><span class="main">)</span> <span class="main">∈</span> reach <span class="free">Σ</span> <span class="main">(</span>delta<span class="hidden">⇩</span><sub>C</sub> <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial<span class="hidden">⇩</span><sub>C</sub> <span class="free">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> reach<span class="hidden">⇩</span><sub>t</sub>_def reach_def run<span class="hidden">⇩</span><sub>t</sub>.simps t_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="skolem"><span class="skolem">m'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">y</span> <span class="free">χ</span> <span class="main">=</span> Some <span class="skolem">m</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">y</span> <span class="free">χ</span> <span class="main">≠</span> None"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.lookup <span class="skolem">z'</span> <span class="free">χ</span> <span class="main">=</span> Some <span class="skolem">m'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> reach_delta_initial<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">have</span></span> FF <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"fail_filt <span class="free">Σ</span> <span class="free">δ<span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span>theG <span class="free">χ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ltl_prop_entails_abs <span class="main">(</span>dom <span class="free">π</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span>Mapping.lookup <span class="skolem">y</span> <span class="free">χ</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ν</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> 
    <span class="main">=</span> <span class="main">(</span><span class="main">(</span>the <span class="main">(</span>map_option rk <span class="main">(</span>Mapping.lookup <span class="skolem">y</span> <span class="free">χ</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ν</span><span class="main">,</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Some <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> mojmir_to_rabin_def.fail<span class="hidden">⇩</span><sub>R</sub> <span class="free">Σ</span> <span class="free">δ<span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span>theG <span class="free">χ</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> dom <span class="free">π</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">q</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> option.map_sel<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Mapping.lookup <span class="skolem">y</span> <span class="free">χ</span> <span class="main">≠</span> None›</span></span><span class="main">]</span> fail_filt_eq<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  

  <span class="keyword1"><span class="command">have</span></span> MF <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> merge_filt <span class="free">δ<span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span>theG <span class="free">χ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ltl_prop_entails_abs <span class="main">(</span>dom <span class="free">π</span><span class="main">)</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>the <span class="main">(</span>Mapping.lookup <span class="skolem">y</span> <span class="free">χ</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ν</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>
    <span class="main">=</span> <span class="main">(</span><span class="main">(</span>the <span class="main">(</span>map_option rk <span class="main">(</span>Mapping.lookup <span class="skolem">y</span> <span class="free">χ</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ν</span><span class="main">,</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Some <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> mojmir_to_rabin_def.merge<span class="hidden">⇩</span><sub>R</sub> <span class="free">δ<span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span>theG <span class="free">χ</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> dom <span class="free">π</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">q</span><span class="main">}</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> option.map_sel<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Mapping.lookup <span class="skolem">y</span> <span class="free">χ</span> <span class="main">≠</span> None›</span></span><span class="main">]</span> merge_filt_eq<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  

  <span class="keyword1"><span class="command">have</span></span> SF <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> succeed_filt <span class="free">δ<span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span>theG <span class="free">χ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>ltl_prop_entails_abs <span class="main">(</span>dom <span class="free">π</span><span class="main">)</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>the <span class="main">(</span>Mapping.lookup <span class="skolem">y</span> <span class="free">χ</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ν</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>
    <span class="main">=</span> <span class="main">(</span><span class="main">(</span>the <span class="main">(</span>map_option rk <span class="main">(</span>Mapping.lookup <span class="skolem">y</span> <span class="free">χ</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ν</span><span class="main">,</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Some <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> mojmir_to_rabin_def.succeed<span class="hidden">⇩</span><sub>R</sub> <span class="free">δ<span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span><span class="free">q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span>theG <span class="free">χ</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> dom <span class="free">π</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="bound">q</span><span class="main">}</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> option.map_sel<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Mapping.lookup <span class="skolem">y</span> <span class="free">χ</span> <span class="main">≠</span> None›</span></span><span class="main">]</span> succeed_filt_eq<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  

  <span class="keyword1"><span class="command">note</span></span> mojmir_to_rabin_def.fail<span class="hidden">⇩</span><sub>R</sub>_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> 
  <span class="keyword1"><span class="command">note</span></span> mojmir_to_rabin_def.merge<span class="hidden">⇩</span><sub>R</sub>_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> mojmir_to_rabin_def.succeed<span class="hidden">⇩</span><sub>R</sub>_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?t1</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?t2</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def keys.abs_eq lookup.abs_eq <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> rk.simps<span class="main">)</span> 
       <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">metis</span> option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> option.sel option.collapse rk_facts<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">theorem</span></span> ltl_to_generalized_rabin<span class="hidden">⇩</span><sub>C</sub>_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Σ</span> <span class="main">=</span> set <span class="free">Σ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>ltl_to_generalized_rabin <span class="free">Σ</span> <span class="free">φ</span><span class="main">)</span> <span class="free">w</span> <span class="main">⟷</span> accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_LTS <span class="main">(</span>ltl_to_generalized_rabin<span class="hidden">⇩</span><sub>C</sub> <span class="free">Σ'</span> <span class="free">φ</span><span class="main">)</span> <span class="free">w</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?δ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"delta <span class="free">Σ</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"initial <span class="free">φ</span>"</span></span>
 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?δ<span class="hidden">⇩</span><sub>C</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"delta<span class="hidden">⇩</span><sub>C</sub> <span class="free">Σ</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>C</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"initial<span class="hidden">⇩</span><sub>C</sub> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?reach<span class="hidden">⇩</span><sub>C</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="main">(</span>delta<span class="hidden">⇩</span><sub>C</sub> <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial<span class="hidden">⇩</span><sub>C</sub> <span class="free">φ</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">note</span></span> reachable_transitions<span class="hidden">⇩</span><sub>C</sub>_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> reachable_transitions<span class="hidden">⇩</span><sub>C</sub>_eq<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> 
  <span class="keyword1"><span class="command">note</span></span> max_rank_of<span class="hidden">⇩</span><sub>C</sub>_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> max_rank_of<span class="hidden">⇩</span><sub>C</sub>_eq<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">π</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl <span class="main">⇒</span> nat option"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> π_wellformed<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">π</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>"</span></span>
       
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?F</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M_fin</span> <span class="skolem">π</span> <span class="main">∪</span> <span class="main">⋃</span><span class="main">{</span>Acc_fin <span class="free">Σ</span> <span class="skolem">π</span> <span class="bound">χ</span> <span class="main">|</span> <span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span>Acc_inf <span class="skolem">π</span> <span class="bound">χ</span> <span class="main">|</span> <span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?fin</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">t</span><span class="main">.</span> <span class="free">M_fin<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">φ</span> <span class="main">(</span>Mapping.Mapping <span class="skolem">π</span><span class="main">)</span> <span class="bound">t</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">t</span><span class="main">.</span> <span class="main">∃</span><span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π</span><span class="main">.</span> Acc_fin<span class="hidden">⇩</span><sub>C</sub> <span class="free">Σ</span> <span class="main">(</span>Mapping.Mapping <span class="skolem">π</span><span class="main">)</span> <span class="bound">χ</span> <span class="bound">t</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?inf</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">{</span><span class="bound">t</span><span class="main">.</span> Acc_inf<span class="hidden">⇩</span><sub>C</sub> <span class="main">(</span>Mapping.Mapping <span class="skolem">π</span><span class="main">)</span> <span class="bound">χ</span> <span class="bound">t</span><span class="main">}</span> <span class="main">|</span> <span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π</span><span class="main">}</span>"</span></span>
    
    <span class="keyword1"><span class="command">have</span></span> finite_reach'<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="main">(</span>delta <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> finite_reach finite_Σ finite_reach<span class="hidden">⇩</span><sub>t</sub><span class="main">)</span> 

    <span class="keyword1"><span class="command">have</span></span> run_abstraction_correct'<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"run<span class="hidden">⇩</span><sub>t</sub> <span class="main">(</span>delta <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial <span class="free">φ</span><span class="main">)</span> <span class="free">w</span> <span class="main">=</span> abstract_transition <span class="keyword1">o</span> <span class="main">(</span>run<span class="hidden">⇩</span><sub>t</sub> <span class="main">(</span>delta<span class="hidden">⇩</span><sub>C</sub> <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial<span class="hidden">⇩</span><sub>C</sub> <span class="free">φ</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> run_abstraction_correct comp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub> <span class="var">?δ</span> <span class="var">?q<span class="hidden">⇩</span><sub>0</sub></span> <span class="var">?F</span> <span class="free">w</span> <span class="main">⟷</span> accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub> <span class="var">?δ<span class="hidden">⇩</span><sub>C</sub></span>  <span class="var">?q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>C</sub></span> <span class="main">(</span><span class="var">?fin</span><span class="main">,</span> <span class="var">?inf</span><span class="main">)</span> <span class="free">w</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">⟷</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_abstract<span class="main"><span class="main">[</span></span><span class="operator">OF</span> finite_reach' finite_reach<span class="hidden">⇩</span><sub>C</sub> bounded_w<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span>
          <span class="operator">insert</span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">π</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>›</span></span> M_fin<span class="hidden">⇩</span><sub>C</sub>_correct Acc_fin<span class="hidden">⇩</span><sub>C</sub>_correct Acc_inf<span class="hidden">⇩</span><sub>C</sub>_correct run_abstraction_correct'<span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_LTS <span class="var">?reach<span class="hidden">⇩</span><sub>C</sub></span> <span class="var">?q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>C</sub></span> <span class="main">(</span><span class="var">?fin</span> <span class="main">∩</span> <span class="var">?reach<span class="hidden">⇩</span><sub>C</sub></span><span class="main">,</span> <span class="main">(</span><span class="main">λ</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="main">∩</span> <span class="var">?reach<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">`</span> <span class="var">?inf</span><span class="main">)</span> <span class="free">w</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟷</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> bounded_w <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_LTS<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_restrict<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">⟷</span> <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span>
 
  <span class="keyword1"><span class="command">note</span></span> X <span class="main">=</span> this

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">π</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π</span> <span class="main">⟹</span> the <span class="main">(</span><span class="skolem">π</span> <span class="bound">χ</span><span class="main">)</span> <span class="main">&lt;</span> max_rank_of <span class="free">Σ</span> <span class="bound">χ</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>delta <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial <span class="free">φ</span><span class="main">)</span> <span class="main">(</span><span class="free">M_fin</span> <span class="skolem">π</span> <span class="main">∪</span> <span class="main">⋃</span><span class="main">{</span>Acc_fin <span class="free">Σ</span> <span class="skolem">π</span> <span class="bound">χ</span> <span class="main">|</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span>Acc_inf <span class="skolem">π</span> <span class="bound">χ</span> <span class="main">|</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π</span><span class="main">}</span><span class="main">)</span> <span class="free">w</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">π'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π'</span> <span class="main">=</span> Mapping.Mapping <span class="skolem">π</span>"</span></span>
    
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">π</span> <span class="main">=</span> Mapping.keys <span class="skolem">π'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="main">=</span> Mapping.lookup <span class="skolem">π'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> keys.abs_eq lookup.abs_eq π'_def<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> acc_pair_LTS<span class="main">:</span> <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_LTS <span class="var">?reach<span class="hidden">⇩</span><sub>C</sub></span> <span class="var">?q<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>C</sub></span> <span class="main">(</span><span class="main">(</span><span class="main">{</span><span class="bound">t</span><span class="main">.</span> <span class="free">M_fin<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">φ</span> <span class="skolem">π'</span> <span class="bound">t</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">t</span><span class="main">.</span> <span class="main">∃</span><span class="bound">χ</span> <span class="main">∈</span> Mapping.keys <span class="skolem">π'</span><span class="main">.</span> Acc_fin<span class="hidden">⇩</span><sub>C</sub> <span class="free">Σ</span> <span class="skolem">π'</span> <span class="bound">χ</span> <span class="bound">t</span><span class="main">}</span><span class="main">)</span> <span class="main">∩</span> <span class="var">?reach<span class="hidden">⇩</span><sub>C</sub></span><span class="main">,</span>
        <span class="main">(</span><span class="main">λ</span><span class="bound">I</span><span class="main">.</span> <span class="bound">I</span> <span class="main">∩</span> <span class="var">?reach<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">{</span><span class="bound">t</span><span class="main">.</span> Acc_inf<span class="hidden">⇩</span><sub>C</sub> <span class="skolem">π'</span> <span class="bound">χ</span> <span class="bound">t</span><span class="main">}</span> <span class="main">|</span> <span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> Mapping.keys <span class="skolem">π'</span><span class="main">}</span><span class="main">)</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">unfolding</span></span> X<span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">π</span> <span class="main">=</span> Mapping.keys <span class="skolem">π'</span>›</span></span> π'_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">unfold</span> ltl_to_generalized_rabin<span class="hidden">⇩</span><sub>C</sub>.simps Let_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_LTS_I<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> acc_pair_LTS<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> mappings<span class="hidden">⇩</span><sub>C</sub>_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">insert</span> 1 2<span class="main"><span class="keyword3">;</span></span> <span class="operator">unfold</span>  <span class="quoted"><span class="quoted">‹dom <span class="skolem">π</span> <span class="main">=</span> Mapping.keys <span class="skolem">π'</span>›</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">unfold</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="main">=</span> Mapping.lookup <span class="skolem">π'</span>›</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> Set.filter_def image_def mappings<span class="hidden">⇩</span><sub>C</sub>_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  
  <span class="keyword1"><span class="command">moreover</span></span> 

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Fin</span></span> <span class="skolem"><span class="skolem">Inf</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Fin</span><span class="main">,</span> <span class="skolem">Inf</span><span class="main">)</span> <span class="main">∈</span> snd <span class="main">(</span>snd <span class="main">(</span>ltl_to_generalized_rabin<span class="hidden">⇩</span><sub>C</sub> <span class="free">Σ'</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_LTS <span class="var">?reach<span class="hidden">⇩</span><sub>C</sub></span> <span class="main">(</span>initial<span class="hidden">⇩</span><sub>C</sub> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Fin</span><span class="main">,</span> <span class="skolem">Inf</span><span class="main">)</span> <span class="free">w</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_LTS_E<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="var">?rhs</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def assms <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_LTS.simps<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π</span></span> <span class="keyword2"><span class="keyword">where</span></span> Y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Fin</span><span class="main">,</span> <span class="skolem">Inf</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Set.filter <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free">M_fin<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">φ</span> <span class="skolem">π</span> <span class="bound">t</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">χ</span> <span class="main">∈</span> Mapping.keys <span class="skolem">π</span><span class="main">.</span> Acc_fin<span class="hidden">⇩</span><sub>C</sub> <span class="free">Σ</span> <span class="skolem">π</span> <span class="bound">χ</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="var">?reach<span class="hidden">⇩</span><sub>C</sub></span><span class="main">,</span>
        <span class="main">(</span><span class="main">λ</span><span class="bound">χ</span><span class="main">.</span> Set.filter <span class="main">(</span>Acc_inf<span class="hidden">⇩</span><sub>C</sub> <span class="skolem">π</span> <span class="bound">χ</span><span class="main">)</span> <span class="var">?reach<span class="hidden">⇩</span><sub>C</sub></span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>Mapping.keys <span class="skolem">π</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"Mapping.keys <span class="skolem">π</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> Mapping.keys <span class="skolem">π</span> <span class="main">⟹</span> the <span class="main">(</span>Mapping.lookup <span class="skolem">π</span> <span class="bound">χ</span><span class="main">)</span> <span class="main">&lt;</span> max_rank_of <span class="free">Σ</span> <span class="bound">χ</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ltl_to_generalized_rabin<span class="hidden">⇩</span><sub>C</sub>.simps Let_def fst_conv snd_conv mappings<span class="hidden">⇩</span><sub>C</sub>_def assms reachable_transitions<span class="hidden">⇩</span><sub>C</sub>_simp max_rank_of<span class="hidden">⇩</span><sub>C</sub>_simp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">π'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π'</span> <span class="main">=</span> Mapping.rep <span class="skolem">π</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dom <span class="skolem">π'</span> <span class="main">=</span> Mapping.keys <span class="skolem">π</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Mapping.Mapping <span class="skolem">π'</span> <span class="main">=</span> <span class="skolem">π</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> π'_def mapping.rep_inverse keys.rep_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"dom <span class="skolem">π'</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π'</span> <span class="main">⟹</span> the <span class="main">(</span><span class="skolem">π'</span> <span class="bound">χ</span><span class="main">)</span> <span class="main">&lt;</span> max_rank_of <span class="free">Σ</span> <span class="bound">χ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">unfolding</span></span>  π'_def Mapping.keys.rep_eq Mapping.mapping.rep_inverse <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup.rep_eq<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="main">(</span>delta<span class="hidden">⇩</span><sub>C</sub> <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial<span class="hidden">⇩</span><sub>C</sub> <span class="free">φ</span><span class="main">)</span><span class="main">.</span> <span class="free">M_fin<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">φ</span> <span class="skolem">π</span> <span class="bound">a</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">χ</span><span class="main">∈</span>Mapping.keys <span class="skolem">π</span><span class="main">.</span> Acc_fin<span class="hidden">⇩</span><sub>C</sub> <span class="free">Σ</span> <span class="skolem">π</span> <span class="bound">χ</span> <span class="bound">a</span><span class="main">)</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">∈</span>Mapping.keys <span class="skolem">π</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="main">(</span>delta<span class="hidden">⇩</span><sub>C</sub> <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial<span class="hidden">⇩</span><sub>C</sub> <span class="free">φ</span><span class="main">)</span><span class="main">.</span> Acc_inf<span class="hidden">⇩</span><sub>C</sub> <span class="skolem">π</span> <span class="bound">x</span> <span class="bound">a</span><span class="main">}</span><span class="main">}</span><span class="main">)</span>
      <span class="main">=</span> <span class="main">(</span><span class="main">(</span>Collect <span class="main">(</span><span class="free">M_fin<span class="hidden">⇩</span><sub>C</sub></span> <span class="free">φ</span> <span class="skolem">π</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">t</span><span class="main">.</span> <span class="main">∃</span><span class="bound">χ</span><span class="main">∈</span>Mapping.keys <span class="skolem">π</span><span class="main">.</span> Acc_fin<span class="hidden">⇩</span><sub>C</sub> <span class="free">Σ</span> <span class="skolem">π</span> <span class="bound">χ</span> <span class="bound">t</span><span class="main">}</span><span class="main">)</span> <span class="main">∩</span> reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="main">(</span>delta<span class="hidden">⇩</span><sub>C</sub> <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial<span class="hidden">⇩</span><sub>C</sub> <span class="free">φ</span><span class="main">)</span><span class="main">,</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="main">{</span>Collect <span class="main">(</span>Acc_inf<span class="hidden">⇩</span><sub>C</sub> <span class="skolem">π</span> <span class="bound">χ</span><span class="main">)</span> <span class="main">|</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> Mapping.keys <span class="skolem">π</span><span class="main">}</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">∩</span> reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="main">(</span>delta<span class="hidden">⇩</span><sub>C</sub> <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial<span class="hidden">⇩</span><sub>C</sub> <span class="free">φ</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"accepting_pair<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>delta <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>initial <span class="free">φ</span><span class="main">)</span> <span class="main">(</span><span class="free">M_fin</span> <span class="skolem">π'</span> <span class="main">∪</span> <span class="main">⋃</span><span class="main">{</span>Acc_fin <span class="free">Σ</span> <span class="skolem">π'</span> <span class="bound">χ</span> <span class="main">|</span> <span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π'</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span>Acc_inf <span class="skolem">π'</span> <span class="bound">χ</span> <span class="main">|</span> <span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="skolem">π'</span><span class="main">}</span><span class="main">)</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> X<span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">unfolding</span></span> Y Set.filter_def <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹dom <span class="skolem">π'</span> <span class="main">=</span> Mapping.keys <span class="skolem">π</span>›</span></span> <span class="quoted"><span class="quoted">‹Mapping.Mapping <span class="skolem">π'</span> <span class="main">=</span> <span class="skolem">π</span>›</span></span> image_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>    
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span>  
      <span class="keyword1"><span class="command">unfolding</span></span> ltl_to_generalized_rabin.simps
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Rabin.accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_I<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">}</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> 

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Generalized Deterministic Rabin Automaton (af)›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">M_fin<span class="hidden">⇩</span><sub>C</sub>_af_lhs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> ltl<span class="main">,</span> nat<span class="main">)</span> mapping <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> ltl<span class="main">,</span> <span class="main">(</span><span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub> list<span class="main">)</span><span class="main">)</span> mapping <span class="main">⇒</span> <span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">M_fin<span class="hidden">⇩</span><sub>C</sub>_af_lhs</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="main">≡</span> 
    <span class="keyword1">let</span>
      <span class="bound">𝒢</span> <span class="main">=</span> Mapping.keys <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">;</span>
      <span class="bound">𝒢<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">𝒢</span><span class="main">)</span> <span class="main">(</span>G_list <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">;</span>
      <span class="bound">mk_conj</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">χ</span><span class="main">.</span> foldl and_abs <span class="main">(</span>Abs <span class="bound">χ</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="keyword1">↑eval<span class="hidden">⇩</span><sub>G</sub></span> <span class="bound">𝒢</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>the <span class="main">(</span>Mapping.lookup <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="bound">χ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span>Mapping.lookup <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="bound">χ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">in</span> 
      <span class="keyword1">↑And</span> <span class="main">(</span>map <span class="bound">mk_conj</span> <span class="bound">𝒢<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">M_fin<span class="hidden">⇩</span><sub>C</sub>_af</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> ltl<span class="main">,</span> nat<span class="main">)</span> mapping <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub> <span class="main">×</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> ltl<span class="main">,</span> <span class="main">(</span><span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub> list<span class="main">)</span><span class="main">)</span> mapping<span class="main">)</span><span class="main">,</span> <span class="tfree">'a</span> set<span class="main">)</span> transition <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">M_fin<span class="hidden">⇩</span><sub>C</sub>_af</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> Not <span class="main">(</span><span class="main">(</span>M_fin<span class="hidden">⇩</span><sub>C</sub>_af_lhs <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">)</span> <span class="keyword1">↑⟶<span class="hidden">⇩</span><sub>P</sub></span>  <span class="free"><span class="bound"><span class="entity">φ'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="LTL_Rabin_Impl-M_fin"><span class="command">lemma</span></span> M_fin<span class="hidden">⇩</span><sub>C</sub>_af_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="main">(</span>ltl_to_rabin_base_code_def.delta<span class="hidden">⇩</span><sub>C</sub> <span class="keyword1">↑af</span> <span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub></span> Abs <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>ltl_to_rabin_base_code_def.initial<span class="hidden">⇩</span><sub>C</sub> Abs Abs <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dom <span class="free">π</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"abstract_transition <span class="free">t</span> <span class="main">∈</span> M_fin <span class="free">π</span> <span class="main">=</span> M_fin<span class="hidden">⇩</span><sub>C</sub>_af <span class="free">φ</span> <span class="main">(</span>Mapping.Mapping <span class="free">π</span><span class="main">)</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?delta</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"ltl_to_rabin_base_code_def.delta<span class="hidden">⇩</span><sub>C</sub> <span class="keyword1">↑af</span> <span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub></span> Abs <span class="free">Σ</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?initial</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"ltl_to_rabin_base_code_def.initial<span class="hidden">⇩</span><sub>C</sub> Abs Abs <span class="free">φ</span>"</span></span>
  
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">ν</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="skolem"><span class="skolem">z'</span></span> <span class="keyword2"><span class="keyword">where</span></span> t_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ν</span><span class="main">,</span> <span class="main">(</span><span class="skolem">z</span><span class="main">,</span> <span class="skolem">z'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.collapse<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> reach <span class="free">Σ</span> <span class="var">?delta</span> <span class="var">?initial</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach<span class="hidden">⇩</span><sub>t</sub>_def reach_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> N1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="free">π</span> <span class="main">⟹</span> Mapping.lookup <span class="skolem">y</span> <span class="bound">χ</span> <span class="main">≠</span> None"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> D1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="free">π</span> <span class="main">⟹</span> distinct <span class="main">(</span>the <span class="main">(</span>Mapping.lookup <span class="skolem">y</span> <span class="bound">χ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ltl_to_rabin_base_code_def.reach_delta_initial<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">χ</span><span class="main">.</span> map_option rk <span class="main">(</span>Mapping.lookup <span class="skolem">y</span> <span class="bound">χ</span><span class="main">)</span>"</span></span>
    
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">χ</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">χ</span> <span class="main">∈</span> dom <span class="free">π</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">(</span>foldl and_abs <span class="main">(</span>Abs <span class="skolem">χ</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="keyword1">↑eval<span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span>dom <span class="free">π</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>the <span class="main">(</span><span class="free">π</span> <span class="skolem">χ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span>Mapping.lookup <span class="skolem">y</span> <span class="skolem">χ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
         <span class="main">⟷</span> <span class="skolem">S</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">(</span>Abs <span class="skolem">χ</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> the <span class="main">(</span><span class="free">π</span> <span class="skolem">χ</span><span class="main">)</span><span class="main">.</span> the <span class="main">(</span><span class="var">?m'</span> <span class="skolem">χ</span><span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">S</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword1">↑eval<span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span>dom <span class="free">π</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> D1<span class="main">[</span><span class="operator">THEN</span> drop_rk<span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="free">π</span> <span class="skolem">χ</span><span class="main">)</span>"</span></span><span class="main">]</span> N1<span class="main">[</span><span class="operator">THEN</span> option.map_sel<span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted">rk</span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> foldl_LTLAnd_prop_entailment_abs<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>

    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">(</span>M_fin<span class="hidden">⇩</span><sub>C</sub>_af_lhs <span class="free">φ</span> <span class="main">(</span>Mapping.Mapping <span class="free">π</span><span class="main">)</span> <span class="skolem">y</span><span class="main">)</span>
      <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">χ</span> <span class="main">∈</span> dom <span class="free">π</span><span class="main">.</span> <span class="skolem">S</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">(</span>Abs <span class="bound">χ</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> the <span class="main">(</span><span class="free">π</span> <span class="bound">χ</span><span class="main">)</span><span class="main">.</span> the <span class="main">(</span><span class="var">?m'</span> <span class="bound">χ</span><span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">S</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword1">↑eval<span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span>dom <span class="free">π</span><span class="main">)</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> M_fin<span class="hidden">⇩</span><sub>C</sub>_af_lhs_def Let_def And_prop_entailment_abs set_map Ball_def keys.abs_eq lookup.abs_eq 
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def inter_set_filter<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> G_eq_G_list<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ltl_prop_implies_def ltl_prop_implies_abs_def ltl_prop_entails_abs_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">ltl_to_generalized_rabin<span class="hidden">⇩</span><sub>C</sub>_af</span> <span class="main">≡</span> ltl_to_rabin_base_code_def.ltl_to_generalized_rabin<span class="hidden">⇩</span><sub>C</sub> <span class="keyword1">↑af</span> <span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub></span> Abs Abs M_fin<span class="hidden">⇩</span><sub>C</sub>_af"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> ltl_to_generalized_rabin<span class="hidden">⇩</span><sub>C</sub>_af_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"range <span class="free">w</span> <span class="main">⊆</span> set <span class="free">Σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span> <span class="main">⟷</span> accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_LTS <span class="main">(</span>ltl_to_generalized_rabin<span class="hidden">⇩</span><sub>C</sub>_af <span class="free">Σ</span> <span class="free">φ</span><span class="main">)</span> <span class="free">w</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"ltl_to_rabin_base_code <span class="keyword1">↑af</span> <span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub></span> Abs Abs M_fin <span class="main">(</span>set <span class="free">Σ</span><span class="main">)</span> <span class="free">w</span> M_fin<span class="hidden">⇩</span><sub>C</sub>_af"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ltl_to_generalized_rabin_af_wellformed<span class="main">[</span><span class="operator">OF</span> finite_set assms<span class="main">]</span> M_fin<span class="hidden">⇩</span><sub>C</sub>_af_correct assms
    <span class="keyword1"><span class="command">unfolding</span></span> ltl_to_rabin_af_def ltl_to_rabin_base_code_def ltl_to_rabin_base_code_axioms_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>ltl_to_generalized_rabin_af <span class="main">(</span>set <span class="free">Σ</span><span class="main">)</span> <span class="free">φ</span><span class="main">)</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms ltl_to_generalized_rabin_af_correct <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ltl_to_rabin_base_code.ltl_to_generalized_rabin<span class="hidden">⇩</span><sub>C</sub>_correct<span class="main">[</span><span class="operator">OF</span> X<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> ltl_to_generalized_rabin<span class="hidden">⇩</span><sub>C</sub>_af_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Generalized Deterministic Rabin Automaton (eager af)›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">M_fin<span class="hidden">⇩</span><sub>C</sub>_af<span class="hidden">⇩</span><sub>𝔘</sub>_lhs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> ltl<span class="main">,</span> nat<span class="main">)</span> mapping <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> ltl<span class="main">,</span> <span class="main">(</span><span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub> list<span class="main">)</span><span class="main">)</span> mapping <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">M_fin<span class="hidden">⇩</span><sub>C</sub>_af<span class="hidden">⇩</span><sub>𝔘</sub>_lhs</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">≡</span> 
    <span class="keyword1">let</span>
      <span class="bound">𝒢</span> <span class="main">=</span> Mapping.keys <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">;</span>
      <span class="bound">𝒢<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">𝒢</span><span class="main">)</span> <span class="main">(</span>G_list <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">;</span>
      <span class="bound">mk_conj</span> <span class="main">=</span> <span class="main">λ</span><span class="bound">χ</span><span class="main">.</span> foldl and_abs <span class="main">(</span>and_abs <span class="main">(</span>Abs <span class="bound">χ</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">↑eval<span class="hidden">⇩</span><sub>G</sub></span> <span class="bound">𝒢</span> <span class="main">(</span>Abs <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="keyword1">↑eval<span class="hidden">⇩</span><sub>G</sub></span> <span class="bound">𝒢</span> <span class="keyword1">o</span> <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="keyword1">↑step</span> <span class="bound">q</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>the <span class="main">(</span>Mapping.lookup <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="bound">χ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span>Mapping.lookup <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="bound">χ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">in</span> 
      <span class="keyword1">↑And</span> <span class="main">(</span>map <span class="bound">mk_conj</span> <span class="bound">𝒢<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">M_fin<span class="hidden">⇩</span><sub>C</sub>_af<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ltl <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> ltl<span class="main">,</span> nat<span class="main">)</span> mapping <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub> <span class="main">×</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> ltl<span class="main">,</span> <span class="main">(</span><span class="tfree">'a</span> ltl<span class="hidden">⇩</span><sub>P</sub> list<span class="main">)</span><span class="main">)</span> mapping<span class="main">)</span><span class="main">,</span> <span class="tfree">'a</span> set<span class="main">)</span> transition <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">M_fin<span class="hidden">⇩</span><sub>C</sub>_af<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> Not <span class="main">(</span><span class="main">(</span>M_fin<span class="hidden">⇩</span><sub>C</sub>_af<span class="hidden">⇩</span><sub>𝔘</sub>_lhs <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">m'</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span> <span class="keyword1">↑⟶<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">(</span><span class="keyword1">↑step</span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="LTL_Rabin_Impl-M_fin"><span class="command">lemma</span></span> M_fin<span class="hidden">⇩</span><sub>C</sub>_af<span class="hidden">⇩</span><sub>𝔘</sub>_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> reach<span class="hidden">⇩</span><sub>t</sub> <span class="free">Σ</span> <span class="main">(</span>ltl_to_rabin_base_code_def.delta<span class="hidden">⇩</span><sub>C</sub> <span class="keyword1">↑af<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">(</span>Abs <span class="main">∘</span> Unf<span class="hidden">⇩</span><sub>G</sub><span class="main">)</span> <span class="free">Σ</span><span class="main">)</span> <span class="main">(</span>ltl_to_rabin_base_code_def.initial<span class="hidden">⇩</span><sub>C</sub> <span class="main">(</span>Abs <span class="main">∘</span> Unf<span class="main">)</span> <span class="main">(</span>Abs <span class="main">∘</span> Unf<span class="hidden">⇩</span><sub>G</sub><span class="main">)</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dom <span class="free">π</span> <span class="main">⊆</span> <span class="keyword1"><span class="hidden">❙</span><b>G</b></span> <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"abstract_transition <span class="free">t</span> <span class="main">∈</span> M<span class="hidden">⇩</span><sub>𝔘</sub>_fin <span class="free">π</span> <span class="main">=</span> M_fin<span class="hidden">⇩</span><sub>C</sub>_af<span class="hidden">⇩</span><sub>𝔘</sub> <span class="free">φ</span> <span class="main">(</span>Mapping.Mapping <span class="free">π</span><span class="main">)</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?delta</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"ltl_to_rabin_base_code_def.delta<span class="hidden">⇩</span><sub>C</sub> <span class="keyword1">↑af<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">(</span>Abs <span class="main">∘</span> Unf<span class="hidden">⇩</span><sub>G</sub><span class="main">)</span> <span class="free">Σ</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?initial</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"ltl_to_rabin_base_code_def.initial<span class="hidden">⇩</span><sub>C</sub> <span class="main">(</span>Abs <span class="main">∘</span> Unf<span class="main">)</span> <span class="main">(</span>Abs <span class="main">∘</span> Unf<span class="hidden">⇩</span><sub>G</sub><span class="main">)</span> <span class="free">φ</span>"</span></span>
  
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">ν</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="skolem"><span class="skolem">z'</span></span> <span class="keyword2"><span class="keyword">where</span></span> t_def <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ν</span><span class="main">,</span> <span class="main">(</span><span class="skolem">z</span><span class="main">,</span> <span class="skolem">z'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.collapse<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> reach <span class="free">Σ</span> <span class="var">?delta</span> <span class="var">?initial</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach<span class="hidden">⇩</span><sub>t</sub>_def reach_def<span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> N1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="free">π</span> <span class="main">⟹</span> Mapping.lookup <span class="skolem">y</span> <span class="bound">χ</span> <span class="main">≠</span> None"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> D1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">χ</span><span class="main">.</span> <span class="bound">χ</span> <span class="main">∈</span> dom <span class="free">π</span> <span class="main">⟹</span> distinct <span class="main">(</span>the <span class="main">(</span>Mapping.lookup <span class="skolem">y</span> <span class="bound">χ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ltl_to_rabin_base_code_def.reach_delta_initial<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">χ</span><span class="main">.</span> map_option rk <span class="main">(</span>Mapping.lookup <span class="skolem">y</span> <span class="bound">χ</span><span class="main">)</span>"</span></span>
    
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">χ</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">χ</span> <span class="main">∈</span> dom <span class="free">π</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">(</span>foldl and_abs <span class="main">(</span>and_abs <span class="main">(</span>Abs <span class="skolem">χ</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">↑eval<span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span>dom <span class="free">π</span><span class="main">)</span> <span class="main">(</span>Abs <span class="main">(</span>theG <span class="skolem">χ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="keyword1">↑eval<span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span>dom <span class="free">π</span><span class="main">)</span> <span class="keyword1">o</span> <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="keyword1">↑step</span> <span class="bound">q</span> <span class="skolem">ν</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="main">(</span>the <span class="main">(</span><span class="free">π</span> <span class="skolem">χ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>the <span class="main">(</span>Mapping.lookup <span class="skolem">y</span> <span class="skolem">χ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
         <span class="main">⟷</span> <span class="skolem">S</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> Abs <span class="skolem">χ</span> <span class="main">∧</span> <span class="skolem">S</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword1">↑eval<span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span>dom <span class="free">π</span><span class="main">)</span> <span class="main">(</span>Abs <span class="main">(</span>theG <span class="skolem">χ</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> the <span class="main">(</span><span class="free">π</span> <span class="skolem">χ</span><span class="main">)</span><span class="main">.</span> the <span class="main">(</span><span class="var">?m'</span> <span class="skolem">χ</span><span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">S</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword1">↑eval<span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span>dom <span class="free">π</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">↑step</span> <span class="bound">q</span> <span class="skolem">ν</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> D1<span class="main">[</span><span class="operator">THEN</span> drop_rk<span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span><span class="free">π</span> <span class="skolem">χ</span><span class="main">)</span>"</span></span><span class="main">]</span> N1<span class="main">[</span><span class="operator">THEN</span> option.map_sel<span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted">rk</span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> foldl_LTLAnd_prop_entailment_abs and_abs_conjunction <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> rk.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>

    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="main">(</span>M_fin<span class="hidden">⇩</span><sub>C</sub>_af<span class="hidden">⇩</span><sub>𝔘</sub>_lhs <span class="free">φ</span> <span class="main">(</span>Mapping.Mapping <span class="free">π</span><span class="main">)</span> <span class="skolem">y</span> <span class="skolem">ν</span><span class="main">)</span>
      <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">χ</span> <span class="main">∈</span> dom <span class="free">π</span><span class="main">.</span> <span class="main">(</span><span class="skolem">S</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> Abs <span class="bound">χ</span> <span class="main">∧</span> <span class="skolem">S</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword1">↑eval<span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span>dom <span class="free">π</span><span class="main">)</span> <span class="main">(</span>Abs <span class="main">(</span>theG <span class="bound">χ</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">≥</span> the <span class="main">(</span><span class="free">π</span> <span class="bound">χ</span><span class="main">)</span><span class="main">.</span> the <span class="main">(</span><span class="var">?m'</span> <span class="bound">χ</span><span class="main">)</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="bound">j</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">S</span> <span class="keyword1">↑⊨<span class="hidden">⇩</span><sub>P</sub></span> <span class="keyword1">↑eval<span class="hidden">⇩</span><sub>G</sub></span> <span class="main">(</span>dom <span class="free">π</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">↑step</span> <span class="bound">q</span> <span class="skolem">ν</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> M_fin<span class="hidden">⇩</span><sub>C</sub>_af<span class="hidden">⇩</span><sub>𝔘</sub>_lhs_def Let_def And_prop_entailment_abs set_map Ball_def keys.abs_eq lookup.abs_eq 
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def inter_set_filter<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> G_eq_G_list<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ltl_prop_implies_def ltl_prop_implies_abs_def ltl_prop_entails_abs_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">ltl_to_generalized_rabin<span class="hidden">⇩</span><sub>C</sub>_af<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">≡</span> ltl_to_rabin_base_code_def.ltl_to_generalized_rabin<span class="hidden">⇩</span><sub>C</sub> <span class="keyword1">↑af<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">(</span>Abs <span class="main">∘</span> Unf<span class="main">)</span> <span class="main">(</span>Abs <span class="main">∘</span> Unf<span class="hidden">⇩</span><sub>G</sub><span class="main">)</span> M_fin<span class="hidden">⇩</span><sub>C</sub>_af<span class="hidden">⇩</span><sub>𝔘</sub>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> ltl_to_generalized_rabin<span class="hidden">⇩</span><sub>C</sub>_af<span class="hidden">⇩</span><sub>𝔘</sub>_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"range <span class="free">w</span> <span class="main">⊆</span> set <span class="free">Σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">⊨</span> <span class="free">φ</span> <span class="main">⟷</span> accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_LTS <span class="main">(</span>ltl_to_generalized_rabin<span class="hidden">⇩</span><sub>C</sub>_af<span class="hidden">⇩</span><sub>𝔘</sub> <span class="free">Σ</span> <span class="free">φ</span><span class="main">)</span> <span class="free">w</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"ltl_to_rabin_base_code <span class="keyword1">↑af<span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="keyword1">↑af<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>𝔘</sub></span> <span class="main">(</span>Abs <span class="main">∘</span> Unf<span class="main">)</span> <span class="main">(</span>Abs <span class="main">∘</span> Unf<span class="hidden">⇩</span><sub>G</sub><span class="main">)</span> M<span class="hidden">⇩</span><sub>𝔘</sub>_fin <span class="main">(</span>set <span class="free">Σ</span><span class="main">)</span> <span class="free">w</span> M_fin<span class="hidden">⇩</span><sub>C</sub>_af<span class="hidden">⇩</span><sub>𝔘</sub>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ltl_to_generalized_rabin_af<span class="hidden">⇩</span><sub>𝔘</sub>_wellformed<span class="main">[</span><span class="operator">OF</span> finite_set assms<span class="main">]</span> M_fin<span class="hidden">⇩</span><sub>C</sub>_af<span class="hidden">⇩</span><sub>𝔘</sub>_correct assms
    <span class="keyword1"><span class="command">unfolding</span></span> ltl_to_rabin_af_unf_def ltl_to_rabin_base_code_def ltl_to_rabin_base_code_axioms_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">⟷</span> accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub> <span class="main">(</span>ltl_to_generalized_rabin_af<span class="hidden">⇩</span><sub>𝔘</sub> <span class="main">(</span>set <span class="free">Σ</span><span class="main">)</span> <span class="free">φ</span><span class="main">)</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms ltl_to_generalized_rabin_af<span class="hidden">⇩</span><sub>𝔘</sub>_correct <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> 
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ltl_to_rabin_base_code.ltl_to_generalized_rabin<span class="hidden">⇩</span><sub>C</sub>_correct<span class="main">[</span><span class="operator">OF</span> X<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> ltl_to_generalized_rabin<span class="hidden">⇩</span><sub>C</sub>_af<span class="hidden">⇩</span><sub>𝔘</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Export_Code">
<div class="head">
<h1>Theory Export_Code</h1>
</div>
<pre class="source"><span class="comment1">(*  
    Author:      Salomon Sickert
    License:     BSD
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Code Generation›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Export_Code
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <a href="LTL_Compat.html">LTL_Compat</a> <a href="LTL_Rabin_Impl.html">LTL_Rabin_Impl</a> 
    <span class="quoted">"<a href="../../HOL/HOL-Library/AList_Mapping.html">HOL-Library.AList_Mapping</a>"</span> <span class="comment1">(* Future, Performance: Replace by LC *)</span> 
    <a href="../LTL/Rewriting.html">LTL.Rewriting</a>
    <span class="quoted">"<a href="../../HOL/HOL-Library/Code_Target_Numeral.html">HOL-Library.Code_Target_Numeral</a>"</span> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹External Interface›</span></span>

<span class="comment1">― ‹Fix the type to match the type of the LTL parser›</span>

<span class="keyword1"><span class="command">definition</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">ltlc_to_rabin</span> <span class="free"><span class="bound"><span class="entity">eager</span></span></span> <span class="free"><span class="bound"><span class="entity">mode</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>c</sub></span></span></span> <span class="main">::</span> String.literal ltlc<span class="main">)</span> <span class="main">≡</span>
    <span class="main">(</span><span class="keyword1">let</span>
      <span class="bound">φ<span class="hidden">⇩</span><sub>n</sub></span> <span class="main">=</span> ltlc_to_ltln <span class="free"><span class="bound"><span class="entity">φ<span class="hidden">⇩</span><sub>c</sub></span></span></span><span class="main">;</span>
      <span class="bound">Σ</span> <span class="main">=</span> map set <span class="main">(</span>subseqs <span class="main">(</span>atoms_list <span class="bound">φ<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
      <span class="bound">φ</span> <span class="main">=</span> ltln_to_ltl <span class="main">(</span>simplify <span class="free"><span class="bound"><span class="entity">mode</span></span></span> <span class="bound">φ<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span>
     <span class="keyword1">in</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">eager</span></span></span> <span class="keyword1">then</span> ltl_to_generalized_rabin<span class="hidden">⇩</span><sub>C</sub>_af<span class="hidden">⇩</span><sub>𝔘</sub> <span class="bound">Σ</span> <span class="bound">φ</span> <span class="keyword1">else</span> ltl_to_generalized_rabin<span class="hidden">⇩</span><sub>C</sub>_af <span class="bound">Σ</span> <span class="bound">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> ltlc_to_rabin_exec_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"range <span class="free">w</span> <span class="main">⊆</span> Pow <span class="main">(</span>atoms_ltlc <span class="free">φ<span class="hidden">⇩</span><sub>c</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">φ<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">⟷</span> accept<span class="hidden">⇩</span><sub>G</sub><span class="hidden">⇩</span><sub>R</sub>_LTS <span class="main">(</span>ltlc_to_rabin <span class="free">eager</span> <span class="free">mode</span> <span class="free">φ<span class="hidden">⇩</span><sub>c</sub></span><span class="main">)</span> <span class="free">w</span>"</span></span> 
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?φ<span class="hidden">⇩</span><sub>n</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"ltlc_to_ltln <span class="free">φ<span class="hidden">⇩</span><sub>c</sub></span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Σ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map set <span class="main">(</span>subseqs <span class="main">(</span>atoms_list <span class="var">?φ<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?φ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"ltln_to_ltl <span class="main">(</span>simplify <span class="free">mode</span> <span class="var">?φ<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="var">?Σ</span> <span class="main">=</span> Pow <span class="main">(</span>atoms_ltln <span class="var">?φ<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> atoms_list_correct<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> subseqs_powset<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> list.set_map <span class="keyword1"><span class="command">..</span></span>  
  <span class="keyword1"><span class="command">hence</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"range <span class="free">w</span> <span class="main">⊆</span> set <span class="var">?Σ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms ltlc_to_ltln_atoms<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">⊨<span class="hidden">⇩</span><sub>c</sub></span> <span class="free">φ<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">⟷</span> <span class="free">w</span> <span class="main">⊨</span> <span class="var">?φ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ltlc_to_ltln_semantics simplify_correct ltln_to_ltl_semantics<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⟷</span> <span class="var">?rhs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ltl_to_generalized_rabin<span class="hidden">⇩</span><sub>C</sub>_af<span class="hidden">⇩</span><sub>𝔘</sub>_correct<span class="main">[</span><span class="operator">OF</span> R<span class="main">]</span> ltl_to_generalized_rabin<span class="hidden">⇩</span><sub>C</sub>_af_correct<span class="main">[</span><span class="operator">OF</span> R<span class="main">]</span> 
    <span class="keyword1"><span class="command">unfolding</span></span> ltlc_to_rabin_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Normalize Equivalence Classes During DFS-Search›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">norm_rep</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">norm_rep</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ν'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p'</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> 
      <span class="bound">eq_q</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">q'</span></span></span><span class="main">)</span><span class="main">;</span> <span class="bound">eq_p</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p'</span></span></span><span class="main">)</span><span class="main">;</span>
      <span class="bound">q''</span> <span class="main">=</span> <span class="keyword1">if</span> <span class="bound">eq_q</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">q'</span></span></span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p'</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">p'</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">;</span>
      <span class="bound">p''</span> <span class="main">=</span> <span class="keyword1">if</span> <span class="bound">eq_p</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">p'</span></span></span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">q'</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">q'</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>
    <span class="keyword1">in</span> 
      <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">|</span> <span class="main">(</span><span class="bound">eq_q</span> <span class="main">&amp;</span> <span class="bound">eq_p</span> <span class="main">&amp;</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ν'</span></span></span><span class="main">)</span><span class="main">,</span> <span class="bound">q''</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">,</span> <span class="bound">p''</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">norm_fold</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> transition <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> transition list <span class="main">⇒</span> <span class="main">(</span>bool <span class="main">*</span> <span class="tfree">'a</span> <span class="main">*</span> <span class="tfree">'b</span> <span class="main">*</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">norm_fold</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> foldl_break norm_rep fst <span class="main">(</span>False<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ν</span></span></span><span class="main">,</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">norm_insert</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> transition <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> transition list <span class="main">⇒</span> <span class="main">(</span>bool <span class="main">*</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> transition list<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">norm_insert</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">x'</span><span class="main">)</span> <span class="main">=</span> norm_fold <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">x'</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1" id="Export_Code-norm_fold"><span class="command">lemma</span></span> norm_fold<span class="main">:</span>
  <span class="quoted"><span class="quoted">"norm_fold <span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">ν</span><span class="main">,</span> <span class="free">p</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">q</span><span class="main">,</span> <span class="free">ν</span><span class="main">,</span> <span class="free">p</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">,</span> <span class="free">q</span><span class="main">,</span> <span class="free">ν</span><span class="main">,</span> <span class="free">p</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="skolem"><span class="skolem">ν'</span></span> <span class="skolem"><span class="skolem">p'</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">q'</span><span class="main">,</span> <span class="skolem">ν'</span><span class="main">,</span> <span class="skolem">p'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> prod_cases3<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> snoc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x_def foldl_break_append<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>  

<span class="keyword1" id="Export_Code-norm_insert"><span class="command">lemma</span></span> norm_insert<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"norm_insert <span class="free">x</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">,</span> List.insert <span class="free">x</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">ν</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">q</span><span class="main">,</span> <span class="skolem">ν</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> prod_cases3<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> x_def norm_insert_def norm_fold <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>
 
<span class="keyword1"><span class="command">declare</span></span> list_dfs_def <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> norm_insert_def <span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span>

<span class="keyword1" id="Export_Code-list_dfs_norm_insert"><span class="command">lemma</span></span> list_dfs_norm_insert <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"list_dfs <span class="free">succ</span> <span class="free">S</span> <span class="main">[]</span> <span class="main">=</span> <span class="free">S</span>"</span></span>
  <span class="quoted"><span class="quoted">"list_dfs <span class="free">succ</span> <span class="free">S</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">memb</span><span class="main">,</span> <span class="bound">S'</span><span class="main">)</span> <span class="main">=</span> norm_insert <span class="free">x</span> <span class="free">S</span> <span class="keyword1">in</span> list_dfs <span class="free">succ</span> <span class="bound">S'</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">memb</span> <span class="keyword1">then</span> <span class="free">xs</span> <span class="keyword1">else</span> <span class="free">succ</span> <span class="free">x</span> <span class="main">@</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> list_dfs_def Let_def norm_insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span> 

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Register Code Equations›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">↑Δ<span class="hidden">⇩</span><sub>×</sub></span> <span class="free">f</span> <span class="main">(</span>AList_Mapping.Mapping <span class="free">xs</span><span class="main">)</span> <span class="free">c</span> <span class="main">=</span> AList_Mapping.Mapping <span class="main">(</span>map_ran <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span> <span class="free">c</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">Δ<span class="hidden">⇩</span><sub>×</sub></span> <span class="free">f</span> <span class="main">(</span>map_of <span class="free">xs</span><span class="main">)</span> <span class="free">c</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span>map_of <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="free">f</span> <span class="bound">k</span> <span class="bound">v</span> <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_ran_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> ltl_to_rabin_base_code_export <span class="main">[</span><span class="operator">code</span><span class="main">,</span> <span class="operator">code_unfold</span><span class="main">]</span> <span class="main">=</span>
  ltl_to_rabin_base_code_def.ltl_to_generalized_rabin<span class="hidden">⇩</span><sub>C</sub>.simps
  ltl_to_rabin_base_code_def.reachable_transitions<span class="hidden">⇩</span><sub>C</sub>_def 
  ltl_to_rabin_base_code_def.mappings<span class="hidden">⇩</span><sub>C</sub>_code 
  ltl_to_rabin_base_code_def.delta<span class="hidden">⇩</span><sub>C</sub>.simps
  ltl_to_rabin_base_code_def.initial<span class="hidden">⇩</span><sub>C</sub>.simps 
  ltl_to_rabin_base_code_def.Acc_inf<span class="hidden">⇩</span><sub>C</sub>.simps 
  ltl_to_rabin_base_code_def.Acc_fin<span class="hidden">⇩</span><sub>C</sub>.simps
  ltl_to_rabin_base_code_def.max_rank_of<span class="hidden">⇩</span><sub>C</sub>_def

<span class="keyword1"><span class="command">lemmas</span></span> M_fin<span class="hidden">⇩</span><sub>C</sub>_lhs <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">,</span> <span class="operator">code_unfold</span><span class="main">]</span> <span class="main">=</span> 
  M_fin<span class="hidden">⇩</span><sub>C</sub>_af<span class="hidden">⇩</span><sub>𝔘</sub>_lhs_def M_fin<span class="hidden">⇩</span><sub>C</sub>_af_lhs_def 

<span class="comment1">― ‹Test code export›</span>
<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted"><span class="keyword1">true<span class="hidden">⇩</span><sub>c</sub></span></span></span> <span class="quoted"><span class="quoted">Iff_ltlc</span></span> <span class="quoted"><span class="quoted">Nop</span></span> <span class="quoted"><span class="quoted"><span class="keyword1">true</span></span></span> <span class="quoted"><span class="quoted">Abs</span></span> <span class="quoted"><span class="quoted">AList_Mapping.Mapping</span></span> <span class="quoted"><span class="quoted">set</span></span> <span class="quoted"><span class="quoted">ltlc_to_rabin</span></span> <span class="keyword2"><span class="keyword">checking</span></span>

<span class="comment1">― ‹Export translator (and also constructors)›</span>
<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted"><span class="keyword1">true<span class="hidden">⇩</span><sub>c</sub></span></span></span> <span class="quoted"><span class="quoted">Iff_ltlc</span></span> <span class="quoted"><span class="quoted">Nop</span></span> <span class="quoted"><span class="quoted"><span class="keyword1">true</span></span></span> <span class="quoted"><span class="quoted">Abs</span></span> <span class="quoted"><span class="quoted">AList_Mapping.Mapping</span></span> <span class="quoted"><span class="quoted">set</span></span> <span class="quoted"><span class="quoted">ltlc_to_rabin</span></span> 
  <span class="keyword2"><span class="keyword">in</span></span> SML <span class="keyword2"><span class="keyword">module_name</span></span> LTL <span class="keyword2"><span class="keyword">file</span></span> <span class="quoted">‹../Code/LTL_to_DRA_Translator.sml›</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>