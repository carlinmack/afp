<div id="Tensor">
<div class="head">
<h1>Theory Tensor</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Alexander Bentkamp, Universität des Saarlandes
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Tensor›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Tensor
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">typedef</span></span> <span class="tfree">'a</span> tensor <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">t</span><span class="main">::</span>nat list <span class="main">×</span> <span class="tfree">'a</span> list<span class="main">.</span> length <span class="main">(</span>snd <span class="bound">t</span><span class="main">)</span> <span class="main">=</span> prod_list <span class="main">(</span>fst <span class="bound">t</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Ex_list_of_length<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">dims</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tensor <span class="main">⇒</span> nat list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dims</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> fst <span class="main">(</span>Rep_tensor <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">vec</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tensor <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">vec</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> snd <span class="main">(</span>Rep_tensor <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tensor_from_vec</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> tensor"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tensor_from_vec</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> Abs_tensor <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">v</span> <span class="main">=</span> prod_list <span class="free">d</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> dims_tensor<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dims <span class="main">(</span>tensor_from_vec <span class="free">d</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">d</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span>   vec_tensor<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"vec <span class="main">(</span>tensor_from_vec <span class="free">d</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_tensor_inverse assms dims_def tensor_from_vec_def vec_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Tensor-tensor_from_vec_simp"><span class="command">lemma</span></span> tensor_from_vec_simp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"tensor_from_vec <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span> <span class="main">(</span>vec <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Rep_tensor_inverse Tensor.vec_def dims_def tensor_from_vec_def<span class="main">)</span>

<span class="keyword1" id="Tensor-length_vec"><span class="command">lemma</span></span> length_vec<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>vec <span class="free">A</span><span class="main">)</span> <span class="main">=</span> prod_list <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Rep_tensor Tensor.vec_def dims_def mem_Collect_eq<span class="main">)</span>

<span class="keyword1" id="Tensor-tensor_eqI"><span class="command">lemma</span></span> tensor_eqI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dims <span class="free">A</span> <span class="main">=</span> dims <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"vec <span class="free">A</span> <span class="main">=</span> vec <span class="free">B</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">=</span><span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms tensor_from_vec_simp<span class="main">)</span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">order</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tensor <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">order</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">==</span> length <span class="main">(</span>dims <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">valid_index</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> nat list <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊲</span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main"><span class="free">⊲</span></span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
  Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="main"><span class="free">⊲</span></span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="main"><span class="free">⊲</span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ds</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive_cases</span></span> valid_indexE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">⊲</span> <span class="free">ds</span>"</span></span>
<span class="keyword1"><span class="command">inductive_cases</span></span> valid_index_dimsE<span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">⊲</span> dims <span class="free">A</span>"</span></span>

<span class="keyword1" id="Tensor-valid_index_length"><span class="command">lemma</span></span> valid_index_length<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">⊲</span> <span class="free">ds</span> <span class="main">⟹</span> length <span class="free">is</span> <span class="main">=</span> length <span class="free">ds</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>valid_index.induct<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Tensor-valid_index_lt"><span class="command">lemma</span></span> valid_index_lt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">⊲</span> <span class="free">ds</span> <span class="main">⟹</span> <span class="free">m</span><span class="main">&lt;</span>length <span class="free">ds</span> <span class="main">⟹</span> <span class="free">is</span><span class="main">!</span><span class="free">m</span> <span class="main">&lt;</span> <span class="free">ds</span><span class="main">!</span><span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>valid_index.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Cons
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> gr0_conv_Suc length_Cons linorder_neqE_nat not_less_eq nth_Cons' nth_Cons_Suc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor-valid_indexI"><span class="command">lemma</span></span> valid_indexI<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">is</span> <span class="main">=</span> length <span class="free">ds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span><span class="main">.</span> <span class="bound">m</span><span class="main">&lt;</span>length <span class="free">ds</span> <span class="main">⟹</span> <span class="free">is</span><span class="main">!</span><span class="bound">m</span> <span class="main">&lt;</span> <span class="free">ds</span><span class="main">!</span><span class="bound">m</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">⊲</span> <span class="free">ds</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="free">is</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">ds</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_0_conv valid_index.simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="quoted">"<span class="skolem">is</span>"</span> <span class="skolem">ds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="skolem"><span class="skolem">ds'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ds</span> <span class="main">=</span> <span class="skolem">d</span> <span class="main">#</span> <span class="skolem">ds'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_Suc_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> <span class="skolem">ds'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_Cons less_irrefl linorder_neqE_nat not_less_eq nth_Cons_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">ds</span> <span class="main">=</span> <span class="skolem">d</span> <span class="main">#</span> <span class="skolem">ds'</span>›</span></span> valid_index.Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor-valid_index_append"><span class="command">lemma</span></span> valid_index_append<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> is1_valid<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">is1</span> <span class="main">⊲</span> <span class="free">ds1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> is2_valid<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">is2</span> <span class="main">⊲</span> <span class="free">ds2</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">is1</span> <span class="main">@</span> <span class="free">is2</span> <span class="main">⊲</span> <span class="free">ds1</span> <span class="main">@</span> <span class="free">ds2</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> valid_indexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">is1</span></span> <span class="main"><span class="main">@</span></span> <span class="free"><span class="free">is2</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">ds1</span></span> <span class="main"><span class="main">@</span></span> <span class="free"><span class="free">ds2</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> nth_append
  <span class="keyword1"><span class="command">using</span></span> valid_index_lt<span class="main">[</span><span class="operator">OF</span> is2_valid<span class="main">]</span> valid_index_lt<span class="main">[</span><span class="operator">OF</span> is1_valid<span class="main">]</span> valid_index_length<span class="main">[</span><span class="operator">OF</span> is1_valid<span class="main">]</span> valid_index_length<span class="main">[</span><span class="operator">OF</span> is2_valid<span class="main">]</span> length_append
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹length <span class="free">is1</span> <span class="main">=</span> length <span class="free">ds1</span>›</span></span><span class="main">)</span>

<span class="keyword1" id="Tensor-valid_index_list_all2_iff"><span class="command">lemma</span></span> valid_index_list_all2_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">⊲</span> <span class="free">ds</span> <span class="main">⟷</span> list_all2 <span class="main">(&lt;)</span> <span class="free">is</span> <span class="free">ds</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list_all2_conv_all_nth list_all2_nthD valid_indexI valid_index_length valid_index_lt<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fixed_length_sublist</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">fixed_length_sublist</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span>take <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span>drop <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lookup_base</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> nat list <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  lookup_base_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lookup_base</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">[]</span> <span class="main">=</span> hd <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span> <span class="main">|</span>
  lookup_base_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lookup_base</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">is</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="free">lookup_base</span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span> <span class="main">(</span>fixed_length_sublist <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>prod_list <span class="free"><span class="bound"><span class="entity">ds</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">is</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lookup</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tensor <span class="main">⇒</span> nat list <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lookup</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> lookup_base <span class="main">(</span>dims <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>vec <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">tensor_vec_from_lookup</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> <span class="main">(</span>nat list <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  tensor_vec_from_lookup_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">tensor_vec_from_lookup</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">[]</span><span class="main">]</span>"</span></span> <span class="main">|</span>
  tensor_vec_from_lookup_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">tensor_vec_from_lookup</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">tensor_vec_from_lookup</span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">is</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">(</span><span class="bound">i</span> <span class="main">#</span> <span class="bound">is</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tensor_from_lookup</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> <span class="main">(</span>nat list <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> tensor"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tensor_from_lookup</span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> tensor_from_vec <span class="free"><span class="bound"><span class="entity">ds</span></span></span> <span class="main">(</span>tensor_vec_from_lookup <span class="free"><span class="bound"><span class="entity">ds</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Tensor-concat_parts_leq"><span class="command">lemma</span></span> concat_parts_leq<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">*</span> <span class="free">d</span> <span class="main">≤</span> length <span class="free">v</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span>map <span class="main">(</span>fixed_length_sublist <span class="free">v</span> <span class="free">d</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> take <span class="main">(</span><span class="free">a</span><span class="main">*</span><span class="free">d</span><span class="main">)</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span>map <span class="main">(</span>fixed_length_sublist <span class="free">v</span> <span class="free">d</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> take <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> <span class="free">d</span><span class="main">)</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span>map <span class="main">(</span>fixed_length_sublist <span class="free">v</span> <span class="free">d</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
        take <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> <span class="free">d</span><span class="main">)</span> <span class="free">v</span> <span class="main">@</span> fixed_length_sublist <span class="free">v</span> <span class="free">d</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fixed_length_sublist_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute mult.commute mult_Suc take_add fixed_length_sublist_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor-concat_parts_eq"><span class="command">lemma</span></span> concat_parts_eq<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">*</span> <span class="free">d</span> <span class="main">=</span> length <span class="free">v</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span>map <span class="main">(</span>fixed_length_sublist <span class="free">v</span> <span class="free">d</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">a</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> concat_parts_leq assms<span class="main">)</span>

<span class="keyword1" id="Tensor-tensor_lookup_base"><span class="command">lemma</span></span> tensor_lookup_base<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">v</span> <span class="main">=</span> prod_list <span class="free">ds</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">is</span><span class="main">.</span> <span class="bound">is</span> <span class="main">⊲</span> <span class="free">ds</span> <span class="main">⟹</span> lookup_base <span class="free">ds</span> <span class="free">v</span> <span class="bound">is</span> <span class="main">=</span> <span class="free">e</span> <span class="bound">is</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tensor_vec_from_lookup <span class="free">ds</span> <span class="free">e</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ds</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">e</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> tensor_vec_from_lookup.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Tensor.lookup_base_Nil length_0_conv length_Suc_conv list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> prod_list.Nil valid_index.Nil<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">ds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">*</span> prod_list <span class="skolem">ds</span> <span class="main">=</span> length <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span><span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prod_list <span class="skolem">ds</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">≤</span> length <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">*</span> prod_list <span class="skolem">ds</span> <span class="main">=</span> length <span class="skolem">v</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> discrete mult.commute mult_le_mono1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">is'</span><span class="main">.</span> <span class="bound">is'</span> <span class="main">⊲</span> <span class="skolem">ds</span> <span class="main">⟹</span> <span class="skolem">e</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">#</span> <span class="bound">is'</span><span class="main">)</span> <span class="main">=</span> lookup_base <span class="skolem">ds</span> <span class="main">(</span>fixed_length_sublist <span class="skolem">v</span> <span class="main">(</span>prod_list <span class="skolem">ds</span><span class="main">)</span> <span class="skolem">i</span><span class="main">)</span> <span class="bound">is'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span><span class="main">&lt;</span><span class="skolem">a</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Tensor.lookup_base_Cons valid_index.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tensor_vec_from_lookup <span class="skolem">ds</span> <span class="main">(</span><span class="main">λ</span><span class="bound">is'</span><span class="main">.</span> <span class="skolem">e</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">#</span> <span class="bound">is'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> fixed_length_sublist <span class="skolem">v</span> <span class="main">(</span>prod_list <span class="skolem">ds</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹prod_list <span class="skolem">ds</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">≤</span> length <span class="skolem">v</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons.IH fixed_length_sublist_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> tensor_vec_from_lookup_Cons lookup_base_Cons
    <span class="keyword1"><span class="command">using</span></span>   concat_parts_eq<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">*</span> prod_list <span class="skolem">ds</span> <span class="main">=</span> length <span class="skolem">v</span>›</span></span><span class="main">]</span>
     atLeastLessThan_iff map_eq_conv set_upt Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor-tensor_lookup"><span class="command">lemma</span></span> tensor_lookup<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">is</span><span class="main">.</span> <span class="bound">is</span> <span class="main">⊲</span> dims <span class="free">A</span> <span class="main">⟹</span> lookup <span class="free">A</span> <span class="bound">is</span> <span class="main">=</span> <span class="free">e</span> <span class="bound">is</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tensor_from_lookup <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span> <span class="free">e</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> tensor_lookup_base lookup_def length_vec tensor_from_lookup_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms tensor_from_vec_simp<span class="main">)</span>

<span class="keyword1" id="Tensor-concat_equal_length"><span class="command">lemma</span></span> concat_equal_length<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span><span class="main">∈</span>set <span class="free">xss</span> <span class="main">⟹</span> length <span class="bound">xs</span> <span class="main">=</span> <span class="free">l</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>concat <span class="free">xss</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xss</span><span class="main">*</span><span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xss</span></span><span class="main"><span class="keyword3">;</span></span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Tensor-concat_equal_length_map"><span class="command">lemma</span></span> concat_equal_length_map<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free">a</span> <span class="main">⟹</span> length <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">d</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span><span class="main">*</span><span class="free">d</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">;</span></span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Tensor-concat_parts"><span class="command">lemma</span></span> concat_parts<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span><span class="main">∈</span>set <span class="free">xss</span> <span class="main">⟹</span> length <span class="bound">xs</span> <span class="main">=</span> <span class="free">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span>length <span class="free">xss</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fixed_length_sublist <span class="main">(</span>concat <span class="free">xss</span><span class="main">)</span> <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> <span class="free">xss</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">xs</span> <span class="skolem">xss</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>concat <span class="skolem">xss</span><span class="main">)</span> <span class="main">=</span> length <span class="skolem">xss</span> <span class="main">*</span> <span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> concat_equal_length<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fixed_length_sublist <span class="main">(</span>concat <span class="main">(</span><span class="skolem">xs</span> <span class="main">#</span> <span class="skolem">xss</span><span class="main">)</span><span class="main">)</span> <span class="free">d</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> fixed_length_sublist_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fixed_length_sublist <span class="main">(</span>concat <span class="skolem">xss</span><span class="main">)</span> <span class="free">d</span> <span class="skolem">i'</span> <span class="main">=</span> <span class="skolem">xss</span> <span class="main">!</span> <span class="skolem">i'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> fixed_length_sublist_def <span class="keyword1"><span class="command">using</span></span> Suc Cons.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor-concat_parts'"><span class="command">lemma</span></span> concat_parts'<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free">a</span> <span class="main">⟹</span> length <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">d</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="free">a</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fixed_length_sublist <span class="main">(</span>concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> <span class="free">f</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">a</span> <span class="main">⟹</span> length <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>concat <span class="main">(</span>map <span class="free">f</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">a</span><span class="main">*</span><span class="free">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> concat_equal_length_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">=</span><span class="skolem">a</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">=</span><span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fixed_length_sublist <span class="main">(</span>concat <span class="main">(</span>map <span class="free">f</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹length <span class="main">(</span>concat <span class="main">(</span>map <span class="free">f</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">*</span> <span class="free">d</span>›</span></span> fixed_length_sublist_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span><span class="main">=</span><span class="skolem">a</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">≠</span><span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fixed_length_sublist <span class="main">(</span>concat <span class="main">(</span>map <span class="free">f</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> <span class="free">f</span> <span class="free">i</span>"</span></span>
      <span class="quoted"><span class="quoted">"concat <span class="main">(</span>map <span class="free">f</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> concat <span class="main">(</span>map <span class="free">f</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="free">f</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹concat <span class="main">(</span>map <span class="free">f</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>Suc <span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> concat <span class="main">(</span>map <span class="free">f</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="free">f</span> <span class="skolem">a</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> fixed_length_sublist_def drop_append
      <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹length <span class="main">(</span>concat <span class="main">(</span>map <span class="free">f</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">*</span> <span class="free">d</span>›</span></span>  <span class="quoted"><span class="quoted">‹fixed_length_sublist <span class="main">(</span>concat <span class="main">(</span>map <span class="free">f</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="free">d</span> <span class="free">i</span> <span class="main">=</span> <span class="free">f</span> <span class="free">i</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> append_assoc append_eq_conv_conj append_take_drop_id assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span>  fixed_length_sublist_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor-length_tensor_vec_from_lookup"><span class="command">lemma</span></span> length_tensor_vec_from_lookup<span class="main">:</span>
<span class="quoted"><span class="quoted">"length <span class="main">(</span>tensor_vec_from_lookup <span class="free">ds</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> prod_list <span class="free">ds</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ds</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">e</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> concat_equal_length_map<span class="main">)</span>

<span class="keyword1" id="Tensor-lookup_tensor_vec"><span class="command">lemma</span></span> lookup_tensor_vec<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span><span class="main">⊲</span><span class="free">ds</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lookup_base <span class="free">ds</span> <span class="main">(</span>tensor_vec_from_lookup <span class="free">ds</span> <span class="free">e</span><span class="main">)</span> <span class="free">is</span> <span class="main">=</span> <span class="free">e</span> <span class="free">is</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">e</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>valid_index.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="quoted">"<span class="skolem">is</span>"</span> <span class="skolem">ds</span> <span class="skolem">i</span> <span class="skolem">d</span> <span class="skolem">e</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> tensor_vec_from_lookup_Cons lookup_base_Cons
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_tensor_vec_from_lookup concat_parts'<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">d</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> tensor_vec_from_lookup <span class="skolem">ds</span> <span class="main">(</span><span class="main">λ</span><span class="bound">is</span><span class="main">.</span> <span class="skolem">e</span> <span class="main">(</span><span class="bound">i</span> <span class="main">#</span> <span class="bound">is</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"prod_list <span class="skolem">ds</span>"</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">d</span>›</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor-lookup_tensor_from_lookup"><span class="command">lemma</span></span> lookup_tensor_from_lookup<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span><span class="main">⊲</span><span class="free">ds</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span>tensor_from_lookup <span class="free">ds</span> <span class="free">e</span><span class="main">)</span> <span class="free">is</span> <span class="main">=</span> <span class="free">e</span> <span class="free">is</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lookup_def tensor_from_lookup_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_tensor_vec assms length_tensor_vec_from_lookup<span class="main">)</span>

<span class="keyword1" id="Tensor-dims_tensor_from_lookup"><span class="command">lemma</span></span> dims_tensor_from_lookup<span class="main">:</span> <span class="quoted"><span class="quoted">"dims <span class="main">(</span>tensor_from_lookup <span class="free">ds</span> <span class="free">e</span><span class="main">)</span> <span class="main">=</span> <span class="free">ds</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tensor_from_lookup_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_tensor_vec_from_lookup<span class="main">)</span>

<span class="keyword1" id="Tensor-tensor_lookup_cong"><span class="command">lemma</span></span> tensor_lookup_cong<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"tensor_from_lookup <span class="free">ds</span> <span class="free">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> tensor_from_lookup <span class="free">ds</span> <span class="free">e<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span><span class="main">⊲</span><span class="free">ds</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">is</span> <span class="main">=</span> <span class="free">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">is</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms lookup_tensor_from_lookup <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="Tensor-tensor_from_lookup_eqI"><span class="command">lemma</span></span> tensor_from_lookup_eqI<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">is</span><span class="main">.</span> <span class="bound">is</span><span class="main">⊲</span><span class="free">ds</span> <span class="main">⟹</span> <span class="free">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">is</span> <span class="main">=</span> <span class="free">e<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">is</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tensor_from_lookup <span class="free">ds</span> <span class="free">e<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> tensor_from_lookup <span class="free">ds</span> <span class="free">e<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms lookup_tensor_vec length_tensor_vec_from_lookup tensor_lookup_base tensor_from_lookup_def<span class="main">)</span>

<span class="keyword1" id="Tensor-tensor_lookup_eqI"><span class="command">lemma</span></span> tensor_lookup_eqI<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dims <span class="free">A</span> <span class="main">=</span> dims <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">is</span><span class="main">.</span> <span class="bound">is</span><span class="main">⊲</span><span class="main">(</span>dims <span class="free">A</span><span class="main">)</span> <span class="main">⟹</span> lookup <span class="free">A</span> <span class="bound">is</span> <span class="main">=</span> lookup <span class="free">B</span> <span class="bound">is</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> tensor_lookup<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Tensor_Subtensor">
<div class="head">
<h1>Theory Tensor_Subtensor</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Alexander Bentkamp, Universität des Saarlandes
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Subtensors›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Tensor_Subtensor
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Tensor.html">Tensor</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subtensor</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tensor <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> tensor"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subtensor</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> tensor_from_vec <span class="main">(</span>tl <span class="main">(</span>dims <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fixed_length_sublist <span class="main">(</span>vec <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>prod_list <span class="main">(</span>tl <span class="main">(</span>dims <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">subtensor_combine</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> <span class="tfree">'a</span> tensor list <span class="main">⇒</span> <span class="tfree">'a</span> tensor"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">subtensor_combine</span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span> <span class="free"><span class="bound"><span class="entity">As</span></span></span> <span class="main">=</span> tensor_from_vec <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">As</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span><span class="main">)</span> <span class="main">(</span>concat <span class="main">(</span>map vec <span class="free"><span class="bound"><span class="entity">As</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Tensor_Subtensor-length_fixed_length_sublist"><span class="command">lemma</span></span> length_fixed_length_sublist<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">*</span><span class="free">l</span> <span class="main">≤</span> length <span class="free">xs</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>fixed_length_sublist <span class="free">xs</span> <span class="free">l</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fixed_length_sublist_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms diff_add_inverse2 length_drop length_take min.absorb2 mult.commute mult_Suc take_drop<span class="main">)</span>

<span class="keyword1" id="Tensor_Subtensor-vec_subtensor"><span class="command">lemma</span></span> vec_subtensor<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dims <span class="free">A</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vec <span class="main">(</span>subtensor <span class="free">A</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> fixed_length_sublist <span class="main">(</span>vec <span class="free">A</span><span class="main">)</span> <span class="main">(</span>prod_list <span class="main">(</span>tl <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Suc_leI assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> hd_Cons_tl length_fixed_length_sublist length_vec prod_list.Cons mult_le_mono1 subtensor_def vec_tensor<span class="main">)</span>

<span class="keyword1" id="Tensor_Subtensor-dims_subtensor"><span class="command">lemma</span></span> dims_subtensor<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dims <span class="free">A</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dims <span class="main">(</span>subtensor <span class="free">A</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> tl <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Suc_leI assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> dims_tensor length_fixed_length_sublist length_vec list.collapse prod_list.Cons mult_le_mono1 subtensor_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="Tensor_Subtensor-subtensor_combine_subtensor"><span class="command">lemma</span></span> subtensor_combine_subtensor<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dims <span class="free">A</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subtensor_combine <span class="main">(</span>tl <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>subtensor <span class="free">A</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> length_vec_A<span class="main">:</span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span> <span class="main">*</span> prod_list <span class="main">(</span>tl <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>Tensor.vec <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms length_vec list.collapse prod_list.Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?subtensor_vec</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fixed_length_sublist <span class="main">(</span>vec <span class="free">A</span><span class="main">)</span> <span class="main">(</span>prod_list <span class="main">(</span>tl <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">*</span><span class="main">(</span>prod_list <span class="main">(</span>tl <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span>vec <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_leI length_vec_A mult_le_mono1<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>vec <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> tensor_from_vec <span class="main">(</span>tl <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?subtensor_vec</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">=</span> <span class="var">?subtensor_vec</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"map <span class="main">(</span>Tensor.vec <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> tensor_from_vec <span class="main">(</span>tl <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?subtensor_vec</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span><span class="main">]</span>
              <span class="main">=</span> map <span class="var">?subtensor_vec</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subtensor_combine <span class="main">(</span>tl <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> subtensor <span class="free">A</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> subtensor_combine_def subtensor_def <span class="keyword1"><span class="command">using</span></span> concat_parts_eq<span class="main">[</span><span class="operator">OF</span> length_vec_A<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 1 assms<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span><span class="main">∈</span>set <span class="free">As</span> <span class="main">⟹</span> dims <span class="bound">A</span> <span class="main">=</span> <span class="free">ds</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> subtensor_combine_dims<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dims <span class="main">(</span>subtensor_combine <span class="free">ds</span> <span class="free">As</span><span class="main">)</span> <span class="main">=</span> length <span class="free">As</span> <span class="main">#</span> <span class="free">ds</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?D</span></span></span><span class="main">)</span>
<span class="keyword2"><span class="keyword">and</span></span> subtensor_combine_vec<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vec <span class="main">(</span>subtensor_combine <span class="free">ds</span> <span class="free">As</span><span class="main">)</span> <span class="main">=</span> concat <span class="main">(</span>map vec <span class="free">As</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?V</span></span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span><span class="main">∈</span>set <span class="main">(</span>map Tensor.vec <span class="free">As</span><span class="main">)</span> <span class="main">⟹</span> length <span class="bound">v</span> <span class="main">=</span> prod_list <span class="free">ds</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms length_vec <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">As</span> <span class="main">*</span> prod_list <span class="free">ds</span> <span class="main">=</span> length <span class="main">(</span>concat <span class="main">(</span>map Tensor.vec <span class="free">As</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> concat_equal_length
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_map<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?D</span></span></span> <span class="var"><span class="quoted"><span class="var">?V</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> subtensor_combine_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor_Subtensor-subtensor_subtensor_combine"><span class="command">lemma</span></span> subtensor_subtensor_combine<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span><span class="main">∈</span>set <span class="free">As</span> <span class="main">⟹</span> dims <span class="bound">A</span> <span class="main">=</span> <span class="free">ds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">As</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subtensor <span class="main">(</span>subtensor_combine <span class="free">ds</span> <span class="free">As</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> <span class="free">As</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fixed_length_sublist <span class="main">(</span>concat <span class="main">(</span>map vec <span class="free">As</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>prod_list <span class="free">ds</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> vec <span class="main">(</span><span class="free">As</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> concat_parts<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"map vec <span class="free">As</span>"</span></span> <span class="quoted"><span class="quoted">"prod_list <span class="free">ds</span>"</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span> assms imageE length_map length_vec
    nth_map set_map in_set_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> subtensor_def <span class="keyword1"><span class="command">using</span></span> subtensor_combine_dims subtensor_combine_vec
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> nth_mem tensor_from_vec_simp<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor_Subtensor-subtensor_induct"><span class="command">lemma</span></span> subtensor_induct<span class="main">[</span><span class="operator">case_names</span> order_0 order_step<span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> order_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> dims <span class="bound">A</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">A</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> order_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> dims <span class="bound">A</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> hd <span class="main">(</span>dims <span class="bound">A</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>subtensor <span class="bound">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">A</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"dims <span class="free">B</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">B</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Cons
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dims_subtensor list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor_Subtensor-subtensor_combine_induct"><span class="command">lemma</span></span> subtensor_combine_induct<span class="main">[</span><span class="operator">case_names</span> order_0 order_step<span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> order_0<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> dims <span class="bound">A</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">A</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> order_step<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">As</span> <span class="bound">ds</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span><span class="main">∈</span>set <span class="bound">As</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">A</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span><span class="main">∈</span>set <span class="bound">As</span> <span class="main">⟹</span> dims <span class="bound">A</span> <span class="main">=</span> <span class="bound">ds</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>subtensor_combine <span class="bound">ds</span> <span class="bound">As</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>subtensor_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>order_0 <span class="skolem">A</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>order_step <span class="skolem">A</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>subtensor_combine <span class="main">(</span>tl <span class="main">(</span>dims <span class="skolem">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span>subtensor <span class="skolem">A</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>hd <span class="main">(</span>dims <span class="skolem">A</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> atLeastLessThan_iff dims_subtensor imageE set_map set_upt order_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> subtensor_combine_subtensor<span class="main">[</span><span class="operator">OF</span> order_step.hyps<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor_Subtensor-lookup_subtensor1"><span class="command">lemma</span></span> lookup_subtensor1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">#</span> <span class="free">is</span> <span class="main">⊲</span> dims <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span>subtensor <span class="free">A</span> <span class="free">i</span><span class="main">)</span> <span class="free">is</span> <span class="main">=</span> lookup <span class="free">A</span> <span class="main">(</span><span class="free">i</span> <span class="main">#</span> <span class="free">is</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subtensor_combine_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> order_0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>order_step <span class="skolem">As</span> <span class="skolem">ds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span><span class="quoted"><span class="quoted">"subtensor <span class="main">(</span>subtensor_combine <span class="skolem">ds</span> <span class="skolem">As</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> <span class="skolem">As</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.discI list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> order_step.hyps order_step.prems subtensor_combine_dims subtensor_subtensor_combine valid_index_dimsE<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"dims <span class="main">(</span>subtensor_combine <span class="skolem">ds</span> <span class="skolem">As</span><span class="main">)</span> <span class="main">=</span> length <span class="skolem">As</span> <span class="main">#</span> <span class="skolem">ds</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> order_step subtensor_combine_def subtensor_combine_dims <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted">"0"</span> lookup_def 1 <span class="keyword1"><span class="command">unfolding</span></span> lookup_base_Cons <span class="keyword1"><span class="command">using</span></span>  order_step.prems
    <span class="keyword1"><span class="command">using</span></span> Tensor.lookup_base_Cons dims_subtensor lookup_def list.discI list.sel<span class="main">(</span>1<span class="main">)</span>
    list.sel<span class="main">(</span>3<span class="main">)</span>  valid_index_dimsE vec_subtensor <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"0"</span> <span class="quoted">"1"</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor_Subtensor-lookup_subtensor"><span class="command">lemma</span></span> lookup_subtensor<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">⊲</span> dims <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lookup <span class="free">A</span> <span class="free">is</span> <span class="main">=</span> hd <span class="main">(</span>vec <span class="main">(</span>fold <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">A</span><span class="main">.</span> subtensor <span class="bound">A</span> <span class="bound">i</span><span class="main">)</span> <span class="free">is</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="free">is</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Tensor.lookup_base_Nil lookup_def fold_simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> length_0_conv valid_index_length<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="quoted">"<span class="skolem">is</span>"</span> <span class="skolem">A</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> dims_subtensor lookup_subtensor1 fold_simps<span class="main">(</span>2<span class="main">)</span> list.discI list.sel<span class="main">(</span>1<span class="main">)</span> list.sel<span class="main">(</span>3<span class="main">)</span>
    valid_indexE <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor_Subtensor-subtensor_eqI"><span class="command">lemma</span></span> subtensor_eqI<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dims <span class="free">A</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> dims_eq<span class="main">:</span><span class="quoted"><span class="quoted">"dims <span class="free">A</span> <span class="main">=</span> dims <span class="free">B</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span> <span class="main">⟹</span> subtensor <span class="free">A</span> <span class="bound">i</span> <span class="main">=</span> subtensor <span class="free">B</span> <span class="bound">i</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">=</span><span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="quoted">"<span class="skolem">is</span>"</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> dims <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">is'</span></span> <span class="keyword2"><span class="keyword">where</span></span> is_Cons<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">#</span> <span class="skolem">is'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lookup <span class="free">A</span> <span class="skolem">is</span> <span class="main">=</span> lookup <span class="free">B</span> <span class="skolem">is</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lookup_subtensor1 assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">⊲</span> dims <span class="free">A</span>›</span></span> is_Cons list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> valid_index_dimsE<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> tensor_lookup_eqI<span class="main">[</span><span class="operator">OF</span> dims_eq<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Tensor_Plus">
<div class="head">
<h1>Theory Tensor_Plus</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Alexander Bentkamp, Universität des Saarlandes
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Tensor Addition›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Tensor_Plus
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Tensor_Subtensor.html">Tensor_Subtensor</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(* Problem: typeclass plus only has one zero element. If this is the empty tensor, other zero tensors cannot be of rank 0.*)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">vec_plus</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> plus <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span>zip <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">plus_base</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>semigroup_add tensor <span class="main">⇒</span> <span class="tfree">'a</span> tensor <span class="main">⇒</span> <span class="tfree">'a</span> tensor"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">plus_base</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> <span class="main">(</span>tensor_from_vec <span class="main">(</span>dims <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>vec_plus <span class="main">(</span>vec <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>vec <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> tensor<span class="main">::</span> <span class="main">(</span><span class="quoted">semigroup_add</span><span class="main">)</span> <span class="quoted">plus</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> plus_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span>dims <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> dims <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>
                  <span class="keyword1">then</span> plus_base <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span>
                  <span class="keyword1">else</span> undefined<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Tensor_Plus-plus_dim1"><span class="command">lemma</span></span> plus_dim1<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dims <span class="free">A</span> <span class="main">=</span> dims <span class="free">B</span> <span class="main">⟹</span> dims <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> dims <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> plus_def plus_base_def
  <span class="keyword1"><span class="command">using</span></span> dims_tensor length_vec length_map map_fst_zip vec_plus_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1" id="Tensor_Plus-plus_dim2"><span class="command">lemma</span></span> plus_dim2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dims <span class="free">A</span> <span class="main">=</span> dims <span class="free">B</span> <span class="main">⟹</span> dims <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> dims <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> plus_dim1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1" id="Tensor_Plus-plus_base"><span class="command">lemma</span></span> plus_base<span class="main">:</span> <span class="quoted"><span class="quoted">"dims <span class="free">A</span> <span class="main">=</span> dims <span class="free">B</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">+</span> <span class="free">B</span> <span class="main">=</span> plus_base <span class="free">A</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> plus_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="Tensor_Plus-fixed_length_sublist_plus"><span class="command">lemma</span></span> fixed_length_sublist_plus<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs1</span> <span class="main">=</span> <span class="free">c</span> <span class="main">*</span> <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs2</span> <span class="main">=</span> <span class="free">c</span> <span class="main">*</span> <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">c</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fixed_length_sublist <span class="main">(</span>vec_plus <span class="free">xs1</span> <span class="free">xs2</span><span class="main">)</span> <span class="free">l</span> <span class="free">i</span>
          <span class="main">=</span> vec_plus <span class="main">(</span>fixed_length_sublist <span class="free">xs1</span> <span class="free">l</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>fixed_length_sublist <span class="free">xs2</span> <span class="free">l</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> vec_plus_def fixed_length_sublist_def <span class="keyword1"><span class="command">using</span></span> drop_map drop_zip take_map take_zip <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="Tensor_Plus-vec_plus"><span class="command">lemma</span></span> vec_plus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dims <span class="free">A</span> <span class="main">=</span> dims <span class="free">B</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vec <span class="main">(</span><span class="free">A</span><span class="main">+</span><span class="free">B</span><span class="main">)</span> <span class="main">=</span> vec_plus <span class="main">(</span>vec <span class="free">A</span><span class="main">)</span> <span class="main">(</span>vec <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> plus_def plus_base_def vec_plus_def <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> length_map length_tensor_vec_from_lookup map_fst_zip tensor_lookup tensor_from_lookup_def vec_tensor<span class="main">)</span>

<span class="keyword1" id="Tensor_Plus-subtensor_plus"><span class="command">lemma</span></span> subtensor_plus<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>semigroup_add tensor"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">B</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>semigroup_add tensor"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dims <span class="free">A</span> <span class="main">=</span> dims <span class="free">B</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dims <span class="free">A</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subtensor <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> subtensor <span class="free">A</span> <span class="free">i</span> <span class="main">+</span> subtensor <span class="free">B</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>vec <span class="free">A</span><span class="main">)</span> <span class="main">=</span>  hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span> <span class="main">*</span> prod_list <span class="main">(</span>tl <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"length <span class="main">(</span>Tensor.vec <span class="free">B</span><span class="main">)</span> <span class="main">=</span> hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span> <span class="main">*</span> prod_list <span class="main">(</span>tl <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> length_vec prod_list.Cons assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> list.exhaust_sel<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
   <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
     <span class="keyword1"><span class="command">using</span></span> Tensor_Plus.vec_plus assms fixed_length_sublist_plus vec_subtensor tensor_eqI
     dims_subtensor plus_dim1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor_Plus-lookup_plus"><span class="command">lemma</span></span> lookup_plus<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dims <span class="free">A</span> <span class="main">=</span> dims <span class="free">B</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">⊲</span> dims <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="free">is</span> <span class="main">=</span> lookup <span class="free">A</span> <span class="free">is</span> <span class="main">+</span> lookup <span class="free">B</span> <span class="free">is</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">+</span><span class="free">B</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> subtensor_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>order_0 <span class="skolem">A</span> <span class="skolem">B</span> <span class="quoted">"<span class="skolem">is</span>"</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">⊲</span> dims <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> order_0 <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">=</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">⊲</span> dims <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> order_0 <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">=</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">⊲</span> dims <span class="main">(</span><span class="skolem">A</span> <span class="main">+</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> order_0 <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">=</span> <span class="main">[]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>vec <span class="skolem">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>vec <span class="skolem">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_vec prod_list.Nil order_0.hyps order_0.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> plus_dim1<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> lookup_subtensor<span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span> lookup_subtensor<span class="main">[</span><span class="operator">OF</span> 2<span class="main">]</span> lookup_subtensor<span class="main">[</span><span class="operator">OF</span> 3<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">=</span> <span class="main">[]</span>›</span></span>
    fold_simps<span class="main">(</span>1<span class="main">)</span> vec_plus<span class="main">[</span><span class="operator">OF</span> order_0.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> vec_plus_def <span class="keyword1"><span class="command">using</span></span>  order_0.prems  length_map
    list.map_sel<span class="main">(</span>1<span class="main">)</span> list.size<span class="main">(</span>3<span class="main">)</span>  map_fst_zip map_snd_zip order_0.hyps
    zero_neq_one case_prod_unfold length_vec <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>order_step <span class="skolem">A</span> <span class="skolem">B</span> <span class="quoted">"<span class="skolem">is</span>"</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">is'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">#</span> <span class="skolem">is'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> dims <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> order_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> dims <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> order_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> dims <span class="main">(</span><span class="skolem">A</span> <span class="main">+</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> order_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span>subtensor <span class="skolem">A</span> <span class="skolem">i</span> <span class="main">+</span> subtensor <span class="skolem">B</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">is'</span> <span class="main">=</span> lookup <span class="main">(</span>subtensor <span class="skolem">A</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">is'</span> <span class="main">+</span> lookup <span class="main">(</span>subtensor <span class="skolem">B</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">is'</span>"</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_step.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">#</span> <span class="skolem">is'</span>›</span></span> 3 hd_conv_nth length_greater_0_conv nth_Cons_0 order_step.hyps<span class="main">(</span>1<span class="main">)</span> valid_index_lt
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2"</span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">#</span> <span class="skolem">is'</span>›</span></span> list.inject list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> order_step.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> subtensor_plus valid_index.cases<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">#</span> <span class="skolem">is'</span>›</span></span> order_step.prems<span class="main">(</span>1<span class="main">)</span> plus_dim1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
     <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">#</span> <span class="skolem">is'</span>›</span></span> plus_dim1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> lookup_subtensor<span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span> lookup_subtensor<span class="main">[</span><span class="operator">OF</span> 2<span class="main">]</span> lookup_subtensor<span class="main">[</span><span class="operator">OF</span> 3<span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> order_step <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">#</span> <span class="skolem">is'</span>›</span></span> plus_dim1 lookup_subtensor1 list.sel<span class="main">(</span>1<span class="main">)</span> subtensor_plus valid_index_dimsE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor_Plus-plus_assoc"><span class="command">lemma</span></span> plus_assoc<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> dimsA<span class="main">:</span><span class="quoted"><span class="quoted">"dims <span class="free">A</span> <span class="main">=</span> <span class="free">ds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dimsB<span class="main">:</span><span class="quoted"><span class="quoted">"dims <span class="free">B</span> <span class="main">=</span> <span class="free">ds</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> dimsC<span class="main">:</span><span class="quoted"><span class="quoted">"dims <span class="free">C</span> <span class="main">=</span> <span class="free">ds</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">+</span> <span class="free">C</span> <span class="main">=</span> <span class="free">A</span> <span class="main">+</span> <span class="main">(</span><span class="free">B</span> <span class="main">+</span> <span class="free">C</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tensor_lookup_eqI<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dimsA dimsB dimsC add.assoc<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Tensor_Plus-tensor_comm"><span class="command">lemma</span></span> tensor_comm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>ab_semigroup_add tensor"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">+</span> <span class="free">B</span> <span class="main">=</span> <span class="free">B</span> <span class="main">+</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"dims <span class="free">A</span> <span class="main">=</span> dims <span class="free">B</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> plus_def plus_base_def
    <span class="keyword1"><span class="command">using</span></span> add.commute lookup_plus<span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span> plus_dim1<span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span> tensor_lookup_eqI<span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span> vec_plus<span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lookup_plus plus_dim1 tensor_lookup_eqI vec_plus<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> plus_def plus_base_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">vec0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> replicate <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">tensor0</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>zero tensor"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">tensor0</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> tensor_from_vec <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">(</span>vec0 <span class="main">(</span>prod_list <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Tensor_Plus-dims_tensor0"><span class="command">lemma</span></span> dims_tensor0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dims <span class="main">(</span>tensor0 <span class="free">d</span><span class="main">)</span> <span class="main">=</span> <span class="free">d</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span>   vec_tensor0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"vec <span class="main">(</span>tensor0 <span class="free">d</span><span class="main">)</span> <span class="main">=</span> vec0 <span class="main">(</span>prod_list <span class="free">d</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tensor0_def vec0_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="Tensor_Plus-lookup_is_in_vec"><span class="command">lemma</span></span> lookup_is_in_vec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">⊲</span> <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span> <span class="main">⟹</span> lookup <span class="free">A</span> <span class="free">is</span> <span class="main">∈</span> set <span class="main">(</span>vec <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="quoted">"<span class="free">is</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>subtensor_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> order_0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> lookup_def <span class="keyword1"><span class="command">using</span></span> lookup_base_Nil
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_0_conv length_vec list.set_sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> prod_list.Nil valid_index_length zero_neq_one<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>order_step <span class="skolem">A</span> <span class="quoted">"<span class="skolem">is</span>"</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">is'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">#</span> <span class="skolem">is'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> valid_index_dimsE <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> hd <span class="main">(</span>dims <span class="skolem">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dims_def order_step.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">is'</span> <span class="main">⊲</span> dims <span class="main">(</span>subtensor <span class="skolem">A</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">#</span> <span class="skolem">is'</span>›</span></span> dims_subtensor order_step.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lookup <span class="skolem">A</span> <span class="skolem">is</span> <span class="main">∈</span> set <span class="main">(</span>Tensor.vec <span class="main">(</span>subtensor <span class="skolem">A</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> order_step.IH <span class="main">[</span><span class="operator">OF</span> 1 2<span class="main">]</span> lookup_subtensor1 <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">#</span> <span class="skolem">is'</span>›</span></span> order_step.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> vec_subtensor fixed_length_sublist_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1"</span> in_set_dropD in_set_takeD order_step.hyps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor_Plus-lookup_tensor0"><span class="command">lemma</span></span> lookup_tensor0<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">⊲</span> <span class="free">ds</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span>tensor0 <span class="free">ds</span><span class="main">)</span> <span class="free">is</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span>tensor0 <span class="free">ds</span><span class="main">)</span> <span class="free">is</span> <span class="main">∈</span> set <span class="main">(</span>vec <span class="main">(</span>tensor0 <span class="free">ds</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lookup_is_in_vec assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dims_tensor0<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>vec <span class="main">(</span>tensor0 <span class="free">ds</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> vec_tensor0 vec0_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_replicate singleton_iff subsetI<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>monoid_add tensor"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> tensor_add_0_right<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">+</span> tensor0 <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> plus_def plus_base_def dims_tensor0
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> tensor_lookup_eqI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span>  dims_tensor dims_tensor0 length_vec plus_dim2 vec_plus vec_tensor0<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.right_neutral dims_tensor0 lookup_plus lookup_tensor0 plus_dim2 tensor_from_vec_simp vec_plus vec_tensor0<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>monoid_add tensor"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> tensor_add_0_left<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>  <span class="quoted"><span class="quoted">"tensor0 <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span> <span class="main">+</span> <span class="free">A</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> plus_def plus_base_def dims_tensor0
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> tensor_lookup_eqI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span>  dims_tensor dims_tensor0 length_vec plus_dim2 vec_plus vec_tensor0<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.left_neutral dims_tensor0 lookup_plus lookup_tensor0 plus_dim2 tensor_from_vec_simp vec_plus vec_tensor0<span class="main">)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">listsum</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>monoid_add tensor list <span class="main">⇒</span> <span class="tfree">'a</span> tensor"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">listsum</span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span> <span class="free"><span class="bound"><span class="entity">As</span></span></span> <span class="main">=</span> foldr <span class="main">(+)</span> <span class="free"><span class="bound"><span class="entity">As</span></span></span> <span class="main">(</span>tensor0 <span class="free"><span class="bound"><span class="entity">ds</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">listsum'</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>monoid_add tensor list <span class="main">⇒</span> <span class="tfree">'a</span> tensor"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">listsum'</span> <span class="free"><span class="bound"><span class="entity">As</span></span></span> <span class="main">=</span> listsum <span class="main">(</span>dims <span class="main">(</span>hd <span class="free"><span class="bound"><span class="entity">As</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">As</span></span></span>"</span></span>

<span class="keyword1" id="Tensor_Plus-listsum_Nil"><span class="command">lemma</span></span> listsum_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"listsum <span class="free">ds</span> <span class="main">[]</span> <span class="main">=</span> tensor0 <span class="free">ds</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Tensor_Plus.listsum_def<span class="main">)</span>

<span class="keyword1" id="Tensor_Plus-listsum_one"><span class="command">lemma</span></span> listsum_one<span class="main">:</span> <span class="quoted"><span class="quoted">"listsum <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span> <span class="main">[</span><span class="free">A</span><span class="main">]</span> <span class="main">=</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> listsum_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Tensor_Plus-listsum_Cons"><span class="command">lemma</span></span> listsum_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"listsum <span class="free">ds</span> <span class="main">(</span><span class="free">A</span> <span class="main">#</span> <span class="free">As</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="main">+</span> listsum <span class="free">ds</span> <span class="free">As</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> listsum_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Tensor_Plus-listsum_dims"><span class="command">lemma</span></span> listsum_dims<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span><span class="main">∈</span>set <span class="free">As</span> <span class="main">⟹</span> dims <span class="bound">A</span> <span class="main">=</span> <span class="free">ds</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dims <span class="main">(</span>listsum <span class="free">ds</span> <span class="free">As</span><span class="main">)</span> <span class="main">=</span> <span class="free">ds</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">As</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dims_tensor0 listsum_Nil<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">A</span> <span class="skolem">As</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> listsum_Cons
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.set_intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> plus_dim2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor_Plus-subtensor0"><span class="command">lemma</span></span> subtensor0<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ds</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span>hd <span class="free">ds</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subtensor <span class="main">(</span>tensor0 <span class="free">ds</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> tensor0 <span class="main">(</span>tl <span class="free">ds</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> tensor_lookup_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"dims <span class="main">(</span>subtensor <span class="main">(</span>tensor0 <span class="free">ds</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> dims <span class="main">(</span>tensor0 <span class="main">(</span>tl <span class="free">ds</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="quoted">"<span class="skolem">is</span>"</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> dims <span class="main">(</span>subtensor <span class="main">(</span>tensor0 <span class="free">ds</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">#</span> <span class="skolem">is</span> <span class="main">⊲</span> dims <span class="main">(</span>tensor0 <span class="free">ds</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> valid_index.Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span>subtensor <span class="main">(</span>tensor0 <span class="free">ds</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">is</span> <span class="main">=</span> lookup <span class="main">(</span>tensor0 <span class="main">(</span>tl <span class="free">ds</span><span class="main">)</span><span class="main">)</span> <span class="skolem">is</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lookup_subtensor1  1 <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">⊲</span> dims <span class="main">(</span>subtensor <span class="main">(</span>tensor0 <span class="free">ds</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span>›</span></span> dims_tensor0 lookup_tensor0
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor_Plus-subtensor_listsum"><span class="command">lemma</span></span> subtensor_listsum<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span><span class="main">∈</span>set <span class="free">As</span> <span class="main">⟹</span> dims <span class="bound">A</span> <span class="main">=</span> <span class="free">ds</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ds</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span>hd <span class="free">ds</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subtensor <span class="main">(</span>listsum <span class="free">ds</span> <span class="free">As</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> listsum <span class="main">(</span>tl <span class="free">ds</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> subtensor <span class="bound">A</span> <span class="free">i</span><span class="main">)</span> <span class="free">As</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">As</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> lookup_tensor0 assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> subtensor0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> listsum_Nil<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">A</span> <span class="skolem">As</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> listsum_Cons<span class="main"><span class="keyword3">;</span></span> <span class="operator">metis</span> subtensor_plus listsum_dims<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Tensor_Plus-listsum0"><span class="command">lemma</span></span> listsum0<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span><span class="main">∈</span>set <span class="free">As</span> <span class="main">⟹</span> <span class="bound">A</span> <span class="main">=</span> tensor0 <span class="free">ds</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"listsum <span class="free">ds</span> <span class="free">As</span> <span class="main">=</span> tensor0 <span class="free">ds</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">As</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> listsum_Nil<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Cons
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> listsum_Cons
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dims_tensor0 list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> set_subset_Cons subsetCE tensor_add_0_right<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor_Plus-listsum_all_0_but_one"><span class="command">lemma</span></span> listsum_all_0_but_one<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">≠</span><span class="free">j</span> <span class="main">⟹</span> <span class="bound">i</span><span class="main">&lt;</span>length <span class="free">As</span> <span class="main">⟹</span> <span class="free">As</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> tensor0 <span class="free">ds</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dims <span class="main">(</span><span class="free">As</span><span class="main">!</span><span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">ds</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">As</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"listsum <span class="free">ds</span> <span class="free">As</span> <span class="main">=</span> <span class="free">As</span><span class="main">!</span><span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">As</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">j</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">A</span> <span class="skolem">As</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">As</span> <span class="main">⟹</span> <span class="skolem">As</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> tensor0 <span class="free">ds</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">using</span></span> Suc_less_eq length_Cons list.sel<span class="main">(</span>3<span class="main">)</span> nat.simps<span class="main">(</span>3<span class="main">)</span> nth_tl <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"listsum <span class="free">ds</span> <span class="skolem">As</span> <span class="main">=</span> tensor0 <span class="free">ds</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> listsum0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"0"</span> Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> listsum_Cons nth_Cons_0 tensor_add_0_right<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j'</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"listsum <span class="free">ds</span> <span class="skolem">As</span> <span class="main">=</span> <span class="skolem">As</span><span class="main">!</span><span class="skolem">j'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Cons.IH Cons.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Cons.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> Suc_less_eq length_Cons less_Suc_eq list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> not_less_eq nth_tl<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Suc length_greater_0_conv list.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> listsum_Cons nat.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> nth_Cons_0 nth_Cons_Suc tensor_add_0_left<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor_Plus-lookup_listsum"><span class="command">lemma</span></span> lookup_listsum<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">⊲</span> <span class="free">ds</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> set <span class="free">As</span> <span class="main">⟹</span> dims <span class="bound">A</span> <span class="main">=</span> <span class="free">ds</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span>listsum <span class="free">ds</span> <span class="free">As</span><span class="main">)</span> <span class="free">is</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">A</span><span class="main">←</span><span class="free">As</span><span class="main">.</span> lookup <span class="bound">A</span> <span class="free">is</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">As</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> listsum_Nil lookup_tensor0<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">A</span> <span class="skolem">As</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> listsum_Cons list.set_intros listsum_dims<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Tensor_Scalar_Mult">
<div class="head">
<h1>Theory Tensor_Scalar_Mult</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Alexander Bentkamp, Universität des Saarlandes
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Tensor Scalar Multiplication›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Tensor_Scalar_Mult
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Tensor_Plus.html">Tensor_Plus</a> <a href="Tensor_Subtensor.html">Tensor_Subtensor</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">vec_smult</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>ring <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">vec_smult</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="main">=</span> map <span class="main">(</span><span class="main">(*)</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">β</span></span></span>"</span></span>

<span class="keyword1" id="Tensor_Scalar_Mult-vec_smult0"><span class="command">lemma</span></span> vec_smult0<span class="main">:</span> <span class="quoted"><span class="quoted">"vec_smult <span class="main">0</span> <span class="free">as</span> <span class="main">=</span> vec0 <span class="main">(</span>length <span class="free">as</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">as</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>vec0_def vec_smult_def<span class="main">)</span>

<span class="keyword1" id="Tensor_Scalar_Mult-vec_smult_distr_right"><span class="command">lemma</span></span> vec_smult_distr_right<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vec_smult <span class="main">(</span><span class="free">α</span> <span class="main">+</span> <span class="free">β</span><span class="main">)</span> <span class="free">as</span> <span class="main">=</span> vec_plus <span class="main">(</span>vec_smult <span class="free">α</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span>vec_smult <span class="free">β</span> <span class="free">as</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> vec_smult_def vec_plus_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">as</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_right<span class="main">)</span>

<span class="keyword1" id="Tensor_Scalar_Mult-vec_smult_Cons"><span class="command">lemma</span></span> vec_smult_Cons<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vec_smult <span class="free">α</span> <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">as</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">α</span> <span class="main">*</span> <span class="free">a</span><span class="main">)</span> <span class="main">#</span> vec_smult <span class="free">α</span> <span class="free">as</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vec_smult_def<span class="main">)</span>

<span class="keyword1" id="Tensor_Scalar_Mult-vec_plus_Cons"><span class="command">lemma</span></span> vec_plus_Cons<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vec_plus <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="main">#</span> <span class="free">bs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span><span class="main">+</span><span class="free">b</span><span class="main">)</span> <span class="main">#</span> vec_plus <span class="free">as</span> <span class="free">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vec_plus_def<span class="main">)</span>

<span class="keyword1" id="Tensor_Scalar_Mult-vec_smult_distr_left"><span class="command">lemma</span></span> vec_smult_distr_left<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">as</span> <span class="main">=</span> length <span class="free">bs</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"vec_smult <span class="free">α</span> <span class="main">(</span>vec_plus <span class="free">as</span> <span class="free">bs</span><span class="main">)</span> <span class="main">=</span> vec_plus <span class="main">(</span>vec_smult <span class="free">α</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span>vec_smult <span class="free">α</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">bs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> vec_smult_def vec_plus_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">bs'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bs</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">#</span> <span class="skolem">bs'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_length_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span><span class="quoted"><span class="quoted">"vec_smult <span class="free">α</span> <span class="main">(</span>vec_plus <span class="main">(</span><span class="skolem">a</span> <span class="main">#</span> <span class="skolem">as'</span><span class="main">)</span> <span class="skolem">bs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">α</span><span class="main">*</span><span class="main">(</span><span class="skolem">a</span><span class="main">+</span><span class="skolem">b</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> vec_smult <span class="free">α</span> <span class="main">(</span>vec_plus <span class="skolem">as'</span> <span class="skolem">bs'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> vec_smult_def vec_plus_def <span class="keyword1"><span class="command">using</span></span> Cons.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">bs'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">bs'</span> <span class="main">=</span> length <span class="skolem">as'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems <span class="quoted"><span class="quoted">‹<span class="skolem">bs</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">#</span> <span class="skolem">bs'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> 0 <span class="keyword1"><span class="command">unfolding</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">bs</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">#</span> <span class="skolem">bs'</span>›</span></span> vec_smult_Cons vec_plus_Cons
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons.IH distrib_left<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor_Scalar_Mult-length_vec_smult"><span class="command">lemma</span></span> length_vec_smult<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>vec_smult <span class="free">α</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> length <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> vec_smult_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">smult</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>ring <span class="main">⇒</span> <span class="tfree">'a</span> tensor <span class="main">⇒</span> <span class="tfree">'a</span> tensor"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⋅</span>"</span> 70<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">smult</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">(</span>tensor_from_vec <span class="main">(</span>dims <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>vec_smult <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">(</span>vec <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1" id="Tensor_Scalar_Mult-tensor_smult0"><span class="command">lemma</span></span> tensor_smult0<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>ring tensor"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">⋅</span> <span class="free">A</span> <span class="main">=</span> tensor0 <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> smult_def tensor0_def vec_smult_def <span class="keyword1"><span class="command">using</span></span> vec_smult0 length_vec
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> vec_smult_def<span class="main">)</span>

<span class="keyword1" id="Tensor_Scalar_Mult-dims_smult"><span class="command">lemma</span></span> dims_smult<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"dims <span class="main">(</span><span class="free">α</span> <span class="main">⋅</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> dims <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span>   vec_smult<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vec  <span class="main">(</span><span class="free">α</span> <span class="main">⋅</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span><span class="main">(*)</span> <span class="free">α</span><span class="main">)</span> <span class="main">(</span>vec <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> smult_def vec_smult_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_vec<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Tensor_Scalar_Mult-tensor_smult_distr_right"><span class="command">lemma</span></span> tensor_smult_distr_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">α</span> <span class="main">+</span> <span class="free">β</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">A</span> <span class="main">=</span> <span class="free">α</span> <span class="main">⋅</span> <span class="free">A</span>  <span class="main">+</span> <span class="free">β</span> <span class="main">⋅</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> plus_def plus_base_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">metis</span> smult_def vec_smult_def vec_smult_distr_right<span class="main">)</span>

<span class="keyword1" id="Tensor_Scalar_Mult-tensor_smult_distr_left"><span class="command">lemma</span></span> tensor_smult_distr_left<span class="main">:</span> <span class="quoted"><span class="quoted">"dims <span class="free">A</span> <span class="main">=</span> dims <span class="free">B</span> <span class="main">⟹</span> <span class="free">α</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">α</span> <span class="main">⋅</span> <span class="free">A</span>  <span class="main">+</span> <span class="free">α</span> <span class="main">⋅</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"dims <span class="free">A</span> <span class="main">=</span> dims <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>vec_plus <span class="main">(</span>vec <span class="free">A</span><span class="main">)</span> <span class="main">(</span>vec <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>vec <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_vec vec_plus_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> f3<span class="main">:</span> <span class="quoted"><span class="quoted">"dims <span class="main">(</span>tensor_from_vec <span class="main">(</span>dims <span class="free">B</span><span class="main">)</span> <span class="main">(</span>vec_smult <span class="free">α</span> <span class="main">(</span>vec <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dims <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_vec vec_smult_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> f4<span class="main">:</span> <span class="quoted"><span class="quoted">"vec <span class="main">(</span><span class="free">α</span> <span class="main">⋅</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> vec_smult <span class="free">α</span> <span class="main">(</span>vec <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vec_smult_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>vec_smult <span class="free">α</span> <span class="main">(</span>vec <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>vec <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vec_smult_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> plus_def plus_base_def <span class="keyword1"><span class="command">using</span></span> f4 f3 f2 a1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_vec smult_def vec_smult_distr_left<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor_Scalar_Mult-smult_fixed_length_sublist"><span class="command">lemma</span></span> smult_fixed_length_sublist<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> <span class="free">l</span> <span class="main">*</span> <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="free">c</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fixed_length_sublist <span class="main">(</span>vec_smult <span class="free">α</span> <span class="free">xs</span><span class="main">)</span> <span class="free">l</span> <span class="free">i</span> <span class="main">=</span> vec_smult <span class="free">α</span> <span class="main">(</span>fixed_length_sublist <span class="free">xs</span> <span class="free">l</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> fixed_length_sublist_def vec_smult_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drop_map take_map<span class="main">)</span>

<span class="keyword1" id="Tensor_Scalar_Mult-smult_subtensor"><span class="command">lemma</span></span> smult_subtensor<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dims <span class="free">A</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">⋅</span> subtensor <span class="free">A</span> <span class="free">i</span> <span class="main">=</span> subtensor <span class="main">(</span><span class="free">α</span> <span class="main">⋅</span> <span class="free">A</span><span class="main">)</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> tensor_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dims <span class="main">(</span><span class="free">α</span> <span class="main">⋅</span> subtensor <span class="free">A</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> dims <span class="main">(</span>subtensor <span class="main">(</span><span class="free">α</span> <span class="main">⋅</span> <span class="free">A</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dims_smult dims_subtensor assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"vec <span class="main">(</span><span class="free">α</span> <span class="main">⋅</span> subtensor <span class="free">A</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> vec <span class="main">(</span>subtensor <span class="main">(</span><span class="free">α</span> <span class="main">⋅</span> <span class="free">A</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> vec_smult
    <span class="keyword1"><span class="command">unfolding</span></span> vec_subtensor<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹dims <span class="free">A</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> vec_subtensor<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">⋅</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> drop_map fixed_length_sublist_def take_map<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor_Scalar_Mult-lookup_smult"><span class="command">lemma</span></span> lookup_smult<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">⊲</span> dims <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="free">α</span> <span class="main">⋅</span> <span class="free">A</span><span class="main">)</span> <span class="free">is</span> <span class="main">=</span> <span class="free">α</span> <span class="main">*</span> lookup <span class="free">A</span> <span class="free">is</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="quoted">"<span class="free">is</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>subtensor_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>order_0 <span class="skolem">A</span> <span class="quoted">"<span class="skolem">is</span>"</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>vec <span class="skolem">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_vec<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>vec_smult <span class="free">α</span> <span class="main">(</span>vec <span class="skolem">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">α</span> <span class="main">*</span> hd <span class="main">(</span>vec <span class="skolem">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> vec_smult_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.map_sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> zero_neq_one<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> order_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> smult_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹length <span class="main">(</span>Tensor.vec <span class="skolem">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>›</span></span> lookup_def length_vec_smult order_0.hyps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>order_step <span class="skolem">A</span> <span class="quoted">"<span class="skolem">is</span>"</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">is'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">#</span> <span class="skolem">is'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="free">α</span> <span class="main">⋅</span> subtensor <span class="skolem">A</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">is'</span> <span class="main">=</span> <span class="free">α</span> <span class="main">*</span> lookup <span class="main">(</span>subtensor <span class="skolem">A</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">is'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> dims_subtensor list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> order_step.IH order_step.hyps order_step.prems valid_index_dimsE<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> smult_subtensor <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">#</span> <span class="skolem">is'</span>›</span></span> dims_smult lookup_subtensor1
    list.sel<span class="main">(</span>1<span class="main">)</span> order_step.hyps order_step.prems valid_index_dimsE
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor_Scalar_Mult-tensor_smult_assoc"><span class="command">lemma</span></span> tensor_smult_assoc<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>ring tensor"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">β</span> <span class="main">⋅</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">α</span> <span class="main">*</span> <span class="free">β</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tensor_lookup_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> lookup_smult dims_smult mult.assoc<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Tensor_Product">
<div class="head">
<h1>Theory Tensor_Product</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Alexander Bentkamp, Universität des Saarlandes
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Tensor Product›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Tensor_Product
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Tensor_Scalar_Mult.html">Tensor_Scalar_Mult</a> <a href="Tensor_Subtensor.html">Tensor_Subtensor</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> tensor<span class="main">::</span> <span class="main">(</span><span class="quoted">ring</span><span class="main">)</span> <span class="quoted">semigroup_mult</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> tensor_prod_def<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> tensor_from_vec <span class="main">(</span>dims <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">@</span> dims <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">(</span>concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> vec_smult <span class="bound">a</span> <span class="main">(</span>vec <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>vec <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">tensor_prod_otimes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tensor <span class="main">⇒</span> <span class="tfree">'a</span> tensor <span class="main">⇒</span> <span class="tfree">'a</span> tensor"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊗</span>"</span> 70<span class="main">)</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main"><span class="free">⊗</span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span>"</span></span>


  <span class="keyword1" id="Tensor_Product-vec_tensor_prod"><span class="command">lemma</span></span> vec_tensor_prod<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"vec <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> vec_smult <span class="bound">a</span> <span class="main">(</span>vec <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>vec <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?V</span></span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> dims_tensor_prod<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"dims <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> dims <span class="free">A</span> <span class="main">@</span> dims <span class="free">B</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?D</span></span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> vec_smult <span class="bound">a</span> <span class="main">(</span>vec <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>vec <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> prod_list <span class="main">(</span>dims <span class="free">A</span> <span class="main">@</span> dims <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="bound">xs</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> vec_smult <span class="bound">a</span> <span class="main">(</span>vec <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>vec <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> length <span class="bound">xs</span> <span class="main">=</span> length <span class="main">(</span>vec <span class="free">B</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> length_vec_smult <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> concat_equal_length <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_map length_vec prod_list.append<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?V</span></span></span> <span class="var"><span class="quoted"><span class="var">?D</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tensor_prod_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Tensor_Product-tensorprod_subtensor_base"><span class="command">lemma</span></span> tensorprod_subtensor_base<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"concat <span class="main">(</span>map <span class="free">f</span> <span class="main">(</span>concat <span class="free">xss</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> concat <span class="main">(</span>map <span class="free">f</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span> <span class="free">xss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xss</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1" id="Tensor_Product-subtensor_combine_tensor_prod"><span class="command">lemma</span></span> subtensor_combine_tensor_prod<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span><span class="main">∈</span>set <span class="free">As</span> <span class="main">⟹</span> dims <span class="bound">A</span> <span class="main">=</span> <span class="free">ds</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subtensor_combine <span class="free">ds</span> <span class="free">As</span> <span class="main">⊗</span> <span class="free">B</span> <span class="main">=</span> subtensor_combine <span class="main">(</span><span class="free">ds</span> <span class="main">@</span> dims <span class="free">B</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span> <span class="free">As</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span><span class="main">.</span> vec_smult <span class="bound">a</span> <span class="main">(</span>Tensor.vec <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xss</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map Tensor.vec <span class="free">As</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"prod_list <span class="main">(</span>length <span class="free">As</span> <span class="main">#</span> <span class="free">ds</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>concat <span class="var">?xss</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms length_vec subtensor_combine_dims subtensor_combine_vec<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span><span class="main">∈</span>set <span class="free">As</span> <span class="main">⟹</span> prod_list <span class="main">(</span>dims <span class="bound">A</span> <span class="main">@</span> dims <span class="free">B</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>concat <span class="main">(</span>map <span class="var">?f</span> <span class="main">(</span>Tensor.vec <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dims_tensor_prod length_vec vec_tensor_prod<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">As</span> <span class="main">#</span> <span class="free">ds</span> <span class="main">@</span> dims <span class="free">B</span> <span class="main">=</span> <span class="main">(</span>length <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> tensor_from_vec <span class="main">(</span>dims <span class="bound">A</span> <span class="main">@</span> dims <span class="free">B</span><span class="main">)</span>
      <span class="main">(</span>concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> vec_smult <span class="bound">a</span> <span class="main">(</span>vec <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>vec <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">As</span><span class="main">)</span> <span class="main">#</span> <span class="free">ds</span> <span class="main">@</span> dims <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span>concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> vec_smult <span class="bound">a</span> <span class="main">(</span>vec <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map vec <span class="free">As</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
         <span class="main">=</span> <span class="main">(</span>concat <span class="main">(</span>map vec <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> tensor_from_vec <span class="main">(</span>dims <span class="bound">A</span> <span class="main">@</span> dims <span class="free">B</span><span class="main">)</span> <span class="main">(</span>concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> vec_smult <span class="bound">a</span> <span class="main">(</span>vec <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>vec <span class="bound">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>  <span class="free">As</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> map_map<span class="main">[</span><span class="operator">unfolded</span> comp_def<span class="main">]</span>  <span class="keyword1"><span class="command">using</span></span> vec_tensor <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted">"2"</span> map_eq_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subtensor_combine <span class="free">ds</span> <span class="free">As</span> <span class="main">⊗</span> <span class="free">B</span> <span class="main">=</span> tensor_from_vec <span class="main">(</span>length <span class="free">As</span> <span class="main">#</span> <span class="free">ds</span> <span class="main">@</span> dims <span class="free">B</span><span class="main">)</span> <span class="main">(</span>concat <span class="main">(</span>map <span class="var">?f</span> <span class="main">(</span>concat <span class="main">(</span><span class="var">?xss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> subtensor_combine_def tensor_prod_def <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> tensor_from_vec <span class="main">(</span>length <span class="free">As</span> <span class="main">#</span> <span class="free">ds</span> <span class="main">@</span> dims <span class="free">B</span><span class="main">)</span> <span class="main">(</span>concat <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> concat <span class="main">(</span>map <span class="var">?f</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span> <span class="var">?xss</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tensorprod_subtensor_base<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="var"><span class="quoted"><span class="var">?xss</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>subtensor_combine <span class="main">(</span><span class="free">ds</span> <span class="main">@</span> dims <span class="free">B</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span> <span class="free">As</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> subtensor_combine_def tensor_prod_def <span class="keyword1"><span class="command">using</span></span> 3 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">(* evtl. besser ohne Induktion beweisen? Dann wäre das obige Lemma unnötig. Vllt aber auch schwierig. *)</span>
  <span class="keyword1" id="Tensor_Product-subtensor_tensor_prod"><span class="command">lemma</span></span> subtensor_tensor_prod<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dims <span class="free">A</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subtensor <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> subtensor <span class="free">A</span> <span class="free">i</span> <span class="main">⊗</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>subtensor_combine_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> order_0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>order_step <span class="skolem">As</span> <span class="skolem">ds</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span> <span class="skolem">As</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> order_step <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> order_step.hyps order_step.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span> <span class="skolem">As</span><span class="main">)</span> <span class="main">⟹</span> dims <span class="bound">A</span> <span class="main">=</span> <span class="skolem">ds</span> <span class="main">@</span> dims <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> order_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"subtensor <span class="main">(</span>subtensor_combine <span class="skolem">ds</span> <span class="skolem">As</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> subtensor <span class="main">(</span>subtensor_combine <span class="main">(</span><span class="skolem">ds</span> <span class="main">@</span> dims <span class="free">B</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span> <span class="skolem">As</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> subtensor_combine_tensor_prod order_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">As</span> <span class="main">!</span> <span class="free">i</span> <span class="main">⊗</span> <span class="free">B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> order_step subtensor_subtensor_combine<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span> <span class="skolem">As</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ds</span> <span class="main">@</span> dims <span class="free">B</span>"</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> subtensor <span class="main">(</span>subtensor_combine <span class="skolem">ds</span> <span class="skolem">As</span><span class="main">)</span> <span class="free">i</span> <span class="main">⊗</span> <span class="free">B</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1"</span> length_map order_step.hyps subtensor_subtensor_combine<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Tensor_Product-lookup_tensor_prod"><span class="command">lemma</span></span> lookup_tensor_prod<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> is1_valid<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">is1</span> <span class="main">⊲</span> dims <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> is2_valid<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">is2</span> <span class="main">⊲</span> dims <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">is1</span> <span class="main">@</span> <span class="free">is2</span><span class="main">)</span> <span class="main">=</span> lookup <span class="free">A</span> <span class="free">is1</span> <span class="main">*</span> lookup <span class="free">B</span> <span class="free">is2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">is1</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>subtensor_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>order_0 <span class="skolem">A</span> <span class="skolem">is1</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"vec <span class="skolem">A</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc_length_conv Tensor.tensor_vec_from_lookup_Nil length_0_conv length_tensor_vec_from_lookup length_vec <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊗</span> <span class="free">B</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">⋅</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> tensor_prod_def smult_def <span class="keyword1"><span class="command">using</span></span> order_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lookup <span class="skolem">A</span> <span class="main">[]</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹Tensor.vec <span class="skolem">A</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span>›</span></span> lookup_def order_0.hyps<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="skolem">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="free">is2</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">*</span> lookup <span class="free">B</span> <span class="free">is2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_smult is2_valid<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹lookup <span class="skolem">A</span> <span class="main">[]</span> <span class="main">=</span> <span class="skolem">a</span>›</span></span> null_rec<span class="main">(</span>1<span class="main">)</span> order_0.hyps order_0.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>order_step <span class="skolem">A</span> <span class="skolem">is1</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">is1'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">#</span> <span class="skolem">is1'</span> <span class="main">=</span> <span class="skolem">is1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span>subtensor <span class="skolem">A</span> <span class="skolem">i</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="skolem">is1'</span> <span class="main">@</span> <span class="free">is2</span><span class="main">)</span> <span class="main">=</span> lookup <span class="main">(</span>subtensor <span class="skolem">A</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">is1'</span> <span class="main">*</span> lookup <span class="free">B</span> <span class="free">is2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> order_step
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">#</span> <span class="skolem">is1'</span> <span class="main">=</span> <span class="skolem">is1</span>›</span></span> dims_subtensor list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> valid_index_dimsE<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="skolem">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="skolem">is1</span> <span class="main">@</span> <span class="free">is2</span><span class="main">)</span> <span class="main">=</span> lookup <span class="skolem">A</span> <span class="skolem">is1</span> <span class="main">*</span> lookup <span class="free">B</span> <span class="free">is2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lookup_subtensor1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">is1'</span></span> <span class="quoted"><span class="skolem">A</span></span><span class="main">]</span> lookup_subtensor1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is1'</span> <span class="main">@</span> <span class="free">is2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span><span class="main">⊗</span><span class="free">B</span>"</span></span><span class="main">]</span> subtensor_tensor_prod<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">A</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span>
      Cons_eq_appendI <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">#</span> <span class="skolem">is1'</span> <span class="main">=</span> <span class="skolem">is1</span>›</span></span> dims_tensor_prod is2_valid list.sel<span class="main">(</span>1<span class="main">)</span> order_step.hyps order_step.prems<span class="main">(</span>1<span class="main">)</span> valid_index_append valid_index_dimsE
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Tensor_Product-valid_index_split"><span class="command">lemma</span></span> valid_index_split<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">⊲</span> <span class="free">ds1</span> <span class="main">@</span> <span class="free">ds2</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">is1</span> <span class="free">is2</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">is1</span> <span class="main">@</span> <span class="free">is2</span> <span class="main">=</span> <span class="free">is</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">is1</span> <span class="main">⊲</span> <span class="free">ds1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">is2</span> <span class="main">⊲</span> <span class="free">ds2</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">is1</span> <span class="bound">is2</span><span class="main">.</span> <span class="bound">is1</span> <span class="main">@</span> <span class="bound">is2</span> <span class="main">=</span> <span class="free">is</span> <span class="main">⟹</span> <span class="bound">is1</span> <span class="main">⊲</span> <span class="free">ds1</span> <span class="main">⟹</span> <span class="bound">is2</span> <span class="main">⊲</span> <span class="free">ds2</span> <span class="main">⟹</span> <span class="free">thesis</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> length_is<span class="main">:</span><span class="quoted"><span class="quoted">"length <span class="free">is</span> <span class="main">=</span> length <span class="free">ds1</span> <span class="main">+</span> length <span class="free">ds2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> valid_index_length <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="free">ds1</span><span class="main">)</span> <span class="free">is</span> <span class="main">⊲</span> <span class="free">ds1</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> valid_indexI<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> valid_index_length <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_leD1 assms length_append not_less nth_append nth_take valid_index_lt<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span>length <span class="free">ds1</span><span class="main">)</span> <span class="free">is</span> <span class="main">⊲</span> <span class="free">ds2</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> valid_indexI<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> valid_index_length <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command">using</span></span> nth_drop<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"length <span class="free">ds1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span>"</span></span><span class="main">]</span> valid_index_lt<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> nth_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ds1</span></span> <span class="quoted"><span class="free">ds2</span></span><span class="main">]</span> length_is
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_append nat_add_left_cancel_less nat_le_iff_add nth_append_length_plus<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="free">ds1</span><span class="main">)</span> <span class="free">is</span> <span class="main">@</span> drop <span class="main">(</span>length <span class="free">ds1</span><span class="main">)</span> <span class="free">is</span> <span class="main">=</span> <span class="free">is</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> length_is <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">C</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>ring tensor"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span> <span class="main">⊗</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">⊗</span> <span class="skolem">C</span> <span class="main">=</span> <span class="skolem">A</span> <span class="main">⊗</span> <span class="main">(</span><span class="skolem">B</span> <span class="main">⊗</span> <span class="skolem">C</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> tensor_lookup_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="quoted">"<span class="skolem">is</span>"</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> dims <span class="main">(</span><span class="main">(</span><span class="skolem">A</span> <span class="main">⊗</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">⊗</span> <span class="skolem">C</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">is1</span></span> <span class="skolem"><span class="skolem">is23</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is1</span> <span class="main">⊲</span> dims <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is23</span> <span class="main">⊲</span> dims <span class="main">(</span><span class="skolem">B</span> <span class="main">⊗</span> <span class="skolem">C</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is1</span> <span class="main">@</span> <span class="skolem">is23</span> <span class="main">=</span> <span class="skolem">is</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">⊲</span> dims <span class="main">(</span><span class="main">(</span><span class="skolem">A</span> <span class="main">⊗</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">⊗</span> <span class="skolem">C</span><span class="main">)</span>›</span></span> Tensor_Product.dims_tensor_prod append_assoc valid_index_split<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">is2</span></span> <span class="skolem"><span class="skolem">is3</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is2</span> <span class="main">⊲</span> dims <span class="skolem">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is3</span> <span class="main">⊲</span> dims <span class="skolem">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is2</span> <span class="main">@</span> <span class="skolem">is3</span> <span class="main">=</span> <span class="skolem">is23</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">is23</span> <span class="main">⊲</span> dims <span class="main">(</span>local.tensor_prod_otimes <span class="skolem">B</span> <span class="skolem">C</span><span class="main">)</span>›</span></span> dims_tensor_prod valid_index_split<span class="main">)</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">is12</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is12</span> <span class="main">=</span> <span class="skolem">is1</span> <span class="main">@</span> <span class="skolem">is2</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is12</span> <span class="main">⊲</span> dims <span class="main">(</span><span class="skolem">A</span> <span class="main">⊗</span> <span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is1</span> <span class="main">⊲</span> dims <span class="skolem">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is2</span> <span class="main">⊲</span> dims <span class="skolem">B</span>›</span></span> is12_def valid_index_append<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is12</span> <span class="main">@</span> <span class="skolem">is3</span> <span class="main">=</span> <span class="skolem">is</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is1</span> <span class="main">@</span> <span class="skolem">is23</span> <span class="main">=</span> <span class="skolem">is</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is2</span> <span class="main">@</span> <span class="skolem">is3</span> <span class="main">=</span> <span class="skolem">is23</span>›</span></span> is12_def<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="main">(</span><span class="skolem">A</span> <span class="main">⊗</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">⊗</span> <span class="skolem">C</span><span class="main">)</span> <span class="skolem">is</span> <span class="main">=</span> lookup <span class="main">(</span><span class="skolem">A</span> <span class="main">⊗</span> <span class="main">(</span><span class="skolem">B</span> <span class="main">⊗</span> <span class="skolem">C</span><span class="main">)</span><span class="main">)</span> <span class="skolem">is</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> lookup_tensor_prod<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">is1</span> <span class="main">⊲</span> dims <span class="skolem">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is23</span> <span class="main">⊲</span> dims <span class="main">(</span><span class="skolem">B</span> <span class="main">⊗</span> <span class="skolem">C</span><span class="main">)</span>›</span></span><span class="main">,</span> <span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="skolem">is1</span> <span class="main">@</span> <span class="skolem">is23</span> <span class="main">=</span> <span class="skolem">is</span>›</span></span><span class="main">]</span>
        lookup_tensor_prod<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">is12</span> <span class="main">⊲</span> dims <span class="main">(</span><span class="skolem">A</span> <span class="main">⊗</span> <span class="skolem">B</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is3</span> <span class="main">⊲</span> dims <span class="skolem">C</span>›</span></span><span class="main">,</span> <span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="skolem">is12</span> <span class="main">@</span> <span class="skolem">is3</span> <span class="main">=</span> <span class="skolem">is</span>›</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is1</span> <span class="main">⊲</span> dims <span class="skolem">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is2</span> <span class="main">@</span> <span class="skolem">is3</span> <span class="main">=</span> <span class="skolem">is23</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is2</span> <span class="main">⊲</span> dims <span class="skolem">B</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is3</span> <span class="main">⊲</span> dims <span class="skolem">C</span>›</span></span> is12_def mult.assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Tensor_Product-tensor_prod_distr_left"><span class="command">lemma</span></span> tensor_prod_distr_left<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dims <span class="free">A</span> <span class="main">=</span> dims <span class="free">B</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">⊗</span> <span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">C</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">B</span> <span class="main">⊗</span> <span class="free">C</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">is</span><span class="main">.</span> <span class="bound">is</span> <span class="main">⊲</span> dims <span class="free">A</span> <span class="main">@</span> dims <span class="free">C</span> <span class="main">⟹</span> lookup <span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">⊗</span> <span class="free">C</span><span class="main">)</span> <span class="bound">is</span> <span class="main">=</span> lookup <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">C</span> <span class="main">+</span> <span class="free">B</span> <span class="main">⊗</span> <span class="free">C</span><span class="main">)</span> <span class="bound">is</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="quoted">"<span class="skolem">is</span>"</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> dims <span class="free">A</span> <span class="main">@</span> dims <span class="free">C</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">is1</span></span> <span class="skolem"><span class="skolem">is2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">=</span> <span class="skolem">is1</span> <span class="main">@</span> <span class="skolem">is2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is1</span> <span class="main">⊲</span> dims <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is2</span> <span class="main">⊲</span> dims <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> valid_index_split <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">⊲</span> dims <span class="free">A</span> <span class="main">@</span> dims <span class="free">C</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">⊗</span> <span class="free">C</span><span class="main">)</span> <span class="skolem">is</span> <span class="main">=</span> lookup <span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">C</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">B</span> <span class="main">⊗</span> <span class="free">C</span><span class="main">)</span><span class="main">)</span> <span class="skolem">is</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> lookup_plus
     <span class="quoted"><span class="quoted">‹<span class="skolem">is1</span> <span class="main">⊲</span> dims <span class="free">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is2</span> <span class="main">⊲</span> dims <span class="free">C</span>›</span></span> assms plus_dim1 dims_tensor_prod lookup_tensor_prod ring_class.ring_distribs<span class="main">(</span>2<span class="main">)</span> valid_index_append
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tensor_from_lookup <span class="main">(</span>dims <span class="free">A</span> <span class="main">@</span> dims <span class="free">C</span><span class="main">)</span> <span class="main">(</span>lookup <span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">⊗</span> <span class="free">C</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">⊗</span> <span class="free">C</span>"</span></span>
       <span class="quoted"><span class="quoted">"tensor_from_lookup <span class="main">(</span>dims <span class="free">A</span> <span class="main">@</span> dims <span class="free">C</span><span class="main">)</span> <span class="main">(</span>lookup <span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">C</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">B</span> <span class="main">⊗</span> <span class="free">C</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">C</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">B</span> <span class="main">⊗</span> <span class="free">C</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms plus_dim1 dims_tensor_prod tensor_lookup<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> tensor_from_lookup_eqI
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">is</span><span class="main">.</span> <span class="bound">is</span> <span class="main">⊲</span> dims <span class="free">A</span> <span class="main">@</span> dims <span class="free">C</span> <span class="main">⟹</span> lookup <span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">⊗</span> <span class="free">C</span><span class="main">)</span> <span class="bound">is</span> <span class="main">=</span> lookup <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">C</span> <span class="main">+</span> <span class="free">B</span> <span class="main">⊗</span> <span class="free">C</span><span class="main">)</span> <span class="bound">is</span>›</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor_Product-tensor_prod_distr_right"><span class="command">lemma</span></span> tensor_prod_distr_right<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dims <span class="free">A</span> <span class="main">=</span> dims <span class="free">B</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">⊗</span> <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">C</span> <span class="main">⊗</span> <span class="free">A</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">C</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">is</span><span class="main">.</span> <span class="bound">is</span> <span class="main">⊲</span> dims <span class="free">C</span> <span class="main">@</span> dims <span class="free">A</span> <span class="main">⟹</span> lookup <span class="main">(</span><span class="free">C</span> <span class="main">⊗</span> <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="bound">is</span> <span class="main">=</span> lookup <span class="main">(</span><span class="free">C</span> <span class="main">⊗</span> <span class="free">A</span> <span class="main">+</span> <span class="free">C</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span> <span class="bound">is</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="quoted">"<span class="skolem">is</span>"</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> dims <span class="free">C</span> <span class="main">@</span> dims <span class="free">A</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">is1</span></span> <span class="skolem"><span class="skolem">is2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">=</span> <span class="skolem">is1</span> <span class="main">@</span> <span class="skolem">is2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is1</span> <span class="main">⊲</span> dims <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is2</span> <span class="main">⊲</span> dims <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> valid_index_split <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">⊲</span> dims <span class="free">C</span> <span class="main">@</span> dims <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="free">C</span> <span class="main">⊗</span> <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="skolem">is</span> <span class="main">=</span> lookup <span class="main">(</span><span class="main">(</span><span class="free">C</span> <span class="main">⊗</span> <span class="free">A</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">C</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="skolem">is</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> lookup_plus
     <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is2</span> <span class="main">⊲</span> dims <span class="free">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is1</span> <span class="main">⊲</span> dims <span class="free">C</span>›</span></span> assms plus_dim1 dims_tensor_prod lookup_tensor_prod ring_class.ring_distribs<span class="main">(</span>1<span class="main">)</span> valid_index_append
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tensor_from_lookup <span class="main">(</span>dims <span class="free">C</span> <span class="main">@</span> dims <span class="free">A</span><span class="main">)</span> <span class="main">(</span>lookup <span class="main">(</span><span class="free">C</span> <span class="main">⊗</span> <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">C</span> <span class="main">⊗</span> <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span>"</span></span>
       <span class="quoted"><span class="quoted">"tensor_from_lookup <span class="main">(</span>dims <span class="free">C</span> <span class="main">@</span> dims <span class="free">A</span><span class="main">)</span> <span class="main">(</span>lookup <span class="main">(</span><span class="main">(</span><span class="free">C</span> <span class="main">⊗</span> <span class="free">A</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">C</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">C</span> <span class="main">⊗</span> <span class="free">A</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">C</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms plus_dim1 dims_tensor_prod tensor_lookup<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> tensor_from_lookup_eqI
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">is</span><span class="main">.</span> <span class="bound">is</span> <span class="main">⊲</span> dims <span class="free">C</span> <span class="main">@</span> dims <span class="free">A</span> <span class="main">⟹</span> lookup <span class="main">(</span><span class="free">C</span> <span class="main">⊗</span> <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="bound">is</span> <span class="main">=</span> lookup <span class="main">(</span><span class="free">C</span> <span class="main">⊗</span> <span class="free">A</span> <span class="main">+</span> <span class="free">C</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span> <span class="bound">is</span>›</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> tensor <span class="main">::</span> <span class="main">(</span><span class="quoted">ring_1</span><span class="main">)</span> <span class="quoted">monoid_mult</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> tensor_one_def<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> tensor_from_vec <span class="main">[]</span> <span class="main">[</span><span class="main">1</span><span class="main">]</span>"</span></span>

  <span class="keyword1" id="Tensor_Product-tensor_one_from_lookup"><span class="command">lemma</span></span> tensor_one_from_lookup<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> tensor_from_lookup <span class="main">[]</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> tensor_one_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tensor_eqI<span class="main"><span class="keyword3">;</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tensor_from_lookup_def <span class="main">)</span>

  <span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>ring_1 tensor"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">*</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> tensor_one_from_lookup
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tensor_lookup_eqI<span class="main"><span class="keyword3">;</span></span><span class="operator">metis</span> lookup_tensor_prod<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">A</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"tensor_from_lookup <span class="main"><span class="main"><span class="main">[]</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">λ</span></span></span><span class="main"><span class="bound"><span class="main"><span class="bound"><span class="main"><span class="bound">_</span></span></span></span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">1</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span>
          lookup_tensor_from_lookup valid_index.Nil append_Nil2 dims_tensor dims_tensor_prod
          length_tensor_vec_from_lookup mult.right_neutral tensor_from_lookup_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>ring_1 tensor"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">*</span> <span class="skolem">A</span> <span class="main">=</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> tensor_one_from_lookup
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> tensor_lookup_eqI<span class="main"><span class="keyword3">;</span></span> <span class="operator">metis</span> lookup_tensor_prod<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[]</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"tensor_from_lookup <span class="main"><span class="main"><span class="main">[]</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">λ</span></span></span><span class="main"><span class="bound"><span class="main"><span class="bound"><span class="main"><span class="bound">_</span></span></span></span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">1</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">A</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span>
          lookup_tensor_from_lookup valid_index.Nil List.append.append_Nil dims_tensor dims_tensor_prod
          length_tensor_vec_from_lookup mult.left_neutral tensor_from_lookup_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Tensor_Product-order_tensor_one"><span class="command">lemma</span></span> order_tensor_one<span class="main">:</span> <span class="quoted"><span class="quoted">"order <span class="main">1</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> tensor_one_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Tensor_Product-smult_prod_extract1"><span class="command">lemma</span></span> smult_prod_extract1<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>comm_ring_1"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">⋅</span> <span class="free">A</span><span class="main">)</span> <span class="main">⊗</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> tensor_lookup_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dims <span class="main">(</span><span class="free">a</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dims <span class="main">(</span><span class="main">(</span><span class="free">a</span> <span class="main">⋅</span> <span class="free">A</span><span class="main">)</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="quoted">"<span class="skolem">is</span>"</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> dims <span class="main">(</span><span class="free">a</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> dims <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">is1</span></span> <span class="skolem"><span class="skolem">is2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is1</span> <span class="main">⊲</span> dims <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is2</span> <span class="main">⊲</span> dims <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">=</span> <span class="skolem">is1</span> <span class="main">@</span> <span class="skolem">is2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dims_tensor_prod valid_index_split<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is1</span> <span class="main">⊲</span> dims <span class="main">(</span><span class="free">a</span> <span class="main">⋅</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="free">a</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="skolem">is</span> <span class="main">=</span> lookup <span class="main">(</span><span class="free">a</span> <span class="main">⋅</span> <span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span> <span class="skolem">is</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lookup_tensor_prod<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">is1</span> <span class="main">⊲</span> dims <span class="free">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is2</span> <span class="main">⊲</span> dims <span class="free">B</span>›</span></span><span class="main">]</span> lookup_tensor_prod<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">is1</span> <span class="main">⊲</span> dims <span class="main">(</span><span class="free">a</span> <span class="main">⋅</span> <span class="free">A</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is2</span> <span class="main">⊲</span> dims <span class="free">B</span>›</span></span><span class="main">]</span>
        lookup_smult<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">⊲</span> dims <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span>›</span></span><span class="main">]</span> lookup_smult<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">is1</span> <span class="main">⊲</span> dims <span class="free">A</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">=</span> <span class="skolem">is1</span> <span class="main">@</span> <span class="skolem">is2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor_Product-smult_prod_extract2"><span class="command">lemma</span></span> smult_prod_extract2<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>comm_ring_1"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="main">⊗</span> <span class="main">(</span><span class="free">a</span> <span class="main">⋅</span> <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> tensor_lookup_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dims <span class="main">(</span><span class="free">a</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dims <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="main">(</span><span class="free">a</span> <span class="main">⋅</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="quoted">"<span class="skolem">is</span>"</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> dims <span class="main">(</span><span class="free">a</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> dims <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">is1</span></span> <span class="skolem"><span class="skolem">is2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is1</span> <span class="main">⊲</span> dims <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is2</span> <span class="main">⊲</span> dims <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">=</span> <span class="skolem">is1</span> <span class="main">@</span> <span class="skolem">is2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dims_tensor_prod valid_index_split<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is2</span> <span class="main">⊲</span> dims <span class="main">(</span><span class="free">a</span> <span class="main">⋅</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="free">a</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="skolem">is</span> <span class="main">=</span> lookup <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="main">(</span><span class="free">a</span> <span class="main">⋅</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="skolem">is</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lookup_tensor_prod<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">is1</span> <span class="main">⊲</span> dims <span class="free">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is2</span> <span class="main">⊲</span> dims <span class="free">B</span>›</span></span><span class="main">]</span> lookup_tensor_prod<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">is1</span> <span class="main">⊲</span> dims <span class="free">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is2</span> <span class="main">⊲</span> dims <span class="main">(</span><span class="free">a</span> <span class="main">⋅</span> <span class="free">B</span><span class="main">)</span>›</span></span><span class="main">]</span>
        lookup_smult<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">⊲</span> dims <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span>›</span></span><span class="main">]</span> lookup_smult<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">is2</span> <span class="main">⊲</span> dims <span class="free">B</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">=</span> <span class="skolem">is1</span> <span class="main">@</span> <span class="skolem">is2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Tensor_Product-order_0_multiple_of_one"><span class="command">lemma</span></span> order_0_multiple_of_one<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"order <span class="free">A</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">a</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="free">a</span> <span class="main">⋅</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="free">A</span> <span class="main">=</span> <span class="bound">a</span> <span class="main">⋅</span> <span class="main">1</span> <span class="main">⟹</span> <span class="free">thesis</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>vec <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>length_vec<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"vec <span class="free">A</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_length_conv length_0_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vec <span class="main">(</span><span class="skolem">a</span> <span class="main">⋅</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> smult_def tensor_one_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vec_smult_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">⋅</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tensor_eqI <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms dims_smult length_0_conv order_tensor_one<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> hd <span class="main">(</span>vec <span class="free">A</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vec <span class="free">A</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor_Product-smult_1"><span class="command">lemma</span></span> smult_1<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>ring_1 tensor"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⋅</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> smult_def tensor_one_def
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> tensor_eqI<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_vec length_vec_smult<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dims_tensor length_vec length_vec_smult lookup_smult mult.left_neutral smult_def tensor_lookup_eqI<span class="main">)</span>


<span class="keyword1" id="Tensor_Product-tensor0_prod_right"><span class="command">lemma</span></span> tensor0_prod_right<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊗</span> tensor0 <span class="free">ds</span> <span class="main">=</span> tensor0 <span class="main">(</span>dims <span class="free">A</span> <span class="main">@</span> <span class="free">ds</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> tensor_lookup_eqI<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="quoted">"<span class="skolem">is</span>"</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> dims <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> tensor0 <span class="free">ds</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">is1</span></span> <span class="skolem"><span class="skolem">is2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is1</span> <span class="main">⊲</span> dims <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is2</span> <span class="main">⊲</span> dims <span class="main">(</span>tensor0 <span class="free">ds</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">=</span> <span class="skolem">is1</span> <span class="main">@</span> <span class="skolem">is2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dims_tensor0 dims_tensor_prod valid_index_split<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> tensor0 <span class="free">ds</span><span class="main">)</span> <span class="skolem">is</span> <span class="main">=</span> lookup <span class="main">(</span>tensor0 <span class="main">(</span>dims <span class="free">A</span> <span class="main">@</span> <span class="free">ds</span><span class="main">)</span><span class="main">)</span> <span class="skolem">is</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">⊲</span> dims <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> tensor0 <span class="free">ds</span><span class="main">)</span>›</span></span> dims_tensor0 dims_tensor_prod lookup_tensor0 lookup_tensor_prod mult_zero_right<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor_Product-tensor0_prod_left"><span class="command">lemma</span></span> tensor0_prod_left<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"tensor0 <span class="free">ds</span> <span class="main">⊗</span> <span class="free">A</span> <span class="main">=</span> tensor0 <span class="main">(</span><span class="free">ds</span> <span class="main">@</span> dims <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> tensor_lookup_eqI<span class="main"><span class="keyword3">,</span></span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="quoted">"<span class="skolem">is</span>"</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> dims <span class="main">(</span>tensor0 <span class="free">ds</span> <span class="main">⊗</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">is1</span></span> <span class="skolem"><span class="skolem">is2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is1</span> <span class="main">⊲</span> dims <span class="main">(</span>tensor0 <span class="free">ds</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is2</span> <span class="main">⊲</span> dims <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">=</span> <span class="skolem">is1</span> <span class="main">@</span> <span class="skolem">is2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dims_tensor0 dims_tensor_prod valid_index_split<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span>tensor0 <span class="free">ds</span> <span class="main">⊗</span> <span class="free">A</span><span class="main">)</span> <span class="skolem">is</span> <span class="main">=</span> lookup <span class="main">(</span>tensor0 <span class="main">(</span><span class="free">ds</span> <span class="main">@</span> dims <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="skolem">is</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">⊲</span> dims <span class="main">(</span>tensor0 <span class="free">ds</span> <span class="main">⊗</span> <span class="free">A</span><span class="main">)</span>›</span></span> dims_tensor0 dims_tensor_prod lookup_tensor0 lookup_tensor_prod mult_zero_left<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor_Product-subtensor_prod_with_vec"><span class="command">lemma</span></span> subtensor_prod_with_vec<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"order <span class="free">A</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subtensor <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> lookup <span class="free">A</span> <span class="main">[</span><span class="free">i</span><span class="main">]</span> <span class="main">⋅</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> tensor_lookup_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dims <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span> <span class="main">=</span>  hd <span class="main">(</span>dims <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_length_conv append_Cons assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> dims_tensor_prod list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dims <span class="main">(</span>subtensor <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> dims <span class="main">(</span>lookup <span class="free">A</span> <span class="main">[</span><span class="free">i</span><span class="main">]</span> <span class="main">⋅</span> <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> dims_smult dims_subtensor<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹dims <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span> <span class="main">=</span>  hd <span class="main">(</span>dims <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>›</span></span><span class="main"><span class="main">]</span></span> <span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_length_conv append.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> append_self_conv2 assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> dims_tensor_prod length_0_conv list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="quoted">"<span class="skolem">is</span>"</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> dims <span class="main">(</span>subtensor <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dims <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span> <span class="main">=</span>  hd <span class="main">(</span>dims <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_length_conv append_Cons assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> dims_tensor_prod list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> dims <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">⊲</span> dims <span class="main">(</span>subtensor <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> dims_subtensor<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹dims <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span> <span class="main">=</span>  hd <span class="main">(</span>dims <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>›</span></span><span class="main"><span class="main">]</span></span> <span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_length_conv append_self_conv2 assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> dims_tensor_prod length_0_conv list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> tl_append2<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">i</span><span class="main">]</span> <span class="main">⊲</span> dims <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_length_conv length_0_conv list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> valid_index.Nil valid_index.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">#</span> <span class="skolem">is</span> <span class="main">⊲</span> dims <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">⊲</span> dims <span class="main">(</span>subtensor <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span>›</span></span> dims_subtensor valid_index.Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span>subtensor <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">is</span> <span class="main">=</span> lookup <span class="main">(</span>lookup <span class="free">A</span> <span class="main">[</span><span class="free">i</span><span class="main">]</span> <span class="main">⋅</span> <span class="free">B</span><span class="main">)</span> <span class="skolem">is</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lookup_subtensor1<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">#</span> <span class="skolem">is</span> <span class="main">⊲</span> dims <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> lookup_tensor_prod<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="free">i</span><span class="main">]</span> <span class="main">⊲</span> dims <span class="free">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">⊲</span> dims <span class="free">B</span>›</span></span><span class="main">]</span> lookup_smult
    <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">⊲</span> dims <span class="free">B</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> append_Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Tensor_Unit_Vec">
<div class="head">
<h1>Theory Tensor_Unit_Vec</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Alexander Bentkamp, Universität des Saarlandes
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Unit Vectors as Tensors›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Tensor_Unit_Vec
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Tensor_Product.html">Tensor_Product</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">unit_vec</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>ring_1 tensor"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">unit_vec</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> tensor_from_lookup <span class="main">[</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span><span class="main">=</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">]</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Tensor_Unit_Vec-dims_unit_vec"><span class="command">lemma</span></span> dims_unit_vec<span class="main">:</span> <span class="quoted"><span class="quoted">"dims <span class="main">(</span>unit_vec <span class="free">n</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free">n</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> unit_vec_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tensor_from_lookup_def<span class="main">)</span>

<span class="keyword1" id="Tensor_Unit_Vec-lookup_unit_vec"><span class="command">lemma</span></span> lookup_unit_vec<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">&lt;</span><span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span>unit_vec <span class="free">n</span> <span class="free">i</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span><span class="main">=</span><span class="free">j</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">j</span><span class="main">]</span> <span class="main">⊲</span> <span class="main">[</span><span class="free">n</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms valid_index.Cons valid_index.Nil<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span>unit_vec <span class="free">n</span> <span class="free">i</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span><span class="main">=</span><span class="main">[</span><span class="free">i</span><span class="main">]</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_tensor_from_lookup unit_vec_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor_Unit_Vec-subtensor_prod_with_unit_vec"><span class="command">lemma</span></span> subtensor_prod_with_unit_vec<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>ring_1 tensor"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">&lt;</span><span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"subtensor <span class="main">(</span>unit_vec <span class="free">n</span> <span class="free">i</span> <span class="main">⊗</span> <span class="free">A</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span><span class="main">=</span><span class="free">j</span> <span class="keyword1">then</span> <span class="free">A</span> <span class="keyword1">else</span> <span class="main">(</span>tensor0 <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span><span class="quoted"><span class="quoted">"lookup <span class="main">(</span>unit_vec <span class="free">n</span> <span class="free">i</span><span class="main">)</span> <span class="main">[</span><span class="free">j</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span><span class="main">=</span><span class="free">j</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> unit_vec_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms lookup_tensor_from_lookup valid_index.Cons valid_index.Nil<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"order <span class="main">(</span>unit_vec <span class="free">n</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> unit_vec_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tensor_from_lookup_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> hd <span class="main">(</span>dims <span class="main">(</span>tensor_from_lookup <span class="main">[</span><span class="free">n</span><span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">[</span><span class="free">i</span><span class="main">]</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dims_tensor_from_lookup<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> unit_vec_def subtensor_prod_with_vec 1 2 0 smult_1 tensor_smult0
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> tensor_from_lookup_eqI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor_Unit_Vec-subtensor_decomposition"><span class="command">lemma</span></span> subtensor_decomposition<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dims <span class="free">A</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"listsum <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> unit_vec <span class="main">(</span>hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="bound">i</span> <span class="main">⊗</span> subtensor <span class="free">A</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?LS</span> <span class="main">=</span> <span class="free">A</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> unit_vec <span class="main">(</span>hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="bound">i</span> <span class="main">⊗</span> subtensor <span class="free">A</span> <span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> correct_dims<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">B</span><span class="main">.</span> <span class="bound">B</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="var">?f</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> dims <span class="bound">B</span> <span class="main">=</span> dims <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">B</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈</span> set <span class="main">(</span>map <span class="var">?f</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> B<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="var">?f</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span>hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dims <span class="main">(</span>subtensor <span class="free">A</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> tl <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dims_subtensor <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dims <span class="skolem">B</span> <span class="main">=</span> dims <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> B
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons assms dims_tensor_prod dims_unit_vec list.exhaust_sel self_append_conv2<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span> <span class="main">⟹</span> subtensor <span class="var">?LS</span> <span class="bound">j</span> <span class="main">=</span> subtensor <span class="free">A</span> <span class="bound">j</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"subtensor <span class="var">?LS</span> <span class="skolem">j</span> <span class="main">=</span> listsum <span class="main">(</span>tl <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> subtensor <span class="bound">A</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>map <span class="var">?f</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> subtensor_listsum<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"dims <span class="free">A</span>"</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main">,</span> <span class="operator">OF</span> correct_dims assms <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> listsum <span class="main">(</span>tl <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> subtensor <span class="main">(</span><span class="var">?f</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> subtensor <span class="bound">A</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>map <span class="var">?f</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> subtensor <span class="main">(</span><span class="var">?f</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> map_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> subtensor <span class="bound">A</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">j</span> <span class="keyword1">then</span> subtensor <span class="free">A</span> <span class="bound">i</span> <span class="keyword1">else</span> tensor0 <span class="main">(</span>dims <span class="main">(</span>subtensor <span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span><span class="main">]</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> subtensor_prod_with_unit_vec<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> listsum_all_0_but_one<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">j</span> <span class="keyword1">then</span> subtensor <span class="free">A</span> <span class="bound">i</span> <span class="keyword1">else</span> tensor0 <span class="main">(</span>dims <span class="main">(</span>subtensor <span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"tl <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span>›</span></span> assms<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> subtensor <span class="free">A</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> hd <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"subtensor <span class="var">?LS</span> <span class="skolem">j</span> <span class="main">=</span> subtensor <span class="free">A</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dims <span class="var">?LS</span> <span class="main">=</span> dims <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> correct_dims listsum_dims <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> subtensor_eqI <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Tensor_Rank">
<div class="head">
<h1>Theory Tensor_Rank</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Alexander Bentkamp, Universität des Saarlandes
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Tensor CP-Rank›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Tensor_Rank
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Tensor_Unit_Vec.html">Tensor_Unit_Vec</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">cprank_max1</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>ring_1 tensor <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
order1<span class="main">:</span> <span class="quoted"><span class="quoted">"order <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≤</span> <span class="main">1</span> <span class="main">⟹</span> <span class="free">cprank_max1</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span> <span class="main">|</span>
higher_order<span class="main">:</span> <span class="quoted"><span class="quoted">"order <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span> <span class="free">cprank_max1</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟹</span> <span class="free">cprank_max1</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⊗</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Tensor_Rank-cprank_max1_order0"><span class="command">lemma</span></span> cprank_max1_order0<span class="main">:</span> <span class="quoted"><span class="quoted">"cprank_max1 <span class="free">B</span> <span class="main">⟹</span> order <span class="free">A</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> cprank_max1 <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">B</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>cprank_max1.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> order1
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cprank_max1.order1<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>higher_order <span class="skolem">A'</span> <span class="skolem">B</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="skolem">A'</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> higher_order cprank_max1.higher_order <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult.assoc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor_Rank-cprank_max1_order_le1"><span class="command">lemma</span></span> cprank_max1_order_le1<span class="main">:</span> <span class="quoted"><span class="quoted">"order <span class="free">A</span> <span class="main">≤</span> <span class="main">0</span> <span class="main">⟹</span> cprank_max1 <span class="free">B</span> <span class="main">⟹</span> cprank_max1 <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cprank_max1_order0<span class="main">)</span>

<span class="keyword1" id="Tensor_Rank-cprank_max1_prod"><span class="command">lemma</span></span> cprank_max1_prod<span class="main">:</span> <span class="quoted"><span class="quoted">"cprank_max1 <span class="free">A</span> <span class="main">⟹</span> cprank_max1 <span class="free">B</span> <span class="main">⟹</span> cprank_max1 <span class="main">(</span><span class="free">A</span> <span class="main">⊗</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> cprank_max1.induct<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> higher_order le_neq_trans less_one cprank_max1_order0<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> higher_order mult.assoc<span class="main">)</span>

<span class="keyword1" id="Tensor_Rank-cprank_max1_prod_list"><span class="command">lemma</span></span> cprank_max1_prod_list<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">B</span><span class="main">.</span> <span class="bound">B</span><span class="main">∈</span>set <span class="free">Bs</span> <span class="main">⟹</span> cprank_max1 <span class="bound">B</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cprank_max1 <span class="main">(</span>prod_list <span class="free">Bs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Bs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> dims_smult dims_tensor0 list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> prod_list.Nil order1 order_0_multiple_of_one zero_le_one<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cprank_max1_prod<span class="main">)</span>

<span class="keyword1" id="Tensor_Rank-cprank_max1_prod_listE"><span class="command">lemma</span></span> cprank_max1_prod_listE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>comm_ring_1 tensor"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cprank_max1 <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">Bs</span> <span class="free">a</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">B</span><span class="main">.</span> <span class="bound">B</span><span class="main">∈</span>set <span class="free">Bs</span> <span class="main">⟹</span> order <span class="bound">B</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⋅</span> prod_list <span class="free">Bs</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">thesis</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>cprank_max1.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>order1 <span class="skolem">A</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"order <span class="skolem">A</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">⋅</span> prod_list <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> order_0_multiple_of_one <span class="keyword1"><span class="command">using</span></span> prod_list.Nil <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> length_pos_if_in_set order1.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"order <span class="skolem">A</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> order1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⋅</span> prod_list <span class="main">[</span><span class="skolem">A</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> smult_1<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹order <span class="skolem">A</span> <span class="main">=</span> <span class="main">1</span>›</span></span> length_greater_0_conv length_pos_if_in_set order1.prems set_ConsD<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>higher_order <span class="skolem">A</span> <span class="skolem">B</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Bs</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">B'</span><span class="main">.</span> <span class="bound">B'</span> <span class="main">∈</span> set <span class="skolem">Bs</span> <span class="main">⟹</span> order <span class="bound">B'</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">⋅</span> prod_list <span class="skolem">Bs</span> <span class="main">=</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">B</span><span class="main">.</span> <span class="bound">B</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">A</span> <span class="main">#</span> <span class="skolem">Bs</span><span class="main">)</span> <span class="main">⟹</span> order <span class="bound">B</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> higher_order <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊗</span> <span class="skolem">B</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">⋅</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">⊗</span> prod_list <span class="skolem">Bs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> smult_prod_extract2  <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">⋅</span> prod_list <span class="skolem">Bs</span> <span class="main">=</span> <span class="skolem">B</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">Ba</span><span class="main">.</span> <span class="bound">Ba</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">A</span> <span class="main">#</span> <span class="skolem">Bs</span><span class="main">)</span> <span class="main">⟹</span> order <span class="bound">Ba</span> <span class="main">=</span> <span class="main">1</span>›</span></span> higher_order.prems prod_list.Cons<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">cprank_max</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>ring_1 tensor <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
cprank_max0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">cprank_max</span> <span class="main">0</span> <span class="main">(</span>tensor0 <span class="free"><span class="bound"><span class="entity">ds</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
cprank_max_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"dims <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> dims <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟹</span> cprank_max1 <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⟹</span> <span class="free">cprank_max</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟹</span> <span class="free">cprank_max</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Tensor_Rank-cprank_max1"><span class="command">lemma</span></span> cprank_max1<span class="main">:</span> <span class="quoted"><span class="quoted">"cprank_max1 <span class="free">A</span> <span class="main">⟹</span> cprank_max <span class="main">1</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def dims_tensor0 cprank_max.simps cprank_max0 tensor_add_0_right<span class="main">)</span>

<span class="keyword1" id="Tensor_Rank-cprank_max_plus"><span class="command">lemma</span></span> cprank_max_plus<span class="main">:</span> <span class="quoted"><span class="quoted">"cprank_max <span class="free">i</span> <span class="free">A</span> <span class="main">⟹</span> cprank_max <span class="free">j</span> <span class="free">B</span> <span class="main">⟹</span> dims <span class="free">A</span> <span class="main">=</span> dims <span class="free">B</span> <span class="main">⟹</span> cprank_max <span class="main">(</span><span class="free">i</span><span class="main">+</span><span class="free">j</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span><span class="main">+</span><span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>cprank_max.induct<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_Suc plus_assoc plus_dim1 cprank_max.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Tensor_Rank-cprank_max_listsum"><span class="command">lemma</span></span> cprank_max_listsum<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span><span class="main">∈</span>set <span class="free">As</span> <span class="main">⟹</span> dims <span class="bound">A</span> <span class="main">=</span> <span class="free">ds</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span><span class="main">∈</span>set <span class="free">As</span> <span class="main">⟹</span> cprank_max <span class="free">n</span> <span class="bound">A</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cprank_max <span class="main">(</span><span class="free">n</span><span class="main">*</span>length <span class="free">As</span><span class="main">)</span> <span class="main">(</span>listsum <span class="free">ds</span> <span class="free">As</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">As</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> listsum_Nil cprank_max.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">A</span> <span class="skolem">As</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> cprank_max_plus<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="skolem">A</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">*</span> length <span class="skolem">As</span>"</span></span> <span class="quoted"><span class="quoted">"listsum <span class="free">ds</span> <span class="skolem">As</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_Cons list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> listsum_Cons listsum_dims set_subset_Cons subsetCE<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor_Rank-cprank_maxE"><span class="command">lemma</span></span> cprank_maxE<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cprank_max <span class="free">n</span> <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">BS</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">B</span><span class="main">.</span> <span class="bound">B</span><span class="main">∈</span>set <span class="free">BS</span> <span class="main">⟹</span> cprank_max1 <span class="bound">B</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">B</span><span class="main">.</span> <span class="bound">B</span><span class="main">∈</span>set <span class="free">BS</span> <span class="main">⟹</span> dims <span class="free">A</span> <span class="main">=</span> dims <span class="bound">B</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"listsum <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span> <span class="free">BS</span> <span class="main">=</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">BS</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">thesis</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>cprank_max.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cprank_max0 <span class="skolem">ds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Tensor_Plus.listsum <span class="main">(</span>dims <span class="main">(</span>tensor0 <span class="skolem">ds</span><span class="main">)</span><span class="main">)</span> <span class="main">[]</span> <span class="main">=</span> tensor0 <span class="skolem">ds</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> listsum_Nil<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> cprank_max0.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cprank_max_Suc <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">BS</span></span> <span class="keyword2"><span class="keyword">where</span></span> BS_def<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">B</span><span class="main">.</span> <span class="bound">B</span> <span class="main">∈</span> set <span class="skolem">BS</span> <span class="main">⟹</span> cprank_max1 <span class="bound">B</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">B'</span><span class="main">.</span> <span class="bound">B'</span> <span class="main">∈</span> set <span class="skolem">BS</span> <span class="main">⟹</span> dims <span class="bound">B'</span> <span class="main">=</span> dims <span class="skolem">B</span><span class="main">)</span>"</span></span>
                       <span class="quoted"><span class="quoted">"listsum <span class="main">(</span>dims <span class="skolem">B</span><span class="main">)</span> <span class="skolem">BS</span> <span class="main">=</span> <span class="skolem">B</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">BS</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"listsum <span class="main">(</span>dims <span class="main">(</span><span class="skolem">A</span> <span class="main">+</span> <span class="skolem">B</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">#</span> <span class="skolem">BS</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">A</span> <span class="main">+</span> <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> listsum_Cons cprank_max_Suc.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> BS_def length_Cons cprank_max_Suc.hyps<span class="main">(</span>2<span class="main">)</span> cprank_max_Suc.prems set_ConsD
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> plus_dim1 cprank_max_Suc.hyps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor_Rank-cprank_maxI"><span class="command">lemma</span></span> cprank_maxI<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">B</span><span class="main">.</span> <span class="bound">B</span><span class="main">∈</span>set <span class="free">BS</span> <span class="main">⟹</span> cprank_max1 <span class="bound">B</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">B</span><span class="main">.</span> <span class="bound">B</span><span class="main">∈</span>set <span class="free">BS</span> <span class="main">⟹</span> dims <span class="bound">B</span> <span class="main">=</span> <span class="free">ds</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cprank_max <span class="main">(</span>length <span class="free">BS</span><span class="main">)</span> <span class="main">(</span>listsum <span class="free">ds</span> <span class="free">BS</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">BS</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> listsum_Nil cprank_max0<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">B</span> <span class="skolem">BS</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_Cons list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.set_intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> listsum_Cons listsum_dims cprank_max_Suc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor_Rank-cprank_max_0E"><span class="command">lemma</span></span> cprank_max_0E<span class="main">:</span> <span class="quoted"><span class="quoted">"cprank_max <span class="main">0</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">=</span> tensor0 <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dims_tensor0 length_0_conv cprank_max0 cprank_maxE<span class="main">)</span>

<span class="keyword1" id="Tensor_Rank-listsum_prod_distr_right"><span class="command">lemma</span></span> listsum_prod_distr_right<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">C</span><span class="main">.</span> <span class="bound">C</span><span class="main">∈</span>set <span class="free">CS</span> <span class="main">⟹</span> dims <span class="bound">C</span> <span class="main">=</span> <span class="free">ds</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊗</span> listsum <span class="free">ds</span> <span class="free">CS</span> <span class="main">=</span> listsum <span class="main">(</span>dims <span class="free">A</span> <span class="main">@</span> <span class="free">ds</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">C</span><span class="main">.</span> <span class="free">A</span> <span class="main">⊗</span> <span class="bound">C</span><span class="main">)</span> <span class="free">CS</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">CS</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>listsum_Nil<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">C</span> <span class="skolem">CS</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dims <span class="skolem">C</span> <span class="main">=</span> dims <span class="main">(</span>listsum <span class="free">ds</span> <span class="skolem">CS</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.set_intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> listsum_dims<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> listsum_Cons list.map<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> tensor_prod_distr_right Cons.IH Cons.prems list.set_intros<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor_Rank-cprank_max_prod_order1"><span class="command">lemma</span></span> cprank_max_prod_order1<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"order <span class="free">A</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"cprank_max <span class="free">n</span> <span class="free">B</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cprank_max <span class="free">n</span> <span class="main">(</span><span class="free">A</span><span class="main">⊗</span><span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">CS</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">C</span><span class="main">.</span> <span class="bound">C</span><span class="main">∈</span>set <span class="skolem">CS</span> <span class="main">⟹</span> cprank_max1 <span class="bound">C</span><span class="main">)</span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">C</span><span class="main">.</span> <span class="bound">C</span><span class="main">∈</span>set <span class="skolem">CS</span> <span class="main">⟹</span> dims <span class="bound">C</span> <span class="main">=</span> dims <span class="free">B</span><span class="main">)</span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"listsum <span class="main">(</span>dims <span class="free">B</span><span class="main">)</span> <span class="skolem">CS</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">CS</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> cprank_maxE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">CS'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CS'</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">C</span><span class="main">.</span> <span class="free">A</span><span class="main">⊗</span><span class="bound">C</span><span class="main">)</span> <span class="skolem">CS</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C'</span><span class="main">.</span> <span class="bound">C'</span><span class="main">∈</span>set <span class="skolem">CS'</span> <span class="main">⟹</span> cprank_max1 <span class="bound">C'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> higher_order <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">C</span><span class="main">.</span> <span class="bound">C</span> <span class="main">∈</span> set <span class="skolem">CS</span> <span class="main">⟹</span> cprank_max1 <span class="bound">C</span>›</span></span> imageE set_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"listsum <span class="main">(</span>dims <span class="free">A</span> <span class="main">@</span> dims <span class="free">B</span><span class="main">)</span> <span class="skolem">CS'</span> <span class="main">=</span> <span class="free">A</span><span class="main">⊗</span><span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> CS'_def <span class="quoted"><span class="quoted">‹Tensor_Plus.listsum <span class="main">(</span>dims <span class="free">B</span><span class="main">)</span> <span class="skolem">CS</span> <span class="main">=</span> <span class="free">B</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">Ca</span><span class="main">.</span> <span class="bound">Ca</span> <span class="main">∈</span> set <span class="skolem">CS</span> <span class="main">⟹</span> dims <span class="bound">Ca</span> <span class="main">=</span> dims <span class="free">B</span>›</span></span> listsum_prod_distr_right <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> CS'_def <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">C'</span><span class="main">.</span> <span class="bound">C'</span> <span class="main">∈</span> set <span class="skolem">CS'</span> <span class="main">⟹</span> cprank_max1 <span class="bound">C'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">Ca</span><span class="main">.</span> <span class="bound">Ca</span> <span class="main">∈</span> set <span class="skolem">CS</span> <span class="main">⟹</span> dims <span class="bound">Ca</span> <span class="main">=</span> dims <span class="free">B</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">CS</span> <span class="main">=</span> <span class="free">n</span>›</span></span> dims_tensor_prod imageE length_map cprank_maxI set_map<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor_Rank-cprank_max_upper_bound"><span class="command">lemma</span></span> cprank_max_upper_bound<span class="main">:</span> <span class="comment1">(* Stronger bound is possible, one of the factors in prod_list can be dropped. *)</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cprank_max <span class="main">(</span>prod_list <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>subtensor_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>order_0 <span class="skolem">A</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cprank_max <span class="main">1</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> order1 cprank_max1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> order_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>order_step <span class="skolem">A</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Bs</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> unit_vec <span class="main">(</span>hd <span class="main">(</span>dims <span class="skolem">A</span><span class="main">)</span><span class="main">)</span> <span class="bound">i</span> <span class="main">⊗</span> subtensor <span class="skolem">A</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>hd <span class="main">(</span>dims <span class="skolem">A</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">B</span><span class="main">.</span> <span class="bound">B</span> <span class="main">∈</span> set <span class="skolem">Bs</span> <span class="main">⟹</span> dims <span class="skolem">A</span> <span class="main">=</span> dims <span class="bound">B</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">B</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈</span> set <span class="skolem">Bs</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span>hd <span class="main">(</span>dims <span class="skolem">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Bs</span><span class="main">!</span><span class="skolem">i</span><span class="main">=</span><span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Bs_def <span class="quoted"><span class="quoted">‹<span class="skolem">B</span> <span class="main">∈</span> set <span class="skolem">Bs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dims <span class="main">(</span>unit_vec <span class="main">(</span>hd <span class="main">(</span>dims <span class="skolem">A</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">⊗</span> subtensor <span class="skolem">A</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> dims <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> dims_unit_vec order_step.hyps
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons dims_subtensor dims_tensor_prod list.exhaust_sel self_append_conv2<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dims <span class="skolem">A</span> <span class="main">=</span> dims <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Bs_def <span class="quoted"><span class="quoted">‹<span class="skolem">Bs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">B</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> hd <span class="main">(</span>dims <span class="skolem">A</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">B</span><span class="main">.</span> <span class="bound">B</span> <span class="main">∈</span> set <span class="skolem">Bs</span> <span class="main">⟹</span> cprank_max <span class="main">(</span>prod_list <span class="main">(</span>tl <span class="main">(</span>dims <span class="skolem">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">B</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">B</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈</span> set <span class="skolem">Bs</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span>hd <span class="main">(</span>dims <span class="skolem">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Bs</span><span class="main">!</span><span class="skolem">i</span><span class="main">=</span><span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Bs_def <span class="quoted"><span class="quoted">‹<span class="skolem">B</span> <span class="main">∈</span> set <span class="skolem">Bs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cprank_max <span class="main">(</span>prod_list <span class="main">(</span>tl <span class="main">(</span>dims <span class="skolem">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>unit_vec <span class="main">(</span>hd <span class="main">(</span>dims <span class="skolem">A</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">⊗</span> subtensor <span class="skolem">A</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def dims_subtensor dims_unit_vec length_Cons list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> order_step.IH order_step.hyps cprank_max_prod_order1<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cprank_max <span class="main">(</span>prod_list <span class="main">(</span>tl <span class="main">(</span>dims <span class="skolem">A</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Bs_def <span class="quoted"><span class="quoted">‹<span class="skolem">Bs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">B</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> hd <span class="main">(</span>dims <span class="skolem">A</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> subtensor_decomposition<span class="main">[</span><span class="operator">OF</span> order_step.hyps<span class="main">]</span> cprank_max_listsum
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Bs_def <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">Ba</span><span class="main">.</span> <span class="bound">Ba</span> <span class="main">∈</span> set <span class="skolem">Bs</span> <span class="main">⟹</span> dims <span class="skolem">A</span> <span class="main">=</span> dims <span class="bound">Ba</span>›</span></span> diff_zero length_map length_upt list.exhaust_sel prod_list.Cons mult.commute order_step.hyps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cprank</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>ring_1 tensor <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">cprank</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> cprank_max <span class="bound">n</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Tensor_Rank-cprank_upper_bound"><span class="command">lemma</span></span> cprank_upper_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"cprank <span class="free">A</span> <span class="main">≤</span> prod_list <span class="main">(</span>dims <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> cprank_def <span class="keyword1"><span class="command">using</span></span> cprank_max_upper_bound Least_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Tensor_Rank-cprank_max_cprank"><span class="command">lemma</span></span> cprank_max_cprank<span class="main">:</span> <span class="quoted"><span class="quoted">"cprank_max <span class="main">(</span>cprank <span class="free">A</span><span class="main">)</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> cprank_def <span class="keyword1"><span class="command">using</span></span> cprank_max_upper_bound <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> LeastI<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Tensor_Matricization">
<div class="head">
<h1>Theory Tensor_Matricization</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Alexander Bentkamp, Universität des Saarlandes
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Tensor Matricization›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Tensor_Matricization
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Tensor_Plus.html">Tensor_Plus</a>
<a href="../Jordan_Normal_Form/Matrix.html">Jordan_Normal_Form.Matrix</a> <a href="../Jordan_Normal_Form/DL_Missing_Sublist.html">Jordan_Normal_Form.DL_Missing_Sublist</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">digit_decode</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> nat list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">digit_decode</span> <span class="main">[]</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">digit_decode</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">is</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">*</span> <span class="free">digit_decode</span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span> <span class="free"><span class="bound"><span class="entity">is</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">digit_encode</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> nat <span class="main">⇒</span> nat list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">digit_encode</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">digit_encode</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">mod</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">#</span> <span class="free">digit_encode</span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">div</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Tensor_Matricization-digit_encode_decode"><span class="command">lemma</span></span> digit_encode_decode<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">⊲</span> <span class="free">ds</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"digit_encode <span class="free">ds</span> <span class="main">(</span>digit_decode <span class="free">ds</span> <span class="free">is</span><span class="main">)</span> <span class="main">=</span> <span class="free">is</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>valid_index.induct<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> digit_decode.simps digit_encode.simps
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="Tensor_Matricization-digit_decode_encode"><span class="command">lemma</span></span> digit_decode_encode<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"digit_decode <span class="free">ds</span> <span class="main">(</span>digit_encode <span class="free">ds</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">mod</span> <span class="main">(</span>prod_list <span class="free">ds</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ds</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Divides.mod_mult2_eq add.commute<span class="main">)</span>

<span class="keyword1" id="Tensor_Matricization-digit_decode_encode_lt"><span class="command">lemma</span></span> digit_decode_encode_lt<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> prod_list <span class="free">ds</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"digit_decode <span class="free">ds</span> <span class="main">(</span>digit_encode <span class="free">ds</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1" id="Tensor_Matricization-digit_decode_lt"><span class="command">lemma</span></span> digit_decode_lt<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">⊲</span> <span class="free">ds</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"digit_decode <span class="free">ds</span> <span class="free">is</span> <span class="main">&lt;</span> prod_list <span class="free">ds</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>valid_index.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="quoted">"<span class="skolem">is</span>"</span> <span class="skolem">ds</span> <span class="skolem">i</span> <span class="skolem">d</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">d</span> <span class="main">*</span> digit_decode <span class="skolem">ds</span> <span class="skolem">is</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span><span class="skolem">d</span> <span class="main">*</span> prod_list <span class="skolem">ds</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons.IH Cons.hyps<span class="main">(</span>2<span class="main">)</span> div_mult2_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> digit_decode.simps prod_list.Cons
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Cons.IH Cons.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> div_eq_0_iff mult_eq_0_iff not_less0<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor_Matricization-digit_encode_valid_index"><span class="command">lemma</span></span> digit_encode_valid_index<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&lt;</span> prod_list <span class="free">ds</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"digit_encode <span class="free">ds</span> <span class="free">a</span> <span class="main">⊲</span> <span class="free">ds</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ds</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">a</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_index.Nil<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">d</span> <span class="skolem">ds</span> <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">&lt;</span> <span class="skolem">d</span> <span class="main">*</span> prod_list <span class="skolem">ds</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="keyword1">div</span> <span class="skolem">d</span> <span class="main">&lt;</span> prod_list <span class="skolem">ds</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> div_eq_0_iff div_mult2_eq mult_0_right not_less0<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"digit_encode <span class="skolem">ds</span> <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">div</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">⊲</span> <span class="skolem">ds</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">&lt;</span> <span class="skolem">d</span> <span class="main">*</span> prod_list <span class="skolem">ds</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="keyword1">mod</span> <span class="skolem">d</span> <span class="main">&lt;</span> <span class="skolem">d</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_index.Cons<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor_Matricization-length_digit_encode"><span class="command">lemma</span></span> length_digit_encode<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>digit_encode <span class="free">ds</span> <span class="free">a</span><span class="main">)</span> <span class="main">=</span> length <span class="free">ds</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ds</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="Tensor_Matricization-digit_encode_0"><span class="command">lemma</span></span> digit_encode_0<span class="main">:</span>
<span class="quoted"><span class="quoted">"prod_list <span class="free">ds</span> <span class="keyword1">dvd</span> <span class="free">a</span> <span class="main">⟹</span> digit_encode <span class="free">ds</span> <span class="free">a</span> <span class="main">=</span> replicate <span class="main">(</span>length <span class="free">ds</span><span class="main">)</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ds</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">a</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">d</span> <span class="skolem">ds</span> <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prod_list <span class="skolem">ds</span> <span class="keyword1">dvd</span> <span class="main">(</span><span class="skolem">a</span> <span class="keyword1">div</span> <span class="skolem">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> prod_list.Cons
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dvd_0_right dvd_div_iff_mult dvd_mult_left mult.commute split_div<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> digit_encode.simps length_Cons replicate_Suc prod_list.Cons <span class="keyword1"><span class="command">using</span></span> Cons
    <span class="keyword1"><span class="command">using</span></span> dvd_imp_mod_0 dvd_mult_left prod_list.Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1" id="Tensor_Matricization-valid_index_weave"><span class="command">lemma</span></span> valid_index_weave<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">is1</span> <span class="main">⊲</span> <span class="main">(</span>nths <span class="free">ds</span> <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="free">is2</span> <span class="main">⊲</span> <span class="main">(</span>nths <span class="free">ds</span> <span class="main">(</span><span class="main">-</span><span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"weave <span class="free">A</span> <span class="free">is1</span> <span class="free">is2</span> <span class="main">⊲</span> <span class="free">ds</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"nths <span class="main">(</span>weave <span class="free">A</span> <span class="free">is1</span> <span class="free">is2</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> <span class="free">is1</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"nths <span class="main">(</span>weave <span class="free">A</span> <span class="free">is1</span> <span class="free">is2</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">is2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> length_ds<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">is1</span> <span class="main">+</span> length <span class="free">is2</span> <span class="main">=</span> length <span class="free">ds</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_index_length<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> valid_index_length<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    length_weave  weave_complementary_nthss <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"length <span class="free">is1</span> <span class="main">=</span> card <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">is1</span> <span class="main">+</span> length <span class="free">is2</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> length_ds
    <span class="keyword1"><span class="command">using</span></span> length_nths' assms<span class="main">(</span>1<span class="main">)</span> valid_index_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"length <span class="free">is2</span> <span class="main">=</span> card <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="main">-</span><span class="free">A</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">is1</span> <span class="main">+</span> length <span class="free">is2</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> length_ds
    <span class="keyword1"><span class="command">using</span></span> length_nths'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ds</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">A</span>"</span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span> valid_index_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nths <span class="main">(</span>weave <span class="free">A</span> <span class="free">is1</span> <span class="free">is2</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> <span class="free">is1</span>"</span></span> <span class="quoted"><span class="quoted">"nths <span class="main">(</span>weave <span class="free">A</span> <span class="free">is1</span> <span class="free">is2</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">is2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> nths_weave<span class="main">[</span><span class="operator">OF</span> 1 2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nths <span class="main">(</span>weave <span class="free">A</span> <span class="free">is1</span> <span class="free">is2</span><span class="main">)</span> <span class="free">A</span> <span class="main">⊲</span> <span class="main">(</span>nths <span class="free">ds</span> <span class="free">A</span><span class="main">)</span>"</span></span>
       <span class="quoted"><span class="quoted">"nths <span class="main">(</span>weave <span class="free">A</span> <span class="free">is1</span> <span class="free">is2</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="free">A</span><span class="main">)</span> <span class="main">⊲</span> <span class="main">(</span>nths <span class="free">ds</span> <span class="main">(</span><span class="main">-</span><span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"weave <span class="free">A</span> <span class="free">is1</span> <span class="free">is2</span> <span class="main">⊲</span> <span class="free">ds</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> list_all2_nths valid_index_list_all2_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">matricize</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set <span class="main">⇒</span> <span class="tfree">'a</span> tensor <span class="main">⇒</span> <span class="tfree">'a</span> mat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">matricize</span> <span class="free"><span class="bound"><span class="entity">rmodes</span></span></span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> mat
  <span class="main">(</span>prod_list <span class="main">(</span>nths <span class="main">(</span>Tensor.dims <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">rmodes</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>prod_list <span class="main">(</span>nths <span class="main">(</span>Tensor.dims <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">rmodes</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">.</span> Tensor.lookup <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">(</span>weave <span class="free"><span class="bound"><span class="entity">rmodes</span></span></span>
    <span class="main">(</span>digit_encode <span class="main">(</span>nths <span class="main">(</span>Tensor.dims <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">rmodes</span></span></span><span class="main">)</span> <span class="bound">r</span><span class="main">)</span>
    <span class="main">(</span>digit_encode <span class="main">(</span>nths <span class="main">(</span>Tensor.dims <span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">rmodes</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">c</span><span class="main">)</span>
  <span class="main">)</span><span class="main">)</span>
"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">dematricize</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat set <span class="main">⇒</span> <span class="tfree">'a</span> mat <span class="main">⇒</span> nat list <span class="main">⇒</span> <span class="tfree">'a</span> tensor"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">dematricize</span> <span class="free"><span class="bound"><span class="entity">rmodes</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span>  <span class="main">=</span> tensor_from_lookup <span class="free"><span class="bound"><span class="entity">ds</span></span></span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">is</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">$$</span> <span class="main">(</span>digit_decode <span class="main">(</span>nths <span class="free"><span class="bound"><span class="entity">ds</span></span></span> <span class="free"><span class="bound"><span class="entity">rmodes</span></span></span><span class="main">)</span> <span class="main">(</span>nths <span class="bound">is</span> <span class="free"><span class="bound"><span class="entity">rmodes</span></span></span><span class="main">)</span><span class="main">,</span>
              digit_decode <span class="main">(</span>nths <span class="free"><span class="bound"><span class="entity">ds</span></span></span> <span class="main">(</span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">rmodes</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>nths <span class="bound">is</span> <span class="main">(</span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">rmodes</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
 <span class="main">)</span>
"</span></span>

<span class="keyword1" id="Tensor_Matricization-dims_matricize"><span class="command">lemma</span></span> dims_matricize<span class="main">:</span>
<span class="quoted"><span class="quoted">"dim_row <span class="main">(</span>matricize <span class="free">rmodes</span> <span class="free">T</span><span class="main">)</span> <span class="main">=</span> prod_list <span class="main">(</span>nths <span class="main">(</span>Tensor.dims <span class="free">T</span><span class="main">)</span> <span class="free">rmodes</span><span class="main">)</span>"</span></span>
<span class="quoted"><span class="quoted">"dim_col <span class="main">(</span>matricize <span class="free">rmodes</span> <span class="free">T</span><span class="main">)</span> <span class="main">=</span> prod_list <span class="main">(</span>nths <span class="main">(</span>Tensor.dims <span class="free">T</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="free">rmodes</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> matricize_def <span class="keyword1"><span class="command">using</span></span> dim_row_mat <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="Tensor_Matricization-dims_dematricize"><span class="command">lemma</span></span> dims_dematricize<span class="main">:</span> <span class="quoted"><span class="quoted">"Tensor.dims <span class="main">(</span>dematricize <span class="free">rmodes</span> <span class="free">A</span> <span class="free">ds</span><span class="main">)</span> <span class="main">=</span> <span class="free">ds</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dematricize_def dims_tensor_from_lookup<span class="main">)</span>

<span class="keyword1" id="Tensor_Matricization-valid_index_nths"><span class="command">lemma</span></span> valid_index_nths<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">⊲</span> <span class="free">ds</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nths <span class="free">is</span> <span class="free">A</span> <span class="main">⊲</span> nths <span class="free">ds</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>valid_index.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> nths_nil valid_index.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="quoted">"<span class="skolem">is</span>"</span> <span class="skolem">ds</span> <span class="skolem">i</span> <span class="skolem">d</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">" nths <span class="skolem">is</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> Suc <span class="bound">j</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">}</span> <span class="main">⊲</span> nths <span class="skolem">ds</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> Suc <span class="bound">j</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> nths_Cons
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">∈</span><span class="skolem">A</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> valid_index.Cons<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor_Matricization-dematricize_matricize"><span class="command">lemma</span></span> dematricize_matricize<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dematricize <span class="free">rmodes</span> <span class="main">(</span>matricize <span class="free">rmodes</span> <span class="free">T</span><span class="main">)</span> <span class="main">(</span>Tensor.dims <span class="free">T</span><span class="main">)</span> <span class="main">=</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> tensor_lookup_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"Tensor.dims <span class="main">(</span>dematricize <span class="free">rmodes</span> <span class="main">(</span>matricize <span class="free">rmodes</span> <span class="free">T</span><span class="main">)</span> <span class="main">(</span>Tensor.dims <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Tensor.dims <span class="free">T</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dematricize_def dims_tensor_from_lookup<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="quoted">"<span class="skolem">is</span>"</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> Tensor.dims <span class="main">(</span>dematricize <span class="free">rmodes</span> <span class="main">(</span>matricize <span class="free">rmodes</span> <span class="free">T</span><span class="main">)</span> <span class="main">(</span>Tensor.dims <span class="free">T</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> Tensor.dims <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rds</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nths <span class="main">(</span>Tensor.dims <span class="free">T</span><span class="main">)</span> <span class="free">rmodes</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cds</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nths <span class="main">(</span>Tensor.dims <span class="free">T</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="free">rmodes</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> decode_r<span class="main">:</span> <span class="quoted"><span class="quoted">"digit_decode <span class="var">?rds</span> <span class="main">(</span>nths <span class="skolem">is</span> <span class="free">rmodes</span><span class="main">)</span> <span class="main">&lt;</span> prod_list <span class="var">?rds</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">⊲</span> Tensor.dims <span class="free">T</span>›</span></span> valid_index_nths digit_decode_lt<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> decode_c<span class="main">:</span> <span class="quoted"><span class="quoted">"digit_decode <span class="var">?cds</span> <span class="main">(</span>nths <span class="skolem">is</span> <span class="main">(</span><span class="main">-</span><span class="free">rmodes</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> prod_list <span class="var">?cds</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">⊲</span> Tensor.dims <span class="free">T</span>›</span></span> valid_index_nths digit_decode_lt<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>matricize <span class="free">rmodes</span> <span class="free">T</span><span class="main">)</span> <span class="main">$$</span>
     <span class="main">(</span>digit_decode <span class="var">?rds</span> <span class="main">(</span>nths <span class="skolem">is</span> <span class="free">rmodes</span><span class="main">)</span><span class="main">,</span>
      digit_decode <span class="var">?cds</span> <span class="main">(</span>nths <span class="skolem">is</span> <span class="main">(</span><span class="main">-</span> <span class="free">rmodes</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    Tensor.lookup <span class="free">T</span> <span class="skolem">is</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> matricize_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> decode_r decode_c <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">⊲</span> Tensor.dims <span class="free">T</span>›</span></span> valid_index_nths<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Tensor.lookup <span class="main">(</span>dematricize <span class="free">rmodes</span> <span class="main">(</span>matricize <span class="free">rmodes</span> <span class="free">T</span><span class="main">)</span> <span class="main">(</span>Tensor.dims <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="skolem">is</span> <span class="main">=</span> Tensor.lookup <span class="free">T</span> <span class="skolem">is</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dematricize_def dims_tensor_from_lookup lookup_tensor_from_lookup<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">⊲</span> Tensor.dims <span class="free">T</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor_Matricization-matricize_dematricize"><span class="command">lemma</span></span> matricize_dematricize<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">" dim_row <span class="free">A</span> <span class="main">=</span> prod_list <span class="main">(</span>nths <span class="free">ds</span> <span class="free">rmodes</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">" dim_col <span class="free">A</span> <span class="main">=</span> prod_list <span class="main">(</span>nths <span class="free">ds</span> <span class="main">(</span><span class="main">-</span><span class="free">rmodes</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matricize <span class="free">rmodes</span> <span class="main">(</span>dematricize <span class="free">rmodes</span> <span class="free">A</span> <span class="free">ds</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> eq_matI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span>matricize <span class="free">rmodes</span> <span class="main">(</span>dematricize <span class="free">rmodes</span> <span class="free">A</span> <span class="free">ds</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dim_row <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> assms<span class="main">(</span>1<span class="main">)</span> dematricize_def dims_tensor_from_lookup matricize_def dim_row_mat <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span>matricize <span class="free">rmodes</span> <span class="main">(</span>dematricize <span class="free">rmodes</span> <span class="free">A</span> <span class="free">ds</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dim_col <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> assms<span class="main">(</span>2<span class="main">)</span> dematricize_def dims_tensor_from_lookup matricize_def dim_col_mat <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">c</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">&lt;</span> dim_row <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">&lt;</span> dim_col <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> valid1<span class="main">:</span><span class="quoted"><span class="quoted">"digit_encode <span class="main">(</span>nths <span class="free">ds</span> <span class="free">rmodes</span><span class="main">)</span> <span class="skolem">r</span> <span class="main">⊲</span> nths <span class="free">ds</span> <span class="free">rmodes</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
       valid2<span class="main">:</span><span class="quoted"><span class="quoted">"digit_encode <span class="main">(</span>nths <span class="free">ds</span> <span class="main">(</span><span class="main">-</span> <span class="free">rmodes</span><span class="main">)</span><span class="main">)</span> <span class="skolem">c</span> <span class="main">⊲</span> nths <span class="free">ds</span> <span class="main">(</span><span class="main">-</span> <span class="free">rmodes</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">&lt;</span> dim_row <span class="free">A</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">&lt;</span> dim_col <span class="free">A</span>›</span></span> assms<span class="main">(</span>2<span class="main">)</span> digit_encode_valid_index <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span><span class="quoted"><span class="quoted">"Tensor.lookup <span class="main">(</span>dematricize <span class="free">rmodes</span> <span class="free">A</span> <span class="free">ds</span><span class="main">)</span>
     <span class="main">(</span>weave <span class="free">rmodes</span>
       <span class="main">(</span>digit_encode <span class="main">(</span>nths <span class="main">(</span>Tensor.dims <span class="main">(</span>dematricize <span class="free">rmodes</span> <span class="free">A</span> <span class="free">ds</span><span class="main">)</span><span class="main">)</span> <span class="free">rmodes</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span>
       <span class="main">(</span>digit_encode <span class="main">(</span>nths <span class="main">(</span>Tensor.dims <span class="main">(</span>dematricize <span class="free">rmodes</span> <span class="free">A</span> <span class="free">ds</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span> <span class="free">rmodes</span><span class="main">)</span><span class="main">)</span> <span class="skolem">c</span><span class="main">)</span>
     <span class="main">)</span> <span class="main">=</span>  <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> dematricize_def <span class="keyword1"><span class="command">unfolding</span></span> dims_tensor_from_lookup
      <span class="keyword1"><span class="command">unfolding</span></span> lookup_tensor_from_lookup<span class="main">[</span><span class="operator">OF</span> valid_index_weave<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> valid1 valid2<span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> digit_decode_encode_lt<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">&lt;</span> dim_col <span class="free">A</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      digit_decode_encode_lt<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">&lt;</span> dim_row <span class="free">A</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      valid_index_weave<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> valid1 valid2<span class="main">]</span> valid_index_weave<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> valid1 valid2<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r</span> <span class="main">&lt;</span> dim_row <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> r_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">&lt;</span> prod_list <span class="main">(</span>nths <span class="main">(</span>Tensor.dims <span class="main">(</span>dematricize <span class="free">rmodes</span> <span class="free">A</span> <span class="free">ds</span><span class="main">)</span><span class="main">)</span> <span class="free">rmodes</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹dim_row <span class="main">(</span>matricize <span class="free">rmodes</span> <span class="main">(</span>dematricize <span class="free">rmodes</span> <span class="free">A</span> <span class="free">ds</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dim_row <span class="free">A</span>›</span></span> matricize_def dim_row_mat<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">&lt;</span> dim_col <span class="free">A</span> ›</span></span><span class="keyword1"><span class="command">have</span></span> c_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">&lt;</span> prod_list <span class="main">(</span>nths <span class="main">(</span>Tensor.dims <span class="main">(</span>dematricize <span class="free">rmodes</span> <span class="free">A</span> <span class="free">ds</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span> <span class="free">rmodes</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹dim_col <span class="main">(</span>matricize <span class="free">rmodes</span> <span class="main">(</span>dematricize <span class="free">rmodes</span> <span class="free">A</span> <span class="free">ds</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dim_col <span class="free">A</span>›</span></span> matricize_def dim_col_mat<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>matricize <span class="free">rmodes</span> <span class="main">(</span>dematricize <span class="free">rmodes</span> <span class="free">A</span> <span class="free">ds</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> matricize_def <span class="keyword1"><span class="command">using</span></span> r_le c_le 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor_Matricization-matricize_add"><span class="command">lemma</span></span> matricize_add<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dims <span class="free">A</span> <span class="main">=</span> dims <span class="free">B</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matricize <span class="free">I</span> <span class="free">A</span> <span class="main">+</span> matricize <span class="free">I</span> <span class="free">B</span> <span class="main">=</span> matricize <span class="free">I</span> <span class="main">(</span><span class="free">A</span><span class="main">+</span><span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> eq_matI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span>matricize <span class="free">I</span> <span class="free">A</span> <span class="main">+</span> matricize <span class="free">I</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> dim_row <span class="main">(</span>matricize <span class="free">I</span> <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms dims_matricize<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span>matricize <span class="free">I</span> <span class="free">A</span> <span class="main">+</span> matricize <span class="free">I</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> dim_col <span class="main">(</span>matricize <span class="free">I</span> <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms dims_matricize<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> ij_le1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> dim_row <span class="main">(</span>matricize <span class="free">I</span> <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> dim_col <span class="main">(</span>matricize <span class="free">I</span> <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
    ij_le2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> prod_list <span class="main">(</span>nths <span class="main">(</span>Tensor.dims <span class="free">A</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> prod_list <span class="main">(</span>nths <span class="main">(</span>Tensor.dims <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ij_le3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> prod_list <span class="main">(</span>nths <span class="main">(</span>Tensor.dims <span class="free">B</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> prod_list <span class="main">(</span>nths <span class="main">(</span>Tensor.dims <span class="free">B</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ij_le4<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> prod_list <span class="main">(</span>nths <span class="main">(</span>Tensor.dims <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> prod_list <span class="main">(</span>nths <span class="main">(</span>Tensor.dims <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms dims_matricize<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ij_le5<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> dim_row <span class="main">(</span>matricize <span class="free">I</span> <span class="free">B</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> dim_col <span class="main">(</span>matricize <span class="free">I</span> <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms dims_matricize<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>matricize <span class="free">I</span> <span class="free">A</span> <span class="main">+</span> matricize <span class="free">I</span> <span class="free">B</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> matricize <span class="free">I</span> <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> index_add_mat<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> ij_le5<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> matricize_def <span class="keyword1"><span class="command">unfolding</span></span> index_mat<span class="main">[</span><span class="operator">OF</span> ij_le2<span class="main">]</span> index_mat<span class="main">[</span><span class="operator">OF</span> ij_le3<span class="main">]</span> index_mat<span class="main">[</span><span class="operator">OF</span> ij_le4<span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> assms digit_encode_valid_index ij_le2<span class="main">(</span>1<span class="main">)</span> ij_le2<span class="main">(</span>2<span class="main">)</span> valid_index_weave<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Tensor_Matricization-matricize_0"><span class="command">lemma</span></span> matricize_0<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"matricize <span class="free">I</span> <span class="main">(</span>tensor0 <span class="free">ds</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>dim_row <span class="main">(</span>matricize <span class="free">I</span> <span class="main">(</span>tensor0 <span class="free">ds</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>dim_col <span class="main">(</span>matricize <span class="free">I</span> <span class="main">(</span>tensor0 <span class="free">ds</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> eq_matI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span>matricize <span class="free">I</span> <span class="main">(</span>tensor0 <span class="free">ds</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dim_row <span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>dim_row <span class="main">(</span>matricize <span class="free">I</span> <span class="main">(</span>tensor0 <span class="free">ds</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>dim_col <span class="main">(</span>matricize <span class="free">I</span> <span class="main">(</span>tensor0 <span class="free">ds</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> zero_mat_def dim_row_mat <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dims_matricize<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span>matricize <span class="free">I</span> <span class="main">(</span>tensor0 <span class="free">ds</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dim_col <span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>dim_row <span class="main">(</span>matricize <span class="free">I</span> <span class="main">(</span>tensor0 <span class="free">ds</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>dim_col <span class="main">(</span>matricize <span class="free">I</span> <span class="main">(</span>tensor0 <span class="free">ds</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> zero_mat_def dim_row_mat <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dims_matricize<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> ij_le1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> dim_row <span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>dim_row <span class="main">(</span>matricize <span class="free">I</span> <span class="main">(</span>tensor0 <span class="free">ds</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>dim_col <span class="main">(</span>matricize <span class="free">I</span> <span class="main">(</span>tensor0 <span class="free">ds</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
                 <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> dim_col <span class="main">(</span><span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>dim_row <span class="main">(</span>matricize <span class="free">I</span> <span class="main">(</span>tensor0 <span class="free">ds</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>dim_col <span class="main">(</span>matricize <span class="free">I</span> <span class="main">(</span>tensor0 <span class="free">ds</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ij_le2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> dim_row <span class="main">(</span>matricize <span class="free">I</span> <span class="main">(</span>tensor0 <span class="free">ds</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> dim_col <span class="main">(</span>matricize <span class="free">I</span> <span class="main">(</span>tensor0 <span class="free">ds</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> zero_mat_def dim_row_mat <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dims_matricize<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"matricize <span class="free">I</span> <span class="main">(</span>tensor0 <span class="free">ds</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>dim_row <span class="main">(</span>matricize <span class="free">I</span> <span class="main">(</span>tensor0 <span class="free">ds</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>dim_col <span class="main">(</span>matricize <span class="free">I</span> <span class="main">(</span>tensor0 <span class="free">ds</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> zero_mat_def  index_mat<span class="main">[</span><span class="operator">OF</span> ij_le2<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> matricize_def index_mat<span class="main">[</span><span class="operator">OF</span> ij_le2<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">unfolded</span></span> dims_matricize<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> lookup_tensor0 digit_encode_valid_index dims_matricize<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> dims_matricize<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> dims_tensor0
    ij_le2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ij_le2<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> valid_index_weave<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="DL_Rank_CP_Rank">
<div class="head">
<h1>Theory DL_Rank_CP_Rank</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Alexander Bentkamp, Universität des Saarlandes *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹CP-Rank and Matrix Rank›</span></span>

<span class="keyword1"><span class="command">theory</span></span> DL_Rank_CP_Rank
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Tensor_Rank.html">Tensor_Rank</a> <a href="../Jordan_Normal_Form/DL_Rank.html">Jordan_Normal_Form.DL_Rank</a> <a href="Tensor_Matricization.html">Tensor_Matricization</a> 
  <a href="../Jordan_Normal_Form/DL_Submatrix.html">Jordan_Normal_Form.DL_Submatrix</a> <a href="../Jordan_Normal_Form/Missing_VectorSpace.html">Jordan_Normal_Form.Missing_VectorSpace</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">mrank</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">==</span> vec_space.rank <span class="main">(</span>dim_row <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="keyword1"><span class="command">no_notation</span></span> <span class="quoted">"normal_rel"</span>  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊲</span>"</span> 60<span class="main">)</span>

<span class="keyword1" id="DL_Rank_CP_Rank-lookup_order1_prod"><span class="command">lemma</span></span> lookup_order1_prod<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">B</span><span class="main">.</span> <span class="bound">B</span><span class="main">∈</span>set <span class="free">Bs</span> <span class="main">⟹</span> Tensor.order <span class="bound">B</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">⊲</span> dims <span class="main">(</span>prod_list <span class="free">Bs</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span>prod_list <span class="free">Bs</span><span class="main">)</span> <span class="free">is</span> <span class="main">=</span> prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">B</span><span class="main">)</span><span class="main">.</span> lookup <span class="bound">B</span> <span class="main">[</span><span class="bound">i</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>zip <span class="free">is</span> <span class="free">Bs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">Bs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="quoted">"<span class="free">is</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted">"prod_list.Nil"</span> <span class="keyword1"><span class="command">unfolding</span></span> zip.simps tensor_one_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> dims_tensor_from_lookup length_greater_0_conv length_map prod_list.Nil
    lookup_tensor_from_lookup tensor_one_def tensor_one_from_lookup<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">B</span> <span class="skolem">Bs</span> <span class="quoted">"<span class="skolem">is'</span>"</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="quoted">"<span class="skolem"><span class="skolem">is</span></span>"</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is'</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">#</span> <span class="skolem">is</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_is_Nil_conv dims_tensor_prod length_0_conv list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> prod_list.Cons valid_index.simps zero_neq_one<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Tensor.order <span class="skolem">B</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> valid1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">i</span><span class="main">]</span> <span class="main">⊲</span> dims <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is'</span> <span class="main">⊲</span> dims <span class="main">(</span>prod_list <span class="main">(</span><span class="skolem">B</span> <span class="main">#</span> <span class="skolem">Bs</span><span class="main">)</span><span class="main">)</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> prod_list.Cons dims_tensor_prod <span class="quoted"><span class="quoted">‹<span class="skolem">is'</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">#</span> <span class="skolem">is</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_length_conv hd_append2 length_0_conv list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> valid_index.Nil valid_index.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> valid2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> dims <span class="main">(</span>prod_list <span class="skolem">Bs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is'</span> <span class="main">⊲</span> dims <span class="main">(</span>prod_list <span class="main">(</span><span class="skolem">B</span> <span class="main">#</span> <span class="skolem">Bs</span><span class="main">)</span><span class="main">)</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> prod_list.Cons dims_tensor_prod <span class="quoted"><span class="quoted">‹<span class="skolem">is'</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">#</span> <span class="skolem">is</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹Tensor.order <span class="skolem">B</span> <span class="main">=</span> <span class="main">1</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_length_conv append_eq_Cons_conv length_0_conv list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> self_append_conv2 valid_indexE<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is'</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">#</span> <span class="skolem">is</span>›</span></span> List.zip_Cons_Cons List.list.map<span class="main">(</span>2<span class="main">)</span> prod_list.Cons
    lookup_tensor_prod<span class="main">[</span><span class="operator">OF</span> valid1 valid2<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons.IH Cons.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> valid2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Rank_CP_Rank-matricize_cprank_max1"><span class="command">lemma</span></span> matricize_cprank_max1<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>field tensor"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cprank_max1 <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mrank <span class="main">(</span>matricize <span class="free">I</span> <span class="free">A</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Bs</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">B</span><span class="main">.</span> <span class="bound">B</span> <span class="main">∈</span> set <span class="skolem">Bs</span> <span class="main">⟹</span> Tensor.order <span class="bound">B</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">⋅</span> prod_list <span class="skolem">Bs</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cprank_max1_prod_listE assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">row_factor</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">row_factor</span> <span class="skolem">ris</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">*</span> prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">B</span><span class="main">)</span><span class="main">.</span> lookup <span class="bound">B</span> <span class="main">[</span><span class="bound">i</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>zip <span class="skolem">ris</span> <span class="main">(</span>nths <span class="skolem">Bs</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ris</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">col_factor</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">col_factor</span> <span class="skolem">cis</span> <span class="main">=</span> prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">B</span><span class="main">)</span><span class="main">.</span> lookup <span class="bound">B</span> <span class="main">[</span><span class="bound">i</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>zip <span class="skolem">cis</span> <span class="main">(</span>nths <span class="skolem">Bs</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">cis</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">is</span><span class="main">.</span> <span class="bound">is</span> <span class="main">⊲</span> dims <span class="free">A</span> <span class="main">⟹</span> lookup <span class="free">A</span> <span class="bound">is</span> <span class="main">=</span> <span class="skolem">row_factor</span> <span class="main">(</span>nths <span class="bound">is</span> <span class="free">I</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">col_factor</span> <span class="main">(</span>nths <span class="bound">is</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="quoted">"<span class="skolem">is</span>"</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> dims <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lookup <span class="free">A</span> <span class="skolem">is</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">*</span> <span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">B</span><span class="main">)</span><span class="main">.</span> lookup <span class="bound">B</span> <span class="main">[</span><span class="bound">i</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>zip <span class="skolem">is</span> <span class="skolem">Bs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lookup_order1_prod<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">B</span><span class="main">.</span> <span class="bound">B</span> <span class="main">∈</span> set <span class="skolem">Bs</span> <span class="main">⟹</span> Tensor.order <span class="bound">B</span> <span class="main">=</span> <span class="main">1</span>›</span></span><span class="main">]</span> lookup_smult
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">⋅</span> prod_list <span class="skolem">Bs</span> <span class="main">=</span> <span class="free">A</span>›</span></span> dims_smult <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">*</span> <span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">B</span><span class="main">)</span><span class="main">.</span> lookup <span class="bound">B</span> <span class="main">[</span><span class="bound">i</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>nths <span class="main">(</span>zip <span class="skolem">is</span> <span class="skolem">Bs</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
                         <span class="main">(</span>prod_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">B</span><span class="main">)</span><span class="main">.</span> lookup <span class="bound">B</span> <span class="main">[</span><span class="bound">i</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>nths <span class="main">(</span>zip <span class="skolem">is</span> <span class="skolem">Bs</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod_list_complementary_nthss <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">row_factor</span> <span class="main">(</span>nths <span class="skolem">is</span> <span class="free">I</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">col_factor</span> <span class="main">(</span>nths <span class="skolem">is</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nths_zip row_factor_def col_factor_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lookup <span class="free">A</span> <span class="skolem">is</span> <span class="main">=</span> <span class="skolem">row_factor</span> <span class="main">(</span>nths <span class="skolem">is</span> <span class="free">I</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">col_factor</span> <span class="main">(</span>nths <span class="skolem">is</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">row_factor'</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">row_factor'</span> <span class="skolem">r</span> <span class="main">=</span> <span class="skolem">row_factor</span> <span class="main">(</span>digit_encode <span class="main">(</span>nths <span class="main">(</span>Tensor.dims <span class="free">A</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">r</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">col_factor'</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">col_factor'</span> <span class="skolem">c</span> <span class="main">=</span> <span class="skolem">col_factor</span> <span class="main">(</span>digit_encode <span class="main">(</span>nths <span class="main">(</span>Tensor.dims <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">c</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">r</span><span class="main">&lt;</span>dim_row <span class="main">(</span>matricize <span class="free">I</span> <span class="free">A</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">c</span><span class="main">&lt;</span>dim_col <span class="main">(</span>matricize <span class="free">I</span> <span class="free">A</span><span class="main">)</span> <span class="main">⟹</span> matricize <span class="free">I</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">r</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">row_factor'</span> <span class="bound">r</span> <span class="main">*</span> <span class="skolem">col_factor'</span> <span class="bound">c</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">c</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span><span class="main">&lt;</span>dim_row <span class="main">(</span>matricize <span class="free">I</span> <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span><span class="main">&lt;</span>dim_col <span class="main">(</span>matricize <span class="free">I</span> <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"matricize <span class="free">I</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span> <span class="main">=</span> Tensor.lookup <span class="free">A</span> <span class="main">(</span>weave <span class="free">I</span>
      <span class="main">(</span>digit_encode <span class="main">(</span>nths <span class="main">(</span>Tensor.dims <span class="free">A</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span> <span class="skolem">r</span><span class="main">)</span>
      <span class="main">(</span>digit_encode <span class="main">(</span>nths <span class="main">(</span>Tensor.dims <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="skolem">c</span><span class="main">)</span>
    <span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dims_matricize <span class="keyword1"><span class="command">unfolding</span></span> matricize_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">row_factor'</span> <span class="skolem">r</span> <span class="main">*</span> <span class="skolem">col_factor'</span> <span class="skolem">c</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">is</span><span class="main">.</span> <span class="bound">is</span> <span class="main">⊲</span> dims <span class="free">A</span> <span class="main">⟹</span> lookup <span class="free">A</span> <span class="bound">is</span> <span class="main">=</span> <span class="skolem">row_factor</span> <span class="main">(</span>nths <span class="bound">is</span> <span class="free">I</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">col_factor</span> <span class="main">(</span>nths <span class="bound">is</span> <span class="main">(</span><span class="main">-</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span>›</span></span>
      valid_index_weave<span class="main">[</span><span class="operator">OF</span>
      digit_encode_valid_index<span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span><span class="operator"><span class="operator"><span class="operator">OF</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">‹<span class="skolem"><span class="skolem"><span class="skolem">r</span></span></span> <span class="main"><span class="main"><span class="main">&lt;</span></span></span> dim_row <span class="main"><span class="main"><span class="main">(</span></span></span>matricize <span class="free"><span class="free"><span class="free">I</span></span></span> <span class="free"><span class="free"><span class="free">A</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>›</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span><span class="operator"><span class="operator"><span class="operator">unfolded</span></span></span> dims_matricize<span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span>
      digit_encode_valid_index<span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span><span class="operator"><span class="operator"><span class="operator">OF</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">‹<span class="skolem"><span class="skolem"><span class="skolem">c</span></span></span> <span class="main"><span class="main"><span class="main">&lt;</span></span></span> dim_col <span class="main"><span class="main"><span class="main">(</span></span></span>matricize <span class="free"><span class="free"><span class="free">I</span></span></span> <span class="free"><span class="free"><span class="free">A</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>›</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span><span class="operator"><span class="operator"><span class="operator">unfolded</span></span></span> dims_matricize<span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span><span class="main">]</span>
      valid_index_weave<span class="main">(</span>2<span class="main">)</span> valid_index_weave<span class="main">(</span>3<span class="main">)</span> row_factor'_def col_factor'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"matricize <span class="free">I</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">r</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">row_factor'</span> <span class="skolem">r</span> <span class="main">*</span> <span class="skolem">col_factor'</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> vec_space.rank_le_1_product_entries<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"matricize <span class="free">I</span> <span class="free">A</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Rank_CP_Rank-matrix_rank_le_cprank_max"><span class="command">lemma</span></span> matrix_rank_le_cprank_max<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>field<span class="main">)</span> tensor"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"cprank_max <span class="free">r</span> <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mrank <span class="main">(</span>matricize <span class="free">I</span> <span class="free">A</span><span class="main">)</span> <span class="main">≤</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>cprank_max.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ds</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"matricize <span class="free">I</span> <span class="main">(</span>tensor0 <span class="skolem">ds</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>dim_row <span class="main">(</span>matricize <span class="free">I</span> <span class="main">(</span>tensor0 <span class="skolem">ds</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>dim_col <span class="main">(</span>matricize <span class="free">I</span> <span class="main">(</span>tensor0 <span class="skolem">ds</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> matricize_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mrank <span class="main">(</span>matricize <span class="free">I</span> <span class="main">(</span>tensor0 <span class="skolem">ds</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eq_imp_le vec_space.rank_0I <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">B</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tensor"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">j</span><span class="main">::</span><span class="quoted">nat</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"dims <span class="skolem">A</span> <span class="main">=</span> dims <span class="skolem">B</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"cprank_max1 <span class="skolem">A</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"mrank <span class="main">(</span>matricize <span class="free">I</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mrank <span class="main">(</span>matricize <span class="free">I</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹cprank_max1 <span class="skolem">A</span>›</span></span> matricize_cprank_max1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mrank <span class="main">(</span>matricize <span class="free">I</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">+</span> <span class="skolem">B</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> mrank <span class="main">(</span>matricize <span class="free">I</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">+</span> mrank <span class="main">(</span>matricize <span class="free">I</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> matricize_add vec_space.rank_subadditive dims_matricize
    carrier_matI index_add_mat<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹dims <span class="skolem">A</span> <span class="main">=</span> dims <span class="skolem">B</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mrank <span class="main">(</span>matricize <span class="free">I</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">+</span> <span class="skolem">B</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> Suc <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹mrank <span class="main">(</span>matricize <span class="free">I</span> <span class="skolem">A</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>›</span></span> <span class="quoted"><span class="quoted">‹mrank <span class="main">(</span>matricize <span class="free">I</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">j</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Rank_CP_Rank-matrix_rank_le_cp_rank"><span class="command">lemma</span></span> matrix_rank_le_cp_rank<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>field<span class="main">)</span> tensor"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mrank <span class="main">(</span>matricize <span class="free">I</span> <span class="free">A</span><span class="main">)</span> <span class="main">≤</span> cprank <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> matrix_rank_le_cprank_max <span class="keyword1"><span class="command">using</span></span> cprank_max_cprank <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="DL_Flatten_Matrix">
<div class="head">
<h1>Theory DL_Flatten_Matrix</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Alexander Bentkamp, Universität des Saarlandes
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Matrix to Vector Conversion›</span></span>

<span class="keyword1"><span class="command">theory</span></span> DL_Flatten_Matrix
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../Jordan_Normal_Form/Matrix.html">Jordan_Normal_Form.Matrix</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">extract_matrix</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> mat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">extract_matrix</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> mat <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="bound">i</span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">flatten_matrix</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mat <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">flatten_matrix</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">$$</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">div</span> dim_col <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">mod</span> dim_col <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="DL_Flatten_Matrix-two_digit_le"><span class="command">lemma</span></span> two_digit_le<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="free">j</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">*</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">i</span> <span class="free">j</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> less_imp_Suc_add <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1" id="DL_Flatten_Matrix-extract_matrix_cong"><span class="command">lemma</span></span> extract_matrix_cong<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">*</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">a</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">b</span> <span class="bound">i</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"extract_matrix <span class="free">a</span> <span class="free">m</span> <span class="free">n</span> <span class="main">=</span> extract_matrix <span class="free">b</span> <span class="free">m</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">(</span><span class="bound">i</span><span class="main">*</span><span class="free">n</span> <span class="main">+</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">b</span> <span class="main">(</span><span class="bound">i</span><span class="main">*</span><span class="free">n</span> <span class="main">+</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> two_digit_le assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> extract_matrix_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Flatten_Matrix-extract_matrix_flatten_matrix"><span class="command">lemma</span></span> extract_matrix_flatten_matrix<span class="main">:</span>
<span class="quoted"><span class="quoted">"extract_matrix <span class="main">(</span>flatten_matrix <span class="free">A</span><span class="main">)</span> <span class="main">(</span>dim_row <span class="free">A</span><span class="main">)</span> <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> extract_matrix_def flatten_matrix_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="DL_Flatten_Matrix-extract_matrix_flatten_matrix_cong"><span class="command">lemma</span></span> extract_matrix_flatten_matrix_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> dim_row <span class="free">A</span> <span class="main">*</span> dim_col <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> flatten_matrix <span class="free">A</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"extract_matrix <span class="free">f</span> <span class="main">(</span>dim_row <span class="free">A</span><span class="main">)</span> <span class="main">(</span>dim_col <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> extract_matrix_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms extract_matrix_cong extract_matrix_def extract_matrix_flatten_matrix<span class="main">)</span>

<span class="keyword1" id="DL_Flatten_Matrix-flatten_matrix_extract_matrix"><span class="command">lemma</span></span> flatten_matrix_extract_matrix<span class="main">:</span>
  <span class="quoted"><span class="quoted">"flatten_matrix <span class="main">(</span>extract_matrix <span class="free">a</span> <span class="free">m</span> <span class="free">n</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> <span class="free">a</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">*</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">*</span> <span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">*</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">with</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="keyword1">div</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> div_eq_0_iff div_mult2_eq mult.commute neq0_conv<span class="main">)</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="keyword1">mod</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extract_matrix_def flatten_matrix_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Flatten_Matrix-index_extract_matrix"><span class="command">lemma</span></span> index_extract_matrix<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">&lt;</span><span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"extract_matrix <span class="free">a</span> <span class="free">m</span> <span class="free">n</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="main">(</span><span class="free">i</span><span class="main">*</span><span class="free">n</span> <span class="main">+</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> extract_matrix_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="DL_Flatten_Matrix-dim_extract_matrix"><span class="command">lemma</span></span> dim_extract_matrix<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span>extract_matrix <span class="free">as</span> <span class="free">m</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span>extract_matrix <span class="free">as</span> <span class="free">m</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> extract_matrix_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="DL_Network">
<div class="head">
<h1>Theory DL_Network</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Alexander Bentkamp, Universität des Saarlandes
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Deep Learning Networks›</span></span>

<span class="keyword1"><span class="command">theory</span></span> DL_Network
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Tensor_Product.html">Tensor_Product</a>
  <a href="../Jordan_Normal_Form/Matrix.html">Jordan_Normal_Form.Matrix</a> <a href="Tensor_Unit_Vec.html">Tensor_Unit_Vec</a> <a href="DL_Flatten_Matrix.html">DL_Flatten_Matrix</a> 
  <a href="../Jordan_Normal_Form/DL_Missing_List.html">Jordan_Normal_Form.DL_Missing_List</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This symbol is used for the Tensor product:›</span></span>
<span class="keyword1"><span class="command">no_notation</span></span> Group.monoid.mult <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊗</span>ı"</span> 70<span class="main">)</span>

<span class="keyword1"><span class="command">notation</span></span> Matrix.unit_vec <span class="main">(</span><span class="quoted">"<span class="keyword1">unit<span class="hidden">⇩</span><sub>v</sub></span>"</span><span class="main">)</span>
<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> Matrix.unit_vec 


<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> convnet <span class="main">=</span> Input <span class="quoted">nat</span> <span class="main">|</span> Conv <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> convnet"</span></span> <span class="main">|</span> Pool <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> convnet"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> convnet"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">input_sizes</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> convnet <span class="main">⇒</span> nat list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">input_sizes</span> <span class="main">(</span>Input <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">]</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">input_sizes</span> <span class="main">(</span>Conv <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">input_sizes</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">input_sizes</span> <span class="main">(</span>Pool <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">input_sizes</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="main">@</span> <span class="free">input_sizes</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">count_weights</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> convnet <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">count_weights</span> <span class="free"><span class="bound"><span class="entity">shared</span></span></span> <span class="main">(</span>Input <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">count_weights</span> <span class="free"><span class="bound"><span class="entity">shared</span></span></span> <span class="main">(</span>Conv <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r0</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r0</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="main">+</span> <span class="free">count_weights</span> <span class="free"><span class="bound"><span class="entity">shared</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">count_weights</span> <span class="free"><span class="bound"><span class="entity">shared</span></span></span> <span class="main">(</span>Pool <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="main">=</span> 
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">shared</span></span></span> 
    <span class="keyword1">then</span> max <span class="main">(</span><span class="free">count_weights</span> <span class="free"><span class="bound"><span class="entity">shared</span></span></span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">count_weights</span> <span class="free"><span class="bound"><span class="entity">shared</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> 
    <span class="keyword1">else</span> <span class="free">count_weights</span> <span class="free"><span class="bound"><span class="entity">shared</span></span></span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="main">+</span> <span class="free">count_weights</span> <span class="free"><span class="bound"><span class="entity">shared</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">output_size</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> convnet <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">output_size</span> <span class="main">(</span>Input <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">output_size</span> <span class="main">(</span>Conv <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r0</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r0</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">output_size</span> <span class="main">(</span>Pool <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">output_size</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">valid_net</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat<span class="main">×</span>nat<span class="main">)</span> convnet <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">valid_net</span> <span class="main">(</span>Input <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"output_size <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span> <span class="main">⟹</span> <span class="free">valid_net</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">⟹</span> <span class="free">valid_net</span> <span class="main">(</span>Conv <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r0</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"output_size <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="main">=</span> output_size <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">⟹</span> <span class="free">valid_net</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="main">⟹</span> <span class="free">valid_net</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">⟹</span> <span class="free">valid_net</span> <span class="main">(</span>Pool <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">insert_weights</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> convnet <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> real mat convnet"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">insert_weights</span> <span class="free"><span class="bound"><span class="entity">shared</span></span></span> <span class="main">(</span>Input <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> Input <span class="free"><span class="bound"><span class="entity">M</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">insert_weights</span> <span class="free"><span class="bound"><span class="entity">shared</span></span></span> <span class="main">(</span>Conv <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r0</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> Conv
  <span class="main">(</span>extract_matrix <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">r0</span></span></span> <span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span>
  <span class="main">(</span><span class="free">insert_weights</span> <span class="free"><span class="bound"><span class="entity">shared</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">r0</span></span></span><span class="main">*</span><span class="free"><span class="bound"><span class="entity">r1</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">insert_weights</span> <span class="free"><span class="bound"><span class="entity">shared</span></span></span> <span class="main">(</span>Pool <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> Pool
  <span class="main">(</span><span class="free">insert_weights</span> <span class="free"><span class="bound"><span class="entity">shared</span></span></span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span>
  <span class="main">(</span><span class="free">insert_weights</span> <span class="free"><span class="bound"><span class="entity">shared</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">shared</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="main">(</span>count_weights <span class="free"><span class="bound"><span class="entity">shared</span></span></span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">remove_weights</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real mat convnet <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> convnet"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">remove_weights</span> <span class="main">(</span>Input <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> Input <span class="free"><span class="bound"><span class="entity">M</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">remove_weights</span> <span class="main">(</span>Conv <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> Conv <span class="main">(</span>dim_row <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> dim_col <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">remove_weights</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">remove_weights</span> <span class="main">(</span>Pool <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="main">=</span> Pool <span class="main">(</span><span class="free">remove_weights</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">remove_weights</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">output_size'</span> <span class="main">==</span> <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> output_size <span class="main">(</span>remove_weights <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">valid_net'</span> <span class="main">==</span> <span class="main">(</span><span class="main">λ</span><span class="bound">m</span><span class="main">.</span> valid_net <span class="main">(</span>remove_weights <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">evaluate_net</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real mat convnet <span class="main">⇒</span> real vec list <span class="main">⇒</span> real vec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">evaluate_net</span> <span class="main">(</span>Input <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">inputs</span></span></span> <span class="main">=</span> hd <span class="free"><span class="bound"><span class="entity">inputs</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">evaluate_net</span> <span class="main">(</span>Conv <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">inputs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">evaluate_net</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">inputs</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">evaluate_net</span> <span class="main">(</span>Pool <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">inputs</span></span></span> <span class="main">=</span> component_mult
  <span class="main">(</span><span class="free">evaluate_net</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="main">(</span>take <span class="main">(</span>length <span class="main">(</span>input_sizes <span class="free"><span class="bound"><span class="entity">m1</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">inputs</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span><span class="free">evaluate_net</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">(</span>drop <span class="main">(</span>length <span class="main">(</span>input_sizes <span class="free"><span class="bound"><span class="entity">m1</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">inputs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mat_tensorlist_mult</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real mat <span class="main">⇒</span> real tensor vec <span class="main">⇒</span> nat list <span class="main">⇒</span> real tensor vec"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">mat_tensorlist_mult</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span> <span class="free"><span class="bound"><span class="entity">ds</span></span></span>
 <span class="main">=</span> Matrix.vec <span class="main">(</span>dim_row <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> tensor_from_lookup <span class="free"><span class="bound"><span class="entity">ds</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">is</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>map_vec <span class="main">(</span><span class="main">λ</span><span class="bound">T</span><span class="main">.</span> Tensor.lookup <span class="bound">T</span> <span class="bound">is</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Ts</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">$</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="DL_Network-insert_weights_cong"><span class="command">lemma</span></span> insert_weights_cong<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span>count_weights <span class="free">s</span> <span class="free">m</span> <span class="main">⟹</span> <span class="free">w1</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">w2</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"insert_weights <span class="free">s</span> <span class="free">m</span> <span class="free">w1</span> <span class="main">=</span> insert_weights <span class="free">s</span> <span class="free">m</span> <span class="free">w2</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w1</span></span> <span class="quoted"><span class="free">w2</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Input
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Conv <span class="skolem">r01</span> <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r0</span></span> <span class="skolem"><span class="skolem">r1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r01</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">r0</span><span class="main">,</span><span class="skolem">r1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> surj_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"insert_weights <span class="free">s</span> <span class="skolem">m</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">w1</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">r0</span> <span class="main">*</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> insert_weights <span class="free">s</span> <span class="skolem">m</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">w2</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">r0</span> <span class="main">*</span> <span class="skolem">r1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Conv
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r01</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">r0</span><span class="main">,</span> <span class="skolem">r1</span><span class="main">)</span>›</span></span> add.commute add_less_cancel_right count_weights.simps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r01</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">r0</span><span class="main">,</span><span class="skolem">r1</span><span class="main">)</span>›</span></span> insert_weights.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Conv.prems <span class="quoted"><span class="quoted">‹<span class="skolem">r01</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">r0</span><span class="main">,</span> <span class="skolem">r1</span><span class="main">)</span>›</span></span> count_weights.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> extract_matrix_cong trans_less_add1<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pool <span class="skolem">m1</span> <span class="skolem">m2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"insert_weights <span class="free">s</span> <span class="skolem">m1</span> <span class="skolem">w1</span> <span class="main">=</span> insert_weights <span class="free">s</span> <span class="skolem">m1</span> <span class="skolem">w2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Pool<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">w1</span></span> <span class="quoted"><span class="skolem">w2</span></span><span class="main">]</span> Pool<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> count_weights.simps<span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">s</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> shared<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">=</span>True <span class="main">⟹</span> insert_weights <span class="free">s</span> <span class="skolem">m2</span> <span class="skolem">w1</span> <span class="main">=</span> insert_weights <span class="free">s</span> <span class="skolem">m2</span> <span class="skolem">w2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Pool<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">w1</span></span> <span class="quoted"><span class="skolem">w2</span></span><span class="main">]</span> Pool<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> count_weights.simps<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> unshared<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">=</span>False <span class="main">⟹</span> insert_weights <span class="free">s</span> <span class="skolem">m2</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">w1</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> count_weights <span class="free">s</span> <span class="skolem">m1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> insert_weights <span class="free">s</span> <span class="skolem">m2</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">w2</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> count_weights <span class="free">s</span> <span class="skolem">m1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Pool<span class="main">(</span>2<span class="main">)</span> Pool<span class="main">(</span>3<span class="main">)</span> count_weights.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> insert_weights.simps 1 <span class="keyword1"><span class="command">using</span></span> unshared shared <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Network-dims_mat_tensorlist_mult"><span class="command">lemma</span></span> dims_mat_tensorlist_mult<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span><span class="main">∈</span><span class="keyword1">set<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>mat_tensorlist_mult <span class="free">A</span> <span class="free">Ts</span> <span class="free">ds</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Tensor.dims <span class="free">T</span> <span class="main">=</span> <span class="free">ds</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">=</span> tensor_from_lookup <span class="free">ds</span> <span class="main">(</span><span class="main">λ</span><span class="bound">is</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>map_vec <span class="main">(</span><span class="main">λ</span><span class="bound">T</span><span class="main">.</span> Tensor.lookup <span class="bound">T</span> <span class="bound">is</span><span class="main">)</span> <span class="free">Ts</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span><span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> vec_setE<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">unfolded</span> mat_tensorlist_mult_def<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dim_vec index_vec<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_tensor_vec_from_lookup tensor_from_lookup_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">tensors_from_net</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real mat convnet <span class="main">⇒</span> real tensor vec"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">tensors_from_net</span> <span class="main">(</span>Input <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> Matrix.vec <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> unit_vec <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">tensors_from_net</span> <span class="main">(</span>Conv <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> mat_tensorlist_mult <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span><span class="free">tensors_from_net</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">(</span>input_sizes <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">tensors_from_net</span> <span class="main">(</span>Pool <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="main">=</span> component_mult <span class="main">(</span><span class="free">tensors_from_net</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">tensors_from_net</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="DL_Network-output_size_correct_tensors"><span class="command">lemma</span></span> output_size_correct_tensors<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_net' <span class="free">m</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"output_size' <span class="free">m</span> <span class="main">=</span> dim_vec <span class="main">(</span>tensors_from_net <span class="free">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Input
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Conv <span class="skolem">A</span> <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> remove_weights.simps output_size.simps tensors_from_net.simps
    <span class="keyword1"><span class="command">using</span></span> mat_tensorlist_mult_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pool <span class="skolem">m1</span> <span class="skolem">m2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> convnet.distinct<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> convnet.distinct<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> convnet.inject<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> dim_component_mult
    min.idem output_size.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> remove_weights.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> tensors_from_net.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> valid_net.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="DL_Network-output_size_correct"><span class="command">lemma</span></span> output_size_correct<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_net' <span class="free">m</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"map dim_vec <span class="free">inputs</span> <span class="main">=</span> input_sizes <span class="free">m</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"output_size' <span class="free">m</span> <span class="main">=</span> dim_vec <span class="main">(</span>evaluate_net <span class="free">m</span> <span class="free">inputs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">inputs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Input
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> length_Cons list.map_sel<span class="main">(</span>1<span class="main">)</span> list.sel<span class="main">(</span>1<span class="main">)</span> list.simps<span class="main">(</span>8<span class="main">)</span> list.size<span class="main">(</span>3<span class="main">)</span> nat.simps<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Conv <span class="skolem">A</span> <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> evaluate_net.simps remove_weights.simps output_size.simps dim_mult_mat_vec
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pool <span class="skolem">m1</span> <span class="skolem">m2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_net' <span class="skolem">m1</span>"</span></span> <span class="quoted"><span class="quoted">"valid_net' <span class="skolem">m2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> convnet.distinct<span class="main">(</span>3<span class="main">)</span> convnet.distinct<span class="main">(</span>5<span class="main">)</span> convnet.inject<span class="main">(</span>3<span class="main">)</span> remove_weights.simps<span class="main">(</span>3<span class="main">)</span> valid_net.cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map dim_vec <span class="main">(</span>take <span class="main">(</span>length <span class="main">(</span>input_sizes <span class="skolem">m1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">inputs</span><span class="main">)</span> <span class="main">=</span> input_sizes <span class="skolem">m1</span>"</span></span>
       <span class="quoted"><span class="quoted">"map dim_vec <span class="main">(</span>drop <span class="main">(</span>length <span class="main">(</span>input_sizes <span class="skolem">m1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">inputs</span><span class="main">)</span> <span class="main">=</span> input_sizes <span class="skolem">m2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Pool.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_eq_conv_conj drop_map input_sizes.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> take_map<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"output_size' <span class="skolem">m1</span> <span class="main">=</span> dim_vec <span class="main">(</span>evaluate_net <span class="skolem">m1</span> <span class="main">(</span>take <span class="main">(</span>length <span class="main">(</span>input_sizes <span class="skolem">m1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">inputs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"output_size' <span class="skolem">m2</span> <span class="main">=</span> dim_vec <span class="main">(</span>evaluate_net <span class="skolem">m2</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="main">(</span>input_sizes <span class="skolem">m1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">inputs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Pool.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> evaluate_net.simps remove_weights.simps output_size.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pool.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹valid_net' <span class="skolem">m1</span>›</span></span> <span class="quoted"><span class="quoted">‹valid_net' <span class="skolem">m2</span>›</span></span> dim_component_mult
     output_size.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> output_size_correct_tensors remove_weights.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> tensors_from_net.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Network-input_sizes_remove_weights"><span class="command">lemma</span></span> input_sizes_remove_weights<span class="main">:</span> <span class="quoted"><span class="quoted">"input_sizes <span class="free">m</span> <span class="main">=</span> input_sizes <span class="main">(</span>remove_weights <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="DL_Network-dims_tensors_from_net"><span class="command">lemma</span></span> dims_tensors_from_net<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">∈</span> <span class="keyword1">set<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>tensors_from_net <span class="free">m</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Tensor.dims <span class="free">T</span> <span class="main">=</span> input_sizes <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">T</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Input <span class="skolem">M</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">=</span> unit_vec <span class="skolem">M</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> vec_setE tensors_from_net.simps<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dim_vec index_vec<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dims_unit_vec<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Conv <span class="skolem">A</span> <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> remove_weights.simps input_sizes.simps
    <span class="keyword1"><span class="command">using</span></span> dims_mat_tensorlist_mult <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> input_sizes_remove_weights<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pool <span class="skolem">m1</span> <span class="skolem">m2</span> <span class="skolem">T</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"component_mult <span class="main">(</span>tensors_from_net <span class="skolem">m1</span><span class="main">)</span> <span class="main">(</span>tensors_from_net <span class="skolem">m2</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">T</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> dim_vec <span class="main">(</span>tensors_from_net <span class="skolem">m1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> dim_vec <span class="main">(</span>tensors_from_net <span class="skolem">m2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tensors_from_net.simps vec_setE dim_component_mult <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> min.strict_boundedE<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T1</span></span> <span class="skolem"><span class="skolem">T2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">=</span> <span class="skolem">T1</span> <span class="main">⊗</span> <span class="skolem">T2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T1</span> <span class="main">∈</span> <span class="keyword1">set<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>tensors_from_net <span class="skolem">m1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T2</span> <span class="main">∈</span> <span class="keyword1">set<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>tensors_from_net <span class="skolem">m2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> vec_setI <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> index_component_mult<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> remove_weights.simps input_sizes.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Pool.IH<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Pool.IH<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">base_input</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real mat convnet <span class="main">⇒</span> nat list <span class="main">⇒</span> real vec list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">base_input</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">is</span></span></span> <span class="main">=</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">unit<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">n</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span>input_sizes <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">is</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="DL_Network-base_input_length"><span class="command">lemma</span></span> base_input_length<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">⊲</span> input_sizes <span class="free">m</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"input_sizes <span class="free">m</span> <span class="main">=</span> map dim_vec <span class="main">(</span>base_input <span class="free">m</span> <span class="free">is</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> nth_equalityI<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>input_sizes <span class="free">m</span><span class="main">)</span> <span class="main">=</span> length <span class="free">is</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms valid_index_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>input_sizes <span class="free">m</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>map dim_vec <span class="main">(</span>base_input <span class="free">m</span> <span class="free">is</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> base_input_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span>length <span class="main">(</span>input_sizes <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">unit<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">n</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span>input_sizes <span class="free">m</span><span class="main">)</span> <span class="free">is</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="keyword1">unit<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>input_sizes <span class="free">m</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span><span class="free">is</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹length <span class="main">(</span>input_sizes <span class="free">m</span><span class="main">)</span> <span class="main">=</span> length <span class="free">is</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"input_sizes <span class="free">m</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> map dim_vec <span class="main">(</span>base_input <span class="free">m</span> <span class="free">is</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> base_input_def <span class="keyword1"><span class="command">using</span></span> index_unit_vec<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>input_sizes <span class="free">m</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="main">(</span>input_sizes <span class="free">m</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>map dim_vec <span class="main">(</span>base_input <span class="free">m</span> <span class="free">is</span><span class="main">)</span><span class="main">)</span>›</span></span>
       base_input_def assms length_map nth_map valid_index_lt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> input_sizes_remove_weights<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="main">(</span>input_sizes <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span> input_sizes <span class="free">m</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> map dim_vec <span class="main">(</span>base_input <span class="free">m</span> <span class="free">is</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Network-nth_mat_tensorlist_mult"><span class="command">lemma</span></span> nth_mat_tensorlist_mult<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span><span class="main">∈</span><span class="keyword1">set<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">Ts</span> <span class="main">⟹</span> dims <span class="bound">A</span> <span class="main">=</span> <span class="free">ds</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> dim_row <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="free">Ts</span> <span class="main">=</span> dim_col <span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mat_tensorlist_mult <span class="free">A</span> <span class="free">Ts</span> <span class="free">ds</span> <span class="main">$</span> <span class="free">i</span> <span class="main">=</span> listsum <span class="free">ds</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">Ts</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>dim_vec <span class="free">Ts</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> listsum <span class="free">ds</span> <span class="var">?Ts'</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> tensor_lookup_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> dims_Ts'<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">T</span><span class="main">.</span> <span class="bound">T</span><span class="main">∈</span>set <span class="var">?Ts'</span> <span class="main">⟹</span> dims <span class="bound">T</span> <span class="main">=</span> <span class="free">ds</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">T</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span><span class="main">∈</span>set <span class="var">?Ts'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">=</span> <span class="var">?Ts'</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="var">?Ts'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> dim_vec <span class="free">Ts</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> in_set_conv_nth <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dims <span class="skolem">T</span> <span class="main">=</span> <span class="free">ds</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">T</span> <span class="main">=</span> <span class="var">?Ts'</span> <span class="main">!</span> <span class="skolem">k</span>›</span></span>   nth_map<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="var">?Ts'</span>›</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> length_map<span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> dim_vec <span class="free">Ts</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">Ts</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>dim_vec <span class="free">Ts</span><span class="main">]</span><span class="main">)</span>›</span></span> vec_setI<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> dims_eq<span class="main">:</span><span class="quoted"><span class="quoted">"dims <span class="main">(</span>mat_tensorlist_mult <span class="free">A</span> <span class="free">Ts</span> <span class="free">ds</span> <span class="main">$</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> dims <span class="main">(</span>Tensor_Plus.listsum <span class="free">ds</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">Ts</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>dim_vec <span class="free">Ts</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dims_mat_tensorlist_mult assms  mat_tensorlist_mult_def listsum_dims
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> dim_vec vec_setI<span class="main">)</span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="quoted">"<span class="skolem">is</span>"</span> <span class="keyword3"><span class="command">assume</span></span> is_valid<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> dims <span class="main">(</span>mat_tensorlist_mult <span class="free">A</span> <span class="free">Ts</span> <span class="free">ds</span> <span class="main">$</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> <span class="free">ds</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dims_eq dims_Ts' listsum_dims <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> summand_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> dim_vec <span class="free">Ts</span><span class="main">}</span> <span class="main">⟹</span> row <span class="free">A</span> <span class="free">i</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">*</span> <span class="main">(</span>map_vec <span class="main">(</span><span class="main">λ</span><span class="bound">T</span><span class="main">.</span> Tensor.lookup <span class="bound">T</span> <span class="skolem">is</span><span class="main">)</span> <span class="free">Ts</span><span class="main">)</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">=</span> lookup <span class="main">(</span><span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">Ts</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span> <span class="skolem">is</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> index_vec <span class="quoted"><span class="quoted">‹<span class="free">i</span><span class="main">&lt;</span>dim_row <span class="free">A</span>›</span></span> row_def <span class="quoted"><span class="quoted">‹dim_vec <span class="free">Ts</span> <span class="main">=</span> dim_col <span class="free">A</span>›</span></span>
     <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">⊲</span> <span class="free">ds</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> lookup_smult atLeastLessThan_iff index_map_vec<span class="main">(</span>1<span class="main">)</span> vec_setI <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span>mat_tensorlist_mult <span class="free">A</span> <span class="free">Ts</span> <span class="free">ds</span> <span class="main">$</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">is</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>map_vec <span class="main">(</span><span class="main">λ</span><span class="bound">T</span><span class="main">.</span> Tensor.lookup <span class="bound">T</span> <span class="skolem">is</span><span class="main">)</span> <span class="free">Ts</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mat_tensorlist_mult_def <span class="keyword1"><span class="command">using</span></span> lookup_tensor_from_lookup<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">⊲</span> <span class="free">ds</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span><span class="main">&lt;</span>dim_row <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> row <span class="free">A</span> <span class="free">i</span> <span class="main">∙</span> map_vec <span class="main">(</span><span class="main">λ</span><span class="bound">T</span><span class="main">.</span> Tensor.lookup <span class="bound">T</span> <span class="skolem">is</span><span class="main">)</span> <span class="free">Ts</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span><span class="main">&lt;</span>dim_row <span class="free">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span> <span class="bound">j</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span> <span class="main">..&lt;</span> dim_vec <span class="free">Ts</span><span class="main">}</span><span class="main">.</span> row <span class="free">A</span> <span class="free">i</span> <span class="main">$</span> <span class="bound">j</span> <span class="main">*</span> <span class="main">(</span>map_vec <span class="main">(</span><span class="main">λ</span><span class="bound">T</span><span class="main">.</span> Tensor.lookup <span class="bound">T</span> <span class="skolem">is</span><span class="main">)</span> <span class="free">Ts</span><span class="main">)</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> scalar_prod_def nth_rows<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span><span class="main">&lt;</span>dim_row <span class="free">A</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>dim_vec <span class="free">Ts</span><span class="main">}</span><span class="main">.</span> lookup <span class="main">(</span><span class="free">A</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">Ts</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span> <span class="skolem">is</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> summand_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">A</span><span class="main">←</span><span class="var">?Ts'</span><span class="main">.</span> lookup <span class="bound">A</span> <span class="skolem">is</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> map_map
    Groups_List.sum_set_upt_conv_sum_list_nat<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>  atLeastLessThan_upt<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> lookup <span class="main">(</span>listsum <span class="free">ds</span> <span class="var">?Ts'</span><span class="main">)</span> <span class="skolem">is</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lookup_listsum<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">⊲</span> <span class="free">ds</span>›</span></span><span class="main">]</span> dims_Ts' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span>mat_tensorlist_mult <span class="free">A</span> <span class="free">Ts</span> <span class="free">ds</span> <span class="main">$</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">is</span> <span class="main">=</span> lookup <span class="main">(</span>listsum <span class="free">ds</span> <span class="var">?Ts'</span><span class="main">)</span> <span class="skolem">is</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Network-lookup_tensors_from_net"><span class="command">lemma</span></span> lookup_tensors_from_net<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_net' <span class="free">m</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">⊲</span> input_sizes <span class="free">m</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> output_size' <span class="free">m</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Tensor.lookup <span class="main">(</span>tensors_from_net <span class="free">m</span> <span class="main">$</span> <span class="free">j</span><span class="main">)</span> <span class="free">is</span> <span class="main">=</span> evaluate_net <span class="free">m</span> <span class="main">(</span>base_input <span class="free">m</span> <span class="free">is</span><span class="main">)</span> <span class="main">$</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Input <span class="skolem">M</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> output_size.simps<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> Input <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"tensors_from_net <span class="main">(</span>Input <span class="skolem">M</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">=</span> unit_vec <span class="skolem">M</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span><span class="skolem">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Input Suc_length_conv input_sizes.simps<span class="main">(</span>1<span class="main">)</span> length_0_conv list.size<span class="main">(</span>3<span class="main">)</span> valid_index_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"Tensor.lookup <span class="main">(</span>tensors_from_net <span class="main">(</span>Input <span class="skolem">M</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">is</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">i</span><span class="main">=</span><span class="skolem">j</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lookup_unit_vec 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"evaluate_net <span class="main">(</span>Input <span class="skolem">M</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">unit<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">n</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span>input_sizes <span class="main">(</span>Input <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">is</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">unit<span class="hidden">⇩</span><sub>v</sub></span> <span class="skolem">M</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">i</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">M</span>›</span></span> base_input_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">M</span>›</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Conv <span class="skolem">A</span> <span class="skolem">m</span> <span class="skolem">j</span> <span class="quoted">"<span class="skolem">is</span>"</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> is_valid<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> input_sizes <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Conv.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> valid_net<span class="main">:</span><span class="quoted"><span class="quoted">"valid_net' <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Conv.prems<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> remove_weights.simps
    <span class="keyword1"><span class="command">using</span></span> valid_net.simps convnet.distinct<span class="main">(</span>1<span class="main">)</span> convnet.distinct<span class="main">(</span>5<span class="main">)</span> convnet.inject<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> length_em<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>evaluate_net <span class="skolem">m</span> <span class="main">(</span>base_input <span class="skolem">m</span> <span class="skolem">is</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> output_size' <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> output_size_correct base_input_length is_valid <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1"><span class="command">have</span></span> IH'<span class="main">:</span><span class="quoted"><span class="quoted">"map_vec <span class="main">(</span><span class="main">λ</span><span class="bound">T</span><span class="main">.</span> Tensor.lookup <span class="bound">T</span> <span class="skolem">is</span><span class="main">)</span> <span class="main">(</span>tensors_from_net <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span>
                evaluate_net <span class="skolem">m</span> <span class="main">(</span>base_input <span class="skolem">m</span> <span class="skolem">is</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> eq_vecI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> equal_lengths<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>map_vec <span class="main">(</span><span class="main">λ</span><span class="bound">T</span><span class="main">.</span> lookup <span class="bound">T</span> <span class="skolem">is</span><span class="main">)</span> <span class="main">(</span>tensors_from_net <span class="skolem">m</span><span class="main">)</span><span class="main">)</span>
      <span class="main">=</span> dim_vec <span class="main">(</span>evaluate_net <span class="skolem">m</span> <span class="main">(</span>base_input <span class="skolem">m</span> <span class="skolem">is</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> length_em
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> output_size_correct_tensors valid_net<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> dim_vec <span class="main">(</span>evaluate_net <span class="skolem">m</span> <span class="main">(</span>base_input <span class="skolem">m</span> <span class="skolem">is</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
         map_vec <span class="main">(</span><span class="main">λ</span><span class="bound">T</span><span class="main">.</span> lookup <span class="bound">T</span> <span class="skolem">is</span><span class="main">)</span> <span class="main">(</span>tensors_from_net <span class="skolem">m</span><span class="main">)</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">=</span> evaluate_net <span class="skolem">m</span> <span class="main">(</span>base_input <span class="skolem">m</span> <span class="skolem">is</span><span class="main">)</span> <span class="main">$</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> dim_vec <span class="main">(</span>evaluate_net <span class="skolem">m</span> <span class="main">(</span>base_input <span class="skolem">m</span> <span class="skolem">is</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> output_size' <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> equal_lengths length_em <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"map_vec <span class="main">(</span><span class="main">λ</span><span class="bound">T</span><span class="main">.</span> lookup <span class="bound">T</span> <span class="skolem">is</span><span class="main">)</span> <span class="main">(</span>tensors_from_net <span class="skolem">m</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span>
        <span class="main">=</span> evaluate_net <span class="skolem">m</span> <span class="main">(</span>base_input <span class="skolem">m</span> <span class="skolem">is</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Conv.IH is_valid equal_lengths valid_net base_input_def length_em nth_map_upt
        length_map nth_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Tensor.lookup <span class="main">(</span><span class="main">(</span>tensors_from_net <span class="main">(</span>Conv <span class="skolem">A</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">is</span> <span class="main">=</span>
    <span class="main">(</span><span class="skolem">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>map_vec <span class="main">(</span><span class="main">λ</span><span class="bound">T</span><span class="main">.</span> Tensor.lookup <span class="bound">T</span> <span class="skolem">is</span><span class="main">)</span> <span class="main">(</span>tensors_from_net <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">j</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>tensors_from_net <span class="main">(</span>Conv <span class="skolem">A</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> output_size' <span class="main">(</span>Conv <span class="skolem">A</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Conv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mat_tensorlist_mult_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">&lt;</span>dim_vec <span class="main">(</span>tensors_from_net <span class="main">(</span>Conv <span class="skolem">A</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Conv.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>tensors_from_net <span class="main">(</span>Conv <span class="skolem">A</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">=</span>  tensor_from_lookup <span class="main">(</span>input_sizes <span class="skolem">m</span><span class="main">)</span>
                <span class="main">(</span><span class="main">λ</span><span class="bound">is</span><span class="main">.</span> <span class="main">(</span><span class="skolem">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>map_vec <span class="main">(</span><span class="main">λ</span><span class="bound">T</span><span class="main">.</span> Tensor.lookup <span class="bound">T</span> <span class="bound">is</span><span class="main">)</span> <span class="main">(</span>tensors_from_net <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> tensors_from_net.simps mat_tensorlist_mult_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> lookup_tensor_from_lookup<span class="main">[</span><span class="operator">OF</span> is_valid<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>map_vec <span class="main">(</span><span class="main">λ</span><span class="bound">T</span><span class="main">.</span> Tensor.lookup <span class="bound">T</span> <span class="skolem">is</span><span class="main">)</span> <span class="main">(</span>tensors_from_net <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">j</span>
    <span class="main">=</span> <span class="main">(</span><span class="skolem">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>evaluate_net <span class="skolem">m</span> <span class="main">(</span>base_input <span class="skolem">m</span> <span class="skolem">is</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IH' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> evaluate_net <span class="main">(</span>Conv <span class="skolem">A</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">(</span>base_input <span class="main">(</span>Conv <span class="skolem">A</span> <span class="skolem">m</span><span class="main">)</span> <span class="skolem">is</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> base_input_def <span class="keyword1"><span class="command">using</span></span> evaluate_net.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pool <span class="skolem">m1</span> <span class="skolem">m2</span> <span class="skolem">j</span> <span class="quoted">"<span class="skolem">is</span>"</span><span class="main">)</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We split "is" into two parts for each subnet:›</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">is1</span></span> <span class="skolem"><span class="skolem">is2</span></span> <span class="keyword2"><span class="keyword">where</span></span> is12_def<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">=</span> <span class="skolem">is1</span> <span class="main">@</span> <span class="skolem">is2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is1</span> <span class="main">⊲</span> input_sizes <span class="skolem">m1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is2</span> <span class="main">⊲</span> input_sizes <span class="skolem">m2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pool.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> input_sizes.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> valid_index_split<span class="main">)</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Apply the induction hypothesis to the subnets:›</span></span>
  <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span><span class="quoted"><span class="quoted">"Tensor.lookup <span class="main">(</span>tensors_from_net <span class="skolem">m1</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">is1</span>
      <span class="main">=</span> evaluate_net <span class="skolem">m1</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">unit<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span>input_sizes <span class="skolem">m1</span><span class="main">)</span> <span class="skolem">is1</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">j</span>"</span></span>
      <span class="quoted"><span class="quoted">"Tensor.lookup <span class="main">(</span>tensors_from_net <span class="skolem">m2</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">is2</span>
      <span class="main">=</span> evaluate_net <span class="skolem">m2</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">unit<span class="hidden">⇩</span><sub>v</sub></span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span>zip <span class="main">(</span>input_sizes <span class="skolem">m2</span><span class="main">)</span> <span class="skolem">is2</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Pool convnet.distinct<span class="main">(</span>3<span class="main">)</span> convnet.distinct<span class="main">(</span>5<span class="main">)</span> convnet.inject<span class="main">(</span>3<span class="main">)</span> remove_weights.simps<span class="main">(</span>3<span class="main">)</span>
    valid_net.simps  <span class="quoted"><span class="quoted">‹<span class="skolem">is1</span> <span class="main">⊲</span> input_sizes <span class="skolem">m1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is2</span> <span class="main">⊲</span> input_sizes <span class="skolem">m2</span>›</span></span> output_size.simps<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> base_input_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In the Pool layer tensor entries get multiplied:›</span></span>
  <span class="keyword1"><span class="command">have</span></span> lookup_prod<span class="main">:</span> <span class="quoted"><span class="quoted">"Tensor.lookup <span class="main">(</span>tensors_from_net <span class="main">(</span>Pool <span class="skolem">m1</span> <span class="skolem">m2</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">is</span>
    <span class="main">=</span> Tensor.lookup <span class="main">(</span>tensors_from_net <span class="skolem">m1</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">is1</span> <span class="main">*</span> Tensor.lookup <span class="main">(</span>tensors_from_net <span class="skolem">m2</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">is2</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> j_small<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> dim_vec <span class="main">(</span>tensors_from_net <span class="skolem">m1</span><span class="main">)</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> dim_vec <span class="main">(</span>tensors_from_net <span class="skolem">m2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pool.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Pool.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> convnet.distinct<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> convnet.inject<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> convnet.simps<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span>
      output_size.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> output_size_correct_tensors remove_weights.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> valid_net.cases<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span><span class="quoted"><span class="quoted">"tensors_from_net <span class="main">(</span>Pool <span class="skolem">m1</span> <span class="skolem">m2</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">=</span> tensors_from_net <span class="skolem">m1</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">⊗</span> tensors_from_net <span class="skolem">m2</span> <span class="main">$</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> tensors_from_net.simps <span class="keyword1"><span class="command">using</span></span> j_small index_component_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Tensor.dims <span class="main">(</span>tensors_from_net <span class="skolem">m1</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> input_sizes <span class="skolem">m1</span>"</span></span>
         <span class="quoted"><span class="quoted">"Tensor.dims <span class="main">(</span>tensors_from_net <span class="skolem">m2</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> input_sizes <span class="skolem">m2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> dims_tensors_from_net j_small nth_mem <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vec_setI<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> is12_valid<span class="main">:</span>
              <span class="quoted"><span class="quoted">"<span class="skolem">is1</span> <span class="main">⊲</span> Tensor.dims <span class="main">(</span>tensors_from_net <span class="skolem">m1</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
              <span class="quoted"><span class="quoted">"<span class="skolem">is2</span> <span class="main">⊲</span> Tensor.dims <span class="main">(</span>tensors_from_net <span class="skolem">m2</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> is12_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> 0 <span class="keyword1"><span class="command">using</span></span> lookup_tensor_prod<span class="main">[</span><span class="operator">OF</span> is12_valid<span class="main">]</span> is12_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Output values get multiplied in the Pool layer as well:›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"evaluate_net <span class="main">(</span>Pool <span class="skolem">m1</span> <span class="skolem">m2</span><span class="main">)</span> <span class="main">(</span>base_input <span class="main">(</span>Pool <span class="skolem">m1</span> <span class="skolem">m2</span><span class="main">)</span> <span class="skolem">is</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">j</span>
    <span class="main">=</span> evaluate_net <span class="skolem">m1</span> <span class="main">(</span>base_input <span class="skolem">m1</span> <span class="skolem">is1</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">*</span> evaluate_net <span class="skolem">m2</span> <span class="main">(</span>base_input <span class="skolem">m2</span> <span class="skolem">is2</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">j</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_net' <span class="skolem">m1</span>"</span></span> <span class="quoted"><span class="quoted">"valid_net' <span class="skolem">m2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> remove_weights.simps  valid_net.simps Pool.prems
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> convnet.distinct<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> convnet.distinct<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> convnet.inject<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"input_sizes <span class="skolem">m1</span> <span class="main">=</span> map dim_vec <span class="main">(</span>base_input <span class="skolem">m1</span> <span class="skolem">is1</span><span class="main">)</span>"</span></span>
         <span class="quoted"><span class="quoted">"input_sizes <span class="skolem">m2</span> <span class="main">=</span> map dim_vec <span class="main">(</span>base_input <span class="skolem">m2</span> <span class="skolem">is2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> base_input_def base_input_length base_input_def is12_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> dim_vec <span class="main">(</span>evaluate_net <span class="skolem">m1</span> <span class="main">(</span>base_input <span class="skolem">m1</span> <span class="skolem">is1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> dim_vec <span class="main">(</span>evaluate_net <span class="skolem">m2</span> <span class="main">(</span>base_input <span class="skolem">m2</span> <span class="skolem">is2</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Pool.prems <span class="quoted"><span class="quoted">‹input_sizes <span class="skolem">m1</span> <span class="main">=</span> map dim_vec <span class="main">(</span>base_input <span class="skolem">m1</span> <span class="skolem">is1</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹valid_net' <span class="skolem">m1</span>›</span></span>
      output_size_correct <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span><span class="operator">metis</span> Pool.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Pool.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹input_sizes <span class="skolem">m2</span> <span class="main">=</span> map dim_vec <span class="main">(</span>base_input <span class="skolem">m2</span> <span class="skolem">is2</span><span class="main">)</span>›</span></span>
      convnet.distinct<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> convnet.distinct<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> convnet.inject<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> output_size.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> output_size_correct
      remove_weights.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> valid_net.cases<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> evaluate_net.simps <span class="keyword1"><span class="command">unfolding</span></span> base_input_def
      <span class="keyword1"><span class="command">using</span></span> is12_def<span class="main">(</span>1<span class="main">)</span> is12_def<span class="main">(</span>2<span class="main">)</span> valid_index_length <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> append_eq_conv_conj drop_map
      drop_zip index_component_mult input_sizes_remove_weights take_map take_zip<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> lookup_prod IH base_input_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">extract_weights</span><span class="main">::</span><span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> real mat convnet <span class="main">⇒</span> nat <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  extract_weights_Input<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">extract_weights</span> <span class="free"><span class="bound"><span class="entity">shared</span></span></span> <span class="main">(</span>Input <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="main">|</span> extract_weights_Conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">extract_weights</span> <span class="free"><span class="bound"><span class="entity">shared</span></span></span> <span class="main">(</span>Conv <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">&lt;</span> dim_row <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">*</span> dim_col <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">then</span> flatten_matrix <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">x</span> 
         <span class="keyword1">else</span> <span class="free">extract_weights</span> <span class="free"><span class="bound"><span class="entity">shared</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> dim_row <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">*</span> dim_col <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> extract_weights_Pool<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">extract_weights</span> <span class="free"><span class="bound"><span class="entity">shared</span></span></span> <span class="main">(</span>Pool <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="main">=</span> 
    <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">&lt;</span> count_weights <span class="free"><span class="bound"><span class="entity">shared</span></span></span> <span class="main">(</span>remove_weights <span class="free"><span class="bound"><span class="entity">m1</span></span></span><span class="main">)</span> 
         <span class="keyword1">then</span> <span class="free">extract_weights</span> <span class="free"><span class="bound"><span class="entity">shared</span></span></span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="bound">x</span> 
         <span class="keyword1">else</span> <span class="free">extract_weights</span> <span class="free"><span class="bound"><span class="entity">shared</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">(</span><span class="bound">x</span> <span class="main">-</span> count_weights <span class="free"><span class="bound"><span class="entity">shared</span></span></span> <span class="main">(</span>remove_weights <span class="free"><span class="bound"><span class="entity">m1</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">balanced_net</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">×</span> nat<span class="main">)</span> convnet <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  balanced_net_Input<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">balanced_net</span> <span class="main">(</span>Input <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> balanced_net_Conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">balanced_net</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">⟹</span> <span class="free">balanced_net</span> <span class="main">(</span>Conv <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> balanced_net_Pool<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">balanced_net</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="main">⟹</span> <span class="free">balanced_net</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">⟹</span> 
    count_weights True <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="main">=</span> count_weights True <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">⟹</span> <span class="free">balanced_net</span> <span class="main">(</span>Pool <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">shared_weight_net</span><span class="main">::</span><span class="quoted"><span class="quoted">"real mat convnet <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  shared_weight_net_Input<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">shared_weight_net</span> <span class="main">(</span>Input <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> shared_weight_net_Conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">shared_weight_net</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">⟹</span> <span class="free">shared_weight_net</span> <span class="main">(</span>Conv <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> shared_weight_net_Pool<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">shared_weight_net</span> <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="main">⟹</span> <span class="free">shared_weight_net</span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="main">⟹</span> 
  count_weights True <span class="main">(</span>remove_weights <span class="free"><span class="bound"><span class="entity">m1</span></span></span><span class="main">)</span> <span class="main">=</span> count_weights True <span class="main">(</span>remove_weights <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span> <span class="main">⟹</span> 
  <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> count_weights True <span class="main">(</span>remove_weights <span class="free"><span class="bound"><span class="entity">m1</span></span></span><span class="main">)</span> <span class="main">⟹</span> extract_weights True <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="bound">x</span> <span class="main">=</span> extract_weights True <span class="free"><span class="bound"><span class="entity">m2</span></span></span> <span class="bound">x</span><span class="main">)</span>
   <span class="main">⟹</span> <span class="free">shared_weight_net</span> <span class="main">(</span>Pool <span class="free"><span class="bound"><span class="entity">m1</span></span></span> <span class="free"><span class="bound"><span class="entity">m2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="DL_Network-insert_extract_weights_cong_shared"><span class="command">lemma</span></span> insert_extract_weights_cong_shared<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"shared_weight_net <span class="free">m</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> count_weights True <span class="main">(</span>remove_weights <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> extract_weights True <span class="free">m</span> <span class="bound">x</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> insert_weights True <span class="main">(</span>remove_weights <span class="free">m</span><span class="main">)</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">f</span></span><span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>shared_weight_net_Input <span class="skolem">M</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>shared_weight_net_Conv <span class="skolem">m</span> <span class="skolem">A</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extract_matrix <span class="skolem">f</span> <span class="main">(</span>dim_row <span class="skolem">A</span><span class="main">)</span> <span class="main">(</span>dim_col <span class="skolem">A</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> extract_matrix_cong extract_matrix_flatten_matrix shared_weight_net_Conv.prems<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> shared_weight_net_Conv.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> dim_row <span class="skolem">A</span> <span class="main">*</span> dim_col <span class="skolem">A</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> shared_weight_net_Conv.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>shared_weight_net_Pool <span class="skolem">m1</span> <span class="skolem">m2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m1</span> <span class="main">=</span> insert_weights True <span class="main">(</span>remove_weights <span class="skolem">m1</span><span class="main">)</span> <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> shared_weight_net_Pool.IH<span class="main">(</span>1<span class="main">)</span> shared_weight_net_Pool.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m2</span> <span class="main">=</span> insert_weights True <span class="main">(</span>remove_weights <span class="skolem">m2</span><span class="main">)</span> <span class="skolem">f</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> local.shared_weight_net_Pool<span class="main">(</span>3<span class="main">)</span> shared_weight_net_Pool.IH<span class="main">(</span>2<span class="main">)</span> 
    shared_weight_net_Pool.hyps<span class="main">(</span>4<span class="main">)</span> shared_weight_net_Pool.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">m1</span> <span class="main">=</span> insert_weights True <span class="main">(</span>remove_weights <span class="skolem">m1</span><span class="main">)</span> <span class="skolem">f</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Network-insert_extract_weights_cong_unshared"><span class="command">lemma</span></span> insert_extract_weights_cong_unshared<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> count_weights False <span class="main">(</span>remove_weights <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> extract_weights False <span class="free">m</span> <span class="bound">x</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> insert_weights False <span class="main">(</span>remove_weights <span class="free">m</span><span class="main">)</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">f</span></span><span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Input <span class="skolem">M</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Conv <span class="skolem">A</span> <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extract_matrix <span class="skolem">f</span> <span class="main">(</span>dim_row <span class="skolem">A</span><span class="main">)</span> <span class="main">(</span>dim_col <span class="skolem">A</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> count_weights.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> extract_matrix_flatten_matrix_cong extract_weights_Conv remove_weights.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> trans_less_add1<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> Conv.IH Conv.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pool <span class="skolem">m1</span> <span class="skolem">m2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Pool.IH<span class="main">(</span>1<span class="main">)</span> Pool.IH<span class="main">(</span>2<span class="main">)</span> Pool.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Network-remove_insert_weights"><span class="command">lemma</span></span> remove_insert_weights<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"remove_weights <span class="main">(</span>insert_weights <span class="free">s</span> <span class="free">m</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">w</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Input
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Conv <span class="skolem">r12</span> <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r1</span></span> <span class="skolem"><span class="skolem">r2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r12</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">r1</span><span class="main">,</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"remove_weights <span class="main">(</span>insert_weights <span class="free">s</span> <span class="skolem">m</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Conv.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"remove_weights <span class="main">(</span>insert_weights <span class="free">s</span> <span class="main">(</span>Conv <span class="main">(</span><span class="skolem">r1</span><span class="main">,</span><span class="skolem">r2</span><span class="main">)</span> <span class="skolem">m</span><span class="main">)</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> Conv <span class="main">(</span><span class="skolem">r1</span><span class="main">,</span><span class="skolem">r2</span><span class="main">)</span> <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> insert_weights.simps remove_weights.simps
    <span class="keyword1"><span class="command">using</span></span> extract_matrix_def Conv.IH dim_extract_matrix<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dim_col_mat<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r12</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">r1</span><span class="main">,</span> <span class="skolem">r2</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pool <span class="skolem">m1</span> <span class="skolem">m2</span> <span class="skolem">w</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> insert_weights.simps remove_weights.simps <span class="keyword1"><span class="command">using</span></span> Pool.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Network-extract_insert_weights_shared"><span class="command">lemma</span></span> extract_insert_weights_shared<span class="main">:</span> 
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">&lt;</span>count_weights True <span class="free">m</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"balanced_net <span class="free">m</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"extract_weights True <span class="main">(</span>insert_weights True <span class="free">m</span> <span class="free">w</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">w</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Input <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Conv <span class="skolem">r01</span> <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r0</span></span> <span class="skolem"><span class="skolem">r1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r01</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">r0</span><span class="main">,</span><span class="skolem">r1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r01</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">r0</span><span class="main">,</span><span class="skolem">r1</span><span class="main">)</span>›</span></span> insert_weights.simps extract_weights.simps 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> dim_row <span class="main">(</span>extract_matrix <span class="skolem">w</span> <span class="skolem">r0</span> <span class="skolem">r1</span><span class="main">)</span> <span class="main">*</span> dim_col <span class="main">(</span>extract_matrix <span class="skolem">w</span> <span class="skolem">r0</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span><span class="main">)</span>  
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dim_extract_matrix<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> dim_extract_matrix<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> flatten_matrix_extract_matrix<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> Conv.IH<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">w</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">r0</span> <span class="main">*</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span><span class="main">]</span> Conv.prems<span class="main">(</span>1<span class="main">)</span> Conv.prems<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">r01</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">r0</span><span class="main">,</span> <span class="skolem">r1</span><span class="main">)</span>›</span></span> balanced_net.cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pool <span class="skolem">m1</span> <span class="skolem">m2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> insert_weights.simps extract_weights.simps  remove_insert_weights
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> count_weights True <span class="skolem">m1</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> balanced_net.simps convnet.distinct<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> convnet.inject<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> count_weights.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> not_less_zero<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> balanced_net.simps convnet.distinct<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> convnet.inject<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> count_weights.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> count_weights.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> less_max_iff_disj not_less_zero<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Network-shared_weight_net_insert_weights"><span class="command">lemma</span></span> shared_weight_net_insert_weights<span class="main">:</span> <span class="quoted"><span class="quoted">"balanced_net <span class="free">m</span> <span class="main">⟹</span> shared_weight_net <span class="main">(</span>insert_weights True <span class="free">m</span> <span class="free">w</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">w</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Input <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> insert_weights.simps balanced_net.simps shared_weight_net.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Conv <span class="skolem">r01</span> <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r0</span></span> <span class="skolem"><span class="skolem">r1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r01</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">r0</span><span class="main">,</span><span class="skolem">r1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>  <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">r01</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">r0</span><span class="main">,</span><span class="skolem">r1</span><span class="main">)</span>›</span></span> insert_weights.simps  
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Conv.IH Conv.prems balanced_net.simps convnet.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> convnet.distinct<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> convnet.inject<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> shared_weight_net_Conv<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pool <span class="skolem">m1</span> <span class="skolem">m2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"balanced_net <span class="skolem">m1</span>"</span></span> <span class="quoted"><span class="quoted">"balanced_net <span class="skolem">m2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Pool.prems balanced_net.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>              
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> count_weights True <span class="skolem">m1</span> <span class="main">⟹</span>
         extract_weights True <span class="main">(</span>insert_weights True <span class="skolem">m1</span> <span class="skolem">w</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> extract_weights True <span class="main">(</span>insert_weights True <span class="skolem">m2</span> <span class="skolem">w</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> extract_insert_weights_shared 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pool.prems balanced_net.simps convnet.distinct<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> convnet.distinct<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> convnet.inject<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> insert_weights.simps <span class="keyword1"><span class="command">using</span></span> Pool<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">w</span></span><span class="main">]</span> Pool<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">w</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pool.prems balanced_net.simps convnet.distinct<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> convnet.distinct<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> convnet.inject<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> remove_insert_weights shared_weight_net_Pool<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Network-finite_valid_index"><span class="command">lemma</span></span> finite_valid_index<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">is</span><span class="main">.</span> <span class="bound">is</span> <span class="main">⊲</span> <span class="free">ds</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ds</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> List.finite_set finite_subset length_0_conv list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> mem_Collect_eq subsetI valid_index_length<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">d</span> <span class="skolem">ds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">is</span><span class="main">.</span> <span class="bound">is</span> <span class="main">⊲</span> <span class="skolem">d</span> <span class="main">#</span> <span class="skolem">ds</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">&lt;</span><span class="skolem">d</span><span class="main">.</span> <span class="main">{</span><span class="bound">i</span> <span class="main">#</span> <span class="bound">is</span> <span class="main">|</span><span class="bound">is</span><span class="main">.</span> <span class="bound">is</span> <span class="main">⊲</span> <span class="skolem">ds</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="quoted">"<span class="skolem">is</span>"</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">is</span><span class="main">.</span> <span class="bound">is</span> <span class="main">⊲</span> <span class="skolem">d</span> <span class="main">#</span> <span class="skolem">ds</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> <span class="skolem">d</span> <span class="main">#</span> <span class="skolem">ds</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">is'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">#</span> <span class="skolem">is'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span><span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">⊲</span> <span class="skolem">d</span> <span class="main">#</span> <span class="skolem">ds</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is'</span> <span class="main">⊲</span> <span class="skolem">ds</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">#</span> <span class="skolem">is'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">⊲</span> <span class="skolem">d</span> <span class="main">#</span> <span class="skolem">ds</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i</span> <span class="main">#</span> <span class="bound">is</span> <span class="main">|</span><span class="bound">is</span><span class="main">.</span> <span class="bound">is</span> <span class="main">⊲</span> <span class="skolem">ds</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">=</span> <span class="skolem">i</span> <span class="main">#</span> <span class="skolem">is'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is'</span> <span class="main">⊲</span> <span class="skolem">ds</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">&lt;</span><span class="skolem">d</span><span class="main">.</span> <span class="main">{</span><span class="bound">i</span> <span class="main">#</span> <span class="bound">is</span> <span class="main">|</span><span class="bound">is</span><span class="main">.</span> <span class="bound">is</span> <span class="main">⊲</span> <span class="skolem">ds</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">d</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> finite <span class="main">{</span><span class="bound">i</span> <span class="main">#</span> <span class="bound">is</span> <span class="main">|</span><span class="bound">is</span><span class="main">.</span> <span class="bound">is</span> <span class="main">⊲</span> <span class="skolem">ds</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons.IH<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">is</span><span class="main">.</span> <span class="bound">is</span> <span class="main">⊲</span> <span class="skolem">d</span> <span class="main">#</span> <span class="skolem">ds</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Network-setsum_valid_index_split"><span class="command">lemma</span></span> setsum_valid_index_split<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">is</span></span> <span class="main">|</span> <span class="bound">is</span> <span class="main">⊲</span> <span class="free">ds1</span> <span class="main">@</span> <span class="free">ds2</span><span class="main">.</span> <span class="free">f</span> <span class="bound">is</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">is1</span></span> <span class="main">|</span> <span class="bound">is1</span> <span class="main">⊲</span> <span class="free">ds1</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">is2</span></span> <span class="main">|</span> <span class="bound">is2</span> <span class="main">⊲</span> <span class="free">ds2</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">is1</span> <span class="main">@</span> <span class="bound">is2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">is1</span><span class="main">,</span> <span class="bound">is2</span><span class="main">)</span><span class="main">.</span> <span class="bound">is1</span> <span class="main">@</span> <span class="bound">is2</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="main">{</span><span class="bound">is1</span><span class="main">.</span> <span class="bound">is1</span> <span class="main">⊲</span> <span class="free">ds1</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">is2</span><span class="main">.</span> <span class="bound">is2</span> <span class="main">⊲</span> <span class="free">ds2</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">is</span><span class="main">.</span> <span class="bound">is</span> <span class="main">⊲</span> <span class="free">ds1</span> <span class="main">@</span> <span class="free">ds2</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="var">?B</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subset_antisym<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> subsetI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> valid_index_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⊲</span> <span class="free">ds1</span> <span class="main">@</span> <span class="free">ds2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x1</span></span> <span class="skolem"><span class="skolem">x2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x1</span> <span class="main">@</span> <span class="skolem">x2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x1</span> <span class="main">⊲</span> <span class="free">ds1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x2</span> <span class="main">⊲</span> <span class="free">ds2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> valid_index_split<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> <span class="skolem">x2</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">{</span><span class="bound">is1</span><span class="main">.</span> <span class="bound">is1</span> <span class="main">⊲</span> <span class="free">ds1</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">is2</span><span class="main">.</span> <span class="bound">is2</span> <span class="main">⊲</span> <span class="free">ds2</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> imageI <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x1</span> <span class="main">@</span> <span class="skolem">x2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">is1</span><span class="main">,</span> <span class="bound">is2</span><span class="main">)</span><span class="main">.</span> <span class="bound">is1</span> <span class="main">@</span> <span class="bound">is2</span><span class="main">)</span> <span class="main">(</span><span class="main">{</span><span class="bound">is1</span><span class="main">.</span> <span class="bound">is1</span> <span class="main">⊲</span> <span class="free">ds1</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">is2</span><span class="main">.</span> <span class="bound">is2</span> <span class="main">⊲</span> <span class="free">ds2</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inj_on_def valid_index_length<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Groups_Big.comm_monoid_add_class.sum.cartesian_product<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">is1</span> <span class="bound">is2</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">is1</span> <span class="main">@</span> <span class="bound">is2</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> Groups_Big.comm_monoid_add_class.sum.reindex<span class="main">[</span><span class="operator">OF</span> 2<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> 1
     <span class="quoted">"2"</span> SigmaE prod.simps<span class="main">(</span>2<span class="main">)</span> sum.reindex_cong <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Network-prod_lessThan_split"><span class="command">lemma</span></span> prod_lessThan_split<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"prod <span class="free">g</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">+</span><span class="free">m</span><span class="main">}</span> <span class="main">=</span> prod <span class="free">g</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">*</span> prod <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">g</span> <span class="main">(</span><span class="bound">x</span><span class="main">+</span><span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">{..&lt;</span><span class="free">m</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> Groups_Big.comm_monoid_mult_class.prod.union_inter_neutral<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">n</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">+</span><span class="free">m</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="free">g</span></span><span class="main">,</span> <span class="operator">unfolded</span> ivl_disj_un_one<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> le_add1<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">OF</span> finite_lessThan finite_atLeastLessThan<span class="main">]</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> add.commute add.left_neutral atLeast0LessThan empty_iff ivl_disj_int_one<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> prod.shift_bounds_nat_ivl<span class="main">)</span>

<span class="comment1">(* This is a nice lemma, but never used to prove the Fundamental Theorem of Network Capacity: *)</span>
<span class="keyword1" id="DL_Network-evaluate_net_from_tensors"><span class="command">lemma</span></span> evaluate_net_from_tensors<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_net' <span class="free">m</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"map dim_vec <span class="free">inputs</span> <span class="main">=</span> input_sizes <span class="free">m</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> output_size' <span class="free">m</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"evaluate_net <span class="free">m</span> <span class="free">inputs</span> <span class="main">$</span> <span class="free">j</span>
  <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">is</span><span class="main">∈</span><span class="main">{</span><span class="bound">is</span><span class="main">.</span> <span class="bound">is</span> <span class="main">⊲</span> input_sizes <span class="free">m</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="main">∏</span><span class="bound">k</span><span class="main">&lt;</span>length <span class="free">inputs</span><span class="main">.</span> <span class="free">inputs</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">$</span> <span class="main">(</span><span class="bound">is</span><span class="main">!</span><span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> Tensor.lookup <span class="main">(</span>tensors_from_net <span class="free">m</span> <span class="main">$</span> <span class="free">j</span><span class="main">)</span> <span class="bound">is</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span>"</span></span> <span class="quoted"><span class="free">inputs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Input <span class="skolem">M</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">inputs</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"input_sizes <span class="main">(</span>Input <span class="skolem">M</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">M</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="quoted">"<span class="skolem">is</span>"</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> input_sizes <span class="main">(</span>Input <span class="skolem">M</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">is</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_index_length<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">=</span> <span class="main">[</span>hd <span class="skolem">is</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def length_0_conv length_Suc_conv list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Tensor.lookup <span class="main">(</span>tensors_from_net <span class="main">(</span>Input <span class="skolem">M</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">is</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> hd <span class="skolem">is</span><span class="main">=</span><span class="skolem">j</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Input.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹input_sizes <span class="main">(</span>Input <span class="skolem">M</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">M</span><span class="main">]</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">⊲</span> input_sizes <span class="main">(</span>Input <span class="skolem">M</span><span class="main">)</span>›</span></span> list.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
      lookup_unit_vec nth_Cons_0 output_size.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> remove_weights.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> tensors_from_net.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> valid_indexE index_vec<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">k</span><span class="main">&lt;</span>length <span class="skolem">inputs</span><span class="main">.</span> <span class="skolem">inputs</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">$</span> <span class="main">(</span><span class="skolem">is</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> lookup <span class="main">(</span>tensors_from_net <span class="main">(</span>Input <span class="skolem">M</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">is</span> <span class="main">=</span>
               <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">is</span><span class="main">=</span><span class="main">[</span><span class="skolem">j</span><span class="main">]</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">∏</span><span class="bound">k</span><span class="main">&lt;</span>length <span class="skolem">inputs</span><span class="main">.</span> <span class="skolem">inputs</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">$</span> <span class="main">(</span><span class="skolem">is</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">=</span> <span class="main">[</span>hd <span class="skolem">is</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">is</span></span> <span class="main">|</span> <span class="bound">is</span> <span class="main">⊲</span> input_sizes <span class="main">(</span>Input <span class="skolem">M</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∏</span><span class="bound">k</span><span class="main">&lt;</span>length <span class="skolem">inputs</span><span class="main">.</span> <span class="skolem">inputs</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">$</span> <span class="main">(</span><span class="bound">is</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> lookup <span class="main">(</span>tensors_from_net <span class="main">(</span>Input <span class="skolem">M</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span> <span class="bound">is</span><span class="main">)</span>
   <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">is</span></span> <span class="main">|</span> <span class="bound">is</span> <span class="main">⊲</span> input_sizes <span class="main">(</span>Input <span class="skolem">M</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">is</span><span class="main">=</span><span class="main">[</span><span class="skolem">j</span><span class="main">]</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">∏</span><span class="bound">k</span><span class="main">&lt;</span>length <span class="skolem">inputs</span><span class="main">.</span> <span class="skolem">inputs</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">$</span> <span class="main">(</span><span class="bound">is</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">is</span></span> <span class="main">|</span> <span class="bound">is</span> <span class="main">⊲</span> input_sizes <span class="main">(</span>Input <span class="skolem">M</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">is</span><span class="main">=</span><span class="main">[</span><span class="skolem">j</span><span class="main">]</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">∏</span><span class="bound">k</span><span class="main">&lt;</span>length <span class="skolem">inputs</span><span class="main">.</span> <span class="skolem">inputs</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">$</span> <span class="main">(</span><span class="bound">is</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>
   <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">k</span><span class="main">&lt;</span>length <span class="skolem">inputs</span><span class="main">.</span> <span class="skolem">inputs</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">$</span> <span class="main">(</span><span class="main">[</span><span class="skolem">j</span><span class="main">]</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sum.delta<span class="main">[</span><span class="operator">OF</span> finite_valid_index<span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> Input.prems<span class="main">(</span>3<span class="main">)</span> valid_index.Cons valid_index.Nil <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">inputs</span> <span class="main">!</span> <span class="main">0</span> <span class="main">$</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">inputs</span> <span class="main">=</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod.lessThan_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> evaluate_net <span class="main">(</span>Input <span class="skolem">M</span><span class="main">)</span> <span class="skolem">inputs</span> <span class="main">$</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> evaluate_net.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹length <span class="skolem">inputs</span> <span class="main">=</span> <span class="main">1</span>›</span></span> hd_conv_nth list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> zero_neq_one<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Conv <span class="skolem">A</span> <span class="skolem">m</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> dim_row <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Conv.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">is</span><span class="main">.</span> <span class="bound">is</span> <span class="main">⊲</span> input_sizes <span class="main">(</span>Conv <span class="skolem">A</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">∏</span><span class="bound">k</span><span class="main">&lt;</span>length <span class="skolem">inputs</span><span class="main">.</span> <span class="skolem">inputs</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">$</span> <span class="main">(</span><span class="bound">is</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> lookup <span class="main">(</span>tensors_from_net <span class="main">(</span>Conv <span class="skolem">A</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span> <span class="bound">is</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span>dim_vec <span class="main">(</span>tensors_from_net <span class="skolem">m</span><span class="main">)</span><span class="main">.</span> row <span class="skolem">A</span> <span class="skolem">j</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="main">∏</span><span class="bound">k</span><span class="main">&lt;</span>length <span class="skolem">inputs</span><span class="main">.</span> <span class="skolem">inputs</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">$</span> <span class="main">(</span><span class="bound">is</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> lookup <span class="main">(</span>tensors_from_net <span class="skolem">m</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">is</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="quoted">"<span class="skolem">is</span>"</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> input_sizes <span class="main">(</span>Conv <span class="skolem">A</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> input_sizes <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span><span class="quoted"><span class="quoted">"lookup <span class="main">(</span>tensors_from_net <span class="main">(</span>Conv <span class="skolem">A</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">is</span> <span class="main">=</span>
          <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span>dim_vec <span class="main">(</span>tensors_from_net <span class="skolem">m</span><span class="main">)</span><span class="main">.</span> row <span class="skolem">A</span> <span class="skolem">j</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">*</span> lookup <span class="main">(</span>tensors_from_net <span class="skolem">m</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">is</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> tensors_from_net.simps mat_tensorlist_mult_def index_vec<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> dim_row <span class="skolem">A</span>›</span></span><span class="main">]</span>
      lookup_tensor_from_lookup<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">⊲</span> input_sizes <span class="skolem">m</span>›</span></span><span class="main">]</span> index_mult_mat_vec<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> dim_row <span class="skolem">A</span>›</span></span><span class="main">]</span> scalar_prod_def
      <span class="keyword1"><span class="command">using</span></span> index_map_vec <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">k</span><span class="main">&lt;</span>length <span class="skolem">inputs</span><span class="main">.</span> <span class="skolem">inputs</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">$</span> <span class="main">(</span><span class="skolem">is</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> lookup <span class="main">(</span>tensors_from_net <span class="main">(</span>Conv <span class="skolem">A</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">is</span>
      <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span>dim_vec <span class="main">(</span>tensors_from_net <span class="skolem">m</span><span class="main">)</span><span class="main">.</span> row <span class="skolem">A</span> <span class="skolem">j</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="main">∏</span><span class="bound">k</span><span class="main">&lt;</span>length <span class="skolem">inputs</span><span class="main">.</span> <span class="skolem">inputs</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">$</span> <span class="main">(</span><span class="skolem">is</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> lookup <span class="main">(</span>tensors_from_net <span class="skolem">m</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">is</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> 0 sum_distrib_left <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> semiring_normalization_rules<span class="main"><span class="main">(</span></span>19<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_net' <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Conv.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> convnet.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> convnet.distinct<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> convnet.inject<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> remove_weights.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> valid_net.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map dim_vec <span class="skolem">inputs</span> <span class="main">=</span> input_sizes <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Conv.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"output_size' <span class="skolem">m</span> <span class="main">=</span> dim_vec <span class="main">(</span>tensors_from_net <span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹valid_net' <span class="skolem">m</span>›</span></span> output_size_correct_tensors<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span>dim_vec <span class="main">(</span>tensors_from_net <span class="skolem">m</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">is</span></span> <span class="main">|</span> <span class="bound">is</span> <span class="main">⊲</span> input_sizes <span class="main">(</span>Conv <span class="skolem">A</span> <span class="skolem">m</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">∏</span><span class="bound">k</span><span class="main">&lt;</span>length <span class="skolem">inputs</span><span class="main">.</span> <span class="skolem">inputs</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">$</span> <span class="main">(</span><span class="bound">is</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> lookup <span class="main">(</span>tensors_from_net <span class="skolem">m</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">is</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> evaluate_net <span class="skolem">m</span> <span class="skolem">inputs</span> <span class="main">$</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> input_sizes.simps
    <span class="keyword1"><span class="command">using</span></span> Conv.IH <span class="quoted"><span class="quoted">‹valid_net' <span class="skolem">m</span>›</span></span> <span class="quoted"><span class="quoted">‹map dim_vec <span class="skolem">inputs</span> <span class="main">=</span> input_sizes <span class="skolem">m</span>›</span></span> <span class="quoted"><span class="quoted">‹output_size' <span class="skolem">m</span> <span class="main">=</span> dim_vec <span class="main">(</span>tensors_from_net <span class="skolem">m</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">is</span></span> <span class="main">|</span> <span class="bound">is</span> <span class="main">⊲</span> input_sizes <span class="main">(</span>Conv <span class="skolem">A</span> <span class="skolem">m</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∏</span><span class="bound">k</span><span class="main">&lt;</span>length <span class="skolem">inputs</span><span class="main">.</span> <span class="skolem">inputs</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">$</span> <span class="main">(</span><span class="bound">is</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> lookup <span class="main">(</span>tensors_from_net <span class="main">(</span>Conv <span class="skolem">A</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span> <span class="bound">is</span><span class="main">)</span>
    <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span>dim_vec <span class="main">(</span>tensors_from_net <span class="skolem">m</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">is</span></span> <span class="main">|</span> <span class="bound">is</span> <span class="main">⊲</span> input_sizes <span class="main">(</span>Conv <span class="skolem">A</span> <span class="skolem">m</span><span class="main">)</span><span class="main">.</span>  row <span class="skolem">A</span> <span class="skolem">j</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">*</span>  <span class="main">(</span><span class="main">(</span><span class="main">∏</span><span class="bound">k</span><span class="main">&lt;</span>length <span class="skolem">inputs</span><span class="main">.</span> <span class="skolem">inputs</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">$</span> <span class="main">(</span><span class="bound">is</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> lookup <span class="main">(</span>tensors_from_net <span class="skolem">m</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">is</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Groups_Big.comm_monoid_add_class.sum.swap 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span>dim_vec <span class="main">(</span>tensors_from_net <span class="skolem">m</span><span class="main">)</span><span class="main">.</span> row <span class="skolem">A</span> <span class="skolem">j</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">is</span></span> <span class="main">|</span> <span class="bound">is</span> <span class="main">⊲</span> input_sizes <span class="main">(</span>Conv <span class="skolem">A</span> <span class="skolem">m</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="main">∏</span><span class="bound">k</span><span class="main">&lt;</span>length <span class="skolem">inputs</span><span class="main">.</span> <span class="skolem">inputs</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">$</span> <span class="main">(</span><span class="bound">is</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> lookup <span class="main">(</span>tensors_from_net <span class="skolem">m</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">is</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_left<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span>dim_vec <span class="main">(</span>tensors_from_net <span class="skolem">m</span><span class="main">)</span><span class="main">.</span> row <span class="skolem">A</span> <span class="skolem">j</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">*</span> evaluate_net <span class="skolem">m</span> <span class="skolem">inputs</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> row <span class="skolem">A</span> <span class="skolem">j</span> <span class="main">∙</span> evaluate_net <span class="skolem">m</span> <span class="skolem">inputs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹map dim_vec <span class="skolem">inputs</span> <span class="main">=</span> input_sizes <span class="skolem">m</span>›</span></span> <span class="quoted"><span class="quoted">‹output_size' <span class="skolem">m</span> <span class="main">=</span> dim_vec <span class="main">(</span>tensors_from_net <span class="skolem">m</span><span class="main">)</span>›</span></span>
    <span class="quoted"><span class="quoted">‹valid_net' <span class="skolem">m</span>›</span></span> output_size_correct scalar_prod_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> evaluate_net <span class="skolem">m</span> <span class="skolem">inputs</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> dim_row <span class="skolem">A</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> evaluate_net <span class="main">(</span>Conv <span class="skolem">A</span> <span class="skolem">m</span><span class="main">)</span> <span class="skolem">inputs</span> <span class="main">$</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pool <span class="skolem">m1</span> <span class="skolem">m2</span> <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_net' <span class="skolem">m1</span>"</span></span> <span class="quoted"><span class="quoted">"valid_net' <span class="skolem">m2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pool.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> convnet.distinct<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> convnet.inject<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> convnet.simps<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> remove_weights.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> valid_net.simps<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> output_size' <span class="skolem">m2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> output_size' <span class="skolem">m1</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Pool.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Pool.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> convnet.distinct<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> convnet.inject<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> convnet.simps<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span>
    output_size.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> remove_weights.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> valid_net.simps<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> Pool.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> dim_vec <span class="main">(</span>tensors_from_net <span class="skolem">m1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> dim_vec <span class="main">(</span>tensors_from_net <span class="skolem">m2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹valid_net' <span class="skolem">m1</span>›</span></span> <span class="quoted"><span class="quoted">‹valid_net' <span class="skolem">m2</span>›</span></span> output_size_correct_tensors<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">inputs1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">inputs1</span> <span class="main">=</span> take <span class="main">(</span>length <span class="main">(</span>input_sizes <span class="skolem">m1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">inputs</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">inputs2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">inputs2</span> <span class="main">=</span> drop <span class="main">(</span>length <span class="main">(</span>input_sizes <span class="skolem">m1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">inputs</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map dim_vec <span class="skolem">inputs1</span> <span class="main">=</span> input_sizes <span class="skolem">m1</span>"</span></span> <span class="quoted"><span class="quoted">"map dim_vec <span class="skolem">inputs2</span> <span class="main">=</span> input_sizes <span class="skolem">m2</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Pool.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> append_eq_conv_conj input_sizes.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> inputs1_def take_map<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pool.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> append_eq_conv_conj drop_map input_sizes.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> inputs2_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">inputs</span> <span class="main">=</span> <span class="skolem">inputs1</span> <span class="main">@</span> <span class="skolem">inputs2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inputs1_def inputs2_def<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">is1</span> <span class="skolem">is2</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is1</span> <span class="main">⊲</span> input_sizes <span class="skolem">m1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is2</span> <span class="main">⊲</span> input_sizes <span class="skolem">m2</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">is1</span> <span class="main">=</span> length <span class="skolem">inputs1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is1</span> <span class="main">⊲</span> input_sizes <span class="skolem">m1</span>›</span></span> <span class="quoted"><span class="quoted">‹map dim_vec <span class="skolem">inputs1</span> <span class="main">=</span> input_sizes <span class="skolem">m1</span>›</span></span> valid_index_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">is2</span> <span class="main">=</span> length <span class="skolem">inputs2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is2</span> <span class="main">⊲</span> input_sizes <span class="skolem">m2</span>›</span></span> <span class="quoted"><span class="quoted">‹map dim_vec <span class="skolem">inputs2</span> <span class="main">=</span> input_sizes <span class="skolem">m2</span>›</span></span> valid_index_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">k</span><span class="main">&lt;</span>length <span class="skolem">inputs1</span><span class="main">.</span> <span class="main">(</span><span class="skolem">inputs1</span> <span class="main">@</span> <span class="skolem">inputs2</span><span class="main">)</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">$</span> <span class="main">(</span><span class="main">(</span><span class="skolem">is1</span> <span class="main">@</span> <span class="skolem">is2</span><span class="main">)</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>  <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">k</span><span class="main">&lt;</span>length <span class="skolem">inputs1</span><span class="main">.</span> <span class="skolem">inputs1</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">$</span> <span class="main">(</span><span class="skolem">is1</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">is1</span> <span class="main">=</span> length <span class="skolem">inputs1</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">is2</span> <span class="main">=</span> length <span class="skolem">inputs2</span>›</span></span>
      nth_append <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> lessThan_iff prod.cong<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">x</span><span class="main">&lt;</span>length <span class="skolem">inputs2</span><span class="main">.</span> <span class="main">(</span><span class="skolem">inputs1</span> <span class="main">@</span> <span class="skolem">inputs2</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> length <span class="skolem">inputs1</span><span class="main">)</span> <span class="main">$</span> <span class="main">(</span><span class="main">(</span><span class="skolem">is1</span> <span class="main">@</span> <span class="skolem">is2</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> length <span class="skolem">inputs1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="main">∏</span><span class="bound">k</span><span class="main">&lt;</span>length <span class="skolem">inputs2</span><span class="main">.</span> <span class="skolem">inputs2</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">$</span> <span class="main">(</span><span class="skolem">is2</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">is1</span> <span class="main">=</span> length <span class="skolem">inputs1</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">is2</span> <span class="main">=</span> length <span class="skolem">inputs2</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> add.commute nth_append_length_plus<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∏</span><span class="bound">k</span><span class="main">&lt;</span>length <span class="skolem">inputs</span><span class="main">.</span> <span class="skolem">inputs</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">$</span> <span class="main">(</span><span class="main">(</span><span class="skolem">is1</span> <span class="main">@</span> <span class="skolem">is2</span><span class="main">)</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∏</span><span class="bound">k</span><span class="main">&lt;</span>length <span class="skolem">inputs1</span><span class="main">.</span> <span class="skolem">inputs1</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">$</span> <span class="main">(</span><span class="skolem">is1</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span><span class="bound">k</span><span class="main">&lt;</span>length <span class="skolem">inputs2</span><span class="main">.</span> <span class="skolem">inputs2</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">$</span> <span class="main">(</span><span class="skolem">is2</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">inputs</span> <span class="main">=</span> <span class="skolem">inputs1</span> <span class="main">@</span> <span class="skolem">inputs2</span>›</span></span> length_append prod_lessThan_split <span class="keyword1"><span class="command">using</span></span> 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> 1 <span class="main">=</span> this
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">is1</span> <span class="skolem">is2</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is1</span> <span class="main">⊲</span> input_sizes <span class="skolem">m1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is2</span> <span class="main">⊲</span> input_sizes <span class="skolem">m2</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is1</span> <span class="main">⊲</span> dims <span class="main">(</span>tensors_from_net <span class="skolem">m1</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is2</span> <span class="main">⊲</span> dims <span class="main">(</span>tensors_from_net <span class="skolem">m2</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> dim_vec <span class="main">(</span>tensors_from_net <span class="skolem">m1</span><span class="main">)</span>›</span></span>  <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> dim_vec <span class="main">(</span>tensors_from_net <span class="skolem">m2</span><span class="main">)</span>›</span></span> dims_tensors_from_net vec_setI <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span>tensors_from_net <span class="main">(</span>Pool <span class="skolem">m1</span> <span class="skolem">m2</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span><span class="skolem">is1</span> <span class="main">@</span> <span class="skolem">is2</span><span class="main">)</span> <span class="main">=</span> lookup <span class="main">(</span>tensors_from_net <span class="skolem">m1</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">is1</span> <span class="main">*</span> lookup <span class="main">(</span>tensors_from_net <span class="skolem">m2</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">is2</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted">"tensors_from_net.simps"</span> index_component_mult<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> dim_vec <span class="main">(</span>tensors_from_net <span class="skolem">m1</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> dim_vec <span class="main">(</span>tensors_from_net <span class="skolem">m2</span><span class="main">)</span>›</span></span><span class="main">]</span>
      lookup_tensor_prod<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">is1</span> <span class="main">⊲</span> dims <span class="main">(</span>tensors_from_net <span class="skolem">m1</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is2</span> <span class="main">⊲</span> dims <span class="main">(</span>tensors_from_net <span class="skolem">m2</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> 2 <span class="main">=</span> this

  <span class="keyword1"><span class="command">have</span></span> j_le_eval<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> dim_vec <span class="main">(</span>evaluate_net <span class="skolem">m1</span> <span class="main">(</span>take <span class="main">(</span>length <span class="main">(</span>input_sizes <span class="skolem">m1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">inputs</span><span class="main">)</span><span class="main">)</span>"</span></span>
                 <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> dim_vec <span class="main">(</span>evaluate_net <span class="skolem">m2</span> <span class="main">(</span>drop <span class="main">(</span>length <span class="main">(</span>input_sizes <span class="skolem">m1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">inputs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> output_size' <span class="skolem">m1</span>›</span></span> <span class="quoted"><span class="quoted">‹map dim_vec <span class="skolem">inputs1</span> <span class="main">=</span> input_sizes <span class="skolem">m1</span>›</span></span> <span class="quoted"><span class="quoted">‹valid_net' <span class="skolem">m1</span>›</span></span> inputs1_def output_size_correct
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> output_size' <span class="skolem">m2</span>›</span></span> <span class="quoted"><span class="quoted">‹map dim_vec <span class="skolem">inputs2</span> <span class="main">=</span> input_sizes <span class="skolem">m2</span>›</span></span> <span class="quoted"><span class="quoted">‹valid_net' <span class="skolem">m2</span>›</span></span> inputs2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">is</span></span> <span class="main">|</span> <span class="bound">is</span> <span class="main">⊲</span> input_sizes <span class="main">(</span>Pool <span class="skolem">m1</span> <span class="skolem">m2</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">∏</span><span class="bound">k</span><span class="main">&lt;</span>length <span class="skolem">inputs</span><span class="main">.</span> <span class="skolem">inputs</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">$</span> <span class="main">(</span><span class="bound">is</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> lookup <span class="main">(</span>tensors_from_net <span class="main">(</span>Pool <span class="skolem">m1</span> <span class="skolem">m2</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span> <span class="bound">is</span><span class="main">)</span>
        <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">is1</span></span> <span class="main">|</span> <span class="bound">is1</span> <span class="main">⊲</span> input_sizes <span class="skolem">m1</span><span class="main">.</span> <span class="main">∑</span><span class="bound"><span class="bound">is2</span></span> <span class="main">|</span> <span class="bound">is2</span> <span class="main">⊲</span> input_sizes <span class="skolem">m2</span><span class="main">.</span>
          <span class="main">(</span><span class="main">∏</span><span class="bound">k</span><span class="main">&lt;</span>length <span class="skolem">inputs1</span><span class="main">.</span> <span class="skolem">inputs1</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">$</span> <span class="main">(</span><span class="bound">is1</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span><span class="bound">k</span><span class="main">&lt;</span>length <span class="skolem">inputs2</span><span class="main">.</span> <span class="skolem">inputs2</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">$</span> <span class="main">(</span><span class="bound">is2</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span>
          lookup <span class="main">(</span>tensors_from_net <span class="skolem">m1</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span> <span class="bound">is1</span> <span class="main">*</span> lookup <span class="main">(</span>tensors_from_net <span class="skolem">m2</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span> <span class="bound">is2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> input_sizes.simps setsum_valid_index_split <span class="keyword1"><span class="command">using</span></span> 1 2
    <span class="keyword1"><span class="command">using</span></span> mem_Collect_eq sum.cong <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">is1</span></span> <span class="main">|</span> <span class="bound">is1</span> <span class="main">⊲</span> input_sizes <span class="skolem">m1</span><span class="main">.</span> <span class="main">(</span><span class="main">∏</span><span class="bound">k</span><span class="main">&lt;</span>length <span class="skolem">inputs1</span><span class="main">.</span> <span class="skolem">inputs1</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">$</span> <span class="main">(</span><span class="bound">is1</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> lookup <span class="main">(</span>tensors_from_net <span class="skolem">m1</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span> <span class="bound">is1</span><span class="main">)</span> <span class="main">*</span>
                   <span class="main">(</span><span class="main">∑</span><span class="bound"><span class="bound">is2</span></span> <span class="main">|</span> <span class="bound">is2</span> <span class="main">⊲</span> input_sizes <span class="skolem">m2</span><span class="main">.</span> <span class="main">(</span><span class="main">∏</span><span class="bound">k</span><span class="main">&lt;</span>length <span class="skolem">inputs2</span><span class="main">.</span> <span class="skolem">inputs2</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">$</span> <span class="main">(</span><span class="bound">is2</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> lookup <span class="main">(</span>tensors_from_net <span class="skolem">m2</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span> <span class="bound">is2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sum_product <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> sum.cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> evaluate_net <span class="main">(</span>Pool <span class="skolem">m1</span> <span class="skolem">m2</span><span class="main">)</span> <span class="skolem">inputs</span> <span class="main">$</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted">"evaluate_net.simps"</span> index_component_mult<span class="main">[</span><span class="operator">OF</span> j_le_eval<span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> Pool.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹valid_net' <span class="skolem">m1</span>›</span></span> _ <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> output_size' <span class="skolem">m1</span>›</span></span><span class="main">]</span> Pool.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹valid_net' <span class="skolem">m2</span>›</span></span> _ <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> output_size' <span class="skolem">m2</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹map dim_vec <span class="skolem">inputs1</span> <span class="main">=</span> input_sizes <span class="skolem">m1</span>›</span></span> <span class="quoted"><span class="quoted">‹map dim_vec <span class="skolem">inputs2</span> <span class="main">=</span> input_sizes <span class="skolem">m2</span>›</span></span> inputs1_def inputs2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Network-tensors_from_net_eqI"><span class="command">lemma</span></span> tensors_from_net_eqI<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_net' <span class="free">m1</span>"</span></span> <span class="quoted"><span class="quoted">"valid_net' <span class="free">m2</span>"</span></span> <span class="quoted"><span class="quoted">"input_sizes <span class="free">m1</span> <span class="main">=</span> input_sizes <span class="free">m2</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">inputs</span><span class="main">.</span> input_sizes <span class="free">m1</span> <span class="main">=</span> map dim_vec <span class="bound">inputs</span> <span class="main">⟹</span> evaluate_net <span class="free">m1</span> <span class="bound">inputs</span> <span class="main">=</span> evaluate_net <span class="free">m2</span> <span class="bound">inputs</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tensors_from_net <span class="free">m1</span> <span class="main">=</span> tensors_from_net <span class="free">m2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map dim_vec <span class="main">(</span>map <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>input_sizes <span class="free">m2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> input_sizes <span class="free">m2</span>"</span></span>
       <span class="quoted"><span class="quoted">"map dim_vec <span class="main">(</span>map <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>input_sizes <span class="free">m1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> input_sizes <span class="free">m1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nth_equalityI<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"output_size' <span class="free">m1</span> <span class="main">=</span> output_size' <span class="free">m2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span>
    output_size_correct<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹valid_net' <span class="free">m1</span>›</span></span> <span class="quoted"><span class="quoted">‹map dim_vec <span class="main">(</span>map <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>input_sizes <span class="free">m1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> input_sizes <span class="free">m1</span>›</span></span><span class="main">]</span>
    output_size_correct<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹valid_net' <span class="free">m2</span>›</span></span> <span class="quoted"><span class="quoted">‹map dim_vec <span class="main">(</span>map <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span>input_sizes <span class="free">m2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> input_sizes <span class="free">m2</span>›</span></span><span class="main">]</span>
    assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">is</span><span class="main">.</span> base_input <span class="free">m1</span> <span class="bound">is</span> <span class="main">=</span> base_input <span class="free">m2</span> <span class="bound">is</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> base_input_def <span class="quoted"><span class="quoted">‹input_sizes <span class="free">m1</span> <span class="main">=</span> input_sizes <span class="free">m2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq_vecI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> tensor_lookup_eqI<span class="main"><span class="keyword3">;</span></span> <span class="operator">metis</span>
    lookup_tensors_from_net<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹valid_net' <span class="free">m1</span>›</span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">is</span><span class="main">.</span> base_input <span class="free">m1</span> <span class="bound">is</span> <span class="main">=</span> base_input <span class="free">m2</span> <span class="bound">is</span>›</span></span> <span class="quoted"><span class="quoted">‹output_size' <span class="free">m1</span> <span class="main">=</span> output_size' <span class="free">m2</span>›</span></span><span class="main"><span class="main">]</span></span>
    lookup_tensors_from_net<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹valid_net' <span class="free">m2</span>›</span></span><span class="main"><span class="main">]</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> base_input_length
    assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> dims_tensors_from_net output_size_correct_tensors vec_setI
    <span class="quoted"><span class="quoted">‹output_size' <span class="free">m1</span> <span class="main">=</span> output_size' <span class="free">m2</span>›</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="DL_Concrete_Matrices">
<div class="head">
<h1>Theory DL_Concrete_Matrices</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Alexander Bentkamp, Universität des Saarlandes
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Concrete Matrices›</span></span>

<span class="keyword1"><span class="command">theory</span></span> DL_Concrete_Matrices
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../Jordan_Normal_Form/Matrix.html">Jordan_Normal_Form.Matrix</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following definition allows non-square-matrices, mat\_one (mat\_one n) only allows square matrices.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">id_matrix</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> real mat"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">id_matrix</span> <span class="free"><span class="bound"><span class="entity">nr</span></span></span> <span class="free"><span class="bound"><span class="entity">nc</span></span></span> <span class="main">=</span> mat <span class="free"><span class="bound"><span class="entity">nr</span></span></span> <span class="free"><span class="bound"><span class="entity">nc</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">r</span><span class="main">=</span><span class="bound">c</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="DL_Concrete_Matrices-id_matrix_dim"><span class="command">lemma</span></span> id_matrix_dim<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span>id_matrix <span class="free">nr</span> <span class="free">nc</span><span class="main">)</span> <span class="main">=</span> <span class="free">nr</span>"</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span>id_matrix <span class="free">nr</span> <span class="free">nc</span><span class="main">)</span> <span class="main">=</span> <span class="free">nc</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_matrix_def<span class="main">)</span>

<span class="keyword1" id="DL_Concrete_Matrices-row_id_matrix"><span class="command">lemma</span></span> row_id_matrix<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">nr</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"row <span class="main">(</span>id_matrix <span class="free">nr</span> <span class="free">nc</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> unit_vec <span class="free">nc</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq_vecI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms id_matrix_def unit_vec_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_matrix_dim<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="DL_Concrete_Matrices-unit_eq_0"><span class="command">lemma</span></span> unit_eq_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≥</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"unit_vec <span class="free">n</span> <span class="free">i</span> <span class="main">=</span> <span class="keyword1">0<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> eq_vecI<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unit_vec_def<span class="main">)</span>

<span class="keyword1" id="DL_Concrete_Matrices-mult_id_matrix"><span class="command">lemma</span></span> mult_id_matrix<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">nr</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>id_matrix <span class="free">nr</span> <span class="main">(</span>dim_vec <span class="free">v</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span><span class="main">)</span> <span class="main">$</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span><span class="main">&lt;</span>dim_vec <span class="free">v</span> <span class="keyword1">then</span> <span class="free">v</span> <span class="main">$</span> <span class="free">i</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">$</span> <span class="free">i</span> <span class="main">=</span> <span class="var">?b</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">$</span> <span class="free">i</span> <span class="main">=</span> row <span class="main">(</span>id_matrix <span class="free">nr</span> <span class="main">(</span>dim_vec <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span> <span class="main">∙</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> index_mult_mat_vec assms id_matrix_dim <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> unit_vec <span class="main">(</span>dim_vec <span class="free">v</span><span class="main">)</span> <span class="free">i</span> <span class="main">∙</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> row_id_matrix assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="var">?b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> scalar_prod_left_unit carrier_vecI unit_eq_0 scalar_prod_left_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">all1_vec</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real vec"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">all1_vec</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> vec <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">all1_matrix</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> real mat"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">all1_matrix</span> <span class="free"><span class="bound"><span class="entity">nr</span></span></span> <span class="free"><span class="bound"><span class="entity">nc</span></span></span> <span class="main">=</span> mat <span class="free"><span class="bound"><span class="entity">nr</span></span></span> <span class="free"><span class="bound"><span class="entity">nc</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="DL_Concrete_Matrices-all1_matrix_dim"><span class="command">lemma</span></span> all1_matrix_dim<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span>all1_matrix <span class="free">nr</span> <span class="free">nc</span><span class="main">)</span> <span class="main">=</span> <span class="free">nr</span>"</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span>all1_matrix <span class="free">nr</span> <span class="free">nc</span><span class="main">)</span> <span class="main">=</span> <span class="free">nc</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> all1_matrix_def<span class="main">)</span>

<span class="keyword1" id="DL_Concrete_Matrices-row_all1_matrix"><span class="command">lemma</span></span> row_all1_matrix<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">nr</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"row <span class="main">(</span>all1_matrix <span class="free">nr</span> <span class="free">nc</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> all1_vec <span class="free">nc</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eq_vecI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> all1_matrix_def all1_vec_def assms<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> all1_matrix_def all1_vec_def<span class="main">)</span>

<span class="keyword1" id="DL_Concrete_Matrices-all1_vec_scalar_prod"><span class="command">lemma</span></span> all1_vec_scalar_prod<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"all1_vec <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span>vec_of_list <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"all1_vec <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">∙</span> <span class="main">(</span>vec_of_list <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span>dim_vec <span class="main">(</span>vec_of_list <span class="free">xs</span><span class="main">)</span><span class="main">.</span> vec_of_list <span class="free">xs</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> scalar_prod_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> all1_vec_def mult_cancel_right1 sum.ivl_cong
    vec.abs_eq dim_vec index_vec vec_of_list.abs_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span>length <span class="free">xs</span><span class="main">.</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> vec.abs_eq dim_vec vec_of_list.abs_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sum.ivl_cong index_vec<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum_list <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_list_sum_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="DL_Concrete_Matrices-mult_all1_matrix"><span class="command">lemma</span></span> mult_all1_matrix<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">nr</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>all1_matrix <span class="free">nr</span> <span class="main">(</span>dim_vec <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span><span class="main">)</span> <span class="main">$</span> <span class="free">i</span> <span class="main">=</span> sum_list <span class="main">(</span>list_of_vec <span class="free">v</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">$</span> <span class="free">i</span> <span class="main">=</span> sum_list <span class="main">(</span>list_of_vec <span class="free">v</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">$</span> <span class="free">i</span> <span class="main">=</span> row <span class="main">(</span>all1_matrix <span class="free">nr</span> <span class="main">(</span>dim_vec <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span> <span class="main">∙</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> index_mult_mat_vec assms all1_matrix_dim <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum_list <span class="main">(</span>list_of_vec <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> row_all1_matrix<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> all1_vec_scalar_prod<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"list_of_vec <span class="free">v</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> vec.abs_eq dim_vec vec_list vec_of_list.abs_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">copy_first_matrix</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> real mat"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">copy_first_matrix</span> <span class="free"><span class="bound"><span class="entity">nr</span></span></span> <span class="free"><span class="bound"><span class="entity">nc</span></span></span> <span class="main">=</span> mat <span class="free"><span class="bound"><span class="entity">nr</span></span></span> <span class="free"><span class="bound"><span class="entity">nc</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">c</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="DL_Concrete_Matrices-copy_first_matrix_dim"><span class="command">lemma</span></span> copy_first_matrix_dim<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span>copy_first_matrix <span class="free">nr</span> <span class="free">nc</span><span class="main">)</span> <span class="main">=</span> <span class="free">nr</span>"</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span>copy_first_matrix <span class="free">nr</span> <span class="free">nc</span><span class="main">)</span> <span class="main">=</span> <span class="free">nc</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> copy_first_matrix_def<span class="main">)</span>

<span class="keyword1" id="DL_Concrete_Matrices-row_copy_first_matrix"><span class="command">lemma</span></span> row_copy_first_matrix<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">nr</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"row <span class="main">(</span>copy_first_matrix <span class="free">nr</span> <span class="free">nc</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> unit_vec <span class="free">nc</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> eq_vecI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> copy_first_matrix_def assms<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> copy_first_matrix_def<span class="main">)</span>

<span class="keyword1" id="DL_Concrete_Matrices-mult_copy_first_matrix"><span class="command">lemma</span></span> mult_copy_first_matrix<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">nr</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="free">v</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>copy_first_matrix <span class="free">nr</span> <span class="main">(</span>dim_vec <span class="free">v</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="free">v</span><span class="main">)</span> <span class="main">$</span> <span class="free">i</span> <span class="main">=</span> <span class="free">v</span> <span class="main">$</span> <span class="main">0</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">$</span> <span class="free">i</span> <span class="main">=</span> <span class="free">v</span> <span class="main">$</span> <span class="main">0</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">$</span> <span class="free">i</span> <span class="main">=</span> row <span class="main">(</span>copy_first_matrix <span class="free">nr</span> <span class="main">(</span>dim_vec <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span> <span class="main">∙</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> index_mult_mat_vec assms copy_first_matrix_dim <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> unit_vec <span class="main">(</span>dim_vec <span class="free">v</span><span class="main">)</span> <span class="main">0</span> <span class="main">∙</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> row_copy_first_matrix assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">v</span> <span class="main">$</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> scalar_prod_left_unit carrier_dim_vec <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="DL_Missing_Finite_Set">
<div class="head">
<h1>Theory DL_Missing_Finite_Set</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Alexander Bentkamp, Universität des Saarlandes
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Missing Lemmas of Finite\_Set›</span></span>
<span class="keyword1"><span class="command">theory</span></span> DL_Missing_Finite_Set
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="DL_Missing_Finite_Set-card_even"><span class="command">lemma</span></span> card_even<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> Collect even<span class="main">.</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span><span class="main">}</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> Collect even<span class="main">.</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">*</span> Suc <span class="skolem">n</span><span class="main">}</span> <span class="main">=</span> insert <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">n</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> Collect even<span class="main">.</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> le_eq_less_or_eq less_Suc_eq_le subset_antisym <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> Collect even<span class="main">.</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">*</span> Suc <span class="skolem">n</span><span class="main">}</span> <span class="main">=</span> insert <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">n</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> Collect even<span class="main">.</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">n</span><span class="main">}</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc card_insert_disjoint<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> Collect even<span class="main">.</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">*</span><span class="skolem">n</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_M_bounded_by_nat less_not_refl2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Missing_Finite_Set-card_odd"><span class="command">lemma</span></span> card_odd<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> Collect odd<span class="main">.</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span><span class="main">}</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> Collect odd<span class="main">.</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">*</span> Suc <span class="skolem">n</span><span class="main">}</span> <span class="main">=</span> insert <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> Collect odd<span class="main">.</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> le_eq_less_or_eq less_Suc_eq_le subset_antisym <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> Collect odd<span class="main">.</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">*</span> Suc <span class="skolem">n</span><span class="main">}</span> <span class="main">=</span> insert <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> Collect odd<span class="main">.</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">n</span><span class="main">}</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc card_insert_disjoint<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> Collect even<span class="main">.</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">*</span><span class="skolem">n</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_M_bounded_by_nat less_not_refl2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="DL_Deep_Model">
<div class="head">
<h1>Theory DL_Deep_Model</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Alexander Bentkamp, Universität des Saarlandes
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Deep Network Model›</span></span>

<span class="keyword1"><span class="command">theory</span></span> DL_Deep_Model
<span class="keyword2"><span class="keyword">imports</span></span> <a href="DL_Network.html">DL_Network</a> <a href="Tensor_Matricization.html">Tensor_Matricization</a> <a href="../Jordan_Normal_Form/DL_Submatrix.html">Jordan_Normal_Form.DL_Submatrix</a> <a href="DL_Concrete_Matrices.html">DL_Concrete_Matrices</a>
<a href="DL_Missing_Finite_Set.html">DL_Missing_Finite_Set</a> <a href="../Jordan_Normal_Form/DL_Missing_Sublist.html">Jordan_Normal_Form.DL_Missing_Sublist</a> <a href="../Jordan_Normal_Form/Determinant.html">Jordan_Normal_Form.Determinant</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">hide_const</span></span><span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> Polynomial.order
<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> Matrix.unit_vec 


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">deep_model</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">deep_model'</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">deep_model'</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">[]</span> <span class="main">=</span> Input <span class="free"><span class="bound"><span class="entity">Y</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">deep_model'</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="main">=</span> Pool <span class="main">(</span><span class="free">deep_model</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">deep_model</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">deep_model</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">=</span> Conv <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">deep_model'</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">deep_model'_l</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">==</span> deep_model' <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">!</span><span class="main">0</span><span class="main">)</span> <span class="main">(</span>tl <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">deep_model_l</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">==</span> deep_model <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">!</span><span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">!</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>tl <span class="main">(</span>tl <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="DL_Deep_Model-valid_deep_model"><span class="command">lemma</span></span> valid_deep_model<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_net <span class="main">(</span>deep_model <span class="free">Y</span> <span class="free">r</span> <span class="free">rs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">rs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Y</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_net.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> valid_net.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">using</span></span> valid_net.intros<span class="main">(</span>2<span class="main">)</span> valid_net.intros<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="DL_Deep_Model-valid_deep_model'"><span class="command">lemma</span></span> valid_deep_model'<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_net <span class="main">(</span>deep_model' <span class="free">r</span> <span class="free">rs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">rs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_net.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> deep_model'.elims deep_model'.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> deep_model.elims output_size.simps valid_net.simps<span class="main">)</span>

<span class="keyword1" id="DL_Deep_Model-input_sizes_deep_model'"><span class="command">lemma</span></span> input_sizes_deep_model'<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">rs</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"input_sizes <span class="main">(</span>deep_model'_l <span class="free">rs</span><span class="main">)</span> <span class="main">=</span> replicate <span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="main">(</span>length <span class="free">rs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>last <span class="free">rs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"butlast <span class="free">rs</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">rs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rs</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">rs</span><span class="main">!</span><span class="main">0</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def diff_diff_cancel diff_zero length_0_conv length_Suc_conv length_butlast nth_Cons_0<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"input_sizes <span class="main">(</span>deep_model'_l <span class="skolem">rs</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span>last <span class="skolem">rs</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> deep_model'.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> input_sizes.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> last.simps list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"input_sizes <span class="main">(</span>deep_model'_l <span class="skolem">rs</span><span class="main">)</span> <span class="main">=</span> replicate <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>length <span class="skolem">rs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>last <span class="skolem">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def <span class="quoted"><span class="quoted">‹<span class="main">[]</span> <span class="main">=</span> butlast <span class="skolem">rs</span>›</span></span> empty_replicate length_butlast list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> power_0 replicate.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">r</span> <span class="skolem">rs'</span> <span class="skolem">rs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"input_sizes <span class="main">(</span>deep_model'_l <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> replicate <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>length <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>last <span class="skolem">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> One_nat_def butlast_tl diff_is_0_eq' last_tl length_Cons
    length_butlast length_tl list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> nat_le_linear not_one_le_zero<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rs</span> <span class="main">=</span> <span class="skolem">r</span> <span class="main">#</span> <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Cons.prems One_nat_def append_Cons append_butlast_last_id length_greater_0_conv less_le_trans list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> zero_less_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"deep_model'_l <span class="skolem">rs</span> <span class="main">=</span> Pool <span class="main">(</span>deep_model_l <span class="skolem">rs</span><span class="main">)</span> <span class="main">(</span>deep_model_l <span class="skolem">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> One_nat_def butlast.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> deep_model'.elims list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> nth_Cons_0 nth_Cons_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"input_sizes <span class="main">(</span>deep_model'_l <span class="skolem">rs</span><span class="main">)</span> <span class="main">=</span> input_sizes <span class="main">(</span>deep_model_l <span class="skolem">rs</span><span class="main">)</span> <span class="main">@</span> input_sizes <span class="main">(</span>deep_model_l <span class="skolem">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> input_sizes.simps<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> input_sizes <span class="main">(</span>deep_model'_l <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> input_sizes <span class="main">(</span>deep_model'_l <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Cons.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> One_nat_def deep_model.elims input_sizes.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>
    length_Cons length_butlast length_greater_0_conv length_tl list.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span>
    nth_tl one_neq_zero<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> replicate <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>length <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>last <span class="skolem">rs</span><span class="main">)</span> <span class="main">@</span> replicate <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>length <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>last <span class="skolem">rs</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> replicate <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>length <span class="skolem">rs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>last <span class="skolem">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> replicate_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>length <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>length <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"last <span class="skolem">rs</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> One_nat_def butlast_tl length_butlast list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.size<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> mult_2_right
    power_add power_one_right<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Deep_Model-input_sizes_deep_model"><span class="command">lemma</span></span> input_sizes_deep_model<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">rs</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"input_sizes <span class="main">(</span>deep_model_l <span class="free">rs</span><span class="main">)</span> <span class="main">=</span> replicate <span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="main">(</span>length <span class="free">rs</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>last <span class="free">rs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"input_sizes <span class="main">(</span>deep_model_l <span class="free">rs</span><span class="main">)</span> <span class="main">=</span> input_sizes <span class="main">(</span>deep_model'_l <span class="main">(</span>tl <span class="free">rs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_1 assms hd_Cons_tl deep_model.elims input_sizes.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> length_Cons
    length_greater_0_conv lessI linorder_not_le list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> not_numeral_le_zero nth_tl<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> replicate <span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="main">(</span>length <span class="free">rs</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>last <span class="free">rs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> input_sizes_deep_model'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> One_nat_def Suc_1 Suc_eq_plus1 assms diff_diff_left hd_Cons_tl
    last_tl length_Cons length_tl linorder_not_le list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> not_less_eq not_numeral_le_zero
    numeral_le_one_iff semiring_norm<span class="main"><span class="main">(</span></span>69<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Deep_Model-evaluate_net_Conv_id"><span class="command">lemma</span></span> evaluate_net_Conv_id<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_net' <span class="free">m</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"input_sizes <span class="free">m</span> <span class="main">=</span> map dim_vec <span class="free">input</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">&lt;</span><span class="free">nr</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"evaluate_net <span class="main">(</span>Conv <span class="main">(</span>id_matrix <span class="free">nr</span> <span class="main">(</span>output_size' <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="free">m</span><span class="main">)</span> <span class="free">input</span> <span class="main">$</span> <span class="free">j</span>
 <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">j</span><span class="main">&lt;</span>output_size' <span class="free">m</span> <span class="keyword1">then</span> evaluate_net <span class="free">m</span> <span class="free">input</span> <span class="main">$</span> <span class="free">j</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> evaluate_net.simps output_size_correct<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> mult_id_matrix<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">j</span><span class="main">&lt;</span><span class="free">nr</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"evaluate_net <span class="free">m</span> <span class="free">input</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> dim_vec_of_list<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="DL_Deep_Model-tensors_from_net_Conv_id"><span class="command">lemma</span></span> tensors_from_net_Conv_id<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_net' <span class="free">m</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="free">nr</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tensors_from_net <span class="main">(</span>Conv <span class="main">(</span>id_matrix <span class="free">nr</span> <span class="main">(</span>output_size' <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="free">m</span><span class="main">)</span> <span class="main">$</span> <span class="free">i</span>
 <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span><span class="main">&lt;</span>output_size' <span class="free">m</span> <span class="keyword1">then</span> tensors_from_net <span class="free">m</span> <span class="main">$</span> <span class="free">i</span> <span class="keyword1">else</span> tensor0 <span class="main">(</span>input_sizes <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">$</span> <span class="free">i</span> <span class="main">=</span> <span class="var">?b</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> tensor_lookup_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Tensor.dims <span class="main">(</span><span class="var">?a</span> <span class="main">$</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> input_sizes <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> dims_tensors_from_net
    id_matrix_dim<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> id_matrix_dim<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> input_sizes.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> output_size.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>
    output_size_correct_tensors remove_weights.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> valid_net.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> vec_setI<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Tensor.dims <span class="main">(</span><span class="var">?b</span><span class="main">)</span> <span class="main">=</span> input_sizes <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dims_tensors_from_net
    output_size_correct_tensors<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> dims_tensor0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vec_setI<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Tensor.dims <span class="main">(</span><span class="var">?a</span> <span class="main">$</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> Tensor.dims <span class="main">(</span><span class="var">?b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Convm</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Convm</span> <span class="main">=</span> Conv <span class="main">(</span>id_matrix <span class="free">nr</span> <span class="main">(</span>output_size' <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="free">m</span>"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="quoted">"<span class="skolem">is</span>"</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> Tensor.dims <span class="main">(</span><span class="var">?a</span><span class="main">$</span><span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> input_sizes <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Tensor.dims <span class="main">(</span><span class="var">?a</span><span class="main">$</span><span class="free">i</span><span class="main">)</span> <span class="main">=</span> input_sizes <span class="free">m</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_net' <span class="skolem">Convm</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms id_matrix_dim valid_net.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Convm_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"base_input <span class="free">m</span> <span class="skolem">is</span> <span class="main">=</span> base_input <span class="skolem">Convm</span> <span class="skolem">is</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Convm_def base_input_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> output_size' <span class="skolem">Convm</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Convm_def remove_weights.simps output_size.simps
    id_matrix_dim <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> input_sizes <span class="main">(</span>Conv <span class="main">(</span>id_matrix <span class="free">nr</span> <span class="main">(</span>output_size' <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">⊲</span> input_sizes <span class="free">m</span>›</span></span> input_sizes.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span>tensors_from_net <span class="main">(</span>Conv <span class="main">(</span>id_matrix <span class="free">nr</span> <span class="main">(</span>output_size' <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="free">m</span><span class="main">)</span> <span class="main">$</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">is</span> <span class="main">=</span> evaluate_net <span class="main">(</span>Conv <span class="main">(</span>id_matrix <span class="free">nr</span> <span class="main">(</span>output_size' <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="free">m</span><span class="main">)</span> <span class="main">(</span>base_input <span class="main">(</span>Conv <span class="main">(</span>id_matrix <span class="free">nr</span> <span class="main">(</span>output_size' <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="free">m</span><span class="main">)</span> <span class="skolem">is</span><span class="main">)</span> <span class="main">$</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Convm_def <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> output_size' <span class="skolem">Convm</span>›</span></span> <span class="quoted"><span class="quoted">‹valid_net' <span class="skolem">Convm</span>›</span></span> lookup_tensors_from_net <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lookup <span class="main">(</span>tensor0 <span class="main">(</span>input_sizes <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="skolem">is</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span>real<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">⊲</span> input_sizes <span class="free">m</span>›</span></span> lookup_tensor0<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Tensor.lookup <span class="main">(</span><span class="var">?a</span> <span class="main">$</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">is</span> <span class="main">=</span> Tensor.lookup <span class="var">?b</span> <span class="skolem">is</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> Convm_def <span class="quoted"><span class="quoted">‹base_input <span class="free">m</span> <span class="skolem">is</span> <span class="main">=</span> base_input <span class="skolem">Convm</span> <span class="skolem">is</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">⊲</span> input_sizes <span class="free">m</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span>
   base_input_length evaluate_net_Conv_id f1 lookup_tensors_from_net <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Deep_Model-evaluate_net_Conv_copy_first"><span class="command">lemma</span></span> evaluate_net_Conv_copy_first<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_net' <span class="free">m</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"input_sizes <span class="free">m</span> <span class="main">=</span> map dim_vec <span class="free">input</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">&lt;</span><span class="free">nr</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"output_size' <span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"evaluate_net <span class="main">(</span>Conv <span class="main">(</span>copy_first_matrix <span class="free">nr</span> <span class="main">(</span>output_size' <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="free">m</span><span class="main">)</span> <span class="free">input</span> <span class="main">$</span> <span class="free">j</span>
 <span class="main">=</span> evaluate_net <span class="free">m</span> <span class="free">input</span> <span class="main">$</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> evaluate_net.simps output_size_correct<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> mult_copy_first_matrix<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">j</span><span class="main">&lt;</span><span class="free">nr</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"evaluate_net <span class="free">m</span> <span class="free">input</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> dim_vec_of_list<span class="main">]</span>
  assms<span class="main">(</span>3<span class="main">)</span> copy_first_matrix_dim<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹output_size' <span class="free">m</span> <span class="main">=</span> dim_vec <span class="main">(</span>evaluate_net <span class="free">m</span> <span class="free">input</span><span class="main">)</span>›</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="DL_Deep_Model-tensors_from_net_Conv_copy_first"><span class="command">lemma</span></span> tensors_from_net_Conv_copy_first<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_net' <span class="free">m</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="free">nr</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"output_size' <span class="free">m</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tensors_from_net <span class="main">(</span>Conv <span class="main">(</span>copy_first_matrix <span class="free">nr</span> <span class="main">(</span>output_size' <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="free">m</span><span class="main">)</span> <span class="main">$</span> <span class="free">i</span> <span class="main">=</span> tensors_from_net <span class="free">m</span> <span class="main">$</span> <span class="main">0</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">$</span> <span class="free">i</span> <span class="main">=</span> <span class="var">?b</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> tensor_lookup_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Tensor.dims <span class="main">(</span><span class="var">?a</span><span class="main">$</span><span class="free">i</span><span class="main">)</span> <span class="main">=</span> input_sizes <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> copy_first_matrix_dim<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> copy_first_matrix_dim<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> dims_tensors_from_net
    input_sizes.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> output_size.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> output_size_correct_tensors remove_weights.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>
    valid_net.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> vec_setI<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Tensor.dims <span class="main">(</span><span class="var">?b</span><span class="main">)</span> <span class="main">=</span> input_sizes <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dims_tensors_from_net
    output_size_correct_tensors<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vec_setI<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Tensor.dims <span class="main">(</span><span class="var">?a</span><span class="main">$</span><span class="free">i</span><span class="main">)</span> <span class="main">=</span> Tensor.dims <span class="main">(</span><span class="var">?b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Convm</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Convm</span> <span class="main">=</span> Conv <span class="main">(</span>copy_first_matrix <span class="free">nr</span> <span class="main">(</span>output_size' <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="free">m</span>"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="quoted">"<span class="skolem">is</span>"</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> Tensor.dims <span class="main">(</span><span class="var">?a</span><span class="main">$</span><span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> input_sizes <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Tensor.dims <span class="main">(</span><span class="var">?a</span><span class="main">$</span><span class="free">i</span><span class="main">)</span> <span class="main">=</span> input_sizes <span class="free">m</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_net' <span class="skolem">Convm</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms copy_first_matrix_dim valid_net.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Convm_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"base_input <span class="free">m</span> <span class="skolem">is</span> <span class="main">=</span> base_input <span class="skolem">Convm</span> <span class="skolem">is</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Convm_def base_input_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> output_size' <span class="skolem">Convm</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Convm_def remove_weights.simps output_size.simps
    copy_first_matrix_dim <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Tensor.lookup <span class="main">(</span><span class="var">?a</span> <span class="main">$</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">is</span> <span class="main">=</span> Tensor.lookup <span class="var">?b</span> <span class="skolem">is</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Convm_def <span class="quoted"><span class="quoted">‹base_input <span class="free">m</span> <span class="skolem">is</span> <span class="main">=</span> base_input <span class="skolem">Convm</span> <span class="skolem">is</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> output_size' <span class="skolem">Convm</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">⊲</span> input_sizes <span class="free">m</span>›</span></span> <span class="quoted"><span class="quoted">‹valid_net' <span class="skolem">Convm</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> base_input_length
    evaluate_net_Conv_copy_first input_sizes.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> lookup_tensors_from_net<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Deep_Model-evaluate_net_Conv_all1"><span class="command">lemma</span></span> evaluate_net_Conv_all1<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_net' <span class="free">m</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"input_sizes <span class="free">m</span> <span class="main">=</span> map dim_vec <span class="free">input</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="free">nr</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"evaluate_net <span class="main">(</span>Conv <span class="main">(</span>all1_matrix <span class="free">nr</span> <span class="main">(</span>output_size' <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="free">m</span><span class="main">)</span> <span class="free">input</span> <span class="main">$</span> <span class="free">i</span>
 <span class="main">=</span> Groups_List.sum_list <span class="main">(</span>list_of_vec <span class="main">(</span>evaluate_net <span class="free">m</span> <span class="free">input</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> evaluate_net.simps output_size_correct<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> mult_all1_matrix<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span><span class="main">&lt;</span><span class="free">nr</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"evaluate_net <span class="free">m</span> <span class="free">input</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> dim_vec_of_list<span class="main">]</span>
  assms<span class="main">(</span>3<span class="main">)</span> all1_matrix_dim<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="DL_Deep_Model-tensors_from_net_Conv_all1"><span class="command">lemma</span></span> tensors_from_net_Conv_all1<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_net' <span class="free">m</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="free">nr</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tensors_from_net <span class="main">(</span>Conv <span class="main">(</span>all1_matrix <span class="free">nr</span> <span class="main">(</span>output_size' <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="free">m</span><span class="main">)</span> <span class="main">$</span> <span class="free">i</span>
 <span class="main">=</span> listsum <span class="main">(</span>input_sizes <span class="free">m</span><span class="main">)</span> <span class="main">(</span>list_of_vec <span class="main">(</span>tensors_from_net <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">$</span> <span class="free">i</span> <span class="main">=</span> <span class="var">?b</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> tensor_lookup_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> dim_vec <span class="var">?a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms all1_matrix_dim output_size.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>
    output_size_correct_tensors remove_weights.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> valid_net.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Tensor.dims <span class="main">(</span><span class="var">?a</span> <span class="main">$</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> Tensor.dims <span class="main">(</span><span class="var">?b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dims_tensors_from_net input_sizes.simps<span class="main">(</span>2<span class="main">)</span> listsum_dims
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> index_vec_of_list in_set_conv_nth length_list_of_vec vec_list vec_setI<span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Convm</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Convm</span> <span class="main">=</span> Conv <span class="main">(</span>all1_matrix <span class="free">nr</span> <span class="main">(</span>output_size' <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="free">m</span>"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="quoted">"<span class="skolem">is</span>"</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> Tensor.dims <span class="main">(</span><span class="var">?a</span> <span class="main">$</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> input_sizes <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> dim_vec <span class="var">?a</span>›</span></span> dims_tensors_from_net input_sizes.simps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> vec_setI<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> input_sizes <span class="skolem">Convm</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Convm_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_net' <span class="skolem">Convm</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Convm_def assms all1_matrix_dim valid_net.intros<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span> output_size' <span class="skolem">Convm</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Convm_def <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> dim_vec <span class="var">?a</span>›</span></span> <span class="quoted"><span class="quoted">‹valid_net' <span class="skolem">Convm</span>›</span></span>
    output_size_correct_tensors <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"base_input <span class="skolem">Convm</span> <span class="skolem">is</span> <span class="main">=</span> base_input <span class="free">m</span> <span class="skolem">is</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> base_input_def Convm_def input_sizes.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Tensor.lookup <span class="main">(</span><span class="var">?a</span> <span class="main">$</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">is</span> <span class="main">=</span> evaluate_net <span class="skolem">Convm</span> <span class="main">(</span>base_input <span class="skolem">Convm</span> <span class="skolem">is</span><span class="main">)</span> <span class="main">$</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lookup_tensors_from_net<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹valid_net' <span class="skolem">Convm</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">⊲</span> input_sizes <span class="skolem">Convm</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span><span class="main">&lt;</span> output_size' <span class="skolem">Convm</span>›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Convm_def <span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> monoid_add_class.sum_list <span class="main">(</span>list_of_vec <span class="main">(</span>evaluate_net <span class="free">m</span> <span class="main">(</span>base_input <span class="skolem">Convm</span> <span class="skolem">is</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> evaluate_net_Conv_all1 Convm_def <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">⊲</span> input_sizes <span class="skolem">Convm</span>›</span></span> assms base_input_length <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> <span class="free">nr</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> monoid_add_class.sum_list <span class="main">(</span>list_of_vec <span class="main">(</span>map_vec <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span>  lookup <span class="bound">A</span> <span class="skolem">is</span><span class="main">)</span><span class="main">(</span>tensors_from_net <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹base_input <span class="skolem">Convm</span> <span class="skolem">is</span> <span class="main">=</span> base_input <span class="free">m</span> <span class="skolem">is</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> lookup_tensors_from_net<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹valid_net' <span class="free">m</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">⊲</span> input_sizes <span class="free">m</span>›</span></span><span class="main">]</span>
     base_input_length<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">⊲</span> input_sizes <span class="free">m</span>›</span></span><span class="main">]</span> output_size_correct<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>  output_size_correct_tensors<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    eq_vecI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"evaluate_net <span class="free">m</span> <span class="main">(</span>base_input <span class="free">m</span> <span class="skolem">is</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"map_vec <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> lookup <span class="bound">A</span> <span class="skolem">is</span><span class="main">)</span> <span class="main">(</span>tensors_from_net <span class="free">m</span><span class="main">)</span>"</span></span><span class="main">]</span> index_map_vec<span class="main">(</span>1<span class="main">)</span> index_map_vec<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> monoid_add_class.sum_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span>  lookup <span class="bound">A</span> <span class="skolem">is</span><span class="main">)</span> <span class="main">(</span>list_of_vec <span class="main">(</span>tensors_from_net <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eq_vecI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"vec_of_list <span class="main">(</span>list_of_vec <span class="main">(</span>map_vec <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span>  lookup <span class="bound">A</span> <span class="skolem">is</span><span class="main">)</span><span class="main">(</span>tensors_from_net <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"vec_of_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span>  lookup <span class="bound">A</span> <span class="skolem">is</span><span class="main">)</span> <span class="main">(</span>list_of_vec <span class="main">(</span>tensors_from_net <span class="free">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>  dim_vec_of_list
    nth_list_of_vec length_map list_vec nth_map  index_map_vec<span class="main">(</span>1<span class="main">)</span> index_map_vec<span class="main">(</span>2<span class="main">)</span> vec_list
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Tensor.lookup <span class="var">?b</span> <span class="skolem">is</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> dims_tensors_from_net set_list_of_vec
    <span class="keyword1"><span class="command">using</span></span> lookup_listsum<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">⊲</span> input_sizes <span class="free">m</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"list_of_vec <span class="main">(</span>tensors_from_net <span class="free">m</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Tensor.lookup <span class="main">(</span><span class="var">?a</span> <span class="main">$</span> <span class="free">i</span><span class="main">)</span> <span class="skolem">is</span> <span class="main">=</span> Tensor.lookup <span class="var">?b</span> <span class="skolem">is</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">witness</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="entity">witness'</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">witness'</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">[]</span> <span class="main">=</span> Input <span class="free"><span class="bound"><span class="entity">Y</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">witness'</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="main">=</span> Pool <span class="main">(</span><span class="free">witness</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">witness</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">witness</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">=</span> Conv <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> length <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> id_matrix <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> length <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> all1_matrix <span class="keyword1">else</span> copy_first_matrix<span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">witness'</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">witness_l</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">==</span> witness <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">!</span><span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">!</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>tl <span class="main">(</span>tl <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">witness'_l</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">==</span> witness' <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">!</span><span class="main">0</span><span class="main">)</span> <span class="main">(</span>tl <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="DL_Deep_Model-witness_is_deep_model"><span class="command">lemma</span></span> witness_is_deep_model<span class="main">:</span> <span class="quoted"><span class="quoted">"remove_weights <span class="main">(</span>witness <span class="free">Y</span> <span class="free">r</span> <span class="free">rs</span><span class="main">)</span> <span class="main">=</span> deep_model <span class="free">Y</span> <span class="free">r</span> <span class="free">rs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">rs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Y</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> witness.simps witness'.simps deep_model.simps deep_model'.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_matrix_dim<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">r'</span> <span class="skolem">rs</span> <span class="skolem">Y</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> length <span class="main">(</span><span class="skolem">r'</span> <span class="main">#</span> <span class="skolem">rs</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> id_matrix <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> length <span class="main">(</span><span class="skolem">r'</span> <span class="main">#</span> <span class="skolem">rs</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> all1_matrix <span class="keyword1">else</span> copy_first_matrix<span class="main">)</span><span class="main">)</span> <span class="skolem">Y</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Y</span>"</span></span>
       <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> length <span class="main">(</span><span class="skolem">r'</span> <span class="main">#</span> <span class="skolem">rs</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> id_matrix <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> length <span class="main">(</span><span class="skolem">r'</span> <span class="main">#</span> <span class="skolem">rs</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> all1_matrix <span class="keyword1">else</span> copy_first_matrix<span class="main">)</span><span class="main">)</span> <span class="skolem">Y</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> all1_matrix_dim copy_first_matrix_dim<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> witness.simps <span class="keyword1"><span class="command">unfolding</span></span> witness'.simps <span class="keyword1"><span class="command">unfolding</span></span> remove_weights.simps
    <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Deep_Model-witness'_is_deep_model"><span class="command">lemma</span></span> witness'_is_deep_model<span class="main">:</span> <span class="quoted"><span class="quoted">"remove_weights <span class="main">(</span>witness' <span class="free">Y</span> <span class="free">rs</span><span class="main">)</span> <span class="main">=</span> deep_model' <span class="free">Y</span> <span class="free">rs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">rs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Y</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> witness.simps witness'.simps deep_model.simps deep_model'.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_matrix_dim<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">r</span> <span class="skolem">rs</span> <span class="skolem">Y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> length <span class="skolem">rs</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> id_matrix <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> length <span class="skolem">rs</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> all1_matrix <span class="keyword1">else</span> copy_first_matrix<span class="main">)</span><span class="main">)</span> <span class="skolem">Y</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Y</span>"</span></span>
       <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> length <span class="skolem">rs</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> id_matrix <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> length <span class="skolem">rs</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> all1_matrix <span class="keyword1">else</span> copy_first_matrix<span class="main">)</span><span class="main">)</span> <span class="skolem">Y</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> all1_matrix_dim copy_first_matrix_dim id_matrix_dim<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> witness'.simps <span class="keyword1"><span class="command">unfolding</span></span> witness.simps <span class="keyword1"><span class="command">unfolding</span></span> remove_weights.simps
    <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Deep_Model-witness_valid"><span class="command">lemma</span></span> witness_valid<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_net' <span class="main">(</span>witness <span class="free">Y</span> <span class="free">r</span> <span class="free">rs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> valid_deep_model witness_is_deep_model <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="DL_Deep_Model-witness'_valid"><span class="command">lemma</span></span> witness'_valid<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_net' <span class="main">(</span>witness' <span class="free">Y</span> <span class="free">rs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> valid_deep_model' witness'_is_deep_model <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="DL_Deep_Model-shared_weight_net_witness"><span class="command">lemma</span></span> shared_weight_net_witness<span class="main">:</span> <span class="quoted"><span class="quoted">"shared_weight_net <span class="main">(</span>witness <span class="free">Y</span> <span class="free">r</span> <span class="free">rs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">rs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">Y</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> witness.simps witness'.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> shared_weight_net_Conv shared_weight_net_Input<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">rs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> witness.simps witness'.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> shared_weight_net_Conv shared_weight_net_Input shared_weight_net_Pool<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1" id="DL_Deep_Model-witness_l0'"><span class="command">lemma</span></span> witness_l0'<span class="main">:</span> <span class="quoted"><span class="quoted">"witness' <span class="free">Y</span> <span class="main">[</span><span class="free">M</span><span class="main">]</span> <span class="main">=</span>
    <span class="main">(</span>Pool
      <span class="main">(</span>Conv <span class="main">(</span>id_matrix <span class="free">Y</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span>Input <span class="free">M</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>Conv <span class="main">(</span>id_matrix <span class="free">Y</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span>Input <span class="free">M</span><span class="main">)</span><span class="main">)</span>
    <span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> witness'.simps witness.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="DL_Deep_Model-witness_l1"><span class="command">lemma</span></span> witness_l1<span class="main">:</span> <span class="quoted"><span class="quoted">"witness <span class="free">Y</span> <span class="free">r0</span> <span class="main">[</span><span class="free">M</span><span class="main">]</span> <span class="main">=</span>
  Conv <span class="main">(</span>all1_matrix <span class="free">Y</span> <span class="free">r0</span><span class="main">)</span> <span class="main">(</span>witness' <span class="free">r0</span> <span class="main">[</span><span class="free">M</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> witness'.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="DL_Deep_Model-tensors_ht_l0"><span class="command">lemma</span></span> tensors_ht_l0<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">&lt;</span><span class="free">r0</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tensors_from_net <span class="main">(</span>Conv <span class="main">(</span>id_matrix <span class="free">r0</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span>Input <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="free">j</span>
 <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">j</span><span class="main">&lt;</span><span class="free">M</span> <span class="keyword1">then</span> unit_vec <span class="free">M</span> <span class="free">j</span> <span class="keyword1">else</span> tensor0 <span class="main">[</span><span class="free">M</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms input_sizes.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> output_size.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> remove_weights.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> tensors_from_net.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
  tensors_from_net_Conv_id valid_net.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> index_vec<span class="main">)</span>

<span class="keyword1" id="DL_Deep_Model-tensor_prod_unit_vec"><span class="command">lemma</span></span> tensor_prod_unit_vec<span class="main">:</span>
<span class="quoted"><span class="quoted">"unit_vec <span class="free">M</span> <span class="free">j</span> <span class="main">⊗</span> unit_vec <span class="free">M</span> <span class="free">j</span> <span class="main">=</span> tensor_from_lookup <span class="main">[</span><span class="free">M</span><span class="main">,</span><span class="free">M</span><span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">is</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">is</span><span class="main">=</span><span class="main">[</span><span class="free">j</span><span class="main">,</span><span class="free">j</span><span class="main">]</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span><span class="main">=</span><span class="var">?B</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> tensor_lookup_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Tensor.dims <span class="var">?A</span> <span class="main">=</span> Tensor.dims <span class="var">?B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons self_append_conv2 dims_unit_vec dims_tensor_prod dims_tensor_from_lookup<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="quoted">"<span class="skolem">is</span>"</span> <span class="keyword3"><span class="command">assume</span></span> is_valid<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> Tensor.dims <span class="main">(</span>unit_vec <span class="free">M</span> <span class="free">j</span> <span class="main">⊗</span> unit_vec <span class="free">M</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> <span class="main">[</span><span class="free">M</span><span class="main">,</span><span class="free">M</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Cons self_append_conv2 dims_unit_vec dims_tensor_prod<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i1</span></span> <span class="skolem"><span class="skolem">i2</span></span> <span class="keyword2"><span class="keyword">where</span></span> is_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">i1</span><span class="main">,</span> <span class="skolem">i2</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i1</span> <span class="main">&lt;</span> <span class="free">M</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i2</span> <span class="main">&lt;</span> <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> list.distinct<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">i1</span><span class="main">]</span> <span class="main">⊲</span> Tensor.dims <span class="main">(</span>unit_vec <span class="free">M</span> <span class="free">j</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">i2</span><span class="main">]</span> <span class="main">⊲</span> Tensor.dims <span class="main">(</span>unit_vec <span class="free">M</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_index.Cons valid_index.Nil dims_unit_vec<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">i1</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i2</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_split<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Tensor.lookup <span class="var">?A</span> <span class="skolem">is</span> <span class="main">=</span> Tensor.lookup <span class="var">?B</span> <span class="skolem">is</span>"</span></span>
     <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">i1</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i2</span><span class="main">]</span>›</span></span>
     lookup_tensor_prod<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="skolem">i1</span><span class="main">]</span> <span class="main">⊲</span> Tensor.dims <span class="main">(</span>unit_vec <span class="free">M</span> <span class="free">j</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">[</span><span class="skolem">i2</span><span class="main">]</span> <span class="main">⊲</span> Tensor.dims <span class="main">(</span>unit_vec <span class="free">M</span> <span class="free">j</span><span class="main">)</span>›</span></span><span class="main">]</span>
     lookup_tensor_from_lookup<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">⊲</span> <span class="main">[</span><span class="free">M</span><span class="main">,</span> <span class="free">M</span><span class="main">]</span>›</span></span><span class="main">,</span> <span class="operator">unfolded</span>  <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">i1</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">i2</span><span class="main">]</span>›</span></span><span class="main">]</span>
     lookup_unit_vec<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i1</span> <span class="main">&lt;</span> <span class="free">M</span>›</span></span><span class="main">]</span> lookup_unit_vec<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i2</span> <span class="main">&lt;</span> <span class="free">M</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Deep_Model-tensors_ht_l0'"><span class="command">lemma</span></span> tensors_ht_l0'<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">&lt;</span><span class="free">r0</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"tensors_from_net <span class="main">(</span>witness' <span class="free">r0</span> <span class="main">[</span><span class="free">M</span><span class="main">]</span><span class="main">)</span> <span class="main">$</span> <span class="free">j</span>
 <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">j</span><span class="main">&lt;</span><span class="free">M</span> <span class="keyword1">then</span> unit_vec <span class="free">M</span> <span class="free">j</span> <span class="main">⊗</span> unit_vec <span class="free">M</span> <span class="free">j</span> <span class="keyword1">else</span> tensor0 <span class="main">[</span><span class="free">M</span><span class="main">,</span><span class="free">M</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?b</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_net' <span class="main">(</span>Conv <span class="main">(</span>id_matrix <span class="free">r0</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span>Input <span class="free">M</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> convnet.inject<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.discI witness'.elims witness_l0' witness_valid<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> j_le<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> dim_vec <span class="main">(</span>tensors_from_net <span class="main">(</span>Conv <span class="main">(</span>id_matrix <span class="free">r0</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span>Input <span class="free">M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> output_size_correct_tensors<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹valid_net' <span class="main">(</span>Conv <span class="main">(</span>id_matrix <span class="free">r0</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span>Input <span class="free">M</span><span class="main">)</span><span class="main">)</span>›</span></span><span class="main">,</span>
    <span class="operator">unfolded</span> remove_weights.simps output_size.simps id_matrix_dim<span class="main">]</span>
    assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> tensors_from_net.simps<span class="main">(</span>3<span class="main">)</span> witness_l0' index_component_mult<span class="main">[</span><span class="operator">OF</span> j_le j_le<span class="main">]</span>  tensors_ht_l0<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Deep_Model-lookup_tensors_ht_l0'"><span class="command">lemma</span></span> lookup_tensors_ht_l0'<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">&lt;</span><span class="free">r0</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">⊲</span> <span class="main">[</span><span class="free">M</span><span class="main">,</span><span class="free">M</span><span class="main">]</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Tensor.lookup <span class="main">(</span>tensors_from_net <span class="main">(</span>witness' <span class="free">r0</span> <span class="main">[</span><span class="free">M</span><span class="main">]</span><span class="main">)</span> <span class="main">$</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="free">is</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">is</span><span class="main">=</span><span class="main">[</span><span class="free">j</span><span class="main">,</span><span class="free">j</span><span class="main">]</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">&lt;</span><span class="free">M</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">&lt;</span><span class="free">M</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> tensors_ht_l0'<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> tensor_prod_unit_vec
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">=</span> <span class="main">[</span><span class="free">j</span><span class="main">,</span><span class="free">j</span><span class="main">]</span>"</span></span><span class="main">)</span>  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span><span class="main">&lt;</span><span class="free">M</span>›</span></span> assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>lookup_tensor_from_lookup<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">j</span><span class="main">&lt;</span><span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">≠</span> <span class="main">[</span><span class="free">j</span><span class="main">,</span> <span class="free">j</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> list.distinct<span class="main">(</span>1<span class="main">)</span> nth_Cons_0 valid_index.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> tensors_ht_l0'<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> tensor_prod_unit_vec
    <span class="keyword1"><span class="command">using</span></span>  <span class="quoted"><span class="quoted">‹<span class="main">¬</span><span class="free">j</span><span class="main">&lt;</span><span class="free">M</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lookup_tensor0<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> <span class="quoted"><span class="quoted">‹<span class="free">is</span> <span class="main">≠</span> <span class="main">[</span><span class="free">j</span><span class="main">,</span> <span class="free">j</span><span class="main">]</span>›</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Deep_Model-lookup_tensors_ht_l1"><span class="command">lemma</span></span> lookup_tensors_ht_l1<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">r1</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">⊲</span> <span class="main">[</span><span class="free">M</span><span class="main">,</span><span class="free">M</span><span class="main">]</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Tensor.lookup <span class="main">(</span>tensors_from_net <span class="main">(</span>witness <span class="free">r1</span> <span class="free">r0</span> <span class="main">[</span><span class="free">M</span><span class="main">]</span><span class="main">)</span> <span class="main">$</span> <span class="free">j</span><span class="main">)</span> <span class="free">is</span>
   <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">is</span><span class="main">!</span><span class="main">0</span> <span class="main">=</span> <span class="free">is</span><span class="main">!</span><span class="main">1</span> <span class="main">∧</span> <span class="free">is</span><span class="main">!</span><span class="main">0</span><span class="main">&lt;</span><span class="free">r0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> witness_l0'_valid<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_net' <span class="main">(</span>witness' <span class="free">r0</span> <span class="main">[</span><span class="free">M</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> witness_l0'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_matrix_dim valid_net.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"input_sizes <span class="main">(</span>witness' <span class="free">r0</span> <span class="main">[</span><span class="free">M</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free">M</span><span class="main">,</span><span class="free">M</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> witness_l0' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"output_size' <span class="main">(</span>witness' <span class="free">r0</span> <span class="main">[</span><span class="free">M</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">r0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> witness_l0' <span class="keyword1"><span class="command">using</span></span> witness_l0'_valid
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> id_matrix_dim<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>tensors_from_net <span class="main">(</span>witness' <span class="free">r0</span> <span class="main">[</span><span class="free">M</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">r0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹output_size' <span class="main">(</span>witness' <span class="free">r0</span> <span class="main">[</span><span class="free">M</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">r0</span>›</span></span> witness_l0'_valid output_size_correct_tensors <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> all0_but1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">≠</span><span class="free">is</span><span class="main">!</span><span class="main">0</span> <span class="main">⟹</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free">r0</span> <span class="main">⟹</span> Tensor.lookup <span class="main">(</span>tensors_from_net <span class="main">(</span>witness' <span class="free">r0</span> <span class="main">[</span><span class="free">M</span><span class="main">]</span><span class="main">)</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span> <span class="free">is</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lookup_tensors_ht_l0' <span class="quoted"><span class="quoted">‹<span class="free">is</span> <span class="main">⊲</span> <span class="main">[</span><span class="free">M</span><span class="main">,</span> <span class="free">M</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>



  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tensors_from_net <span class="main">(</span>witness <span class="free">r1</span> <span class="free">r0</span> <span class="main">[</span><span class="free">M</span><span class="main">]</span><span class="main">)</span> <span class="main">$</span> <span class="free">j</span> <span class="main">=</span>
    Tensor_Plus.listsum <span class="main">[</span><span class="free">M</span><span class="main">,</span><span class="free">M</span><span class="main">]</span> <span class="main">(</span>list_of_vec <span class="main">(</span>tensors_from_net <span class="main">(</span>witness' <span class="free">r0</span> <span class="main">[</span><span class="free">M</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> witness_l1 <span class="keyword1"><span class="command">using</span></span> tensors_from_net_Conv_all1<span class="main">[</span><span class="operator">OF</span> witness_l0'_valid assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    witness_l0' <span class="quoted"><span class="quoted">‹output_size' <span class="main">(</span>witness' <span class="free">r0</span> <span class="main">[</span><span class="free">M</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">r0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Tensor.lookup <span class="main">(</span>tensors_from_net <span class="main">(</span>witness <span class="free">r1</span> <span class="free">r0</span> <span class="main">[</span><span class="free">M</span><span class="main">]</span><span class="main">)</span> <span class="main">$</span> <span class="free">j</span><span class="main">)</span> <span class="free">is</span>
    <span class="main">=</span> monoid_add_class.sum_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> Tensor.lookup <span class="bound">A</span> <span class="free">is</span><span class="main">)</span> <span class="main">(</span>list_of_vec <span class="main">(</span>tensors_from_net <span class="main">(</span>witness' <span class="free">r0</span> <span class="main">[</span><span class="free">M</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lookup_listsum<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">is</span> <span class="main">⊲</span> <span class="main">[</span><span class="free">M</span><span class="main">,</span> <span class="free">M</span><span class="main">]</span>›</span></span><span class="main">]</span>  <span class="quoted"><span class="quoted">‹input_sizes <span class="main">(</span>witness' <span class="free">r0</span> <span class="main">[</span><span class="free">M</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free">M</span><span class="main">,</span> <span class="free">M</span><span class="main">]</span>›</span></span>
    dims_tensors_from_net <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> set_list_of_vec<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> monoid_add_class.sum_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> lookup <span class="main">(</span>tensors_from_net <span class="main">(</span>witness' <span class="free">r0</span> <span class="main">[</span><span class="free">M</span><span class="main">]</span><span class="main">)</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span> <span class="free">is</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">r0</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> map_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">A</span><span class="main">.</span> Tensor.lookup <span class="bound">A</span> <span class="free">is</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span>tensors_from_net <span class="main">(</span>witness' <span class="free">r0</span> <span class="main">[</span><span class="free">M</span><span class="main">]</span><span class="main">)</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">r0</span><span class="main">]</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> list_of_vec_map <span class="quoted"><span class="quoted">‹dim_vec <span class="main">(</span>tensors_from_net <span class="main">(</span>witness' <span class="free">r0</span> <span class="main">[</span><span class="free">M</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">r0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> comp_apply map_eq_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">r0</span><span class="main">.</span> Tensor.lookup <span class="main">(</span><span class="main">(</span>tensors_from_net <span class="main">(</span>witness' <span class="free">r0</span> <span class="main">[</span><span class="free">M</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span> <span class="free">is</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_set_upt_conv_sum_list_nat atLeast0LessThan <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> atLeast_upt<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">is</span><span class="main">!</span><span class="main">0</span> <span class="main">=</span> <span class="free">is</span><span class="main">!</span><span class="main">1</span> <span class="main">∧</span> <span class="free">is</span><span class="main">!</span><span class="main">0</span><span class="main">&lt;</span><span class="free">r0</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">is</span><span class="main">!</span><span class="main">0</span><span class="main">&lt;</span><span class="free">r0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">r0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span><span class="main">!</span><span class="main">0</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">r0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">&lt;</span><span class="free">r0</span><span class="main">.</span> Tensor.lookup <span class="main">(</span><span class="main">(</span>tensors_from_net <span class="main">(</span>witness' <span class="free">r0</span> <span class="main">[</span><span class="free">M</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="bound">i</span><span class="main">)</span> <span class="free">is</span><span class="main">)</span>
      <span class="main">=</span> Tensor.lookup <span class="main">(</span>tensors_from_net <span class="main">(</span>witness' <span class="free">r0</span> <span class="main">[</span><span class="free">M</span><span class="main">]</span><span class="main">)</span> <span class="main">$</span> <span class="main">(</span><span class="free">is</span><span class="main">!</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free">is</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹dim_vec <span class="main">(</span>tensors_from_net <span class="main">(</span>witness' <span class="free">r0</span> <span class="main">[</span><span class="free">M</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">r0</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> sum.remove<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">r0</span><span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">is</span><span class="main">!</span><span class="main">0</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">r0</span><span class="main">}</span>›</span></span><span class="main">,</span>
        <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span>Tensor.lookup <span class="main">(</span>tensors_from_net <span class="main">(</span>witness' <span class="free">r0</span> <span class="main">[</span><span class="free">M</span><span class="main">]</span><span class="main">)</span><span class="main">$</span><span class="bound">i</span><span class="main">)</span> <span class="free">is</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> all0_but1 atLeast0LessThan <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> lookup_tensors_ht_l0' <span class="quoted"><span class="quoted">‹<span class="free">is</span> <span class="main">!</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">r0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">is</span> <span class="main">⊲</span> <span class="main">[</span><span class="free">M</span><span class="main">,</span> <span class="free">M</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> all0_but1 atLeast0LessThan sum.neutral <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Deep_Model-length_output_deep_model"><span class="command">lemma</span></span> length_output_deep_model<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"remove_weights <span class="free">m</span> <span class="main">=</span> deep_model_l <span class="free">rs</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>tensors_from_net <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="free">rs</span> <span class="main">!</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> output_size_correct_tensors valid_deep_model
   deep_model.elims output_size.simps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main">)</span>

<span class="keyword1" id="DL_Deep_Model-length_output_deep_model'"><span class="command">lemma</span></span> length_output_deep_model'<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"remove_weights <span class="free">m</span> <span class="main">=</span> deep_model'_l <span class="free">rs</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>tensors_from_net <span class="free">m</span><span class="main">)</span> <span class="main">=</span> <span class="free">rs</span> <span class="main">!</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> output_size_correct_tensors valid_deep_model'
   deep_model'.elims output_size.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms deep_model.elims<span class="main">)</span>

<span class="keyword1" id="DL_Deep_Model-length_output_witness"><span class="command">lemma</span></span> length_output_witness<span class="main">:</span>
<span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>tensors_from_net <span class="main">(</span>witness_l <span class="free">rs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">rs</span> <span class="main">!</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> length_output_deep_model witness_is_deep_model <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="DL_Deep_Model-length_output_witness'"><span class="command">lemma</span></span> length_output_witness'<span class="main">:</span>
<span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>tensors_from_net <span class="main">(</span>witness'_l <span class="free">rs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">rs</span> <span class="main">!</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> length_output_deep_model' witness'_is_deep_model <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="DL_Deep_Model-dims_output_deep_model"><span class="command">lemma</span></span> dims_output_deep_model<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">rs</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span><span class="main">∈</span>set <span class="free">rs</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">rs</span><span class="main">!</span><span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"remove_weights <span class="free">m</span> <span class="main">=</span> deep_model_l <span class="free">rs</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Tensor.dims <span class="main">(</span>tensors_from_net <span class="free">m</span> <span class="main">$</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> replicate <span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="main">(</span>length <span class="free">rs</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>last <span class="free">rs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> dims_tensors_from_net input_sizes_deep_model<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> output_size_correct_tensors valid_deep_model
  assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> input_sizes_remove_weights length_output_witness witness_is_deep_model <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> vec_setI<span class="main">)</span>

<span class="keyword1" id="DL_Deep_Model-dims_output_witness"><span class="command">lemma</span></span> dims_output_witness<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">rs</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span><span class="main">∈</span>set <span class="free">rs</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">rs</span><span class="main">!</span><span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Tensor.dims <span class="main">(</span>tensors_from_net <span class="main">(</span>witness_l <span class="free">rs</span><span class="main">)</span> <span class="main">$</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> replicate <span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="main">(</span>length <span class="free">rs</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>last <span class="free">rs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> dims_output_deep_model witness_is_deep_model assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="DL_Deep_Model-dims_output_deep_model'"><span class="command">lemma</span></span> dims_output_deep_model'<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">rs</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span><span class="main">∈</span>set <span class="free">rs</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">rs</span><span class="main">!</span><span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"remove_weights <span class="free">m</span> <span class="main">=</span> deep_model'_l <span class="free">rs</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Tensor.dims <span class="main">(</span>tensors_from_net <span class="free">m</span> <span class="main">$</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> replicate <span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="main">(</span>length <span class="free">rs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>last <span class="free">rs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>tensors_from_net <span class="free">m</span><span class="main">)</span> <span class="main">&gt;</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> length_output_deep_model' <span class="quoted"><span class="quoted">‹remove_weights <span class="free">m</span> <span class="main">=</span> deep_model'_l <span class="free">rs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">&lt;</span> <span class="free">rs</span><span class="main">!</span><span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Tensor.dims <span class="main">(</span>tensors_from_net <span class="free">m</span> <span class="main">$</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> input_sizes <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dims_tensors_from_net<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">m</span></span><span class="main">]</span> output_size_correct_tensors
    vec_setI <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> input_sizes_deep_model'
    input_sizes_remove_weights<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span><span class="main">,</span> <span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹remove_weights <span class="free">m</span> <span class="main">=</span> deep_model'_l <span class="free">rs</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Deep_Model-dims_output_witness'"><span class="command">lemma</span></span> dims_output_witness'<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">rs</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span><span class="main">∈</span>set <span class="free">rs</span> <span class="main">⟹</span> <span class="bound">r</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">rs</span><span class="main">!</span><span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Tensor.dims <span class="main">(</span>tensors_from_net <span class="main">(</span>witness'_l <span class="free">rs</span><span class="main">)</span> <span class="main">$</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> replicate <span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="main">(</span>length <span class="free">rs</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>last <span class="free">rs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> dims_output_deep_model' assms witness'_is_deep_model <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">ten2mat</span> <span class="main">==</span> matricize <span class="main">{</span><span class="bound">n</span><span class="main">.</span> even <span class="bound">n</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">mat2ten</span> <span class="main">==</span> dematricize <span class="main">{</span><span class="bound">n</span><span class="main">.</span> even <span class="bound">n</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> deep_model_correct_params <span class="main">=</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">shared_weights</span><span class="main">::</span><span class="quoted">bool</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">rs</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat list"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> deep<span class="main">:</span><span class="quoted"><span class="quoted">"length <span class="free">rs</span> <span class="main">≥</span> <span class="numeral">3</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> no_zeros<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span><span class="main">∈</span>set <span class="free">rs</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">r</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> min <span class="main">(</span>last <span class="free">rs</span><span class="main">)</span> <span class="main">(</span>last <span class="main">(</span>butlast <span class="free">rs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">N_half</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">^</span><span class="main">(</span>length <span class="free">rs</span> <span class="main">-</span> <span class="numeral">3</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">weight_space_dim</span> <span class="main">=</span> count_weights <span class="free">shared_weights</span> <span class="main">(</span>deep_model_l <span class="free">rs</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> deep_model_correct_params_y <span class="main">=</span> deep_model_correct_params <span class="main">+</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">y</span><span class="main">::</span><span class="quoted">nat</span>
<span class="keyword2"><span class="keyword">assumes</span></span> y_valid<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&lt;</span> <span class="free">rs</span> <span class="main">!</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> real tensor"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="free"><span class="bound"><span class="entity">ws</span></span></span> <span class="main">=</span> tensors_from_net <span class="main">(</span>insert_weights <span class="free">shared_weights</span> <span class="main">(</span>deep_model_l <span class="free">rs</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ws</span></span></span><span class="main">)</span> <span class="main">$</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">A'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> real mat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">A'</span> <span class="free"><span class="bound"><span class="entity">ws</span></span></span> <span class="main">=</span> ten2mat <span class="main">(</span>A <span class="free"><span class="bound"><span class="entity">ws</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1" id="DL_Deep_Model-dims_tensor_deep_model"><span class="command">lemma</span></span> dims_tensor_deep_model<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"remove_weights <span class="free">m</span> <span class="main">=</span> deep_model_l <span class="free">rs</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dims <span class="main">(</span>tensors_from_net <span class="free">m</span> <span class="main">$</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> replicate <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> N_half<span class="main">)</span> <span class="main">(</span>last <span class="free">rs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dims <span class="main">(</span>tensors_from_net <span class="free">m</span> <span class="main">$</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> replicate <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>length <span class="free">rs</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>last <span class="free">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dims_output_deep_model<span class="main">[</span><span class="operator">OF</span> _ no_zeros y_valid assms<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> less_imp_le_nat Suc_le_lessD deep numeral_3_eq_3
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> N_half_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_1 Suc_eq_plus1 Suc_le_lessD deep
    diff_diff_left less_numeral_extra<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> numeral_3_eq_3 power_eq_if zero_less_diff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Deep_Model-order_tensor_deep_model"><span class="command">lemma</span></span> order_tensor_deep_model<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"remove_weights <span class="free">m</span> <span class="main">=</span> deep_model_l <span class="free">rs</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"order <span class="main">(</span>tensors_from_net <span class="free">m</span> <span class="main">$</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> N_half"</span></span>
  <span class="keyword1"><span class="command">using</span></span> dims_tensor_deep_model <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1" id="DL_Deep_Model-dims_A"><span class="command">lemma</span></span> dims_A<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Tensor.dims <span class="main">(</span>A <span class="free">ws</span><span class="main">)</span> <span class="main">=</span> replicate <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> N_half<span class="main">)</span> <span class="main">(</span>last <span class="free">rs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> A_def
  <span class="keyword1"><span class="command">using</span></span> dims_tensor_deep_model remove_insert_weights <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="DL_Deep_Model-order_A"><span class="command">lemma</span></span> order_A<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"order <span class="main">(</span>A <span class="free">ws</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> N_half"</span></span> <span class="keyword1"><span class="command">using</span></span> dims_A length_replicate <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="DL_Deep_Model-dims_A'"><span class="command">lemma</span></span> dims_A'<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span>A' <span class="free">ws</span><span class="main">)</span> <span class="main">=</span> prod_list <span class="main">(</span>nths <span class="main">(</span>Tensor.dims <span class="main">(</span>A <span class="free">ws</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> even <span class="bound">n</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span>A' <span class="free">ws</span><span class="main">)</span> <span class="main">=</span> prod_list <span class="main">(</span>nths <span class="main">(</span>Tensor.dims <span class="main">(</span>A <span class="free">ws</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> odd <span class="bound">n</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> A'_def matricize_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A_def Collect_neg_eq<span class="main">)</span>

<span class="keyword1" id="DL_Deep_Model-dims_A'_pow"><span class="command">lemma</span></span> dims_A'_pow<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span>A' <span class="free">ws</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>last <span class="free">rs</span><span class="main">)</span> <span class="main">^</span> N_half"</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span>A' <span class="free">ws</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>last <span class="free">rs</span><span class="main">)</span> <span class="main">^</span> N_half"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> dims_A' dims_A nths_replicate set_le_in card_even card_odd prod_list_replicate
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>



<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Aw</span> <span class="main">=</span> tensors_from_net <span class="main">(</span>witness_l <span class="free">rs</span><span class="main">)</span> <span class="main">$</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Aw'</span> <span class="main">=</span> ten2mat Aw"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">witness_weights</span> <span class="main">=</span> extract_weights <span class="free">shared_weights</span> <span class="main">(</span>witness_l <span class="free">rs</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="DL_Deep_Model-witness_weights"><span class="command">lemma</span></span> witness_weights<span class="main">:</span><span class="quoted"><span class="quoted">"witness_l <span class="free">rs</span> <span class="main">=</span> insert_weights <span class="free">shared_weights</span> <span class="main">(</span>deep_model_l <span class="free">rs</span><span class="main">)</span> witness_weights"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> insert_extract_weights_cong_shared insert_extract_weights_cong_unshared shared_weight_net_witness witness_is_deep_model witness_weights_def<span class="main">)</span>

<span class="keyword1" id="DL_Deep_Model-Aw_def'"><span class="command">lemma</span></span> Aw_def'<span class="main">:</span> <span class="quoted"><span class="quoted">"Aw <span class="main">=</span> A witness_weights"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Aw_def A_def <span class="keyword1"><span class="command">using</span></span> witness_weights <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="DL_Deep_Model-Aw'_def'"><span class="command">lemma</span></span> Aw'_def'<span class="main">:</span> <span class="quoted"><span class="quoted">"Aw' <span class="main">=</span> A' witness_weights"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Aw'_def A'_def Aw_def' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="DL_Deep_Model-dims_Aw"><span class="command">lemma</span></span> dims_Aw<span class="main">:</span> <span class="quoted"><span class="quoted">"Tensor.dims Aw <span class="main">=</span> replicate <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> N_half<span class="main">)</span> <span class="main">(</span>last <span class="free">rs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Aw_def' <span class="keyword1"><span class="command">using</span></span> dims_A <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="DL_Deep_Model-order_Aw"><span class="command">lemma</span></span> order_Aw<span class="main">:</span> <span class="quoted"><span class="quoted">"order Aw <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> N_half"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Aw_def' <span class="keyword1"><span class="command">using</span></span> order_A <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="DL_Deep_Model-dims_Aw'"><span class="command">lemma</span></span> dims_Aw'<span class="main">:</span>
<span class="quoted"><span class="quoted">"dim_row Aw' <span class="main">=</span> prod_list <span class="main">(</span>nths <span class="main">(</span>Tensor.dims Aw<span class="main">)</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> even <span class="bound">n</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="quoted"><span class="quoted">"dim_col Aw' <span class="main">=</span> prod_list <span class="main">(</span>nths <span class="main">(</span>Tensor.dims Aw<span class="main">)</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> odd <span class="bound">n</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Aw'_def' Aw_def' <span class="keyword1"><span class="command">using</span></span> dims_A' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="DL_Deep_Model-dims_Aw'_pow"><span class="command">lemma</span></span> dims_Aw'_pow<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row Aw' <span class="main">=</span> <span class="main">(</span>last <span class="free">rs</span><span class="main">)</span> <span class="main">^</span> N_half"</span></span> <span class="quoted"><span class="quoted">"dim_col Aw' <span class="main">=</span> <span class="main">(</span>last <span class="free">rs</span><span class="main">)</span> <span class="main">^</span> N_half"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Aw'_def' Aw_def' <span class="keyword1"><span class="command">using</span></span> dims_A'_pow <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="DL_Deep_Model-witness_tensor"><span class="command">lemma</span></span> witness_tensor<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">⊲</span> Tensor.dims Aw"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Tensor.lookup Aw <span class="free">is</span>
   <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> nths <span class="free">is</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> even <span class="bound">n</span><span class="main">}</span> <span class="main">=</span> nths <span class="free">is</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> odd <span class="bound">n</span><span class="main">}</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>set <span class="free">is</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> last <span class="main">(</span>butlast <span class="free">rs</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms deep no_zeros y_valid <span class="keyword1"><span class="command">unfolding</span></span> Aw_def <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"butlast <span class="main">(</span>butlast <span class="main">(</span>butlast <span class="free">rs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">rs</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span>"</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">rs</span> <span class="main">=</span> <span class="numeral">3</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> Nil.hyps One_nat_def Suc_1 Suc_eq_plus1 add_2_eq_Suc' diff_diff_left
      length_butlast less_numeral_extra<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> not_le numeral_3_eq_3 zero_less_diff<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="numeral">3</span> <span class="main">≤</span> length <span class="skolem">rs</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rs</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">rs</span><span class="main">!</span><span class="main">0</span><span class="main">,</span> <span class="skolem">rs</span><span class="main">!</span><span class="main">1</span><span class="main">,</span> <span class="skolem">rs</span><span class="main">!</span><span class="numeral">2</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Cons_nth_drop_Suc One_nat_def Suc_eq_plus1
    append_Nil id_take_nth_drop length_0_conv length_tl lessI list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.size<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> not_le numeral_3_eq_3
    numeral_le_one_iff one_add_one semiring_norm<span class="main"><span class="main">(</span></span>70<span class="main"><span class="main">)</span></span> take_0 zero_less_Suc<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"input_sizes <span class="main">(</span>witness_l <span class="main">[</span><span class="skolem">rs</span> <span class="main">!</span> <span class="main">0</span><span class="main">,</span> <span class="skolem">rs</span> <span class="main">!</span> <span class="main">1</span><span class="main">,</span> <span class="skolem">rs</span> <span class="main">!</span> <span class="numeral">2</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">rs</span><span class="main">!</span><span class="numeral">2</span><span class="main">,</span> <span class="skolem">rs</span><span class="main">!</span><span class="numeral">2</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> witness.simps  witness'.simps input_sizes.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Tensor.dims <span class="main">(</span>tensors_from_net <span class="main">(</span>witness_l <span class="skolem">rs</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">rs</span><span class="main">!</span><span class="numeral">2</span><span class="main">,</span> <span class="skolem">rs</span><span class="main">!</span><span class="numeral">2</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dims_tensors_from_net<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"tensors_from_net <span class="main">(</span>witness_l <span class="skolem">rs</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"witness_l <span class="skolem">rs</span>"</span></span><span class="main">]</span>
      Nil.prems<span class="main">(</span>4<span class="main">)</span> length_output_witness <span class="quoted"><span class="quoted">‹<span class="skolem">rs</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">rs</span> <span class="main">!</span> <span class="main">0</span><span class="main">,</span> <span class="skolem">rs</span> <span class="main">!</span> <span class="main">1</span><span class="main">,</span> <span class="skolem">rs</span> <span class="main">!</span> <span class="numeral">2</span><span class="main">]</span>›</span></span> vec_setI <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> <span class="main">[</span><span class="skolem">rs</span><span class="main">!</span><span class="numeral">2</span><span class="main">,</span> <span class="skolem">rs</span><span class="main">!</span><span class="numeral">2</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Nil.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Tensor.lookup <span class="main">(</span><span class="main">(</span>tensors_from_net <span class="main">(</span>witness_l <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span><span class="main">$</span><span class="skolem">y</span><span class="main">)</span> <span class="skolem">is</span>
    <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">is</span> <span class="main">!</span> <span class="main">0</span> <span class="main">=</span> <span class="skolem">is</span> <span class="main">!</span> <span class="main">1</span> <span class="main">∧</span> <span class="skolem">is</span> <span class="main">!</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">rs</span> <span class="main">!</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Nil.prems<span class="main">(</span>4<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">rs</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">rs</span> <span class="main">!</span> <span class="main">0</span><span class="main">,</span> <span class="skolem">rs</span> <span class="main">!</span> <span class="main">1</span><span class="main">,</span> <span class="skolem">rs</span> <span class="main">!</span> <span class="numeral">2</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> lookup_tensors_ht_l1<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">!</span> <span class="main">0</span> <span class="main">=</span> <span class="skolem">is</span> <span class="main">!</span> <span class="main">1</span> <span class="main">∧</span> <span class="skolem">is</span> <span class="main">!</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">rs</span> <span class="main">!</span> <span class="main">1</span>
    <span class="main">⟷</span> nths <span class="skolem">is</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> even <span class="bound">n</span><span class="main">}</span> <span class="main">=</span> nths <span class="skolem">is</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> odd <span class="bound">n</span><span class="main">}</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>set <span class="skolem">is</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> last <span class="main">(</span>butlast <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">is</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_eq_plus1 <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">⊲</span> <span class="main">[</span><span class="skolem">rs</span> <span class="main">!</span> <span class="numeral">2</span><span class="main">,</span> <span class="skolem">rs</span> <span class="main">!</span> <span class="numeral">2</span><span class="main">]</span>›</span></span> list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.size<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> numeral_2_eq_2 valid_index_length<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nths <span class="skolem">is</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> even <span class="bound">n</span><span class="main">}</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">is</span><span class="main">!</span><span class="main">0</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nths_only_one<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> subset_antisym less_2_cases <span class="quoted"><span class="quoted">‹length <span class="skolem">is</span> <span class="main">=</span> <span class="numeral">2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nths <span class="skolem">is</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> odd <span class="bound">n</span><span class="main">}</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">is</span><span class="main">!</span><span class="main">1</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nths_only_one<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> subset_antisym less_2_cases <span class="quoted"><span class="quoted">‹length <span class="skolem">is</span> <span class="main">=</span> <span class="numeral">2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"last <span class="main">(</span>butlast <span class="skolem">rs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">rs</span><span class="main">!</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_eq_plus1 <span class="quoted"><span class="quoted">‹<span class="skolem">rs</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">rs</span> <span class="main">!</span> <span class="main">0</span><span class="main">,</span> <span class="skolem">rs</span> <span class="main">!</span> <span class="main">1</span><span class="main">,</span> <span class="skolem">rs</span> <span class="main">!</span> <span class="numeral">2</span><span class="main">]</span>›</span></span>
      append_butlast_last_id last_conv_nth length_butlast length_tl lessI list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span>
      list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.size<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> nat.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> nth_append<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹last <span class="main">(</span>butlast <span class="skolem">rs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">rs</span><span class="main">!</span><span class="main">1</span>›</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> conjI<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹nths <span class="skolem">is</span> <span class="main">(</span>Collect even<span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">is</span> <span class="main">!</span> <span class="main">0</span><span class="main">]</span>›</span></span> <span class="quoted"><span class="quoted">‹nths <span class="skolem">is</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> odd <span class="bound">n</span><span class="main">}</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">is</span> <span class="main">!</span> <span class="main">1</span><span class="main">]</span>›</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹length <span class="skolem">is</span> <span class="main">=</span> <span class="numeral">2</span>›</span></span> One_nat_def in_set_conv_nth less_2_cases<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹nths <span class="skolem">is</span> <span class="main">(</span>Collect even<span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">is</span> <span class="main">!</span> <span class="main">0</span><span class="main">]</span>›</span></span> <span class="quoted"><span class="quoted">‹nths <span class="skolem">is</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> odd <span class="bound">n</span><span class="main">}</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">is</span> <span class="main">!</span> <span class="main">1</span><span class="main">]</span>›</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">is</span> <span class="main">=</span> <span class="numeral">2</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹Tensor.lookup <span class="main">(</span>tensors_from_net <span class="main">(</span>witness_l <span class="skolem">rs</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">is</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">is</span> <span class="main">!</span> <span class="main">0</span> <span class="main">=</span> <span class="skolem">is</span> <span class="main">!</span> <span class="main">1</span> <span class="main">∧</span> <span class="skolem">is</span> <span class="main">!</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">rs</span> <span class="main">!</span> <span class="main">1</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> witness_is_deep_model witness_valid <span class="quoted"><span class="quoted">‹<span class="skolem">rs</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">rs</span> <span class="main">!</span> <span class="main">0</span><span class="main">,</span> <span class="skolem">rs</span> <span class="main">!</span> <span class="main">1</span><span class="main">,</span> <span class="skolem">rs</span> <span class="main">!</span> <span class="numeral">2</span><span class="main">]</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">r</span> <span class="skolem">rs'</span> <span class="skolem">rs</span> <span class="quoted">"<span class="skolem">is</span>"</span> <span class="skolem">j</span><span class="main">)</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We prove the Induction Hypothesis for "tl rs" and j=0:›</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rs</span> <span class="main">=</span> <span class="skolem">r</span> <span class="main">#</span> tl <span class="skolem">rs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> append_butlast_last_id butlast.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> hd_append2 list.collapse list.discI list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">rs'</span> <span class="main">=</span> butlast <span class="main">(</span>butlast <span class="main">(</span>butlast <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> butlast_tl list.sel<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="numeral">3</span> <span class="main">≤</span> length <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Cons.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>
    Nitpick.size_list_simp<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> One_nat_def Suc_eq_plus1 <span class="quoted"><span class="quoted">‹<span class="skolem">rs</span> <span class="main">=</span> <span class="skolem">r</span> <span class="main">#</span> tl <span class="skolem">rs</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">rs'</span> <span class="main">=</span> butlast <span class="main">(</span>butlast <span class="main">(</span>butlast <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span>
    diff_diff_left diff_self_eq_0 gr0_conv_Suc le_Suc_eq length_butlast length_tl less_numeral_extra<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> numeral_3_eq_3<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">∈</span> set <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> list.set_sel<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span> <span class="main">!</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2"</span> <span class="quoted">"3"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">is'</span><span class="main">.</span> <span class="bound">is'</span> <span class="main">⊲</span> Tensor.dims <span class="main">(</span>tensors_from_net <span class="main">(</span>witness_l <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="main">0</span><span class="main">)</span>
    <span class="main">⟹</span> Tensor.lookup <span class="main">(</span>tensors_from_net <span class="main">(</span>witness_l <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="main">0</span><span class="main">)</span> <span class="bound">is'</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> nths <span class="bound">is'</span> <span class="main">(</span>Collect even<span class="main">)</span> <span class="main">=</span> nths <span class="bound">is'</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> odd <span class="bound">n</span><span class="main">}</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>set <span class="bound">is'</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> last <span class="main">(</span>butlast <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span> <span class="quoted">"2"</span> <span class="quoted">"3"</span> 4 Cons.hyps<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The list "is" can be split in two parts:›</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> replicate <span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="main">(</span>length <span class="skolem">rs</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>last <span class="skolem">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons.prems<span class="main">(</span>3<span class="main">)</span> dims_output_witness 2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Cons.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Cons.prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span>
    Cons.prems<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> Nitpick.size_list_simp<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> One_nat_def diff_diff_left diff_is_0_eq length_tl
    nat_le_linear not_numeral_le_zero numeral_le_one_iff one_add_one semiring_norm<span class="main"><span class="main">(</span></span>70<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> replicate <span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="main">(</span>length <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>last <span class="skolem">rs</span><span class="main">)</span> <span class="main">@</span> replicate <span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="main">(</span>length <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>last <span class="skolem">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons.prems dims_output_witness <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2"</span> Nitpick.size_list_simp<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> One_nat_def
    diff_diff_left length_tl mult_2 not_numeral_le_zero numeral_le_one_iff one_add_one
    power.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> replicate_add semiring_norm<span class="main"><span class="main">(</span></span>70<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">is1</span></span> <span class="skolem"><span class="skolem">is2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">=</span> <span class="skolem">is1</span> <span class="main">@</span> <span class="skolem">is2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    is1_replicate<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">is1</span> <span class="main">⊲</span> replicate <span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="main">(</span>length <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>last <span class="skolem">rs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    is2_replicate<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">is2</span> <span class="main">⊲</span> replicate <span class="main">(</span><span class="numeral">2</span><span class="main">^</span><span class="main">(</span>length <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>last <span class="skolem">rs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> valid_index_split<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span>
    is1_valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">is1</span> <span class="main">⊲</span> Tensor.dims <span class="main">(</span>tensors_from_net <span class="main">(</span>witness_l <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?is1</span></span></span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
    is2_valid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">is2</span> <span class="main">⊲</span> Tensor.dims <span class="main">(</span>tensors_from_net <span class="main">(</span>witness_l <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?is2</span></span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"last <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span> <span class="main">=</span> last <span class="skolem">rs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2"</span> <span class="quoted"><span class="quoted">‹<span class="skolem">rs</span> <span class="main">=</span> <span class="skolem">r</span> <span class="main">#</span> tl <span class="skolem">rs</span>›</span></span> last_ConsR list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> not_numeral_le_zero<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?is1</span></span></span> <span class="var"><span class="quoted"><span class="var">?is2</span></span></span> <span class="keyword1"><span class="command">using</span></span> dims_output_witness<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"tl <span class="skolem">rs</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> dims_output_witness<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"tl <span class="skolem">rs</span>"</span></span><span class="main">]</span> 2 3 is1_replicate is2_replicate <span class="quoted"><span class="quoted">‹last <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span> <span class="main">=</span> last <span class="skolem">rs</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A shorthand for the condition to find a "1" in the tensor:›</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?cond</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">is</span> <span class="bound">rs</span><span class="main">.</span> nths <span class="bound">is</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> even <span class="bound">n</span><span class="main">}</span> <span class="main">=</span> nths <span class="bound">is</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> odd <span class="bound">n</span><span class="main">}</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>set <span class="bound">is</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> last <span class="main">(</span>butlast <span class="bound">rs</span><span class="main">)</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We can use the IH on our newly created is1 and is2:›</span></span>
  <span class="keyword1"><span class="command">have</span></span> IH_is12<span class="main">:</span>
    <span class="quoted"><span class="quoted">"Tensor.lookup <span class="main">(</span>tensors_from_net <span class="main">(</span>witness_l <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">is1</span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="var">?cond</span> <span class="skolem">is1</span> <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"Tensor.lookup <span class="main">(</span>tensors_from_net <span class="main">(</span>witness_l <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">is2</span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="var">?cond</span> <span class="skolem">is2</span> <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> IH is1_valid is2_valid <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In the induction step we have to add two layers: first the Pool layer, then the Conv layer.

        The Pool layer connects the two subtrees. Therefore the two conditions on is1 and is2 become
        one, and we have to prove that they are equivalent:›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?cond</span> <span class="skolem">is1</span> <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span> <span class="main">∧</span> <span class="var">?cond</span> <span class="skolem">is2</span> <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span> <span class="main">⟷</span> <span class="var">?cond</span> <span class="skolem">is</span> <span class="skolem">rs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">is1</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>length <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
         <span class="quoted"><span class="quoted">"length <span class="skolem">is2</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>length <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> is1_replicate is2_replicate <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_index_length<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"even <span class="main">(</span>length <span class="skolem">is1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"even <span class="main">(</span>length <span class="skolem">is2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> One_nat_def add_gr_0 diff_diff_left even_numeral even_power
      length_butlast length_tl list.size<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> one_add_one zero_less_Suc<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">+</span> length <span class="skolem">is1</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> even <span class="bound">n</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> even <span class="bound">n</span><span class="main">}</span>"</span></span>
              <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">+</span> length <span class="skolem">is1</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> odd <span class="bound">n</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> odd <span class="bound">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>nths <span class="skolem">is2</span> <span class="main">(</span>Collect even<span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>nths <span class="skolem">is2</span> <span class="main">(</span>Collect odd<span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> length_nths_even <span class="quoted"><span class="quoted">‹even <span class="main">(</span>length <span class="skolem">is2</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> cond1_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nths <span class="skolem">is1</span> <span class="main">(</span>Collect even<span class="main">)</span> <span class="main">=</span> nths <span class="skolem">is1</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> odd <span class="bound">n</span><span class="main">}</span> <span class="main">∧</span> nths <span class="skolem">is2</span> <span class="main">(</span>Collect even<span class="main">)</span> <span class="main">=</span> nths <span class="skolem">is2</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> odd <span class="bound">n</span><span class="main">}</span><span class="main">)</span>
          <span class="main">=</span> <span class="main">(</span>nths <span class="skolem">is</span> <span class="main">(</span>Collect even<span class="main">)</span> <span class="main">=</span> nths <span class="skolem">is</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> odd <span class="bound">n</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">=</span> <span class="skolem">is1</span> <span class="main">@</span> <span class="skolem">is2</span>›</span></span> nths_append
        <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">+</span> length <span class="skolem">is1</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> odd <span class="bound">n</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> odd <span class="bound">n</span><span class="main">}</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">+</span> length <span class="skolem">is1</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> even <span class="bound">n</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> even <span class="bound">n</span><span class="main">}</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹length <span class="main">(</span>nths <span class="skolem">is2</span> <span class="main">(</span>Collect even<span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>nths <span class="skolem">is2</span> <span class="main">(</span>Collect odd<span class="main">)</span><span class="main">)</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"last <span class="main">(</span>butlast <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> last <span class="main">(</span>butlast <span class="skolem">rs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Nitpick.size_list_simp<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹even <span class="main">(</span>length <span class="skolem">is1</span><span class="main">)</span>›</span></span>
      <span class="quoted"><span class="quoted">‹length <span class="skolem">is1</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>length <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span>›</span></span> butlast_tl last_tl length_butlast length_tl not_less_eq zero_less_diff
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Cons.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> length_Cons less_nat_zero_code<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> cond2_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>set <span class="skolem">is1</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> last <span class="main">(</span>butlast <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>set <span class="skolem">is2</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> last <span class="main">(</span>butlast <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>set <span class="skolem">is</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> last <span class="main">(</span>butlast <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹last <span class="main">(</span>butlast <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> last <span class="main">(</span>butlast <span class="skolem">rs</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">=</span> <span class="skolem">is1</span> <span class="main">@</span> <span class="skolem">is2</span>›</span></span> set_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> cond1_iff cond2_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now we can make the Pool layer step: ›</span></span>
  <span class="keyword1"><span class="command">have</span></span> lookup_witness'<span class="main">:</span> <span class="quoted"><span class="quoted">"Tensor.lookup <span class="main">(</span><span class="main">(</span>tensors_from_net <span class="main">(</span>witness' <span class="main">(</span><span class="skolem">rs</span> <span class="main">!</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>tl <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">is</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="var">?cond</span> <span class="skolem">is</span> <span class="skolem">rs</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> lookup_prod<span class="main">:</span> <span class="quoted"><span class="quoted">"Tensor.lookup <span class="main">(</span><span class="main">(</span>tensors_from_net <span class="main">(</span>witness_l <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊗</span> <span class="main">(</span>tensors_from_net <span class="main">(</span>witness_l <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">is</span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">if</span> <span class="var">?cond</span> <span class="skolem">is</span> <span class="skolem">rs</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?cond</span> <span class="skolem">is1</span> <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span> <span class="main">∧</span> <span class="var">?cond</span> <span class="skolem">is2</span> <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span> <span class="main">⟷</span> <span class="var">?cond</span> <span class="skolem">is</span> <span class="skolem">rs</span>›</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">=</span> <span class="skolem">is1</span> <span class="main">@</span> <span class="skolem">is2</span>›</span></span> lookup_tensor_prod<span class="main">[</span><span class="operator">OF</span> is1_valid is2_valid<span class="main">]</span> IH_is12
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> witness_l_tl<span class="main">:</span> <span class="quoted"><span class="quoted">"witness_l <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span> <span class="main">=</span> witness <span class="main">(</span><span class="skolem">rs</span> <span class="main">!</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">rs</span> <span class="main">!</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">(</span>tl <span class="main">(</span>tl <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_1 <span class="quoted"><span class="quoted">‹<span class="skolem">rs</span> <span class="main">=</span> <span class="skolem">r</span> <span class="main">#</span> tl <span class="skolem">rs</span>›</span></span> nth_Cons_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> tl_tl<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span>tl <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">rs</span> <span class="main">!</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">#</span> tl <span class="main">(</span>tl <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>tl <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span>  One_nat_def Suc_eq_plus1 diff_diff_left diff_is_0_eq length_tl not_less_eq_eq
        Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> numeral_3_eq_3<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tl <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.exhaust_sel nth_Cons_0 nth_Cons_Suc numeral_2_eq_2 tl_Nil<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> length_gt0<span class="main">:</span><span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>tensors_from_net <span class="main">(</span>witness <span class="main">(</span><span class="skolem">rs</span> <span class="main">!</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">rs</span> <span class="main">!</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">(</span>tl <span class="main">(</span>tl <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> output_size_correct_tensors<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"witness <span class="main">(</span><span class="skolem">rs</span> <span class="main">!</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">rs</span> <span class="main">!</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">(</span>tl <span class="main">(</span>tl <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
      witness_is_deep_model<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">rs</span> <span class="main">!</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rs</span> <span class="main">!</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"tl <span class="main">(</span>tl <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
      valid_deep_model<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">rs</span> <span class="main">!</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rs</span> <span class="main">!</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"tl <span class="main">(</span>tl <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span> output_size.simps witness.simps
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2"</span> <span class="quoted">"3"</span> One_nat_def <span class="quoted"><span class="quoted">‹<span class="skolem">rs</span> <span class="main">=</span> <span class="skolem">r</span> <span class="main">#</span> tl <span class="skolem">rs</span>›</span></span> deep_model.elims length_greater_0_conv list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span>
      not_numeral_le_zero nth_Cons_Suc nth_mem<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tensors_from_net <span class="main">(</span>witness' <span class="main">(</span><span class="skolem">rs</span> <span class="main">!</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="skolem">rs</span> <span class="main">!</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">#</span> tl <span class="main">(</span>tl <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="main">0</span>
       <span class="main">=</span> <span class="main">(</span>tensors_from_net <span class="main">(</span>witness_l <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊗</span> <span class="main">(</span>tensors_from_net <span class="main">(</span>witness_l <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> witness'.simps tensors_from_net.simps witness_l_tl <span class="keyword1"><span class="command">using</span></span> index_component_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> lookup_prod tl_tl <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Then we can make the Conv layer step: ›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_net' <span class="main">(</span>witness' <span class="main">(</span><span class="skolem">rs</span> <span class="main">!</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>tl <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> witness'_valid<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"output_size' <span class="main">(</span>witness' <span class="main">(</span><span class="skolem">rs</span> <span class="main">!</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>tl <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">rs</span> <span class="main">!</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2"</span> Nitpick.size_list_simp<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> diff_diff_left diff_is_0_eq hd_Cons_tl deep_model'.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> deep_model.elims length_tl not_less_eq_eq numeral_2_eq_2 numeral_3_eq_3 one_add_one output_size.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> output_size.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> tl_Nil witness'_is_deep_model<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> if_resolve<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> length <span class="main">(</span>tl <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> id_matrix <span class="keyword1">else</span> <span class="keyword1">if</span> length <span class="main">(</span>tl <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="keyword1">then</span> all1_matrix <span class="keyword1">else</span> copy_first_matrix<span class="main">)</span> <span class="main">=</span> copy_first_matrix"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"2"</span> Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Nitpick.size_list_simp<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> One_nat_def Suc_n_not_le_n not_numeral_le_zero numeral_3_eq_3<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tensors_from_net <span class="main">(</span>Conv <span class="main">(</span>copy_first_matrix <span class="main">(</span><span class="skolem">rs</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="skolem">rs</span> <span class="main">!</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>witness' <span class="main">(</span><span class="skolem">rs</span> <span class="main">!</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>tl <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">j</span> <span class="main">=</span>
      tensors_from_net <span class="main">(</span>witness' <span class="main">(</span><span class="skolem">rs</span> <span class="main">!</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>tl <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tensors_from_net_Conv_copy_first<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹valid_net' <span class="main">(</span>witness' <span class="main">(</span><span class="skolem">rs</span> <span class="main">!</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>tl <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">rs</span> <span class="main">!</span> <span class="main">0</span>›</span></span><span class="main">,</span> <span class="operator">unfolded</span> <span class="quoted"><span class="quoted">‹output_size' <span class="main">(</span>witness' <span class="main">(</span><span class="skolem">rs</span> <span class="main">!</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>tl <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">rs</span> <span class="main">!</span> <span class="main">1</span>›</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4"</span> One_nat_def <span class="quoted"><span class="quoted">‹<span class="skolem">rs</span> <span class="main">=</span> <span class="skolem">r</span> <span class="main">#</span> tl <span class="skolem">rs</span>›</span></span> nth_Cons_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> witness.simps if_resolve <span class="quoted"><span class="quoted">‹output_size' <span class="main">(</span>witness' <span class="main">(</span><span class="skolem">rs</span> <span class="main">!</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>tl <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">rs</span> <span class="main">!</span> <span class="main">1</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> lookup_witness' <span class="quoted"><span class="quoted">‹valid_net' <span class="main">(</span>witness' <span class="main">(</span><span class="skolem">rs</span> <span class="main">!</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>tl <span class="main">(</span>tl <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span> hd_conv_nth output_size_correct_tensors
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Deep_Model-witness_matricization"><span class="command">lemma</span></span> witness_matricization<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> dim_row Aw'"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> dim_col Aw'"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Aw' <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span>
 <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span><span class="main">=</span><span class="free">j</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i0</span><span class="main">∈</span>set <span class="main">(</span>digit_encode <span class="main">(</span>nths <span class="main">(</span>Tensor.dims Aw<span class="main">)</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> even <span class="bound">n</span><span class="main">}</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span><span class="main">.</span> <span class="bound">i0</span> <span class="main">&lt;</span> last <span class="main">(</span>butlast <span class="free">rs</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="quoted">"<span class="skolem"><span class="skolem">is</span></span>"</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">=</span> weave <span class="main">{</span><span class="bound">n</span><span class="main">.</span> even <span class="bound">n</span><span class="main">}</span>
    <span class="main">(</span>digit_encode <span class="main">(</span>nths <span class="main">(</span>Tensor.dims Aw<span class="main">)</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> even <span class="bound">n</span><span class="main">}</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span>
    <span class="main">(</span>digit_encode <span class="main">(</span>nths <span class="main">(</span>Tensor.dims Aw<span class="main">)</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> odd <span class="bound">n</span><span class="main">}</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> lookup_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"Aw' <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> Tensor.lookup Aw <span class="skolem">is</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Aw'_def matricize_def dims_Aw'<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">unfolded</span> A_def<span class="main">]</span> dims_Aw'<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">unfolded</span> A_def Collect_neg_eq<span class="main">]</span>
    index_mat<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> dim_row Aw'›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">&lt;</span> dim_col Aw'›</span></span><span class="main">]</span> is_def Collect_neg_eq case_prod_conv
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Aw'_def Collect_neg_eq  case_prod_conv is_def matricize_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">is</span> <span class="main">⊲</span> Tensor.dims Aw"</span></span>
    <span class="keyword1"><span class="command">using</span></span> is_def valid_index_weave A_def Collect_neg_eq assms digit_encode_valid_index
    dims_Aw' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"even <span class="main">(</span>order Aw<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Aw_def <span class="keyword1"><span class="command">using</span></span> assms dims_output_witness even_numeral le_eq_less_or_eq numeral_2_eq_2 numeral_3_eq_3 deep no_zeros y_valid <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1"><span class="command">have</span></span> nths_dimsAw<span class="main">:</span> <span class="quoted"><span class="quoted">"nths <span class="main">(</span>Tensor.dims Aw<span class="main">)</span> <span class="main">(</span>Collect even<span class="main">)</span> <span class="main">=</span> nths <span class="main">(</span>Tensor.dims Aw<span class="main">)</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> odd <span class="bound">n</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span><span class="quoted"><span class="quoted">"Tensor.dims <span class="main">(</span>tensors_from_net <span class="main">(</span>witness_l <span class="free">rs</span><span class="main">)</span> <span class="main">$</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> replicate <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>length <span class="free">rs</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>last <span class="free">rs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> dims_output_witness<span class="main">[</span><span class="operator">OF</span> _ no_zeros y_valid<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> deep <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> A_def
      <span class="keyword1"><span class="command">using</span></span> nths_replicate
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted">"0"</span> Aw_def <span class="quoted"><span class="quoted">‹even <span class="main">(</span>order Aw<span class="main">)</span>›</span></span> length_replicate length_nths_even<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="free">j</span> <span class="main">⟷</span> nths <span class="skolem">is</span> <span class="main">(</span>Collect even<span class="main">)</span> <span class="main">=</span> nths <span class="skolem">is</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> odd <span class="bound">n</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">have</span></span> eq_lengths<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>digit_encode <span class="main">(</span>nths <span class="main">(</span>Tensor.dims Aw<span class="main">)</span> <span class="main">(</span>Collect even<span class="main">)</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span>
        <span class="main">=</span> length <span class="main">(</span>digit_encode <span class="main">(</span>nths <span class="main">(</span>Tensor.dims Aw<span class="main">)</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> odd <span class="bound">n</span><span class="main">}</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> length_digit_encode <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹even <span class="main">(</span>order Aw<span class="main">)</span>›</span></span> length_nths_even<span class="main">)</span>

    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="free">j</span> <span class="main">⟹</span> nths <span class="skolem">is</span> <span class="main">(</span>Collect even<span class="main">)</span> <span class="main">=</span> nths <span class="skolem">is</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> odd <span class="bound">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_def
      <span class="keyword1"><span class="command">using</span></span> nths_weave<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"digit_encode <span class="main">(</span>nths <span class="main">(</span>Tensor.dims Aw<span class="main">)</span> <span class="main">(</span>Collect even<span class="main">)</span><span class="main">)</span> <span class="free">i</span>"</span></span>
      <span class="quoted"><span class="quoted">"Collect even"</span></span> <span class="quoted"><span class="quoted">"digit_encode <span class="main">(</span>nths <span class="main">(</span>Tensor.dims Aw<span class="main">)</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> odd <span class="bound">n</span><span class="main">}</span><span class="main">)</span> <span class="free">j</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> eq_lengths<span class="main">,</span> <span class="operator">unfolded</span> Collect_neg_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> card_even mult_2<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> card_odd<span class="main">]</span>
      nths_dimsAw <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nths <span class="skolem">is</span> <span class="main">(</span>Collect even<span class="main">)</span> <span class="main">=</span> nths <span class="skolem">is</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> odd <span class="bound">n</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">=</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_def
      <span class="keyword1"><span class="command">using</span></span> nths_weave<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"digit_encode <span class="main">(</span>nths <span class="main">(</span>Tensor.dims Aw<span class="main">)</span> <span class="main">(</span>Collect even<span class="main">)</span><span class="main">)</span> <span class="free">i</span>"</span></span>
      <span class="quoted"><span class="quoted">"Collect even"</span></span> <span class="quoted"><span class="quoted">"digit_encode <span class="main">(</span>nths <span class="main">(</span>Tensor.dims Aw<span class="main">)</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> odd <span class="bound">n</span><span class="main">}</span><span class="main">)</span> <span class="free">j</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> eq_lengths<span class="main">,</span> <span class="operator">unfolded</span> Collect_neg_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> card_even mult_2<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> card_odd<span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹nths <span class="main">(</span>Tensor.dims Aw<span class="main">)</span> <span class="main">(</span>Collect even<span class="main">)</span> <span class="main">=</span> nths <span class="main">(</span>Tensor.dims Aw<span class="main">)</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> odd <span class="bound">n</span><span class="main">}</span>›</span></span>
        deep no_zeros y_valid assms digit_decode_encode dims_Aw'
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> digit_decode_encode_lt<span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">=</span><span class="free">j</span> <span class="main">⟹</span> set <span class="main">(</span>digit_encode <span class="main">(</span>nths <span class="main">(</span>Tensor.dims Aw<span class="main">)</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> even <span class="bound">n</span><span class="main">}</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> set <span class="skolem">is</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_def nths_dimsAw
    <span class="keyword1"><span class="command">using</span></span> set_weave<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>digit_encode <span class="main">(</span>nths <span class="main">(</span>Tensor.dims Aw<span class="main">)</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> odd <span class="bound">n</span><span class="main">}</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Collect even"</span></span>
                       <span class="quoted"><span class="quoted">"<span class="main">(</span>digit_encode <span class="main">(</span>nths <span class="main">(</span>Tensor.dims Aw<span class="main">)</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> odd <span class="bound">n</span><span class="main">}</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span>"</span></span><span class="main">,</span>
                    <span class="operator">unfolded</span> mult_2<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> card_even Collect_neg_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> card_odd<span class="main">]</span>
    Un_absorb card_even card_odd mult_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> lookup_eq
    <span class="keyword1"><span class="command">using</span></span> witness_tensor<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">is</span> <span class="main">⊲</span> Tensor.dims Aw›</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A_def <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">i</span> <span class="main">=</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>nths <span class="skolem">is</span> <span class="main">(</span>Collect even<span class="main">)</span> <span class="main">=</span> nths <span class="skolem">is</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> odd <span class="bound">n</span><span class="main">}</span><span class="main">)</span>›</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">rows_with_1</span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i0</span><span class="main">∈</span>set <span class="main">(</span>digit_encode <span class="main">(</span>nths <span class="main">(</span>Tensor.dims Aw<span class="main">)</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> even <span class="bound">n</span><span class="main">}</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="bound">i0</span> <span class="main">&lt;</span> last <span class="main">(</span>butlast <span class="free">rs</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="DL_Deep_Model-card_low_digits"><span class="command">lemma</span></span> card_low_digits<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main">&gt;</span><span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span><span class="main">∈</span>set <span class="free">ds</span> <span class="main">⟹</span> <span class="free">m</span> <span class="main">≤</span> <span class="bound">d</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span>prod_list <span class="free">ds</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i0</span><span class="main">∈</span>set <span class="main">(</span>digit_encode <span class="free">ds</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="bound">i0</span> <span class="main">&lt;</span> <span class="free">m</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="free">m</span> <span class="main">^</span> <span class="main">(</span>length <span class="free">ds</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ds</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> prod_list.Nil <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">d</span> <span class="skolem">ds</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">low_digits</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">low_digits</span> <span class="skolem">ds</span> <span class="skolem">i</span> <span class="main">⟷</span> <span class="skolem">i</span> <span class="main">&lt;</span> prod_list <span class="skolem">ds</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i0</span><span class="main">∈</span>set <span class="main">(</span>digit_encode <span class="skolem">ds</span> <span class="skolem">i</span><span class="main">)</span><span class="main">.</span> <span class="bound">i0</span> <span class="main">&lt;</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ds</span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">low_digits</span> <span class="skolem">ds</span> <span class="bound">i</span><span class="main">}</span> <span class="main">=</span> <span class="free">m</span> <span class="main">^</span> <span class="main">(</span>length <span class="skolem">ds</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> low_digits_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons.IH Cons.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Cons.prems<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">low_digits</span> <span class="main">(</span><span class="skolem">d</span> <span class="main">#</span> <span class="skolem">ds</span><span class="main">)</span> <span class="bound">i</span><span class="main">}</span> <span class="main">=</span> card <span class="main">(</span><span class="main">{..&lt;</span><span class="free">m</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">low_digits</span> <span class="skolem">ds</span> <span class="bound">i</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">p</span> <span class="main">=</span> fst <span class="skolem">p</span> <span class="main">+</span> <span class="skolem">d</span> <span class="main">*</span> snd <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">p</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="skolem">f</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">m</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">low_digits</span> <span class="skolem">ds</span> <span class="bound">i</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> inj_onI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{..&lt;</span><span class="free">m</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">low_digits</span> <span class="skolem">ds</span> <span class="bound">i</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">{..&lt;</span><span class="free">m</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">low_digits</span> <span class="skolem">ds</span> <span class="bound">i</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">x</span><span class="main">&lt;</span><span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">y</span><span class="main">&lt;</span><span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">x</span><span class="main">&lt;</span><span class="skolem">d</span>"</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">y</span><span class="main">&lt;</span><span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> not_le order_trans<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="keyword1">mod</span> <span class="skolem">d</span> <span class="main">=</span> fst <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">y</span> <span class="keyword1">mod</span> <span class="skolem">d</span> <span class="main">=</span> fst <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="keyword1">div</span> <span class="skolem">d</span> <span class="main">=</span> snd <span class="skolem">x</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">y</span> <span class="keyword1">div</span> <span class="skolem">d</span> <span class="main">=</span> snd <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="skolem">x</span> <span class="keyword1">mod</span> <span class="skolem">d</span> <span class="main">=</span> fst <span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹fst <span class="skolem">y</span> <span class="main">&lt;</span> <span class="skolem">d</span>›</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="skolem">x</span> <span class="keyword1">div</span> <span class="skolem">d</span> <span class="main">=</span> snd <span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="skolem">x</span> <span class="keyword1">mod</span> <span class="skolem">d</span> <span class="main">=</span> fst <span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="skolem">y</span> <span class="keyword1">div</span> <span class="skolem">d</span> <span class="main">=</span> snd <span class="skolem">y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="skolem">y</span> <span class="keyword1">mod</span> <span class="skolem">d</span> <span class="main">=</span> fst <span class="skolem">y</span>›</span></span> prod_eqI <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">`</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">m</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">low_digits</span> <span class="skolem">ds</span> <span class="bound">i</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">low_digits</span> <span class="main">(</span><span class="skolem">d</span> <span class="main">#</span> <span class="skolem">ds</span><span class="main">)</span> <span class="bound">i</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subset_antisym<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> subsetI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">f</span> <span class="main">`</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">m</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">low_digits</span> <span class="skolem">ds</span> <span class="bound">i</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i0</span></span> <span class="skolem"><span class="skolem">i1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">i0</span> <span class="main">+</span> <span class="skolem">d</span> <span class="main">*</span> <span class="skolem">i1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i0</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">low_digits</span> <span class="skolem">ds</span> <span class="skolem">i1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i0</span><span class="main">&lt;</span><span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> not_le order_trans<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">low_digits</span> <span class="main">(</span><span class="skolem">d</span> <span class="main">#</span> <span class="skolem">ds</span><span class="main">)</span> <span class="bound">i</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> low_digits_def
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> conjI<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i1</span> <span class="main">&lt;</span> prod_list <span class="skolem">ds</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i0</span><span class="main">∈</span>set <span class="main">(</span>digit_encode <span class="skolem">ds</span> <span class="skolem">i1</span><span class="main">)</span><span class="main">.</span> <span class="bound">i0</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">low_digits</span> <span class="skolem">ds</span> <span class="skolem">i1</span>›</span></span> low_digits_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> prod_list <span class="main">(</span><span class="skolem">d</span> <span class="main">#</span> <span class="skolem">ds</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> prod_list.Cons <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">i0</span> <span class="main">+</span> <span class="skolem">d</span> <span class="main">*</span> <span class="skolem">i1</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i0</span><span class="main">&lt;</span><span class="skolem">d</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i1</span> <span class="main">&lt;</span> prod_list <span class="skolem">ds</span>›</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i0</span> <span class="main">&lt;</span> <span class="skolem">d</span>›</span></span> gr_implies_not0<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i0</span> <span class="main">+</span> <span class="skolem">d</span> <span class="main">*</span> <span class="skolem">i1</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span><span class="skolem">d</span> <span class="main">*</span> prod_list <span class="skolem">ds</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Divides.div_mult2_eq <span class="quoted"><span class="quoted">‹<span class="skolem">i0</span> <span class="main">&lt;</span> <span class="skolem">d</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i1</span> <span class="main">&lt;</span> prod_list <span class="skolem">ds</span>›</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i0</span> <span class="main">+</span> <span class="skolem">d</span> <span class="main">*</span> <span class="skolem">i1</span> <span class="main">&lt;</span> <span class="skolem">d</span> <span class="main">*</span> prod_list <span class="skolem">ds</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i0</span> <span class="main">&lt;</span> <span class="skolem">d</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i1</span> <span class="main">&lt;</span> prod_list <span class="skolem">ds</span>›</span></span> div_eq_0_iff gr_implies_not0 no_zero_divisors<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i0</span><span class="main">∈</span>set <span class="main">(</span>digit_encode <span class="main">(</span><span class="skolem">d</span> <span class="main">#</span> <span class="skolem">ds</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">i0</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">i0</span><span class="main">∈</span>set <span class="main">(</span>digit_encode <span class="skolem">ds</span> <span class="skolem">i1</span><span class="main">)</span><span class="main">.</span> <span class="bound">i0</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i0</span> <span class="main">&lt;</span> <span class="skolem">d</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i0</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">i0</span> <span class="main">+</span> <span class="skolem">d</span> <span class="main">*</span> <span class="skolem">i1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">low_digits</span> <span class="main">(</span><span class="skolem">d</span> <span class="main">#</span> <span class="skolem">ds</span><span class="main">)</span> <span class="bound">i</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> prod_list <span class="main">(</span><span class="skolem">d</span> <span class="main">#</span> <span class="skolem">ds</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i0</span><span class="main">∈</span>set <span class="main">(</span>digit_encode <span class="main">(</span><span class="skolem">d</span> <span class="main">#</span> <span class="skolem">ds</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">i0</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> low_digits_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">mod</span> <span class="skolem">d</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">i0</span><span class="main">∈</span>set <span class="main">(</span>digit_encode <span class="main">(</span><span class="skolem">d</span> <span class="main">#</span> <span class="skolem">ds</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">i0</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> digit_encode.simps<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="keyword1">div</span> <span class="skolem">d</span> <span class="main">&lt;</span> prod_list <span class="skolem">ds</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">&lt;</span> prod_list <span class="main">(</span><span class="skolem">d</span> <span class="main">#</span> <span class="skolem">ds</span><span class="main">)</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> prod_list.Cons<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> div_eq_0_iff div_mult2_eq mult_0_right not_less0<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i0</span><span class="main">∈</span>set <span class="main">(</span>digit_encode <span class="skolem">ds</span> <span class="main">(</span><span class="skolem">x</span> <span class="keyword1">div</span> <span class="skolem">d</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">i0</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">i0</span><span class="main">∈</span>set <span class="main">(</span>digit_encode <span class="main">(</span><span class="skolem">d</span> <span class="main">#</span> <span class="skolem">ds</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">i0</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">(</span><span class="main">(</span><span class="skolem">x</span> <span class="keyword1">mod</span> <span class="skolem">d</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="skolem">x</span> <span class="keyword1">div</span> <span class="skolem">d</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> f_def<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">f</span> <span class="main">`</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">m</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">low_digits</span> <span class="skolem">ds</span> <span class="bound">i</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> SigmaI <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">i0</span><span class="main">∈</span>set <span class="main">(</span>digit_encode <span class="skolem">ds</span> <span class="main">(</span><span class="skolem">x</span> <span class="keyword1">div</span> <span class="skolem">d</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">i0</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">(</span><span class="skolem">x</span> <span class="keyword1">mod</span> <span class="skolem">d</span><span class="main">,</span> <span class="skolem">x</span> <span class="keyword1">div</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="keyword1">div</span> <span class="skolem">d</span> <span class="main">&lt;</span> prod_list <span class="skolem">ds</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="keyword1">mod</span> <span class="skolem">d</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span> image_eqI lessThan_iff low_digits_def mem_Collect_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="skolem">f</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">m</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">low_digits</span> <span class="skolem">ds</span> <span class="bound">i</span><span class="main">}</span><span class="main">)</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">low_digits</span> <span class="main">(</span><span class="skolem">d</span> <span class="main">#</span> <span class="skolem">ds</span><span class="main">)</span> <span class="bound">i</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹inj_on <span class="skolem">f</span> <span class="main">(</span><span class="main">{..&lt;</span><span class="free">m</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">low_digits</span> <span class="skolem">ds</span> <span class="bound">i</span><span class="main">}</span><span class="main">)</span>›</span></span> bij_betw_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_betw_same_card<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹card <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">low_digits</span> <span class="skolem">ds</span> <span class="bound">i</span><span class="main">}</span> <span class="main">=</span> <span class="free">m</span> <span class="main">^</span> <span class="main">(</span>length <span class="skolem">ds</span><span class="main">)</span>›</span></span> card_cartesian_product <span class="keyword1"><span class="command">using</span></span> low_digits_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Deep_Model-card_rows_with_1"><span class="command">lemma</span></span> card_rows_with_1<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">i</span></span><span class="main">∈</span>rows_with_1<span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span>dim_row Aw'<span class="main">}</span> <span class="main">=</span> r <span class="main">^</span> N_half"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">i</span></span><span class="main">∈</span>rows_with_1<span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span>dim_row Aw'<span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> prod_list <span class="main">(</span>nths <span class="main">(</span>Tensor.dims Aw<span class="main">)</span> <span class="main">(</span>Collect even<span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
             <span class="main">(</span><span class="main">∀</span><span class="bound">i0</span><span class="main">∈</span>set <span class="main">(</span>digit_encode <span class="main">(</span>nths <span class="main">(</span>Tensor.dims Aw<span class="main">)</span> <span class="main">(</span>Collect even<span class="main">)</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="bound">i0</span> <span class="main">&lt;</span> r<span class="main">)</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="var">?B</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subset_antisym<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> subsetI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> dim_row Aw'"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i0</span><span class="main">∈</span>set <span class="main">(</span>digit_encode <span class="main">(</span>nths <span class="main">(</span>Tensor.dims Aw<span class="main">)</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> even <span class="bound">n</span><span class="main">}</span><span class="main">)</span> <span class="skolem">i</span><span class="main">)</span><span class="main">.</span> <span class="bound">i0</span> <span class="main">&lt;</span> last <span class="main">(</span>butlast <span class="free">rs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rows_with_1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> prod_list <span class="main">(</span>nths <span class="main">(</span>dims Aw<span class="main">)</span> <span class="main">(</span>Collect even<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dims_Aw' <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"digit_encode <span class="main">(</span>nths <span class="main">(</span>dims Aw<span class="main">)</span> <span class="main">(</span>Collect even<span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">⊲</span> nths <span class="main">(</span>dims Aw<span class="main">)</span> <span class="main">(</span>Collect even<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> digit_encode_valid_index <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i0</span><span class="main">∈</span>set <span class="main">(</span>digit_encode <span class="main">(</span>nths <span class="main">(</span>Tensor.dims Aw<span class="main">)</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> even <span class="bound">n</span><span class="main">}</span><span class="main">)</span> <span class="skolem">i</span><span class="main">)</span><span class="main">.</span> <span class="bound">i0</span> <span class="main">&lt;</span> r"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i0</span> <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">i0</span> <span class="main">∈</span> set <span class="main">(</span>digit_encode <span class="main">(</span>nths <span class="main">(</span>dims Aw<span class="main">)</span> <span class="main">(</span>Collect even<span class="main">)</span><span class="main">)</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">(</span>digit_encode <span class="main">(</span>nths <span class="main">(</span>dims Aw<span class="main">)</span> <span class="main">(</span>Collect even<span class="main">)</span><span class="main">)</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
              <span class="quoted"><span class="quoted">"digit_encode <span class="main">(</span>nths <span class="main">(</span>dims Aw<span class="main">)</span> <span class="main">(</span>Collect even<span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> <span class="skolem">i0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> in_set_conv_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i0</span> <span class="main">&lt;</span> last <span class="main">(</span>butlast <span class="free">rs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">i0</span><span class="main">∈</span>set <span class="main">(</span>digit_encode <span class="main">(</span>nths <span class="main">(</span>dims Aw<span class="main">)</span> <span class="main">(</span>Collect even<span class="main">)</span><span class="main">)</span> <span class="skolem">i</span><span class="main">)</span><span class="main">.</span> <span class="bound">i0</span> <span class="main">&lt;</span> last <span class="main">(</span>butlast <span class="free">rs</span><span class="main">)</span>›</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>nths <span class="main">(</span>dims Aw<span class="main">)</span> <span class="main">(</span>Collect even<span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>last <span class="free">rs</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dims_Aw <span class="keyword1"><span class="command">using</span></span> subset_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nths <span class="main">(</span>dims Aw<span class="main">)</span> <span class="main">(</span>Collect even<span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> last <span class="free">rs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹digit_encode <span class="main">(</span>nths <span class="main">(</span>dims Aw<span class="main">)</span> <span class="main">(</span>Collect even<span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">⊲</span> nths <span class="main">(</span>dims Aw<span class="main">)</span> <span class="main">(</span>Collect even<span class="main">)</span>›</span></span>
        <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">(</span>digit_encode <span class="main">(</span>nths <span class="main">(</span>dims Aw<span class="main">)</span> <span class="main">(</span>Collect even<span class="main">)</span><span class="main">)</span> <span class="skolem">i</span><span class="main">)</span>›</span></span>
        nth_mem valid_index_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i0</span> <span class="main">&lt;</span> last <span class="free">rs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> valid_index_lt <span class="quoted"><span class="quoted">‹digit_encode <span class="main">(</span>nths <span class="main">(</span>dims Aw<span class="main">)</span> <span class="main">(</span>Collect even<span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> <span class="skolem">i0</span>›</span></span>
        <span class="quoted"><span class="quoted">‹digit_encode <span class="main">(</span>nths <span class="main">(</span>dims Aw<span class="main">)</span> <span class="main">(</span>Collect even<span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> <span class="main">⊲</span> nths <span class="main">(</span>dims Aw<span class="main">)</span> <span class="main">(</span>Collect even<span class="main">)</span>›</span></span>
        <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">(</span>digit_encode <span class="main">(</span>nths <span class="main">(</span>dims Aw<span class="main">)</span> <span class="main">(</span>Collect even<span class="main">)</span><span class="main">)</span> <span class="skolem">i</span><span class="main">)</span>›</span></span> valid_index_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i0</span> <span class="main">&lt;</span> r"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> r_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i0</span> <span class="main">&lt;</span> last <span class="main">(</span>butlast <span class="free">rs</span><span class="main">)</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> prod_list <span class="main">(</span>nths <span class="main">(</span>dims Aw<span class="main">)</span> <span class="main">(</span>Collect even<span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">∈</span><span class="var">?B</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">∈</span><span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dims_Aw' r_def rows_with_1_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">d</span><span class="main">.</span> <span class="bound">d</span> <span class="main">∈</span> set <span class="main">(</span>nths <span class="main">(</span>Tensor.dims Aw<span class="main">)</span> <span class="main">(</span>Collect even<span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> r <span class="main">≤</span> <span class="bound">d</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">d</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> set <span class="main">(</span>nths <span class="main">(</span>Tensor.dims Aw<span class="main">)</span> <span class="main">(</span>Collect even<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">∈</span> set <span class="main">(</span>Tensor.dims Aw<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> in_set_nthsD <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">=</span> last <span class="free">rs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dims_Aw <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"r <span class="main">≤</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> r_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> r"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> r_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> deep diff_diff_cancel diff_zero dual_order.trans in_set_butlastD last_in_set length_butlast list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> min_def nat_le_linear no_zeros not_numeral_le_zero numeral_le_one_iff rel_simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>nths <span class="main">(</span>Tensor.dims Aw<span class="main">)</span> <span class="main">(</span>Collect even<span class="main">)</span><span class="main">)</span> <span class="main">=</span> N_half"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> length_nths order_Aw <span class="keyword1"><span class="command">using</span></span> card_even<span class="main">[</span><span class="operator">of</span> <span class="quoted">N_half</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Collect_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> card_low_digits<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"r"</span></span> <span class="quoted"><span class="quoted">"nths <span class="main">(</span>Tensor.dims Aw<span class="main">)</span> <span class="main">(</span>Collect even<span class="main">)</span>"</span></span><span class="main">]</span> 1 2 3 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="DL_Deep_Model-infinite_rows_with_1"><span class="command">lemma</span></span> infinite_rows_with_1<span class="main">:</span> <span class="quoted"><span class="quoted">"infinite rows_with_1"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">listpr</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">listpr</span> <span class="main">=</span> prod_list <span class="main">(</span>nths <span class="main">(</span>Tensor.dims Aw<span class="main">)</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> even <span class="bound">n</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">listpr</span> <span class="keyword1">dvd</span> <span class="bound">i</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">∈</span> rows_with_1"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> dvd_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">listpr</span> <span class="keyword1">dvd</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i0</span><span class="main">::</span><span class="quoted">nat</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i0</span><span class="main">∈</span>set <span class="main">(</span>digit_encode <span class="main">(</span>nths <span class="main">(</span>Tensor.dims Aw<span class="main">)</span> <span class="main">{</span><span class="bound">n</span><span class="main">.</span> even <span class="bound">n</span><span class="main">}</span><span class="main">)</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i0</span><span class="main">=</span><span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> digit_encode_0 dvd_i listpr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i0</span> <span class="main">&lt;</span> last <span class="main">(</span>butlast <span class="free">rs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> deep no_zeros
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Nitpick.size_list_simp<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> One_nat_def Suc_le_lessD in_set_butlastD last_in_set length_butlast length_tl not_numeral_less_zero numeral_2_eq_2 numeral_3_eq_3 numeral_le_one_iff semiring_norm<span class="main"><span class="main">(</span></span>70<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">∈</span>rows_with_1"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rows_with_1_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span><span class="quoted"><span class="quoted">"Tensor.dims Aw <span class="main">=</span> replicate <span class="main">(</span><span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>length <span class="free">rs</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>last <span class="free">rs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Aw_def
      <span class="keyword1"><span class="command">using</span></span> dims_output_witness<span class="main">[</span><span class="operator">OF</span> _ no_zeros y_valid<span class="main">]</span>  <span class="keyword1"><span class="command">using</span></span> deep <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">listpr</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> listpr_def 0
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"0"</span> deep last_in_set length_greater_0_conv less_le_trans no_zeros dims_Aw'_pow<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> dims_Aw'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
    zero_less_numeral zero_less_power<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj <span class="main">(</span><span class="main">(*)</span> <span class="skolem">listpr</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> injI mult_left_cancel neq0_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">listpr</span> <span class="keyword1">dvd</span> <span class="bound">i</span> <span class="main">⟹</span> <span class="bound">i</span> <span class="main">∈</span> rows_with_1›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> dvd_triv_left image_subset_iff infinite_iff_countable_subset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Deep_Model-witness_submatrix"><span class="command">lemma</span></span> witness_submatrix<span class="main">:</span> <span class="quoted"><span class="quoted">"submatrix Aw' rows_with_1 rows_with_1 <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>r<span class="main">^</span>N_half<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span>submatrix Aw' rows_with_1 rows_with_1<span class="main">)</span> <span class="main">=</span> dim_row <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>r <span class="main">^</span> N_half<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> index_one_mat<span class="main">(</span>2<span class="main">)</span> dim_submatrix<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> set_le_in card_rows_with_1<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span>submatrix Aw' rows_with_1 rows_with_1<span class="main">)</span> <span class="main">=</span> dim_col <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>r <span class="main">^</span> N_half<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹dim_row <span class="main">(</span>submatrix Aw' rows_with_1 rows_with_1<span class="main">)</span> <span class="main">=</span> dim_row <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>r <span class="main">^</span> N_half<span class="main">)</span><span class="main">)</span>›</span></span> dim_submatrix<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> dim_submatrix<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> index_one_mat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> index_one_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> dims_Aw'_pow<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> dim_row <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>r <span class="main">^</span> N_half<span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
           <span class="bound">j</span> <span class="main">&lt;</span> dim_col <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>r <span class="main">^</span> N_half<span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> submatrix Aw' rows_with_1 rows_with_1 <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>r <span class="main">^</span> N_half<span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> dim_row <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>r <span class="main">^</span> N_half<span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> dim_col <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>r <span class="main">^</span> N_half<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> r <span class="main">^</span> N_half"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> r <span class="main">^</span> N_half"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> rows_with_1<span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> dim_row Aw'<span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> rows_with_1<span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> dim_col Aw'<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> card_rows_with_1 dims_Aw'_pow <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pick rows_with_1 <span class="skolem">i</span> <span class="main">&lt;</span> dim_row Aw'"</span></span> <span class="quoted"><span class="quoted">"pick rows_with_1 <span class="skolem">j</span> <span class="main">&lt;</span> dim_col Aw'"</span></span>
      <span class="keyword1"><span class="command">using</span></span> card_le_pick_inf<span class="main">[</span><span class="operator">OF</span> infinite_rows_with_1<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"dim_row Aw'"</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> card_le_pick_inf<span class="main">[</span><span class="operator">OF</span> infinite_rows_with_1<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"dim_col Aw'"</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i0</span><span class="main">∈</span>set <span class="main">(</span>digit_encode <span class="main">(</span>nths <span class="main">(</span>dims Aw<span class="main">)</span> <span class="main">(</span>Collect even<span class="main">)</span><span class="main">)</span> <span class="main">(</span>pick rows_with_1 <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">i0</span> <span class="main">&lt;</span> last <span class="main">(</span>butlast <span class="free">rs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> infinite_rows_with_1 pick_in_set_inf rows_with_1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Aw' <span class="main">$$</span> <span class="main">(</span>pick rows_with_1 <span class="skolem">i</span><span class="main">,</span> pick rows_with_1 <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> pick rows_with_1 <span class="skolem">i</span> <span class="main">=</span> pick rows_with_1 <span class="skolem">j</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> witness_matricization<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹pick rows_with_1 <span class="skolem">i</span> <span class="main">&lt;</span> dim_row Aw'›</span></span> <span class="quoted"><span class="quoted">‹pick rows_with_1 <span class="skolem">j</span> <span class="main">&lt;</span> dim_col Aw'›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"submatrix Aw' rows_with_1 rows_with_1 <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> pick rows_with_1 <span class="skolem">i</span> <span class="main">=</span> pick rows_with_1 <span class="skolem">j</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> submatrix_index <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span>
      <span class="quoted"><span class="quoted">‹dim_col <span class="main">(</span>submatrix Aw' rows_with_1 rows_with_1<span class="main">)</span> <span class="main">=</span> dim_col <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>r <span class="main">^</span> N_half<span class="main">)</span><span class="main">)</span>›</span></span>
      <span class="quoted"><span class="quoted">‹dim_row <span class="main">(</span>submatrix Aw' rows_with_1 rows_with_1<span class="main">)</span> <span class="main">=</span> dim_row <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>r <span class="main">^</span> N_half<span class="main">)</span><span class="main">)</span>›</span></span>
      <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> dim_row <span class="main">(</span><span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>r <span class="main">^</span> N_half<span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> r <span class="main">^</span> N_half›</span></span> dim_submatrix<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> dim_submatrix<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> index_one_mat<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"submatrix Aw' rows_with_1 rows_with_1 <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">j</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pick_eq_iff_inf<span class="main">[</span><span class="operator">OF</span> infinite_rows_with_1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"submatrix Aw' rows_with_1 rows_with_1 <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">1<span class="hidden">⇩</span><sub>m</sub></span> <span class="main">(</span>r <span class="main">^</span> N_half<span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> r <span class="main">^</span> N_half›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> r <span class="main">^</span> N_half›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Deep_Model-witness_det"><span class="command">lemma</span></span> witness_det<span class="main">:</span> <span class="quoted"><span class="quoted">"det <span class="main">(</span>submatrix Aw' rows_with_1 rows_with_1<span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> witness_submatrix <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* Examples to show that the locales can be instantiated: *)</span>

<span class="keyword1"><span class="command">interpretation</span></span> example <span class="main">:</span> deep_model_correct_params <span class="quoted">False</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="numeral">10</span><span class="main">,</span><span class="numeral">10</span><span class="main">,</span><span class="numeral">10</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> deep_model_correct_params_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">interpretation</span></span> example <span class="main">:</span> deep_model_correct_params_y <span class="quoted">False</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="numeral">10</span><span class="main">,</span><span class="numeral">10</span><span class="main">,</span><span class="numeral">10</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="main">1</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> deep_model_correct_params_y_def deep_model_correct_params_y_axioms_def 
  deep_model_correct_params_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="DL_Deep_Model_Poly">
<div class="head">
<h1>Theory DL_Deep_Model_Poly</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Alexander Bentkamp, Universität des Saarlandes
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Polynomials representing the Deep Network Model›</span></span>

<span class="keyword1"><span class="command">theory</span></span> DL_Deep_Model_Poly
<span class="keyword2"><span class="keyword">imports</span></span> <a href="DL_Deep_Model.html">DL_Deep_Model</a> <a href="../Polynomials/More_MPoly_Type.html">Polynomials.More_MPoly_Type</a> <a href="../Jordan_Normal_Form/Determinant.html">Jordan_Normal_Form.Determinant</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="DL_Deep_Model_Poly-polyfun_det"><span class="command">lemma</span></span> polyfun_det<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> carrier_mat <span class="free">n</span> <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free">n</span> <span class="main">⟹</span> <span class="bound">j</span><span class="main">&lt;</span><span class="free">n</span> <span class="main">⟹</span> polyfun <span class="free">N</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="bound">x</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"polyfun <span class="free">N</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> det <span class="main">(</span><span class="free">A</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">∈</span> <span class="main">{</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="keyword1">permutes</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="keyword1">permutes</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="skolem">p</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> permutes_in_image <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"polyfun <span class="free">N</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∏</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> <span class="free">A</span> <span class="bound">x</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="skolem">p</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> polyfun_Prod<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="free">N</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span> <span class="bound">x</span><span class="main">.</span> <span class="free">A</span> <span class="bound">x</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="skolem">p</span> <span class="bound">i</span><span class="main">)</span>"</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"polyfun <span class="free">N</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> signof <span class="skolem">p</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> <span class="free">A</span> <span class="bound">x</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="skolem">p</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> polyfun_const polyfun_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="keyword1">permutes</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_permutations<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  <span class="keyword1"><span class="command">unfolding</span></span> det_def'<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> polyfun_Sum<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="keyword1">permutes</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">}</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">N</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span> <span class="bound">x</span><span class="main">.</span> signof <span class="bound">p</span> <span class="main">*</span> <span class="main">(</span><span class="main">∏</span><span class="bound">i</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">.</span> <span class="free">A</span> <span class="bound">x</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">p</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Deep_Model_Poly-polyfun_extract_matrix"><span class="command">lemma</span></span> polyfun_extract_matrix<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">&lt;</span><span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"polyfun <span class="main">{..&lt;</span><span class="free">a</span> <span class="main">+</span> <span class="main">(</span><span class="free">m</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="free">c</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> extract_matrix <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">f</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="free">m</span> <span class="free">n</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> index_extract_matrix<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> polyfun_single<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> two_digit_le<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="DL_Deep_Model_Poly-polyfun_mult_mat_vec"><span class="command">lemma</span></span> polyfun_mult_mat_vec<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">v</span> <span class="bound">x</span> <span class="main">∈</span> carrier_vec <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span><span class="main">&lt;</span><span class="free">n</span> <span class="main">⟹</span> polyfun <span class="free">N</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">v</span> <span class="bound">x</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">A</span> <span class="bound">x</span> <span class="main">∈</span> carrier_mat <span class="free">m</span> <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free">m</span> <span class="main">⟹</span> <span class="bound">j</span><span class="main">&lt;</span><span class="free">n</span> <span class="main">⟹</span> polyfun <span class="free">N</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">A</span> <span class="bound">x</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"polyfun <span class="free">N</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>v</sub></span> <span class="main">(</span><span class="free">v</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="free">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">j</span> <span class="main">&lt;</span> dim_row <span class="main">(</span><span class="free">A</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span> assms<span class="main">(</span>3<span class="main">)</span> carrier_matD<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">n</span> <span class="main">=</span> dim_vec <span class="main">(</span><span class="free">v</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> carrier_vecD <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> dim_vec <span class="main">(</span><span class="free">v</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> carrier_vecD <span class="quoted"><span class="quoted">‹<span class="skolem">i</span><span class="main">&lt;</span><span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> dim_row <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span> assms<span class="main">(</span>3<span class="main">)</span> carrier_matD<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> dim_vec <span class="main">(</span><span class="free">v</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> carrier_matD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> carrier_vecD<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"row <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">j</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">$$</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span><span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">&lt;</span> dim_row <span class="main">(</span><span class="free">A</span> <span class="skolem">x</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span><span class="main">&lt;</span><span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> dim_vec <span class="main">(</span><span class="free">v</span> <span class="skolem">x</span><span class="main">)</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"polyfun <span class="free">N</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> row <span class="main">(</span><span class="free">A</span> <span class="bound">x</span><span class="main">)</span> <span class="free">j</span> <span class="main">$</span> <span class="skolem">i</span> <span class="main">*</span> <span class="free">v</span> <span class="bound">x</span> <span class="main">$</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> polyfun_mult assms<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">&lt;</span> <span class="free">m</span>›</span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> index_mult_mat_vec<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">j</span> <span class="main">&lt;</span> dim_row <span class="main">(</span><span class="free">A</span> <span class="bound">x</span><span class="main">)</span>›</span></span><span class="main">]</span> scalar_prod_def
    <span class="keyword1"><span class="command">using</span></span> polyfun_Sum<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="free">N</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span> <span class="bound">x</span><span class="main">.</span> row <span class="main">(</span><span class="free">A</span> <span class="bound">x</span><span class="main">)</span> <span class="free">j</span> <span class="main">$</span> <span class="bound">i</span> <span class="main">*</span> <span class="free">v</span> <span class="bound">x</span> <span class="main">$</span> <span class="bound">i</span>"</span></span><span class="main">]</span> finite_atLeastLessThan<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">n</span> <span class="main">=</span> dim_vec <span class="main">(</span><span class="free">v</span> <span class="bound">x</span><span class="main">)</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* The variable a has been inserted here to make the induction work:*)</span>
<span class="keyword1" id="DL_Deep_Model_Poly-polyfun_evaluate_net_plus_a"><span class="command">lemma</span></span> polyfun_evaluate_net_plus_a<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"map dim_vec <span class="free">inputs</span> <span class="main">=</span> input_sizes <span class="free">m</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_net <span class="free">m</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> output_size <span class="free">m</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"polyfun <span class="main">{..&lt;</span><span class="free">a</span> <span class="main">+</span> count_weights <span class="free">s</span> <span class="free">m</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> evaluate_net <span class="main">(</span>insert_weights <span class="free">s</span> <span class="free">m</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">f</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">inputs</span> <span class="main">$</span> <span class="free">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">inputs</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Input<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> insert_weights.simps evaluate_net.simps <span class="keyword1"><span class="command">using</span></span> polyfun_const <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Conv <span class="skolem">x</span> <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x1</span></span> <span class="skolem"><span class="skolem">x2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">=</span><span class="main">(</span><span class="skolem">x1</span><span class="main">,</span><span class="skolem">x2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span><span class="main">=</span><span class="main">(</span><span class="skolem">x1</span><span class="main">,</span><span class="skolem">x2</span><span class="main">)</span>›</span></span> insert_weights.simps evaluate_net.simps drop_map <span class="keyword1"><span class="command">unfolding</span></span> list_of_vec_index
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> polyfun_mult_mat_vec<span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"valid_net' <span class="main">(</span>insert_weights <span class="free">s</span> <span class="skolem">m</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">x1</span> <span class="main">*</span> <span class="skolem">x2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹valid_net <span class="main">(</span>Conv <span class="skolem">x</span> <span class="skolem">m</span><span class="main">)</span>›</span></span> valid_net.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span>
        convnet.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> convnet.distinct<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> convnet.inject<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> remove_insert_weights<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"map dim_vec <span class="skolem">inputs</span> <span class="main">=</span> input_sizes <span class="main">(</span>insert_weights <span class="free">s</span> <span class="skolem">m</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">x1</span> <span class="main">*</span> <span class="skolem">x2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> input_sizes_remove_weights remove_insert_weights
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Conv.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dim_vec <span class="main">(</span>evaluate_net <span class="main">(</span>insert_weights <span class="free">s</span> <span class="skolem">m</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">x1</span> <span class="main">*</span> <span class="skolem">x2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">inputs</span><span class="main">)</span> <span class="main">=</span> output_size <span class="skolem">m</span>"</span></span>
       <span class="keyword1"><span class="command">using</span></span> output_size_correct<span class="main">[</span><span class="operator">OF</span> 1 2<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> remove_insert_weights <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"evaluate_net <span class="main">(</span>insert_weights <span class="free">s</span> <span class="skolem">m</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">x1</span> <span class="main">*</span> <span class="skolem">x2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">inputs</span> <span class="main">∈</span> carrier_vec <span class="main">(</span>output_size <span class="skolem">m</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> carrier_vec_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> mem_Collect_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map dim_vec <span class="skolem">inputs</span> <span class="main">=</span> input_sizes <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Conv.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_net <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Conv.prems<span class="main">(</span>2<span class="main">)</span> valid_net.cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> output_size <span class="skolem">m</span> <span class="main">⟹</span>  polyfun <span class="main">{..&lt;</span><span class="skolem">a</span> <span class="main">+</span> count_weights <span class="free">s</span> <span class="main">(</span>Conv <span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> <span class="skolem">x2</span><span class="main">)</span> <span class="skolem">m</span><span class="main">)</span><span class="main">}</span>
          <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> evaluate_net <span class="main">(</span>insert_weights <span class="free">s</span> <span class="skolem">m</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">f</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">x1</span> <span class="main">*</span> <span class="skolem">x2</span> <span class="main">+</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">inputs</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> vec_of_list_index count_weights.simps
      <span class="keyword1"><span class="command">using</span></span> Conv<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹map dim_vec <span class="skolem">inputs</span> <span class="main">=</span> input_sizes <span class="skolem">m</span>›</span></span> <span class="quoted"><span class="quoted">‹valid_net <span class="skolem">m</span>›</span></span><span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="skolem">x1</span> <span class="main">*</span> <span class="skolem">x2</span> <span class="main">+</span> <span class="skolem">a</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> semigroup_add_class.add.assoc ab_semigroup_add_class.add.commute<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">x1</span> <span class="main">*</span> <span class="skolem">x2</span>"</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"output_size <span class="skolem">m</span> <span class="main">=</span> <span class="skolem">x2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Conv.prems<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> <span class="skolem">x2</span><span class="main">)</span>›</span></span> valid_net.cases <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> extract_matrix <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">f</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x1</span> <span class="skolem">x2</span> <span class="main">∈</span> carrier_mat <span class="skolem">x1</span> <span class="main">(</span>output_size <span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹output_size <span class="skolem">m</span> <span class="main">=</span> <span class="skolem">x2</span>›</span></span> <span class="keyword1"><span class="command">using</span></span> dim_extract_matrix
      <span class="keyword1"><span class="command">using</span></span> carrier_matI <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">x1</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> output_size <span class="skolem">m</span> <span class="main">⟹</span> polyfun <span class="main">{..&lt;</span><span class="skolem">a</span> <span class="main">+</span> count_weights <span class="free">s</span> <span class="main">(</span>Conv <span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> <span class="skolem">x2</span><span class="main">)</span> <span class="skolem">m</span><span class="main">)</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> extract_matrix <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">f</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x1</span> <span class="skolem">x2</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹output_size <span class="skolem">m</span> <span class="main">=</span> <span class="skolem">x2</span>›</span></span> count_weights.simps <span class="keyword1"><span class="command">using</span></span> polyfun_extract_matrix<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">x1</span></span> <span class="main">_</span> <span class="quoted"><span class="skolem">x2</span></span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="quoted">"count_weights <span class="free">s</span> <span class="skolem">m</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">x1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Conv.prems<span class="main">(</span>3<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x1</span><span class="main">,</span> <span class="skolem">x2</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pool <span class="skolem">m1</span> <span class="skolem">m2</span> <span class="skolem">inputs</span> <span class="skolem">j</span> <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> A2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> map dim_vec <span class="main">(</span>take <span class="main">(</span>length <span class="main">(</span>input_sizes <span class="main">(</span>insert_weights <span class="free">s</span> <span class="skolem">m1</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">f</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">inputs</span><span class="main">)</span> <span class="main">=</span> input_sizes <span class="skolem">m1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pool.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>  append_eq_conv_conj input_sizes.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> input_sizes_remove_weights remove_insert_weights take_map<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> B2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> map dim_vec <span class="main">(</span>drop <span class="main">(</span>length <span class="main">(</span>input_sizes <span class="main">(</span>insert_weights <span class="free">s</span> <span class="skolem">m1</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">f</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">inputs</span><span class="main">)</span> <span class="main">=</span> input_sizes <span class="skolem">m2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Pool.prems<span class="main">(</span>1<span class="main">)</span> append_eq_conv_conj input_sizes.simps<span class="main">(</span>3<span class="main">)</span> input_sizes_remove_weights remove_insert_weights <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> drop_map<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> A3<span class="main">:</span><span class="quoted"><span class="quoted">"valid_net <span class="skolem">m1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> B3<span class="main">:</span><span class="quoted"><span class="quoted">"valid_net <span class="skolem">m2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹valid_net <span class="main">(</span>Pool <span class="skolem">m1</span> <span class="skolem">m2</span><span class="main">)</span>›</span></span> valid_net.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"output_size <span class="main">(</span>Pool <span class="skolem">m1</span> <span class="skolem">m2</span><span class="main">)</span> <span class="main">=</span> output_size <span class="skolem">m2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> output_size.simps
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹valid_net <span class="main">(</span>Pool <span class="skolem">m1</span> <span class="skolem">m2</span><span class="main">)</span>›</span></span> <span class="quoted">"valid_net.cases"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> A4<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> output_size <span class="skolem">m1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> B4<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> output_size <span class="skolem">m2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> output_size <span class="main">(</span>Pool <span class="skolem">m1</span> <span class="skolem">m2</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?net1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span><span class="main">.</span> evaluate_net <span class="main">(</span>insert_weights <span class="free">s</span> <span class="skolem">m1</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">f</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>take <span class="main">(</span>length <span class="main">(</span>input_sizes <span class="main">(</span>insert_weights <span class="free">s</span> <span class="skolem">m1</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">f</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">inputs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?net2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span><span class="main">.</span> evaluate_net <span class="main">(</span>insert_weights <span class="free">s</span> <span class="skolem">m2</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">s</span> <span class="keyword1">then</span> <span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">f</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">a</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">f</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> count_weights <span class="free">s</span> <span class="skolem">m1</span> <span class="main">+</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>drop <span class="main">(</span>length <span class="main">(</span>input_sizes <span class="main">(</span>insert_weights <span class="free">s</span> <span class="skolem">m1</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">f</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">inputs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> length1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> output_size <span class="skolem">m1</span> <span class="main">=</span> dim_vec <span class="main">(</span><span class="var">?net1</span> <span class="bound">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> A2 A3 input_sizes_remove_weights output_size_correct remove_insert_weights<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> jlength1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="skolem">j</span> <span class="main">&lt;</span> dim_vec <span class="main">(</span><span class="var">?net1</span> <span class="bound">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> length2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> output_size <span class="skolem">m2</span> <span class="main">=</span> dim_vec <span class="main">(</span><span class="var">?net2</span> <span class="bound">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> B2 B3 input_sizes_remove_weights output_size_correct remove_insert_weights<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> jlength2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="skolem">j</span> <span class="main">&lt;</span> dim_vec <span class="main">(</span><span class="var">?net2</span> <span class="bound">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> B4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> cong1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xf</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> evaluate_net <span class="main">(</span>insert_weights <span class="free">s</span> <span class="skolem">m1</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">f</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>take <span class="main">(</span>length <span class="main">(</span>input_sizes <span class="main">(</span>insert_weights <span class="free">s</span> <span class="skolem">m1</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">xf</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">inputs</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span>
         <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="var">?net1</span> <span class="bound">f</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> input_sizes_remove_weights remove_insert_weights <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> cong2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xf</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> evaluate_net <span class="main">(</span>insert_weights <span class="free">s</span> <span class="skolem">m2</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">f</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">s</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> count_weights <span class="free">s</span> <span class="skolem">m1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>drop <span class="main">(</span>length <span class="main">(</span>input_sizes <span class="main">(</span>insert_weights <span class="free">s</span> <span class="skolem">m1</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="bound">xf</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="skolem">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">inputs</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span>
         <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="var">?net2</span> <span class="bound">f</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> semigroup_add_class.add.assoc<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> ab_semigroup_add_class.add.commute<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> <span class="free">s</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> count_weights <span class="free">s</span> <span class="skolem">m1</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> input_sizes_remove_weights remove_insert_weights <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> insert_weights.simps evaluate_net.simps  count_weights.simps
    <span class="keyword1"><span class="command">unfolding</span></span>  index_component_mult<span class="main">[</span><span class="operator">OF</span> jlength1 jlength2<span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> polyfun_mult<span class="main">)</span>
     <span class="keyword1"><span class="command">using</span></span> Pool.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> A2 A3 A4<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">,</span> <span class="operator">unfolded</span> cong1<span class="main">]</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>polyfun_subset<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span><span class="skolem">a</span> <span class="main">+</span> count_weights <span class="free">s</span> <span class="skolem">m1</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span><span class="skolem">a</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">s</span> <span class="keyword1">then</span> max <span class="main">(</span>count_weights <span class="free">s</span> <span class="skolem">m1</span><span class="main">)</span> <span class="main">(</span>count_weights <span class="free">s</span> <span class="skolem">m2</span><span class="main">)</span> <span class="keyword1">else</span> count_weights <span class="free">s</span> <span class="skolem">m1</span> <span class="main">+</span> count_weights <span class="free">s</span> <span class="skolem">m2</span><span class="main">)</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> 
    <span class="keyword1"><span class="command">using</span></span> Pool.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> B2 B3 B4<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">s</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> count_weights <span class="free">s</span> <span class="skolem">m1</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> cong2 semigroup_add_class.add.assoc<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>polyfun_subset<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span><span class="skolem">a</span> <span class="main">+</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> <span class="free">s</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> count_weights <span class="free">s</span> <span class="skolem">m1</span><span class="main">)</span> <span class="main">+</span> count_weights <span class="free">s</span> <span class="skolem">m2</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span><span class="skolem">a</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">s</span> <span class="keyword1">then</span> max <span class="main">(</span>count_weights <span class="free">s</span> <span class="skolem">m1</span><span class="main">)</span> <span class="main">(</span>count_weights <span class="free">s</span> <span class="skolem">m2</span><span class="main">)</span> <span class="keyword1">else</span> count_weights <span class="free">s</span> <span class="skolem">m1</span> <span class="main">+</span> count_weights <span class="free">s</span> <span class="skolem">m2</span><span class="main">)</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Deep_Model_Poly-polyfun_evaluate_net"><span class="command">lemma</span></span> polyfun_evaluate_net<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"map dim_vec <span class="free">inputs</span> <span class="main">=</span> input_sizes <span class="free">m</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_net <span class="free">m</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> output_size <span class="free">m</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"polyfun <span class="main">{..&lt;</span>count_weights <span class="free">s</span> <span class="free">m</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> evaluate_net <span class="main">(</span>insert_weights <span class="free">s</span> <span class="free">m</span> <span class="bound">f</span><span class="main">)</span> <span class="free">inputs</span> <span class="main">$</span> <span class="free">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> polyfun_evaluate_net_plus_a<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main">=</span></span><span class="quoted"><span class="main">0</span></span><span class="main">,</span> <span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="DL_Deep_Model_Poly-polyfun_tensors_from_net"><span class="command">lemma</span></span> polyfun_tensors_from_net<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_net <span class="free">m</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">⊲</span> input_sizes <span class="free">m</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> output_size <span class="free">m</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"polyfun <span class="main">{..&lt;</span>count_weights <span class="free">s</span> <span class="free">m</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> Tensor.lookup <span class="main">(</span>tensors_from_net <span class="main">(</span>insert_weights <span class="free">s</span> <span class="free">m</span> <span class="bound">f</span><span class="main">)</span> <span class="main">$</span> <span class="free">j</span><span class="main">)</span> <span class="free">is</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> valid_net' <span class="main">(</span>insert_weights <span class="free">s</span> <span class="free">m</span> <span class="bound">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> remove_insert_weights<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> input_sizes<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> input_sizes <span class="main">(</span>insert_weights <span class="free">s</span> <span class="free">m</span> <span class="bound">f</span><span class="main">)</span> <span class="main">=</span> input_sizes <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> input_sizes_remove_weights <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_insert_weights<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="free">is</span> <span class="main">⊲</span> input_sizes <span class="main">(</span>insert_weights <span class="free">s</span> <span class="free">m</span> <span class="bound">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> input_sizes <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="free">j</span> <span class="main">&lt;</span> output_size' <span class="main">(</span>insert_weights <span class="free">s</span> <span class="free">m</span> <span class="bound">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> remove_insert_weights<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f1</span> <span class="bound">f2</span><span class="main">.</span> base_input <span class="main">(</span>insert_weights <span class="free">s</span> <span class="free">m</span> <span class="bound">f1</span><span class="main">)</span> <span class="free">is</span> <span class="main">=</span> base_input <span class="main">(</span>insert_weights <span class="free">s</span> <span class="free">m</span> <span class="bound">f2</span><span class="main">)</span> <span class="free">is</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> base_input_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> input_sizes<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xf</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> evaluate_net <span class="main">(</span>insert_weights <span class="free">s</span> <span class="free">m</span> <span class="bound">f</span><span class="main">)</span> <span class="main">(</span>base_input <span class="main">(</span>insert_weights <span class="free">s</span> <span class="free">m</span> <span class="bound">xf</span><span class="main">)</span> <span class="free">is</span><span class="main">)</span> <span class="main">$</span> <span class="free">j</span><span class="main">)</span>
    <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> evaluate_net <span class="main">(</span>insert_weights <span class="free">s</span> <span class="free">m</span> <span class="bound">f</span><span class="main">)</span> <span class="main">(</span>base_input <span class="main">(</span>insert_weights <span class="free">s</span> <span class="free">m</span> <span class="bound">f</span><span class="main">)</span> <span class="free">is</span><span class="main">)</span> <span class="main">$</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> lookup_tensors_from_net<span class="main">[</span><span class="operator">OF</span> 1 2 3<span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> polyfun_evaluate_net<span class="main">[</span><span class="operator">OF</span> base_input_length<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 2<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> input_sizes<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Deep_Model_Poly-polyfun_matricize"><span class="command">lemma</span></span> polyfun_matricize<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> dims <span class="main">(</span><span class="free">T</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">ds</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">is</span><span class="main">.</span> <span class="bound">is</span> <span class="main">⊲</span> <span class="free">ds</span> <span class="main">⟹</span> polyfun <span class="free">N</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Tensor.lookup <span class="main">(</span><span class="free">T</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">is</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> dim_row <span class="main">(</span>matricize <span class="free">I</span> <span class="main">(</span><span class="free">T</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">nr</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> dim_col <span class="main">(</span>matricize <span class="free">I</span> <span class="main">(</span><span class="free">T</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">nc</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">nr</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">nc</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"polyfun <span class="free">N</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> matricize <span class="free">I</span> <span class="main">(</span><span class="free">T</span> <span class="bound">x</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?weave</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span>weave <span class="free">I</span>
    <span class="main">(</span>digit_encode <span class="main">(</span>nths <span class="free">ds</span> <span class="free">I</span> <span class="main">)</span> <span class="free">i</span><span class="main">)</span>
    <span class="main">(</span>digit_encode <span class="main">(</span>nths <span class="free">ds</span> <span class="main">(</span><span class="main">-</span><span class="free">I</span> <span class="main">)</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> matricize <span class="free">I</span> <span class="main">(</span><span class="free">T</span> <span class="bound">x</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span> <span class="main">=</span> Tensor.lookup <span class="main">(</span><span class="free">T</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="var">?weave</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> matricize_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> case_prod_conv
    dim_col_mat<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> dim_row_mat<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> index_mat<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> matricize_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="var">?weave</span> <span class="bound">x</span> <span class="main">⊲</span> <span class="free">ds</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_index_weave<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> digit_encode_valid_index dim_row_mat<span class="main">(</span>1<span class="main">)</span> matricize_def
    <span class="keyword1"><span class="command">using</span></span> assms digit_encode_valid_index matricize_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dim_col_mat<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"polyfun <span class="free">N</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Tensor.lookup <span class="main">(</span><span class="free">T</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="var">?weave</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">¬</span> <span class="main">(</span><span class="free">a</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">&lt;</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">≥</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> not_le<span class="main">)</span>

<span class="keyword1" id="DL_Deep_Model_Poly-polyfun_submatrix"><span class="command">lemma</span></span> polyfun_submatrix<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> carrier_mat <span class="free">m</span> <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span><span class="free">m</span> <span class="main">⟹</span> <span class="bound">j</span><span class="main">&lt;</span><span class="free">n</span> <span class="main">⟹</span> polyfun <span class="free">N</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="bound">x</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free">J</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"infinite <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"infinite <span class="free">J</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"polyfun <span class="free">N</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>submatrix <span class="main">(</span><span class="free">A</span> <span class="bound">x</span><span class="main">)</span> <span class="free">I</span> <span class="free">J</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span>submatrix <span class="main">(</span><span class="free">A</span> <span class="bound">x</span><span class="main">)</span> <span class="free">I</span> <span class="free">J</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="bound">x</span><span class="main">)</span> <span class="main">$$</span> <span class="main">(</span>pick <span class="free">I</span> <span class="free">i</span><span class="main">,</span> pick <span class="free">J</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> submatrix_index <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Collect_cong assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> carrier_matD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> carrier_matD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pick <span class="free">I</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">m</span>"</span></span>  <span class="quoted"><span class="quoted">"pick <span class="free">J</span> <span class="free">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> card_le_pick_inf<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹infinite <span class="free">I</span>›</span></span><span class="main">]</span> card_le_pick_inf<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹infinite <span class="free">J</span>›</span></span><span class="main">]</span>
    <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">}</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> set_le_in<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">∈</span> <span class="free">J</span><span class="main">}</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> set_le_in<span class="main">]</span> not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> deep_model_correct_params_y
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">witness_submatrix</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">witness_submatrix</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> submatrix <span class="main">(</span>A' <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> rows_with_1 rows_with_1"</span></span>


<span class="keyword1" id="DL_Deep_Model_Poly-polyfun_tensor_deep_model"><span class="command">lemma</span></span> polyfun_tensor_deep_model<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">is</span> <span class="main">⊲</span> input_sizes <span class="main">(</span>deep_model_l <span class="free">rs</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"polyfun <span class="main">{..&lt;</span>weight_space_dim<span class="main">}</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> Tensor.lookup <span class="main">(</span>tensors_from_net <span class="main">(</span>insert_weights <span class="free">shared_weights</span> <span class="main">(</span>deep_model_l <span class="free">rs</span><span class="main">)</span> <span class="bound">f</span><span class="main">)</span> <span class="main">$</span> <span class="free">y</span><span class="main">)</span> <span class="free">is</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> remove_weights <span class="main">(</span>insert_weights <span class="free">shared_weights</span> <span class="main">(</span>deep_model_l <span class="free">rs</span><span class="main">)</span> <span class="bound">f</span><span class="main">)</span> <span class="main">=</span> deep_model_l <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> remove_insert_weights <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&lt;</span> output_size <span class="main">(</span> deep_model_l <span class="free">rs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> valid_deep_model y_valid length_output_deep_model <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span>weight_space_dim<span class="main">}</span> <span class="main">=</span> set <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span>weight_space_dim<span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> weight_space_dim_def <span class="keyword1"><span class="command">using</span></span> polyfun_tensors_from_net assms<span class="main">(</span>1<span class="main">)</span> valid_deep_model
    <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">&lt;</span> output_size <span class="main">(</span> deep_model_l <span class="free">rs</span> <span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Deep_Model_Poly-input_sizes_deep_model"><span class="command">lemma</span></span> input_sizes_deep_model<span class="main">:</span> <span class="quoted"><span class="quoted">"input_sizes <span class="main">(</span>deep_model_l <span class="free">rs</span><span class="main">)</span> <span class="main">=</span> replicate <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> N_half<span class="main">)</span> <span class="main">(</span>last <span class="free">rs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> N_half_def <span class="keyword1"><span class="command">using</span></span> input_sizes_deep_model deep
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Nitpick.size_list_simp<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> One_nat_def Suc_1 Suc_le_lessD diff_Suc_Suc length_tl less_imp_le_nat list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> not_less_eq numeral_3_eq_3 power_eq_if<span class="main">)</span>

<span class="keyword1" id="DL_Deep_Model_Poly-polyfun_matrix_deep_model"><span class="command">lemma</span></span> polyfun_matrix_deep_model<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="main">(</span>last <span class="free">rs</span><span class="main">)</span> <span class="main">^</span> N_half"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span><span class="main">&lt;</span><span class="main">(</span>last <span class="free">rs</span><span class="main">)</span> <span class="main">^</span> N_half"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"polyfun <span class="main">{..&lt;</span>weight_space_dim<span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> A' <span class="bound">f</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&lt;</span> output_size <span class="main">(</span> deep_model_l <span class="free">rs</span> <span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> valid_deep_model y_valid length_output_deep_model <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> remove_weights <span class="main">(</span>insert_weights <span class="free">shared_weights</span> <span class="main">(</span>deep_model_l <span class="free">rs</span><span class="main">)</span> <span class="bound">f</span><span class="main">)</span> <span class="main">=</span> deep_model_l <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> remove_insert_weights <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">f</span> <span class="bound">is</span><span class="main">.</span> <span class="bound">is</span> <span class="main">⊲</span> replicate <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> N_half<span class="main">)</span> <span class="main">(</span>last <span class="free">rs</span><span class="main">)</span> <span class="main">⟹</span>
         polyfun <span class="main">{..&lt;</span>weight_space_dim<span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> Tensor.lookup <span class="main">(</span>A <span class="bound">x</span><span class="main">)</span> <span class="bound">is</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> A_def <span class="keyword1"><span class="command">using</span></span> polyfun_tensor_deep_model<span class="main">[</span><span class="operator">unfolded</span> input_sizes_deep_model<span class="main">]</span> 0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> A'_def A_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> polyfun_matricize<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> dims_tensor_deep_model<span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span> 2<span class="main">[</span><span class="operator">unfolded</span> A_def<span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> dims_A'_pow<span class="main">[</span><span class="operator">unfolded</span> A'_def A_def<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span><span class="main">&lt;</span><span class="main">(</span>last <span class="free">rs</span><span class="main">)</span> <span class="main">^</span> N_half›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">j</span><span class="main">&lt;</span><span class="main">(</span>last <span class="free">rs</span><span class="main">)</span> <span class="main">^</span> N_half›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Deep_Model_Poly-polyfun_submatrix_deep_model"><span class="command">lemma</span></span> polyfun_submatrix_deep_model<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> r <span class="main">^</span> N_half"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> r <span class="main">^</span> N_half"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"polyfun <span class="main">{..&lt;</span>weight_space_dim<span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> witness_submatrix <span class="bound">f</span> <span class="main">$$</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> witness_submatrix_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> polyfun_submatrix<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> remove_weights <span class="main">(</span>insert_weights <span class="free">shared_weights</span> <span class="main">(</span>deep_model_l <span class="free">rs</span><span class="main">)</span> <span class="bound">f</span><span class="main">)</span> <span class="main">=</span> deep_model_l <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> remove_insert_weights <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> A' <span class="bound">f</span> <span class="main">∈</span> carrier_mat <span class="main">(</span><span class="main">(</span>last <span class="free">rs</span><span class="main">)</span> <span class="main">^</span> N_half<span class="main">)</span> <span class="main">(</span><span class="main">(</span>last <span class="free">rs</span><span class="main">)</span> <span class="main">^</span> N_half<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span> dims_A'_pow <span class="keyword1"><span class="command">using</span></span> weight_space_dim_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> last <span class="free">rs</span> <span class="main">^</span> N_half <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> last <span class="free">rs</span> <span class="main">^</span> N_half <span class="main">⟹</span>
        polyfun <span class="main">{..&lt;</span>weight_space_dim<span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> A' <span class="bound">f</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> polyfun_matrix_deep_model weight_space_dim_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> last <span class="free">rs</span> <span class="main">^</span> N_half <span class="main">∧</span> <span class="bound">i</span> <span class="main">∈</span> rows_with_1<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> card_rows_with_1 dims_Aw'_pow set_le_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> card <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> last <span class="free">rs</span> <span class="main">^</span> N_half <span class="main">∧</span> <span class="bound">i</span> <span class="main">∈</span> rows_with_1<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> card_rows_with_1 dims_Aw'_pow set_le_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"infinite rows_with_1"</span></span> <span class="quoted"><span class="quoted">"infinite rows_with_1"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> infinite_rows_with_1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Deep_Model_Poly-polyfun_det_deep_model"><span class="command">lemma</span></span> polyfun_det_deep_model<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"polyfun <span class="main">{..&lt;</span>weight_space_dim<span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> det <span class="main">(</span>witness_submatrix <span class="bound">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> polyfun_det<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"remove_weights <span class="main">(</span>insert_weights <span class="free">shared_weights</span> <span class="main">(</span>deep_model_l <span class="free">rs</span><span class="main">)</span> <span class="skolem">f</span><span class="main">)</span> <span class="main">=</span> deep_model_l <span class="free">rs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> remove_insert_weights <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"witness_submatrix <span class="skolem">f</span> <span class="main">∈</span> carrier_mat <span class="main">(</span>r <span class="main">^</span> N_half<span class="main">)</span> <span class="main">(</span>r <span class="main">^</span> N_half<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> witness_submatrix_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> carrier_matI<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> dim_submatrix<span class="main">[</span><span class="operator">unfolded</span> set_le_in<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> dims_A'_pow<span class="main">[</span><span class="operator">unfolded</span> weight_space_dim_def<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> card_rows_with_1 dims_Aw'_pow <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> r <span class="main">^</span> N_half <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> r <span class="main">^</span> N_half <span class="main">⟹</span> polyfun <span class="main">{..&lt;</span>weight_space_dim<span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> witness_submatrix <span class="bound">f</span> <span class="main">$$</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> polyfun_submatrix_deep_model <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Lebesgue_Functional">
<div class="head">
<h1>Theory Lebesgue_Functional</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Alexander Bentkamp, Universität des Saarlandes
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Alternative Lebesgue Measure Definition›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Lebesgue_Functional
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Analysis/Lebesgue_Measure.html">HOL-Analysis.Lebesgue_Measure</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lebesgue\_Measure.lborel is defined on the typeclass euclidean\_space, which does not allow the
space dimension to be dependent on a variable. As the Lebesgue measure of higher dimensions is the
product measure of the one dimensional Lebesgue measure, we can easily define a more flexible version
of the Lebesgue measure as follows. This version of the Lebesgue measure measures sets of functions
from nat to real whose values are undefined for arguments higher than n. These "Extensional Function Spaces"
 are defined in HOL/FuncSet. ›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lborel_f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> real<span class="main">)</span> measure"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lborel_f</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">Π<span class="hidden">⇩</span><sub>M</sub></span> <span class="bound">b</span><span class="main">∈</span><span class="main">{..&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span><span class="main">.</span> lborel<span class="main">)</span>"</span></span>

<span class="keyword1" id="Lebesgue_Functional-product_sigma_finite_interval"><span class="command">lemma</span></span> product_sigma_finite_interval<span class="main">:</span> <span class="quoted"><span class="quoted">"product_sigma_finite <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> interval_measure <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> product_sigma_finite_def <span class="keyword1"><span class="command">using</span></span>  sigma_finite_interval_measure <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Lebesgue_Functional-l_borel_f_1"><span class="command">lemma</span></span> l_borel_f_1<span class="main">:</span> <span class="quoted"><span class="quoted">"distr <span class="main">(</span>lborel_f <span class="main">1</span><span class="main">)</span> lborel <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> lborel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lborel_f_def
  <span class="keyword1"><span class="command">using</span></span> product_sigma_finite.distr_singleton<span class="main">[</span><span class="operator">OF</span> product_sigma_finite_interval<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span>
    lborel_eq_real lessThan_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Lebesgue_Functional-space_lborel_f"><span class="command">lemma</span></span> space_lborel_f<span class="main">:</span> <span class="quoted"><span class="quoted">"space <span class="main">(</span>lborel_f <span class="free">n</span><span class="main">)</span> <span class="main">=</span> Pi<span class="hidden">⇩</span><sub>E</sub> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> UNIV<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lborel_f_def
  <span class="keyword1"><span class="command">unfolding</span></span> space_PiM space_lborel space_borel <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="Lebesgue_Functional-space_lborel_f_subset"><span class="command">lemma</span></span> space_lborel_f_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"space <span class="main">(</span>lborel_f <span class="free">n</span><span class="main">)</span> <span class="main">⊆</span> space <span class="main">(</span>lborel_f <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> space_lborel_f <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> PiE_I<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span>
  <span class="operator">metis</span> PiE_E  Suc_n_not_le_n le_cases lessThan_subset_iff subsetCE<span class="main">)</span>

<span class="keyword1" id="Lebesgue_Functional-space_lborel_add_dim"><span class="command">lemma</span></span> space_lborel_add_dim<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> space <span class="main">(</span>lborel_f <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">(</span><span class="free">n</span><span class="main">:=</span><span class="free">x</span><span class="main">)</span> <span class="main">∈</span> space <span class="main">(</span>lborel_f <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> space_lborel_f
<span class="keyword1"><span class="command">using</span></span> assms lessThan_Suc space_lborel_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Lebesgue_Functional-integral_lborel_f"><span class="command">lemma</span></span> integral_lborel_f<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>lborel_f <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">integral<span class="hidden">⇧</span><sup>N</sup></span> <span class="main">(</span>lborel_f <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="free">f</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">y</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span><span class="main">(</span><span class="free">n</span> <span class="main">:=</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">∂</span>lborel_f <span class="free">n</span> <span class="main">∂</span>lborel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lborel_f_def
  <span class="keyword1"><span class="command">using</span></span> product_sigma_finite.product_nn_integral_insert_rev<span class="main">[</span><span class="operator">OF</span> product_sigma_finite_interval<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> finite_lessThan _<span class="main">]</span>
  assms<span class="main">[</span><span class="operator">unfolded</span> lborel_f_def<span class="main">]</span> lborel_eq_real <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lessThan_Suc<span class="main">)</span>

<span class="keyword1" id="Lebesgue_Functional-emeasure_lborel_f_Suc"><span class="command">lemma</span></span> emeasure_lborel_f_Suc<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> sets <span class="main">(</span>lborel_f <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span>space <span class="main">(</span>lborel_f <span class="free">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">(</span><span class="free">n</span> <span class="main">:=</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span> <span class="main">∈</span> sets <span class="main">(</span>lborel_f <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>lborel_f <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">y</span><span class="main">.</span> emeasure <span class="main">(</span>lborel_f <span class="free">n</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span>space <span class="main">(</span>lborel_f <span class="free">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">(</span><span class="free">n</span> <span class="main">:=</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span> <span class="main">∂</span>lborel"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span>space <span class="main">(</span>lborel_f <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>indicator <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">(</span><span class="free">n</span> <span class="main">:=</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>indicator <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span>space <span class="main">(</span>lborel_f <span class="free">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">(</span><span class="free">n</span> <span class="main">:=</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> indicator_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> mem_Collect_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> nn_integral_indicator<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> nn_integral_indicator<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
     integral_lborel_f<span class="main">[</span><span class="operator">OF</span> borel_measurable_indicator<span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> nn_integral_cong <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Lebesgue_Functional-lborel_f_measurable_add_dim"><span class="command">lemma</span></span> lborel_f_measurable_add_dim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="free">n</span> <span class="main">:=</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> measurable <span class="main">(</span>lborel_f <span class="free">n</span><span class="main">)</span> <span class="main">(</span>lborel_f <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> space lborel"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="free">n</span> <span class="main">:=</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span><span class="main">λ</span><span class="bound">xa</span><span class="main">.</span> <span class="main">(</span><span class="bound">xa</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="free">n</span> <span class="main">:=</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> comp_def  <span class="keyword1"><span class="command">using</span></span> case_prod_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> lborel_f_def
    <span class="keyword1"><span class="command">using</span></span> measurable_comp<span class="main">[</span><span class="operator">OF</span> measurable_Pair2'<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted">lborel</span> <span class="quoted"><span class="quoted">"Pi<span class="hidden">⇩</span><sub>M</sub> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> lborel<span class="main">)</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">∈</span> space lborel›</span></span><span class="main"><span class="main">]</span></span>
    measurable_add_dim<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">b</span><span class="main">.</span> lborel"</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">unfolded</span> 0<span class="main">]</span> lessThan_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Lebesgue_Functional-sets_lborel_f_sub_dim"><span class="command">lemma</span></span> sets_lborel_f_sub_dim<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> sets <span class="main">(</span>lborel_f <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">(</span><span class="free">n</span> <span class="main">:=</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span> <span class="main">∩</span> space <span class="main">(</span>lborel_f <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> sets <span class="main">(</span>lborel_f <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="free">n</span> <span class="main">:=</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">-`</span> <span class="free">A</span> <span class="main">∩</span> space <span class="main">(</span>lborel_f <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> sets <span class="main">(</span>lborel_f <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> measurable_sets<span class="main">[</span><span class="operator">OF</span> lborel_f_measurable_add_dim assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="free">n</span> <span class="main">:=</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">-`</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">(</span><span class="free">n</span> <span class="main">:=</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Lebesgue_Functional-lborel_f_measurable_restrict"><span class="command">lemma</span></span> lborel_f_measurable_restrict<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> restrict <span class="bound">f</span> <span class="main">{..&lt;</span><span class="free">m</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> measurable <span class="main">(</span>lborel_f <span class="free">n</span><span class="main">)</span> <span class="main">(</span>lborel_f <span class="free">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> measurable_restrict_subset lborel_f_def assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Lebesgue_Functional-lborel_measurable_sub_dim"><span class="command">lemma</span></span> lborel_measurable_sub_dim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> restrict <span class="bound">f</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> measurable <span class="main">(</span>lborel_f <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>lborel_f <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> lborel_f_measurable_restrict<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">n</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>

<span class="keyword1" id="Lebesgue_Functional-measurable_lborel_component"><span class="command">lemma</span></span> measurable_lborel_component <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">&lt;</span><span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="free">k</span><span class="main">)</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>lborel_f <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lborel_f_def <span class="keyword1"><span class="command">using</span></span> assms measurable_PiM_component_rev <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Lebesgue_Zero_Set">
<div class="head">
<h1>Theory Lebesgue_Zero_Set</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Alexander Bentkamp, Universität des Saarlandes
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Lebesgue Measure of Polynomial Zero Sets›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Lebesgue_Zero_Set
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="../Polynomials/More_MPoly_Type.html">Polynomials.More_MPoly_Type</a>
    <a href="Lebesgue_Functional.html">Lebesgue_Functional</a>
    <a href="../Polynomials/MPoly_Type_Univariate.html">Polynomials.MPoly_Type_Univariate</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Lebesgue_Zero_Set-measurable_insertion"><span class="command">lemma</span></span> measurable_insertion <span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"vars <span class="free">p</span> <span class="main">⊆</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> insertion <span class="bound">f</span> <span class="free">p</span><span class="main">)</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>lborel_f <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>mpoly_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>monom <span class="skolem">m</span> <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> insertion_single <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> <span class="main">0</span>›</span></span> MPoly_Type.monom.abs_eq single_zero
      zero_mpoly.abs_eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> insertion_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Poly_Mapping.keys <span class="skolem">m</span> <span class="main">⊆</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> monom <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> False vars_monom_keys<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span><span class="main">≠</span><span class="main">0</span>›</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">m</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="skolem">a</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>poly_mapping_induct<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>single <span class="skolem">x</span> <span class="skolem">i</span> <span class="skolem">a</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> insertion_single <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> insertion_single <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">measurable</span>
          <span class="keyword1"><span class="command">using</span></span> vars_monom_single_cases single False insert_subset lessThan_iff <span class="quoted"><span class="quoted">‹<span class="skolem">a</span><span class="main">≠</span><span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>sum <span class="skolem">m1</span> <span class="skolem">m2</span> <span class="skolem">x</span> <span class="skolem">i</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Poly_Mapping.keys <span class="skolem">m1</span> <span class="main">∩</span> Poly_Mapping.keys <span class="skolem">m2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Poly_Mapping.keys <span class="skolem">m1</span> <span class="main">∪</span> Poly_Mapping.keys <span class="skolem">m2</span> <span class="main">=</span> Poly_Mapping.keys <span class="main">(</span><span class="skolem">m1</span> <span class="main">+</span> <span class="skolem">m2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> keys_add <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"Poly_Mapping.keys <span class="skolem">m1</span> <span class="main">⊆</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"Poly_Mapping.keys <span class="skolem">m2</span> <span class="main">⊆</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sum.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> MPoly_Type.mult_monom<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">m1</span></span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">m2</span></span> <span class="quoted"><span class="main">1</span></span><span class="main">,</span><span class="operator">simplified</span><span class="main">,</span><span class="operator">symmetric</span><span class="main">]</span>
        insertion_mult <span class="keyword1"><span class="command">using</span></span> sum.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 1 <span class="quoted"><span class="quoted">‹<span class="skolem">a</span><span class="main">≠</span><span class="main">0</span>›</span></span><span class="main">]</span> sum.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 2<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="main">1</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>sum <span class="skolem">p1</span> <span class="skolem">p2</span> <span class="skolem">m</span> <span class="skolem">a</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> insertion <span class="bound">f</span> <span class="skolem">p1</span><span class="main">)</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>lborel_f <span class="free">n</span><span class="main">)</span>"</span></span>
            <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> insertion <span class="bound">f</span> <span class="skolem">p2</span><span class="main">)</span> <span class="main">∈</span> borel_measurable <span class="main">(</span>lborel_f <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> vars_add_monom<span class="main">[</span><span class="operator">OF</span> sum.hyps<span class="main">]</span>  le_sup_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> insertion_add <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This proof follows Richard Caron and Tim Traynor, "The zero set of a polynomial"
http://www1.uwindsor.ca/math/sites/uwindsor.ca.math/files/05-03.pdf›</span></span>

<span class="keyword1" id="Lebesgue_Zero_Set-lebesgue_mpoly_zero_set"><span class="command">lemma</span></span> lebesgue_mpoly_zero_set<span class="main">:</span>
<span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span><span class="quoted"><span class="quoted">"real mpoly"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"vars <span class="free">p</span> <span class="main">⊆</span> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">f</span></span><span class="main">∈</span>space <span class="main">(</span>lborel_f <span class="free">n</span><span class="main">)</span><span class="main">.</span> insertion <span class="bound">f</span> <span class="free">p</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">∈</span> null_sets <span class="main">(</span>lborel_f <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">p</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vars <span class="skolem">p</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> insertion <span class="bound">f</span> <span class="skolem">p</span> <span class="main">=</span> MPoly_Type.coeff <span class="skolem">p</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> insertion_trivial<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> insertion_irrelevant_vars <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span><span class="main">.</span> <span class="bound">m</span><span class="main">≠</span><span class="main">0</span> <span class="main">⟹</span> MPoly_Type.coeff <span class="skolem">p</span> <span class="bound">m</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat <span class="main">⇒<span class="hidden">⇩</span><sub>0</sub></span> nat"</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span><span class="main">≠</span><span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"MPoly_Type.coeff <span class="skolem">p</span> <span class="skolem">m</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"Poly_Mapping.lookup <span class="skolem">m</span> <span class="skolem">v</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> aux <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span>vars <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> More_MPoly_Type.vars_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹MPoly_Type.coeff <span class="skolem">p</span> <span class="skolem">m</span> <span class="main">≠</span> <span class="main">0</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> UN_I coeff_keys lookup_not_eq_zero_eq_in_keys<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vars <span class="skolem">p</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"MPoly_Type.coeff <span class="skolem">p</span> <span class="main">0</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">≠</span> <span class="main">0</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> coeff_all_0<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">f</span><span class="main">.</span> insertion <span class="bound">f</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> insertion <span class="bound">f</span> <span class="skolem">p</span> <span class="main">=</span> MPoly_Type.coeff <span class="skolem">p</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span> <span class="skolem">p</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Show that N is finite:›</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"extract_var <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reduce_nested_mpoly_0
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> reduce_nested_mpoly_extract_var<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">j</span><span class="main">.</span> MPoly_Type.coeff <span class="main">(</span>extract_var <span class="skolem">p</span> <span class="skolem">n</span><span class="main">)</span> <span class="bound">j</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?q</span> <span class="skolem">j</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹extract_var <span class="skolem">p</span> <span class="skolem">n</span> <span class="main">≠</span> <span class="main">0</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> coeff_all_0<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> insertion <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="var">?q</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> univariate_mpoly_roots_finite<span class="main">[</span><span class="operator">OF</span> vars_coeff_extract_var<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">⋂</span><span class="bound">j</span><span class="main">.</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> insertion <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="var">?q</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∀</span><span class="bound">j</span><span class="main">.</span> insertion <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="var">?q</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋂</span><span class="bound">j</span><span class="main">.</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> insertion <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="var">?q</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∀</span><span class="bound">j</span><span class="main">.</span> insertion <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="var">?q</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p_fix1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p_fix1</span> <span class="skolem">x1</span> <span class="main">=</span> replace_coeff <span class="main">(</span>insertion <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="skolem">x1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>extract_var <span class="skolem">p</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x1</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">N</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x1</span><span class="main">.</span> <span class="skolem">p_fix1</span> <span class="bound">x1</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∀</span><span class="bound">j</span><span class="main">.</span> insertion <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="var">?q</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="skolem">N</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p_fix1</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> N_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span><span class="main">.</span> MPoly_Type.coeff <span class="main">(</span><span class="skolem">p_fix1</span> <span class="skolem">x</span><span class="main">)</span> <span class="bound">m</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> More_MPoly_Type.coeff_monom monom_zero when_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> insertion <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="var">?q</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">m</span><span class="main">.</span> MPoly_Type.coeff <span class="main">(</span><span class="skolem">p_fix1</span> <span class="skolem">x</span><span class="main">)</span> <span class="bound">m</span> <span class="main">=</span> <span class="main">0</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> p_fix1_def coeff_replace_coeff<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"insertion <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="skolem">x</span><span class="main">)</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> insertion_zero<span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∀</span><span class="bound">j</span><span class="main">.</span> insertion <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>MPoly_Type.coeff <span class="main">(</span>extract_var <span class="skolem">p</span> <span class="skolem">n</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">N</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹finite <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∀</span><span class="bound">j</span><span class="main">.</span> insertion <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>MPoly_Type.coeff <span class="main">(</span>extract_var <span class="skolem">p</span> <span class="skolem">n</span><span class="main">)</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>›</span></span> finite_subset<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Use the IH:›</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">f</span></span><span class="main">∈</span>space <span class="main">(</span>lborel_f <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> insertion <span class="bound">f</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x1</span><span class="main">.</span> vars <span class="main">(</span><span class="skolem">p_fix1</span> <span class="bound">x1</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{..&lt;</span><span class="skolem">n</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x1</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vars <span class="main">(</span>extract_var <span class="skolem">p</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{..&lt;</span><span class="skolem">n</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹vars <span class="skolem">p</span> <span class="main">⊆</span> <span class="main">{..&lt;</span>Suc <span class="skolem">n</span><span class="main">}</span>›</span></span> lessThan_Suc v_not_in_vars_extract_var vars_extract_var_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"vars <span class="main">(</span><span class="skolem">p_fix1</span> <span class="skolem">x1</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{..&lt;</span><span class="skolem">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> p_fix1_def
      <span class="keyword1"><span class="command">using</span></span> vars_replace_coeff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"insertion <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="skolem">x1</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> insertion_zero<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> set_eq<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x1</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="bound">x1</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">f</span></span> <span class="main">∈</span> space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span><span class="main">.</span> insertion <span class="bound">f</span> <span class="main">(</span><span class="skolem">p_fix1</span> <span class="bound">x1</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x1</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span>space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="skolem">x1</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">f</span></span><span class="main">∈</span>space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span><span class="main">.</span> insertion <span class="bound">f</span> <span class="main">(</span><span class="skolem">p_fix1</span> <span class="skolem">x1</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subset_antisym<span class="main"><span class="keyword3">;</span></span><span class="operator">rule</span> subsetI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span>space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="skolem">x1</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insertion <span class="main">(</span><span class="skolem">x</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="skolem">x1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> A_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insertion <span class="skolem">x</span> <span class="main">(</span><span class="skolem">p_fix1</span> <span class="skolem">x1</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> p_fix1_def
        <span class="keyword1"><span class="command">unfolding</span></span> replace_coeff_extract_var_cong<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="skolem">x1</span>"</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="skolem">x1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main">,</span> <span class="operator">OF</span> fun_upd_same<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">using</span></span> insertion_replace_coeff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="skolem">x1</span><span class="main">)</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">using</span></span>  insertion_irrelevant_vars<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"replace_coeff <span class="main">(</span>insertion <span class="main">(</span><span class="skolem">x</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="skolem">x1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>extract_var <span class="skolem">p</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="skolem">x1</span><span class="main">)</span>"</span></span><span class="main">]</span>
         vars_replace_coeff fun_upd_other insertion_zero reduce_nested_mpoly_extract_var subset_eq
         v_not_in_vars_extract_var <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">f</span></span><span class="main">∈</span>space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span><span class="main">.</span> insertion <span class="bound">f</span> <span class="main">(</span><span class="skolem">p_fix1</span> <span class="skolem">x1</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">f</span></span><span class="main">∈</span>space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span><span class="main">.</span> insertion <span class="bound">f</span> <span class="main">(</span><span class="skolem">p_fix1</span> <span class="skolem">x1</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span><span class="main">∈</span>space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"insertion <span class="skolem">f</span> <span class="main">(</span><span class="skolem">p_fix1</span> <span class="skolem">x1</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insertion <span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="skolem">x1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹insertion <span class="skolem">f</span> <span class="main">(</span><span class="skolem">p_fix1</span> <span class="skolem">x1</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>›</span></span><span class="main">[</span><span class="operator">unfolded</span> p_fix1_def<span class="main">]</span>
        insertion_replace_coeff insertion_irrelevant_vars replace_coeff_extract_var_cong
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹insertion <span class="skolem">f</span> <span class="main">(</span><span class="skolem">p_fix1</span> <span class="skolem">x1</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹vars <span class="main">(</span><span class="skolem">p_fix1</span> <span class="skolem">x1</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{..&lt;</span><span class="skolem">n</span><span class="main">}</span>›</span></span>
        fun_upd_other fun_upd_same lessThan_iff order_less_irrefl p_fix1_def reduce_nested_mpoly_extract_var subsetCE<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="skolem">x1</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> A_def <span class="keyword1"><span class="command">using</span></span> space_lborel_add_dim
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">∈</span> space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span>›</span></span> lborel_f_def mem_Collect_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">f</span></span><span class="main">∈</span>space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">f</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="skolem">x1</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">f</span> <span class="main">∈</span> space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x1</span><span class="main">.</span> <span class="bound">x1</span><span class="main">∈</span><span class="skolem">N</span> <span class="main">⟹</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span>space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="bound">x1</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">}</span> <span class="main">∈</span> sets <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> emeasure_in_N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x1</span><span class="main">.</span> <span class="bound">x1</span><span class="main">∈</span><span class="skolem">N</span> <span class="main">⟹</span> emeasure <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span>space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="bound">x1</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">}</span> <span class="main">=</span> emeasure <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x1</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x1</span><span class="main">∈</span><span class="skolem">N</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p_fix1</span> <span class="skolem">x1</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> N_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> insertion <span class="bound">f</span> <span class="main">(</span><span class="skolem">p_fix1</span> <span class="skolem">x1</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insertion_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">f</span></span> <span class="main">∈</span> space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span><span class="main">.</span> insertion <span class="bound">f</span> <span class="main">(</span><span class="skolem">p_fix1</span> <span class="skolem">x1</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span>space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="skolem">x1</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">}</span> <span class="main">∈</span> sets <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> set_eq
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="bound"><span class="bound">f</span></span> <span class="main">∈</span> space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span><span class="main">.</span> insertion <span class="bound">f</span> <span class="main">(</span><span class="skolem">p_fix1</span> <span class="skolem">x1</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span>›</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span>space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="skolem">x1</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">}</span> <span class="main">=</span> emeasure <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> set_eq
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="bound"><span class="bound">f</span></span> <span class="main">∈</span> space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span><span class="main">.</span> insertion <span class="bound">f</span> <span class="main">(</span><span class="skolem">p_fix1</span> <span class="skolem">x1</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> emeasure_not_in_N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x1</span><span class="main">.</span> <span class="bound">x1</span><span class="main">∉</span><span class="skolem">N</span> <span class="main">⟹</span> emeasure <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span>space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="bound">x1</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x1</span><span class="main">.</span> <span class="bound">x1</span><span class="main">∉</span><span class="skolem">N</span> <span class="main">⟹</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span>space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="bound">x1</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">}</span> <span class="main">∈</span> sets <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x1</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x1</span><span class="main">∉</span><span class="skolem">N</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p_fix1</span> <span class="skolem">x1</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p_fix1_def N_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">f</span></span><span class="main">∈</span>space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span><span class="main">.</span> insertion <span class="bound">f</span> <span class="main">(</span><span class="skolem">p_fix1</span> <span class="skolem">x1</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
              <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">f</span></span><span class="main">∈</span>space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span><span class="main">.</span> insertion <span class="bound">f</span> <span class="main">(</span><span class="skolem">p_fix1</span> <span class="skolem">x1</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">∈</span> sets <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc.IH<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">p_fix1</span> <span class="skolem">x1</span> <span class="main">≠</span> <span class="main">0</span>›</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">x1</span><span class="main">.</span> vars <span class="main">(</span><span class="skolem">p_fix1</span> <span class="bound">x1</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{..&lt;</span><span class="skolem">n</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span>space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="skolem">x1</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span>space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="skolem">x1</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">}</span> <span class="main">∈</span> sets <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">{</span><span class="bound"><span class="bound">f</span></span><span class="main">∈</span>space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span><span class="main">.</span> insertion <span class="bound">f</span> <span class="main">(</span><span class="skolem">p_fix1</span> <span class="skolem">x1</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">∈</span> sets <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span>›</span></span>
        <span class="quoted"><span class="quoted">‹emeasure <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">f</span></span><span class="main">∈</span>space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span><span class="main">.</span> insertion <span class="bound">f</span> <span class="main">(</span><span class="skolem">p_fix1</span> <span class="skolem">x1</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>›</span></span>
      <span class="keyword1"><span class="command">using</span></span> set_eq
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">∈</span> null_sets lborel"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">N</span>›</span></span> finite_imp_null_set_lborel <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> ae_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x1</span> <span class="keyword1">in</span> lborel<span class="main">.</span> emeasure <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="bound">x1</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> AE_I'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">N</span> <span class="main">∈</span> null_sets lborel›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">x1</span><span class="main">.</span> <span class="bound">x1</span><span class="main">∉</span><span class="skolem">N</span> <span class="main">⟹</span> emeasure <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span>space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="bound">x1</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">}</span> <span class="main">=</span> <span class="main">0</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

  <span class="keyword1"><span class="command">have</span></span> measurable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x1</span><span class="main">.</span> emeasure <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="bound">x1</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> borel_measurable lborel"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> borel_measurableI<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x1</span><span class="main">.</span> emeasure <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="bound">x1</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span><span class="main">::</span><span class="quoted"><span class="quoted">"ennreal set"</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"open <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">∈</span><span class="skolem">S</span> <span class="main">⟹</span> <span class="main">-</span> <span class="skolem">N</span> <span class="main">⊆</span> <span class="var">?f</span> <span class="main">-`</span> <span class="skolem">S</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> emeasure_not_in_N <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">S</span> <span class="main">⟹</span> <span class="skolem">N</span> <span class="main">⊆</span> <span class="var">?f</span> <span class="main">-`</span> <span class="skolem">S</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> emeasure_in_N <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">∉</span><span class="skolem">S</span> <span class="main">⟹</span> <span class="var">?f</span> <span class="main">-`</span> <span class="skolem">S</span> <span class="main">⊆</span> <span class="skolem">N</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> emeasure_not_in_N <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">S</span> <span class="main">⟹</span> <span class="var">?f</span> <span class="main">-`</span> <span class="skolem">S</span> <span class="main">⊆</span> <span class="main">-</span><span class="skolem">N</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> emeasure_in_N <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">-`</span> <span class="skolem">S</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="var">?f</span> <span class="main">-`</span> <span class="skolem">S</span> <span class="main">=</span> <span class="skolem">N</span> <span class="main">∨</span> <span class="var">?f</span> <span class="main">-`</span> <span class="skolem">S</span> <span class="main">=</span> UNIV <span class="main">∨</span> <span class="var">?f</span> <span class="main">-`</span> <span class="skolem">S</span> <span class="main">=</span> <span class="main">-</span> <span class="skolem">N</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">∈</span><span class="skolem">S</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span>space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">S</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> 0 1 2 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="main">-`</span> <span class="skolem">S</span>  <span class="main">∩</span> space lborel <span class="main">∈</span> sets lborel"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="skolem">N</span>›</span></span> finite_imp_null_set_lborel borel_comp null_setsD2 sets_lborel <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> sets <span class="main">(</span>lborel_f <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> A_def
    <span class="keyword1"><span class="command">using</span></span> pred_eq_const1<span class="main">[</span><span class="operator">OF</span> measurable_insertion<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹vars <span class="skolem">p</span> <span class="main">⊆</span> <span class="main">{..&lt;</span>Suc <span class="skolem">n</span><span class="main">}</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> pred_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> in_sets<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">f</span></span> <span class="main">∈</span> space <span class="main">(</span>lborel_f <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> insertion <span class="bound">f</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span> <span class="main">∈</span> sets <span class="main">(</span>lborel_f <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x1</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span>space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="bound">x1</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">}</span> <span class="main">∈</span> sets <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">x1</span><span class="main">.</span> <span class="bound">x1</span><span class="main">∈</span><span class="skolem">N</span> <span class="main">⟹</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span>space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="bound">x1</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">}</span> <span class="main">∈</span> sets <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span>›</span></span>
    <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">x1</span><span class="main">.</span> <span class="bound">x1</span><span class="main">∉</span><span class="skolem">N</span> <span class="main">⟹</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span>space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="bound">x1</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">}</span> <span class="main">∈</span> sets <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>lborel_f <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">A</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">y</span><span class="main">.</span> emeasure <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">}</span> <span class="main">∂</span>lborel"</span></span>
    <span class="keyword1"><span class="command">using</span></span> emeasure_lborel_f_Suc<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">∈</span> sets <span class="main">(</span>lborel_f <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>›</span></span><span class="main">]</span>
     <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">x1</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span>space <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">(</span><span class="skolem">n</span> <span class="main">:=</span> <span class="bound">x1</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">}</span> <span class="main">∈</span> sets <span class="main">(</span>lborel_f <span class="skolem">n</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nn_integral_0_iff_AE<span class="main">[</span><span class="operator">OF</span> measurable<span class="main">]</span> ae_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>lborel_f <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">A</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> null_sets_def <span class="keyword1"><span class="command">using</span></span> in_sets A_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="DL_Shallow_Model">
<div class="head">
<h1>Theory DL_Shallow_Model</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Alexander Bentkamp, Universität des Saarlandes
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Shallow Network Model›</span></span>

<span class="keyword1"><span class="command">theory</span></span> DL_Shallow_Model
<span class="keyword2"><span class="keyword">imports</span></span> <a href="DL_Network.html">DL_Network</a> <a href="Tensor_Rank.html">Tensor_Rank</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">shallow_model'</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">shallow_model'</span> <span class="free"><span class="bound"><span class="entity">Z</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">0</span> <span class="main">=</span> Conv <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Z</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span> <span class="main">(</span>Input <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">shallow_model'</span> <span class="free"><span class="bound"><span class="entity">Z</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span> <span class="main">=</span> Pool <span class="main">(</span><span class="free">shallow_model'</span> <span class="free"><span class="bound"><span class="entity">Z</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="free">shallow_model'</span> <span class="free"><span class="bound"><span class="entity">Z</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">shallow_model</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">shallow_model</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="free"><span class="bound"><span class="entity">Z</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span> <span class="main">=</span> Conv <span class="main">(</span><span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Z</span></span></span><span class="main">)</span> <span class="main">(</span>shallow_model' <span class="free"><span class="bound"><span class="entity">Z</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">N</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="DL_Shallow_Model-valid_shallow_model'"><span class="command">lemma</span></span> valid_shallow_model'<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_net <span class="main">(</span>shallow_model' <span class="free">Z</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">N</span></span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> shallow_model'.simps
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_net.intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> shallow_model'.elims shallow_model'.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> valid_net.intros output_size.simps<span class="main">)</span>

<span class="keyword1" id="DL_Shallow_Model-output_size_shallow_model'"><span class="command">lemma</span></span> output_size_shallow_model'<span class="main">:</span> <span class="quoted"><span class="quoted">"output_size <span class="main">(</span>shallow_model' <span class="free">Z</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span> <span class="free">Z</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">N</span></span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> shallow_model'.simps <span class="keyword1"><span class="command">using</span></span> output_size.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="DL_Shallow_Model-valid_shallow_model"><span class="command">lemma</span></span> valid_shallow_model<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_net <span class="main">(</span>shallow_model <span class="free">Y</span> <span class="free">Z</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> shallow_model_def <span class="keyword1"><span class="command">using</span></span> valid_shallow_model' valid_net.intros output_size.simps output_size_shallow_model' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="DL_Shallow_Model-output_size_shallow_model"><span class="command">lemma</span></span> output_size_shallow_model<span class="main">:</span> <span class="quoted"><span class="quoted">"output_size <span class="main">(</span>shallow_model <span class="free">Y</span> <span class="free">Z</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> shallow_model_def <span class="keyword1"><span class="command">using</span></span> output_size_shallow_model' output_size.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="DL_Shallow_Model-input_sizes_shallow_model"><span class="command">lemma</span></span> input_sizes_shallow_model<span class="main">:</span> <span class="quoted"><span class="quoted">"input_sizes <span class="main">(</span>shallow_model <span class="free">Y</span> <span class="free">Z</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span> replicate <span class="main">(</span>Suc <span class="free">N</span><span class="main">)</span> <span class="free">M</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">N</span></span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> shallow_model_def input_sizes.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="DL_Shallow_Model-balanced_net_shallow_model'"><span class="command">lemma</span></span> balanced_net_shallow_model'<span class="main">:</span> <span class="quoted"><span class="quoted">"balanced_net <span class="main">(</span>shallow_model' <span class="free">Z</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">N</span></span><span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> balanced_net.simps shallow_model'.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">N</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count_weights True <span class="main">(</span>Conv <span class="main">(</span><span class="free">Z</span><span class="main">,</span> <span class="free">M</span><span class="main">)</span> <span class="main">(</span>Input <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> count_weights True <span class="main">(</span>shallow_model' <span class="free">Z</span> <span class="free">M</span> <span class="skolem">N</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">N</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> shallow_model'.simps 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc.IH balanced_net_Conv balanced_net_Input balanced_net_Pool<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Shallow_Model-balanced_net_shallow_model"><span class="command">lemma</span></span> balanced_net_shallow_model<span class="main">:</span> <span class="quoted"><span class="quoted">"balanced_net <span class="main">(</span>shallow_model <span class="free">Y</span> <span class="free">Z</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> shallow_model_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> balanced_net_Conv balanced_net_shallow_model'<span class="main">)</span>

<span class="keyword1" id="DL_Shallow_Model-cprank_max1_shallow_model'"><span class="command">lemma</span></span> cprank_max1_shallow_model'<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&lt;</span> output_size <span class="main">(</span>shallow_model' <span class="free">Z</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cprank_max1 <span class="main">(</span>tensors_from_net <span class="main">(</span>insert_weights <span class="free">s</span> <span class="main">(</span>shallow_model' <span class="free">Z</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span> <span class="free">w</span><span class="main">)</span> <span class="main">$</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">N</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">w</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"input_sizes <span class="main">(</span>insert_weights <span class="free">s</span> <span class="main">(</span>shallow_model' <span class="free">Z</span> <span class="free">M</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free">M</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> shallow_model_def shallow_model'.simps insert_weights.simps
    input_sizes.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dims <span class="main">(</span>tensors_from_net <span class="main">(</span>insert_weights <span class="free">s</span> <span class="main">(</span>shallow_model' <span class="free">Z</span> <span class="free">M</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">$</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free">M</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dims_tensors_from_net<span class="main">[</span><span class="operator">OF</span> vec_setI<span class="main">]</span> <span class="quoted">"0.prems"</span><span class="main">(</span>1<span class="main">)</span> output_size_correct_tensors
    remove_insert_weights valid_shallow_model' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> order1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def eq_imp_le length_Cons list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">N</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> y_le_IH<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&lt;</span> dim_vec <span class="main">(</span>tensors_from_net <span class="main">(</span>insert_weights <span class="free">s</span> <span class="main">(</span>shallow_model' <span class="free">Z</span> <span class="free">M</span> <span class="skolem">N</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">w</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">(</span>count_weights <span class="free">s</span> <span class="main">(</span>shallow_model' <span class="free">Z</span> <span class="free">M</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> output_size_correct_tensors<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"insert_weights <span class="free">s</span> <span class="main">(</span>shallow_model' <span class="free">Z</span> <span class="free">M</span> <span class="skolem">N</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">w</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">(</span>count_weights <span class="free">s</span> <span class="main">(</span>shallow_model' <span class="free">Z</span> <span class="free">M</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">,</span>
    <span class="operator">unfolded</span> remove_insert_weights<span class="main">,</span> <span class="operator">OF</span> valid_shallow_model'<span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> Suc.prems<span class="main">(</span>1<span class="main">)</span> output_size_shallow_model' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> cprank_max1_IH<span class="main">:</span><span class="quoted"><span class="quoted">"cprank_max1 <span class="main">(</span>tensors_from_net <span class="main">(</span>insert_weights <span class="free">s</span> <span class="main">(</span>shallow_model' <span class="free">Z</span> <span class="free">M</span> <span class="skolem">N</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">w</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">(</span>count_weights <span class="free">s</span> <span class="main">(</span>shallow_model' <span class="free">Z</span> <span class="free">M</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc.IH Suc.prems<span class="main">(</span>1<span class="main">)</span> output_size_shallow_model' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> y_le_0<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&lt;</span> dim_vec <span class="main">(</span>tensors_from_net <span class="main">(</span>insert_weights <span class="free">s</span> <span class="main">(</span>shallow_model' <span class="free">Z</span> <span class="free">M</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms output_size_correct_tensors output_size_shallow_model' remove_insert_weights valid_shallow_model'<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> cprank_max1_0<span class="main">:</span><span class="quoted"><span class="quoted">"cprank_max1 <span class="main">(</span>tensors_from_net <span class="main">(</span>insert_weights <span class="free">s</span> <span class="main">(</span>shallow_model' <span class="free">Z</span> <span class="free">M</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">$</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"input_sizes <span class="main">(</span>insert_weights <span class="free">s</span> <span class="main">(</span>shallow_model' <span class="free">Z</span> <span class="free">M</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="free">M</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> shallow_model_def shallow_model'.simps insert_weights.simps
      input_sizes.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> order1 dims_tensors_from_net<span class="main">[</span><span class="operator">OF</span> vec_setI<span class="main">]</span>  One_nat_def eq_imp_le length_Cons list.size<span class="main">(</span>3<span class="main">)</span> y_le_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> shallow_model'.simps<span class="main">(</span>2<span class="main">)</span> insert_weights.simps tensors_from_net.simps
    <span class="keyword1"><span class="command">using</span></span> cprank_max1_IH cprank_max1_0 cprank_max1_prod index_component_mult y_le_0 y_le_IH 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.IH output_size_correct_tensors remove_insert_weights valid_shallow_model'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="DL_Shallow_Model-cprank_shallow_model"><span class="command">lemma</span></span> cprank_shallow_model<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> insert_weights <span class="free">s</span> <span class="main">(</span>shallow_model <span class="free">Y</span> <span class="free">Z</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span> <span class="free">w</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">&lt;</span> <span class="free">Y</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cprank <span class="main">(</span>tensors_from_net <span class="free">m</span> <span class="main">$</span> <span class="free">y</span><span class="main">)</span> <span class="main">≤</span> <span class="free">Z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⟹</span> shared_weight_net <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> balanced_net_shallow_model shared_weight_net_insert_weights<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cprank_max <span class="free">Z</span> <span class="main">(</span>tensors_from_net <span class="free">m</span> <span class="main">$</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> dim_extract<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_row <span class="main">(</span>extract_matrix <span class="free">w</span> <span class="free">Y</span> <span class="free">Z</span><span class="main">)</span> <span class="main">=</span> <span class="free">Y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> dim_extract_matrix<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> dimc_extract_matrix<span class="main">:</span> <span class="quoted"><span class="quoted">"dim_col <span class="main">(</span>extract_matrix <span class="free">w</span> <span class="free">Y</span> <span class="free">Z</span><span class="main">)</span> <span class="main">=</span> <span class="free">Z</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> dim_extract_matrix<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">have</span></span> input_sizes<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>input_sizes <span class="main">(</span>insert_weights <span class="free">s</span> <span class="main">(</span>shallow_model' <span class="free">Z</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">w</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="free">Y</span> <span class="main">*</span> <span class="free">Z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>input_sizes <span class="main">(</span>shallow_model' <span class="free">Z</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> input_sizes_remove_weights remove_insert_weights <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span><span class="quoted"><span class="quoted">"tensors_from_net <span class="free">m</span> <span class="main">$</span> <span class="free">y</span> <span class="main">=</span> Tensor_Plus.listsum <span class="main">(</span>input_sizes <span class="main">(</span>shallow_model' <span class="free">Z</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">(</span>extract_matrix <span class="free">w</span> <span class="free">Y</span> <span class="free">Z</span><span class="main">)</span>  <span class="main">$$</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span>tensors_from_net <span class="main">(</span>insert_weights <span class="free">s</span> <span class="main">(</span>shallow_model' <span class="free">Z</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">w</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="free">Y</span> <span class="main">*</span> <span class="free">Z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">Z</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="free">m</span> <span class="main">=</span> insert_weights <span class="free">s</span> <span class="main">(</span>shallow_model <span class="free">Y</span> <span class="free">Z</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span> <span class="free">w</span>›</span></span> shallow_model_def insert_weights.simps tensors_from_net.simps
      <span class="keyword1"><span class="command">using</span></span> nth_mat_tensorlist_mult dims_tensors_from_net assms<span class="main">(</span>2<span class="main">)</span> dim_extract output_size_correct_tensors<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"insert_weights <span class="free">s</span> <span class="main">(</span>shallow_model' <span class="free">Z</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">w</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="free">Y</span> <span class="main">*</span> <span class="free">Z</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> remove_insert_weights<span class="main">,</span> <span class="operator">OF</span> valid_shallow_model'<span class="main">]</span>
      dimc_extract_matrix output_size_shallow_model' input_sizes <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Bs</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> extract_matrix <span class="free">w</span> <span class="free">Y</span> <span class="free">Z</span> <span class="main">$$</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span> <span class="main">⋅</span> tensors_from_net <span class="main">(</span>insert_weights <span class="free">s</span> <span class="main">(</span>shallow_model' <span class="free">Z</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">w</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="free">Y</span> <span class="main">*</span> <span class="free">Z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="bound">j</span><span class="main">)</span> <span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">Z</span><span class="main">]</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">B</span><span class="main">.</span> <span class="bound">B</span> <span class="main">∈</span> set <span class="skolem">Bs</span> <span class="main">⟹</span> cprank_max1 <span class="bound">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">B</span><span class="main">.</span> <span class="bound">B</span> <span class="main">∈</span> set <span class="skolem">Bs</span> <span class="main">⟹</span> dims <span class="bound">B</span> <span class="main">=</span> input_sizes <span class="main">(</span>shallow_model' <span class="free">Z</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">B</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈</span> set <span class="skolem">Bs</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="skolem">Bs</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="skolem">Bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> in_set_conv_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">Z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> length_map Bs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"cprank_max1 <span class="main">(</span>tensors_from_net <span class="main">(</span>insert_weights <span class="free">s</span> <span class="main">(</span>shallow_model' <span class="free">Z</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">w</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="free">Y</span> <span class="main">*</span> <span class="free">Z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">Z</span>›</span></span> output_size_shallow_model' cprank_max1_shallow_model' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cprank_max1 <span class="main">(</span>extract_matrix <span class="free">w</span> <span class="free">Y</span> <span class="free">Z</span> <span class="main">$$</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">⋅</span> tensors_from_net <span class="main">(</span>insert_weights <span class="free">s</span> <span class="main">(</span>shallow_model' <span class="free">Z</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">w</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="free">Y</span> <span class="main">*</span> <span class="free">Z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> smult_prod_extract1 cprank_max1_order0<span class="main">[</span><span class="operator">OF</span> 1<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"extract_matrix <span class="free">w</span> <span class="free">Y</span> <span class="free">Z</span> <span class="main">$$</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">1</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dims_smult mult.left_neutral order_tensor_one<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"cprank_max1 <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Bs_def <span class="quoted"><span class="quoted">‹<span class="skolem">B</span> <span class="main">=</span> <span class="skolem">Bs</span> <span class="main">!</span> <span class="skolem">j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">Z</span>›</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dims <span class="skolem">B</span> <span class="main">=</span> input_sizes <span class="main">(</span>shallow_model' <span class="free">Z</span> <span class="free">M</span> <span class="free">N</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">B</span> <span class="main">=</span> <span class="skolem">Bs</span> <span class="main">!</span> <span class="skolem">j</span>›</span></span> Bs_def
        nth_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">Z</span><span class="main">]</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> length_upt Nat.diff_0<span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">Z</span>›</span></span><span class="main">]</span> dims_smult
        input_sizes<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> dims_tensors_from_net<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> vec_setI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">j</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">Z</span>›</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">Z</span>›</span></span> output_size_correct_tensors output_size_shallow_model' remove_insert_weights valid_shallow_model'<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> 0 <span class="keyword1"><span class="command">using</span></span> cprank_maxI length_map Bs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> diff_zero length_upt<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> cprank_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Least_le<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="DL_Fundamental_Theorem_Network_Capacity">
<div class="head">
<h1>Theory DL_Fundamental_Theorem_Network_Capacity</h1>
</div>
<pre class="source"><span class="comment1">(* Author: Alexander Bentkamp, Universität des Saarlandes
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Fundamental Theorem of Network Capacity›</span></span>

<span class="keyword1"><span class="command">theory</span></span> DL_Fundamental_Theorem_Network_Capacity
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="DL_Rank_CP_Rank.html">DL_Rank_CP_Rank</a> <a href="DL_Deep_Model_Poly.html">DL_Deep_Model_Poly</a> <a href="Lebesgue_Zero_Set.html">Lebesgue_Zero_Set</a> 
  <a href="../Jordan_Normal_Form/DL_Rank_Submatrix.html">Jordan_Normal_Form.DL_Rank_Submatrix</a> <span class="quoted">"<a href="../../HOL/HOL-Analysis/Complete_Measure.html">HOL-Analysis.Complete_Measure</a>"</span> <a href="DL_Shallow_Model.html">DL_Shallow_Model</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span> deep_model_correct_params_y
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">polynomial_f</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> det <span class="main">(</span>submatrix <span class="main">(</span>matricize <span class="main">{</span><span class="bound">n</span><span class="main">.</span> even <span class="bound">n</span><span class="main">}</span> <span class="main">(</span>A <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span><span class="main">)</span> rows_with_1 rows_with_1<span class="main">)</span>"</span></span>


<span class="keyword1" id="DL_Fundamental_Theorem_Network_Capacity-polyfun_polynomial"><span class="command">lemma</span></span> polyfun_polynomial<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"polyfun <span class="main">{..&lt;</span>weight_space_dim<span class="main">}</span> polynomial_f"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> polynomial_f_def <span class="keyword1"><span class="command">using</span></span> polyfun_det_deep_model <span class="keyword1"><span class="command">unfolding</span></span> witness_submatrix_def A'_def <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">polynomial_p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">p</span><span class="main">.</span> vars <span class="bound">p</span> <span class="main">⊆</span> <span class="main">{..&lt;</span>weight_space_dim<span class="main">}</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> insertion <span class="bound">x</span> <span class="bound">p</span> <span class="main">=</span> polynomial_f <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="DL_Fundamental_Theorem_Network_Capacity-polynomial_p_not_0"><span class="command">lemma</span></span>
polynomial_p_not_0<span class="main">:</span> <span class="quoted"><span class="quoted">"polynomial_p<span class="main">≠</span><span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
vars_polynomial_p<span class="main">:</span> <span class="quoted"><span class="quoted">"vars polynomial_p <span class="main">⊆</span> <span class="main">{..&lt;</span>weight_space_dim<span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
polynomial_pf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span><span class="main">.</span> insertion <span class="bound">w</span> polynomial_p <span class="main">=</span> polynomial_f <span class="bound">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"vars polynomial_p <span class="main">⊆</span> <span class="main">{..&lt;</span>weight_space_dim<span class="main">}</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> insertion <span class="bound">x</span> polynomial_p <span class="main">=</span> polynomial_f <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> polynomial_p_def
    <span class="keyword1"><span class="command">using</span></span> someI_ex<span class="main">[</span><span class="operator">OF</span> polyfun_polynomial<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> polyfun_def<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"vars polynomial_p <span class="main">⊆</span> <span class="main">{..&lt;</span>weight_space_dim<span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span><span class="main">.</span> insertion <span class="bound">w</span> polynomial_p <span class="main">=</span> polynomial_f <span class="bound">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"polynomial_p<span class="main">≠</span><span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A'_def Aw'_def' <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">w</span><span class="main">.</span> insertion <span class="bound">w</span> polynomial_p <span class="main">=</span> polynomial_f <span class="bound">w</span>›</span></span> polynomial_f_def witness_det <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Fundamental_Theorem_Network_Capacity-if_polynomial_0_rank"><span class="command">lemma</span></span>  if_polynomial_0_rank<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"polynomial_f <span class="free">w</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"r <span class="main">^</span> N_half <span class="main">≤</span> cprank <span class="main">(</span>A <span class="free">w</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"r <span class="main">^</span> N_half <span class="main">=</span> dim_row <span class="main">(</span>submatrix <span class="main">(</span>matricize <span class="main">{</span><span class="bound">n</span><span class="main">.</span> even <span class="bound">n</span><span class="main">}</span> <span class="main">(</span>A <span class="free">w</span><span class="main">)</span><span class="main">)</span> rows_with_1 rows_with_1<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Aw'_def card_rows_with_1 dim_submatrix<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> dims_A dims_Aw dims_matricize<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> set_le_in<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> mrank <span class="main">(</span>matricize <span class="main">{</span><span class="bound">n</span><span class="main">.</span> even <span class="bound">n</span><span class="main">}</span> <span class="main">(</span>A <span class="free">w</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms vec_space.rank_gt_minor<span class="main">[</span><span class="operator">OF</span> carrier_matI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> dims_A'_pow<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> weight_space_dim_def<span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> A'_def dim_submatrix<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> dims_A'_pow<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> polynomial_f_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> cprank <span class="main">(</span>A <span class="free">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> matrix_rank_le_cp_rank <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Fundamental_Theorem_Network_Capacity-if_polynomial_0_evaluate"><span class="command">lemma</span></span>  if_polynomial_0_evaluate<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"polynomial_f <span class="free">wd</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">inputs</span><span class="main">.</span> input_sizes <span class="main">(</span>deep_model_l <span class="free">rs</span><span class="main">)</span> <span class="main">=</span> map dim_vec <span class="bound">inputs</span> <span class="main">⟶</span> evaluate_net <span class="main">(</span>insert_weights <span class="free">shared_weights</span> <span class="main">(</span>deep_model_l <span class="free">rs</span><span class="main">)</span> <span class="free">wd</span><span class="main">)</span> <span class="bound">inputs</span>
 <span class="main">=</span> evaluate_net <span class="main">(</span>insert_weights <span class="free">shared_weights</span> <span class="main">(</span>shallow_model <span class="main">(</span><span class="free">rs</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="free">Z</span> <span class="main">(</span>last <span class="free">rs</span><span class="main">)</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span>N_half<span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">ws</span><span class="main">)</span> <span class="bound">inputs</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Z</span> <span class="main">≥</span> r <span class="main">^</span> N_half"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> valid1<span class="main">:</span><span class="quoted"><span class="quoted">"valid_net' <span class="main">(</span>insert_weights <span class="free">shared_weights</span> <span class="main">(</span>deep_model_l <span class="free">rs</span><span class="main">)</span> <span class="free">wd</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> remove_insert_weights valid_deep_model <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">have</span></span> valid2<span class="main">:</span><span class="quoted"><span class="quoted">"valid_net' <span class="main">(</span>insert_weights <span class="free">shared_weights</span> <span class="main">(</span>shallow_model <span class="main">(</span><span class="free">rs</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="free">Z</span> <span class="main">(</span>last <span class="free">rs</span><span class="main">)</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span>N_half<span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">ws</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> remove_insert_weights valid_shallow_model<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> input_sizes<span class="main">:</span> <span class="quoted"><span class="quoted">"input_sizes <span class="main">(</span>insert_weights <span class="free">shared_weights</span> <span class="main">(</span>deep_model_l <span class="free">rs</span><span class="main">)</span> <span class="free">wd</span><span class="main">)</span>
    <span class="main">=</span> input_sizes <span class="main">(</span>insert_weights <span class="free">shared_weights</span> <span class="main">(</span>shallow_model <span class="main">(</span><span class="free">rs</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="free">Z</span> <span class="main">(</span>last <span class="free">rs</span><span class="main">)</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> N_half <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">ws</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> input_sizes_remove_weights input_sizes_deep_model remove_insert_weights 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> N_half_def input_sizes_shallow_model<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span><span class="quoted"><span class="quoted">"tensors_from_net <span class="main">(</span>insert_weights <span class="free">shared_weights</span> <span class="main">(</span>deep_model_l <span class="free">rs</span><span class="main">)</span> <span class="free">wd</span><span class="main">)</span>
        <span class="main">=</span> tensors_from_net <span class="main">(</span>insert_weights <span class="free">shared_weights</span> <span class="main">(</span>shallow_model <span class="main">(</span><span class="free">rs</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="free">Z</span> <span class="main">(</span>last <span class="free">rs</span><span class="main">)</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span>N_half <span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">ws</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tensors_from_net_eqI<span class="main">[</span><span class="operator">OF</span> valid1 valid2 input_sizes<span class="main">,</span> <span class="operator">unfolded</span> input_sizes_remove_weights remove_insert_weights<span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cprank <span class="main">(</span>tensors_from_net <span class="main">(</span>insert_weights <span class="free">shared_weights</span> <span class="main">(</span>deep_model_l <span class="free">rs</span><span class="main">)</span> <span class="free">wd</span><span class="main">)</span> <span class="main">$</span> <span class="free">y</span><span class="main">)</span> <span class="main">≤</span> <span class="free">Z</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> 0 <span class="keyword1"><span class="command">using</span></span> y_valid cprank_shallow_model <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
   <span class="keyword1"><span class="command">using</span></span> if_polynomial_0_rank assms
   <span class="keyword1"><span class="command">using</span></span> A_def assms<span class="main">(</span>1<span class="main">)</span>  less_le_trans not_le remove_insert_weights
   <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="DL_Fundamental_Theorem_Network_Capacity-if_polynomial_0_evaluate_notex"><span class="command">lemma</span></span>  if_polynomial_0_evaluate_notex<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"polynomial_f <span class="free">wd</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">weights_shallow</span> <span class="bound">Z</span><span class="main">.</span> <span class="bound">Z</span> <span class="main">&lt;</span> r <span class="main">^</span> N_half <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">inputs</span><span class="main">.</span> input_sizes <span class="main">(</span>deep_model_l <span class="free">rs</span><span class="main">)</span> <span class="main">=</span> map dim_vec <span class="bound">inputs</span> <span class="main">⟶</span>
evaluate_net <span class="main">(</span>insert_weights <span class="free">shared_weights</span> <span class="main">(</span>deep_model_l <span class="free">rs</span><span class="main">)</span> <span class="free">wd</span><span class="main">)</span> <span class="bound">inputs</span>
 <span class="main">=</span> evaluate_net <span class="main">(</span>insert_weights <span class="free">shared_weights</span> <span class="main">(</span>shallow_model <span class="main">(</span><span class="free">rs</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="bound">Z</span> <span class="main">(</span>last <span class="free">rs</span><span class="main">)</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span>N_half<span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">ws</span><span class="main">)</span> <span class="bound">inputs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms if_polynomial_0_evaluate not_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">theorem</span></span> fundamental_theorem_network_capacity<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">x</span> <span class="keyword1">in</span> lborel_f weight_space_dim<span class="main">.</span> r <span class="main">^</span> N_half <span class="main">≤</span> cprank <span class="main">(</span>A <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> AE_I'<span class="main">[</span><span class="operator">OF</span> lebesgue_mpoly_zero_set<span class="main"><span class="main">[</span></span><span class="operator">OF</span> polynomial_p_not_0 vars_polynomial_p<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Collect_mono if_polynomial_0_rank polynomial_pf<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> fundamental_theorem_network_capacity_v2<span class="main">:</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">AE</span> <span class="bound">wd</span> <span class="keyword1">in</span> lborel_f weight_space_dim<span class="main">.</span>
   <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">ws</span> <span class="bound">Z</span><span class="main">.</span> <span class="bound">Z</span> <span class="main">&lt;</span> r <span class="main">^</span> N_half <span class="main">∧</span>  <span class="main">(</span><span class="main">∀</span><span class="bound">inputs</span><span class="main">.</span> input_sizes <span class="main">(</span>deep_model_l <span class="free">rs</span><span class="main">)</span> <span class="main">=</span> map dim_vec <span class="bound">inputs</span> <span class="main">⟶</span>
evaluate_net <span class="main">(</span>insert_weights <span class="free">shared_weights</span> <span class="main">(</span>deep_model_l <span class="free">rs</span><span class="main">)</span> <span class="bound">wd</span><span class="main">)</span> <span class="bound">inputs</span>
 <span class="main">=</span> evaluate_net <span class="main">(</span>insert_weights <span class="free">shared_weights</span> <span class="main">(</span>shallow_model <span class="main">(</span><span class="free">rs</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="bound">Z</span> <span class="main">(</span>last <span class="free">rs</span><span class="main">)</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span>N_half<span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="bound">ws</span><span class="main">)</span> <span class="bound">inputs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> AE_I'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lebesgue_mpoly_zero_set<span class="main"><span class="main">[</span></span><span class="operator">OF</span> polynomial_p_not_0 vars_polynomial_p<span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> polynomial_pf<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> mem_Collect_eq
  <span class="keyword1"><span class="command">using</span></span> if_polynomial_0_evaluate_notex <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">lebesgue_f</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">lebesgue_f</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> completion <span class="main">(</span>lborel_f <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="DL_Fundamental_Theorem_Network_Capacity-space_lebesgue_f"><span class="command">lemma</span></span> space_lebesgue_f<span class="main">:</span> <span class="quoted"><span class="quoted">"space <span class="main">(</span>lebesgue_f <span class="free">n</span><span class="main">)</span> <span class="main">=</span> Pi<span class="hidden">⇩</span><sub>E</sub> <span class="main">{..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> UNIV<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> space_lborel_f<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> fundamental_theorem_network_capacity_v3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">wd</span></span> <span class="main">∈</span> space <span class="main">(</span>lebesgue_f weight_space_dim<span class="main">)</span><span class="main">.</span>
      <span class="main">∃</span><span class="bound">ws</span> <span class="bound">Z</span><span class="main">.</span> <span class="bound">Z</span> <span class="main">&lt;</span> r <span class="main">^</span> N_half <span class="main">∧</span>  <span class="main">(</span><span class="main">∀</span><span class="bound">inputs</span><span class="main">.</span> input_sizes <span class="main">(</span>deep_model_l <span class="free">rs</span><span class="main">)</span> <span class="main">=</span> map dim_vec <span class="bound">inputs</span> <span class="main">⟶</span>
        evaluate_net <span class="main">(</span>insert_weights <span class="free">shared_weights</span> <span class="main">(</span>deep_model_l <span class="free">rs</span><span class="main">)</span> <span class="bound">wd</span><span class="main">)</span> <span class="bound">inputs</span>
      <span class="main">=</span> evaluate_net <span class="main">(</span>insert_weights <span class="free">shared_weights</span> <span class="main">(</span>shallow_model <span class="main">(</span><span class="free">rs</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span> <span class="bound">Z</span> <span class="main">(</span>last <span class="free">rs</span><span class="main">)</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span>N_half<span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="bound">ws</span><span class="main">)</span> <span class="bound">inputs</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">∈</span> null_sets <span class="main">(</span>completion <span class="main">(</span>lborel_f weight_space_dim<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> assms
  <span class="keyword1"><span class="command">using</span></span> fundamental_theorem_network_capacity_v2<span class="main">[</span><span class="operator">unfolded</span> completion.AE_iff_null_sets<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> AE_completion_iff<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">unfolded</span> not_not<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>