<div id="Auxiliary">
<div class="head">
<h1>Theory Auxiliary</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Auxiliary
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a> <span class="quoted">"<a href="../../HOL/HOL-Library/Extended_Nonnegative_Real.html">HOL-Library.Extended_Nonnegative_Real</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary Material›</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Auxiliary-Max_image_commute"><span class="command">lemma</span></span> Max_image_commute<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">MAX</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="keyword1">MAX</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">MAX</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="keyword1">MAX</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Max_eq_if<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 3
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> Max_in<span class="main">[</span><span class="operator">OF</span> finite_imageI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="free">S</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">a</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span><span class="free">f</span> <span class="skolem">a</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span> <span class="main">∈</span> <span class="free">f</span> <span class="skolem">a</span> <span class="main">`</span> <span class="free">S</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> Max <span class="main">(</span><span class="free">f</span> <span class="skolem">a</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">MAX</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="skolem">b</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Max_ge finite_imageI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="free">S</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">b</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> Max <span class="main">(</span><span class="free">f</span> <span class="skolem">a</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">MAX</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> 4
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> Max_in<span class="main">[</span><span class="operator">OF</span> finite_imageI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="free">S</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">a</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="skolem">b</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">MAX</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">MAX</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">≤</span> Max <span class="main">(</span><span class="free">f</span> <span class="skolem">a</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Max_ge finite_imageI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="free">S</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">=</span> <span class="main">_</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">MAX</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">≤</span> Max <span class="main">(</span><span class="free">f</span> <span class="bound">a</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> <span class="quoted"><span class="quoted">‹finite <span class="free">S</span>›</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Auxiliary-Max_image_left_mult"><span class="command">lemma</span></span> Max_image_left_mult<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">MAX</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">c</span> <span class="main">::</span> ennreal<span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">MAX</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Max_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">S</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> y
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">S</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mult_left_mono<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Max_in<span class="main">[</span><span class="operator">OF</span> finite_imageI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹finite <span class="free">S</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Finite set *)</span>

<span class="keyword1" id="Auxiliary-Max_to_image"><span class="command">lemma</span></span> Max_to_image<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Max <span class="main">{</span><span class="free">f</span> <span class="bound">t</span> <span class="main">|</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">S</span><span class="main">}</span> <span class="main">=</span> Max <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">Max</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Auxiliary-Max_to_image2"><span class="command">lemma</span></span> Max_to_image2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Max <span class="main">{</span><span class="free">f</span> <span class="bound">t</span> <span class="main">|</span> <span class="bound">t</span><span class="main">.</span> <span class="free">P</span> <span class="bound">t</span><span class="main">}</span> <span class="main">=</span> Max <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="bound">t</span><span class="main">.</span> <span class="free">P</span> <span class="bound">t</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">Max</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Auxiliary-Max_image_cong"><span class="command">lemma</span></span> Max_image_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Max <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> Max <span class="main">(</span><span class="free">g</span> <span class="main">`</span> <span class="free">T</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">T</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> arg_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">Max</span></span></span><span class="main"><span class="main">]</span></span> image_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> that<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Auxiliary-Max_image_cong_simp"><span class="command">lemma</span></span> Max_image_cong_simp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Max <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> Max <span class="main">(</span><span class="free">g</span> <span class="main">`</span> <span class="free">T</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">T</span> <span class="keyword1">=simp=&gt;</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Max_image_cong<span class="main">[</span><span class="operator">OF</span> that<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> simp_implies_def<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Auxiliary-Max_eq_image_if"><span class="command">lemma</span></span> Max_eq_image_if<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">T</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">g</span> <span class="bound">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">T</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> Max <span class="main">(</span><span class="free">g</span> <span class="main">`</span> <span class="free">T</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Max_eq_if<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> Max_in_image<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">x</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> Max_in<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="free">A</span>"</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">`</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Auxiliary-Max_ge_image"><span class="command">lemma</span></span> Max_ge_image<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Max <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span> <span class="main">≥</span> <span class="free">f</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Max_ge<span class="main">)</span>

<span class="keyword1" id="Auxiliary-Max_image_pair"><span class="command">lemma</span></span> Max_image_pair<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">MAX</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="keyword1">MAX</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">T</span><span class="main">.</span> <span class="free">f</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">MAX</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">×</span> <span class="free">T</span><span class="main">.</span> <span class="free">f</span> <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> Max_eq_image_if<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">T</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">T</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span> <span class="main">`</span> <span class="free">T</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Max_in_image<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">a</span> <span class="skolem">b</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">T</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">use</span> assms <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="operator">auto</span><span class="main">)</span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">argmax</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">argmax</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span>
    List.fold <span class="main">(</span><span class="main">λ</span> <span class="bound">a</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">let</span> <span class="bound">w</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span> <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">w</span> <span class="main">&gt;</span> <span class="bound">v</span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Auxiliary-list_cases"><span class="command">lemma</span></span> list_cases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">[]</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="bound">y</span> <span class="main">#</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="bound">y</span> <span class="main">#</span> <span class="bound">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> y ys
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ys</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Auxiliary-argmax"><span class="command">lemma</span></span> argmax<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"fst <span class="main">(</span>argmax <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span>"</span></span><span class="main">)</span>
    <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span>fst <span class="main">(</span>argmax <span class="free">f</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span>argmax <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span>"</span></span><span class="main">)</span>
    <span class="quoted"><span class="quoted">"snd <span class="main">(</span>argmax <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">MAX</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?C</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">a</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">let</span> <span class="bound">w</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">a</span> <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">w</span> <span class="main">&gt;</span> <span class="bound">v</span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">w</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>List.fold <span class="var">?f</span> <span class="skolem">xs</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="free">f</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∪</span> set <span class="skolem">xs</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">xs</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_nonempty_induct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def max_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span>fst <span class="main">(</span>List.fold <span class="var">?f</span> <span class="skolem">xs</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="free">f</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span>List.fold <span class="var">?f</span> <span class="skolem">xs</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="free">f</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">xs</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_nonempty_induct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def max_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>List.fold <span class="var">?f</span> <span class="skolem">xs</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="free">f</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">MAX</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∪</span> set <span class="skolem">xs</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span><span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span> <span class="skolem">xs</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_nonempty_induct<span class="main">)</span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def max_def<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_cases<span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Theory *)</span></pre>
</div><div id="Hidden_Markov_Model">
<div class="head">
<h1>Theory Hidden_Markov_Model</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Hidden Markov Models›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Hidden_Markov_Model
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="../Markov_Models/Discrete_Time_Markov_Chain.html">Markov_Models.Discrete_Time_Markov_Chain</a> <a href="Auxiliary.html">Auxiliary</a>
    <span class="quoted">"<a href="../../HOL/HOL-Library/IArray.html">HOL-Library.IArray</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definitions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Definition of Markov Kernels that are closed w.r.t. to a set of states.›</span></span>
<span class="keyword1"><span class="command">locale</span></span> Closed_Kernel <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">K</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'t</span> pmf"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> wellformed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> closed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span><span class="main">.</span> <span class="free">K</span> <span class="bound">s</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  An HMM is parameterized by a Markov kernel for the transition probabilites between internal states,
  a Markov kernel for the output probabilities of observations,
  and a fixed set of observations.
›</span></span>
<span class="keyword1"><span class="command">locale</span></span> HMM_defs <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">𝒦</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span> pmf"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝒪</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'t</span> pmf"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝒪<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> set"</span></span>

<span class="keyword1"><span class="command">locale</span></span> HMM <span class="main">=</span>
  HMM_defs <span class="main">+</span> O<span class="main">:</span> Closed_Kernel <span class="quoted"><span class="free">𝒪</span></span> <span class="quoted"><span class="free">𝒪<span class="hidden">⇩</span><sub>s</sub></span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Hidden_Markov_Model-observations_finite"><span class="command">lemma</span></span> observations_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">𝒪<span class="hidden">⇩</span><sub>s</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> observations_wellformed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">𝒪<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> observations_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span><span class="main">.</span> <span class="free">𝒪</span> <span class="bound">s</span> <span class="main">⊆</span> <span class="free">𝒪<span class="hidden">⇩</span><sub>s</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> O.finite O.wellformed O.closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Fixed set of internal states.›</span></span>
<span class="keyword1"><span class="command">locale</span></span> HMM2_defs <span class="main">=</span> HMM_defs <span class="quoted"><span class="free">𝒦</span></span> <span class="quoted"><span class="free">𝒪</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">𝒦</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span> pmf"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝒪</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'t</span> pmf"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">𝒮</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> set"</span></span>

<span class="keyword1"><span class="command">locale</span></span> HMM2 <span class="main">=</span> HMM2_defs <span class="main">+</span> HMM <span class="main">+</span> K<span class="main">:</span> Closed_Kernel <span class="quoted"><span class="free">𝒦</span></span> <span class="quoted"><span class="free">𝒮</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Hidden_Markov_Model-states_finite"><span class="command">lemma</span></span> states_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">𝒮</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> states_wellformed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">𝒮</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> states_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span><span class="main">.</span> <span class="free">𝒦</span> <span class="bound">s</span> <span class="main">⊆</span> <span class="free">𝒮</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> K.finite K.wellformed K.closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The set of internal states is now given as a list to iterate over.
  This is needed for the computations on HMMs.
›</span></span>
<span class="keyword1"><span class="command">locale</span></span> HMM3_defs <span class="main">=</span> HMM2_defs <span class="quoted"><span class="free">𝒪<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="quoted"><span class="free">𝒦</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">𝒪<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝒦</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span> pmf"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">state_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> list"</span></span>

<span class="keyword1"><span class="command">locale</span></span> HMM3 <span class="main">=</span> HMM3_defs _ _ <span class="quoted"><span class="free">𝒪<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="quoted"><span class="free">𝒦</span></span> <span class="main">+</span> HMM2 <span class="quoted"><span class="free">𝒪<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="quoted"><span class="free">𝒦</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">𝒪<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝒦</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span> pmf"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> state_list_𝒮<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">state_list</span> <span class="main">=</span> <span class="free">𝒮</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> HMM_defs
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">no_notation</span></span> <span class="main">(</span>ASCII<span class="main">)</span> comp  <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">o</span>"</span> 55<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The ``default'' observation.›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">obs</span> <span class="main">≡</span> <span class="keyword1">SOME</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">𝒪<span class="hidden">⇩</span><sub>s</sub></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> HMM<span class="main">)</span> obs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"obs <span class="main">∈</span> <span class="free">𝒪<span class="hidden">⇩</span><sub>s</sub></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> obs_def <span class="keyword1"><span class="command">using</span></span> observations_wellformed <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> someI_ex<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The HMM is encoded as a Markov chain over pairs of states and observations.
  This is the Markov chain's defining Markov kernel.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">K</span> <span class="main">≡</span> <span class="main">λ</span> <span class="main">(</span><span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">o<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">::</span> <span class="tfree">'t</span><span class="main">)</span><span class="main">.</span> bind_pmf <span class="main">(</span><span class="free">𝒦</span> <span class="bound">s<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> map_pmf <span class="main">(</span><span class="main">λ</span> <span class="bound">o<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="main">(</span><span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="bound">o<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">𝒪</span> <span class="bound">s<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> MC_syntax <span class="quoted">K</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Uniform distribution of the pairs <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(s, o)›</span></span></span></span> for a fixed state <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>s›</span></span></span></span>.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">::</span> <span class="tfree">'s</span><span class="main">)</span> <span class="main">=</span> map_pmf <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>pmf_of_set <span class="free">𝒪<span class="hidden">⇩</span><sub>s</sub></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The likelihood of an observation sequence given a starting state <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>s›</span></span></span></span> is defined in terms of
  the trace space of the Markov kernel given the uniform distribution of pairs for <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>s›</span></span></span></span>.
›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">likelihood</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">os</span></span></span> <span class="main">=</span> T' <span class="main">(</span>I <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">ω</span></span> <span class="main">∈</span> space S<span class="main">.</span> <span class="main">∃</span> <span class="bound">o<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">xs</span> <span class="bound">ω'</span><span class="main">.</span> <span class="bound">ω</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="bound">o<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">##</span> <span class="bound">xs</span> <span class="main">@-</span> <span class="bound">ω'</span> <span class="main">∧</span> map snd <span class="bound">xs</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">os</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="free"><span class="bound"><span class="entity">os</span></span></span> <span class="free"><span class="bound"><span class="entity">ω</span></span></span> <span class="main">≡</span> <span class="main">∃</span> <span class="bound">xs</span> <span class="bound">ω'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ω</span></span></span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@-</span> <span class="bound">ω'</span> <span class="main">∧</span> map snd <span class="bound">xs</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">os</span></span></span>"</span></span>

<span class="keyword1" id="Hidden_Markov_Model-likelihood_alt_def"><span class="command">lemma</span></span> likelihood_alt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"likelihood <span class="free">s</span> <span class="free">os</span> <span class="main">=</span> T' <span class="main">(</span>I <span class="free">s</span><span class="main">)</span> <span class="main">{</span><span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="bound">o</span><span class="main">)</span> <span class="main">##</span> <span class="bound">xs</span> <span class="main">@-</span> <span class="bound">ω'</span> <span class="main">|</span><span class="bound">o</span> <span class="bound">xs</span> <span class="bound">ω'</span><span class="main">.</span> map snd <span class="bound">xs</span> <span class="main">=</span> <span class="free">os</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> likelihood_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_S<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Iteration Rule For Likelihood›</span></span>

<span class="keyword1" id="Hidden_Markov_Model-L_Nil"><span class="command">lemma</span></span> L_Nil<span class="main">:</span>
  <span class="quoted"><span class="quoted">"L <span class="main">[]</span> <span class="free">ω</span> <span class="main">=</span> True"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Hidden_Markov_Model-emeasure_T_observation_Nil"><span class="command">lemma</span></span> emeasure_T_observation_Nil<span class="main">:</span>
  <span class="quoted"><span class="quoted">"T <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">o<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">ω</span></span> <span class="main">∈</span> space S<span class="main">.</span> L <span class="main">[]</span> <span class="bound">ω</span><span class="main">}</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Hidden_Markov_Model-L_Cons"><span class="command">lemma</span></span> L_Cons<span class="main">:</span>
  <span class="quoted"><span class="quoted">"L <span class="main">(</span><span class="free">o</span> <span class="main">#</span> <span class="free">os</span><span class="main">)</span> <span class="free">ω</span> <span class="main">⟷</span> snd <span class="main">(</span>shd <span class="free">ω</span><span class="main">)</span> <span class="main">=</span> <span class="free">o</span> <span class="main">∧</span> L <span class="free">os</span> <span class="main">(</span>stl <span class="free">ω</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ω</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"shd <span class="free">ω</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x xs ω'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="free">o</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Hidden_Markov_Model-L_measurable"><span class="command">lemma</span></span> L_measurable<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Measurable.pred S <span class="main">(</span>L <span class="free">os</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">os</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> that <span class="keyword2"><span class="keyword">for</span></span> o os
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> L_Cons<span class="main">)</span>
      <span class="main">(</span><span class="operator">intro</span> Measurable.pred_intros_logic
        measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_shd<span class="main"><span class="main">]</span></span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_stl that<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span>
        <span class="operator">measurable</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Hidden_Markov_Model-init_measurable"><span class="command">lemma</span></span> init_measurable<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Measurable.pred S <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">o<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">xs</span> <span class="bound">ω'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="bound">o<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">##</span> <span class="bound">xs</span> <span class="main">@-</span> <span class="bound">ω'</span> <span class="main">∧</span> map snd <span class="bound">xs</span> <span class="main">=</span> <span class="free">os</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"Measurable.pred S <span class="var">?f</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">ω</span> <span class="main">⟷</span> fst <span class="main">(</span>shd <span class="skolem">ω</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∧</span> L <span class="free">os</span> <span class="main">(</span>stl <span class="skolem">ω</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ω</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ω</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> *<span class="main">)</span>
       <span class="main">(</span><span class="operator">intro</span> Measurable.pred_intros_logic measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_shd<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">measurable</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Hidden_Markov_Model-T_init_observation_eq"><span class="command">lemma</span></span> T_init_observation_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"T <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">o</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">ω</span></span> <span class="main">∈</span> space S<span class="main">.</span> L <span class="free">os</span> <span class="bound">ω</span><span class="main">}</span> <span class="main">=</span> T <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">o'</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">ω</span></span> <span class="main">∈</span> space S<span class="main">.</span> L <span class="free">os</span> <span class="bound">ω</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_Collect_T<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> space_T<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">measurable</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> emeasure_Collect_T<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> space_T<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">measurable</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> K_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Shows that it is equivalent to define likelihood in terms of the trace space starting at a single
  pair of an internal state <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>s›</span></span></span></span> and the default observation <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">obs</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> HMM<span class="main">)</span> likelihood_init<span class="main">:</span>
  <span class="quoted"><span class="quoted">"likelihood <span class="free">s</span> <span class="free">os</span> <span class="main">=</span> T <span class="main">(</span><span class="free">s</span><span class="main">,</span> obs<span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">ω</span></span> <span class="main">∈</span> space S<span class="main">.</span> L <span class="free">os</span> <span class="bound">ω</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">o</span><span class="main">∈</span><span class="free">𝒪<span class="hidden">⇩</span><sub>s</sub></span><span class="main">.</span> emeasure <span class="main">(</span>T <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="bound">o</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">ω</span></span> <span class="main">∈</span> space S<span class="main">.</span> L <span class="free">os</span> <span class="bound">ω</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
    of_nat <span class="main">(</span>card <span class="free">𝒪<span class="hidden">⇩</span><sub>s</sub></span><span class="main">)</span> <span class="main">*</span> emeasure <span class="main">(</span>T <span class="main">(</span><span class="free">s</span><span class="main">,</span> obs<span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">ω</span></span> <span class="main">∈</span> space S<span class="main">.</span> L <span class="free">os</span> <span class="bound">ω</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_constant<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum.cong T_init_observation_eq<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> likelihood_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_T'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
    <span class="keyword1"><span class="command">using</span></span> *
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> I_def in_S observations_finite observations_wellformed nn_integral_pmf_of_set<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> mult.commute<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> observations_finite observations_wellformed mult_divide_eq_ennreal<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Hidden_Markov_Model-emeasure_T_observation_Cons"><span class="command">lemma</span></span> emeasure_T_observation_Cons<span class="main">:</span>
  <span class="quoted"><span class="quoted">"T <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">o<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">ω</span></span> <span class="main">∈</span> space S<span class="main">.</span> L <span class="main">(</span><span class="free">o<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">#</span> <span class="free">os</span><span class="main">)</span> <span class="bound">ω</span><span class="main">}</span> <span class="main">=</span>
   <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">t</span><span class="main">.</span> ennreal <span class="main">(</span>pmf <span class="main">(</span><span class="free">𝒪</span> <span class="bound">t</span><span class="main">)</span> <span class="free">o<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">*</span> T <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="free">o<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">ω</span></span> <span class="main">∈</span> space S<span class="main">.</span> L <span class="free">os</span> <span class="bound">ω</span><span class="main">}</span> <span class="main">∂</span><span class="main">(</span><span class="free">𝒦</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">y</span><span class="main">.</span> T <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space S<span class="main">.</span> <span class="main">∃</span><span class="bound">xs</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ω'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">##</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@-</span> <span class="bound">ω'</span><span class="main">)</span> <span class="main">∧</span> map snd <span class="bound">xs</span> <span class="main">=</span> <span class="free">o<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">#</span> <span class="free">os</span><span class="main">}</span>
       <span class="main">∂</span>measure_pmf <span class="main">(</span><span class="free">𝒪</span> <span class="skolem">s'</span><span class="main">)</span> <span class="main">=</span>
    ennreal <span class="main">(</span>pmf <span class="main">(</span><span class="free">𝒪</span> <span class="skolem">s'</span><span class="main">)</span> <span class="free">o<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">*</span> T <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="free">o<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">ω</span></span> <span class="main">∈</span> space S<span class="main">.</span> <span class="main">∃</span><span class="bound">xs</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ω'</span><span class="main">.</span> <span class="bound">ω</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@-</span> <span class="bound">ω'</span><span class="main">)</span> <span class="main">∧</span> map snd <span class="bound">xs</span> <span class="main">=</span> <span class="free">os</span><span class="main">}</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">s'</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span>pmf <span class="main">(</span><span class="free">𝒪</span> <span class="skolem">s'</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">*</span>
            T <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">ω</span></span> <span class="main">∈</span> space S<span class="main">.</span> <span class="main">∃</span><span class="bound">xs</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ω'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">##</span> <span class="bound">ω</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@-</span> <span class="bound">ω'</span><span class="main">)</span> <span class="main">∧</span> map snd <span class="bound">xs</span> <span class="main">=</span> <span class="free">o<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">#</span> <span class="free">os</span><span class="main">}</span>
          <span class="main">∂</span>count_space UNIV"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nn_integral_measure_pmf<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>
      <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">o<span class="hidden">⇩</span><sub>2</sub></span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">o<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">=</span> <span class="free">o<span class="hidden">⇩</span><sub>1</sub></span>
              <span class="keyword1">then</span> ennreal <span class="main">(</span>pmf <span class="main">(</span><span class="free">𝒪</span> <span class="skolem">s'</span><span class="main">)</span> <span class="free">o<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">*</span> T <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="free">o<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">ω</span></span> <span class="main">∈</span> space S<span class="main">.</span> L <span class="free">os</span> <span class="bound">ω</span><span class="main">}</span>
              <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>
       <span class="main">∂</span>count_space UNIV"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> nn_integral_cong_AE
          <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> v <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span> <span class="bound"><span class="bound">o<span class="hidden">⇩</span><sub>2</sub></span></span><span class="main"><span class="main">.</span></span> <span class="keyword1"><span class="keyword1">if</span></span> <span class="bound"><span class="bound">o<span class="hidden">⇩</span><sub>2</sub></span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">o<span class="hidden">⇩</span><sub>1</sub></span></span>
            <span class="keyword1"><span class="keyword1">then</span></span> ennreal <span class="main"><span class="main">(</span></span>pmf <span class="main"><span class="main">(</span></span><span class="free"><span class="free">𝒪</span></span> <span class="skolem"><span class="skolem">s'</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">o<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">*</span></span> T <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">s'</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">o<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">{</span></span><span class="bound"><span class="bound"><span class="bound"><span class="bound">ω</span></span></span></span> <span class="main"><span class="main">∈</span></span> space S<span class="main"><span class="main">.</span></span> L <span class="free"><span class="free">os</span></span> <span class="bound"><span class="bound">ω</span></span><span class="main"><span class="main">}</span></span> <span class="keyword1"><span class="keyword1">else</span></span> <span class="main"><span class="main">0</span></span>"</span></span></span><span class="main"><span class="main">]</span></span>
          <span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> AE_I2<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">split</span> if_split<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">times</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> HOL.refl<span class="main"><span class="main">]</span></span> arg_cong2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted">emeasure</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span>
            <span class="operator">metis</span> list.simps<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> shift.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> snd_conv
           <span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">emeasure</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> d <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{}</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span><span class="bound">o<span class="hidden">⇩</span><sub>2</sub></span><span class="main">∈</span><span class="main">{</span><span class="free">o<span class="hidden">⇩</span><sub>1</sub></span><span class="main">}</span><span class="main">.</span>
       <span class="main">(</span>ennreal <span class="main">(</span>pmf <span class="main">(</span><span class="free">𝒪</span> <span class="skolem">s'</span><span class="main">)</span> <span class="free">o<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">*</span> T <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="free">o<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">ω</span></span> <span class="main">∈</span> space S<span class="main">.</span> L <span class="free">os</span> <span class="bound">ω</span><span class="main">}</span><span class="main">)</span>
      <span class="main">∂</span>count_space UNIV"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nn_integral_cong_AE<span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">t</span><span class="main">.</span> T <span class="bound">t</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> space S<span class="main">.</span> <span class="main">∃</span><span class="bound">xs</span> <span class="bound">ω'</span><span class="main">.</span> <span class="bound">t</span> <span class="main">##</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@-</span> <span class="bound">ω'</span> <span class="main">∧</span> map snd <span class="bound">xs</span> <span class="main">=</span> <span class="free">o<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">#</span> <span class="free">os</span><span class="main">}</span> <span class="main">∂</span> <span class="main">(</span>K <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">o<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_Collect_T<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> space_T<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">measurable</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> K_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Computation of Likelihood›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">backward</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">backward</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">backward</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">o</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">os</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">t</span><span class="main">.</span> ennreal <span class="main">(</span>pmf <span class="main">(</span><span class="free">𝒪</span> <span class="bound">t</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">o</span></span></span><span class="main">)</span> <span class="main">*</span> <span class="free">backward</span> <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">os</span></span></span> <span class="main">∂</span>measure_pmf <span class="main">(</span><span class="free">𝒦</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Hidden_Markov_Model-emeasure_T_observation_backward"><span class="command">lemma</span></span> emeasure_T_observation_backward<span class="main">:</span>
  <span class="quoted"><span class="quoted">"emeasure <span class="main">(</span>T <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">o</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">ω</span></span> <span class="main">∈</span> space S<span class="main">.</span> L <span class="free">os</span> <span class="bound">ω</span><span class="main">}</span> <span class="main">=</span> backward <span class="free">s</span> <span class="free">os</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> emeasure_T_observation_Cons <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">os</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">o</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> HMM<span class="main">)</span> likelihood_backward<span class="main">:</span>
  <span class="quoted"><span class="quoted">"likelihood <span class="free">s</span> <span class="free">os</span> <span class="main">=</span> backward <span class="free">s</span> <span class="free">os</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> likelihood_init emeasure_T_observation_backward <span class="keyword1"><span class="command">..</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* HMM Defs *)</span>

<span class="keyword1"><span class="command">context</span></span> HMM2
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> HMM2_defs<span class="main">)</span> <span class="entity">forward</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">forward</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t_end</span></span></span> <span class="main">[]</span> <span class="main">=</span> indicator <span class="main">{</span><span class="free"><span class="bound"><span class="entity">t_end</span></span></span><span class="main">}</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">forward</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t_end</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">o</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">os</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">∑</span><span class="bound">t</span> <span class="main">∈</span> <span class="free">𝒮</span><span class="main">.</span> ennreal <span class="main">(</span>pmf <span class="main">(</span><span class="free">𝒪</span> <span class="bound">t</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">o</span></span></span><span class="main">)</span> <span class="main">*</span> ennreal <span class="main">(</span>pmf <span class="main">(</span><span class="free">𝒦</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span> <span class="main">*</span> <span class="free">forward</span> <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">t_end</span></span></span> <span class="free"><span class="bound"><span class="entity">os</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Hidden_Markov_Model-forward_split"><span class="command">lemma</span></span> forward_split<span class="main">:</span>
  <span class="quoted"><span class="quoted">"forward <span class="free">s</span> <span class="free">t</span> <span class="main">(</span><span class="free">os1</span> <span class="main">@</span> <span class="free">os2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">t'</span> <span class="main">∈</span> <span class="free">𝒮</span><span class="main">.</span> forward <span class="free">s</span> <span class="bound">t'</span> <span class="free">os1</span> <span class="main">*</span> forward <span class="bound">t'</span> <span class="free">t</span> <span class="free">os2</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">𝒮</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">os1</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_indicator_mult<span class="main"><span class="main">[</span></span><span class="operator">OF</span> states_finite<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sum.cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="skolem"><span class="skolem">s</span></span><span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a os1 s
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sum_distrib_right<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sum.swap<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_left <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">t</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="free">f</span> <span class="bound">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span><span class="main">.</span> <span class="free">f</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">thm</span></span> sum.empty sum.insert sum.mono_neutral_right<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">t</span><span class="main">}</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sum.mono_neutral_right<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="free"><span class="free">t</span></span><span class="main"><span class="main">}</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> that
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="comment1">(*
  oops
  by (metis add.right_neutral empty_iff finite.intros(1) insert_iff subsetI sum.empty sum.insert sum.mono_neutral_right that)

  using that
  apply auto
*)</span>

<span class="keyword1" id="Hidden_Markov_Model-forward_backward"><span class="command">lemma</span></span> forward_backward<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">t</span> <span class="main">∈</span> <span class="free">𝒮</span><span class="main">.</span> forward <span class="free">s</span> <span class="bound">t</span> <span class="free">os</span><span class="main">)</span> <span class="main">=</span> backward <span class="free">s</span> <span class="free">os</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">𝒮</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">∈</span> <span class="free">𝒮</span>›</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">os</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum.mono_neutral_right<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">𝒮</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">s</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> states_finite<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indicator_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> a os s
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.swap sum_distrib_left<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_measure_pmf_support<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> A <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">𝒮</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> states_finite states_closed <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">theorem</span></span> likelihood_forward<span class="main">:</span>
  <span class="quoted"><span class="quoted">"likelihood <span class="free">s</span> <span class="free">os</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">t</span> <span class="main">∈</span> <span class="free">𝒮</span><span class="main">.</span> forward <span class="free">s</span> <span class="bound">t</span> <span class="free">os</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">∈</span> <span class="free">𝒮</span>›</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> likelihood_backward forward_backward<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span> <span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">∈</span> <span class="free">𝒮</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition of Maximum Probabilities›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="free"><span class="bound"><span class="entity">os</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">ω</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">ω'</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ω</span></span></span> <span class="main">=</span> zip <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">os</span></span></span> <span class="main">@-</span> <span class="bound">ω'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">max_prob</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">os</span></span></span> <span class="main">=</span>
  Max <span class="main">{</span>T' <span class="main">(</span>I <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">ω</span></span> <span class="main">∈</span> space S<span class="main">.</span> <span class="main">∃</span><span class="bound">o</span> <span class="bound">ω'</span><span class="main">.</span> <span class="bound">ω</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="bound">o</span><span class="main">)</span> <span class="main">##</span> zip <span class="bound">as</span> <span class="free"><span class="bound"><span class="entity">os</span></span></span> <span class="main">@-</span> <span class="bound">ω'</span><span class="main">}</span>
       <span class="main">|</span> <span class="bound">as</span><span class="main">.</span> length <span class="bound">as</span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">os</span></span></span> <span class="main">∧</span> set <span class="bound">as</span> <span class="main">⊆</span> <span class="free">𝒮</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">viterbi_prob</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">viterbi_prob</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t_end</span></span></span> <span class="main">[]</span> <span class="main">=</span> indicator <span class="main">{</span><span class="free"><span class="bound"><span class="entity">t_end</span></span></span><span class="main">}</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">viterbi_prob</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t_end</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">o</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">os</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">MAX</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">𝒮</span><span class="main">.</span> ennreal <span class="main">(</span>pmf <span class="main">(</span><span class="free">𝒪</span> <span class="bound">t</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">o</span></span></span> <span class="main">*</span> pmf <span class="main">(</span><span class="free">𝒦</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span> <span class="main">*</span> <span class="free">viterbi_prob</span> <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">t_end</span></span></span> <span class="free"><span class="bound"><span class="entity">os</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_decoding</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">os</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">≡</span>
    T' <span class="main">(</span>I <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">ω</span></span> <span class="main">∈</span> space S<span class="main">.</span> <span class="main">∃</span><span class="bound">o</span> <span class="bound">ω'</span><span class="main">.</span> <span class="bound">ω</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="bound">o</span><span class="main">)</span> <span class="main">##</span> zip <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="free"><span class="bound"><span class="entity">os</span></span></span> <span class="main">@-</span> <span class="bound">ω'</span><span class="main">}</span> <span class="main">=</span> max_prob <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">os</span></span></span> <span class="main">∧</span>
    length <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">os</span></span></span> <span class="main">∧</span> set <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">⊆</span> <span class="free">𝒮</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Iteration Rule For Maximum Probabilities›</span></span>

<span class="keyword1" id="Hidden_Markov_Model-emeasure_T_state_Nil"><span class="command">lemma</span></span> emeasure_T_state_Nil<span class="main">:</span>
  <span class="quoted"><span class="quoted">"T <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">o<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">ω</span></span> <span class="main">∈</span> space S<span class="main">.</span> V <span class="main">[]</span> <span class="free">as</span> <span class="bound">ω</span><span class="main">}</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Hidden_Markov_Model-max_prob_T_state_Nil"><span class="command">lemma</span></span> max_prob_T_state_Nil<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Max <span class="main">{</span>T <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">o</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">ω</span></span> <span class="main">∈</span> space S<span class="main">.</span> V <span class="main">[]</span> <span class="bound">as</span> <span class="bound">ω</span><span class="main">}</span> <span class="main">|</span> <span class="bound">as</span><span class="main">.</span> length <span class="bound">as</span> <span class="main">=</span> length <span class="main">[]</span> <span class="main">∧</span> set <span class="bound">as</span> <span class="main">⊆</span> <span class="free">𝒮</span><span class="main">}</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> emeasure_T_state_Nil<span class="main">)</span>

<span class="keyword1" id="Hidden_Markov_Model-V_Cons"><span class="command">lemma</span></span> V_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"V <span class="main">(</span><span class="free">o</span> <span class="main">#</span> <span class="free">os</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">as</span><span class="main">)</span> <span class="free">ω</span> <span class="main">⟷</span> fst <span class="main">(</span>shd <span class="free">ω</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="main">∧</span> snd <span class="main">(</span>shd <span class="free">ω</span><span class="main">)</span> <span class="main">=</span> <span class="free">o</span> <span class="main">∧</span> V <span class="free">os</span> <span class="free">as</span> <span class="main">(</span>stl <span class="free">ω</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ω</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Hidden_Markov_Model-measurable_V"><span class="command">lemma</span></span> measurable_V<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Measurable.pred S <span class="main">(</span><span class="main">λ</span><span class="bound">ω</span><span class="main">.</span> V <span class="free">os</span> <span class="free">as</span> <span class="bound">ω</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">os</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2'<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> V_Cons<span class="main">)</span>
       <span class="main">(</span><span class="operator">intro</span> Measurable.pred_intros_logic
          measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_shd<span class="main"><span class="main">]</span></span> measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_stl<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span>
        <span class="operator">measurable</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Hidden_Markov_Model-init_V_measurable"><span class="command">lemma</span></span> init_V_measurable<span class="main">[</span><span class="operator">measurable</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Measurable.pred S <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">o</span> <span class="bound">ω'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="bound">o</span><span class="main">)</span> <span class="main">##</span> zip <span class="free">as</span> <span class="free">os</span> <span class="main">@-</span> <span class="bound">ω'</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"Measurable.pred S <span class="var">?f</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">ω</span> <span class="main">⟷</span> fst <span class="main">(</span>shd <span class="skolem">ω</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span> <span class="main">∧</span> V <span class="free">os</span> <span class="free">as</span> <span class="main">(</span>stl <span class="skolem">ω</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ω</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ω</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> *<span class="main">)</span>
       <span class="main">(</span><span class="operator">intro</span> Measurable.pred_intros_logic measurable_compose<span class="main"><span class="main">[</span></span><span class="operator">OF</span> measurable_shd<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">measurable</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Hidden_Markov_Model-max_prob_Cons'"><span class="command">lemma</span></span> max_prob_Cons'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Max <span class="main">{</span>T <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">o<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">ω</span></span> <span class="main">∈</span> space S<span class="main">.</span> V <span class="main">(</span><span class="free">o</span> <span class="main">#</span> <span class="free">os</span><span class="main">)</span> <span class="bound">as</span> <span class="bound">ω</span><span class="main">}</span> <span class="main">|</span> <span class="bound">as</span><span class="main">.</span> length <span class="bound">as</span> <span class="main">=</span> length <span class="main">(</span><span class="free">o</span> <span class="main">#</span> <span class="free">os</span><span class="main">)</span> <span class="main">∧</span> set <span class="bound">as</span> <span class="main">⊆</span> <span class="free">𝒮</span><span class="main">}</span> <span class="main">=</span>
  <span class="main">(</span>
    <span class="keyword1">MAX</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">𝒮</span><span class="main">.</span> ennreal <span class="main">(</span>pmf <span class="main">(</span><span class="free">𝒪</span> <span class="bound">t</span><span class="main">)</span> <span class="free">o</span> <span class="main">*</span> pmf <span class="main">(</span><span class="free">𝒦</span> <span class="free">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span> <span class="main">*</span>
      <span class="main">(</span><span class="keyword1">MAX</span> <span class="bound">as</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">as</span><span class="main">.</span> length <span class="bound">as</span> <span class="main">=</span> length <span class="free">os</span> <span class="main">∧</span> set <span class="bound">as</span> <span class="main">⊆</span> <span class="free">𝒮</span><span class="main">}</span><span class="main">.</span> T <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="free">o</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">ω</span></span> <span class="main">∈</span> space S<span class="main">.</span> V <span class="free">os</span> <span class="bound">as</span> <span class="bound">ω</span><span class="main">}</span><span class="main">)</span>
  <span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> T_V_Cons<span class="main">:</span>
  <span class="quoted"><span class="quoted">"T <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">o<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">ω</span></span> <span class="main">∈</span> space S<span class="main">.</span> V <span class="main">(</span><span class="free">o</span> <span class="main">#</span> <span class="free">os</span><span class="main">)</span> <span class="main">(</span><span class="free">t</span> <span class="main">#</span> <span class="free">as</span><span class="main">)</span> <span class="bound">ω</span><span class="main">}</span>
  <span class="main">=</span> ennreal <span class="main">(</span>pmf <span class="main">(</span><span class="free">𝒪</span> <span class="free">t</span><span class="main">)</span> <span class="free">o</span> <span class="main">*</span> pmf <span class="main">(</span><span class="free">𝒦</span> <span class="free">s</span><span class="main">)</span> <span class="free">t</span><span class="main">)</span> <span class="main">*</span> T <span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">o</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">ω</span></span> <span class="main">∈</span> space S<span class="main">.</span> V <span class="free">os</span> <span class="free">as</span> <span class="bound">ω</span><span class="main">}</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l'</span> <span class="main">=</span> <span class="var">?r'</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free">as</span> <span class="main">=</span> length <span class="free">os</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">os</span><span class="main">.</span> <span class="main">{</span><span class="bound">as</span><span class="main">.</span> length <span class="bound">as</span> <span class="main">=</span> length <span class="bound">os</span> <span class="main">∧</span> set <span class="bound">as</span> <span class="main">⊆</span> <span class="free">𝒮</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> S_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="var">?S</span> <span class="skolem">os</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">os</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> list"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_lists_length_eq<span class="main">[</span><span class="operator">OF</span> states_finite<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> S_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="skolem">os</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">os</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> list"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?a</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">SOME</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">𝒮</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?as</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"replicate <span class="main">(</span>length <span class="skolem">os</span><span class="main">)</span> <span class="var">?a</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> states_wellformed <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">∈</span> <span class="free">𝒮</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> someI_ex<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?as</span> <span class="main">∈</span> <span class="var">?S</span> <span class="skolem">os</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span> <span class="bound">as</span> <span class="bound">os</span><span class="main">.</span> T <span class="bound">t</span> <span class="main">{</span><span class="bound"><span class="bound">ω</span></span> <span class="main">∈</span> space S<span class="main">.</span> V <span class="bound">os</span> <span class="bound">as</span> <span class="main">(</span><span class="bound">t</span> <span class="main">##</span> <span class="bound">ω</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?g</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span> <span class="bound">as</span> <span class="bound">os</span><span class="main">.</span> T <span class="bound">t</span> <span class="main">{</span><span class="bound"><span class="bound">ω</span></span> <span class="main">∈</span> space S<span class="main">.</span> V <span class="bound">os</span> <span class="bound">as</span> <span class="bound">ω</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">t</span> <span class="skolem">as</span> <span class="main">(</span><span class="free">o</span> <span class="main">#</span> <span class="free">os</span><span class="main">)</span> <span class="main">=</span> <span class="var">?g</span> <span class="skolem">t</span> <span class="main">(</span>tl <span class="skolem">as</span><span class="main">)</span> <span class="free">os</span> <span class="main">*</span> indicator <span class="main">{</span><span class="main">(</span>hd <span class="skolem">as</span><span class="main">,</span> <span class="free">o</span><span class="main">)</span><span class="main">}</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">as</span> <span class="main">=</span> Suc <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span> <span class="skolem">as</span> <span class="skolem">n</span>
    <span class="keyword1"><span class="command">unfolding</span></span> indicator_def <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">as</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"K <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">o<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">{</span><span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="free">o</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> pmf <span class="main">(</span><span class="free">𝒪</span> <span class="skolem">t</span><span class="main">)</span> <span class="free">o</span> <span class="main">*</span> pmf <span class="main">(</span><span class="free">𝒦</span> <span class="free">s</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
    <span class="keyword1"><span class="command">unfolding</span></span> K_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> vimage_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> arg_cong2<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span>
          f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">nn_integral</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> d <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span> <span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> <span class="free"><span class="free">𝒪</span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">{</span></span><span class="bound"><span class="bound">xa</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">xa</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">o</span></span> <span class="main"><span class="main">∧</span></span> <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">=</span></span> <span class="skolem"><span class="skolem">t</span></span><span class="main"><span class="main">}</span></span> <span class="main"><span class="main">*</span></span> indicator <span class="main"><span class="main">{</span></span><span class="skolem"><span class="skolem">t</span></span><span class="main"><span class="main">}</span></span> <span class="bound"><span class="bound">x</span></span>"</span></span></span><span class="main"><span class="main">,</span></span>
          <span class="operator">OF</span> HOL.refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indicator_def<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> emeasure_pmf_single ennreal_mult'<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">MAX</span> <span class="bound">as</span> <span class="main">∈</span> <span class="var">?S</span> <span class="main">(</span><span class="free">o</span> <span class="main">#</span> <span class="free">os</span><span class="main">)</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">t</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">t</span> <span class="bound">as</span> <span class="main">(</span><span class="free">o</span> <span class="main">#</span> <span class="free">os</span><span class="main">)</span> <span class="main">∂</span>K <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">o<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Max_to_image2<span class="main"><span class="keyword3">;</span></span> <span class="operator">subst</span> emeasure_Collect_T<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> space_T<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> measurable_V HOL.refl<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">MAX</span> <span class="bound">as</span> <span class="main">∈</span> <span class="var">?S</span> <span class="main">(</span><span class="free">o</span> <span class="main">#</span> <span class="free">os</span><span class="main">)</span><span class="main">.</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">t</span><span class="main">.</span> <span class="var">?g</span> <span class="bound">t</span> <span class="main">(</span>tl <span class="bound">as</span><span class="main">)</span> <span class="free">os</span> <span class="main">*</span> indicator <span class="main">{</span><span class="main">(</span>hd <span class="bound">as</span><span class="main">,</span><span class="free">o</span><span class="main">)</span><span class="main">}</span> <span class="bound">t</span> <span class="main">∂</span>K <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">o<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> Max_image_cong_simp <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> *<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">MAX</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">as</span><span class="main">)</span><span class="main">∈</span> <span class="free">𝒮</span> <span class="main">×</span> <span class="var">?S</span> <span class="free">os</span><span class="main">.</span> ennreal <span class="main">(</span>pmf <span class="main">(</span><span class="free">𝒪</span> <span class="bound">t</span><span class="main">)</span> <span class="free">o</span> <span class="main">*</span> pmf <span class="main">(</span><span class="free">𝒦</span> <span class="free">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span> <span class="main">*</span> <span class="var">?g</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="free">o</span><span class="main">)</span> <span class="bound">as</span> <span class="free">os</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> Max_eq_image_if<span class="main"><span class="keyword3">;</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">from</span></span> S_finite<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">o</span> <span class="main">#</span> <span class="free">os</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 2
    <span class="keyword1"><span class="command">from</span></span> states_finite <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S_finite<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">as</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> bexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"hd <span class="skolem"><span class="skolem"><span class="skolem">as</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">as</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> **<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">x</span> <span class="skolem">as</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span> <span class="main"><span class="main"><span class="main">#</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">as</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> **<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Max_image_left_mult<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Max_image_pair<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> states_finite<span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l'</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">t'</span><span class="main">.</span> <span class="var">?f</span> <span class="bound">t'</span> <span class="main">(</span><span class="free">t</span> <span class="main">#</span> <span class="free">as</span><span class="main">)</span> <span class="main">(</span><span class="free">o</span> <span class="main">#</span> <span class="free">os</span><span class="main">)</span> <span class="main">∂</span>K <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">o<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> emeasure_Collect_T<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> space_T<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> measurable_V<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">t'</span><span class="main">.</span> <span class="var">?g</span> <span class="bound">t'</span> <span class="free">as</span> <span class="free">os</span> <span class="main">*</span> indicator <span class="main">{</span><span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">o</span><span class="main">)</span><span class="main">}</span> <span class="bound">t'</span> <span class="main">∂</span>K <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">o<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> *<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"length <span class="free"><span class="free"><span class="free">as</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="var">?r'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> **<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l'</span> <span class="main">=</span> <span class="var">?r'</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> max_prob_Cons <span class="main">=</span> max_prob_Cons'<span class="main">[</span><span class="operator">OF</span> length_replicate<span class="main">]</span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Computation of Maximum Probabilities›</span></span>

<span class="keyword1" id="Hidden_Markov_Model-T_init_V_eq"><span class="command">lemma</span></span> T_init_V_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"T <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">o</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">ω</span></span> <span class="main">∈</span> space S<span class="main">.</span> V <span class="free">os</span> <span class="free">as</span> <span class="bound">ω</span><span class="main">}</span> <span class="main">=</span> T <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">o'</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">ω</span></span> <span class="main">∈</span> space S<span class="main">.</span> V <span class="free">os</span> <span class="free">as</span> <span class="bound">ω</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_Collect_T<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> space_T<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">measurable</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> emeasure_Collect_T<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> space_T<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">measurable</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> K_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Hidden_Markov_Model-T'_I_T"><span class="command">lemma</span></span> T'_I_T<span class="main">:</span>
  <span class="quoted"><span class="quoted">"T' <span class="main">(</span>I <span class="free">s</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">ω</span></span> <span class="main">∈</span> space S<span class="main">.</span> <span class="main">∃</span><span class="bound">o</span> <span class="bound">ω'</span><span class="main">.</span> <span class="bound">ω</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="bound">o</span><span class="main">)</span> <span class="main">##</span> zip <span class="free">as</span> <span class="free">os</span> <span class="main">@-</span> <span class="bound">ω'</span><span class="main">}</span> <span class="main">=</span> T <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">o</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">ω</span></span> <span class="main">∈</span> space S<span class="main">.</span> V <span class="free">os</span> <span class="free">as</span> <span class="bound">ω</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">o</span><span class="main">∈</span><span class="free">𝒪<span class="hidden">⇩</span><sub>s</sub></span><span class="main">.</span> T <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="bound">o</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">ω</span></span> <span class="main">∈</span> space S<span class="main">.</span> V <span class="free">os</span> <span class="skolem">as</span> <span class="bound">ω</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
    of_nat <span class="main">(</span>card <span class="free">𝒪<span class="hidden">⇩</span><sub>s</sub></span><span class="main">)</span> <span class="main">*</span> T <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">o</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">ω</span></span> <span class="main">∈</span> space S<span class="main">.</span> V <span class="free">os</span> <span class="skolem">as</span> <span class="bound">ω</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">as</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> sum_constant<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum.cong T_init_V_eq<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> max_prob_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> emeasure_T'<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">measurable</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> I_def in_S observations_finite observations_wellformed nn_integral_pmf_of_set<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> mult.commute<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> observations_finite observations_wellformed mult_divide_eq_ennreal<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Hidden_Markov_Model-max_prob_init"><span class="command">lemma</span></span> max_prob_init<span class="main">:</span>
  <span class="quoted"><span class="quoted">"max_prob <span class="free">s</span> <span class="free">os</span> <span class="main">=</span> Max <span class="main">{</span>T <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">o</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">ω</span></span> <span class="main">∈</span> space S<span class="main">.</span> V <span class="free">os</span> <span class="bound">as</span> <span class="bound">ω</span><span class="main">}</span> <span class="main">|</span> <span class="bound">as</span><span class="main">.</span> length <span class="bound">as</span> <span class="main">=</span> length <span class="free">os</span> <span class="main">∧</span> set <span class="bound">as</span> <span class="main">⊆</span> <span class="free">𝒮</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> max_prob_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> T'_I_T<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Hidden_Markov_Model-max_prob_Nil"><span class="command">lemma</span></span> max_prob_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"max_prob <span class="free">s</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> max_prob_init<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> o <span class="main"><span class="main">=</span></span> <span class="quoted">obs</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Hidden_Markov_Model-Max_start"><span class="command">lemma</span></span> Max_start<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">MAX</span> <span class="bound">t</span><span class="main">∈</span><span class="free">𝒮</span><span class="main">.</span> <span class="main">(</span>indicator <span class="main">{</span><span class="bound">t</span><span class="main">}</span> <span class="free">s</span> <span class="main">::</span> ennreal<span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">𝒮</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> states_finite that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> indicator_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Max_eqI<span class="main">)</span>

<span class="keyword1" id="Hidden_Markov_Model-Max_V_viterbi"><span class="command">lemma</span></span> Max_V_viterbi<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">MAX</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">𝒮</span><span class="main">.</span> viterbi_prob <span class="free">s</span> <span class="bound">t</span> <span class="free">os</span><span class="main">)</span> <span class="main">=</span>
   Max <span class="main">{</span>T <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">o</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">ω</span></span> <span class="main">∈</span> space S<span class="main">.</span> V <span class="free">os</span> <span class="bound">as</span> <span class="bound">ω</span><span class="main">}</span> <span class="main">|</span> <span class="bound">as</span><span class="main">.</span> length <span class="bound">as</span> <span class="main">=</span> length <span class="free">os</span> <span class="main">∧</span> set <span class="bound">as</span> <span class="main">⊆</span> <span class="free">𝒮</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">𝒮</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that states_finite states_wellformed
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">os</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">o</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span>
        <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Max_start max_prob_Cons<span class="main"><span class="main">[</span></span><span class="operator">simplified</span><span class="main"><span class="main">]</span></span> Max_image_commute Max_image_left_mult Max_to_image2
        <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> Max_image_cong
      <span class="main">)</span>

<span class="keyword1" id="Hidden_Markov_Model-max_prob_viterbi"><span class="command">lemma</span></span> max_prob_viterbi<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">MAX</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">𝒮</span><span class="main">.</span> viterbi_prob <span class="free">s</span> <span class="bound">t</span> <span class="free">os</span><span class="main">)</span> <span class="main">=</span> max_prob <span class="free">s</span> <span class="free">os</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">𝒮</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> max_prob_init<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">os</span></span><span class="main">]</span> Max_V_viterbi<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">s</span> <span class="main">∈</span> <span class="free">𝒮</span>›</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Decoding the Most Probable Hidden State Sequence›</span></span>

<span class="keyword1"><span class="command">context</span></span> HMM3
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">viterbi</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">viterbi</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t_end</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> indicator <span class="main">{</span><span class="free"><span class="bound"><span class="entity">t_end</span></span></span><span class="main">}</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">viterbi</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t_end</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">o</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">os</span></span></span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>
    argmax snd <span class="main">(</span>map
      <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">viterbi</span> <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">t_end</span></span></span> <span class="free"><span class="bound"><span class="entity">os</span></span></span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">t</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">,</span> ennreal <span class="main">(</span>pmf <span class="main">(</span><span class="free">𝒪</span> <span class="bound">t</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">o</span></span></span> <span class="main">*</span> pmf <span class="main">(</span><span class="free">𝒦</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span> <span class="main">*</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>
    <span class="free">state_list</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Hidden_Markov_Model-state_list_nonempty"><span class="command">lemma</span></span> state_list_nonempty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">state_list</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> state_list_𝒮 states_wellformed <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Hidden_Markov_Model-viterbi_viterbi_prob"><span class="command">lemma</span></span> viterbi_viterbi_prob<span class="main">:</span>
  <span class="quoted"><span class="quoted">"snd <span class="main">(</span>viterbi <span class="free">s</span> <span class="free">t_end</span> <span class="free">os</span><span class="main">)</span> <span class="main">=</span> viterbi_prob <span class="free">s</span> <span class="free">t_end</span> <span class="free">os</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">os</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">o</span> <span class="skolem">os</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span>
    <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">=</span> viterbi <span class="bound">t</span> <span class="free">t_end</span> <span class="skolem">os</span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">t</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">,</span> ennreal <span class="main">(</span>pmf <span class="main">(</span><span class="free">𝒪</span> <span class="bound">t</span><span class="main">)</span> <span class="skolem">o</span> <span class="main">*</span> pmf <span class="main">(</span><span class="free">𝒦</span> <span class="skolem">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span> <span class="main">*</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map <span class="var">?f</span> <span class="free">state_list</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> state_list_nonempty <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="var">?f</span> <span class="free">state_list</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> argmax<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">snd</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span>
    <span class="quoted"><span class="quoted">"snd <span class="main">(</span>fst <span class="main">(</span>argmax snd <span class="var">?xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span>argmax snd <span class="var">?xs</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"snd <span class="main">(</span>argmax snd <span class="var">?xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">MAX</span> <span class="bound">x</span> <span class="main">∈</span> set <span class="var">?xs</span><span class="main">.</span> snd <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> state_list_𝒮<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Max_eq_image_if<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> finite_imageI states_finite<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> finite_imageI states_finite<span class="main"><span class="keyword3">;</span></span> <span class="operator">fail</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
        <span class="keyword1"><span class="command">using</span></span> Cons.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
      <span class="keyword1"><span class="command">using</span></span> Cons.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword2"><span class="keyword">private</span></span> <span class="keyword1"><span class="command">fun</span></span> <span class="entity">val_of</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">val_of</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">[]</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">val_of</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">o</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">os</span></span></span><span class="main">)</span> <span class="main">=</span> ennreal <span class="main">(</span>pmf <span class="main">(</span><span class="free">𝒪</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">o</span></span></span> <span class="main">*</span> pmf <span class="main">(</span><span class="free">𝒦</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">*</span> <span class="free">val_of</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">os</span></span></span>"</span></span>

<span class="keyword1" id="Hidden_Markov_Model-val_of_T"><span class="command">lemma</span></span> val_of_T<span class="main">:</span>
  <span class="quoted"><span class="quoted">"val_of <span class="free">s</span> <span class="free">as</span> <span class="free">os</span> <span class="main">=</span> T <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">o<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">ω</span></span> <span class="main">∈</span> space S<span class="main">.</span> V <span class="free">os</span> <span class="free">as</span> <span class="bound">ω</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"length <span class="free">as</span> <span class="main">=</span> length <span class="free">os</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">o<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> val_of.induct<span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">subst</span> T_V_Cons<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Hidden_Markov_Model-viterbi_sequence"><span class="command">lemma</span></span> viterbi_sequence<span class="main">:</span>
  <span class="quoted"><span class="quoted">"snd <span class="main">(</span>viterbi <span class="free">s</span> <span class="free">t_end</span> <span class="free">os</span><span class="main">)</span> <span class="main">=</span> val_of <span class="free">s</span> <span class="main">(</span>fst <span class="main">(</span>viterbi <span class="free">s</span> <span class="free">t_end</span> <span class="free">os</span><span class="main">)</span><span class="main">)</span> <span class="free">os</span>"</span></span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>viterbi <span class="free">s</span> <span class="free">t_end</span> <span class="free">os</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">os</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> indicator_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">o</span> <span class="skolem">os</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map
    <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">=</span> viterbi <span class="bound">t</span> <span class="free">t_end</span> <span class="skolem">os</span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">t</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">,</span> ennreal <span class="main">(</span>pmf <span class="main">(</span><span class="free">𝒪</span> <span class="bound">t</span><span class="main">)</span> <span class="skolem">o</span> <span class="main">*</span> pmf <span class="main">(</span><span class="free">𝒦</span> <span class="skolem">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span> <span class="main">*</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>
    <span class="free">state_list</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> state_list_nonempty <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> argmax<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted">snd</span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> set <span class="free">state_list</span>"</span></span>
    <span class="quoted"><span class="quoted">"fst <span class="main">(</span>argmax snd <span class="var">?xs</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="skolem">t</span> <span class="main">#</span> fst <span class="main">(</span>viterbi <span class="skolem">t</span> <span class="free">t_end</span> <span class="skolem">os</span><span class="main">)</span><span class="main">,</span> ennreal <span class="main">(</span>pmf <span class="main">(</span><span class="free">𝒪</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">o</span> <span class="main">*</span> pmf <span class="main">(</span><span class="free">𝒦</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">*</span> snd <span class="main">(</span>viterbi <span class="skolem">t</span> <span class="free">t_end</span> <span class="skolem">os</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ennreal_zero_less_mult_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Hidden_Markov_Model-viterbi_valid_path"><span class="command">lemma</span></span> viterbi_valid_path<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">as</span> <span class="main">=</span> length <span class="free">os</span> <span class="main">∧</span> set <span class="free">as</span> <span class="main">⊆</span> <span class="free">𝒮</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"viterbi <span class="free">s</span> <span class="free">t_end</span> <span class="free">os</span> <span class="main">=</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">os</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">o</span> <span class="skolem">os</span> <span class="skolem">s</span> <span class="skolem">as</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"map
    <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">=</span> viterbi <span class="bound">t</span> <span class="free">t_end</span> <span class="skolem">os</span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">t</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">,</span> ennreal <span class="main">(</span>pmf <span class="main">(</span><span class="free">𝒪</span> <span class="bound">t</span><span class="main">)</span> <span class="skolem">o</span> <span class="main">*</span> pmf <span class="main">(</span><span class="free">𝒦</span> <span class="skolem">s</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span> <span class="main">*</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>
    <span class="free">state_list</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> state_list_nonempty <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> argmax<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted">snd</span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="free">𝒮</span>"</span></span>
    <span class="quoted"><span class="quoted">"fst <span class="main">(</span>argmax snd <span class="var">?xs</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="skolem">t</span> <span class="main">#</span> fst <span class="main">(</span>viterbi <span class="skolem">t</span> <span class="free">t_end</span> <span class="skolem">os</span><span class="main">)</span><span class="main">,</span> ennreal <span class="main">(</span>pmf <span class="main">(</span><span class="free">𝒪</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">o</span> <span class="main">*</span> pmf <span class="main">(</span><span class="free">𝒦</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">*</span> snd <span class="main">(</span>viterbi <span class="skolem">t</span> <span class="free">t_end</span> <span class="skolem">os</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> state_list_𝒮 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Cons.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"viterbi <span class="skolem">t</span> <span class="free">t_end</span> <span class="skolem">os</span>"</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons.IH<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">viterbi_final</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">os</span></span></span> <span class="main">=</span> fst <span class="main">(</span>argmax snd <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">t</span><span class="main">.</span> viterbi <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">os</span></span></span><span class="main">)</span> <span class="free">state_list</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Hidden_Markov_Model-viterbi_finalE"><span class="command">lemma</span></span> viterbi_finalE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">t</span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="free">𝒮</span>"</span></span> <span class="quoted"><span class="quoted">"viterbi_final <span class="free">s</span> <span class="free">os</span> <span class="main">=</span> viterbi <span class="free">s</span> <span class="free">t</span> <span class="free">os</span>"</span></span>
    <span class="quoted"><span class="quoted">"snd <span class="main">(</span>viterbi <span class="free">s</span> <span class="free">t</span> <span class="free">os</span><span class="main">)</span> <span class="main">=</span> Max <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> snd <span class="main">(</span>viterbi <span class="free">s</span> <span class="bound">t</span> <span class="free">os</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free">𝒮</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> state_list_nonempty <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span> <span class="bound">t</span><span class="main">.</span> viterbi <span class="free">s</span> <span class="bound">t</span> <span class="free">os</span><span class="main">)</span> <span class="free">state_list</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> argmax<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">snd</span></span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> state_list_𝒮 image_comp comp_def viterbi_final_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> viterbi_final_max_prob<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"viterbi_final <span class="free">s</span> <span class="free">os</span> <span class="main">=</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">𝒮</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> max_prob <span class="free">s</span> <span class="free">os</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="free">𝒮</span>"</span></span> <span class="quoted"><span class="quoted">"viterbi_final <span class="free">s</span> <span class="free">os</span> <span class="main">=</span> viterbi <span class="free">s</span> <span class="skolem">t</span> <span class="free">os</span>"</span></span>
    <span class="quoted"><span class="quoted">"snd <span class="main">(</span>viterbi <span class="free">s</span> <span class="skolem">t</span> <span class="free">os</span><span class="main">)</span> <span class="main">=</span> Max <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> snd <span class="main">(</span>viterbi <span class="free">s</span> <span class="bound">t</span> <span class="free">os</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free">𝒮</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> viterbi_finalE<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> viterbi_viterbi_prob max_prob_viterbi<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> viterbi_final_is_decoding<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"viterbi_final <span class="free">s</span> <span class="free">os</span> <span class="main">=</span> <span class="main">(</span><span class="free">as</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> <span class="free">𝒮</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_decoding <span class="free">s</span> <span class="free">os</span> <span class="free">as</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> viterbi_valid_path<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="main">_</span> <span class="quoted"><span class="free">os</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">have</span></span> as<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">as</span> <span class="main">=</span> length <span class="free">os</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">as</span> <span class="main">⊆</span> <span class="free">𝒮</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">rule</span> viterbi_finalE<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">s</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">os</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="free">𝒮</span>"</span></span> <span class="quoted"><span class="quoted">"viterbi_final <span class="free">s</span> <span class="free">os</span> <span class="main">=</span> viterbi <span class="free">s</span> <span class="skolem">t</span> <span class="free">os</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> viterbi_finalE<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms viterbi_sequence<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="free">os</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"val_of <span class="free">s</span> <span class="free">as</span> <span class="free">os</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"viterbi <span class="free">s</span> <span class="skolem">t</span> <span class="free">os</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> snd_def <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> val_of_T as <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"max_prob <span class="free">s</span> <span class="free">os</span> <span class="main">=</span> T <span class="main">(</span><span class="free">s</span><span class="main">,</span> obs<span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">ω</span></span> <span class="main">∈</span> space S<span class="main">.</span> V <span class="free">os</span> <span class="free">as</span> <span class="bound">ω</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> viterbi_final_max_prob<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> as <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_decoding_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> T'_I_T<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Anonymous context *)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* HMM 3 *)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Theory *)</span></pre>
</div><div id="HMM_Implementation">
<div class="head">
<h1>Theory HMM_Implementation</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Implementation›</span></span>

<span class="keyword1"><span class="command">theory</span></span> HMM_Implementation
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="Hidden_Markov_Model.html">Hidden_Markov_Model</a>
    <span class="quoted">"<a href="../Monad_Memo_DP/State_Main.html">Monad_Memo_DP.State_Main</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Forward Algorithm›</span></span>

<span class="keyword1"><span class="command">locale</span></span> HMM4 <span class="main">=</span> HMM3 _ _ _ <span class="quoted"><span class="free">𝒪<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="quoted"><span class="free">𝒦</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">𝒪<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝒦</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span> pmf"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> states_distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">state_list</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> HMM3_defs
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">os</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> iarray"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Alternative definition using indices into the list of states.
  The list of states is implemented as an immutable array for better performance.
›</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">forward_ix_rec</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">forward_ix_rec</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t_end</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≥</span> IArray.length <span class="free">os</span> <span class="keyword1">then</span> indicator <span class="main">{</span><span class="free"><span class="bound"><span class="entity">t_end</span></span></span><span class="main">}</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">else</span>
    <span class="main">(</span><span class="main">∑</span><span class="bound">t</span> <span class="main">←</span> <span class="free">state_list</span><span class="main">.</span>
      ennreal <span class="main">(</span>pmf <span class="main">(</span><span class="free">𝒪</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span><span class="free">os</span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> ennreal <span class="main">(</span>pmf <span class="main">(</span><span class="free">𝒦</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span> <span class="main">*</span> <span class="free">forward_ix_rec</span> <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">t_end</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  "</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"Wellfounded.measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">.</span> IArray.length <span class="free">os</span> <span class="main">-</span> <span class="bound">n</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Memoization›</span></span>

<span class="keyword1"><span class="command">memoize_fun</span></span> forward_ix<span class="hidden">⇩</span><sub>m</sub><span class="main">:</span> <span class="quoted">forward_ix_rec</span>
  <span class="keyword2"><span class="keyword">with_memory</span></span> dp_consistency_mapping
  <span class="keyword1"><span class="command">monadifies</span></span> <span class="main">(</span>state<span class="main">)</span> forward_ix_rec.simps<span class="main">[</span><span class="operator">unfolded</span> Let_def<span class="main">]</span>
  <span class="keyword1"><span class="command">term</span></span> <span class="quoted">forward_ix<span class="hidden">⇩</span><sub>m</sub>'</span>
<span class="keyword1"><span class="command">memoize_correct</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">memoize_prover</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The main theorems generated by memoization.›</span></span>
<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">includes</span></span> state_monad_syntax
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">thm</span></span> forward_ix<span class="hidden">⇩</span><sub>m</sub>'.simps forward_ix<span class="hidden">⇩</span><sub>m</sub>_def
<span class="keyword1"><span class="command">thm</span></span> forward_ix<span class="hidden">⇩</span><sub>m</sub>.memoized_correct
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Fixed IArray *)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">forward_ix</span> <span class="free"><span class="bound"><span class="entity">os</span></span></span> <span class="main">=</span> forward_ix_rec <span class="main">(</span>IArray <span class="free"><span class="bound"><span class="entity">os</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">likelihood_compute</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">os</span></span></span> <span class="main">≡</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∈</span> set <span class="free">state_list</span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="main">∑</span><span class="bound">t</span> <span class="main">←</span> <span class="free">state_list</span><span class="main">.</span> forward <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">os</span></span></span><span class="main">)</span> <span class="keyword1">else</span> None"</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* HMM3 Defs *)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Correctness of the alternative definition.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> HMM3<span class="main">)</span> forward_ix_drop_one<span class="main">:</span>
  <span class="quoted"><span class="quoted">"forward_ix <span class="main">(</span><span class="free">o</span> <span class="main">#</span> <span class="free">os</span><span class="main">)</span> <span class="free">s</span> <span class="free">t</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> forward_ix <span class="free">os</span> <span class="free">s</span> <span class="free">t</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"length <span class="free">os</span> <span class="main">-</span> <span class="free">n</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> forward_ix_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> HMM4<span class="main">)</span> forward_ix_forward<span class="main">:</span>
  <span class="quoted"><span class="quoted">"forward_ix <span class="free">os</span> <span class="free">s</span> <span class="free">t</span> <span class="main">0</span> <span class="main">=</span> forward <span class="free">s</span> <span class="free">t</span> <span class="free">os</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> forward_ix_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">os</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">o</span> <span class="skolem">os</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> forward_ix_drop_one<span class="main">[</span><span class="operator">unfolded</span> forward_ix_def<span class="main">]</span> states_distinct
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> forward.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> forward_ix_rec.simps<span class="main">)</span>
       <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons.IH state_list_𝒮 sum_list_distinct_conv_sum_set
             <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> forward_ix_rec.simps forward.simps
       <span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Instructs the code generator to use this equation instead to execute <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>forward›</span></span></span></span>.
  Uses the memoized version of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>forward_ix›</span></span></span></span>.
›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> HMM4<span class="main">)</span> forward_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"forward <span class="free">s</span> <span class="free">t</span> <span class="free">os</span> <span class="main">=</span> fst <span class="main">(</span>run_state <span class="main">(</span>forward_ix<span class="hidden">⇩</span><sub>m</sub>' <span class="main">(</span>IArray <span class="free">os</span><span class="main">)</span> <span class="free">s</span> <span class="free">t</span> <span class="main">0</span><span class="main">)</span> Mapping.empty<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>
      forward_ix_def forward_ix<span class="hidden">⇩</span><sub>m</sub>.memoized_correct forward_ix_forward<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
      states_distinct
     <span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> HMM4<span class="main">)</span> likelihood_compute<span class="main">:</span>
  <span class="quoted"><span class="quoted">"likelihood_compute <span class="free">s</span> <span class="free">os</span> <span class="main">=</span> Some <span class="free">x</span> <span class="main">⟷</span> <span class="free">s</span> <span class="main">∈</span> <span class="free">𝒮</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">=</span> likelihood <span class="free">s</span> <span class="free">os</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> likelihood_compute_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> states_distinct state_list_𝒮 sum_list_distinct_conv_sum_set likelihood_forward<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Viterbi Algorithm›</span></span>

<span class="keyword1"><span class="command">context</span></span> HMM3_defs
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">os</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> iarray"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Alternative definition using indices into the list of states.
  The list of states is implemented as an immutable array for better performance.
›</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">viterbi_ix_rec</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">viterbi_ix_rec</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t_end</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≥</span> IArray.length <span class="free">os</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> indicator <span class="main">{</span><span class="free"><span class="bound"><span class="entity">t_end</span></span></span><span class="main">}</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="keyword1">else</span>
  fst <span class="main">(</span>
    argmax snd <span class="main">(</span>map
      <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">viterbi_ix_rec</span> <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">t_end</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">in</span>
        <span class="main">(</span><span class="bound">t</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">,</span> ennreal <span class="main">(</span>pmf <span class="main">(</span><span class="free">𝒪</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span><span class="free">os</span> <span class="main">!!</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">*</span> pmf <span class="main">(</span><span class="free">𝒦</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span> <span class="main">*</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>
    <span class="free">state_list</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  "</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"Wellfounded.measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">.</span> IArray.length <span class="free">os</span> <span class="main">-</span> <span class="bound">n</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Memoization›</span></span>

<span class="keyword1"><span class="command">memoize_fun</span></span> viterbi_ix<span class="hidden">⇩</span><sub>m</sub><span class="main">:</span> <span class="quoted">viterbi_ix_rec</span>
  <span class="keyword2"><span class="keyword">with_memory</span></span> dp_consistency_mapping
  <span class="keyword1"><span class="command">monadifies</span></span> <span class="main">(</span>state<span class="main">)</span> viterbi_ix_rec.simps<span class="main">[</span><span class="operator">unfolded</span> Let_def<span class="main">]</span>

<span class="keyword1"><span class="command">memoize_correct</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">memoize_prover</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The main theorems generated by memoization.›</span></span>
<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">includes</span></span> state_monad_syntax
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">thm</span></span> viterbi_ix<span class="hidden">⇩</span><sub>m</sub>'.simps viterbi_ix<span class="hidden">⇩</span><sub>m</sub>_def
<span class="keyword1"><span class="command">thm</span></span> viterbi_ix<span class="hidden">⇩</span><sub>m</sub>.memoized_correct
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Fixed IArray *)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">viterbi_ix</span> <span class="free"><span class="bound"><span class="entity">os</span></span></span> <span class="main">=</span> viterbi_ix_rec <span class="main">(</span>IArray <span class="free"><span class="bound"><span class="entity">os</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* HMM3 Defs *)</span>

<span class="keyword1"><span class="command">context</span></span> HMM3
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="HMM_Implementation-viterbi_ix_drop_one"><span class="command">lemma</span></span> viterbi_ix_drop_one<span class="main">:</span>
  <span class="quoted"><span class="quoted">"viterbi_ix <span class="main">(</span><span class="free">o</span> <span class="main">#</span> <span class="free">os</span><span class="main">)</span> <span class="free">s</span> <span class="free">t</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> viterbi_ix <span class="free">os</span> <span class="free">s</span> <span class="free">t</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"length <span class="free">os</span> <span class="main">-</span> <span class="free">n</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> viterbi_ix_def<span class="main">)</span>

<span class="keyword1" id="HMM_Implementation-viterbi_ix_viterbi"><span class="command">lemma</span></span> viterbi_ix_viterbi<span class="main">:</span>
  <span class="quoted"><span class="quoted">"viterbi_ix <span class="free">os</span> <span class="free">s</span> <span class="free">t</span> <span class="main">0</span> <span class="main">=</span> viterbi <span class="free">s</span> <span class="free">t</span> <span class="free">os</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> viterbi_ix_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">os</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">o</span> <span class="skolem">os</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> viterbi_ix_drop_one<span class="main">[</span><span class="operator">unfolded</span> viterbi_ix_def<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> viterbi.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> viterbi_ix_rec.simps<span class="main">)</span>
       <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons.IH <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> viterbi_ix_rec.simps viterbi.simps<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="HMM_Implementation-viterbi_code"><span class="command">lemma</span></span> viterbi_code <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"viterbi <span class="free">s</span> <span class="free">t</span> <span class="free">os</span> <span class="main">=</span> fst <span class="main">(</span>run_state <span class="main">(</span>viterbi_ix<span class="hidden">⇩</span><sub>m</sub>' <span class="main">(</span>IArray <span class="free">os</span><span class="main">)</span> <span class="free">s</span> <span class="free">t</span> <span class="main">0</span><span class="main">)</span> Mapping.empty<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> viterbi_ix_def viterbi_ix<span class="hidden">⇩</span><sub>m</sub>.memoized_correct viterbi_ix_viterbi<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Hidden Markov Model 3 *)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Misc›</span></span>

<span class="keyword1" id="HMM_Implementation-pmf_of_alist_support_aux_1"><span class="command">lemma</span></span> pmf_of_alist_support_aux_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">μ</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span> <span class="main">::</span> real<span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">case</span> map_of <span class="free">μ</span> <span class="free">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Some <span class="bound">p</span> <span class="main">⇒</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> map_of_SomeD<span class="main">)</span>

<span class="keyword1" id="HMM_Implementation-pmf_of_alist_support_aux_2"><span class="command">lemma</span></span> pmf_of_alist_support_aux_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">μ</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map snd <span class="free">μ</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">μ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∫<span class="hidden">⇧</span><sup>+</sup></span> <span class="bound">x</span><span class="main">.</span> ennreal <span class="main">(</span><span class="keyword1">case</span> map_of <span class="free">μ</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Some <span class="bound">p</span> <span class="main">⇒</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∂</span>count_space UNIV <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> nn_integral_count_space<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> B <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"fst <span class="main"><span class="main"><span class="main">`</span></span></span> set <span class="free"><span class="free"><span class="free">μ</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span>
        <span class="operator">force</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> map_of_SomeD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sum.mono_neutral_left<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> T <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"fst <span class="main"><span class="main">`</span></span> set <span class="free"><span class="free">μ</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> ennreal_less_zero_iff map_of_eq_None_iff mem_Collect_eq option.case<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> subsetI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">..&lt;</span>length <span class="free">μ</span><span class="main">.</span> snd <span class="main">(</span><span class="free">μ</span> <span class="main">!</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>
      <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> map_of <span class="free">μ</span> <span class="bound">x</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="bound">v</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">`</span> set <span class="free">μ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sum.reindex_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> l <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span> <span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">.</span></span> fst <span class="main"><span class="main">(</span></span><span class="free"><span class="free">μ</span></span> <span class="main"><span class="main">!</span></span> <span class="bound"><span class="bound">i</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">using</span></span> prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> inj_onI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distinct_conv_nth<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth rev_image_eqI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_of_eq_None_iff<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
        <span class="keyword1"><span class="command">using</span></span> map_of_eq_Some_iff<span class="main">[</span><span class="operator">OF</span> prems<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv nth_mem option.inject prod_eqI snd_conv<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">with</span></span> prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> pmf_of_alist_support_aux_1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> atLeastLessThan_iff ennreal_1
          length_map nth_map sum.cong sum_ennreal sum_list_sum_nth
          <span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="HMM_Implementation-pmf_of_alist_support"><span class="command">lemma</span></span> pmf_of_alist_support<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">μ</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map snd <span class="free">μ</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">μ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set_pmf <span class="main">(</span>pmf_of_alist <span class="free">μ</span><span class="main">)</span> <span class="main">⊆</span> fst <span class="main">`</span> set <span class="free">μ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pmf_of_alist_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> set_embed_pmf<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> x
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> map_of_SomeD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> pmf_of_alist_support_aux_2<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> map_of_SomeD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Defining a Markov kernel from an association list.›</span></span>
<span class="keyword1"><span class="command">locale</span></span> Closed_Kernel_From <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">K</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'t</span> <span class="main">×</span> real<span class="main">)</span> list<span class="main">)</span> list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wellformed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> closed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">μ</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">K</span><span class="main">.</span> <span class="main">∀</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">μ</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> set <span class="free">S</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> is_pmf<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">μ</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">K</span><span class="main">.</span> <span class="main">∀</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">μ</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">μ</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">K</span><span class="main">.</span> distinct <span class="main">(</span>map fst <span class="bound">μ</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">μ</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">K</span><span class="main">.</span> sum_list <span class="main">(</span>map snd <span class="bound">μ</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> is_unique<span class="main">:</span>
        <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">K</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">K'</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> map_of <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">μ</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> PMF_Impl.pmf_of_alist <span class="bound">μ</span><span class="main">)</span><span class="main">)</span> <span class="free">K</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
  None <span class="main">⇒</span> return_pmf <span class="main">(</span>hd <span class="free">S</span><span class="main">)</span> <span class="main">|</span>
  Some <span class="bound">s</span> <span class="main">⇒</span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> Closed_Kernel <span class="quoted">K'</span> <span class="quoted"><span class="quoted">"set <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wellformed closed is_pmf pmf_of_alist_support
  <span class="keyword1"><span class="command">unfolding</span></span> K'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">-</span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split_asm <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> map_of_SomeD<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">K1</span> <span class="main">=</span> map_of <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">μ</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> map_of <span class="bound">μ</span><span class="main">)</span><span class="main">)</span> <span class="free">K</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="HMM_Implementation-pmf_of_alist_aux"><span class="command">lemma</span></span> pmf_of_alist_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">μ</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">K</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"pmf <span class="main">(</span>pmf_of_alist <span class="free">μ</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> map_of <span class="free">μ</span> <span class="free">t</span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> <span class="main">0</span>
    <span class="main">|</span> Some <span class="bound">p</span> <span class="main">⇒</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms is_pmf <span class="keyword1"><span class="command">unfolding</span></span> pmf_of_alist_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> pmf_embed_pmf pmf_of_alist_support_aux_2<span class="main">)</span> 
     <span class="main">(</span><span class="operator">auto</span> 4 3 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> map_of_SomeD<span class="main">)</span>

<span class="keyword1" id="HMM_Implementation-unique"><span class="command">lemma</span></span> unique<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">μ</span> <span class="main">=</span> <span class="free">μ'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">μ</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">μ'</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">K</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that is_unique
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Pair_inject distinct_conv_nth fst_conv in_set_conv_nth length_map nth_map<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span> map_of_NoneD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> fst <span class="main">`</span> set <span class="free">M</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"map_of <span class="free">M</span> <span class="free">x</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> weak_map_of_SomeI<span class="main">)</span>

<span class="keyword1" id="HMM_Implementation-K'_code"><span class="command">lemma</span></span> K'_code <span class="main">[</span><span class="operator">code_post</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"pmf <span class="main">(</span>K' <span class="free">s</span><span class="main">)</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> K1 <span class="free">s</span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">t</span> <span class="main">=</span> hd <span class="free">S</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>
    <span class="main">|</span> Some <span class="bound">μ</span> <span class="main">⇒</span> <span class="keyword1">case</span> <span class="bound">μ</span> <span class="free">t</span> <span class="keyword1">of</span>
        None <span class="main">⇒</span> <span class="main">0</span>
      <span class="main">|</span> Some <span class="bound">p</span> <span class="main">⇒</span> <span class="bound">p</span>
  <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> K'_def K1_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
                 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> map_of_SomeD<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> map_of_NoneD<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> unique map_of_SomeD <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> pmf_of_alist_aux<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Executing Concrete HMMs›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Concrete_HMM_defs <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">𝒦</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> real<span class="main">)</span> list<span class="main">)</span> list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝒪</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'t</span> <span class="main">×</span> real<span class="main">)</span> list<span class="main">)</span> list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝒪<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝒦<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> list"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">𝒦'</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> map_of <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">μ</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> PMF_Impl.pmf_of_alist <span class="bound">μ</span><span class="main">)</span><span class="main">)</span> <span class="free">𝒦</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
    None <span class="main">⇒</span> return_pmf <span class="main">(</span>hd <span class="free">𝒦<span class="hidden">⇩</span><sub>s</sub></span><span class="main">)</span> <span class="main">|</span>
    Some <span class="bound">s</span> <span class="main">⇒</span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">𝒪'</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> map_of <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">μ</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> PMF_Impl.pmf_of_alist <span class="bound">μ</span><span class="main">)</span><span class="main">)</span> <span class="free">𝒪</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">of</span>
    None <span class="main">⇒</span> return_pmf <span class="main">(</span>hd <span class="free">𝒪<span class="hidden">⇩</span><sub>s</sub></span><span class="main">)</span> <span class="main">|</span>
    Some <span class="bound">s</span> <span class="main">⇒</span> <span class="bound">s</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> Concrete_HMM <span class="main">=</span> Concrete_HMM_defs <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> observations_wellformed'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">𝒪<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> observations_closed'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">μ</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">𝒪</span><span class="main">.</span> <span class="main">∀</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">μ</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> set <span class="free">𝒪<span class="hidden">⇩</span><sub>s</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> observations_form_pmf'<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">μ</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">𝒪</span><span class="main">.</span> <span class="main">∀</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">μ</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">μ</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">𝒪</span><span class="main">.</span> distinct <span class="main">(</span>map fst <span class="bound">μ</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">μ</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">𝒪</span><span class="main">.</span> sum_list <span class="main">(</span>map snd <span class="bound">μ</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> observations_unique<span class="main">:</span>
        <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">𝒪</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> states_wellformed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">𝒦<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> states_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">μ</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">𝒦</span><span class="main">.</span> <span class="main">∀</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">μ</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> set <span class="free">𝒦<span class="hidden">⇩</span><sub>s</sub></span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> states_form_pmf<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">μ</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">𝒦</span><span class="main">.</span> <span class="main">∀</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span> <span class="main">∈</span> set <span class="bound">μ</span><span class="main">.</span> <span class="bound">p</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">μ</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">𝒦</span><span class="main">.</span> distinct <span class="main">(</span>map fst <span class="bound">μ</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">μ</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">𝒦</span><span class="main">.</span> sum_list <span class="main">(</span>map snd <span class="bound">μ</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> states_unique<span class="main">:</span>
        <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">𝒦</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">𝒦<span class="hidden">⇩</span><sub>s</sub></span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> O<span class="main">:</span> Closed_Kernel_From <span class="quoted"><span class="free">𝒪</span></span> <span class="quoted"><span class="free">𝒪<span class="hidden">⇩</span><sub>s</sub></span></span>
  <span class="keyword2"><span class="keyword">rewrites</span></span> <span class="quoted"><span class="quoted">"O.K' <span class="main">=</span> 𝒪'"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹Closed_Kernel_From <span class="free">𝒪</span> <span class="free">𝒪<span class="hidden">⇩</span><sub>s</sub></span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> observations_wellformed' observations_closed' observations_form_pmf' observations_unique
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹Closed_Kernel_From.K' <span class="free">𝒪</span> <span class="free">𝒪<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">=</span> 𝒪'›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Closed_Kernel_From.K'_def<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Closed_Kernel_From <span class="free">𝒪</span> <span class="free">𝒪<span class="hidden">⇩</span><sub>s</sub></span>›</span></span><span class="main">]</span> 𝒪'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> K<span class="main">:</span> Closed_Kernel_From <span class="quoted"><span class="free">𝒦</span></span> <span class="quoted"><span class="free">𝒦<span class="hidden">⇩</span><sub>s</sub></span></span>
  <span class="keyword2"><span class="keyword">rewrites</span></span> <span class="quoted"><span class="quoted">"K.K' <span class="main">=</span> 𝒦'"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹Closed_Kernel_From <span class="free">𝒦</span> <span class="free">𝒦<span class="hidden">⇩</span><sub>s</sub></span>›</span></span>
    <span class="keyword1"><span class="command">using</span></span> states_wellformed states_closed states_form_pmf states_unique <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">‹Closed_Kernel_From.K' <span class="free">𝒦</span> <span class="free">𝒦<span class="hidden">⇩</span><sub>s</sub></span> <span class="main">=</span> 𝒦'›</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Closed_Kernel_From.K'_def<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹Closed_Kernel_From <span class="free">𝒦</span> <span class="free">𝒦<span class="hidden">⇩</span><sub>s</sub></span>›</span></span><span class="main">]</span> 𝒦'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> O_code <span class="main">=</span> O.K'_code O.K1_def
<span class="keyword1"><span class="command">lemmas</span></span> K_code <span class="main">=</span> K.K'_code K.K1_def

<span class="keyword1"><span class="command">sublocale</span></span> HMM_interp<span class="main">:</span> HMM4 <span class="quoted">𝒪'</span> <span class="quoted"><span class="quoted">"set <span class="free">𝒦<span class="hidden">⇩</span><sub>s</sub></span>"</span></span> <span class="quoted"><span class="free">𝒦<span class="hidden">⇩</span><sub>s</sub></span></span> <span class="quoted"><span class="quoted">"set <span class="free">𝒪<span class="hidden">⇩</span><sub>s</sub></span>"</span></span> <span class="quoted">𝒦'</span>
  <span class="keyword1"><span class="command">using</span></span> O.Closed_Kernel_axioms K.Closed_Kernel_axioms states_unique<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro_locales</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">intro</span> HMM4_axioms.intro HMM3_axioms.intro HOL.refl<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* Concrete HMM *)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="HMM_Example">
<div class="head">
<h1>Theory HMM_Example</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Example›</span></span>

<span class="keyword1"><span class="command">theory</span></span> HMM_Example
  <span class="keyword2"><span class="keyword">imports</span></span>
    <a href="HMM_Implementation.html">HMM_Implementation</a>
    <span class="quoted">"<a href="../../HOL/HOL-Library/AList_Mapping.html">HOL-Library.AList_Mapping</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We would like to implement mappings as red-black trees
  but they require the key type to be linearly ordered.
  Unfortunately, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>HOL-Analysis›</span></span></span></span> fixes the product order to the element-wise order
  and thus we cannot restore a linear order,
  and the red-black tree implementation (from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>HOL-Library›</span></span></span></span>) cannot be used.
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The ice cream example from Jurafsky and Martin \cite{Jurafsky}.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">states</span> <span class="main">=</span> <span class="main">[</span><span class="inner_quoted">''start''</span><span class="main">,</span> <span class="inner_quoted">''hot''</span><span class="main">,</span> <span class="inner_quoted">''cold''</span><span class="main">,</span> <span class="inner_quoted">''end''</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">observations</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">observations</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="numeral">2</span><span class="main">,</span> <span class="numeral">3</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">kernel</span> <span class="main">=</span>
    <span class="main">[</span>
      <span class="main">(</span><span class="inner_quoted">''start''</span><span class="main">,</span> <span class="main">[</span><span class="main">(</span><span class="inner_quoted">''hot''</span><span class="main">,</span><span class="numeral">0.8</span> <span class="main">::</span> real<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="inner_quoted">''cold''</span><span class="main">,</span><span class="numeral">0.2</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
      <span class="main">(</span><span class="inner_quoted">''hot''</span><span class="main">,</span>   <span class="main">[</span><span class="main">(</span><span class="inner_quoted">''hot''</span><span class="main">,</span><span class="numeral">0.6</span> <span class="main">::</span> real<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="inner_quoted">''cold''</span><span class="main">,</span><span class="numeral">0.3</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="inner_quoted">''end''</span><span class="main">,</span> <span class="numeral">0.1</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
      <span class="main">(</span><span class="inner_quoted">''cold''</span><span class="main">,</span>  <span class="main">[</span><span class="main">(</span><span class="inner_quoted">''hot''</span><span class="main">,</span><span class="numeral">0.4</span> <span class="main">::</span> real<span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="inner_quoted">''cold''</span><span class="main">,</span><span class="numeral">0.5</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="inner_quoted">''end''</span><span class="main">,</span> <span class="numeral">0.1</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
      <span class="main">(</span><span class="inner_quoted">''end''</span><span class="main">,</span>   <span class="main">[</span><span class="main">(</span><span class="inner_quoted">''end''</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
    <span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">emissions</span> <span class="main">=</span>
    <span class="main">[</span>
      <span class="main">(</span><span class="inner_quoted">''hot''</span><span class="main">,</span>   <span class="main">[</span><span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="numeral">0.2</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="numeral">0.4</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="numeral">3</span><span class="main">,</span> <span class="numeral">0.4</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
      <span class="main">(</span><span class="inner_quoted">''cold''</span><span class="main">,</span>  <span class="main">[</span><span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="numeral">0.5</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="numeral">0.4</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="numeral">3</span><span class="main">,</span> <span class="numeral">0.1</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span>
      <span class="main">(</span><span class="inner_quoted">''end''</span><span class="main">,</span>   <span class="main">[</span><span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
    <span class="main">]</span>
  "</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> Concrete_HMM <span class="quoted">kernel</span> <span class="quoted">emissions</span> <span class="quoted">observations</span> <span class="quoted">states</span>
  <span class="keyword2"><span class="keyword">defines</span></span>
      viterbi_rec   <span class="main">=</span> <span class="quoted">HMM_interp.viterbi_ix<span class="hidden">⇩</span><sub>m</sub>'</span>
  <span class="keyword2"><span class="keyword">and</span></span> viterbi       <span class="main">=</span> <span class="quoted">HMM_interp.viterbi</span>
  <span class="keyword2"><span class="keyword">and</span></span> viterbi_final <span class="main">=</span> <span class="quoted">HMM_interp.viterbi_final</span>
  <span class="keyword2"><span class="keyword">and</span></span> forward_rec   <span class="main">=</span> <span class="quoted">HMM_interp.forward_ix<span class="hidden">⇩</span><sub>m</sub>'</span>
  <span class="keyword2"><span class="keyword">and</span></span> forward       <span class="main">=</span> <span class="quoted">HMM_interp.forward</span>
  <span class="keyword2"><span class="keyword">and</span></span> likelihood    <span class="main">=</span> <span class="quoted">HMM_interp.likelihood_compute</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">eval</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span> HMM_interp.viterbi_ix<span class="hidden">⇩</span><sub>m</sub>'.simps<span class="main">[</span><span class="operator">unfolded</span> O_code K_code<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span> HMM_interp.forward_ix<span class="hidden">⇩</span><sub>m</sub>'.simps<span class="main">[</span><span class="operator">unfolded</span> O_code K_code<span class="main">]</span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"likelihood <span class="inner_quoted">''start''</span> <span class="main">[</span><span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  If we enforce the last observation to correspond to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">‹<span class="inner_quoted"><span class="inner_quoted">''end''</span></span>›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  then <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">forward</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">likelihood</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> yield the same result.
›</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"likelihood <span class="inner_quoted">''start''</span> <span class="main">[</span><span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"forward <span class="inner_quoted">''start''</span> <span class="inner_quoted">''end''</span> <span class="main">[</span><span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"forward <span class="inner_quoted">''start''</span> <span class="inner_quoted">''end''</span> <span class="main">[</span><span class="numeral">3</span><span class="main">,</span> <span class="numeral">3</span><span class="main">,</span> <span class="numeral">3</span><span class="main">,</span> <span class="main">0</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"forward <span class="inner_quoted">''start''</span> <span class="inner_quoted">''end''</span> <span class="main">[</span><span class="numeral">3</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="numeral">3</span><span class="main">,</span> <span class="main">0</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"forward <span class="inner_quoted">''start''</span> <span class="inner_quoted">''end''</span> <span class="main">[</span><span class="numeral">3</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="numeral">3</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"viterbi <span class="inner_quoted">''start''</span> <span class="inner_quoted">''end''</span> <span class="main">[</span><span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"viterbi <span class="inner_quoted">''start''</span> <span class="inner_quoted">''end''</span> <span class="main">[</span><span class="numeral">3</span><span class="main">,</span> <span class="numeral">3</span><span class="main">,</span> <span class="numeral">3</span><span class="main">,</span> <span class="main">0</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"viterbi <span class="inner_quoted">''start''</span> <span class="inner_quoted">''end''</span> <span class="main">[</span><span class="numeral">3</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="numeral">3</span><span class="main">,</span> <span class="main">0</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"viterbi <span class="inner_quoted">''start''</span> <span class="inner_quoted">''end''</span> <span class="main">[</span><span class="numeral">3</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="numeral">3</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  If we enforce the last observation to correspond to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">‹<span class="inner_quoted"><span class="inner_quoted">''end''</span></span>›</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
  then <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">viterbi</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">viterbi_final</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> yield the same result.
›</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"viterbi_final <span class="inner_quoted">''start''</span> <span class="main">[</span><span class="numeral">3</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="numeral">3</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"viterbi_final <span class="inner_quoted">''start''</span> <span class="main">[</span><span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="main">0</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"viterbi_final <span class="inner_quoted">''start''</span> <span class="main">[</span><span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="main">1</span><span class="main">]</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div>